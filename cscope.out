cscope 15 $HOME/Desktop/scst-2.2.0 -q 0000004426 0001148873
	@/root/Desktop/scst-2.2.0/include/scst.h

23 #iâdeà
__SCST_H


24 
	#__SCST_H


	)

26 
	~<lšux/ty³s.h
>

27 #iâdeà
INSIDE_KERNEL_TREE


28 
	~<lšux/v”siÚ.h
>

30 
	~<lšux/blkdev.h
>

31 
	~<lšux/š‹¼u±.h
>

32 
	~<lšux/wa™.h
>

33 
	~<lšux/ýumask.h
>

35 
	#CONFIG_SCST_PROC


	)

37 #ifdeà
CONFIG_SCST_PROC


38 
	~<lšux/´oc_fs.h
>

39 
	~<lšux/£q_fže.h
>

40 #–ià
defšed
(
RHEL_MAJOR
) && RHEL_MAJOR -0 <= 5

41 #”rÜ 
The
 
SCST
 
sysfs
 
š‹rçû
 
is
 
nÙ
 
suµÜ‹d
 
Ú
 
RHEL
 5. 
PËa£
 
run
 
make
 
’abË_´oc
.

42 #–ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26)

43 #”rÜ 
The
 
SCST
 
sysfs
 
š‹rçû
 
is
 
suµÜ‹d
 
äom
 
k”Ãl
 
v”siÚ
 2.6.26 
Ú
. 
PËa£
 
run
 
make
 
’abË_´oc
.

46 
	~<scsi/scsi_cmnd.h
>

47 
	~<scsi/scsi_deviû.h
>

48 
	~<scsi/scsi_eh.h
>

49 
	~<scsi/scsi.h
>

51 #ifdeà
INSIDE_KERNEL_TREE


52 
	~<sc¡/sc¡_cÚ¡.h
>

54 
	~<sc¡_cÚ¡.h
>

57 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 19)

58 #iâdeà
RHEL_RELEASE_CODE


59 
_BoÞ
 
	tboÞ
;

61 
	#Œue
 1

	)

62 
	#çl£
 0

	)

65 #ifdeà
INSIDE_KERNEL_TREE


66 
	~<sc¡/sc¡_sgv.h
>

68 
	~"sc¡_sgv.h
"

71 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 20)

72 
	#Ä_ýu_ids
 
NR_CPUS


	)

75 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 28)

76 
	#ýumask_b™s
(
maskp
è((maskp)->
b™s
)

	)

77 #ifdeà
CONFIG_CPUMASK_OFFSTACK


80 
	#Ä_ýumask_b™s
 
Ä_ýu_ids


	)

82 
	#Ä_ýumask_b™s
 
NR_CPUS


	)

86 
šlše
 
	$ýumask_check
(
ýu
)

88 #ifdeà
CONFIG_DEBUG_PER_CPU_MAPS


89 
	`WARN_ON_ONCE
(
ýu
 >ð
Ä_ýumask_b™s
);

91  
ýu
;

92 
	}
}

101 
šlše
 
	$ýumask_Ãxt
(
n
, cÚ¡ 
ýumask_t
 *
¤ý
)

104 ià(
n
 != -1)

105 
	`ýumask_check
(
n
);

106  
	`fšd_Ãxt_b™
(
	`ýumask_b™s
(
¤ý
), 
Ä_ýumask_b™s
, 
n
+1);

107 
	}
}

116 
	#fÜ_—ch_ýu
(
ýu
, 
mask
) \

117 (
ýu
) = -1; \

118 (
ýu
èð
	`ýumask_Ãxt
((ýu), (
mask
)), \

119 (
ýu
è< 
Ä_ýu_ids
;)

	)

126 
šlše
 
	$ýumask_cÝy
(
ýumask_t
 *
d¡p
,

127 cÚ¡ 
ýumask_t
 *
¤ý
)

129 
	`b™m­_cÝy
(
	`ýumask_b™s
(
d¡p
), cpumask_b™s(
¤ý
), 
Ä_ýumask_b™s
);

130 
	}
}

133 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26è&& !
defšed
(
RHEL_MAJOR
)

134 
šlše
 
	$£t_ýus_®lowed_±r
(
sk_¡ruù
 *
p
,

135 cÚ¡ 
ýumask_t
 *
Ãw_mask
)

137  
	`£t_ýus_®lowed
(
p
, *
Ãw_mask
);

138 
	}
}

141 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 31)

142 
šlše
 
	$queue_max_hw_£ùÜs
(
»que¡_queue
 *
q
)

144  
q
->
max_hw_£ùÜs
;

145 
	}
}

148 
	#SCST_INTERFACE_VERSION
 \

149 
SCST_VERSION_STRING
 "$RevisiÚ: 4021 $" 
SCST_CONST_VERSION


	)

151 
	#SCST_LOCAL_NAME
 "sc¡_loÿl"

	)

161 
	#SCST_CMD_STATE_PARSE
 0

	)

164 
	#SCST_CMD_STATE_PREPARE_SPACE
 1

	)

167 
	#SCST_CMD_STATE_PREPROCESSING_DONE
 2

	)

170 
	#SCST_CMD_STATE_RDY_TO_XFER
 3

	)

173 
	#SCST_CMD_STATE_TGT_PRE_EXEC
 4

	)

176 
	#SCST_CMD_STATE_SEND_FOR_EXEC
 5

	)

179 
	#SCST_CMD_STATE_PRE_DEV_DONE
 6

	)

182 
	#SCST_CMD_STATE_MODE_SELECT_CHECKS
 7

	)

185 
	#SCST_CMD_STATE_DEV_DONE
 8

	)

188 
	#SCST_CMD_STATE_PRE_XMIT_RESP
 9

	)

191 
	#SCST_CMD_STATE_XMIT_RESP
 10

	)

194 
	#SCST_CMD_STATE_FINISHED
 11

	)

197 
	#SCST_CMD_STATE_FINISHED_INTERNAL
 12

	)

199 
	#SCST_CMD_STATE_LAST_ACTIVE
 (
SCST_CMD_STATE_FINISHED_INTERNAL
+100)

	)

202 
	#SCST_CMD_STATE_INIT_WAIT
 (
SCST_CMD_STATE_LAST_ACTIVE
+1)

	)

205 
	#SCST_CMD_STATE_INIT
 (
SCST_CMD_STATE_LAST_ACTIVE
+2)

	)

208 
	#SCST_CMD_STATE_PREPROCESSING_DONE_CALLED
 (
SCST_CMD_STATE_LAST_ACTIVE
+3)

	)

211 
	#SCST_CMD_STATE_DATA_WAIT
 (
SCST_CMD_STATE_LAST_ACTIVE
+4)

	)

217 
	#SCST_CMD_STATE_START_EXEC
 (
SCST_CMD_STATE_LAST_ACTIVE
+5)

	)

220 
	#SCST_CMD_STATE_LOCAL_EXEC
 (
SCST_CMD_STATE_LAST_ACTIVE
+6)

	)

223 
	#SCST_CMD_STATE_REAL_EXEC
 (
SCST_CMD_STATE_LAST_ACTIVE
+7)

	)

226 
	#SCST_CMD_STATE_REAL_EXECUTING
 (
SCST_CMD_STATE_LAST_ACTIVE
+8)

	)

229 
	#SCST_CMD_STATE_XMIT_WAIT
 (
SCST_CMD_STATE_LAST_ACTIVE
+9)

	)

235 
	#SCST_CMD_STATE_DEFAULT
 500

	)

243 
	#SCST_CMD_STATE_NEED_THREAD_CTX
 1000

	)

250 
	#SCST_CMD_STATE_STOP
 1001

	)

257 
	#SCST_MCMD_STATE_INIT
 0

	)

260 
	#SCST_MCMD_STATE_EXEC
 1

	)

263 
	#SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_DONE
 2

	)

266 
	#SCST_MCMD_STATE_AFFECTED_CMDS_DONE
 3

	)

269 
	#SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_FINISHED
 4

	)

272 
	#SCST_MCMD_STATE_DONE
 5

	)

275 
	#SCST_MCMD_STATE_FINISHED
 6

	)

280 
	#SCST_NON_ATOMIC
 0

	)

281 
	#SCST_ATOMIC
 1

	)

289 
	esc¡_exec_cÚ‹xt
 {

294 
	mSCST_CONTEXT_DIRECT_ATOMIC
,

300 
	mSCST_CONTEXT_DIRECT
,

303 
	mSCST_CONTEXT_TASKLET
,

306 
	mSCST_CONTEXT_THREAD
,

316 
	mSCST_CONTEXT_SAME


324 
	#SCST_RX_STATUS_SUCCESS
 0

	)

330 
	#SCST_RX_STATUS_ERROR
 1

	)

336 
	#SCST_RX_STATUS_ERROR_SENSE_SET
 2

	)

342 
	#SCST_RX_STATUS_ERROR_FATAL
 3

	)

349 
	#SCST_PREPROCESS_STATUS_SUCCESS
 0

	)

355 
	#SCST_PREPROCESS_STATUS_ERROR
 1

	)

361 
	#SCST_PREPROCESS_STATUS_ERROR_SENSE_SET
 2

	)

367 
	#SCST_PREPROCESS_STATUS_ERROR_FATAL
 3

	)

382 
	#SCST_AEN_SCSI
 0

	)

387 
	#SCST_AEN_CPU_MASK_CHANGED
 1

	)

395 
	#SCST_AEN_RES_SUCCESS
 0

	)

398 
	#SCST_AEN_RES_NOT_SUPPORTED
 -1

	)

401 
	#SCST_AEN_RES_FAILED
 -2

	)

408 
	#SCST_TGT_RES_SUCCESS
 0

	)

411 
	#SCST_TGT_RES_QUEUE_FULL
 -1

	)

417 
	#SCST_TGT_RES_NEED_THREAD_CTX
 -2

	)

424 
	#SCST_TGT_RES_FATAL_ERROR
 -3

	)

431 
	#SCST_EXEC_COMPLETED
 0

	)

434 
	#SCST_EXEC_NOT_COMPLETED
 1

	)

441 
	#SCST_DEV_TM_NOT_COMPLETED
 1

	)

448 
	#SCST_SESS_IPH_INITING
 0

	)

451 
	#SCST_SESS_IPH_SUCCESS
 1

	)

454 
	#SCST_SESS_IPH_FAILED
 2

	)

457 
	#SCST_SESS_IPH_READY
 3

	)

464 
	#SCST_SESS_SPH_READY
 0

	)

467 
	#SCST_SESS_SPH_SHUTDOWN
 1

	)

470 
	#SCST_SESS_SPH_UNREG_DONE_CALLING
 2

	)

477 
	#SCST_SESS_HW_PENDING_WORK_SCHEDULED
 0

	)

484 
	#SCST_CMD_ABORTED
 0

	)

487 
	#SCST_CMD_ABORTED_OTHER
 1

	)

490 
	#SCST_CMD_NO_RESP
 2

	)

493 
	#SCST_CMD_CAN_BE_DESTROYED
 3

	)

499 
	#SCST_CMD_DEVICE_TAS
 4

	)

506 
	#SCST_TGT_DEV_UA_PENDING
 0

	)

509 
	#SCST_TGT_DEV_RESERVED
 1

	)

512 
	#SCST_TGT_DEV_AFTER_INIT_WR_ATOMIC
 5

	)

513 
	#SCST_TGT_DEV_AFTER_EXEC_ATOMIC
 6

	)

515 
	#SCST_TGT_DEV_CLUST_POOL
 11

	)

527 
	#SCST_IO_GROUPING_AUTO
 0

	)

530 
	#SCST_IO_GROUPING_THIS_GROUP_ONLY
 -1

	)

533 
	#SCST_IO_GROUPING_NEVER
 -2

	)

535 #ifdeà
CONFIG_SCST_PROC


540 
	#SCST_PROC_ENTRY_NAME
 "scsi_tgt"

	)

547 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 22)

548 
	#KMEM_CACHE
(
__¡ruù
, 
__æags
è
	`kmem_ÿche_ü—‹
(#__struct,\

549 (
__¡ruù
), 
	`__®ignof__
(__struct),\

550 (
__æags
), 
NULL
, NULL)

	)

557 
	#SCST_SENSE_KEY_VALID
 1

	)

558 
	#SCST_SENSE_ASC_VALID
 2

	)

559 
	#SCST_SENSE_ASCQ_VALID
 4

	)

561 
	#SCST_SENSE_ASCx_VALID
 (
SCST_SENSE_ASC_VALID
 | \

562 
SCST_SENSE_ASCQ_VALID
)

	)

564 
	#SCST_SENSE_ALL_VALID
 (
SCST_SENSE_KEY_VALID
 | \

565 
SCST_SENSE_ASC_VALID
 | \

566 
SCST_SENSE_ASCQ_VALID
)

	)

572 
	gsc¡_tgt
;

573 
	gsc¡_£ssiÚ
;

574 
	gsc¡_cmd
;

575 
	gsc¡_mgmt_cmd
;

576 
	gsc¡_deviû
;

577 
	gsc¡_tgt_dev
;

578 
	gsc¡_dev_ty³
;

579 
	gsc¡_acg
;

580 
	gsc¡_acg_dev
;

581 
	gsc¡_aú
;

582 
	gsc¡_«n
;

588 
	#NO_SUCH_LUN
 ((
ušt64_t
)-1)

	)

590 
dma_d©a_dœeùiÚ
 
	tsc¡_d©a_dœeùiÚ
;

599 
	ssc¡_tgt_‹m¶©e
 {

606 
	msg_bËsize
;

611 
	munchecked_i§_dma
:1;

617 
	mu£_þu¡”šg
:1;

622 
	mno_þu¡”šg
:1;

628 
	mxm™_»¥Ú£_©omic
:1;

629 
	mrdy_to_xãr_©omic
:1;

631 #ifdeà
CONFIG_SCST_PROC


633 
	mno_´oc_’Œy
:1;

636 
	m’abËd_©Œ_nÙ_Ãeded
:1;

644 
	mçke_aÿ
:1;

649 
sc¡_lun_addr_m‘hod
 
	m´eã¼ed_addr_m‘hod
;

659 
	mmax_hw_³ndšg_time
;

679 (*
	mxm™_»¥Ú£
è(
sc¡_cmd
 *
	mcmd
);

703 (*
	mrdy_to_xãr
è(
sc¡_cmd
 *
	mcmd
);

713 (*
	mÚ_hw_³ndšg_cmd_timeout
è(
sc¡_cmd
 *
	mcmd
);

722 (*
	mÚ_ä“_cmd
è(
sc¡_cmd
 *
	mcmd
);

753 (*
	m®loc_d©a_buf
è(
sc¡_cmd
 *
	mcmd
);

780 (*
	m´•roûssšg_dÚe
è(
sc¡_cmd
 *
	mcmd
);

793 (*
	m´e_exec
è(
sc¡_cmd
 *
	mcmd
);

806 (*
	msk_mgmt_afãùed_cmds_dÚe
è(
sc¡_mgmt_cmd
 *
	mmgmt_cmd
);

819 (*
	msk_mgmt_â_dÚe
è(
sc¡_mgmt_cmd
 *
	mmgmt_cmd
);

828 (*
	mÚ_abÜt_cmd
è(
sc¡_cmd
 *
	mcmd
);

839 (*
	md‘eù
è(
sc¡_tgt_‹m¶©e
 *
	mtgt_‹m¶©e
);

849 (*
	m»Ëa£
è(
sc¡_tgt
 *
	mtgt
);

868 (*
	m»pÜt_«n
è(
sc¡_«n
 *
	m«n
);

870 #ifdeà
CONFIG_SCST_PROC


878 (*
	m»ad_´oc
è(
£q_fže
 *
	m£q
, 
sc¡_tgt
 *
	mtgt
);

879 (*
	mwr™e_´oc
è(*
	mbufãr
, **
	m¡¬t
, 
off_t
 
	moff£t
,

880 
	mËngth
, *
	meof
, 
sc¡_tgt
 *
	mtgt
);

897 (*
	mg‘_š™ŸtÜ_pÜt_Œª¥Üt_id
è(
sc¡_tgt
 *
	mtgt
,

898 
sc¡_£ssiÚ
 *
	m£ss
, 
ušt8_t
 **
	mŒª¥Üt_id
);

912 (*
	m’abË_rg‘
è(
sc¡_tgt
 *
	mtgt
, 
boÞ
 
	m’abË
);

919 
boÞ
 (*
is_rg‘_’abËd
è(
sc¡_tgt
 *
	mtgt
);

939 
ssize_t
 (*
add_rg‘
è(cÚ¡ *
	mrg‘_Çme
, *
	m·¿ms
);

947 
ssize_t
 (*
d–_rg‘
è(cÚ¡ *
	mrg‘_Çme
);

956 
ssize_t
 (*
mgmt_cmd
è(*
	mcmd
);

964 
ušt16_t
 (*
g‘_phys_Œª¥Üt_v”siÚ
è(
sc¡_tgt
 *
	mtgt
);

972 
ušt16_t
 (*
g‘_scsi_Œª¥Üt_v”siÚ
è(
sc¡_tgt
 *
	mtgt
);

978 cÚ¡ 
	mÇme
[
SCST_MAX_NAME
];

986 
	mth»ads_num
;

989 cÚ¡ 
	mdeçuÉ_Œaû_æags
;

992 *
	mŒaû_æags
;

995 
sc¡_Œaû_log
 *
	mŒaû_tbl
;

998 cÚ¡ *
	mŒaû_tbl_h–p
;

1000 #iâdeà
CONFIG_SCST_PROC


1002 cÚ¡ 
©Œibu‹
 **
	mtg‰_©Œs
;

1005 cÚ¡ 
©Œibu‹
 **
	mtgt_©Œs
;

1008 cÚ¡ 
©Œibu‹
 **
	m£ss_©Œs
;

1012 cÚ¡ *
	mmgmt_cmd_h–p
;

1015 cÚ¡ *
	madd_rg‘_·¿m‘”s
;

1022 cÚ¡ *
	mtg‰_ÝtiÚ®_©Œibu‹s
;

1029 cÚ¡ *
	mtgt_ÝtiÚ®_©Œibu‹s
;

1034 
li¡_h—d
 
	mtgt_li¡
;

1037 
li¡_h—d
 
	msc¡_‹m¶©e_li¡_’Œy
;

1039 #ifdeà
CONFIG_SCST_PROC


1041 
´oc_dœ_’Œy
 *
	m´oc_tgt_roÙ
;

1044 
	m´oc_dev_num
;

1046 
kobjeù
 
	mtg‰_kobj
;

1049 
	mtg‰_aùive_sysfs_wÜks_couÁ
;

1052 
com¶‘iÚ
 *
	mtg‰_kobj_»Ëa£_cm¶
;

1060 cÚ¡ *
	mv’dÜ
;

1068 (*
	mg‘_´oduù_id
)(cÚ¡ 
sc¡_tgt_dev
 *
	mtgt_dev
,

1069 *
	mbuf
, 
	msize
);

1076 cÚ¡ *
	m»visiÚ
;

1089 (*
	mg‘_£rŸl
)(cÚ¡ 
sc¡_tgt_dev
 *
	mtgt_dev
, *
	mbuf
,

1090 
	msize
);

1096 (*
	mg‘_v’d_¥ecific
)(cÚ¡ 
sc¡_tgt_dev
 *
	mtgt_dev
, *
	mbuf
,

1097 
	msize
);

1104 
	esc¡_dev_ty³_th»ads_poÞ_ty³
 {

1106 
	mSCST_THREADS_POOL_PER_INITIATOR
 = 0,

1109 
	mSCST_THREADS_POOL_SHARED
,

1112 
	mSCST_THREADS_POOL_TYPE_INVALID
,

1122 
	ssc¡_dev_ty³
 {

1124 
	mty³
;

1130 
	m·r£_©omic
:1;

1131 
	m®loc_d©a_buf_©omic
:1;

1132 
	mdev_dÚe_©omic
:1;

1134 #ifdeà
CONFIG_SCST_PROC


1136 
	mno_´oc
:1;

1143 
	mexec_sync
:1;

1150 
	m´_cmds_nÙifiÿtiÚs
:1;

1170 (*
	m·r£
è(
sc¡_cmd
 *
	mcmd
);

1190 (*
	m®loc_d©a_buf
è(
sc¡_cmd
 *
	mcmd
);

1212 (*
	mexec
è(
sc¡_cmd
 *
	mcmd
);

1231 (*
	mdev_dÚe
è(
sc¡_cmd
 *
	mcmd
);

1240 (*
	mÚ_ä“_cmd
è(
sc¡_cmd
 *
	mcmd
);

1262 (*
	msk_mgmt_â
è(
sc¡_mgmt_cmd
 *
	mmgmt_cmd
,

1263 
sc¡_tgt_dev
 *
	mtgt_dev
);

1275 
boÞ
 (*
Ú_sg_bËsize_low
è(
sc¡_cmd
 *
	mcmd
);

1283 (*
	m©ch
è(
sc¡_deviû
 *
	mdev
);

1290 (*
	md‘ach
è(
sc¡_deviû
 *
	mdev
);

1298 (*
	m©ch_tgt
è(
sc¡_tgt_dev
 *
	mtgt_dev
);

1305 (*
	md‘ach_tgt
è(
sc¡_tgt_dev
 *
	mtgt_dev
);

1307 #ifdeà
CONFIG_SCST_PROC


1315 (*
	m»ad_´oc
è(
£q_fže
 *
	m£q
, 
sc¡_dev_ty³
 *
	mdev_ty³
);

1316 (*
	mwr™e_´oc
è(*
	mbufãr
, **
	m¡¬t
, 
off_t
 
	moff£t
,

1317 
	mËngth
, *
	meof
, 
sc¡_dev_ty³
 *
	mdev_ty³
);

1337 
ssize_t
 (*
add_deviû
è(cÚ¡ *
	mdeviû_Çme
, *
	m·¿ms
);

1345 
ssize_t
 (*
d–_deviû
è(cÚ¡ *
	mdeviû_Çme
);

1354 
ssize_t
 (*
mgmt_cmd
è(*
	mcmd
);

1362 
	mÇme
[
SCST_MAX_NAME
 + 10];

1369 
	mth»ads_num
;

1372 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
	mth»ads_poÞ_ty³
;

1375 cÚ¡ 
	mdeçuÉ_Œaû_æags
;

1378 *
	mŒaû_æags
;

1381 
sc¡_Œaû_log
 *
	mŒaû_tbl
;

1383 #iâdeà
CONFIG_SCST_PROC


1385 cÚ¡ *
	mŒaû_tbl_h–p
;

1388 cÚ¡ *
	mmgmt_cmd_h–p
;

1391 cÚ¡ *
	madd_deviû_·¿m‘”s
;

1398 cÚ¡ *
	mdevt_ÝtiÚ®_©Œibu‹s
;

1405 cÚ¡ *
	mdev_ÝtiÚ®_©Œibu‹s
;

1408 cÚ¡ 
©Œibu‹
 **
	mdevt_©Œs
;

1411 cÚ¡ 
©Œibu‹
 **
	mdev_©Œs
;

1415 *
	mdevt_´iv
;

1418 
sc¡_dev_ty³
 *
	m·»Á
;

1420 
moduË
 *
	mmoduË
;

1425 
li¡_h—d
 
	mdev_ty³_li¡_’Œy
;

1427 #ifdeà
CONFIG_SCST_PROC


1429 
´oc_dœ_’Œy
 *
	m´oc_dev_ty³_roÙ
;

1431 
kobjeù
 
	mdevt_kobj
;

1434 
	mdevt_aùive_sysfs_wÜks_couÁ
;

1437 
com¶‘iÚ
 *
	mdevt_kobj_»Ëa£_com¶
;

1444 
	ssc¡_tgt
 {

1446 
li¡_h—d
 
	m£ss_li¡
;

1449 
li¡_h—d
 
	mtgt_li¡_’Œy
;

1451 
sc¡_tgt_‹m¶©e
 *
	mtg‰
;

1453 #iâdeà
CONFIG_SCST_PROC


1454 
sc¡_acg
 *
	mdeçuÉ_acg
;

1456 
li¡_h—d
 
	mtgt_acg_li¡
;

1463 
	msg_bËsize
;

1466 *
	mtgt_´iv
;

1474 
boÞ
 
	m»Œy_tim”_aùive
;

1475 
tim”_li¡
 
	m»Œy_tim”
;

1476 
©omic_t
 
	mfšished_cmds
;

1477 
	m»Œy_cmds
;

1478 
¥šlock_t
 
	mtgt_lock
;

1479 
li¡_h—d
 
	m»Œy_cmd_li¡
;

1482 
wa™_queue_h—d_t
 
	muÄeg_wa™Q
;

1484 #ifdeà
CONFIG_SCST_PROC


1486 
	m´oc_num
;

1490 *
	mtgt_Çme
;

1493 *
	mtgt_comm’t
;

1495 
ušt16_t
 
	m»l_tgt_id
;

1497 #ifdeà
CONFIG_SCST_PROC


1499 *
	mdeçuÉ_group_Çme
;

1502 
com¶‘iÚ
 *
	mtgt_kobj_»Ëa£_cm¶
;

1504 
kobjeù
 
	mtgt_kobj
;

1505 
kobjeù
 *
	mtgt_£ss_kobj
;

1506 
kobjeù
 *
	mtgt_luns_kobj
;

1507 
kobjeù
 *
	mtgt_ši_g½_kobj
;

1511 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


1514 
	ssc¡_ext_Ï‹ncy_¡©
 {

1515 
ušt64_t
 
	msc¡_time_rd
, 
	mtgt_time_rd
, 
	mdev_time_rd
;

1516 
	m´oûs£d_cmds_rd
;

1517 
ušt64_t
 
	mmš_sc¡_time_rd
, 
	mmš_tgt_time_rd
, 
	mmš_dev_time_rd
;

1518 
ušt64_t
 
	mmax_sc¡_time_rd
, 
	mmax_tgt_time_rd
, 
	mmax_dev_time_rd
;

1520 
ušt64_t
 
	msc¡_time_wr
, 
	mtgt_time_wr
, 
	mdev_time_wr
;

1521 
	m´oûs£d_cmds_wr
;

1522 
ušt64_t
 
	mmš_sc¡_time_wr
, 
	mmš_tgt_time_wr
, 
	mmš_dev_time_wr
;

1523 
ušt64_t
 
	mmax_sc¡_time_wr
, 
	mmax_tgt_time_wr
, 
	mmax_dev_time_wr
;

1526 
	#SCST_IO_SIZE_THRESHOLD_SMALL
 (8*1024)

	)

1527 
	#SCST_IO_SIZE_THRESHOLD_MEDIUM
 (32*1024)

	)

1528 
	#SCST_IO_SIZE_THRESHOLD_LARGE
 (128*1024)

	)

1529 
	#SCST_IO_SIZE_THRESHOLD_VERY_LARGE
 (512*1024)

	)

1531 
	#SCST_LATENCY_STAT_INDEX_SMALL
 0

	)

1532 
	#SCST_LATENCY_STAT_INDEX_MEDIUM
 1

	)

1533 
	#SCST_LATENCY_STAT_INDEX_LARGE
 2

	)

1534 
	#SCST_LATENCY_STAT_INDEX_VERY_LARGE
 3

	)

1535 
	#SCST_LATENCY_STAT_INDEX_OTHER
 4

	)

1536 
	#SCST_LATENCY_STATS_NUM
 (
SCST_LATENCY_STAT_INDEX_OTHER
 + 1)

	)

1540 
	ssc¡_io_¡©_’Œy
 {

1541 
ušt64_t
 
	mcmd_couÁ
;

1542 
ušt64_t
 
	mio_by‹_couÁ
;

1548 
	ssc¡_£ssiÚ
 {

1553 
	mš™_pha£
;

1555 
sc¡_tgt
 *
	mtgt
;

1558 *
	mtgt_´iv
;

1561 
	m£ss_aæags
;

1568 
	#SESS_TGT_DEV_LIST_HASH_SIZE
 (1 << 5)

	)

1569 
	#SESS_TGT_DEV_LIST_HASH_FN
(
v®
è((v®è& (
SESS_TGT_DEV_LIST_HASH_SIZE
 - 1))

	)

1570 
li¡_h—d
 
	m£ss_tgt_dev_li¡
[
SESS_TGT_DEV_LIST_HASH_SIZE
];

1579 
li¡_h—d
 
	m£ss_cmd_li¡
;

1581 
¥šlock_t
 
	m£ss_li¡_lock
;

1583 
©omic_t
 
	m»fút
;

1589 
©omic_t
 
	m£ss_cmd_couÁ
;

1592 
sc¡_io_¡©_’Œy
 
	mio_¡©s
[
SCST_DATA_DIR_MAX
];

1595 
sc¡_acg
 *
	macg
;

1598 
ušt8_t
 *
	mŒª¥Üt_id
;

1601 
li¡_h—d
 
	macg_£ss_li¡_’Œy
;

1603 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 20))

1604 
d–ayed_wÜk
 
	mhw_³ndšg_wÜk
;

1606 
wÜk_¡ruù
 
	mhw_³ndšg_wÜk
;

1610 cÚ¡ *
	mš™ŸtÜ_Çme
;

1613 
li¡_h—d
 
	m£ss_li¡_’Œy
;

1616 
li¡_h—d
 
	m£ss_š™_li¡_’Œy
;

1621 
li¡_h—d
 
	m£ss_shut_li¡_’Œy
;

1627 
li¡_h—d
 
	mš™_deã¼ed_cmd_li¡
;

1628 
li¡_h—d
 
	mš™_deã¼ed_mcmd_li¡
;

1635 
	mshut_pha£
;

1638 
com¶‘iÚ
 *
	mshutdown_com¶
;

1641 
com¶‘iÚ
 *
	m£ss_kobj_»Ëa£_cm¶
;

1643 #iâdeà
CONFIG_SCST_PROC


1644 
	m£ss_kobj_»ady
:1;

1646 
kobjeù
 
	m£ss_kobj
;

1653 *
	m»g_£ss_d©a
;

1654 (*
	mš™_»suÉ_â
è(
sc¡_£ssiÚ
 *
	m£ss
, *
	md©a
,

1655 
	m»suÉ
);

1656 (*
	muÄeg_dÚe_â
è(
sc¡_£ssiÚ
 *
	m£ss
);

1658 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


1663 
¥šlock_t
 
	mÏt_lock
;

1664 
ušt64_t
 
	msc¡_time
, 
	mtgt_time
, 
	mdev_time
;

1665 
	m´oûs£d_cmds
;

1666 
ušt64_t
 
	mmš_sc¡_time
, 
	mmš_tgt_time
, 
	mmš_dev_time
;

1667 
ušt64_t
 
	mmax_sc¡_time
, 
	mmax_tgt_time
, 
	mmax_dev_time
;

1668 
sc¡_ext_Ï‹ncy_¡©
 
	m£ss_Ï‹ncy_¡©
[
SCST_LATENCY_STATS_NUM
];

1675 
	ssc¡_´_abÜt_®l_³ndšg_mgmt_cmds_couÁ”
 {

1680 
©omic_t
 
	m´_abÜt_³ndšg_út
;

1683 (*
	m§ved_cmd_dÚe
è(
sc¡_cmd
 *
	mcmd
, 
	mÃxt_¡©e
,

1684 
sc¡_exec_cÚ‹xt
 
	m´ef_cÚ‹xt
);

1691 
©omic_t
 
	m´_abÜtšg_út
;

1692 
com¶‘iÚ
 
	m´_abÜtšg_cm¶
;

1698 
	ssc¡_cmd_th»ads
 {

1699 
¥šlock_t
 
	mcmd_li¡_lock
;

1700 
li¡_h—d
 
	maùive_cmd_li¡
;

1701 
wa™_queue_h—d_t
 
	mcmd_li¡_wa™Q
;

1703 
io_cÚ‹xt
 *
	mio_cÚ‹xt
;

1704 
	mio_cÚ‹xt_»fút
;

1706 
boÞ
 
	mio_cÚ‹xt_»ady
;

1709 
mu‹x
 
	mio_cÚ‹xt_mu‹x
;

1711 
	mÄ_th»ads
;

1712 
li¡_h—d
 
	mth»ads_li¡
;

1714 
li¡_h—d
 
	mli¡s_li¡_’Œy
;

1720 
	ssc¡_Üd”_d©a
 {

1726 
	mdef_cmd_couÁ
;

1727 
¥šlock_t
 
	m¢_lock
;

1728 
	mex³ùed_¢
;

1729 
	mcu¼_¢
;

1730 
	mhq_cmd_couÁ
;

1731 
li¡_h—d
 
	mdeã¼ed_cmd_li¡
;

1732 
li¡_h—d
 
	msk³d_¢_li¡
;

1738 
	m´ev_cmd_Üd”ed
;

1740 
	mnum_ä“_¢_¦Ùs
;

1741 
©omic_t
 *
	mcur_¢_¦Ù
;

1742 
©omic_t
 
	m¢_¦Ùs
[15];

1748 
	ssc¡_cmd
 {

1750 
li¡_h—d
 
	mcmd_li¡_’Œy
;

1753 
sc¡_cmd_th»ads
 *
	mcmd_th»ads
;

1755 
©omic_t
 
	mcmd_»f
;

1757 
sc¡_£ssiÚ
 *
	m£ss
;

1759 
©omic_t
 *
	mýu_cmd_couÁ”
;

1762 
	m¡©e
;

1772 
	m£Á_fÜ_exec
:1;

1775 
	mcom¶‘ed
:1;

1778 
	mua_ignÜe
:1;

1781 
	m©omic
:1;

1784 
	mdoubË_ua_possibË
:1;

1787 
	mis_£nd_¡©us
:1;

1790 
	m»Œy
:1;

1793 
	mš‹º®
:1;

1796 
	munblock_dev
:1;

1799 
	mdec_´_»ad”s_couÁ_Ãeded
:1;

1802 
	mdec_Ú_dev_Ãeded
:1;

1805 
	mcmd_hw_³ndšg
:1;

1813 
	mnoio_mem_®loc
:1;

1820 
	mtgt_Ãed_®loc_d©a_buf
:1;

1826 
	mtgt_d©a_buf_®loûd
:1;

1829 
	mdh_d©a_buf_®loûd
:1;

1832 
	mex³ùed_v®ues_£t
:1;

1837 
	msg_buff_modif›d
:1;

1843 
	msg_buff_vm®loÿ‹d
:1;

1849 
	m´•roûssšg_Úly
:1;

1852 
	m¢_£t
:1;

1855 
	mhq_cmd_šûd
:1;

1861 
	m£t_¢_Ú_»¡¬t_cmd
:1;

1864 
	mno_sgv
:1;

1871 
	mmay_Ãed_dma_sync
:1;

1874 
	mout_of_¢
:1;

1877 
	mšc_ex³ùed_¢_Ú_dÚe
:1;

1880 
	mtgt_¢_£t
:1;

1883 
	m»sid_possibË
:1;

1886 
	mdÚe
:1;

1892 
	mfšished
:1;

1898 
	mcheck_loÿl_ev’ts_Úû_dÚe
:1;

1900 #ifdeà
CONFIG_SCST_DEBUG_TM


1902 
	mtm_dbg_d–ayed
:1;

1905 
	mtm_dbg_immut
:1;

1911 
	mcmd_æags
;

1914 
	md–iv”y_¡©us
;

1916 
sc¡_tgt_‹m¶©e
 *
	mtg‰
;

1917 
sc¡_tgt
 *
	mtgt
;

1918 
sc¡_deviû
 *
	mdev
;

1921 
sc¡_tgt_dev
 *
	mtgt_dev
;

1923 
sc¡_Üd”_d©a
 *
	mcur_Üd”_d©a
;

1925 
ušt64_t
 
	mlun
;

1927 
	m¡¬t_time
;

1930 
li¡_h—d
 
	m¢_cmd_li¡_’Œy
;

1933 
	m¢
;

1936 
©omic_t
 *
	m¢_¦Ù
;

1939 
li¡_h—d
 
	m£ss_cmd_li¡_’Œy
;

1945 
ušt64_t
 
	mg
;

1947 
ušt32_t
 
	mtgt_¢
;

1949 
ušt8_t
 *
	mcdb
;

1950 
	mcdb_Ën
;

1951 
ušt8_t
 
	mcdb_buf
[
SCST_MAX_CDB_SIZE
];

1953 
sc¡_cdb_æags
 
	mÝ_æags
;

1954 cÚ¡ *
	mÝ_Çme
;

1956 
sc¡_cmd_queue_ty³
 
	mqueue_ty³
;

1958 
	mtimeout
;

1959 
	m»Œ›s
;

1962 
sc¡_d©a_dœeùiÚ
 
	md©a_dœeùiÚ
;

1965 
sc¡_d©a_dœeùiÚ
 
	mex³ùed_d©a_dœeùiÚ
;

1966 
	mex³ùed_Œªsãr_Ën
;

1967 
	mex³ùed_out_Œªsãr_Ën
;

1974 
	md©a_Ën
;

1977 (*
	msc¡_cmd_dÚe
è(
sc¡_cmd
 *
	mcmd
, 
	mÃxt_¡©e
,

1978 
sc¡_exec_cÚ‹xt
 
	m´ef_cÚ‹xt
);

1980 
sgv_poÞ_obj
 *
	msgv
;

1981 
	mbufæ’
;

1982 
sÿ‰”li¡
 *
	msg
;

1983 
	msg_út
;

1989 
	m»¥_d©a_Ën
;

1995 
	madju¡ed_»¥_d©a_Ën
;

2002 
	mwr™e_Ën
;

2008 
sÿ‰”li¡
 **
	mwr™e_sg
;

2009 *
	mwr™e_sg_út
;

2012 
sÿ‰”li¡
 *
	mg‘_sg_buf_cur_sg_’Œy
;

2013 
	mg‘_sg_buf_’Œy_num
;

2016 
	mout_bufæ’
;

2017 
sgv_poÞ_obj
 *
	mout_sgv
;

2018 
sÿ‰”li¡
 *
	mout_sg
;

2019 
	mout_sg_út
;

2030 
sÿ‰”li¡
 *
	mtgt_sg
;

2031 
	mtgt_sg_út
;

2032 
sÿ‰”li¡
 *
	mtgt_out_sg
;

2033 
	mtgt_out_sg_út
;

2039 
ušt8_t
 
	m¡©us
;

2040 
ušt8_t
 
	mmsg_¡©us
;

2041 
ušt8_t
 
	mho¡_¡©us
;

2042 
ušt8_t
 
	mdriv”_¡©us
;

2044 
ušt8_t
 *
	m£n£
;

2045 
	m£n£_v®id_Ën
;

2046 
	m£n£_buæ’
;

2049 
	mhw_³ndšg_¡¬t
;

2052 *
	mtgt_´iv
;

2055 *
	mdh_´iv
;

2058 
sÿ‰”li¡
 *
	mÜig_sg
;

2059 *
	mp_Üig_sg_út
;

2060 
	mÜig_sg_út
, 
	mÜig_sg_’Œy
, 
	mÜig_’Œy_Ën
;

2063 
	mdbl_ua_Üig_»¥_d©a_Ën
, 
	mdbl_ua_Üig_d©a_dœeùiÚ
;

2069 
li¡_h—d
 
	mmgmt_cmd_li¡
;

2072 
li¡_h—d
 
	mblocked_cmd_li¡_’Œy
;

2075 
sc¡_´_abÜt_®l_³ndšg_mgmt_cmds_couÁ”
 *
	m´_abÜt_couÁ”
;

2077 
sc¡_cmd
 *
	mÜig_cmd
;

2079 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


2084 
ušt64_t
 
	m¡¬t
, 
	mcu¼_¡¬t
, 
	m·r£_time
, 
	m®loc_buf_time
;

2085 
ušt64_t
 
	m»¡¬t_wa™šg_time
, 
	mrdy_to_xãr_time
;

2086 
ušt64_t
 
	m´e_exec_time
, 
	mexec_time
, 
	mdev_dÚe_time
;

2087 
ušt64_t
 
	mxm™_time
, 
	mtgt_Ú_ä“_time
, 
	mdev_Ú_ä“_time
;

2094 
	ssc¡_rx_mgmt_·¿ms
 {

2095 
	mâ
;

2096 
ušt64_t
 
	mg
;

2097 cÚ¡ 
ušt8_t
 *
	mlun
;

2098 
	mlun_Ën
;

2099 
ušt32_t
 
	mcmd_¢
;

2100 
	m©omic
;

2101 *
	mtgt_´iv
;

2102 
	mg_£t
;

2103 
	mlun_£t
;

2104 
	mcmd_¢_£t
;

2110 
	ssc¡_mgmt_cmd_¡ub
 {

2111 
sc¡_mgmt_cmd
 *
	mmcmd
;

2114 
li¡_h—d
 
	mcmd_mgmt_cmd_li¡_’Œy
;

2117 
	mdÚe_couÁed
:1;

2120 
	mfšish_couÁed
:1;

2126 
	ssc¡_mgmt_cmd
 {

2128 
li¡_h—d
 
	mmgmt_cmd_li¡_’Œy
;

2130 
sc¡_£ssiÚ
 *
	m£ss
;

2132 
©omic_t
 *
	mýu_cmd_couÁ”
;

2135 
	m¡©e
;

2137 
	mâ
;

2140 
	mÃeds_unblockšg
:1;

2141 
	mlun_£t
:1;

2142 
	mcmd_¢_£t
:1;

2148 
	mcmd_fšish_wa™_couÁ
;

2154 
	mcmd_dÚe_wa™_couÁ
;

2157 
	mcom¶‘ed_cmd_couÁ
;

2159 
ušt64_t
 
	mlun
;

2161 
ušt64_t
 
	mg
;

2163 
ušt32_t
 
	mcmd_¢
;

2166 
sc¡_cmd
 *
	mcmd_to_abÜt
;

2169 
sc¡_tgt_dev
 *
	mmcmd_tgt_dev
;

2172 
	m¡©us
;

2176 *
	mtgt_´iv
;

2177 
sc¡_cmd
 *
	mÜigš_´_cmd
;

2184 
	ssc¡_dev_»gi¡¿Á
 {

2185 
ušt8_t
 *
	mŒª¥Üt_id
;

2186 
ušt16_t
 
	m»l_tgt_id
;

2187 
__be64
 
	mkey
;

2190 
sc¡_tgt_dev
 *
	mtgt_dev
;

2193 
li¡_h—d
 
	mdev_»gi¡¿Ás_li¡_’Œy
;

2196 
li¡_h—d
 
	maux_li¡_’Œy
;

2197 
__be64
 
	mrÞlback_key
;

2203 
	ssc¡_deviû
 {

2204 
	mty³
;

2212 
	mdev_»£rved
:1;

2215 
	mdev_doubË_ua_possibË
:1;

2218 
	mrd_Úly
:1;

2221 
	m¡riùly_£rŸlized_cmd_wa™šg
:1;

2229 
	mdev_uÄegi¡”šg
:1;

2239 
	mqueue_®g
:4 
__©Œibu‹__
((
®igÃd
(())));

2240 
	mt¡
:3;

2241 
	ms
:1;

2242 
	mswp
:1;

2243 
	md_£n£
:1;

2250 
	mhas_own_Üd”_mgmt
:1;

2255 
©omic_t
 
	mdev_cmd_couÁ
;

2257 
¥šlock_t
 
	mdev_lock
;

2263 
	mblock_couÁ
;

2269 
	mÚ_dev_cmd_couÁ
;

2275 
	m´_»ad”s_couÁ
;

2281 
	m´_is_£t
:1 
__©Œibu‹__
((
®igÃd
(())));

2287 
	m´_wr™”_aùive
:1;

2289 
sc¡_dev_ty³
 *
	mhªdËr
;

2292 *
	mdh_´iv
;

2295 
scsi_deviû
 *
	mscsi_dev
;

2298 
sc¡_cmd_th»ads
 
	mdev_cmd_th»ads
;

2301 
sc¡_mem_lim
 
	mdev_mem_lim
;

2311 
	m´_­l
:1 
__©Œibu‹__
((
®igÃd
(())));

2314 
ušt8_t
 
	m´_ty³
;

2317 
ušt8_t
 
	m´_scÝe
;

2320 
mu‹x
 
	mdev_´_mu‹x
;

2323 
ušt32_t
 
	m´_g’”©iÚ
;

2326 
sc¡_dev_»gi¡¿Á
 *
	m´_hÞd”
;

2329 
li¡_h—d
 
	mdev_»gi¡¿Ás_li¡
;

2336 
	mnÙ_´_suµÜtšg_tgt_devs_num
;

2338 
sc¡_Üd”_d©a
 
	mdev_Üd”_d©a
;

2341 *
	m´_fže_Çme
;

2342 *
	m´_fže_Çme1
;

2347 
li¡_h—d
 
	mblocked_cmd_li¡
;

2350 
li¡_h—d
 
	mtm_dev_li¡_’Œy
;

2352 
	mvœt_id
;

2355 *
	mvœt_Çme
;

2357 
li¡_h—d
 
	mdev_li¡_’Œy
;

2363 
li¡_h—d
 
	mdev_tgt_dev_li¡
;

2366 
li¡_h—d
 
	mdev_acg_dev_li¡
;

2369 
	mth»ads_num
;

2372 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
	mth»ads_poÞ_ty³
;

2374 #iâdeà
CONFIG_SCST_PROC


2376 
com¶‘iÚ
 *
	mdev_kobj_»Ëa£_cm¶
;

2378 
kobjeù
 
	mdev_kobj
;

2379 
kobjeù
 *
	mdev_exp_kobj
;

2382 
	mdev_expÜ‹d_lun_num
;

2389 
	ssc¡_thr_d©a_hdr
 {

2391 
li¡_h—d
 
	mthr_d©a_li¡_’Œy
;

2392 
sk_¡ruù
 *
	mowÃr_thr
;

2393 
©omic_t
 
	m»f
;

2395 (*
	mä“_â
è(
sc¡_thr_d©a_hdr
 *
	md©a
);

2401 
	ssc¡_async_io_cÚ‹xt_k“³r
 {

2402 
k»f
 
	maic_k“³r_k»f
;

2403 
boÞ
 
	maic_»ady
;

2404 
io_cÚ‹xt
 *
	maic
;

2405 
sk_¡ruù
 *
	maic_k“³r_thr
;

2406 
wa™_queue_h—d_t
 
	maic_k“³r_wa™Q
;

2413 
	ssc¡_tgt_dev
 {

2415 
li¡_h—d
 
	m£ss_tgt_dev_li¡_’Œy
;

2417 
sc¡_deviû
 *
	mdev
;

2418 
ušt64_t
 
	mlun
;

2420 
gå_t
 
	mgå_mask
;

2421 
sgv_poÞ
 *
	mpoÞ
;

2422 
	mmax_sg_út
;

2428 
	mtgt_dev_æags
;

2431 *
	mdh_´iv
;

2434 
©omic_t
 
	mtgt_dev_cmd_couÁ
;

2436 
sc¡_Üd”_d©a
 *
	mcu¼_Üd”_d©a
;

2437 
sc¡_Üd”_d©a
 
	mtgt_dev_Üd”_d©a
;

2440 
¥šlock_t
 
	mthr_d©a_lock
;

2441 
li¡_h—d
 
	mthr_d©a_li¡
;

2444 
sc¡_cmd_th»ads
 *
	maùive_cmd_th»ads
;

2450 
io_cÚ‹xt
 *
	masync_io_cÚ‹xt
;

2452 
sc¡_async_io_cÚ‹xt_k“³r
 *
	maic_k“³r
;

2456 
sc¡_cmd_th»ads
 
	mtgt_dev_cmd_th»ads
;

2459 
¥šlock_t
 
	mtgt_dev_lock
;

2462 
li¡_h—d
 
	mUA_li¡
;

2464 
sc¡_£ssiÚ
 *
	m£ss
;

2465 
sc¡_acg_dev
 *
	macg_dev
;

2468 
sc¡_dev_»gi¡¿Á
 *
	m»gi¡¿Á
;

2471 
li¡_h—d
 
	mdev_tgt_dev_li¡_’Œy
;

2474 
li¡_h—d
 
	mexŒa_tgt_dev_li¡_’Œy
;

2477 
	mšq_chªged_ua_Ãeded
:1;

2483 
	mtgt_dev_v®id_£n£_Ën
;

2484 
ušt8_t
 
	mtgt_dev_£n£
[
SCST_SENSE_BUFFERSIZE
];

2486 #iâdeà
CONFIG_SCST_PROC


2488 
com¶‘iÚ
 *
	mtgt_dev_kobj_»Ëa£_cm¶
;

2490 
kobjeù
 
	mtgt_dev_kobj
;

2493 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


2500 
ušt64_t
 
	msc¡_time
, 
	mtgt_time
, 
	mdev_time
;

2501 
	m´oûs£d_cmds
;

2502 
sc¡_ext_Ï‹ncy_¡©
 
	mdev_Ï‹ncy_¡©
[
SCST_LATENCY_STATS_NUM
];

2509 
	ssc¡_acg_dev
 {

2510 
sc¡_deviû
 *
	mdev
;

2512 
ušt64_t
 
	mlun
;

2515 
	mrd_Úly
:1;

2517 
sc¡_acg
 *
	macg
;

2520 
li¡_h—d
 
	mdev_acg_dev_li¡_’Œy
;

2523 
li¡_h—d
 
	macg_dev_li¡_’Œy
;

2525 #iâdeà
CONFIG_SCST_PROC


2527 
kobjeù
 
	macg_dev_kobj
;

2530 
com¶‘iÚ
 *
	macg_dev_kobj_»Ëa£_cm¶
;

2533 
	macg_dev_lšk_Çme
[20];

2541 
	ssc¡_acg
 {

2543 
sc¡_tgt
 *
	mtgt
;

2546 
li¡_h—d
 
	macg_dev_li¡
;

2549 
li¡_h—d
 
	macg_£ss_li¡
;

2552 
li¡_h—d
 
	maú_li¡
;

2555 
li¡_h—d
 
	macg_li¡_’Œy
;

2558 cÚ¡ *
	macg_Çme
;

2560 #ifdeà
CONFIG_SCST_PROC


2562 
´oc_dœ_’Œy
 *
	macg_´oc_roÙ
;

2566 
	macg_io_groupšg_ty³
;

2569 
ýumask_t
 
	macg_ýu_mask
;

2571 
	mtgt_acg
:1;

2574 
com¶‘iÚ
 *
	macg_kobj_»Ëa£_cm¶
;

2576 #iâdeà
CONFIG_SCST_PROC


2578 
kobjeù
 
	macg_kobj
;

2580 
kobjeù
 *
	mluns_kobj
;

2581 
kobjeù
 *
	mš™ŸtÜs_kobj
;

2584 
sc¡_lun_addr_m‘hod
 
	maddr_m‘hod
;

2591 
	ssc¡_aú
 {

2592 
sc¡_acg
 *
	macg
;

2594 cÚ¡ *
	mÇme
;

2597 
li¡_h—d
 
	maú_li¡_’Œy
;

2600 
kobj_©Œibu‹
 *
	maú_©Œ
;

2609 
	ssc¡_dev_group
 {

2610 *
	mÇme
;

2611 
li¡_h—d
 
	m’Œy
;

2612 
li¡_h—d
 
	mdev_li¡
;

2613 
li¡_h—d
 
	mtg_li¡
;

2614 
kobjeù
 
	mkobj
;

2615 
kobjeù
 *
	mdev_kobj
;

2616 
kobjeù
 *
	mtg_kobj
;

2622 
	ssc¡_dg_dev
 {

2623 
li¡_h—d
 
	m’Œy
;

2624 
sc¡_deviû
 *
	mdev
;

2633 
	ssc¡_rg‘_group
 {

2634 
sc¡_dev_group
 *
	mdg
;

2635 *
	mÇme
;

2636 
ušt16_t
 
	mgroup_id
;

2637 
sc¡_tg_¡©e
 
	m¡©e
;

2638 
boÞ
 
	m´eã¼ed
;

2639 
li¡_h—d
 
	m’Œy
;

2640 
li¡_h—d
 
	mtgt_li¡
;

2641 
kobjeù
 
	mkobj
;

2652 
	ssc¡_tg_tgt
 {

2653 
li¡_h—d
 
	m’Œy
;

2654 
sc¡_rg‘_group
 *
	mtg
;

2655 
kobjeù
 
	mkobj
;

2656 
sc¡_tgt
 *
	mtgt
;

2657 *
	mÇme
;

2658 
ušt16_t
 
	m»l_tgt_id
;

2665 
	ssc¡_tgt_dev_UA
 {

2667 
li¡_h—d
 
	mUA_li¡_’Œy
;

2670 
	mglob®_UA
:1;

2673 
	mUA_v®id_£n£_Ën
;

2675 
ušt8_t
 
	mUA_£n£_bufãr
[
SCST_SENSE_BUFFERSIZE
];

2679 
	ssc¡_«n
 {

2680 
	mev’t_â
;

2682 
sc¡_£ssiÚ
 *
	m£ss
;

2683 
__be64
 
	mlun
;

2688 
	m«n_£n£_Ën
;

2689 
ušt8_t
 
	m«n_£n£
[
SCST_STANDARD_SENSE_LEN
];

2694 
	md–iv”y_¡©us
;

2697 #iâdeà
smp_mb__aá”_£t_b™


2699 
	#smp_mb__aá”_£t_b™
(è
	`smp_mb
()

	)

2706 
__sc¡_»gi¡”_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
,

2707 cÚ¡ *
v”siÚ
);

2708 
šlše
 
	$sc¡_»gi¡”_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
)

2710  
	`__sc¡_»gi¡”_rg‘_‹m¶©e
(
v‰
, 
SCST_INTERFACE_VERSION
);

2711 
	}
}

2719 
__sc¡_»gi¡”_rg‘_‹m¶©e_nÚ_g¶
(
sc¡_tgt_‹m¶©e
 *
v‰
,

2720 cÚ¡ *
v”siÚ
);

2721 
šlše
 
	$sc¡_»gi¡”_rg‘_‹m¶©e_nÚ_g¶
(

2722 
sc¡_tgt_‹m¶©e
 *
v‰
)

2724  
	`__sc¡_»gi¡”_rg‘_‹m¶©e_nÚ_g¶
(
v‰
,

2725 
SCST_INTERFACE_VERSION
);

2726 
	}
}

2728 
sc¡_uÄegi¡”_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
);

2730 
sc¡_tgt
 *
sc¡_»gi¡”_rg‘
(
sc¡_tgt_‹m¶©e
 *
v‰
,

2731 cÚ¡ *
rg‘_Çme
);

2732 
sc¡_uÄegi¡”_rg‘
(
sc¡_tgt
 *
tgt
);

2734 
sc¡_£ssiÚ
 *
sc¡_»gi¡”_£ssiÚ
(
sc¡_tgt
 *
tgt
, 
©omic
,

2735 cÚ¡ *
š™ŸtÜ_Çme
, *
tgt_´iv
, *
»suÉ_â_d©a
,

2736 (*
»suÉ_â
è(
sc¡_£ssiÚ
 *
£ss
, *
d©a
, 
»suÉ
));

2737 
sc¡_£ssiÚ
 *
	`sc¡_»gi¡”_£ssiÚ_nÚ_g¶
(
sc¡_tgt
 *
tgt
,

2738 cÚ¡ *
š™ŸtÜ_Çme
, *
tgt_´iv
);

2739 
	`sc¡_uÄegi¡”_£ssiÚ
(
sc¡_£ssiÚ
 *
£ss
, 
wa™
,

2740 (*
uÄeg_dÚe_â
è(
sc¡_£ssiÚ
 *
£ss
));

2741 
	`sc¡_uÄegi¡”_£ssiÚ_nÚ_g¶
(
sc¡_£ssiÚ
 *
£ss
);

2743 
	`__sc¡_»gi¡”_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
,

2744 cÚ¡ *
v”siÚ
);

2745 
šlše
 
	$sc¡_»gi¡”_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
)

2747  
	`__sc¡_»gi¡”_dev_driv”
(
dev_ty³
, 
SCST_INTERFACE_VERSION
);

2748 
	}
}

2749 
sc¡_uÄegi¡”_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
);

2751 
__sc¡_»gi¡”_vœtu®_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
,

2752 cÚ¡ *
v”siÚ
);

2757 
šlše
 
	$sc¡_»gi¡”_vœtu®_dev_driv”
(

2758 
sc¡_dev_ty³
 *
dev_ty³
)

2760  
	`__sc¡_»gi¡”_vœtu®_dev_driv”
(
dev_ty³
,

2761 
SCST_INTERFACE_VERSION
);

2762 
	}
}

2764 
sc¡_uÄegi¡”_vœtu®_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
);

2766 
boÞ
 
sc¡_š™ŸtÜ_has_luns
(
sc¡_tgt
 *
tgt
, cÚ¡ *
š™ŸtÜ_Çme
);

2768 
sc¡_cmd
 *
sc¡_rx_cmd
(
sc¡_£ssiÚ
 *
£ss
,

2769 cÚ¡ 
ušt8_t
 *
lun
, 
lun_Ën
, cÚ¡ ušt8_ˆ*
cdb
,

2770 
cdb_Ën
, 
©omic
);

2771 
sc¡_cmd_š™_dÚe
(
sc¡_cmd
 *
cmd
,

2772 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
);

2783 
šlše
 
	$sc¡_cmd_š™_¡age1_dÚe
(
sc¡_cmd
 *
cmd
,

2784 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
, 
£t_¢
)

2786 
cmd
->
´•roûssšg_Úly
 = 1;

2787 
cmd
->
£t_¢_Ú_»¡¬t_cmd
 = !
£t_¢
;

2788 
	`sc¡_cmd_š™_dÚe
(
cmd
, 
´ef_cÚ‹xt
);

2789 
	}
}

2791 
sc¡_»¡¬t_cmd
(
sc¡_cmd
 *
cmd
, 
¡©us
,

2792 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
);

2794 
sc¡_rx_d©a
(
sc¡_cmd
 *
cmd
, 
¡©us
,

2795 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
);

2797 
sc¡_tgt_cmd_dÚe
(
sc¡_cmd
 *
cmd
,

2798 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
);

2800 
sc¡_rx_mgmt_â
(
sc¡_£ssiÚ
 *
£ss
,

2801 cÚ¡ 
sc¡_rx_mgmt_·¿ms
 *
·¿ms
);

2811 
šlše
 
	$sc¡_rx_mgmt_â_g
(
sc¡_£ssiÚ
 *
£ss
, 
â
,

2812 
ušt64_t
 
g
, 
©omic
, *
tgt_´iv
)

2814 
sc¡_rx_mgmt_·¿ms
 
·¿ms
;

2816 
	`BUG_ON
(
â
 !ð
SCST_ABORT_TASK
);

2818 
	`mem£t
(&
·¿ms
, 0, (params));

2819 
·¿ms
.
â
 = fn;

2820 
·¿ms
.
g
 =ag;

2821 
·¿ms
.
g_£t
 = 1;

2822 
·¿ms
.
©omic
 =‡tomic;

2823 
·¿ms
.
tgt_´iv
 =gt_priv;

2824  
	`sc¡_rx_mgmt_â
(
£ss
, &
·¿ms
);

2825 
	}
}

2835 
šlše
 
	$sc¡_rx_mgmt_â_lun
(
sc¡_£ssiÚ
 *
£ss
, 
â
,

2836 cÚ¡ 
ušt8_t
 *
lun
, 
lun_Ën
, 
©omic
, *
tgt_´iv
)

2838 
sc¡_rx_mgmt_·¿ms
 
·¿ms
;

2840 
	`BUG_ON
(
â
 =ð
SCST_ABORT_TASK
);

2842 
	`mem£t
(&
·¿ms
, 0, (params));

2843 
·¿ms
.
â
 = fn;

2844 
·¿ms
.
lun
 =†un;

2845 
·¿ms
.
lun_Ën
 =†un_len;

2846 
·¿ms
.
lun_£t
 = 1;

2847 
·¿ms
.
©omic
 =‡tomic;

2848 
·¿ms
.
tgt_´iv
 =gt_priv;

2849  
	`sc¡_rx_mgmt_â
(
£ss
, &
·¿ms
);

2850 
	}
}

2852 
sc¡_g‘_cdb_šfo
(
sc¡_cmd
 *
cmd
);

2854 
sc¡_£t_cmd_”rÜ_¡©us
(
sc¡_cmd
 *
cmd
, 
¡©us
);

2855 
sc¡_£t_cmd_”rÜ
(
sc¡_cmd
 *
cmd
, 
key
, 
asc
, 
ascq
);

2856 
sc¡_£t_busy
(
sc¡_cmd
 *
cmd
);

2858 
sc¡_check_cÚv”t_£n£
(
sc¡_cmd
 *
cmd
);

2860 
sc¡_£t_š™Ÿl_UA
(
sc¡_£ssiÚ
 *
£ss
, 
key
, 
asc
, 
ascq
);

2862 
sc¡_ÿ·c™y_d©a_chªged
(
sc¡_deviû
 *
dev
);

2864 
sc¡_cmd
 *
sc¡_fšd_cmd_by_g
(
sc¡_£ssiÚ
 *
£ss
, 
ušt64_t
 
g
);

2865 
sc¡_cmd
 *
sc¡_fšd_cmd
(
sc¡_£ssiÚ
 *
£ss
, *
d©a
,

2866 (*
cmp_â
è(
sc¡_cmd
 *
cmd
,

2867 *
d©a
));

2869 
dma_d©a_dœeùiÚ
 
	`sc¡_to_dma_dœ
(
sc¡_dœ
);

2870 
dma_d©a_dœeùiÚ
 
	`sc¡_to_tgt_dma_dœ
(
sc¡_dœ
);

2876 
šlše
 
boÞ
 
	$sc¡_is_cmd_fuÎy_loÿl
(
sc¡_cmd
 *
cmd
)

2878  (
cmd
->
Ý_æags
 & 
SCST_FULLY_LOCAL_CMD
) != 0;

2879 
	}
}

2885 
šlše
 
boÞ
 
	$sc¡_is_cmd_loÿl
(
sc¡_cmd
 *
cmd
)

2887  (
cmd
->
Ý_æags
 & 
SCST_LOCAL_CMD
) != 0;

2888 
	}
}

2891 
šlše
 
boÞ
 
	$sc¡_is_ua_commªd
(
sc¡_cmd
 *
cmd
)

2893  (
cmd
->
Ý_æags
 & 
SCST_SKIP_UA
) == 0;

2894 
	}
}

2896 
sc¡_»gi¡”_vœtu®_deviû
(
sc¡_dev_ty³
 *
dev_hªdËr
,

2897 cÚ¡ *
dev_Çme
);

2898 
sc¡_uÄegi¡”_vœtu®_deviû
(
id
);

2903 
šlše
 
	$sc¡_tgt_g‘_sg_bËsize
(
sc¡_tgt
 *
tgt
)

2905  
tgt
->
sg_bËsize
;

2906 
	}
}

2908 
šlše
 
	$sc¡_tgt_£t_sg_bËsize
(
sc¡_tgt
 *
tgt
, 
v®
)

2910 
tgt
->
sg_bËsize
 = 
v®
;

2911 
	}
}

2916 
šlše
 *
	$sc¡_tgt_g‘_tgt_´iv
(
sc¡_tgt
 *
tgt
)

2918  
tgt
->
tgt_´iv
;

2919 
	}
}

2921 
šlše
 
	$sc¡_tgt_£t_tgt_´iv
(
sc¡_tgt
 *
tgt
, *
v®
)

2923 
tgt
->
tgt_´iv
 = 
v®
;

2924 
	}
}

2926 
sc¡_upd©e_hw_³ndšg_¡¬t
(
sc¡_cmd
 *
cmd
);

2931 
šlše
 *
	$sc¡_£ss_g‘_tgt_´iv
(
sc¡_£ssiÚ
 *
£ss
)

2933  
£ss
->
tgt_´iv
;

2934 
	}
}

2936 
šlše
 
	$sc¡_£ss_£t_tgt_´iv
(
sc¡_£ssiÚ
 *
£ss
,

2937 *
v®
)

2939 
£ss
->
tgt_´iv
 = 
v®
;

2940 
	}
}

2942 
ušt16_t
 
sc¡_lookup_tg_id
(
sc¡_deviû
 *
dev
, 
sc¡_tgt
 *
tgt
);

2943 
boÞ
 
sc¡_im¶_®ua_cÚfigu»d
(
sc¡_deviû
 *
dev
);

2944 
sc¡_tg_g‘_group_šfo
(**
buf
, 
ušt32_t
 *
»¥Ú£_Ëngth
,

2945 
sc¡_deviû
 *
dev
, 
ušt8_t
 
d©a_fÜm©
);

2953 
šlše
 
boÞ
 
	$sc¡_cmd_©omic
(
sc¡_cmd
 *
cmd
)

2955 
»s
 = 
cmd
->
©omic
;

2956 #ifdeà
CONFIG_SCST_EXTRACHECKS


2962 ià(
	`uÆik–y
((
	`š_©omic
(è|| 
	`š_š‹¼u±
(è|| 
	`œqs_di§bËd
()) &&

2963 !
»s
)) {

2964 
	`´štk
(
KERN_ERR
 "ERROR:‡tomic context‡nd‚on-atomic cmd!\n");

2965 
	`dump_¡ack
();

2966 
cmd
->
©omic
 = 1;

2967 
»s
 = 1;

2970  
»s
;

2971 
	}
}

2977 
šlše
 
boÞ
 
	$sc¡_cmd_´–im_com¶‘ed
(
sc¡_cmd
 *
cmd
)

2979  
cmd
->
com¶‘ed
 || 
	`‹¡_b™
(
SCST_CMD_ABORTED
, &cmd->
cmd_æags
);

2980 
	}
}

2982 
šlše
 
sc¡_exec_cÚ‹xt
 
	$__sc¡_e¡im©e_cÚ‹xt
(
boÞ
 
©omic
)

2984 ià(
	`š_œq
())

2985  
SCST_CONTEXT_TASKLET
;

2993 ià(
	`œqs_di§bËd
())

2994  
SCST_CONTEXT_THREAD
;

2995 ià(
	`š_©omic
())

2996  
SCST_CONTEXT_DIRECT_ATOMIC
;

2998  
©omic
 ? 
SCST_CONTEXT_DIRECT
 :

2999 
SCST_CONTEXT_DIRECT_ATOMIC
;

3001  
SCST_CONTEXT_THREAD
;

3003 
	}
}

3005 
šlše
 
sc¡_exec_cÚ‹xt
 
	$sc¡_e¡im©e_cÚ‹xt
()

3007  
	`__sc¡_e¡im©e_cÚ‹xt
(
çl£
);

3008 
	}
}

3010 
šlše
 
sc¡_exec_cÚ‹xt
 
	$sc¡_e¡im©e_cÚ‹xt_©omic
()

3012  
	`__sc¡_e¡im©e_cÚ‹xt
(
Œue
);

3013 
	}
}

3016 
šlše
 cÚ¡ 
ušt8_t
 *
	$sc¡_cmd_g‘_cdb
(
sc¡_cmd
 *
cmd
)

3018  
cmd
->
cdb
;

3019 
	}
}

3022 
šlše
 
	$sc¡_cmd_g‘_cdb_Ën
(
sc¡_cmd
 *
cmd
)

3024  
cmd
->
cdb_Ën
;

3025 
	}
}

3027 
sc¡_cmd_£t_ext_cdb
(
sc¡_cmd
 *
cmd
,

3028 
ušt8_t
 *
ext_cdb
, 
ext_cdb_Ën
, 
gå_t
 
gå_mask
);

3031 
šlše
 
sc¡_£ssiÚ
 *
	$sc¡_cmd_g‘_£ssiÚ
(
sc¡_cmd
 *
cmd
)

3033  
cmd
->
£ss
;

3034 
	}
}

3037 
šlše
 
	$sc¡_cmd_g‘_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
)

3039  
cmd
->
»¥_d©a_Ën
;

3040 
	}
}

3043 
šlše
 
	$sc¡_cmd_g‘_adju¡ed_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
)

3045  
cmd
->
adju¡ed_»¥_d©a_Ën
;

3046 
	}
}

3049 
šlše
 
	$sc¡_cmd_g‘_is_£nd_¡©us
(
sc¡_cmd
 *
cmd
)

3051  
cmd
->
is_£nd_¡©us
;

3052 
	}
}

3060 
šlše
 
sÿ‰”li¡
 *
	$sc¡_cmd_g‘_sg
(
sc¡_cmd
 *
cmd
)

3062  
cmd
->
sg
;

3063 
	}
}

3071 
šlše
 
	$sc¡_cmd_g‘_sg_út
(
sc¡_cmd
 *
cmd
)

3073  
cmd
->
sg_út
;

3074 
	}
}

3083 
šlše
 
	$sc¡_cmd_g‘_bufæ’
(
sc¡_cmd
 *
cmd
)

3085  
cmd
->
bufæ’
;

3086 
	}
}

3094 
šlše
 
sÿ‰”li¡
 *
	$sc¡_cmd_g‘_out_sg
(
sc¡_cmd
 *
cmd
)

3096  
cmd
->
out_sg
;

3097 
	}
}

3105 
šlše
 
	$sc¡_cmd_g‘_out_sg_út
(
sc¡_cmd
 *
cmd
)

3107  
cmd
->
out_sg_út
;

3108 
	}
}

3110 
sc¡_»¡Üe_sg_buff
(
sc¡_cmd
 *
cmd
);

3113 
šlše
 
	$sc¡_check_»¡Üe_sg_buff
(
sc¡_cmd
 *
cmd
)

3115 ià(
	`uÆik–y
(
cmd
->
sg_buff_modif›d
))

3116 
	`sc¡_»¡Üe_sg_buff
(
cmd
);

3117 
	}
}

3126 
šlše
 
	$sc¡_cmd_g‘_out_bufæ’
(
sc¡_cmd
 *
cmd
)

3128  
cmd
->
out_bufæ’
;

3129 
	}
}

3132 
šlše
 
sÿ‰”li¡
 *
	$sc¡_cmd_g‘_tgt_sg
(
sc¡_cmd
 *
cmd
)

3134  
cmd
->
tgt_sg
;

3135 
	}
}

3138 
šlše
 
	$sc¡_cmd_g‘_tgt_sg_út
(
sc¡_cmd
 *
cmd
)

3140  
cmd
->
tgt_sg_út
;

3141 
	}
}

3144 
šlše
 
	$sc¡_cmd_£t_tgt_sg
(
sc¡_cmd
 *
cmd
,

3145 
sÿ‰”li¡
 *
sg
, 
sg_út
)

3147 
cmd
->
tgt_sg
 = 
sg
;

3148 
cmd
->
tgt_sg_út
 = 
sg_út
;

3149 
cmd
->
tgt_d©a_buf_®loûd
 = 1;

3150 
	}
}

3153 
šlše
 
sÿ‰”li¡
 *
	$sc¡_cmd_g‘_out_tgt_sg
(
sc¡_cmd
 *
cmd
)

3155  
cmd
->
tgt_out_sg
;

3156 
	}
}

3159 
šlše
 
	$sc¡_cmd_g‘_tgt_out_sg_út
(
sc¡_cmd
 *
cmd
)

3161  
cmd
->
tgt_out_sg_út
;

3162 
	}
}

3165 
šlše
 
	$sc¡_cmd_£t_tgt_out_sg
(
sc¡_cmd
 *
cmd
,

3166 
sÿ‰”li¡
 *
sg
, 
sg_út
)

3168 
	`WARN_ON
(!
cmd
->
tgt_d©a_buf_®loûd
);

3170 
cmd
->
tgt_out_sg
 = 
sg
;

3171 
cmd
->
tgt_out_sg_út
 = 
sg_út
;

3172 
	}
}

3175 
šlše
 
sc¡_d©a_dœeùiÚ
 
	$sc¡_cmd_g‘_d©a_dœeùiÚ
(

3176 
sc¡_cmd
 *
cmd
)

3178  
cmd
->
d©a_dœeùiÚ
;

3179 
	}
}

3182 
šlše
 
	$sc¡_cmd_g‘_wr™e_f›lds
(
sc¡_cmd
 *
cmd
,

3183 
sÿ‰”li¡
 **
sg
, *
sg_út
)

3185 *
sg
 = *
cmd
->
wr™e_sg
;

3186 *
sg_út
 = *
cmd
->
wr™e_sg_út
;

3187  
cmd
->
wr™e_Ën
;

3188 
	}
}

3190 
sc¡_cmd_£t_wr™e_nÙ_»ûived_d©a_Ën
(
sc¡_cmd
 *
cmd
,

3191 
nÙ_»ûived
);

3193 
boÞ
 
__sc¡_g‘_»sid
(
sc¡_cmd
 *
cmd
, *
»sid
, *
bidi_out_»sid
);

3199 
šlše
 
boÞ
 
	$sc¡_g‘_»sid
(
sc¡_cmd
 *
cmd
,

3200 *
»sid
, *
bidi_out_»sid
)

3202 ià(
	`lik–y
(!
cmd
->
»sid_possibË
))

3203  
çl£
;

3204  
	`__sc¡_g‘_»sid
(
cmd
, 
»sid
, 
bidi_out_»sid
);

3205 
	}
}

3208 
šlše
 
ušt8_t
 
	$sc¡_cmd_g‘_¡©us
(
sc¡_cmd
 *
cmd
)

3210  
cmd
->
¡©us
;

3211 
	}
}

3214 
šlše
 
ušt8_t
 
	$sc¡_cmd_g‘_msg_¡©us
(
sc¡_cmd
 *
cmd
)

3216  
cmd
->
msg_¡©us
;

3217 
	}
}

3220 
šlše
 
ušt8_t
 
	$sc¡_cmd_g‘_ho¡_¡©us
(
sc¡_cmd
 *
cmd
)

3222  
cmd
->
ho¡_¡©us
;

3223 
	}
}

3226 
šlše
 
ušt8_t
 
	$sc¡_cmd_g‘_driv”_¡©us
(
sc¡_cmd
 *
cmd
)

3228  
cmd
->
driv”_¡©us
;

3229 
	}
}

3232 
šlše
 
ušt8_t
 *
	$sc¡_cmd_g‘_£n£_bufãr
(
sc¡_cmd
 *
cmd
)

3234  
cmd
->
£n£
;

3235 
	}
}

3238 
šlše
 
	$sc¡_cmd_g‘_£n£_bufãr_Ën
(
sc¡_cmd
 *
cmd
)

3240  
cmd
->
£n£_v®id_Ën
;

3241 
	}
}

3246 
šlše
 
sc¡_cmd_queue_ty³
 
	$sc¡_cmd_g‘_queue_ty³
(

3247 
sc¡_cmd
 *
cmd
)

3249  
cmd
->
queue_ty³
;

3250 
	}
}

3252 
šlše
 
	$sc¡_cmd_£t_queue_ty³
(
sc¡_cmd
 *
cmd
,

3253 
sc¡_cmd_queue_ty³
 
queue_ty³
)

3255 
cmd
->
queue_ty³
 = queue_type;

3256 
	}
}

3261 
šlše
 
ušt64_t
 
	$sc¡_cmd_g‘_g
(
sc¡_cmd
 *
cmd
)

3263  
cmd
->
g
;

3264 
	}
}

3266 
šlše
 
	$sc¡_cmd_£t_g
(
sc¡_cmd
 *
cmd
, 
ušt64_t
 
g
)

3268 
cmd
->
g
 =ag;

3269 
	}
}

3277 
šlše
 *
	$sc¡_cmd_g‘_tgt_´iv
(
sc¡_cmd
 *
cmd
)

3279  
cmd
->
tgt_´iv
;

3280 
	}
}

3282 
šlše
 
	$sc¡_cmd_£t_tgt_´iv
(
sc¡_cmd
 *
cmd
, *
v®
)

3284 
cmd
->
tgt_´iv
 = 
v®
;

3285 
	}
}

3290 
šlše
 
	$sc¡_cmd_g‘_tgt_Ãed_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
)

3292  
cmd
->
tgt_Ãed_®loc_d©a_buf
;

3293 
	}
}

3295 
šlše
 
	$sc¡_cmd_£t_tgt_Ãed_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
)

3297 
cmd
->
tgt_Ãed_®loc_d©a_buf
 = 1;

3298 
	}
}

3303 
šlše
 
	$sc¡_cmd_g‘_tgt_d©a_buff_®loûd
(
sc¡_cmd
 *
cmd
)

3305  
cmd
->
tgt_d©a_buf_®loûd
;

3306 
	}
}

3308 
šlše
 
	$sc¡_cmd_£t_tgt_d©a_buff_®loûd
(
sc¡_cmd
 *
cmd
)

3310 
cmd
->
tgt_d©a_buf_®loûd
 = 1;

3311 
	}
}

3316 
šlše
 
	$sc¡_cmd_g‘_dh_d©a_buff_®loûd
(
sc¡_cmd
 *
cmd
)

3318  
cmd
->
dh_d©a_buf_®loûd
;

3319 
	}
}

3321 
šlše
 
	$sc¡_cmd_£t_dh_d©a_buff_®loûd
(
sc¡_cmd
 *
cmd
)

3323 
cmd
->
dh_d©a_buf_®loûd
 = 1;

3324 
	}
}

3329 
šlše
 
	$sc¡_cmd_g‘_no_sgv
(
sc¡_cmd
 *
cmd
)

3331  
cmd
->
no_sgv
;

3332 
	}
}

3334 
šlše
 
	$sc¡_cmd_£t_no_sgv
(
sc¡_cmd
 *
cmd
)

3336 
cmd
->
no_sgv
 = 1;

3337 
	}
}

3342 
šlše
 
	$sc¡_cmd_g‘_tgt_¢
(
sc¡_cmd
 *
cmd
)

3344 
	`BUG_ON
(!
cmd
->
tgt_¢_£t
);

3345  
cmd
->
tgt_¢
;

3346 
	}
}

3348 
šlše
 
	$sc¡_cmd_£t_tgt_¢
(
sc¡_cmd
 *
cmd
, 
ušt32_t
 
tgt_¢
)

3350 
cmd
->
tgt_¢_£t
 = 1;

3351 
cmd
->
tgt_¢
 =gt_sn;

3352 
	}
}

3357 
šlše
 
boÞ
 
	$sc¡_cmd_g‘_noio_mem_®loc
(
sc¡_cmd
 *
cmd
)

3359  
cmd
->
noio_mem_®loc
;

3360 
	}
}

3362 
šlše
 
	$sc¡_cmd_£t_noio_mem_®loc
(
sc¡_cmd
 *
cmd
)

3364 
cmd
->
noio_mem_®loc
 = 1;

3365 
	}
}

3372 
šlše
 
	$sc¡_cmd_abÜ‹d
(
sc¡_cmd
 *
cmd
)

3374  
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
) &&

3375 !
	`‹¡_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
);

3376 
	}
}

3379 
šlše
 
boÞ
 
	$sc¡_g‘_cmd_dev_d_£n£
(
sc¡_cmd
 *
cmd
)

3381  (
cmd
->
dev
 !ð
NULL
è? cmd->dev->
d_£n£
 : 0;

3382 
	}
}

3388 
šlše
 
	$sc¡_cmd_is_ex³ùed_£t
(
sc¡_cmd
 *
cmd
)

3390  
cmd
->
ex³ùed_v®ues_£t
;

3391 
	}
}

3393 
šlše
 
sc¡_d©a_dœeùiÚ
 
	$sc¡_cmd_g‘_ex³ùed_d©a_dœeùiÚ
(

3394 
sc¡_cmd
 *
cmd
)

3396  
cmd
->
ex³ùed_d©a_dœeùiÚ
;

3397 
	}
}

3399 
šlše
 
	$sc¡_cmd_g‘_ex³ùed_Œªsãr_Ën
(

3400 
sc¡_cmd
 *
cmd
)

3402  
cmd
->
ex³ùed_Œªsãr_Ën
;

3403 
	}
}

3405 
šlše
 
	$sc¡_cmd_g‘_ex³ùed_out_Œªsãr_Ën
(

3406 
sc¡_cmd
 *
cmd
)

3408  
cmd
->
ex³ùed_out_Œªsãr_Ën
;

3409 
	}
}

3411 
šlše
 
	$sc¡_cmd_£t_ex³ùed
(
sc¡_cmd
 *
cmd
,

3412 
sc¡_d©a_dœeùiÚ
 
ex³ùed_d©a_dœeùiÚ
,

3413 
ex³ùed_Œªsãr_Ën
)

3415 
cmd
->
ex³ùed_d©a_dœeùiÚ
 =ƒxpected_data_direction;

3416 
cmd
->
ex³ùed_Œªsãr_Ën
 =ƒxpected_transfer_len;

3417 
cmd
->
ex³ùed_v®ues_£t
 = 1;

3418 
	}
}

3420 
šlše
 
	$sc¡_cmd_£t_ex³ùed_out_Œªsãr_Ën
(
sc¡_cmd
 *
cmd
,

3421 
ex³ùed_out_Œªsãr_Ën
)

3423 
	`WARN_ON
(!
cmd
->
ex³ùed_v®ues_£t
);

3424 
cmd
->
ex³ùed_out_Œªsãr_Ën
 =ƒxpected_out_transfer_len;

3425 
	}
}

3430 
šlše
 
	$sc¡_g‘_may_Ãed_dma_sync
(
sc¡_cmd
 *
cmd
)

3432  
cmd
->
may_Ãed_dma_sync
;

3433 
	}
}

3435 
šlše
 
	$sc¡_þ—r_may_Ãed_dma_sync
(
sc¡_cmd
 *
cmd
)

3437 
cmd
->
may_Ãed_dma_sync
 = 0;

3438 
	}
}

3445 
šlše
 
	$sc¡_g‘_d–iv”y_¡©us
(
sc¡_cmd
 *
cmd
)

3447  
cmd
->
d–iv”y_¡©us
;

3448 
	}
}

3450 
šlše
 
	$sc¡_£t_d–iv”y_¡©us
(
sc¡_cmd
 *
cmd
,

3451 
d–iv”y_¡©us
)

3453 
cmd
->
d–iv”y_¡©us
 = delivery_status;

3454 
	}
}

3456 
šlše
 
	$sc¡_g‘_aùive_cmd_couÁ
(
sc¡_cmd
 *
cmd
)

3458 ià(
	`lik–y
(
cmd
->
tgt_dev
 !ð
NULL
))

3459  
	`©omic_»ad
(&
cmd
->
tgt_dev
->
tgt_dev_cmd_couÁ
);

3462 
	}
}

3467 
šlše
 *
	$sc¡_mgmt_cmd_g‘_tgt_´iv
(
sc¡_mgmt_cmd
 *
mcmd
)

3469  
mcmd
->
tgt_´iv
;

3470 
	}
}

3472 
šlše
 
	$sc¡_mgmt_cmd_£t_tgt_´iv
(
sc¡_mgmt_cmd
 *
mcmd
,

3473 *
v®
)

3475 
mcmd
->
tgt_´iv
 = 
v®
;

3476 
	}
}

3479 
šlše
 
	$sc¡_mgmt_cmd_g‘_¡©us
(
sc¡_mgmt_cmd
 *
mcmd
)

3481  
mcmd
->
¡©us
;

3482 
	}
}

3485 
šlše
 
	$sc¡_mgmt_cmd_g‘_â
(
sc¡_mgmt_cmd
 *
mcmd
)

3487  
mcmd
->
â
;

3488 
	}
}

3494 
sc¡_´•¬e_async_mcmd
(
sc¡_mgmt_cmd
 *
mcmd
);

3500 
sc¡_async_mcmd_com¶‘ed
(
sc¡_mgmt_cmd
 *
mcmd
, 
¡©us
);

3503 
šlše
 
	$sc¡_«n_g‘_ev’t_â
(
sc¡_«n
 *
«n
)

3505  
«n
->
ev’t_â
;

3506 
	}
}

3509 
šlše
 
sc¡_£ssiÚ
 *
	$sc¡_«n_g‘_£ss
(
sc¡_«n
 *
«n
)

3511  
«n
->
£ss
;

3512 
	}
}

3515 
šlše
 
__be64
 
	$sc¡_«n_g‘_lun
(
sc¡_«n
 *
«n
)

3517  
«n
->
lun
;

3518 
	}
}

3521 
šlše
 cÚ¡ 
ušt8_t
 *
	$sc¡_«n_g‘_£n£
(
sc¡_«n
 *
«n
)

3523  
«n
->
«n_£n£
;

3524 
	}
}

3527 
šlše
 
	$sc¡_«n_g‘_£n£_Ën
(
sc¡_«n
 *
«n
)

3529  
«n
->
«n_£n£_Ën
;

3530 
	}
}

3537 
šlše
 
	$sc¡_g‘_«n_d–iv”y_¡©us
(
sc¡_«n
 *
«n
)

3539  
«n
->
d–iv”y_¡©us
;

3540 
	}
}

3542 
šlše
 
	$sc¡_£t_«n_d–iv”y_¡©us
(
sc¡_«n
 *
«n
,

3543 
¡©us
)

3545 
«n
->
d–iv”y_¡©us
 = 
¡©us
;

3546 
	}
}

3548 
sc¡_«n_dÚe
(
sc¡_«n
 *
«n
);

3550 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24)

3561 #iâdeà
__BACKPORT_LINUX_SCATTERLIST_H_TO_2_6_23__


3563 
šlše
 
boÞ
 
	$sg_is_chaš
(
sÿ‰”li¡
 *
sg
)

3565  
çl£
;

3566 
	}
}

3568 
šlše
 
sÿ‰”li¡
 *
	$sg_chaš_±r
(
sÿ‰”li¡
 *
sg
)

3570  
NULL
;

3571 
	}
}

3573 
šlše
 
·ge
 *
	$sg_·ge
(
sÿ‰”li¡
 *
sg
)

3575  
sg
->
·ge
;

3576 
	}
}

3578 
šlše
 *
	$sg_vœt
(
sÿ‰”li¡
 *
sg
)

3580  
	`·ge_add»ss
(
	`sg_·ge
(
sg
)è+ sg->
off£t
;

3581 
	}
}

3583 
šlše
 
	$sg_š™_bË
(
sÿ‰”li¡
 *
sgl
, 
ÃÁs
)

3585 
	`mem£t
(
sgl
, 0, (*sglè* 
ÃÁs
);

3586 
	}
}

3588 
šlše
 
	$sg_assign_·ge
(
sÿ‰”li¡
 *
sg
, 
·ge
 *page)

3590 
sg
->
·ge
 =…age;

3591 
	}
}

3593 
šlše
 
	$sg_£t_·ge
(
sÿ‰”li¡
 *
sg
, 
·ge
 *page,

3594 
Ën
, 
off£t
)

3596 
	`sg_assign_·ge
(
sg
, 
·ge
);

3597 
sg
->
off£t
 = offset;

3598 
sg
->
Ëngth
 = 
Ën
;

3599 
	}
}

3601 
šlše
 
sÿ‰”li¡
 *
	$sg_Ãxt
(
sÿ‰”li¡
 *
sg
)

3603 
sg
++;

3604  
sg
;

3605 
	}
}

3611 
šlše
 
	$sg_þ—r
(
sÿ‰”li¡
 *
sg
)

3613 
	`mem£t
(
sg
, 0, (*sg));

3614 #ifdeà
CONFIG_DEBUG_SG


3615 
sg
->
sg_magic
 = 
SG_MAGIC
;

3617 
	}
}

3619 
	esc¡_sg_cÝy_dœ
 {

3620 
	mSCST_SG_COPY_FROM_TARGET
,

3621 
	mSCST_SG_COPY_TO_TARGET


3624 
sc¡_cÝy_sg
(
sc¡_cmd
 *
cmd
, 
sc¡_sg_cÝy_dœ
 
cÝy_dœ
);

3639 
šlše
 
	$__sc¡_g‘_buf
(
sc¡_cmd
 *
cmd
, 
sg_út
,

3640 
ušt8_t
 **
buf
)

3642 
»s
 = 0;

3643 
sÿ‰”li¡
 *
sg
 = 
cmd
->
g‘_sg_buf_cur_sg_’Œy
;

3645 ià(
cmd
->
g‘_sg_buf_’Œy_num
 >ð
sg_út
) {

3646 *
buf
 = 
NULL
;

3647 
out
;

3650 ià(
	`uÆik–y
(
	`sg_is_chaš
(
sg
)))

3651 
sg
 = 
	`sg_chaš_±r
(sg);

3653 *
buf
 = 
	`·ge_add»ss
(
	`sg_·ge
(
sg
));

3654 *
buf
 +ð
sg
->
off£t
;

3656 
»s
 = 
sg
->
Ëngth
;

3658 
cmd
->
g‘_sg_buf_’Œy_num
++;

3659 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = ++
sg
;

3661 
out
:

3662  
»s
;

3663 
	}
}

3665 
šlše
 
	$sc¡_g‘_buf_fœ¡
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

3667 ià(
	`uÆik–y
(
cmd
->
sg
 =ð
NULL
)) {

3668 *
buf
 = 
NULL
;

3671 
cmd
->
g‘_sg_buf_’Œy_num
 = 0;

3672 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = cmd->
sg
;

3673 
cmd
->
may_Ãed_dma_sync
 = 1;

3674  
	`__sc¡_g‘_buf
(
cmd
, cmd->
sg_út
, 
buf
);

3675 
	}
}

3677 
šlše
 
	$sc¡_g‘_buf_Ãxt
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

3679  
	`__sc¡_g‘_buf
(
cmd
, cmd->
sg_út
, 
buf
);

3680 
	}
}

3682 
šlše
 
	$sc¡_put_buf
(
sc¡_cmd
 *
cmd
, *
buf
)

3685 
	}
}

3687 
šlše
 
	$sc¡_g‘_out_buf_fœ¡
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

3689 ià(
	`uÆik–y
(
cmd
->
out_sg
 =ð
NULL
)) {

3690 *
buf
 = 
NULL
;

3693 
cmd
->
g‘_sg_buf_’Œy_num
 = 0;

3694 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = cmd->
out_sg
;

3695 
cmd
->
may_Ãed_dma_sync
 = 1;

3696  
	`__sc¡_g‘_buf
(
cmd
, cmd->
out_sg_út
, 
buf
);

3697 
	}
}

3699 
šlše
 
	$sc¡_g‘_out_buf_Ãxt
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

3701  
	`__sc¡_g‘_buf
(
cmd
, cmd->
out_sg_út
, 
buf
);

3702 
	}
}

3704 
šlše
 
	$sc¡_put_out_buf
(
sc¡_cmd
 *
cmd
, *
buf
)

3707 
	}
}

3709 
šlše
 
	$sc¡_g‘_sg_buf_fœ¡
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
,

3710 
sÿ‰”li¡
 *
sg
, 
sg_út
)

3712 ià(
	`uÆik–y
(
sg
 =ð
NULL
)) {

3713 *
buf
 = 
NULL
;

3716 
cmd
->
g‘_sg_buf_’Œy_num
 = 0;

3717 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = cmd->
sg
;

3718 
cmd
->
may_Ãed_dma_sync
 = 1;

3719  
	`__sc¡_g‘_buf
(
cmd
, 
sg_út
, 
buf
);

3720 
	}
}

3722 
šlše
 
	$sc¡_g‘_sg_buf_Ãxt
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
,

3723 
sÿ‰”li¡
 *
sg
, 
sg_út
)

3725  
	`__sc¡_g‘_buf
(
cmd
, 
sg_út
, 
buf
);

3726 
	}
}

3728 
šlše
 
	$sc¡_put_sg_buf
(
sc¡_cmd
 *
cmd
, *
buf
,

3729 
sÿ‰”li¡
 *
sg
, 
sg_út
)

3732 
	}
}

3744 
šlše
 
	$__sc¡_g‘_sg_·ge
(
sc¡_cmd
 *
cmd
, 
sg_út
,

3745 
·ge
 **·ge, *
off£t
)

3747 
»s
 = 0;

3748 
sÿ‰”li¡
 *
sg
 = 
cmd
->
g‘_sg_buf_cur_sg_’Œy
;

3750 ià(
cmd
->
g‘_sg_buf_’Œy_num
 >ð
sg_út
) {

3751 *
·ge
 = 
NULL
;

3752 *
off£t
 = 0;

3753 
out
;

3756 ià(
	`uÆik–y
(
	`sg_is_chaš
(
sg
)))

3757 
sg
 = 
	`sg_chaš_±r
(sg);

3759 *
·ge
 = 
	`sg_·ge
(
sg
);

3760 *
off£t
 = 
sg
->offset;

3761 
»s
 = 
sg
->
Ëngth
;

3763 
cmd
->
g‘_sg_buf_’Œy_num
++;

3764 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = ++
sg
;

3766 
out
:

3767  
»s
;

3768 
	}
}

3770 
šlše
 
	$sc¡_g‘_sg_·ge_fœ¡
(
sc¡_cmd
 *
cmd
,

3771 
·ge
 **·ge, *
off£t
)

3773 ià(
	`uÆik–y
(
cmd
->
sg
 =ð
NULL
)) {

3774 *
·ge
 = 
NULL
;

3775 *
off£t
 = 0;

3778 
cmd
->
g‘_sg_buf_’Œy_num
 = 0;

3779 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = cmd->
sg
;

3780  
	`__sc¡_g‘_sg_·ge
(
cmd
, cmd->
sg_út
, 
·ge
, 
off£t
);

3781 
	}
}

3783 
šlše
 
	$sc¡_g‘_sg_·ge_Ãxt
(
sc¡_cmd
 *
cmd
,

3784 
·ge
 **·ge, *
off£t
)

3786  
	`__sc¡_g‘_sg_·ge
(
cmd
, cmd->
sg_út
, 
·ge
, 
off£t
);

3787 
	}
}

3789 
šlše
 
	$sc¡_put_sg_·ge
(
sc¡_cmd
 *
cmd
,

3790 
·ge
 *·ge, 
off£t
)

3793 
	}
}

3795 
šlše
 
	$sc¡_g‘_out_sg_·ge_fœ¡
(
sc¡_cmd
 *
cmd
,

3796 
·ge
 **·ge, *
off£t
)

3798 ià(
	`uÆik–y
(
cmd
->
out_sg
 =ð
NULL
)) {

3799 *
·ge
 = 
NULL
;

3800 *
off£t
 = 0;

3803 
cmd
->
g‘_sg_buf_’Œy_num
 = 0;

3804 
cmd
->
g‘_sg_buf_cur_sg_’Œy
 = cmd->
out_sg
;

3805  
	`__sc¡_g‘_sg_·ge
(
cmd
, cmd->
out_sg_út
, 
·ge
, 
off£t
);

3806 
	}
}

3808 
šlše
 
	$sc¡_g‘_out_sg_·ge_Ãxt
(
sc¡_cmd
 *
cmd
,

3809 
·ge
 **·ge, *
off£t
)

3811  
	`__sc¡_g‘_sg_·ge
(
cmd
, cmd->
out_sg_út
, 
·ge
, 
off£t
);

3812 
	}
}

3814 
šlše
 
	$sc¡_put_out_sg_·ge
(
sc¡_cmd
 *
cmd
,

3815 
·ge
 *·ge, 
off£t
)

3818 
	}
}

3824 
šlše
 
	$sc¡_g‘_buf_couÁ
(
sc¡_cmd
 *
cmd
)

3826  (
cmd
->
sg_út
 == 0) ? 1 : cmd->sg_cnt;

3827 
	}
}

3833 
šlše
 
	$sc¡_g‘_out_buf_couÁ
(
sc¡_cmd
 *
cmd
)

3835  (
cmd
->
out_sg_út
 == 0) ? 1 : cmd->out_sg_cnt;

3836 
	}
}

3838 
sc¡_g‘_buf_fuÎ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
);

3839 
sc¡_put_buf_fuÎ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
buf
);

3841 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 23è&& !
defšed
(
BACKPORT_LINUX_WORKQUEUE_TO_2_6_19
)

3842 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 20))

3843 
šlše
 
	$ÿnûl_d–ayed_wÜk_sync
(
d–ayed_wÜk
 *
wÜk
)

3845 
šlše
 
	$ÿnûl_d–ayed_wÜk_sync
(
wÜk_¡ruù
 *
wÜk
)

3848 
»s
;

3850 
»s
 = 
	`ÿnûl_d–ayed_wÜk
(
wÜk
);

3851 
	`æush_scheduËd_wÜk
();

3852  
»s
;

3853 
	}
}

3856 #ifdeà
CONFIG_DEBUG_LOCK_ALLOC


3857 
lockd•_m­
 
sc¡_su¥’d_d•_m­
;

3858 
	#sc¡_as£¹_aùiv™y_su¥’ded
() \

3859 
	`WARN_ON
(
debug_locks
 && !
	`lock_is_h–d
(&
sc¡_su¥’d_d•_m­
));

	)

3861 
	#sc¡_as£¹_aùiv™y_su¥’ded
(èdØ{ } 0)

	)

3863 
sc¡_su¥’d_aùiv™y
(
boÞ
 
š‹¼u±ibË
);

3864 
sc¡_»sume_aùiv™y
();

3866 
sc¡_´oûss_aùive_cmd
(
sc¡_cmd
 *
cmd
, 
boÞ
 
©omic
);

3868 
sc¡_po¡_·r£
(
sc¡_cmd
 *
cmd
);

3869 
sc¡_po¡_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
);

3871 
sc¡_check_loÿl_ev’ts
(
sc¡_cmd
 *
cmd
);

3873 
šlše
 
	$sc¡_´e_check_loÿl_ev’ts
(
sc¡_cmd
 *
cmd
)

3875 
»s
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

3876 
cmd
->
check_loÿl_ev’ts_Úû_dÚe
 = 1;

3877  
»s
;

3878 
	}
}

3880 
sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
sc¡_cmd
 *
cmd
);

3882 
	ssc¡_Œaû_log
 {

3883 
	mv®
;

3884 cÚ¡ *
	mtok’
;

3887 
mu‹x
 
sc¡_mu‹x
;

3889 #ifdeà
CONFIG_SCST_PROC


3896 
´oc_dœ_’Œy
 *
sc¡_´oc_g‘_tgt_roÙ
(

3897 
sc¡_tgt_‹m¶©e
 *
v‰
);

3904 
´oc_dœ_’Œy
 *
sc¡_´oc_g‘_dev_ty³_roÙ
(

3905 
sc¡_dev_ty³
 *
d‰
);

3917 
sc¡_´oc_log_’Œy_»ad
(
£q_fže
 *
£q
, 
log_Ëv–
,

3918 cÚ¡ 
sc¡_Œaû_log
 *
tbl
);

3919 
sc¡_´oc_log_’Œy_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

3920 
Ëngth
, *
log_Ëv–
,

3921 
deçuÉ_Ëv–
, cÚ¡ 
sc¡_Œaû_log
 *
tbl
);

3926 
	ssc¡_´oc_d©a
 {

3927 cÚ¡ 
fže_Ý”©iÚs
 
	m£q_Ý
;

3928 (*
	mshow
)(
	m£q_fže
 *, *);

3929 *
	md©a
;

3932 
sc¡_sšgË_£q_Ý’
(
šode
 *šode, 
fže
 *file);

3934 
´oc_dœ_’Œy
 *
sc¡_ü—‹_´oc_’Œy
(´oc_dœ_’Œy *
roÙ
,

3935 cÚ¡ *
Çme
, 
sc¡_´oc_d©a
 *
pd©a
);

3937 
	#SCST_DEF_RW_SEQ_OP
(
x
) \

3938 .
£q_Ý
 = { \

3939 .
owÃr
 = 
THIS_MODULE
, \

3940 .
Ý’
 = 
sc¡_sšgË_£q_Ý’
,\

3941 .
»ad
 = 
£q_»ad
, \

3942 .
wr™e
 = 
x
, \

3943 .
Î£ek
 = 
£q_l£ek
, \

3944 .
»Ëa£
 = 
sšgË_»Ëa£
, \

3945 },

	)

3949 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 34))

3950 cÚ¡ 
sysfs_Ýs
 *
sc¡_sysfs_g‘_sysfs_Ýs
();

3952 
sysfs_Ýs
 *
sc¡_sysfs_g‘_sysfs_Ýs
();

3959 
šlše
 
kobjeù
 *
	$sc¡_sysfs_g‘_tg‰_kobj
(

3960 
sc¡_tgt_‹m¶©e
 *
tg‰
)

3962  &
tg‰
->
tg‰_kobj
;

3963 
	}
}

3969 
šlše
 
kobjeù
 *
	$sc¡_sysfs_g‘_tgt_kobj
(

3970 
sc¡_tgt
 *
tgt
)

3972  &
tgt
->
tgt_kobj
;

3973 
	}
}

3979 
šlše
 
kobjeù
 *
	$sc¡_sysfs_g‘_devt_kobj
(

3980 
sc¡_dev_ty³
 *
devt
)

3982  &
devt
->
devt_kobj
;

3983 
	}
}

3989 
šlše
 
kobjeù
 *
	$sc¡_sysfs_g‘_dev_kobj
(

3990 
sc¡_deviû
 *
dev
)

3992  &
dev
->
dev_kobj
;

3993 
	}
}

3999 
šlše
 
kobjeù
 *
	$sc¡_sysfs_g‘_£ss_kobj
(

4000 
sc¡_£ssiÚ
 *
£ss
)

4002  &
£ss
->
£ss_kobj
;

4003 
	}
}

4008 
šlše
 cÚ¡ *
	$sc¡_g‘_tgt_Çme
(cÚ¡ 
sc¡_tgt
 *
tgt
)

4010  
tgt
->
tgt_Çme
;

4011 
	}
}

4013 
sc¡_®loc_£n£
(
sc¡_cmd
 *
cmd
, 
©omic
);

4014 
sc¡_®loc_£t_£n£
(
sc¡_cmd
 *
cmd
, 
©omic
,

4015 cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
);

4017 
sc¡_£t_£n£
(
ušt8_t
 *
bufãr
, 
Ën
, 
boÞ
 
d_£n£
,

4018 
key
, 
asc
, 
ascq
);

4020 
boÞ
 
sc¡_is_ua_£n£
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
);

4022 
boÞ
 
sc¡_ª®yze_£n£
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
,

4023 
v®id_mask
, 
key
, 
asc
, 
ascq
);

4025 
sc¡_¿ndom
();

4027 
sc¡_£t_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
, 
»¥_d©a_Ën
);

4029 
sc¡_cmd_g‘
(
sc¡_cmd
 *
cmd
);

4030 
sc¡_cmd_put
(
sc¡_cmd
 *
cmd
);

4032 
sÿ‰”li¡
 *
sc¡_®loc
(
size
, 
gå_t
 
gå_mask
, *
couÁ
);

4033 
sc¡_ä“
(
sÿ‰”li¡
 *
sg
, 
couÁ
);

4035 
sc¡_add_thr_d©a
(
sc¡_tgt_dev
 *
tgt_dev
,

4036 
sc¡_thr_d©a_hdr
 *
d©a
,

4037 (*
ä“_â
è(
sc¡_thr_d©a_hdr
 *
d©a
));

4038 
	`sc¡_d–_®l_thr_d©a
(
sc¡_tgt_dev
 *
tgt_dev
);

4039 
	`sc¡_dev_d–_®l_thr_d©a
(
sc¡_deviû
 *
dev
);

4040 
sc¡_thr_d©a_hdr
 *
	`__sc¡_fšd_thr_d©a
(
sc¡_tgt_dev
 *
tgt_dev
,

4041 
sk_¡ruù
 *
tsk
);

4044 
šlše
 
sc¡_thr_d©a_hdr
 *
	$sc¡_fšd_thr_d©a
(

4045 
sc¡_tgt_dev
 *
tgt_dev
)

4047  
	`__sc¡_fšd_thr_d©a
(
tgt_dev
, 
cu¼’t
);

4048 
	}
}

4051 
šlše
 
	$sc¡_thr_d©a_g‘
(
sc¡_thr_d©a_hdr
 *
d©a
)

4053 
	`©omic_šc
(&
d©a
->
»f
);

4054 
	}
}

4057 
šlše
 
	$sc¡_thr_d©a_put
(
sc¡_thr_d©a_hdr
 *
d©a
)

4059 ià(
	`©omic_dec_ªd_‹¡
(&
d©a
->
»f
))

4060 
d©a
->
	`ä“_â
(data);

4061 
	}
}

4063 
sc¡_ÿlc_block_shiá
(
£ùÜ_size
);

4064 
sc¡_sbc_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

4065 (*
g‘_block_shiá
)(
sc¡_cmd
 *
cmd
));

4066 
	`sc¡_cdrom_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

4067 (*
g‘_block_shiá
)(
sc¡_cmd
 *
cmd
));

4068 
	`sc¡_modisk_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

4069 (*
g‘_block_shiá
)(
sc¡_cmd
 *
cmd
));

4070 
	`sc¡_³_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

4071 (*
g‘_block_size
)(
sc¡_cmd
 *
cmd
));

4072 
	`sc¡_chªg”_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

4073 (*
nÙhšg
)(
sc¡_cmd
 *
cmd
));

4074 
	`sc¡_´oûssÜ_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

4075 (*
nÙhšg
)(
sc¡_cmd
 *
cmd
));

4076 
	`sc¡_¿id_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

4077 (*
nÙhšg
)(
sc¡_cmd
 *
cmd
));

4079 
	`sc¡_block_g’”ic_dev_dÚe
(
sc¡_cmd
 *
cmd
,

4080 (*
£t_block_shiá
)(
sc¡_cmd
 *
cmd
, 
block_shiá
));

4081 
	`sc¡_³_g’”ic_dev_dÚe
(
sc¡_cmd
 *
cmd
,

4082 (*
£t_block_size
)(
sc¡_cmd
 *
cmd
, 
block_size
));

4084 
	`sc¡_obš_deviû_·¿m‘”s
(
sc¡_deviû
 *
dev
);

4086 
	`sc¡_»assign_³rsi¡’t_£ss_¡©es
(
sc¡_£ssiÚ
 *
Ãw_£ss
,

4087 
sc¡_£ssiÚ
 *
Þd_£ss
);

4089 
	`sc¡_g‘_max_lun_commªds
(
sc¡_£ssiÚ
 *
£ss
, 
ušt64_t
 
lun
);

4096 
šlše
 
	$add_wa™_queue_exþusive_h—d
(
wa™_queue_h—d_t
 *
q
,

4097 
wa™_queue_t
 *
wa™
)

4099 
æags
;

4101 
wa™
->
æags
 |ð
WQ_FLAG_EXCLUSIVE
;

4102 
	`¥š_lock_œq§ve
(&
q
->
lock
, 
æags
);

4103 
	`__add_wa™_queue
(
q
, 
wa™
);

4104 
	`¥š_uÆock_œq»¡Üe
(&
q
->
lock
, 
æags
);

4105 
	}
}

4107 #iâdeà
CONFIG_SCST_PROC


4112 
	ssc¡_sysfs_u£r_šfo
 {

4114 
ušt32_t
 
	mšfo_cook›
;

4117 
li¡_h—d
 
	mšfo_li¡_’Œy
;

4120 
	mšfo_bešg_execu‹d
:1;

4123 
	mšfo_š_li¡
:1;

4126 
com¶‘iÚ
 
	mšfo_com¶‘iÚ
;

4129 
	mšfo_¡©us
;

4130 *
	md©a
;

4133 
sc¡_sysfs_u£r_add_šfo
(
sc¡_sysfs_u£r_šfo
 **
out_šfo
);

4134 
sc¡_sysfs_u£r_d–_šfo
(
sc¡_sysfs_u£r_šfo
 *
šfo
);

4135 
sc¡_sysfs_u£r_šfo
 *
sc¡_sysfs_u£r_g‘_šfo
(
ušt32_t
 
cook›
);

4136 
sc¡_wa™_šfo_com¶‘iÚ
(
sc¡_sysfs_u£r_šfo
 *
šfo
,

4137 
timeout
);

4139 
sc¡_g‘_£tup_id
();

4151 
	ssc¡_sysfs_wÜk_™em
 {

4160 
boÞ
 
	m»ad_Úly_aùiÚ
;

4162 
li¡_h—d
 
	msysfs_wÜk_li¡_’Œy
;

4163 
k»f
 
	msysfs_wÜk_k»f
;

4164 (*
	msysfs_wÜk_â
)(
sc¡_sysfs_wÜk_™em
 *
	mwÜk
);

4165 
com¶‘iÚ
 
	msysfs_wÜk_dÚe
;

4166 *
	mbuf
;

4169 
sc¡_dev_ty³
 *
	mdevt
;

4170 
sc¡_tgt_‹m¶©e
 *
	mtg‰
;

4172 
sc¡_tgt
 *
	mtgt
;

4173 
sc¡_acg
 *
	macg
;

4175 
boÞ
 
	mis_tgt_kobj
;

4176 
	mio_groupšg_ty³
;

4177 
boÞ
 
	m’abË
;

4178 
ýumask_t
 
	mýu_mask
;

4182 
sc¡_deviû
 *
	mdev
;

4183 
	mÃw_th»ads_num
;

4184 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
	mÃw_th»ads_poÞ_ty³
;

4186 
sc¡_£ssiÚ
 *
	m£ss
;

4188 
sc¡_tgt
 *
	mtgt_r
;

4189 
	m»l_tgt_id
;

4192 
kobjeù
 *
	mkobj
;

4195 
	mwÜk_»s
;

4196 *
	m»s_buf
;

4199 
sc¡_®loc_sysfs_wÜk
((*
sysfs_wÜk_â
)(
sc¡_sysfs_wÜk_™em
 *),

4200 
boÞ
 
»ad_Úly_aùiÚ
, 
sc¡_sysfs_wÜk_™em
 **
»s_wÜk
);

4201 
	`sc¡_sysfs_queue_wa™_wÜk
(
sc¡_sysfs_wÜk_™em
 *
wÜk
);

4202 
	`sc¡_sysfs_wÜk_g‘
(
sc¡_sysfs_wÜk_™em
 *
wÜk
);

4203 
	`sc¡_sysfs_wÜk_put
(
sc¡_sysfs_wÜk_™em
 *
wÜk
);

4207 *
	`sc¡_g‘_Ãxt_Ëxem
(**
tok’_¡r
);

4208 
	`sc¡_»¡Üe_tok’_¡r
(*
´ev_Ëxem
, *
tok’_¡r
);

4209 *
	`sc¡_g‘_Ãxt_tok’_¡r
(**
šput_¡r
);

4211 
	`sc¡_š™_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
);

4212 
	`sc¡_deš™_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
);

4214 
	`sc¡_·ss_through_cmd_dÚe
(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
);

4215 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)è&& 
	`defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

4216 
	`sc¡_scsi_exec_async
(
sc¡_cmd
 *
cmd
, *
d©a
,

4217 (*
dÚe
)(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
));

	@/root/Desktop/scst-2.2.0/include/scst_const.h

21 #iâdeà
__SCST_CONST_H


22 
	#__SCST_CONST_H


	)

24 #iâdeà
GENERATING_UPSTREAM_PATCH


30 
	~<lšux/v”siÚ.h
>

32 
	~<scsi/scsi.h
>

40 
	#SCST_VERSION
(
a
, 
b
, 
c
, 
d
è((×è<< 24è+ ((bè<< 16è+ ((cè<< 8è+ d)

	)

41 
	#SCST_VERSION_CODE
 
	`SCST_VERSION
(2, 2, 0, 0)

	)

42 #ifdeà
CONFIG_SCST_PROC


43 
	#SCST_VERSION_STRING_SUFFIX
 "-´ocfs"

	)

45 
	#SCST_VERSION_STRING_SUFFIX


	)

47 
	#SCST_VERSION_NAME
 "2.2.0"

	)

48 
	#SCST_VERSION_STRING
 
SCST_VERSION_NAME
 
SCST_VERSION_STRING_SUFFIX


	)

50 
	#SCST_CONST_VERSION
 "$RevisiÚ: 4021 $"

	)

55 
	#SCST_MAX_CDB_SIZE
 16

	)

58 
	#SCST_MAX_LONG_CDB_SIZE
 65536

	)

61 
	#SCST_MAX_NAME
 50

	)

64 
	#SCST_MAX_EXTERNAL_NAME
 256

	)

67 
	#SCST_MAX_LUN
 ((1 << (16-2)è- 1)

	)

73 
	#SCST_STANDARD_SENSE_LEN
 18

	)

76 
	#SCST_SENSE_BUFFERSIZE
 96

	)

82 
	#SCST_CMD_DELIVERY_SUCCESS
 0

	)

83 
	#SCST_CMD_DELIVERY_FAILED
 -1

	)

84 
	#SCST_CMD_DELIVERY_ABORTED
 -2

	)

89 
	#SCST_ABORT_TASK
 0

	)

90 
	#SCST_ABORT_TASK_SET
 1

	)

91 
	#SCST_CLEAR_ACA
 2

	)

92 
	#SCST_CLEAR_TASK_SET
 3

	)

93 
	#SCST_LUN_RESET
 4

	)

94 
	#SCST_TARGET_RESET
 5

	)

103 
	#SCST_NEXUS_LOSS_SESS
 6

	)

106 
	#SCST_ABORT_ALL_TASKS_SESS
 7

	)

113 
	#SCST_NEXUS_LOSS
 8

	)

116 
	#SCST_ABORT_ALL_TASKS
 9

	)

127 
	#SCST_UNREG_SESS_TM
 10

	)

142 
	#SCST_PR_ABORT_ALL
 11

	)

147 
	#SCST_MGMT_STATUS_SUCCESS
 0

	)

148 
	#SCST_MGMT_STATUS_TASK_NOT_EXIST
 -1

	)

149 
	#SCST_MGMT_STATUS_LUN_NOT_EXIST
 -2

	)

150 
	#SCST_MGMT_STATUS_FN_NOT_SUPPORTED
 -5

	)

151 
	#SCST_MGMT_STATUS_REJECTED
 -255

	)

152 
	#SCST_MGMT_STATUS_FAILED
 -129

	)

158 
	esc¡_lun_addr_m‘hod
 {

159 
	mSCST_LUN_ADDR_METHOD_PERIPHERAL
 = 0,

160 
	mSCST_LUN_ADDR_METHOD_FLAT
 = 1,

161 
	mSCST_LUN_ADDR_METHOD_LUN
 = 2,

162 
	mSCST_LUN_ADDR_METHOD_EXTENDED_LUN
 = 3,

168 
	esc¡_cmd_queue_ty³
 {

169 
	mSCST_CMD_QUEUE_UNTAGGED
 = 0,

170 
	mSCST_CMD_QUEUE_SIMPLE
,

171 
	mSCST_CMD_QUEUE_ORDERED
,

172 
	mSCST_CMD_QUEUE_HEAD_OF_QUEUE
,

173 
	mSCST_CMD_QUEUE_ACA


179 
	esc¡_cdb_æags
 {

180 
	mSCST_TRANSFER_LEN_TYPE_FIXED
 = 0x0001,

181 
	mSCST_SMALL_TIMEOUT
 = 0x0002,

182 
	mSCST_LONG_TIMEOUT
 = 0x0004,

183 
	mSCST_UNKNOWN_LENGTH
 = 0x0008,

184 
	mSCST_INFO_VALID
 = 0x0010,

185 
	mSCST_VERIFY_BYTCHK_MISMATCH_ALLOWED
 = 0x0020,

186 
	mSCST_IMPLICIT_HQ
 = 0x0040,

187 
	mSCST_SKIP_UA
 = 0x0080,

188 
	mSCST_WRITE_MEDIUM
 = 0x0100,

189 
	mSCST_LOCAL_CMD
 = 0x0200,

190 
	mSCST_FULLY_LOCAL_CMD
 = 0x0400,

191 
	mSCST_REG_RESERVE_ALLOWED
 = 0x0800,

192 
	mSCST_WRITE_EXCL_ALLOWED
 = 0x1000,

193 
	mSCST_EXCL_ACCESS_ALLOWED
 = 0x2000,

194 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


195 
	mSCST_TEST_IO_IN_SIRQ_ALLOWED
 = 0x4000,

197 
	mSCST_SERIALIZED
 = 0x8000,

198 
	mSCST_STRICTLY_SERIALIZED
 = 0x10000|
SCST_SERIALIZED
,

205 
	#SCST_DATA_UNKNOWN
 0

	)

206 
	#SCST_DATA_WRITE
 1

	)

207 
	#SCST_DATA_READ
 2

	)

208 
	#SCST_DATA_BIDI
 (
SCST_DATA_WRITE
 | 
SCST_DATA_READ
)

	)

209 
	#SCST_DATA_NONE
 4

	)

211 
	#SCST_DATA_DIR_MAX
 (
SCST_DATA_NONE
+1)

	)

213 #ifdeà
CONFIG_SCST_PROC


218 
	#SCST_DEFAULT_ACG_NAME
 "DeçuÉ"

	)

225 
	#SCST_DEFAULT_TGT_NAME_SUFFIX
 "_rg‘_"

	)

230 
	#SCST_LOAD_SENSE
(
key_asc_ascq
è
	)
key_asc_ascq

232 
	#SCST_SENSE_VALID
(
£n£
è((£n£ !ð
NULL
) && \

233 ((((cÚ¡ 
ušt8_t
 *)(
£n£
))[0] & 0x70è=ð0x70))

	)

235 
	#SCST_NO_SENSE
(
£n£
è((£n£ !ð
NULL
) && \

236 (((cÚ¡ 
ušt8_t
 *)(
£n£
))[2] =ð0))

	)

242 
	#sc¡_£n£_no_£n£
 
NO_SENSE
, 0x00, 0

	)

243 
	#sc¡_£n£_h¬dw_”rÜ
 
HARDWARE_ERROR
, 0x44, 0

	)

244 
	#sc¡_£n£_abÜ‹d_commªd
 
ABORTED_COMMAND
, 0x00, 0

	)

245 
	#sc¡_£n£_šv®id_Ýcode
 
ILLEGAL_REQUEST
, 0x20, 0

	)

246 
	#sc¡_£n£_šv®id_f›ld_š_cdb
 
ILLEGAL_REQUEST
, 0x24, 0

	)

247 
	#sc¡_£n£_šv®id_f›ld_š_·rm_li¡
 
ILLEGAL_REQUEST
, 0x26, 0

	)

248 
	#sc¡_£n£_·¿m‘”_v®ue_šv®id
 
ILLEGAL_REQUEST
, 0x26, 2

	)

249 
	#sc¡_£n£_šv®id_»Ëa£
 
ILLEGAL_REQUEST
, 0x26, 4

	)

250 
	#sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
 \

251 
ILLEGAL_REQUEST
, 0x1A, 0

	)

252 
	#sc¡_£n£_»£t_UA
 
UNIT_ATTENTION
, 0x29, 0

	)

253 
	#sc¡_£n£_Ãxus_loss_UA
 
UNIT_ATTENTION
, 0x29, 0x7

	)

254 
	#sc¡_£n£_§všg_·¿ms_unsup
 
ILLEGAL_REQUEST
, 0x39, 0

	)

255 
	#sc¡_£n£_lun_nÙ_suµÜ‹d
 
ILLEGAL_REQUEST
, 0x25, 0

	)

256 
	#sc¡_£n£_d©a_´Ùeù
 
DATA_PROTECT
, 0x00, 0

	)

257 
	#sc¡_£n£_miscom·»_”rÜ
 
MISCOMPARE
, 0x1D, 0

	)

258 
	#sc¡_£n£_block_out_¿nge_”rÜ
 
ILLEGAL_REQUEST
, 0x21, 0

	)

259 
	#sc¡_£n£_medium_chªged_UA
 
UNIT_ATTENTION
, 0x28, 0

	)

260 
	#sc¡_£n£_»ad_”rÜ
 
MEDIUM_ERROR
, 0x11, 0

	)

261 
	#sc¡_£n£_wr™e_”rÜ
 
MEDIUM_ERROR
, 0x03, 0

	)

262 
	#sc¡_£n£_nÙ_»ady
 
NOT_READY
, 0x04, 0x10

	)

263 
	#sc¡_£n£_šv®id_mes§ge
 
ILLEGAL_REQUEST
, 0x49, 0

	)

264 
	#sc¡_£n£_þ—»d_by_ªÙh”_ši_UA
 
UNIT_ATTENTION
, 0x2F, 0

	)

265 
	#sc¡_£n£_ÿ·c™y_d©a_chªged
 
UNIT_ATTENTION
, 0x2A, 0x9

	)

266 
	#sc¡_£n£_»£rv©iÚ_´“m±ed
 
UNIT_ATTENTION
, 0x2A, 0x03

	)

267 
	#sc¡_£n£_»£rv©iÚ_»Ëa£d
 
UNIT_ATTENTION
, 0x2A, 0x04

	)

268 
	#sc¡_£n£_»gi¡¿tiÚs_´“m±ed
 
UNIT_ATTENTION
, 0x2A, 0x05

	)

269 
	#sc¡_£n£_asym_acûss_¡©e_chªged
 
UNIT_ATTENTION
, 0x2A, 0x06

	)

270 
	#sc¡_£n£_»pÜ‹d_luns_d©a_chªged
 
UNIT_ATTENTION
, 0x3F, 0xE

	)

271 
	#sc¡_£n£_šqu”y_d©a_chªged
 
UNIT_ATTENTION
, 0x3F, 0x3

	)

276 
	#INIT_ELEMENT_STATUS
 0x07

	)

277 
	#INIT_ELEMENT_STATUS_RANGE
 0x37

	)

278 
	#PREVENT_ALLOW_MEDIUM
 0x1E

	)

279 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 38)

280 
	#READ_ATTRIBUTE
 0x8C

	)

282 
	#REQUEST_VOLUME_ADDRESS
 0xB5

	)

283 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 38)

284 
	#WRITE_ATTRIBUTE
 0x8D

	)

286 
	#WRITE_VERIFY_16
 0x8E

	)

287 
	#VERIFY_6
 0x13

	)

288 #iâdeà
VERIFY_12


289 
	#VERIFY_12
 0xAF

	)

291 #iâdeà
GENERATING_UPSTREAM_PATCH


298 #iâdeà
READ_16


299 
	#READ_16
 0x88

	)

301 #iâdeà
WRITE_16


302 
	#WRITE_16
 0x8a

	)

304 #iâdeà
VERIFY_16


305 
	#VERIFY_16
 0x8f

	)

307 #iâdeà
SERVICE_ACTION_IN


308 
	#SERVICE_ACTION_IN
 0x9e

	)

310 #iâdeà
SAI_READ_CAPACITY_16


312 
	#SAI_READ_CAPACITY_16
 0x10

	)

315 #iâdeà
GENERATING_UPSTREAM_PATCH


316 #iâdeà
REPORT_LUNS


317 
	#REPORT_LUNS
 0xa0

	)

321 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 33)

326 
	#UNMAP
 0x42

	)

329 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 28)

334 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

342 
	#SAM_STAT_GOOD
 0x00

	)

343 
	#SAM_STAT_CHECK_CONDITION
 0x02

	)

344 
	#SAM_STAT_CONDITION_MET
 0x04

	)

345 
	#SAM_STAT_BUSY
 0x08

	)

346 
	#SAM_STAT_INTERMEDIATE
 0x10

	)

347 
	#SAM_STAT_INTERMEDIATE_CONDITION_MET
 0x14

	)

348 
	#SAM_STAT_RESERVATION_CONFLICT
 0x18

	)

349 
	#SAM_STAT_COMMAND_TERMINATED
 0x22

	)

350 
	#SAM_STAT_TASK_SET_FULL
 0x28

	)

351 
	#SAM_STAT_ACA_ACTIVE
 0x30

	)

352 
	#SAM_STAT_TASK_ABORTED
 0x40

	)

357 
	#CONTROL_BYTE_LINK_BIT
 0x01

	)

358 
	#CONTROL_BYTE_NACA_BIT
 0x04

	)

363 
	#SCST_INQ_EVPD
 0x01

	)

368 
	#SCST_INQ_BYTE3
 3

	)

370 
	#SCST_INQ_NORMACA_BIT
 0x20

	)

376 
	mSCST_INQ_TPGS_MODE_IMPLICIT
 = 0x10,

377 
	mSCST_INQ_TPGS_MODE_EXPLICIT
 = 0x20,

383 
	#SCST_RES_3RDPTY
 0x10

	)

384 
	#SCST_RES_LONGID
 0x02

	)

389 
	#SCST_CONTR_MODE_ONE_TASK_SET
 0

	)

390 
	#SCST_CONTR_MODE_SEP_TASK_SETS
 1

	)

395 
	#SCST_CONTR_MODE_QUEUE_ALG_RESTRICTED_REORDER
 0

	)

396 
	#SCST_CONTR_MODE_QUEUE_ALG_UNRESTRICTED_REORDER
 1

	)

401 
	#SCST_CONTR_MODE_FIXED_SENSE
 0

	)

402 
	#SCST_CONTR_MODE_DESCR_SENSE
 1

	)

408 
	#SCSI_TRANSPORTID_PROTOCOLID_FCP2
 0

	)

409 
	#SCSI_TRANSPORTID_PROTOCOLID_SPI5
 1

	)

410 
	#SCSI_TRANSPORTID_PROTOCOLID_SRP
 4

	)

411 
	#SCSI_TRANSPORTID_PROTOCOLID_ISCSI
 5

	)

412 
	#SCSI_TRANSPORTID_PROTOCOLID_SAS
 6

	)

419 
	esc¡_tg_¡©e
 {

420 
	mSCST_TG_STATE_OPTIMIZED
 = 0x0,

421 
	mSCST_TG_STATE_NONOPTIMIZED
 = 0x1,

422 
	mSCST_TG_STATE_STANDBY
 = 0x2,

423 
	mSCST_TG_STATE_UNAVAILABLE
 = 0x3,

424 
	mSCST_TG_STATE_LBA_DEPENDENT
 = 0x4,

425 
	mSCST_TG_STATE_OFFLINE
 = 0xe,

426 
	mSCST_TG_STATE_TRANSITIONING
 = 0xf,

435 
	mSCST_TG_PREFERRED
 = 0x80,

443 
	esc¡_tg_sup
 {

444 
	mSCST_TG_SUP_OPTIMIZED
 = 0x01,

445 
	mSCST_TG_SUP_NONOPTIMIZED
 = 0x02,

446 
	mSCST_TG_SUP_STANDBY
 = 0x04,

447 
	mSCST_TG_SUP_UNAVAILABLE
 = 0x08,

448 
	mSCST_TG_SUP_LBA_DEPENDENT
 = 0x10,

449 
	mSCST_TG_SUP_OFFLINE
 = 0x40,

450 
	mSCST_TG_SUP_TRANSITION
 = 0x80,

456 
	#SCST_SENSE_ASC_UA_RESET
 0x29

	)

457 
	#BYTCHK
 0x02

	)

458 
	#POSITION_LEN_SHORT
 20

	)

459 
	#POSITION_LEN_LONG
 32

	)

464 
	#SCST_DEFAULT_TIMEOUT
 (60 * 
HZ
)

	)

466 
	#SCST_GENERIC_CHANGER_TIMEOUT
 (3 * 
HZ
)

	)

467 
	#SCST_GENERIC_CHANGER_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

469 
	#SCST_GENERIC_PROCESSOR_TIMEOUT
 (3 * 
HZ
)

	)

470 
	#SCST_GENERIC_PROCESSOR_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

472 
	#SCST_GENERIC_TAPE_SMALL_TIMEOUT
 (3 * 
HZ
)

	)

473 
	#SCST_GENERIC_TAPE_REG_TIMEOUT
 (900 * 
HZ
)

	)

474 
	#SCST_GENERIC_TAPE_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

476 
	#SCST_GENERIC_MODISK_SMALL_TIMEOUT
 (3 * 
HZ
)

	)

477 
	#SCST_GENERIC_MODISK_REG_TIMEOUT
 (900 * 
HZ
)

	)

478 
	#SCST_GENERIC_MODISK_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

480 
	#SCST_GENERIC_DISK_SMALL_TIMEOUT
 (3 * 
HZ
)

	)

481 
	#SCST_GENERIC_DISK_REG_TIMEOUT
 (60 * 
HZ
)

	)

482 
	#SCST_GENERIC_DISK_LONG_TIMEOUT
 (3600 * 
HZ
)

	)

484 
	#SCST_GENERIC_RAID_TIMEOUT
 (3 * 
HZ
)

	)

485 
	#SCST_GENERIC_RAID_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

487 
	#SCST_GENERIC_CDROM_SMALL_TIMEOUT
 (3 * 
HZ
)

	)

488 
	#SCST_GENERIC_CDROM_REG_TIMEOUT
 (900 * 
HZ
)

	)

489 
	#SCST_GENERIC_CDROM_LONG_TIMEOUT
 (14000 * 
HZ
)

	)

491 
	#SCST_MAX_OTHER_TIMEOUT
 (14000 * 
HZ
)

	)

497 
	#SCST_IO_GROUPING_AUTO_STR
 "auto"

	)

498 
	#SCST_IO_GROUPING_THIS_GROUP_ONLY_STR
 "this_group_Úly"

	)

499 
	#SCST_IO_GROUPING_NEVER_STR
 "Ãv”"

	)

505 
	#SCST_THREADS_POOL_PER_INITIATOR_STR
 "³r_š™ŸtÜ"

	)

506 
	#SCST_THREADS_POOL_SHARED_STR
 "sh¬ed"

	)

511 
	#SCST_SYSFS_BLOCK_SIZE
 
PAGE_SIZE


	)

513 
	#SCST_PR_DIR
 "/v¬/lib/sc¡/´"

	)

515 
	#TID_COMMON_SIZE
 24

	)

517 
	#SCST_SYSFS_KEY_MARK
 "[key]"

	)

519 
	#SCST_MIN_REL_TGT_ID
 1

	)

520 
	#SCST_MAX_REL_TGT_ID
 65535

	)

	@/root/Desktop/scst-2.2.0/include/scst_debug.h

22 #iâdeà
__SCST_DEBUG_H


23 
	#__SCST_DEBUG_H


	)

25 #ià
LINUX_VERSION_CODE
 <ð
KERNEL_VERSION
(2, 6, 32)

26 
	~<lšux/autocÚf.h
>

28 
	~<g’”©ed/autocÚf.h
>

31 #ià
LINUX_VERSION_CODE
 > 
KERNEL_VERSION
(2, 6, 19)

32 
	~<lšux/bug.h
>

35 #ià!
defšed
(
INSIDE_KERNEL_TREE
)

36 #ifdeà
CONFIG_SCST_DEBUG


38 
	#sBUG
() do { \

39 
	`´štk
(
KERN_CRIT
 "BUG‡t %s:%d\n", \

40 
__FILE__
, 
__LINE__
); \

41 
	`loÿl_œq_’abË
(); \

42 
	`š_soáœq
()) \

43 
	`loÿl_bh_’abË
(); \

44 
	`BUG
(); \

45 } 0)

	)

47 
	#sBUG_ON
(
p
) do { \

48 ià(
	`uÆik–y
(
p
)) { \

49 
	`´štk
(
KERN_CRIT
 "BUG‡t %s:%d (%s)\n", \

50 
__FILE__
, 
__LINE__
, #p); \

51 
	`loÿl_œq_’abË
(); \

52 
	`š_soáœq
()) \

53 
	`loÿl_bh_’abË
(); \

54 
	`BUG
(); \

56 } 0)

	)

60 
	#sBUG
(è
	`BUG
()

	)

61 
	#sBUG_ON
(
p
è
	`BUG_ON
Õ)

	)

66 #ifdeà
CONFIG_SCST_EXTRACHECKS


67 
	#EXTRACHECKS_BUG_ON
(
a
è
	`sBUG_ON
×)

	)

68 
	#EXTRACHECKS_WARN_ON
(
a
è
	`WARN_ON
×)

	)

69 
	#EXTRACHECKS_WARN_ON_ONCE
(
a
è
	`WARN_ON_ONCE
×)

	)

71 
	#EXTRACHECKS_BUG_ON
(
a
èdØ{ } 0)

	)

72 
	#EXTRACHECKS_WARN_ON
(
a
èdØ{ } 0)

	)

73 
	#EXTRACHECKS_WARN_ON_ONCE
(
a
èdØ{ } 0)

	)

76 
	#TRACE_NULL
 0x00000000

	)

77 
	#TRACE_DEBUG
 0x00000001

	)

78 
	#TRACE_FUNCTION
 0x00000002

	)

79 
	#TRACE_LINE
 0x00000004

	)

80 
	#TRACE_PID
 0x00000008

	)

81 #iâdeà
GENERATING_UPSTREAM_PATCH


82 
	#TRACE_ENTRYEXIT
 0x00000010

	)

84 
	#TRACE_BUFF
 0x00000020

	)

85 
	#TRACE_MEMORY
 0x00000040

	)

86 
	#TRACE_SG_OP
 0x00000080

	)

87 
	#TRACE_OUT_OF_MEM
 0x00000100

	)

88 
	#TRACE_MINOR
 0x00000200

	)

89 
	#TRACE_MGMT
 0x00000400

	)

90 
	#TRACE_MGMT_DEBUG
 0x00000800

	)

91 
	#TRACE_SCSI
 0x00001000

	)

92 
	#TRACE_SPECIAL
 0x00002000

	)

93 
	#TRACE_FLOW_CONTROL
 0x00004000

	)

94 
	#TRACE_PRES
 0x00008000

	)

95 
	#TRACE_ALL
 0xffffffff

	)

98 
	#TRACE_MINOR_AND_MGMT_DBG
 (
TRACE_MINOR
|
TRACE_MGMT_DEBUG
)

	)

100 #iâdeà
KERN_CONT


101 
	#KERN_CONT
 ""

	)

108 
	#PRINT
(
log_æag
, 
fÜm©
, 
¬gs
...) \

109 
	`´štk
(
log_æag
 
fÜm©
 "\n", ## 
¬gs
)

	)

110 
	#PRINTN
(
log_æag
, 
fÜm©
, 
¬gs
...) \

111 
	`´štk
(
log_æag
 
fÜm©
, ## 
¬gs
)

	)

113 #ifdeà
LOG_PREFIX


114 
	#__LOG_PREFIX
 
LOG_PREFIX


	)

116 
	#__LOG_PREFIX
 
NULL


	)

119 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

121 #iâdeà
CONFIG_SCST_DEBUG


122 
	#___uÆik–y
(
a
è×)

	)

124 
	#___uÆik–y
(
a
è
	`uÆik–y
×)

	)

132 
debug_´št_´efix
(
Œaû_æag
,

133 cÚ¡ *
´efix
, cÚ¡ *
func
, 
lše
);

134 
debug_´št_bufãr
(cÚ¡ *
d©a
, 
Ën
);

135 cÚ¡ *
debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
);

137 
	#TRACING_MINOR
(è(
Œaû_æag
 & 
TRACE_MINOR
)

	)

139 
	#TRACE
(
Œaû
, 
fÜm©
, 
¬gs
...) \

141 ià(
	`___uÆik–y
(
Œaû_æag
 & (
Œaû
))) { \

142 
	`debug_´št_´efix
(
Œaû_æag
, 
__LOG_PREFIX
, \

143 
__func__
, 
__LINE__
); \

144 
	`PRINT
(
KERN_CONT
, 
fÜm©
, 
¬gs
); \

146 } 0)

	)

148 #ifdeà
CONFIG_SCST_DEBUG


150 
	#PRINT_BUFFER
(
mes§ge
, 
buff
, 
Ën
) \

152 
	`PRINT
(
KERN_INFO
, "%s:%s:", 
__func__
, 
mes§ge
); \

153 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

154 } 0)

	)

158 
	#PRINT_BUFFER
(
mes§ge
, 
buff
, 
Ën
) \

160 
	`PRINT
(
KERN_INFO
, "%s:", 
mes§ge
); \

161 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

162 } 0)

	)

166 
	#PRINT_BUFF_FLAG
(
æag
, 
mes§ge
, 
buff
, 
Ën
) \

168 ià(
	`___uÆik–y
(
Œaû_æag
 & (
æag
))) { \

169 
	`debug_´št_´efix
(
Œaû_æag
, 
NULL
, 
__func__
, 
__LINE__
);\

170 
	`PRINT
(
KERN_CONT
, "%s:", 
mes§ge
); \

171 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

173 } 0)

	)

177 
	#TRACING_MINOR
(è(
çl£
)

	)

179 
	#TRACE
(
Œaû
, 
¬gs
...èdØ{} 0)

	)

180 
	#PRINT_BUFFER
(
mes§ge
, 
buff
, 
Ën
èdØ{} 0)

	)

181 
	#PRINT_BUFF_FLAG
(
æag
, 
mes§ge
, 
buff
, 
Ën
èdØ{} 0)

	)

185 #ifdeà
CONFIG_SCST_DEBUG


187 
	#TRACE_DBG_FLAG
(
Œaû
, 
fÜm©
, 
¬gs
...) \

189 ià(
Œaû_æag
 & (
Œaû
)) { \

190 
	`debug_´št_´efix
(
Œaû_æag
, 
NULL
, 
__func__
, 
__LINE__
);\

191 
	`PRINT
(
KERN_CONT
, 
fÜm©
, 
¬gs
); \

193 } 0)

	)

195 
	#TRACE_MEM
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_MEMORY
,‡rgs)

	)

196 
	#TRACE_SG
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_SG_OP
,‡rgs)

	)

197 
	#TRACE_DBG
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_DEBUG
,‡rgs)

	)

198 
	#TRACE_DBG_SPECIAL
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_DEBUG
|
TRACE_SPECIAL
,‡rgs)

	)

199 
	#TRACE_MGMT_DBG
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_MGMT_DEBUG
,‡rgs)

	)

200 
	#TRACE_MGMT_DBG_SPECIAL
(
¬gs
...) \

201 
	`TRACE_DBG_FLAG
(
TRACE_MGMT_DEBUG
|
TRACE_SPECIAL
, 
¬gs
)

	)

202 
	#TRACE_PR
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_PRES
,‡rgs)

	)

204 
	#TRACE_BUFFER
(
mes§ge
, 
buff
, 
Ën
) \

206 ià(
Œaû_æag
 & 
TRACE_BUFF
) { \

207 
	`debug_´št_´efix
(
Œaû_æag
, 
NULL
, 
__func__
, 
__LINE__
);\

208 
	`PRINT
(
KERN_CONT
, "%s:", 
mes§ge
); \

209 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

211 } 0)

	)

213 
	#TRACE_BUFF_FLAG
(
æag
, 
mes§ge
, 
buff
, 
Ën
) \

215 ià(
Œaû_æag
 & (
æag
)) { \

216 
	`debug_´št_´efix
(
Œaû_æag
, 
NULL
, 
__func__
, 
__LINE__
);\

217 
	`PRINT
(
KERN_CONT
, "%s:", 
mes§ge
); \

218 
	`debug_´št_bufãr
(
buff
, 
Ën
); \

220 } 0)

	)

222 
	#PRINT_LOG_FLAG
(
log_æag
, 
fÜm©
, 
¬gs
...) \

224 
	`debug_´št_´efix
(
Œaû_æag
, 
__LOG_PREFIX
, 
__func__
, 
__LINE__
);\

225 
	`PRINT
(
KERN_CONT
, 
fÜm©
, 
¬gs
); \

226 } 0)

	)

228 
	#PRINT_WARNING
(
fÜm©
, 
¬gs
...) \

230 
	`debug_´št_´efix
(
Œaû_æag
, 
__LOG_PREFIX
, 
__func__
, 
__LINE__
);\

231 
	`PRINT
(
KERN_CONT
, "***WARNING***: " 
fÜm©
, 
¬gs
); \

232 } 0)

	)

234 
	#PRINT_ERROR
(
fÜm©
, 
¬gs
...) \

236 
	`debug_´št_´efix
(
Œaû_æag
, 
__LOG_PREFIX
, 
__func__
, 
__LINE__
);\

237 
	`PRINT
(
KERN_CONT
, "***ERROR***: " 
fÜm©
, 
¬gs
); \

238 } 0)

	)

240 
	#PRINT_CRIT_ERROR
(
fÜm©
, 
¬gs
...) \

242 
	`debug_´št_´efix
(
Œaû_æag
, 
__LOG_PREFIX
, 
__func__
, 
__LINE__
);\

243 
	`PRINT
(
KERN_CONT
, "***CRITICAL ERROR***: " 
fÜm©
, 
¬gs
); \

244 } 0)

	)

246 
	#PRINT_INFO
(
fÜm©
, 
¬gs
...) \

248 
	`debug_´št_´efix
(
Œaû_æag
, 
__LOG_PREFIX
, 
__func__
, 
__LINE__
);\

249 
	`PRINT
(
KERN_CONT
, 
fÜm©
, 
¬gs
); \

250 } 0)

	)

252 #iâdeà
GENERATING_UPSTREAM_PATCH


253 
	#TRACE_ENTRY
() \

255 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

256 ià(
Œaû_æag
 & 
TRACE_PID
) { \

257 
	`PRINT
(
KERN_INFO
, "[%d]: ENTRY %s", 
cu¼’t
->
pid
, \

258 
__func__
); \

261 
	`PRINT
(
KERN_INFO
, "ENTRY %s", 
__func__
); \

264 } 0)

	)

266 
	#TRACE_EXIT
() \

268 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

269 ià(
Œaû_æag
 & 
TRACE_PID
) { \

270 
	`PRINT
(
KERN_INFO
, "[%d]: EXIT %s", 
cu¼’t
->
pid
, \

271 
__func__
); \

274 
	`PRINT
(
KERN_INFO
, "EXIT %s", 
__func__
); \

277 } 0)

	)

279 
	#TRACE_EXIT_RES
(
»s
) \

281 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

282 ià(
Œaû_æag
 & 
TRACE_PID
) { \

283 
	`PRINT
(
KERN_INFO
, "[%d]: EXIT %s: %ld", 
cu¼’t
->
pid
, \

284 
__func__
, ()(
»s
)); \

287 
	`PRINT
(
KERN_INFO
, "EXIT %s: %ld", \

288 
__func__
, ()(
»s
)); \

291 } 0)

	)

293 
	#TRACE_EXIT_HRES
(
»s
) \

295 ià(
Œaû_æag
 & 
TRACE_ENTRYEXIT
) { \

296 ià(
Œaû_æag
 & 
TRACE_PID
) { \

297 
	`PRINT
(
KERN_INFO
, "[%d]: EXIT %s: 0x%lx", 
cu¼’t
->
pid
, \

298 
__func__
, ()(
»s
)); \

301 
	`PRINT
(
KERN_INFO
, "EXIT %s: %lx", \

302 
__func__
, ()(
»s
)); \

305 } 0)

	)

310 
	#TRACE_MEM
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

311 
	#TRACE_SG
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

312 
	#TRACE_DBG
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

313 
	#TRACE_DBG_FLAG
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

314 
	#TRACE_DBG_SPECIAL
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

315 
	#TRACE_MGMT_DBG
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

316 
	#TRACE_MGMT_DBG_SPECIAL
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

317 
	#TRACE_PR
(
fÜm©
, 
¬gs
...èdØ{} 0)

	)

318 
	#TRACE_BUFFER
(
mes§ge
, 
buff
, 
Ën
èdØ{} 0)

	)

319 
	#TRACE_BUFF_FLAG
(
æag
, 
mes§ge
, 
buff
, 
Ën
èdØ{} 0)

	)

321 #iâdeà
GENERATING_UPSTREAM_PATCH


322 
	#TRACE_ENTRY
(èdØ{} 0)

	)

323 
	#TRACE_EXIT
(èdØ{} 0)

	)

324 
	#TRACE_EXIT_RES
(
»s
èdØ{} 0)

	)

325 
	#TRACE_EXIT_HRES
(
»s
èdØ{} 0)

	)

328 #ifdeà
LOG_PREFIX


330 
	#PRINT_INFO
(
fÜm©
, 
¬gs
...) \

332 
	`PRINT
(
KERN_INFO
, "%s: " 
fÜm©
, 
LOG_PREFIX
, 
¬gs
); \

333 } 0)

	)

335 
	#PRINT_WARNING
(
fÜm©
, 
¬gs
...) \

337 
	`PRINT
(
KERN_INFO
, "%s: ***WARNING***: " \

338 
fÜm©
, 
LOG_PREFIX
, 
¬gs
); \

339 } 0)

	)

341 
	#PRINT_ERROR
(
fÜm©
, 
¬gs
...) \

343 
	`PRINT
(
KERN_INFO
, "%s: ***ERROR***: " \

344 
fÜm©
, 
LOG_PREFIX
, 
¬gs
); \

345 } 0)

	)

347 
	#PRINT_CRIT_ERROR
(
fÜm©
, 
¬gs
...) \

349 
	`PRINT
(
KERN_INFO
, "%s: ***CRITICAL ERROR***: " \

350 
fÜm©
, 
LOG_PREFIX
, 
¬gs
); \

351 } 0)

	)

355 
	#PRINT_INFO
(
fÜm©
, 
¬gs
...) \

357 
	`PRINT
(
KERN_INFO
, 
fÜm©
, 
¬gs
); \

358 } 0)

	)

360 
	#PRINT_WARNING
(
fÜm©
, 
¬gs
...) \

362 
	`PRINT
(
KERN_INFO
, "***WARNING***: " \

363 
fÜm©
, 
¬gs
); \

364 } 0)

	)

366 
	#PRINT_ERROR
(
fÜm©
, 
¬gs
...) \

368 
	`PRINT
(
KERN_ERR
, "***ERROR***: " \

369 
fÜm©
, 
¬gs
); \

370 } 0)

	)

372 
	#PRINT_CRIT_ERROR
(
fÜm©
, 
¬gs
...) \

374 
	`PRINT
(
KERN_CRIT
, "***CRITICAL ERROR***: " \

375 
fÜm©
, 
¬gs
); \

376 } 0)

	)

382 #ià
defšed
(
CONFIG_SCST_DEBUG
è&& defšed(
CONFIG_DEBUG_SLAB
)

383 
	#SCST_SLAB_FLAGS
 (
SLAB_RED_ZONE
 | 
SLAB_POISON
)

	)

385 
	#SCST_SLAB_FLAGS
 0L

	)

	@/root/Desktop/scst-2.2.0/include/scst_sgv.h

20 #iâdeà
__SCST_SGV_H


21 
	#__SCST_SGV_H


	)

26 
	#SGV_POOL_ALLOC_NO_CACHED
 1

	)

29 
	#SGV_POOL_NO_ALLOC_ON_CACHE_MISS
 2

	)

32 
	#SGV_POOL_RETURN_OBJ_ON_ALLOC_FAIL
 4

	)

38 
	#SGV_POOL_ALLOC_GET_NEW
 8

	)

40 
	gsgv_poÞ_obj
;

41 
	gsgv_poÞ
;

46 
	ssc¡_mem_lim
 {

48 
©omic_t
 
	m®loûd_·ges
;

54 
	mmax_®lowed_·ges
;

58 
	esgv_þu¡”šg_ty³s
 {

60 
	msgv_no_þu¡”šg
 = 0,

66 
	msgv_ž_þu¡”šg
,

72 
	msgv_fuÎ_þu¡”šg
,

75 
sgv_poÞ
 *
sgv_poÞ_ü—‹
(cÚ¡ *
Çme
,

76 
sgv_þu¡”šg_ty³s
 
þu¡”ed
, 
sšgË_®loc_·ges
,

77 
boÞ
 
sh¬ed
, 
purge_š‹rv®
);

78 
sgv_poÞ_d–
(
sgv_poÞ
 *
poÞ
);

80 
sgv_poÞ_g‘
(
sgv_poÞ
 *
poÞ
);

81 
sgv_poÞ_put
(
sgv_poÞ
 *
poÞ
);

83 
sgv_poÞ_æush
(
sgv_poÞ
 *
poÞ
);

85 
sgv_poÞ_£t_®loÿtÜ
(
sgv_poÞ
 *
poÞ
,

86 
·ge
 *(*
®loc_·ges_â
)(
sÿ‰”li¡
 *, 
gå_t
, *),

87 (*
ä“_·ges_â
)(
sÿ‰”li¡
 *, , *));

89 
sÿ‰”li¡
 *
	`sgv_poÞ_®loc
(
sgv_poÞ
 *
poÞ
, 
size
,

90 
gå_t
 
gå_mask
, 
æags
, *
couÁ
,

91 
sgv_poÞ_obj
 **
sgv
, 
sc¡_mem_lim
 *
mem_lim
, *
´iv
);

92 
	`sgv_poÞ_ä“
(
sgv_poÞ_obj
 *
sgv
, 
sc¡_mem_lim
 *
mem_lim
);

94 *
	`sgv_g‘_´iv
(
sgv_poÞ_obj
 *
sgv
);

96 
	`sc¡_š™_mem_lim
(
sc¡_mem_lim
 *
mem_lim
);

	@/root/Desktop/scst-2.2.0/include/scst_user.h

23 #iâdeà
__SCST_USER_H


24 
	#__SCST_USER_H


	)

26 #ifdeà
INSIDE_KERNEL_TREE


27 
	~<sc¡/sc¡_cÚ¡.h
>

29 
	~<sc¡_cÚ¡.h
>

32 
	#DEV_USER_NAME
 "sc¡_u£r"

	)

33 
	#DEV_USER_PATH
 "/dev/"

	)

34 
	#DEV_USER_VERSION_NAME
 
SCST_VERSION_NAME


	)

35 
	#DEV_USER_VERSION
 \

36 
DEV_USER_VERSION_NAME
 "$RevisiÚ: 4021 $" 
SCST_CONST_VERSION


	)

38 
	#SCST_USER_PARSE_STANDARD
 0

	)

39 
	#SCST_USER_PARSE_CALL
 1

	)

40 
	#SCST_USER_PARSE_EXCEPTION
 2

	)

41 
	#SCST_USER_MAX_PARSE_OPT
 
SCST_USER_PARSE_EXCEPTION


	)

43 
	#SCST_USER_ON_FREE_CMD_CALL
 0

	)

44 
	#SCST_USER_ON_FREE_CMD_IGNORE
 1

	)

45 
	#SCST_USER_MAX_ON_FREE_CMD_OPT
 
SCST_USER_ON_FREE_CMD_IGNORE


	)

47 
	#SCST_USER_MEM_NO_REUSE
 0

	)

48 
	#SCST_USER_MEM_REUSE_READ
 1

	)

49 
	#SCST_USER_MEM_REUSE_WRITE
 2

	)

50 
	#SCST_USER_MEM_REUSE_ALL
 3

	)

51 
	#SCST_USER_MAX_MEM_REUSE_OPT
 
SCST_USER_MEM_REUSE_ALL


	)

53 
	#SCST_USER_PARTIAL_TRANSFERS_NOT_SUPPORTED
 0

	)

54 
	#SCST_USER_PARTIAL_TRANSFERS_SUPPORTED_ORDERED
 1

	)

55 
	#SCST_USER_PARTIAL_TRANSFERS_SUPPORTED
 2

	)

56 
	#SCST_USER_MAX_PARTIAL_TRANSFERS_OPT
 \

57 
SCST_USER_PARTIAL_TRANSFERS_SUPPORTED


	)

59 #iâdeà
®igÃd_u64


60 
	#®igÃd_u64
 
ušt64_t
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

66 
	#UCMD_STATE_NEW
 0

	)

67 
	#UCMD_STATE_PARSING
 1

	)

68 
	#UCMD_STATE_BUF_ALLOCING
 2

	)

69 
	#UCMD_STATE_EXECING
 3

	)

70 
	#UCMD_STATE_ON_FREEING
 4

	)

71 
	#UCMD_STATE_ON_FREE_SKIPPED
 5

	)

72 
	#UCMD_STATE_ON_CACHE_FREEING
 6

	)

73 
	#UCMD_STATE_TM_EXECING
 7

	)

75 
	#UCMD_STATE_ATTACH_SESS
 0x20

	)

76 
	#UCMD_STATE_DETACH_SESS
 0x21

	)

78 
	ssc¡_u£r_Ýt
 {

79 
ušt8_t
 
	m·r£_ty³
;

80 
ušt8_t
 
	mÚ_ä“_cmd_ty³
;

81 
ušt8_t
 
	mmemÜy_»u£_ty³
;

82 
ušt8_t
 
	m·¹Ÿl_Œªsãrs_ty³
;

83 
št32_t
 
	m·¹Ÿl_Ën
;

86 
ušt8_t
 
	mt¡
;

87 
ušt8_t
 
	mqueue_®g
;

88 
ušt8_t
 
	ms
;

89 
ušt8_t
 
	mswp
;

90 
ušt8_t
 
	md_£n£
;

92 
ušt8_t
 
	mhas_own_Üd”_mgmt
;

95 
	ssc¡_u£r_dev_desc
 {

96 
®igÃd_u64
 
	mv”siÚ_¡r
;

97 
®igÃd_u64
 
	mliûn£_¡r
;

98 
ušt8_t
 
	mty³
;

99 
ušt8_t
 
	msgv_sh¬ed
;

100 
ušt8_t
 
	msgv_di§bË_þu¡”ed_poÞ
;

101 
št32_t
 
	msgv_sšgË_®loc_·ges
;

102 
št32_t
 
	msgv_purge_š‹rv®
;

103 
sc¡_u£r_Ýt
 
	mÝt
;

104 
ušt32_t
 
	mblock_size
;

105 
ušt8_t
 
	m’abË_´_cmds_nÙifiÿtiÚs
;

106 
	mÇme
[
SCST_MAX_NAME
];

107 
	msgv_Çme
[
SCST_MAX_NAME
];

110 
	ssc¡_u£r_£ss
 {

111 
®igÃd_u64
 
	m£ss_h
;

112 
®igÃd_u64
 
	mlun
;

113 
ušt16_t
 
	mth»ads_num
;

114 
ušt8_t
 
	mrd_Úly
;

115 
ušt16_t
 
	mscsi_Œª¥Üt_v”siÚ
;

116 
ušt16_t
 
	mphys_Œª¥Üt_v”siÚ
;

117 
	mš™ŸtÜ_Çme
[
SCST_MAX_EXTERNAL_NAME
];

118 
	mrg‘_Çme
[
SCST_MAX_EXTERNAL_NAME
];

121 
	ssc¡_u£r_scsi_cmd_·r£
 {

122 
®igÃd_u64
 
	m£ss_h
;

124 
ušt8_t
 
	mcdb
[
SCST_MAX_CDB_SIZE
];

125 
ušt16_t
 
	mcdb_Ën
;

127 
št32_t
 
	mtimeout
;

128 
št32_t
 
	mbufæ’
;

129 
št32_t
 
	mout_bufæ’
;

131 
ušt32_t
 
	mÝ_æags
;

133 
ušt8_t
 
	mqueue_ty³
;

134 
ušt8_t
 
	md©a_dœeùiÚ
;

136 
ušt8_t
 
	mex³ùed_v®ues_£t
;

137 
ušt8_t
 
	mex³ùed_d©a_dœeùiÚ
;

138 
št32_t
 
	mex³ùed_Œªsãr_Ën
;

139 
št32_t
 
	mex³ùed_out_Œªsãr_Ën
;

141 
ušt32_t
 
	m¢
;

144 
	ssc¡_u£r_scsi_cmd_®loc_mem
 {

145 
®igÃd_u64
 
	m£ss_h
;

147 
ušt8_t
 
	mcdb
[
SCST_MAX_CDB_SIZE
];

148 
ušt16_t
 
	mcdb_Ën
;

150 
št32_t
 
	m®loc_Ën
;

152 
ušt8_t
 
	mqueue_ty³
;

153 
ušt8_t
 
	md©a_dœeùiÚ
;

155 
ušt32_t
 
	m¢
;

158 
	ssc¡_u£r_scsi_cmd_exec
 {

159 
®igÃd_u64
 
	m£ss_h
;

161 
ušt8_t
 
	mcdb
[
SCST_MAX_CDB_SIZE
];

162 
ušt16_t
 
	mcdb_Ën
;

164 
št32_t
 
	md©a_Ën
;

165 
št32_t
 
	mbufæ’
;

166 
št32_t
 
	m®loc_Ën
;

167 
®igÃd_u64
 
	mpbuf
;

168 
ušt8_t
 
	mqueue_ty³
;

169 
ušt8_t
 
	md©a_dœeùiÚ
;

170 
ušt8_t
 
	m·¹Ÿl
;

171 
št32_t
 
	mtimeout
;

173 
®igÃd_u64
 
	mp_out_buf
;

174 
št32_t
 
	mout_bufæ’
;

176 
ušt32_t
 
	m¢
;

178 
ušt32_t
 
	m·»Á_cmd_h
;

179 
št32_t
 
	m·»Á_cmd_d©a_Ën
;

180 
ušt32_t
 
	m·¹Ÿl_off£t
;

183 
	ssc¡_u£r_scsi_Ú_ä“_cmd
 {

184 
®igÃd_u64
 
	mpbuf
;

185 
št32_t
 
	m»¥_d©a_Ën
;

186 
ušt8_t
 
	mbufãr_ÿched
;

187 
ušt8_t
 
	mabÜ‹d
;

188 
ušt8_t
 
	m¡©us
;

189 
ušt8_t
 
	md–iv”y_¡©us
;

192 
	ssc¡_u£r_Ú_ÿched_mem_ä“
 {

193 
®igÃd_u64
 
	mpbuf
;

196 
	ssc¡_u£r_tm
 {

197 
®igÃd_u64
 
	m£ss_h
;

198 
ušt32_t
 
	mâ
;

199 
ušt32_t
 
	mcmd_h_to_abÜt
;

200 
ušt32_t
 
	mcmd_¢
;

201 
ušt8_t
 
	mcmd_¢_£t
;

204 
	ssc¡_u£r_g‘_cmd
 {

205 
ušt32_t
 
	mcmd_h
;

206 
ušt32_t
 
	msubcode
;

208 
®igÃd_u64
 
	m´•ly
;

209 
sc¡_u£r_£ss
 
	m£ss
;

210 
sc¡_u£r_scsi_cmd_·r£
 
	m·r£_cmd
;

211 
sc¡_u£r_scsi_cmd_®loc_mem
 
	m®loc_cmd
;

212 
sc¡_u£r_scsi_cmd_exec
 
	mexec_cmd
;

213 
sc¡_u£r_scsi_Ú_ä“_cmd
 
	mÚ_ä“_cmd
;

214 
sc¡_u£r_Ú_ÿched_mem_ä“
 
	mÚ_ÿched_mem_ä“
;

215 
sc¡_u£r_tm
 
	mtm_cmd
;

220 
	ssc¡_u£r_scsi_cmd_»¶y_·r£
 {

221 
ušt8_t
 
	m¡©us
;

224 
ušt8_t
 
	mqueue_ty³
;

225 
ušt8_t
 
	md©a_dœeùiÚ
;

226 
ušt16_t
 
	mcdb_Ën
;

227 
ušt32_t
 
	mÝ_æags
;

228 
št32_t
 
	md©a_Ën
;

229 
št32_t
 
	mbufæ’
;

230 
št32_t
 
	mout_bufæ’
;

233 
ušt8_t
 
	m£n£_Ën
;

234 
®igÃd_u64
 
	mp£n£_bufãr
;

240 
	ssc¡_u£r_scsi_cmd_»¶y_®loc_mem
 {

241 
®igÃd_u64
 
	mpbuf
;

245 
	ssc¡_u£r_scsi_cmd_»¶y_exec
 {

246 
št32_t
 
	m»¥_d©a_Ën
;

247 
®igÃd_u64
 
	mpbuf
;

249 
	#SCST_EXEC_REPLY_BACKGROUND
 0

	)

250 
	#SCST_EXEC_REPLY_COMPLETED
 1

	)

251 
ušt8_t
 
	m»¶y_ty³
;

253 
ušt8_t
 
	m¡©us
;

254 
ušt8_t
 
	m£n£_Ën
;

255 
®igÃd_u64
 
	mp£n£_bufãr
;

259 
	ssc¡_u£r_»¶y_cmd
 {

260 
ušt32_t
 
	mcmd_h
;

261 
ušt32_t
 
	msubcode
;

263 
št32_t
 
	m»suÉ
;

264 
sc¡_u£r_scsi_cmd_»¶y_·r£
 
	m·r£_»¶y
;

265 
sc¡_u£r_scsi_cmd_»¶y_®loc_mem
 
	m®loc_»¶y
;

266 
sc¡_u£r_scsi_cmd_»¶y_exec
 
	mexec_»¶y
;

271 
	ssc¡_u£r_g‘_ext_cdb
 {

272 
ušt32_t
 
	mcmd_h
;

273 
®igÃd_u64
 
	mext_cdb_bufãr
;

277 
	ssc¡_u£r_´—Îoc_bufãr_š
 {

278 
®igÃd_u64
 
	mpbuf
;

279 
ušt32_t
 
	mbufæ’
;

280 
ušt8_t
 
	mfÜ_þu¡_poÞ
;

284 
	ssc¡_u£r_´—Îoc_bufãr_out
 {

285 
ušt32_t
 
	mcmd_h
;

289 
	usc¡_u£r_´—Îoc_bufãr
 {

290 
sc¡_u£r_´—Îoc_bufãr_š
 
	mš
;

291 
sc¡_u£r_´—Îoc_bufãr_out
 
	mout
;

294 
	#SCST_USER_REGISTER_DEVICE
 
	`_IOW
('u', 1, 
sc¡_u£r_dev_desc
)

	)

295 
	#SCST_USER_UNREGISTER_DEVICE
 
	`_IO
('u', 2)

	)

296 
	#SCST_USER_SET_OPTIONS
 
	`_IOW
('u', 3, 
sc¡_u£r_Ýt
)

	)

297 
	#SCST_USER_GET_OPTIONS
 
	`_IOR
('u', 4, 
sc¡_u£r_Ýt
)

	)

298 
	#SCST_USER_REPLY_AND_GET_CMD
 
	`_IOWR
('u', 5, 
sc¡_u£r_g‘_cmd
)

	)

299 
	#SCST_USER_REPLY_CMD
 
	`_IOW
('u', 6, 
sc¡_u£r_»¶y_cmd
)

	)

300 
	#SCST_USER_FLUSH_CACHE
 
	`_IO
('u', 7)

	)

301 
	#SCST_USER_DEVICE_CAPACITY_CHANGED
 
	`_IO
('u', 8)

	)

302 
	#SCST_USER_GET_EXTENDED_CDB
 
	`_IOWR
('u', 9, 
sc¡_u£r_g‘_ext_cdb
)

	)

303 
	#SCST_USER_PREALLOC_BUFFER
 
	`_IOWR
('u', 10, 
sc¡_u£r_´—Îoc_bufãr
)

	)

306 
	#SCST_USER_ATTACH_SESS
 \

307 
	`_IOR
('s', 
UCMD_STATE_ATTACH_SESS
, 
sc¡_u£r_£ss
)

	)

308 
	#SCST_USER_DETACH_SESS
 \

309 
	`_IOR
('s', 
UCMD_STATE_DETACH_SESS
, 
sc¡_u£r_£ss
)

	)

310 
	#SCST_USER_PARSE
 \

311 
	`_IOWR
('s', 
UCMD_STATE_PARSING
, 
sc¡_u£r_scsi_cmd_·r£
)

	)

312 
	#SCST_USER_ALLOC_MEM
 \

313 
	`_IOWR
('s', 
UCMD_STATE_BUF_ALLOCING
, 
sc¡_u£r_scsi_cmd_®loc_mem
)

	)

314 
	#SCST_USER_EXEC
 \

315 
	`_IOWR
('s', 
UCMD_STATE_EXECING
, 
sc¡_u£r_scsi_cmd_exec
)

	)

316 
	#SCST_USER_ON_FREE_CMD
 \

317 
	`_IOR
('s', 
UCMD_STATE_ON_FREEING
, 
sc¡_u£r_scsi_Ú_ä“_cmd
)

	)

318 
	#SCST_USER_ON_CACHED_MEM_FREE
 \

319 
	`_IOR
('s', 
UCMD_STATE_ON_CACHE_FREEING
, \

320 
sc¡_u£r_Ú_ÿched_mem_ä“
)

	)

321 
	#SCST_USER_TASK_MGMT
 \

322 
	`_IOWR
('s', 
UCMD_STATE_TM_EXECING
, 
sc¡_u£r_tm
)

	)

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_cdrom.c

22 
	~<lšux/cdrom.h
>

23 
	~<scsi/scsi_ho¡.h
>

24 
	~<lšux/¦ab.h
>

26 
	#LOG_PREFIX
 "dev_cdrom"

	)

28 #ifdeà
INSIDE_KERNEL_TREE


29 
	~<sc¡/sc¡.h
>

31 
	~"sc¡.h
"

33 
	~"sc¡_dev_hªdËr.h
"

35 
	#CDROM_NAME
 "dev_cdrom"

	)

37 
	#CDROM_DEF_BLOCK_SHIFT
 11

	)

39 
	scdrom_·¿ms
 {

40 
	mblock_shiá
;

43 
cdrom_©ch
(
sc¡_deviû
 *);

44 
cdrom_d‘ach
(
sc¡_deviû
 *);

45 
cdrom_·r£
(
sc¡_cmd
 *);

46 
cdrom_dÚe
(
sc¡_cmd
 *);

48 
sc¡_dev_ty³
 
	gcdrom_devty³
 = {

49 .
Çme
 = 
CDROM_NAME
,

50 .
	gty³
 = 
TYPE_ROM
,

51 .
	gth»ads_num
 = 1,

52 .
	g·r£_©omic
 = 1,

53 .
	gdev_dÚe_©omic
 = 1,

54 .
	g©ch
 = 
cdrom_©ch
,

55 .
	gd‘ach
 = 
cdrom_d‘ach
,

56 .
	g·r£
 = 
cdrom_·r£
,

57 .
	gdev_dÚe
 = 
cdrom_dÚe
,

58 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

59 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

60 .
	gŒaû_æags
 = &
Œaû_æag
,

64 
	$cdrom_©ch
(
sc¡_deviû
 *
dev
)

66 
»s
, 
rc
;

67 
ušt8_t
 
cmd
[10];

68 cÚ¡ 
bufãr_size
 = 512;

69 
ušt8_t
 *
bufãr
 = 
NULL
;

70 
»Œ›s
;

71 
£n£_bufãr
[
SCSI_SENSE_BUFFERSIZE
];

72 
dma_d©a_dœeùiÚ
 
d©a_dœ
;

73 
cdrom_·¿ms
 *
·¿ms
;

75 
	`TRACE_ENTRY
();

77 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

78 
dev
->
scsi_dev
->
ty³
 != dev->type) {

79 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

80 
»s
 = -
ENODEV
;

81 
out
;

84 
·¿ms
 = 
	`kz®loc
((*·¿ms), 
GFP_KERNEL
);

85 ià(
·¿ms
 =ð
NULL
) {

86 
	`PRINT_ERROR
("Unableo‡llocate struct cdrom_params (size %zd)",

87 (*
·¿ms
));

88 
»s
 = -
ENOMEM
;

89 
out
;

92 
bufãr
 = 
	`km®loc
(
bufãr_size
, 
GFP_KERNEL
);

93 ià(!
bufãr
) {

94 
	`PRINT_ERROR
("Buffer memory‡llocation (size %d) failure",

95 
bufãr_size
);

96 
»s
 = -
ENOMEM
;

97 
out_ä“_·¿ms
;

101 
	`mem£t
(
cmd
, 0, (cmd));

102 
cmd
[0] = 
READ_CAPACITY
;

103 
cmd
[1] = (
dev
->
scsi_dev
->
scsi_Ëv–
 <ð
SCSI_2
) ?

104 ((
dev
->
scsi_dev
->
lun
 << 5) & 0xe0) : 0;

105 
»Œ›s
 = 
SCST_DEV_UA_RETRIES
;

107 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

108 
	`mem£t
(
£n£_bufãr
, 0, (sense_buffer));

109 
d©a_dœ
 = 
SCST_DATA_READ
;

111 
	`TRACE_DBG
("%s", "Doing READ_CAPACITY");

112 
rc
 = 
	`scsi_execu‹
(
dev
->
scsi_dev
, 
cmd
, 
d©a_dœ
, 
bufãr
,

113 
bufãr_size
, 
£n£_bufãr
,

114 
SCST_GENERIC_CDROM_REG_TIMEOUT
, 3, 0

115 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2,6,29)

116 , 
NULL


120 
	`TRACE_DBG
("READ_CAPACITY dÚe: %x", 
rc
);

122 ià((
rc
 == 0) ||

123 !
	`sc¡_ª®yze_£n£
(
£n£_bufãr
,

124 (
£n£_bufãr
), 
SCST_SENSE_KEY_VALID
,

125 
UNIT_ATTENTION
, 0, 0))

128 ià(!--
»Œ›s
) {

129 
	`PRINT_ERROR
("UA‚ot cleared‡fter %d„etries",

130 
SCST_DEV_UA_RETRIES
);

131 
·¿ms
->
block_shiá
 = 
CDROM_DEF_BLOCK_SHIFT
;

132 
»s
 = -
ENODEV
;

133 
out_ä“_buf
;

137 ià(
rc
 == 0) {

138 
£ùÜ_size
 = ((
bufãr
[4] << 24) | (buffer[5] << 16) |

139 (
bufãr
[6] << 8) | (buffer[7] << 0));

140 ià(
£ùÜ_size
 == 0)

141 
·¿ms
->
block_shiá
 = 
CDROM_DEF_BLOCK_SHIFT
;

143 
·¿ms
->
block_shiá
 =

144 
	`sc¡_ÿlc_block_shiá
(
£ùÜ_size
);

145 
	`TRACE_DBG
("Sector size is %i scsi_level %d(SCSI_2 %d)",

146 
£ùÜ_size
, 
dev
->
scsi_dev
->
scsi_Ëv–
, 
SCSI_2
);

148 
·¿ms
->
block_shiá
 = 
CDROM_DEF_BLOCK_SHIFT
;

149 
	`TRACE
(
TRACE_MINOR
, "Read capacity failed: %x, using default "

150 "£ùÜ siz%d", 
rc
, 
·¿ms
->
block_shiá
);

151 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "R‘uºed s’£", 
£n£_bufãr
,

152 (
£n£_bufãr
));

155 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
);

156 ià(
»s
 != 0) {

157 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

158 "%s", 
dev
->
vœt_Çme
);

159 
out_ä“_buf
;

162 
out_ä“_buf
:

163 
	`kä“
(
bufãr
);

165 
out_ä“_·¿ms
:

166 ià(
»s
 == 0)

167 
dev
->
dh_´iv
 = 
·¿ms
;

169 
	`kä“
(
·¿ms
);

171 
out
:

172 
	`TRACE_EXIT
();

173  
»s
;

174 
	}
}

176 
	$cdrom_d‘ach
(
sc¡_deviû
 *
dev
)

178 
cdrom_·¿ms
 *
·¿ms
 =

179 (
cdrom_·¿ms
 *)
dev
->
dh_´iv
;

181 
	`TRACE_ENTRY
();

183 
	`kä“
(
·¿ms
);

184 
dev
->
dh_´iv
 = 
NULL
;

186 
	`TRACE_EXIT
();

188 
	}
}

190 
	$cdrom_g‘_block_shiá
(
sc¡_cmd
 *
cmd
)

192 
cdrom_·¿ms
 *
·¿ms
 = (cdrom_·¿m *)
cmd
->
dev
->
dh_´iv
;

197  
·¿ms
->
block_shiá
;

198 
	}
}

200 
	$cdrom_·r£
(
sc¡_cmd
 *
cmd
)

202 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

204 
	`sc¡_cdrom_g’”ic_·r£
(
cmd
, 
cdrom_g‘_block_shiá
);

206 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

208  
»s
;

209 
	}
}

211 
	$cdrom_£t_block_shiá
(
sc¡_cmd
 *
cmd
, 
block_shiá
)

213 
cdrom_·¿ms
 *
·¿ms
 = (cdrom_·¿m *)
cmd
->
dev
->
dh_´iv
;

218 ià(
block_shiá
 != 0)

219 
·¿ms
->
block_shiá
 = block_shift;

221 
·¿ms
->
block_shiá
 = 
CDROM_DEF_BLOCK_SHIFT
;

223 
	}
}

225 
	$cdrom_dÚe
(
sc¡_cmd
 *
cmd
)

227 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

229 
	`TRACE_ENTRY
();

231 
»s
 = 
	`sc¡_block_g’”ic_dev_dÚe
(
cmd
, 
cdrom_£t_block_shiá
);

233 
	`TRACE_EXIT_RES
(
»s
);

234  
»s
;

235 
	}
}

237 
__š™
 
	$cdrom_š™
()

239 
»s
 = 0;

241 
	`TRACE_ENTRY
();

243 
cdrom_devty³
.
moduË
 = 
THIS_MODULE
;

245 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
cdrom_devty³
);

246 ià(
»s
 < 0)

247 
out
;

249 #ifdeà
CONFIG_SCST_PROC


250 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
cdrom_devty³
);

251 ià(
»s
 != 0)

252 
out_”r
;

255 
out
:

256 
	`TRACE_EXIT
();

257  
»s
;

259 #ifdeà
CONFIG_SCST_PROC


260 
out_”r
:

261 
	`sc¡_uÄegi¡”_dev_driv”
(&
cdrom_devty³
);

262 
out
;

264 
	}
}

266 
__ex™
 
	$cdrom_ex™
()

268 
	`TRACE_ENTRY
();

269 #ifdeà
CONFIG_SCST_PROC


270 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
cdrom_devty³
);

272 
	`sc¡_uÄegi¡”_dev_driv”
(&
cdrom_devty³
);

273 
	`TRACE_EXIT
();

275 
	}
}

277 
moduË_š™
(
cdrom_š™
);

278 
moduË_ex™
(
cdrom_ex™
);

280 
MODULE_LICENSE
("GPL");

281 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

282 
MODULE_DESCRIPTION
("SCSI CDROM (type 5) dev handler for SCST");

283 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_cdrom.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

49 cÚ¡ 
	g__moduË_d•’ds
[]

50 
__u£d


51 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

55 
MODULE_INFO
(
¤cv”siÚ
, "0EED6D0326794ACA9059199");

57 cÚ¡ 
rh–d©a
 
_rh–d©a
 
__u£d


58 
__©Œibu‹__
((
£ùiÚ
(".rheldata"))) = {

59 .
rh–_majÜ
 = 6,

60 .
	grh–_mšÜ
 = 4,

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_changer.c

22 
	~<scsi/scsi_ho¡.h
>

23 
	~<lšux/¦ab.h
>

25 
	#LOG_PREFIX
 "dev_chªg”"

	)

27 #ifdeà
INSIDE_KERNEL_TREE


28 
	~<sc¡/sc¡.h
>

30 
	~"sc¡.h
"

32 
	~"sc¡_dev_hªdËr.h
"

34 
	#CHANGER_NAME
 "dev_chªg”"

	)

36 
	#CHANGER_RETRIES
 2

	)

38 
chªg”_©ch
(
sc¡_deviû
 *);

40 
chªg”_·r£
(
sc¡_cmd
 *);

43 
sc¡_dev_ty³
 
	gchªg”_devty³
 = {

44 .
Çme
 = 
CHANGER_NAME
,

45 .
	gty³
 = 
TYPE_MEDIUM_CHANGER
,

46 .
	gth»ads_num
 = 1,

47 .
	g·r£_©omic
 = 1,

49 .
	g©ch
 = 
chªg”_©ch
,

51 .
	g·r£
 = 
chªg”_·r£
,

53 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

54 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

55 .
	gŒaû_æags
 = &
Œaû_æag
,

59 
	$chªg”_©ch
(
sc¡_deviû
 *
dev
)

61 
»s
, 
rc
;

62 
»Œ›s
;

64 
	`TRACE_ENTRY
();

66 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

67 
dev
->
scsi_dev
->
ty³
 != dev->type) {

68 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

69 
»s
 = -
ENODEV
;

70 
out
;

77 ià(
dev
->
scsi_dev
->
sdev_¡©e
 =ð
SDEV_OFFLINE
) {

78 
	`TRACE_DBG
("%s", "Device is offline");

79 
»s
 = -
ENODEV
;

80 
out
;

83 
»Œ›s
 = 
SCST_DEV_UA_RETRIES
;

85 
	`TRACE_DBG
("%s", "Doing TEST_UNIT_READY");

86 
rc
 = 
	`scsi_‹¡_un™_»ady
(
dev
->
scsi_dev
,

87 
SCST_GENERIC_CHANGER_TIMEOUT
, 
CHANGER_RETRIES


88 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

91 , 
NULL
);

93 
	`TRACE_DBG
("TEST_UNIT_READY dÚe: %x", 
rc
);

94 } (--
»Œ›s
 > 0è&& 
rc
);

96 ià(
rc
) {

97 
	`PRINT_WARNING
("Un™‚Ù„—dy: %x", 
rc
);

101 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
);

102 ià(
»s
 != 0) {

103 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

104 "%s", 
dev
->
vœt_Çme
);

105 
out
;

108 
out
:

109 
	`TRACE_EXIT_HRES
(
»s
);

110  
»s
;

111 
	}
}

114 
	$chªg”_d‘ach
(
sc¡_deviû
 *
dev
)

116 
	`TRACE_ENTRY
();

118 
	`TRACE_EXIT
();

120 
	}
}

123 
	$chªg”_·r£
(
sc¡_cmd
 *
cmd
)

125 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

127 
	`sc¡_chªg”_g’”ic_·r£
(
cmd
, 
NULL
);

129 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

131  
»s
;

132 
	}
}

135 
	$chªg”_dÚe
(
sc¡_cmd
 *
cmd
)

137 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

139 
	`TRACE_ENTRY
();

148 
cmd
->
cdb
[0]) {

155 
	`TRACE_EXIT
();

156  
»s
;

157 
	}
}

160 
__š™
 
	$chªg”_š™
()

162 
»s
 = 0;

164 
	`TRACE_ENTRY
();

166 
chªg”_devty³
.
moduË
 = 
THIS_MODULE
;

168 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
chªg”_devty³
);

169 ià(
»s
 < 0)

170 
out
;

172 #ifdeà
CONFIG_SCST_PROC


173 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
chªg”_devty³
);

174 ià(
»s
 != 0)

175 
out_”r
;

178 
out
:

179 
	`TRACE_EXIT_RES
(
»s
);

180  
»s
;

181 #ifdeà
CONFIG_SCST_PROC


182 
out_”r
:

183 
	`sc¡_uÄegi¡”_dev_driv”
(&
chªg”_devty³
);

184 
out
;

186 
	}
}

188 
__ex™
 
	$chªg”_ex™
()

190 
	`TRACE_ENTRY
();

191 #ifdeà
CONFIG_SCST_PROC


192 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
chªg”_devty³
);

194 
	`sc¡_uÄegi¡”_dev_driv”
(&
chªg”_devty³
);

195 
	`TRACE_EXIT
();

197 
	}
}

199 
moduË_š™
(
chªg”_š™
);

200 
moduË_ex™
(
chªg”_ex™
);

202 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

203 
MODULE_LICENSE
("GPL");

204 
MODULE_DESCRIPTION
("SCSI medium changer (type 8) dev handler for SCST");

205 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_changer.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

41 cÚ¡ 
	g__moduË_d•’ds
[]

42 
__u£d


43 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

47 
MODULE_INFO
(
¤cv”siÚ
, "4856FA65E3DD0522F42CD2E");

49 cÚ¡ 
rh–d©a
 
_rh–d©a
 
__u£d


50 
__©Œibu‹__
((
£ùiÚ
(".rheldata"))) = {

51 .
rh–_majÜ
 = 6,

52 .
	grh–_mšÜ
 = 4,

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_dev_handler.h

1 #iâdeà
__SCST_DEV_HANDLER_H


2 
	#__SCST_DEV_HANDLER_H


	)

4 
	~<lšux/moduË.h
>

5 
	~<scsi/scsi_eh.h
>

6 #ifdeà
INSIDE_KERNEL_TREE


7 
	~<sc¡/sc¡_debug.h
>

9 
	~"sc¡_debug.h
"

12 
	#SCST_DEV_UA_RETRIES
 5

	)

13 
	#SCST_PASSTHROUGH_RETRIES
 0

	)

15 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

17 #ifdeà
CONFIG_SCST_DEBUG


18 
	#SCST_DEFAULT_DEV_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_PID
 | \

19 
TRACE_LINE
 | 
TRACE_FUNCTION
 | 
TRACE_MGMT
 | 
TRACE_MINOR
 | \

20 
TRACE_MGMT_DEBUG
 | 
TRACE_SPECIAL
)

	)

22 
	#SCST_DEFAULT_DEV_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MGMT
 | \

23 
TRACE_SPECIAL
)

	)

26 
	gdh_Œaû_æag
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
;

27 
	#Œaû_æag
 
dh_Œaû_æag


	)

29 #ifdeà
CONFIG_SCST_PROC


31 
	#DEV_HANDLER_LOG_ENTRY_NAME
 "Œaû_Ëv–"

	)

33 #iâdeà
Œaû_log_tbl


34 
	#Œaû_log_tbl
 
NULL


	)

37 
sc¡_´oc_d©a
 
	gdev_hªdËr_log_´oc_d©a
;

39 
	$dev_hªdËr_log_šfo_show
(
£q_fže
 *
£q
, *
v
)

41 
»s
 = 0;

43 
	`TRACE_ENTRY
();

45 
»s
 = 
	`sc¡_´oc_log_’Œy_»ad
(
£q
, 
Œaû_æag
, 
Œaû_log_tbl
);

47 
	`TRACE_EXIT_RES
(
»s
);

48  
»s
;

49 
	}
}

51 
ssize_t
 
	$sc¡_dev_hªdËr_´oc_log_’Œy_wr™e
(
fže
 *file,

52 cÚ¡ 
__u£r
 *
buf
, 
size_t
 
Ëngth
, 
loff_t
 *
off
)

54 
»s
 = 0;

56 
	`TRACE_ENTRY
();

58 
»s
 = 
	`sc¡_´oc_log_’Œy_wr™e
(
fže
, 
buf
, 
Ëngth
, &
Œaû_æag
,

59 
SCST_DEFAULT_DEV_LOG_FLAGS
, 
Œaû_log_tbl
);

61 
	`TRACE_EXIT_RES
(
»s
);

62  
»s
;

63 
	}
}

69 #ifdeà
CONFIG_SCST_PROC


71 
	$sc¡_dev_hªdËr_bužd_¡d_´oc
(
sc¡_dev_ty³
 *
dev_ty³
)

73 
»s
 = 0;

74 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

75 
´oc_dœ_’Œy
 *
p
, *
roÙ
;

77 
	`TRACE_ENTRY
();

79 
roÙ
 = 
	`sc¡_´oc_g‘_dev_ty³_roÙ
(
dev_ty³
);

80 ià(
roÙ
) {

83 cÚ¡ *
Çme
;

84 ià(
	`¡rcmp
(
dev_ty³
->
Çme
, "vdisk_fileio") == 0)

85 
Çme
 = "vdisk";

87 
Çme
 = 
dev_ty³
->name;

88 
dev_hªdËr_log_´oc_d©a
.
d©a
 = (*)
Çme
;

89 
p
 = 
	`sc¡_ü—‹_´oc_’Œy
(
roÙ
, 
DEV_HANDLER_LOG_ENTRY_NAME
,

90 &
dev_hªdËr_log_´oc_d©a
);

91 ià(
p
 =ð
NULL
) {

92 
	`PRINT_ERROR
("Notƒnough memoryo„egister dev "

94 
Çme
, 
DEV_HANDLER_LOG_ENTRY_NAME
);

95 
»s
 = -
ENOMEM
;

96 
out
;

100 
out
:

101 
	`TRACE_EXIT_RES
(
»s
);

103  
»s
;

104 
	}
}

106 
	$sc¡_dev_hªdËr_de¡roy_¡d_´oc
(
sc¡_dev_ty³
 *
dev_ty³
)

108 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

109 
´oc_dœ_’Œy
 *
roÙ
;

111 
	`TRACE_ENTRY
();

113 
roÙ
 = 
	`sc¡_´oc_g‘_dev_ty³_roÙ
(
dev_ty³
);

114 ià(
roÙ
)

115 
	`»move_´oc_’Œy
(
DEV_HANDLER_LOG_ENTRY_NAME
, 
roÙ
);

117 
	`TRACE_EXIT
();

119 
	}
}

121 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

122 
sc¡_´oc_d©a
 
	gdev_hªdËr_log_´oc_d©a
 = {

123 
SCST_DEF_RW_SEQ_OP
(
sc¡_dev_hªdËr_´oc_log_’Œy_wr™e
)

124 .
show
 = 
dev_hªdËr_log_šfo_show
,

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_disk.c

25 
	~<lšux/moduË.h
>

26 
	~<lšux/š™.h
>

27 
	~<lšux/blkdev.h
>

28 
	~<scsi/scsi_ho¡.h
>

29 
	~<lšux/¦ab.h
>

30 
	~<asm/uÇligÃd.h
>

32 
	#LOG_PREFIX
 "dev_disk"

	)

34 #ifdeà
INSIDE_KERNEL_TREE


35 
	~<sc¡/sc¡.h
>

37 
	~"sc¡.h
"

39 
	~"sc¡_dev_hªdËr.h
"

41 
	#DISK_NAME
 "dev_disk"

	)

42 
	#DISK_PERF_NAME
 "dev_disk_³rf"

	)

44 
	#DISK_DEF_BLOCK_SHIFT
 9

	)

46 
	sdisk_·¿ms
 {

47 
	mblock_shiá
;

50 
disk_©ch
(
sc¡_deviû
 *
dev
);

51 
disk_d‘ach
(
sc¡_deviû
 *
dev
);

52 
disk_·r£
(
sc¡_cmd
 *
cmd
);

53 
disk_³rf_exec
(
sc¡_cmd
 *
cmd
);

54 
disk_dÚe
(
sc¡_cmd
 *
cmd
);

55 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)è&& 
defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

56 
disk_exec
(
sc¡_cmd
 *
cmd
);

57 
boÞ
 
disk_Ú_sg_bËsize_low
(
sc¡_cmd
 *
cmd
);

60 
sc¡_dev_ty³
 
	gdisk_devty³
 = {

61 .
Çme
 = 
DISK_NAME
,

62 .
	gty³
 = 
TYPE_DISK
,

63 .
	gth»ads_num
 = 1,

64 .
	g·r£_©omic
 = 1,

65 .
	gdev_dÚe_©omic
 = 1,

66 .
	g©ch
 = 
disk_©ch
,

67 .
	gd‘ach
 = 
disk_d‘ach
,

68 .
	g·r£
 = 
disk_·r£
,

69 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)è&& 
defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

70 .
	gexec
 = 
disk_exec
,

71 .
	gÚ_sg_bËsize_low
 = 
disk_Ú_sg_bËsize_low
,

73 .
	gdev_dÚe
 = 
disk_dÚe
,

74 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

75 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

76 .
	gŒaû_æags
 = &
Œaû_æag
,

80 
sc¡_dev_ty³
 
	gdisk_devty³_³rf
 = {

81 .
Çme
 = 
DISK_PERF_NAME
,

82 .
	gty³
 = 
TYPE_DISK
,

83 .
	g·r£_©omic
 = 1,

84 .
	gdev_dÚe_©omic
 = 1,

85 .
	g©ch
 = 
disk_©ch
,

86 .
	gd‘ach
 = 
disk_d‘ach
,

87 .
	g·r£
 = 
disk_·r£
,

88 .
	gexec
 = 
disk_³rf_exec
,

89 .
	gdev_dÚe
 = 
disk_dÚe
,

90 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)è&& 
defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

91 .
	gÚ_sg_bËsize_low
 = 
disk_Ú_sg_bËsize_low
,

93 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

94 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

95 .
	gŒaû_æags
 = &
Œaû_æag
,

99 
__š™
 
	$š™_sc¡_disk_driv”
()

101 
»s
 = 0;

103 
	`TRACE_ENTRY
();

105 
disk_devty³
.
moduË
 = 
THIS_MODULE
;

107 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
disk_devty³
);

108 ià(
»s
 < 0)

109 
out
;

111 
disk_devty³_³rf
.
moduË
 = 
THIS_MODULE
;

113 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
disk_devty³_³rf
);

114 ià(
»s
 < 0)

115 
out_uÄeg
;

117 #ifdeà
CONFIG_SCST_PROC


118 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
disk_devty³
);

119 ià(
»s
 != 0)

120 
out_uÄeg1
;

122 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
disk_devty³_³rf
);

123 ià(
»s
 != 0)

124 
out_uÄeg2
;

127 
out
:

128 
	`TRACE_EXIT_RES
(
»s
);

129  
»s
;

131 #ifdeà
CONFIG_SCST_PROC


132 
out_uÄeg2
:

133 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
disk_devty³
);

135 
out_uÄeg1
:

136 
	`sc¡_uÄegi¡”_dev_driv”
(&
disk_devty³_³rf
);

139 
out_uÄeg
:

140 
	`sc¡_uÄegi¡”_dev_driv”
(&
disk_devty³
);

141 
out
;

142 
	}
}

144 
__ex™
 
	$ex™_sc¡_disk_driv”
()

146 
	`TRACE_ENTRY
();

148 #ifdeà
CONFIG_SCST_PROC


149 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
disk_devty³_³rf
);

150 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
disk_devty³
);

152 
	`sc¡_uÄegi¡”_dev_driv”
(&
disk_devty³_³rf
);

153 
	`sc¡_uÄegi¡”_dev_driv”
(&
disk_devty³
);

155 
	`TRACE_EXIT
();

157 
	}
}

159 
moduË_š™
(
š™_sc¡_disk_driv”
);

160 
moduË_ex™
(
ex™_sc¡_disk_driv”
);

162 
	$disk_©ch
(
sc¡_deviû
 *
dev
)

164 
»s
, 
rc
;

165 
ušt8_t
 
cmd
[10];

166 cÚ¡ 
bufãr_size
 = 512;

167 
ušt8_t
 *
bufãr
 = 
NULL
;

168 
»Œ›s
;

169 
£n£_bufãr
[
SCSI_SENSE_BUFFERSIZE
];

170 
dma_d©a_dœeùiÚ
 
d©a_dœ
;

171 
disk_·¿ms
 *
·¿ms
;

173 
	`TRACE_ENTRY
();

175 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

176 
dev
->
scsi_dev
->
ty³
 != dev->type) {

177 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

178 
»s
 = -
ENODEV
;

179 
out
;

182 
·¿ms
 = 
	`kz®loc
((*·¿ms), 
GFP_KERNEL
);

183 ià(
·¿ms
 =ð
NULL
) {

184 
	`PRINT_ERROR
("Unableo‡llocate struct disk_params (size %zd)",

185 (*
·¿ms
));

186 
»s
 = -
ENOMEM
;

187 
out
;

190 
bufãr
 = 
	`km®loc
(
bufãr_size
, 
GFP_KERNEL
);

191 ià(!
bufãr
) {

192 
	`PRINT_ERROR
("Buffer memory‡llocation (size %d) failure",

193 
bufãr_size
);

194 
»s
 = -
ENOMEM
;

195 
out_ä“_·¿ms
;

199 
	`mem£t
(
cmd
, 0, (cmd));

200 
cmd
[0] = 
READ_CAPACITY
;

201 
cmd
[1] = (
dev
->
scsi_dev
->
scsi_Ëv–
 <ð
SCSI_2
) ?

202 ((
dev
->
scsi_dev
->
lun
 << 5) & 0xe0) : 0;

203 
»Œ›s
 = 
SCST_DEV_UA_RETRIES
;

205 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

206 
	`mem£t
(
£n£_bufãr
, 0, (sense_buffer));

207 
d©a_dœ
 = 
SCST_DATA_READ
;

209 
	`TRACE_DBG
("%s", "Doing READ_CAPACITY");

210 
rc
 = 
	`scsi_execu‹
(
dev
->
scsi_dev
, 
cmd
, 
d©a_dœ
, 
bufãr
,

211 
bufãr_size
, 
£n£_bufãr
,

212 
SCST_GENERIC_DISK_REG_TIMEOUT
, 3, 0

213 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2,6,29)

214 , 
NULL


218 
	`TRACE_DBG
("READ_CAPACITY dÚe: %x", 
rc
);

220 ià((
rc
 == 0) ||

221 !
	`sc¡_ª®yze_£n£
(
£n£_bufãr
,

222 (
£n£_bufãr
), 
SCST_SENSE_KEY_VALID
,

223 
UNIT_ATTENTION
, 0, 0))

225 ià(!--
»Œ›s
) {

226 
	`PRINT_ERROR
("UA‚ot clear‡fter %d„etries",

227 
SCST_DEV_UA_RETRIES
);

228 
»s
 = -
ENODEV
;

229 
out_ä“_buf
;

232 ià(
rc
 == 0) {

233 
£ùÜ_size
 = ((
bufãr
[4] << 24) | (buffer[5] << 16) |

234 (
bufãr
[6] << 8) | (buffer[7] << 0));

235 ià(
£ùÜ_size
 == 0)

236 
·¿ms
->
block_shiá
 = 
DISK_DEF_BLOCK_SHIFT
;

238 
·¿ms
->
block_shiá
 =

239 
	`sc¡_ÿlc_block_shiá
(
£ùÜ_size
);

241 
·¿ms
->
block_shiá
 = 
DISK_DEF_BLOCK_SHIFT
;

242 
	`TRACE
(
TRACE_MINOR
, "Read capacity failed: %x, using default "

243 "£ùÜ siz%d", 
rc
, 
·¿ms
->
block_shiá
);

244 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "R‘uºed s’£", 
£n£_bufãr
,

245 (
£n£_bufãr
));

248 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
);

249 ià(
»s
 != 0) {

250 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

251 "%s", 
dev
->
vœt_Çme
);

252 
out_ä“_buf
;

255 
out_ä“_buf
:

256 
	`kä“
(
bufãr
);

258 
out_ä“_·¿ms
:

259 ià(
»s
 == 0)

260 
dev
->
dh_´iv
 = 
·¿ms
;

262 
	`kä“
(
·¿ms
);

264 
out
:

265 
	`TRACE_EXIT_RES
(
»s
);

266  
»s
;

267 
	}
}

269 
	$disk_d‘ach
(
sc¡_deviû
 *
dev
)

271 
disk_·¿ms
 *
·¿ms
 =

272 (
disk_·¿ms
 *)
dev
->
dh_´iv
;

274 
	`TRACE_ENTRY
();

276 
	`kä“
(
·¿ms
);

277 
dev
->
dh_´iv
 = 
NULL
;

279 
	`TRACE_EXIT
();

281 
	}
}

283 
	$disk_g‘_block_shiá
(
sc¡_cmd
 *
cmd
)

285 
disk_·¿ms
 *
·¿ms
 = (disk_·¿m *)
cmd
->
dev
->
dh_´iv
;

290  
·¿ms
->
block_shiá
;

291 
	}
}

293 
	$disk_·r£
(
sc¡_cmd
 *
cmd
)

295 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

297 
	`sc¡_sbc_g’”ic_·r£
(
cmd
, 
disk_g‘_block_shiá
);

299 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

301  
»s
;

302 
	}
}

304 
	$disk_£t_block_shiá
(
sc¡_cmd
 *
cmd
, 
block_shiá
)

306 
disk_·¿ms
 *
·¿ms
 = (disk_·¿m *)
cmd
->
dev
->
dh_´iv
;

311 ià(
block_shiá
 != 0)

312 
·¿ms
->
block_shiá
 = block_shift;

314 
·¿ms
->
block_shiá
 = 
DISK_DEF_BLOCK_SHIFT
;

316 
	}
}

318 
	$disk_dÚe
(
sc¡_cmd
 *
cmd
)

320 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

322 
	`TRACE_ENTRY
();

324 
»s
 = 
	`sc¡_block_g’”ic_dev_dÚe
(
cmd
, 
disk_£t_block_shiá
);

326 
	`TRACE_EXIT_RES
(
»s
);

327  
»s
;

328 
	}
}

330 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)è&& 
defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

332 
boÞ
 
	$disk_Ú_sg_bËsize_low
(
sc¡_cmd
 *
cmd
)

334 
boÞ
 
»s
;

336 
	`TRACE_ENTRY
();

338 
cmd
->
cdb
[0]) {

339 
WRITE_6
:

340 
READ_6
:

341 
WRITE_10
:

342 
READ_10
:

343 
WRITE_VERIFY
:

344 
WRITE_12
:

345 
READ_12
:

346 
WRITE_VERIFY_12
:

347 
WRITE_16
:

348 
READ_16
:

349 
WRITE_VERIFY_16
:

350 
»s
 = 
Œue
;

352 
cmd
->
šc_ex³ùed_¢_Ú_dÚe
 = 1;

355 
»s
 = 
çl£
;

359 
	`TRACE_EXIT_RES
(
»s
);

360  
»s
;

361 
	}
}

363 
	sdisk_wÜk
 {

364 
sc¡_cmd
 *
	mcmd
;

365 
com¶‘iÚ
 
	mdisk_wÜk_cm¶
;

366 
	m»suÉ
;

367 
	mËá
;

368 
ušt64_t
 
	m§ve_lba
;

369 
	m§ve_Ën
;

370 
sÿ‰”li¡
 *
	m§ve_sg
;

371 
	m§ve_sg_út
;

374 
	$disk_cdb_g‘_Œªsãr_d©a
(cÚ¡ 
ušt8_t
 *
cdb
,

375 
ušt64_t
 *
out_lba
, *
out_Ëngth
)

377 
»s
;

378 
ušt64_t
 
lba
;

379 
Ën
;

381 
	`TRACE_ENTRY
();

383 
cdb
[0]) {

384 
WRITE_6
:

385 
READ_6
:

386 
lba
 = 
	`be16_to_ýu
(
	`g‘_uÇligÃd
((
__be16
 *)&
cdb
[2]));

387 
Ën
 = 
cdb
[4];

389 
WRITE_10
:

390 
READ_10
:

391 
WRITE_VERIFY
:

392 
lba
 = 
	`be32_to_ýu
(
	`g‘_uÇligÃd
((
__be32
 *)&
cdb
[2]));

393 
Ën
 = 
	`be16_to_ýu
(
	`g‘_uÇligÃd
((
__be16
 *)&
cdb
[7]));

395 
WRITE_12
:

396 
READ_12
:

397 
WRITE_VERIFY_12
:

398 
lba
 = 
	`be32_to_ýu
(
	`g‘_uÇligÃd
((
__be32
 *)&
cdb
[2]));

399 
Ën
 = 
	`be32_to_ýu
(
	`g‘_uÇligÃd
((
__be32
 *)&
cdb
[6]));

401 
WRITE_16
:

402 
READ_16
:

403 
WRITE_VERIFY_16
:

404 
lba
 = 
	`be64_to_ýu
(
	`g‘_uÇligÃd
((
__be64
 *)&
cdb
[2]));

405 
Ën
 = 
	`be32_to_ýu
(
	`g‘_uÇligÃd
((
__be32
 *)&
cdb
[10]));

408 
»s
 = -
EINVAL
;

409 
out
;

412 
»s
 = 0;

413 *
out_lba
 = 
lba
;

414 *
out_Ëngth
 = 
Ën
;

416 
	`TRACE_DBG
("LBA %Îd,†’gth %d", ()
lba
, 
Ën
);

418 
out
:

419 
	`TRACE_EXIT_RES
(
»s
);

420  
»s
;

421 
	}
}

423 
	$disk_cdb_£t_Œªsãr_d©a
(
ušt8_t
 *
cdb
,

424 
ušt64_t
 
lba
, 
Ën
)

426 
»s
;

428 
	`TRACE_ENTRY
();

430 
cdb
[0]) {

431 
WRITE_6
:

432 
READ_6
:

433 
	`put_uÇligÃd
(
	`ýu_to_be16
(
lba
), (
__be16
 *)&
cdb
[2]);

434 
cdb
[4] = 
Ën
;

436 
WRITE_10
:

437 
READ_10
:

438 
WRITE_VERIFY
:

439 
	`put_uÇligÃd
(
	`ýu_to_be32
(
lba
), (
__be32
 *)&
cdb
[2]);

440 
	`put_uÇligÃd
(
	`ýu_to_be16
(
Ën
), (
__be16
 *)&
cdb
[7]);

442 
WRITE_12
:

443 
READ_12
:

444 
WRITE_VERIFY_12
:

445 
	`put_uÇligÃd
(
	`ýu_to_be32
(
lba
), (
__be32
 *)&
cdb
[2]);

446 
	`put_uÇligÃd
(
	`ýu_to_be32
(
Ën
), (
__be32
 *)&
cdb
[6]);

448 
WRITE_16
:

449 
READ_16
:

450 
WRITE_VERIFY_16
:

451 
	`put_uÇligÃd
(
	`ýu_to_be64
(
lba
), (
__be64
 *)&
cdb
[2]);

452 
	`put_uÇligÃd
(
	`ýu_to_be32
(
Ën
), (
__be32
 *)&
cdb
[10]);

455 
»s
 = -
EINVAL
;

456 
out
;

459 
»s
 = 0;

461 
	`TRACE_DBG
("LBA %Îd,†’gth %d", ()
lba
, 
Ën
);

462 
	`TRACE_BUFFER
("New CDB", 
cdb
, 
SCST_MAX_CDB_SIZE
);

464 
out
:

465 
	`TRACE_EXIT_RES
(
»s
);

466  
»s
;

467 
	}
}

469 
	$disk_»¡Üe_sg
(
disk_wÜk
 *
wÜk
)

471 
	`disk_cdb_£t_Œªsãr_d©a
(
wÜk
->
cmd
->
cdb
, wÜk->
§ve_lba
, wÜk->
§ve_Ën
);

472 
wÜk
->
cmd
->
sg
 = wÜk->
§ve_sg
;

473 
wÜk
->
cmd
->
sg_út
 = wÜk->
§ve_sg_út
;

475 
	}
}

477 
	$disk_cmd_dÚe
(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
)

479 
disk_wÜk
 *
wÜk
 = 
d©a
;

481 
	`TRACE_ENTRY
();

483 
	`TRACE_DBG
("work %p, cmd %p,†eft %d,„esult %d, sense %p,„esid %d",

484 
wÜk
, wÜk->
cmd
, wÜk->
Ëá
, 
»suÉ
, 
£n£
, 
»sid
);

486 ià(
»suÉ
 =ð
SAM_STAT_GOOD
)

487 
out_com¶‘e
;

489 
wÜk
->
»suÉ
 =„esult;

491 
	`disk_»¡Üe_sg
(
wÜk
);

493 
	`sc¡_·ss_through_cmd_dÚe
(
wÜk
->
cmd
, 
£n£
, 
»suÉ
, 
»sid
 + wÜk->
Ëá
);

495 
out_com¶‘e
:

496 
	`com¶‘e_®l
(&
wÜk
->
disk_wÜk_cm¶
);

498 
	`TRACE_EXIT
();

500 
	}
}

503 
	$disk_exec
(
sc¡_cmd
 *
cmd
)

505 
»s
, 
rc
;

506 
disk_·¿ms
 *
·¿ms
 = (disk_·¿m *)
cmd
->
dev
->
dh_´iv
;

507 
disk_wÜk
 
wÜk
;

508 
off£t
, 
cur_Ën
;

509 
sÿ‰”li¡
 *
sg
, *
¡¬t_sg
;

510 
cur_sg_út
;

511 
sg_bËsize
 = 
cmd
->
dev
->
scsi_dev
->
ho¡
->sg_tablesize;

512 
max_£ùÜs
;

513 
num
, 
j
;

515 
	`TRACE_ENTRY
();

521 
max_£ùÜs
 = 
	`queue_max_hw_£ùÜs
(
cmd
->
dev
->
scsi_dev
->
»que¡_queue
);

523 ià(
	`uÆik–y
(((
max_£ùÜs
 << 
·¿ms
->
block_shiá
è& ~
PAGE_MASK
) != 0)) {

524 
mËn
 = 
max_£ùÜs
 << 
·¿ms
->
block_shiá
;

525 
pg
 = ((
mËn
 >> 
PAGE_SHIFT
è+ ((mËÀ& ~
PAGE_MASK
) != 0)) - 1;

526 
adj_Ën
 = 
pg
 << 
PAGE_SHIFT
;

527 
max_£ùÜs
 = 
adj_Ën
 >> 
·¿ms
->
block_shiá
;

528 ià(
max_£ùÜs
 == 0) {

529 
	`PRINT_ERROR
("ToØlow max seùÜ %d", 
max_£ùÜs
);

530 
out_”rÜ
;

534 ià(
	`uÆik–y
((
cmd
->
bufæ’
 >> 
·¿ms
->
block_shiá
è> 
max_£ùÜs
)) {

535 ià((
cmd
->
out_bufæ’
 >> 
·¿ms
->
block_shiá
è> 
max_£ùÜs
) {

536 
	`PRINT_ERROR
("Too†imited max_sectors %d for "

538 
max_£ùÜs
, 
cmd
->
cdb
[0], cmd->
out_bufæ’
);

540 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

541 
out
;

543 
¥l™
;

546 ià(
	`lik–y
(
cmd
->
sg_út
 <ð
sg_bËsize
)) {

547 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

548 
out
;

551 
¥l™
:

552 
	`sBUG_ON
(
cmd
->
out_sg_út
 > 
sg_bËsize
);

553 
	`sBUG_ON
((
cmd
->
out_bufæ’
 >> 
·¿ms
->
block_shiá
è> 
max_£ùÜs
);

560 
	`mem£t
(&
wÜk
, 0, (work));

561 
wÜk
.
cmd
 = cmd;

562 
wÜk
.
§ve_sg
 = 
cmd
->
sg
;

563 
wÜk
.
§ve_sg_út
 = 
cmd
->
sg_út
;

564 
rc
 = 
	`disk_cdb_g‘_Œªsãr_d©a
(
cmd
->
cdb
, &
wÜk
.
§ve_lba
,

565 &
wÜk
.
§ve_Ën
);

566 ià(
rc
 != 0)

567 
out_”rÜ
;

569 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

570 ià(
	`uÆik–y
(
rc
 != 0))

571 
out_dÚe
;

573 
cmd
->
¡©us
 = 0;

574 
cmd
->
msg_¡©us
 = 0;

575 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

576 
cmd
->
driv”_¡©us
 = 0;

578 
	`TRACE_DBG
("cmd %p, save_sg %p, save_sg_cnt %d, save_lba %lld, "

580 "sizeof(*sgè0x%zx)", 
cmd
, 
wÜk
.
§ve_sg
, wÜk.
§ve_sg_út
,

581 ()
wÜk
.
§ve_lba
, wÜk.
§ve_Ën
,

582 
sg_bËsize
, 
max_£ùÜs
, 
·¿ms
->
block_shiá
, (*
sg
));

590 
num
 = 1;

591 
j
 = 0;

592 
off£t
 = 0;

593 
cur_Ën
 = 0;

594 
sg
 = 
wÜk
.
§ve_sg
;

595 
¡¬t_sg
 = 
sg
;

596 
cur_sg_út
 = 0;

598 
l
;

600 ià(
	`uÆik–y
(
	`sg_is_chaš
(&
sg
[
j
]))) {

601 
boÞ
 
»£t_¡¬t_sg
 = (
¡¬t_sg
 =ð&
sg
[
j
]);

602 
sg
 = 
	`sg_chaš_±r
(&sg[
j
]);

603 
j
 = 0;

604 ià(
»£t_¡¬t_sg
)

605 
¡¬t_sg
 = 
sg
;

608 
l
 = 
sg
[
j
].
Ëngth
 >> 
·¿ms
->
block_shiá
;

609 
cur_Ën
 +ð
l
;

610 
cur_sg_út
++;

612 
	`TRACE_DBG
("l %d, j %d,‚um %d, offset %d, cur_len %d, "

613 "cur_sg_úˆ%d, s¹_sg %p", 
l
, 
j
, 
num
, 
off£t
,

614 
cur_Ën
, 
cur_sg_út
, 
¡¬t_sg
);

616 ià(((
num
 % 
sg_bËsize
) == 0) ||

617 (
num
 =ð
wÜk
.
§ve_sg_út
) ||

618 (
cur_Ën
 >ð
max_£ùÜs
)) {

619 
	`TRACE_DBG
("%s", "Execing...");

621 
	`disk_cdb_£t_Œªsãr_d©a
(
cmd
->
cdb
,

622 
wÜk
.
§ve_lba
 + 
off£t
, 
cur_Ën
);

623 
cmd
->
sg
 = 
¡¬t_sg
;

624 
cmd
->
sg_út
 = 
cur_sg_út
;

626 
wÜk
.
Ëá
 = wÜk.
§ve_Ën
 - (
off£t
 + 
cur_Ën
);

627 
	`š™_com¶‘iÚ
(&
wÜk
.
disk_wÜk_cm¶
);

629 
rc
 = 
	`sc¡_scsi_exec_async
(
cmd
, &
wÜk
, 
disk_cmd_dÚe
);

630 ià(
	`uÆik–y
(
rc
 != 0)) {

631 
	`PRINT_ERROR
("scst_scsi_exec_async() failed: %d",

632 
rc
);

633 
out_”r_»¡Üe
;

636 
	`wa™_fÜ_com¶‘iÚ
(&
wÜk
.
disk_wÜk_cm¶
);

638 ià(
wÜk
.
»suÉ
 !ð
SAM_STAT_GOOD
) {

640 
»s
 = 
SCST_EXEC_COMPLETED
;

641 
out
;

644 
off£t
 +ð
cur_Ën
;

645 
cur_Ën
 = 0;

646 
cur_sg_út
 = 0;

647 
¡¬t_sg
 = &
sg
[
j
+1];

649 ià(
num
 =ð
wÜk
.
§ve_sg_út
)

652 
num
++;

653 
j
++;

656 
cmd
->
com¶‘ed
 = 1;

658 
out_»¡Üe
:

659 
	`disk_»¡Üe_sg
(&
wÜk
);

661 
out_dÚe
:

662 
»s
 = 
SCST_EXEC_COMPLETED
;

663 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

665 
out
:

666 
	`TRACE_EXIT_RES
(
»s
);

667  
»s
;

669 
out_”r_»¡Üe
:

670 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

671 
out_»¡Üe
;

673 
out_”rÜ
:

674 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

675 
out_dÚe
;

676 
	}
}

680 
	$disk_³rf_exec
(
sc¡_cmd
 *
cmd
)

682 
»s
, 
rc
;

683 
Ýcode
 = 
cmd
->
cdb
[0];

685 
	`TRACE_ENTRY
();

687 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

688 ià(
	`uÆik–y
(
rc
 != 0))

689 
out_dÚe
;

691 
cmd
->
¡©us
 = 0;

692 
cmd
->
msg_¡©us
 = 0;

693 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

694 
cmd
->
driv”_¡©us
 = 0;

696 
Ýcode
) {

697 
WRITE_6
:

698 
WRITE_10
:

699 
WRITE_12
:

700 
WRITE_16
:

701 
READ_6
:

702 
READ_10
:

703 
READ_12
:

704 
READ_16
:

705 
WRITE_VERIFY
:

706 
WRITE_VERIFY_12
:

707 
WRITE_VERIFY_16
:

708 
out_com¶‘e
;

711 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

713 
out
:

714 
	`TRACE_EXIT_RES
(
»s
);

715  
»s
;

717 
out_com¶‘e
:

718 
cmd
->
com¶‘ed
 = 1;

720 
out_dÚe
:

721 
»s
 = 
SCST_EXEC_COMPLETED
;

722 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

723 
out
;

724 
	}
}

726 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

727 
MODULE_LICENSE
("GPL");

728 
MODULE_DESCRIPTION
("SCSI disk (type 0) dev handler for SCST");

729 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_disk.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

50 cÚ¡ 
	g__moduË_d•’ds
[]

51 
__u£d


52 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

56 
MODULE_INFO
(
¤cv”siÚ
, "0255308F3F30D714037A394");

58 cÚ¡ 
rh–d©a
 
_rh–d©a
 
__u£d


59 
__©Œibu‹__
((
£ùiÚ
(".rheldata"))) = {

60 .
rh–_majÜ
 = 6,

61 .
	grh–_mšÜ
 = 4,

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_modisk.c

25 
	~<lšux/moduË.h
>

26 
	~<lšux/š™.h
>

27 
	~<scsi/scsi_ho¡.h
>

28 
	~<lšux/¦ab.h
>

30 
	#LOG_PREFIX
 "dev_modisk"

	)

32 #ifdeà
INSIDE_KERNEL_TREE


33 
	~<sc¡/sc¡.h
>

35 
	~"sc¡.h
"

37 
	~"sc¡_dev_hªdËr.h
"

39 
	#MODISK_NAME
 "dev_modisk"

	)

40 
	#MODISK_PERF_NAME
 "dev_modisk_³rf"

	)

42 
	#MODISK_DEF_BLOCK_SHIFT
 10

	)

44 
	smodisk_·¿ms
 {

45 
	mblock_shiá
;

48 
modisk_©ch
(
sc¡_deviû
 *);

49 
modisk_d‘ach
(
sc¡_deviû
 *);

50 
modisk_·r£
(
sc¡_cmd
 *);

51 
modisk_dÚe
(
sc¡_cmd
 *);

52 
modisk_³rf_exec
(
sc¡_cmd
 *);

54 
sc¡_dev_ty³
 
	gmodisk_devty³
 = {

55 .
Çme
 = 
MODISK_NAME
,

56 .
	gty³
 = 
TYPE_MOD
,

57 .
	gth»ads_num
 = 1,

58 .
	g·r£_©omic
 = 1,

59 .
	gdev_dÚe_©omic
 = 1,

60 .
	g©ch
 = 
modisk_©ch
,

61 .
	gd‘ach
 = 
modisk_d‘ach
,

62 .
	g·r£
 = 
modisk_·r£
,

63 .
	gdev_dÚe
 = 
modisk_dÚe
,

64 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

65 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

66 .
	gŒaû_æags
 = &
Œaû_æag
,

70 
sc¡_dev_ty³
 
	gmodisk_devty³_³rf
 = {

71 .
Çme
 = 
MODISK_PERF_NAME
,

72 .
	gty³
 = 
TYPE_MOD
,

73 .
	g·r£_©omic
 = 1,

74 .
	gdev_dÚe_©omic
 = 1,

75 .
	g©ch
 = 
modisk_©ch
,

76 .
	gd‘ach
 = 
modisk_d‘ach
,

77 .
	g·r£
 = 
modisk_·r£
,

78 .
	gdev_dÚe
 = 
modisk_dÚe
,

79 .
	gexec
 = 
modisk_³rf_exec
,

80 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

81 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

82 .
	gŒaû_æags
 = &
Œaû_æag
,

86 
__š™
 
	$š™_sc¡_modisk_driv”
()

88 
»s
 = 0;

90 
	`TRACE_ENTRY
();

92 
modisk_devty³
.
moduË
 = 
THIS_MODULE
;

94 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
modisk_devty³
);

95 ià(
»s
 < 0)

96 
out
;

98 
modisk_devty³_³rf
.
moduË
 = 
THIS_MODULE
;

100 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
modisk_devty³_³rf
);

101 ià(
»s
 < 0)

102 
out_uÄeg
;

104 #ifdeà
CONFIG_SCST_PROC


105 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
modisk_devty³
);

106 ià(
»s
 != 0)

107 
out_uÄeg1
;

109 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
modisk_devty³_³rf
);

110 ià(
»s
 != 0)

111 
out_uÄeg2
;

114 
out
:

115 
	`TRACE_EXIT_RES
(
»s
);

116  
»s
;

118 #ifdeà
CONFIG_SCST_PROC


119 
out_uÄeg2
:

120 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
modisk_devty³
);

122 
out_uÄeg1
:

123 
	`sc¡_uÄegi¡”_dev_driv”
(&
modisk_devty³_³rf
);

126 
out_uÄeg
:

127 
	`sc¡_uÄegi¡”_dev_driv”
(&
modisk_devty³
);

128 
out
;

129 
	}
}

131 
__ex™
 
	$ex™_sc¡_modisk_driv”
()

133 
	`TRACE_ENTRY
();

135 #ifdeà
CONFIG_SCST_PROC


136 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
modisk_devty³_³rf
);

137 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
modisk_devty³
);

139 
	`sc¡_uÄegi¡”_dev_driv”
(&
modisk_devty³_³rf
);

140 
	`sc¡_uÄegi¡”_dev_driv”
(&
modisk_devty³
);

142 
	`TRACE_EXIT
();

144 
	}
}

146 
moduË_š™
(
š™_sc¡_modisk_driv”
);

147 
moduË_ex™
(
ex™_sc¡_modisk_driv”
);

149 
	$modisk_©ch
(
sc¡_deviû
 *
dev
)

151 
»s
, 
rc
;

152 
ušt8_t
 
cmd
[10];

153 cÚ¡ 
bufãr_size
 = 512;

154 
ušt8_t
 *
bufãr
 = 
NULL
;

155 
»Œ›s
;

156 
£n£_bufãr
[
SCSI_SENSE_BUFFERSIZE
];

157 
dma_d©a_dœeùiÚ
 
d©a_dœ
;

158 
modisk_·¿ms
 *
·¿ms
;

160 
	`TRACE_ENTRY
();

162 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

163 
dev
->
scsi_dev
->
ty³
 != dev->type) {

164 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

165 
»s
 = -
ENODEV
;

166 
out
;

169 
·¿ms
 = 
	`kz®loc
((*·¿ms), 
GFP_KERNEL
);

170 ià(
·¿ms
 =ð
NULL
) {

171 
	`PRINT_ERROR
("Unableo‡llocate struct modisk_params (size %zd)",

172 (*
·¿ms
));

173 
»s
 = -
ENOMEM
;

174 
out
;

176 
·¿ms
->
block_shiá
 = 
MODISK_DEF_BLOCK_SHIFT
;

182 ià(
dev
->
scsi_dev
->
sdev_¡©e
 =ð
SDEV_OFFLINE
) {

183 
	`TRACE_DBG
("%s", "Device is offline");

184 
»s
 = -
ENODEV
;

185 
out_ä“_·¿ms
;

188 
bufãr
 = 
	`km®loc
(
bufãr_size
, 
GFP_KERNEL
);

189 ià(!
bufãr
) {

190 
	`PRINT_ERROR
("Buffer memory‡llocation (size %d) failure",

191 
bufãr_size
);

192 
»s
 = -
ENOMEM
;

193 
out_ä“_·¿ms
;

200 
	`mem£t
(
cmd
, 0, (cmd));

201 
cmd
[0] = 
READ_CAPACITY
;

202 
cmd
[1] = (
dev
->
scsi_dev
->
scsi_Ëv–
 <ð
SCSI_2
) ?

203 ((
dev
->
scsi_dev
->
lun
 << 5) & 0xe0) : 0;

204 
»Œ›s
 = 
SCST_DEV_UA_RETRIES
;

206 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

207 
	`mem£t
(
£n£_bufãr
, 0, (sense_buffer));

208 
d©a_dœ
 = 
SCST_DATA_READ
;

210 
	`TRACE_DBG
("%s", "Doing READ_CAPACITY");

211 
rc
 = 
	`scsi_execu‹
(
dev
->
scsi_dev
, 
cmd
, 
d©a_dœ
, 
bufãr
,

212 
bufãr_size
, 
£n£_bufãr
,

213 
SCST_GENERIC_MODISK_REG_TIMEOUT
, 3, 0

214 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2,6,29)

215 , 
NULL


219 
	`TRACE_DBG
("READ_CAPACITY dÚe: %x", 
rc
);

221 ià(!
rc
 || !
	`sc¡_ª®yze_£n£
(
£n£_bufãr
,

222 (
£n£_bufãr
), 
SCST_SENSE_KEY_VALID
,

223 
UNIT_ATTENTION
, 0, 0))

226 ià(!--
»Œ›s
) {

227 
	`PRINT_ERROR
("UA‚ot cleared‡fter %d„etries",

228 
SCST_DEV_UA_RETRIES
);

229 
»s
 = -
ENODEV
;

230 
out_ä“_buf
;

234 ià(
rc
 == 0) {

235 
£ùÜ_size
 = ((
bufãr
[4] << 24) | (buffer[5] << 16) |

236 (
bufãr
[6] << 8) | (buffer[7] << 0));

237 ià(
£ùÜ_size
 == 0)

238 
·¿ms
->
block_shiá
 = 
MODISK_DEF_BLOCK_SHIFT
;

240 
·¿ms
->
block_shiá
 =

241 
	`sc¡_ÿlc_block_shiá
(
£ùÜ_size
);

242 
	`TRACE_DBG
("Sector size is %i scsi_level %d(SCSI_2 %d)",

243 
£ùÜ_size
, 
dev
->
scsi_dev
->
scsi_Ëv–
, 
SCSI_2
);

245 
·¿ms
->
block_shiá
 = 
MODISK_DEF_BLOCK_SHIFT
;

246 
	`TRACE
(
TRACE_MINOR
, "Read capacity failed: %x, using default "

247 "£ùÜ siz%d", 
rc
, 
·¿ms
->
block_shiá
);

248 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "R‘uºed s’£", 
£n£_bufãr
,

249 (
£n£_bufãr
));

252 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
);

253 ià(
»s
 != 0) {

254 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

255 "%s: %x", 
dev
->
vœt_Çme
, 
»s
);

256 
out_ä“_buf
;

259 
out_ä“_buf
:

260 
	`kä“
(
bufãr
);

262 
out_ä“_·¿ms
:

263 ià(
»s
 == 0)

264 
dev
->
dh_´iv
 = 
·¿ms
;

266 
	`kä“
(
·¿ms
);

268 
out
:

269 
	`TRACE_EXIT_RES
(
»s
);

270  
»s
;

271 
	}
}

273 
	$modisk_d‘ach
(
sc¡_deviû
 *
dev
)

275 
modisk_·¿ms
 *
·¿ms
 =

276 (
modisk_·¿ms
 *)
dev
->
dh_´iv
;

278 
	`TRACE_ENTRY
();

280 
	`kä“
(
·¿ms
);

281 
dev
->
dh_´iv
 = 
NULL
;

283 
	`TRACE_EXIT
();

285 
	}
}

287 
	$modisk_g‘_block_shiá
(
sc¡_cmd
 *
cmd
)

289 
modisk_·¿ms
 *
·¿ms
 =

290 (
modisk_·¿ms
 *)
cmd
->
dev
->
dh_´iv
;

295  
·¿ms
->
block_shiá
;

296 
	}
}

298 
	$modisk_·r£
(
sc¡_cmd
 *
cmd
)

300 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

302 
	`sc¡_modisk_g’”ic_·r£
(
cmd
, 
modisk_g‘_block_shiá
);

304 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

306  
»s
;

307 
	}
}

309 
	$modisk_£t_block_shiá
(
sc¡_cmd
 *
cmd
, 
block_shiá
)

311 
modisk_·¿ms
 *
·¿ms
 =

312 (
modisk_·¿ms
 *)
cmd
->
dev
->
dh_´iv
;

317 ià(
block_shiá
 != 0)

318 
·¿ms
->
block_shiá
 = block_shift;

320 
·¿ms
->
block_shiá
 = 
MODISK_DEF_BLOCK_SHIFT
;

322 
	}
}

324 
	$modisk_dÚe
(
sc¡_cmd
 *
cmd
)

326 
»s
;

328 
	`TRACE_ENTRY
();

330 
»s
 = 
	`sc¡_block_g’”ic_dev_dÚe
(
cmd
, 
modisk_£t_block_shiá
);

332 
	`TRACE_EXIT_RES
(
»s
);

333  
»s
;

334 
	}
}

336 
	$modisk_³rf_exec
(
sc¡_cmd
 *
cmd
)

338 
»s
 = 
SCST_EXEC_NOT_COMPLETED
, 
rc
;

339 
Ýcode
 = 
cmd
->
cdb
[0];

341 
	`TRACE_ENTRY
();

343 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

344 ià(
	`uÆik–y
(
rc
 != 0))

345 
out_dÚe
;

347 
cmd
->
¡©us
 = 0;

348 
cmd
->
msg_¡©us
 = 0;

349 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

350 
cmd
->
driv”_¡©us
 = 0;

352 
Ýcode
) {

353 
WRITE_6
:

354 
WRITE_10
:

355 
WRITE_12
:

356 
WRITE_16
:

357 
READ_6
:

358 
READ_10
:

359 
READ_12
:

360 
READ_16
:

361 
cmd
->
com¶‘ed
 = 1;

362 
out_dÚe
;

365 
out
:

366 
	`TRACE_EXIT_RES
(
»s
);

367  
»s
;

369 
out_dÚe
:

370 
»s
 = 
SCST_EXEC_COMPLETED
;

371 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

372 
out
;

373 
	}
}

375 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

376 
MODULE_LICENSE
("GPL");

377 
MODULE_DESCRIPTION
("SCSI MO disk (type 7) dev handler for SCST");

378 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_modisk.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

50 cÚ¡ 
	g__moduË_d•’ds
[]

51 
__u£d


52 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

56 
MODULE_INFO
(
¤cv”siÚ
, "148B82F775FBD9CFCF9E431");

58 cÚ¡ 
rh–d©a
 
_rh–d©a
 
__u£d


59 
__©Œibu‹__
((
£ùiÚ
(".rheldata"))) = {

60 .
rh–_majÜ
 = 6,

61 .
	grh–_mšÜ
 = 4,

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_processor.c

22 
	~<scsi/scsi_ho¡.h
>

23 
	~<lšux/¦ab.h
>

25 
	#LOG_PREFIX
 "dev_´oûssÜ"

	)

27 #ifdeà
INSIDE_KERNEL_TREE


28 
	~<sc¡/sc¡.h
>

30 
	~"sc¡.h
"

32 
	~"sc¡_dev_hªdËr.h
"

34 
	#PROCESSOR_NAME
 "dev_´oûssÜ"

	)

36 
	#PROCESSOR_RETRIES
 2

	)

38 
´oûssÜ_©ch
(
sc¡_deviû
 *);

40 
´oûssÜ_·r£
(
sc¡_cmd
 *);

43 
sc¡_dev_ty³
 
	g´oûssÜ_devty³
 = {

44 .
Çme
 = 
PROCESSOR_NAME
,

45 .
	gty³
 = 
TYPE_PROCESSOR
,

46 .
	gth»ads_num
 = 1,

47 .
	g·r£_©omic
 = 1,

49 .
	g©ch
 = 
´oûssÜ_©ch
,

51 .
	g·r£
 = 
´oûssÜ_·r£
,

53 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

54 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

55 .
	gŒaû_æags
 = &
Œaû_æag
,

59 
	$´oûssÜ_©ch
(
sc¡_deviû
 *
dev
)

61 
»s
, 
rc
;

62 
»Œ›s
;

64 
	`TRACE_ENTRY
();

66 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

67 
dev
->
scsi_dev
->
ty³
 != dev->type) {

68 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

69 
»s
 = -
ENODEV
;

70 
out
;

77 ià(
dev
->
scsi_dev
->
sdev_¡©e
 =ð
SDEV_OFFLINE
) {

78 
	`TRACE_DBG
("%s", "Device is offline");

79 
»s
 = -
ENODEV
;

80 
out
;

83 
»Œ›s
 = 
SCST_DEV_UA_RETRIES
;

85 
	`TRACE_DBG
("%s", "Doing TEST_UNIT_READY");

86 
rc
 = 
	`scsi_‹¡_un™_»ady
(
dev
->
scsi_dev
,

87 
SCST_GENERIC_PROCESSOR_TIMEOUT
, 
PROCESSOR_RETRIES


88 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

91 , 
NULL
);

93 
	`TRACE_DBG
("TEST_UNIT_READY dÚe: %x", 
rc
);

94 } (--
»Œ›s
 > 0è&& 
rc
);

96 ià(
rc
) {

97 
	`PRINT_WARNING
("Un™‚Ù„—dy: %x", 
rc
);

101 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
);

102 ià(
»s
 != 0) {

103 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

104 "%s", 
dev
->
vœt_Çme
);

105 
out
;

108 
out
:

109 
	`TRACE_EXIT
();

110  
»s
;

111 
	}
}

114 
	$´oûssÜ_d‘ach
(
sc¡_deviû
 *
dev
)

116 
	`TRACE_ENTRY
();

118 
	`TRACE_EXIT
();

120 
	}
}

123 
	$´oûssÜ_·r£
(
sc¡_cmd
 *
cmd
)

125 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

127 
	`sc¡_´oûssÜ_g’”ic_·r£
(
cmd
, 
NULL
);

129 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

131  
»s
;

132 
	}
}

135 
	$´oûssÜ_dÚe
(
sc¡_cmd
 *
cmd
)

137 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

139 
	`TRACE_ENTRY
();

148 
cmd
->
cdb
[0]) {

155 
	`TRACE_EXIT
();

156  
»s
;

157 
	}
}

160 
__š™
 
	$´oûssÜ_š™
()

162 
»s
 = 0;

164 
	`TRACE_ENTRY
();

166 
´oûssÜ_devty³
.
moduË
 = 
THIS_MODULE
;

168 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
´oûssÜ_devty³
);

169 ià(
»s
 < 0)

170 
out
;

172 #ifdeà
CONFIG_SCST_PROC


173 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
´oûssÜ_devty³
);

174 ià(
»s
 != 0)

175 
out_”r
;

178 
out
:

179 
	`TRACE_EXIT_RES
(
»s
);

180  
»s
;

181 #ifdeà
CONFIG_SCST_PROC


182 
out_”r
:

183 
	`sc¡_uÄegi¡”_dev_driv”
(&
´oûssÜ_devty³
);

184 
out
;

186 
	}
}

188 
__ex™
 
	$´oûssÜ_ex™
()

190 
	`TRACE_ENTRY
();

191 #ifdeà
CONFIG_SCST_PROC


192 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
´oûssÜ_devty³
);

194 
	`sc¡_uÄegi¡”_dev_driv”
(&
´oûssÜ_devty³
);

195 
	`TRACE_EXIT
();

197 
	}
}

199 
moduË_š™
(
´oûssÜ_š™
);

200 
moduË_ex™
(
´oûssÜ_ex™
);

202 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

203 
MODULE_LICENSE
("GPL");

204 
MODULE_DESCRIPTION
("SCSI medium…rocessor (type 3) dev handler for SCST");

205 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_processor.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

41 cÚ¡ 
	g__moduË_d•’ds
[]

42 
__u£d


43 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

47 
MODULE_INFO
(
¤cv”siÚ
, "F0FA63446E6FFE3BFA1B655");

49 cÚ¡ 
rh–d©a
 
_rh–d©a
 
__u£d


50 
__©Œibu‹__
((
£ùiÚ
(".rheldata"))) = {

51 .
rh–_majÜ
 = 6,

52 .
	grh–_mšÜ
 = 4,

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_raid.c

22 
	#LOG_PREFIX
 "dev_¿id"

	)

24 
	~<scsi/scsi_ho¡.h
>

25 
	~<lšux/¦ab.h
>

27 #ifdeà
INSIDE_KERNEL_TREE


28 
	~<sc¡/sc¡.h
>

30 
	~"sc¡.h
"

32 
	~"sc¡_dev_hªdËr.h
"

34 
	#RAID_NAME
 "dev_¿id"

	)

36 
	#RAID_RETRIES
 2

	)

38 
¿id_©ch
(
sc¡_deviû
 *);

40 
¿id_·r£
(
sc¡_cmd
 *);

43 
sc¡_dev_ty³
 
	g¿id_devty³
 = {

44 .
Çme
 = 
RAID_NAME
,

45 .
	gty³
 = 
TYPE_RAID
,

46 .
	gth»ads_num
 = 1,

47 .
	g·r£_©omic
 = 1,

49 .
	g©ch
 = 
¿id_©ch
,

51 .
	g·r£
 = 
¿id_·r£
,

53 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

54 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

55 .
	gŒaû_æags
 = &
Œaû_æag
,

59 
	$¿id_©ch
(
sc¡_deviû
 *
dev
)

61 
»s
, 
rc
;

62 
»Œ›s
;

64 
	`TRACE_ENTRY
();

66 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

67 
dev
->
scsi_dev
->
ty³
 != dev->type) {

68 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

69 
»s
 = -
ENODEV
;

70 
out
;

77 ià(
dev
->
scsi_dev
->
sdev_¡©e
 =ð
SDEV_OFFLINE
) {

78 
	`TRACE_DBG
("%s", "Device is offline");

79 
»s
 = -
ENODEV
;

80 
out
;

83 
»Œ›s
 = 
SCST_DEV_UA_RETRIES
;

85 
	`TRACE_DBG
("%s", "Doing TEST_UNIT_READY");

86 
rc
 = 
	`scsi_‹¡_un™_»ady
(
dev
->
scsi_dev
,

87 
SCST_GENERIC_RAID_TIMEOUT
, 
RAID_RETRIES


88 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

91 , 
NULL
);

93 
	`TRACE_DBG
("TEST_UNIT_READY dÚe: %x", 
rc
);

94 } (--
»Œ›s
 > 0è&& 
rc
);

96 ià(
rc
) {

97 
	`PRINT_WARNING
("Un™‚Ù„—dy: %x", 
rc
);

101 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
);

102 ià(
»s
 != 0) {

103 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

104 "%s", 
dev
->
vœt_Çme
);

105 
out
;

108 
out
:

109 
	`TRACE_EXIT
();

110  
»s
;

111 
	}
}

114 
	$¿id_d‘ach
(
sc¡_deviû
 *
dev
)

116 
	`TRACE_ENTRY
();

118 
	`TRACE_EXIT
();

120 
	}
}

123 
	$¿id_·r£
(
sc¡_cmd
 *
cmd
)

125 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

127 
	`sc¡_¿id_g’”ic_·r£
(
cmd
, 
NULL
);

129 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

131  
»s
;

132 
	}
}

135 
	$¿id_dÚe
(
sc¡_cmd
 *
cmd
)

137 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

139 
	`TRACE_ENTRY
();

148 
cmd
->
cdb
[0]) {

155 
	`TRACE_EXIT
();

156  
»s
;

157 
	}
}

160 
__š™
 
	$¿id_š™
()

162 
»s
 = 0;

164 
	`TRACE_ENTRY
();

166 
¿id_devty³
.
moduË
 = 
THIS_MODULE
;

168 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
¿id_devty³
);

169 ià(
»s
 < 0)

170 
out
;

172 #ifdeà
CONFIG_SCST_PROC


173 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
¿id_devty³
);

174 ià(
»s
 != 0)

175 
out_”r
;

178 
out
:

179 
	`TRACE_EXIT_RES
(
»s
);

180  
»s
;

182 #ifdeà
CONFIG_SCST_PROC


183 
out_”r
:

184 
	`sc¡_uÄegi¡”_dev_driv”
(&
¿id_devty³
);

185 
out
;

187 
	}
}

189 
__ex™
 
	$¿id_ex™
()

191 
	`TRACE_ENTRY
();

192 #ifdeà
CONFIG_SCST_PROC


193 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
¿id_devty³
);

195 
	`sc¡_uÄegi¡”_dev_driv”
(&
¿id_devty³
);

196 
	`TRACE_EXIT
();

198 
	}
}

200 
moduË_š™
(
¿id_š™
);

201 
moduË_ex™
(
¿id_ex™
);

203 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

204 
MODULE_LICENSE
("GPL");

205 
MODULE_DESCRIPTION
("SCSI„aid(controller) (type 0xC) dev handler for SCST");

206 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_raid.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

41 cÚ¡ 
	g__moduË_d•’ds
[]

42 
__u£d


43 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

47 
MODULE_INFO
(
¤cv”siÚ
, "B3377851795C8C386C2E8EE");

49 cÚ¡ 
rh–d©a
 
_rh–d©a
 
__u£d


50 
__©Œibu‹__
((
£ùiÚ
(".rheldata"))) = {

51 .
rh–_majÜ
 = 6,

52 .
	grh–_mšÜ
 = 4,

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_tape.c

25 
	~<lšux/moduË.h
>

26 
	~<lšux/š™.h
>

27 
	~<scsi/scsi_ho¡.h
>

28 
	~<lšux/¦ab.h
>

30 
	#LOG_PREFIX
 "dev_³"

	)

32 #ifdeà
INSIDE_KERNEL_TREE


33 
	~<sc¡/sc¡.h
>

35 
	~"sc¡.h
"

37 
	~"sc¡_dev_hªdËr.h
"

39 
	#TAPE_NAME
 "dev_³"

	)

40 
	#TAPE_PERF_NAME
 "dev_³_³rf"

	)

42 
	#TAPE_RETRIES
 2

	)

44 
	#TAPE_DEF_BLOCK_SIZE
 512

	)

47 
	#SILI_BIT
 2

	)

49 
	s³_·¿ms
 {

50 
	mblock_size
;

53 
³_©ch
(
sc¡_deviû
 *);

54 
³_d‘ach
(
sc¡_deviû
 *);

55 
³_·r£
(
sc¡_cmd
 *);

56 
³_dÚe
(
sc¡_cmd
 *);

57 
³_³rf_exec
(
sc¡_cmd
 *);

59 
sc¡_dev_ty³
 
	g³_devty³
 = {

60 .
Çme
 = 
TAPE_NAME
,

61 .
	gty³
 = 
TYPE_TAPE
,

62 .
	gth»ads_num
 = 1,

63 .
	g·r£_©omic
 = 1,

64 .
	gdev_dÚe_©omic
 = 1,

65 .
	g©ch
 = 
³_©ch
,

66 .
	gd‘ach
 = 
³_d‘ach
,

67 .
	g·r£
 = 
³_·r£
,

68 .
	gdev_dÚe
 = 
³_dÚe
,

69 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

70 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

71 .
	gŒaû_æags
 = &
Œaû_æag
,

75 
sc¡_dev_ty³
 
	g³_devty³_³rf
 = {

76 .
Çme
 = 
TAPE_PERF_NAME
,

77 .
	gty³
 = 
TYPE_TAPE
,

78 .
	g·r£_©omic
 = 1,

79 .
	gdev_dÚe_©omic
 = 1,

80 .
	g©ch
 = 
³_©ch
,

81 .
	gd‘ach
 = 
³_d‘ach
,

82 .
	g·r£
 = 
³_·r£
,

83 .
	gdev_dÚe
 = 
³_dÚe
,

84 .
	gexec
 = 
³_³rf_exec
,

85 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

86 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

87 .
	gŒaû_æags
 = &
Œaû_æag
,

91 
__š™
 
	$š™_sc¡_³_driv”
()

93 
»s
 = 0;

95 
	`TRACE_ENTRY
();

97 
³_devty³
.
moduË
 = 
THIS_MODULE
;

99 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
³_devty³
);

100 ià(
»s
 < 0)

101 
out
;

103 
³_devty³_³rf
.
moduË
 = 
THIS_MODULE
;

105 
»s
 = 
	`sc¡_»gi¡”_dev_driv”
(&
³_devty³_³rf
);

106 ià(
»s
 < 0)

107 
out_uÄeg
;

109 #ifdeà
CONFIG_SCST_PROC


110 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
³_devty³
);

111 ià(
»s
 != 0)

112 
out_uÄeg1
;

114 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
³_devty³_³rf
);

115 ià(
»s
 != 0)

116 
out_uÄeg2
;

119 
out
:

120 
	`TRACE_EXIT_RES
(
»s
);

121  
»s
;

123 #ifdeà
CONFIG_SCST_PROC


124 
out_uÄeg2
:

125 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
³_devty³
);

127 
out_uÄeg1
:

128 
	`sc¡_uÄegi¡”_dev_driv”
(&
³_devty³_³rf
);

131 
out_uÄeg
:

132 
	`sc¡_uÄegi¡”_dev_driv”
(&
³_devty³
);

133 
out
;

134 
	}
}

136 
__ex™
 
	$ex™_sc¡_³_driv”
()

138 
	`TRACE_ENTRY
();

140 #ifdeà
CONFIG_SCST_PROC


141 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
³_devty³_³rf
);

142 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
³_devty³
);

144 
	`sc¡_uÄegi¡”_dev_driv”
(&
³_devty³_³rf
);

145 
	`sc¡_uÄegi¡”_dev_driv”
(&
³_devty³
);

147 
	`TRACE_EXIT
();

149 
	}
}

151 
moduË_š™
(
š™_sc¡_³_driv”
);

152 
moduË_ex™
(
ex™_sc¡_³_driv”
);

154 
	$³_©ch
(
sc¡_deviû
 *
dev
)

156 
»s
, 
rc
;

157 
»Œ›s
;

158 
scsi_mode_d©a
 
d©a
;

159 cÚ¡ 
bufãr_size
 = 512;

160 
ušt8_t
 *
bufãr
 = 
NULL
;

161 
³_·¿ms
 *
·¿ms
;

163 
	`TRACE_ENTRY
();

165 ià(
dev
->
scsi_dev
 =ð
NULL
 ||

166 
dev
->
scsi_dev
->
ty³
 != dev->type) {

167 
	`PRINT_ERROR
("%s", "SCSI device‚ot define or illegalype");

168 
»s
 = -
ENODEV
;

169 
out
;

172 
·¿ms
 = 
	`kz®loc
((*·¿ms), 
GFP_KERNEL
);

173 ià(
·¿ms
 =ð
NULL
) {

174 
	`PRINT_ERROR
("Unableo‡llocate structape_params (size %zd)",

175 (*
·¿ms
));

176 
»s
 = -
ENOMEM
;

177 
out
;

180 
·¿ms
->
block_size
 = 
TAPE_DEF_BLOCK_SIZE
;

182 
bufãr
 = 
	`km®loc
(
bufãr_size
, 
GFP_KERNEL
);

183 ià(!
bufãr
) {

184 
	`PRINT_ERROR
("Buffer memory‡llocation (size %d) failure",

185 
bufãr_size
);

186 
»s
 = -
ENOMEM
;

187 
out_ä“_»q
;

190 
»Œ›s
 = 
SCST_DEV_UA_RETRIES
;

192 
	`TRACE_DBG
("%s", "Doing TEST_UNIT_READY");

193 
rc
 = 
	`scsi_‹¡_un™_»ady
(
dev
->
scsi_dev
,

194 
SCST_GENERIC_TAPE_SMALL_TIMEOUT
, 
TAPE_RETRIES


195 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

198 , 
NULL
);

200 
	`TRACE_DBG
("TEST_UNIT_READY dÚe: %x", 
rc
);

201 } (--
»Œ›s
 > 0è&& 
rc
);

203 ià(
rc
) {

204 
	`PRINT_WARNING
("Un™‚Ù„—dy: %x", 
rc
);

206 
obš
;

209 
	`TRACE_DBG
("%s", "Doing MODE_SENSE");

210 
rc
 = 
	`scsi_mode_£n£
(
dev
->
scsi_dev
,

211 ((
dev
->
scsi_dev
->
scsi_Ëv–
 <ð
SCSI_2
) ?

212 ((
dev
->
scsi_dev
->
lun
 << 5) & 0xe0) : 0),

214 
bufãr
, 
bufãr_size
,

215 
SCST_GENERIC_TAPE_SMALL_TIMEOUT
, 
TAPE_RETRIES
,

216 &
d©a
, 
NULL
);

217 
	`TRACE_DBG
("MODE_SENSE dÚe: %x", 
rc
);

219 ià(
rc
 == 0) {

220 
medium_ty³
, 
mode
, 
¥“d
, 
d’s™y
;

221 ià(
bufãr
[3] == 8) {

222 
·¿ms
->
block_size
 = ((
bufãr
[9] << 16) |

223 (
bufãr
[10] << 8) |

224 (
bufãr
[11] << 0));

226 
·¿ms
->
block_size
 = 
TAPE_DEF_BLOCK_SIZE
;

227 
medium_ty³
 = 
bufãr
[1];

228 
mode
 = (
bufãr
[2] & 0x70) >> 4;

229 
¥“d
 = 
bufãr
[2] & 0x0f;

230 
d’s™y
 = 
bufãr
[4];

231 
	`TRACE_DBG
("Tape:†un %d. bs %d.ype 0x%02x mode 0x%02x "

232 "¥“d 0x%02x d’ 0x%02x", 
dev
->
scsi_dev
->
lun
,

233 
·¿ms
->
block_size
, 
medium_ty³
, 
mode
, 
¥“d
, 
d’s™y
);

235 
	`PRINT_ERROR
("MODE_SENSE fažed: %x", 
rc
);

236 
»s
 = -
ENODEV
;

237 
out_ä“_buf
;

240 
obš
:

241 
»s
 = 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
);

242 ià(
»s
 != 0) {

243 
	`PRINT_ERROR
("Failedo obtain control…arameters for device "

244 "%s", 
dev
->
vœt_Çme
);

245 
out_ä“_buf
;

248 
out_ä“_buf
:

249 
	`kä“
(
bufãr
);

251 
out_ä“_»q
:

252 ià(
»s
 == 0)

253 
dev
->
dh_´iv
 = 
·¿ms
;

255 
	`kä“
(
·¿ms
);

257 
out
:

258 
	`TRACE_EXIT_RES
(
»s
);

259  
»s
;

260 
	}
}

262 
	$³_d‘ach
(
sc¡_deviû
 *
dev
)

264 
³_·¿ms
 *
·¿ms
 =

265 (
³_·¿ms
 *)
dev
->
dh_´iv
;

267 
	`TRACE_ENTRY
();

269 
	`kä“
(
·¿ms
);

270 
dev
->
dh_´iv
 = 
NULL
;

272 
	`TRACE_EXIT
();

274 
	}
}

276 
	$³_g‘_block_size
(
sc¡_cmd
 *
cmd
)

278 
³_·¿ms
 *
·¿ms
 = (³_·¿m *)
cmd
->
dev
->
dh_´iv
;

283  
·¿ms
->
block_size
;

284 
	}
}

286 
	$³_·r£
(
sc¡_cmd
 *
cmd
)

288 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

290 
	`sc¡_³_g’”ic_·r£
(
cmd
, 
³_g‘_block_size
);

292 
cmd
->
»Œ›s
 = 
SCST_PASSTHROUGH_RETRIES
;

294  
»s
;

295 
	}
}

297 
	$³_£t_block_size
(
sc¡_cmd
 *
cmd
, 
block_size
)

299 
³_·¿ms
 *
·¿ms
 = (³_·¿m *)
cmd
->
dev
->
dh_´iv
;

304 
·¿ms
->
block_size
 = block_size;

306 
	}
}

308 
	$³_dÚe
(
sc¡_cmd
 *
cmd
)

310 
Ýcode
 = 
cmd
->
cdb
[0];

311 
¡©us
 = 
cmd
->status;

312 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

314 
	`TRACE_ENTRY
();

316 ià((
¡©us
 =ð
SAM_STAT_GOOD
è|| (¡©u =ð
SAM_STAT_CONDITION_MET
))

317 
»s
 = 
	`sc¡_³_g’”ic_dev_dÚe
(
cmd
, 
³_£t_block_size
);

318 ià((
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

319 
	`SCST_SENSE_VALID
(
cmd
->
£n£
)) {

320 
³_·¿ms
 *
·¿ms
;

322 
	`TRACE_DBG
("Ex‹nded s’£ %x", 
cmd
->
£n£
[0] & 0x7F);

324 ià((
cmd
->
£n£
[0] & 0x7F) != 0x70) {

325 
	`PRINT_ERROR
("Sense format 0x%x is‚ot supported",

326 
cmd
->
£n£
[0] & 0x7F);

327 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

328 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

329 
out
;

332 ià(
Ýcode
 =ð
READ_6
 && !(
cmd
->
cdb
[1] & 
SILI_BIT
) &&

333 (
cmd
->
£n£
[2] & 0xe0)) {

335 
T¿nsãrL’gth
, 
Residue
 = 0;

336 ià((
cmd
->
£n£
[2] & 0x0fè=ð
BLANK_CHECK
)

338 
cmd
->
£n£
[2] &= 0xcf;

339 
T¿nsãrL’gth
 = ((
cmd
->
cdb
[2] << 16) |

340 (
cmd
->
cdb
[3] << 8) | cmd->cdb[4]);

342 ià((
cmd
->
£n£
[0] & 0x80) != 0) {

343 
Residue
 = ((
cmd
->
£n£
[3] << 24) |

344 (
cmd
->
£n£
[4] << 16) |

345 (
cmd
->
£n£
[5] << 8) |

346 
cmd
->
£n£
[6]);

348 
	`TRACE_DBG
("Checkinghe sense key "

350 " %d/%d", ()
cmd
->
£n£
[2], cmd->
cdb
[0],

351 
cmd
->
cdb
[1], 
T¿nsãrL’gth
, 
Residue
);

352 ià(
T¿nsãrL’gth
 > 
Residue
) {

353 
»¥_d©a_Ën
 = 
T¿nsãrL’gth
 - 
Residue
;

354 ià(
cmd
->
cdb
[1] & 
SCST_TRANSFER_LEN_TYPE_FIXED
) {

360 
·¿ms
 = (
³_·¿ms
 *)

361 
cmd
->
dev
->
dh_´iv
;

362 
»¥_d©a_Ën
 *ð
·¿ms
->
block_size
;

364 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
»¥_d©a_Ën
);

369 
out
:

370 
	`TRACE_DBG
("cmd->is_send_status=%x, cmd->resp_data_len=%d, "

371 "»s=%d", 
cmd
->
is_£nd_¡©us
, cmd->
»¥_d©a_Ën
, 
»s
);

373 
	`TRACE_EXIT_RES
(
»s
);

374  
»s
;

375 
	}
}

377 
	$³_³rf_exec
(
sc¡_cmd
 *
cmd
)

379 
»s
 = 
SCST_EXEC_NOT_COMPLETED
, 
rc
;

380 
Ýcode
 = 
cmd
->
cdb
[0];

382 
	`TRACE_ENTRY
();

384 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

385 ià(
	`uÆik–y
(
rc
 != 0))

386 
out_dÚe
;

388 
cmd
->
¡©us
 = 0;

389 
cmd
->
msg_¡©us
 = 0;

390 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

391 
cmd
->
driv”_¡©us
 = 0;

393 
Ýcode
) {

394 
WRITE_6
:

395 
READ_6
:

396 
cmd
->
com¶‘ed
 = 1;

397 
out_dÚe
;

400 
out
:

401 
	`TRACE_EXIT_RES
(
»s
);

402  
»s
;

404 
out_dÚe
:

405 
»s
 = 
SCST_EXEC_COMPLETED
;

406 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

407 
out
;

408 
	}
}

410 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

411 
MODULE_LICENSE
("GPL");

412 
MODULE_DESCRIPTION
("SCSIape (type 1) dev handler for SCST");

413 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_tape.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

49 cÚ¡ 
	g__moduË_d•’ds
[]

50 
__u£d


51 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

55 
MODULE_INFO
(
¤cv”siÚ
, "E6BEC223C9CA1BA36FE1881");

57 cÚ¡ 
rh–d©a
 
_rh–d©a
 
__u£d


58 
__©Œibu‹__
((
£ùiÚ
(".rheldata"))) = {

59 .
rh–_majÜ
 = 6,

60 .
	grh–_mšÜ
 = 4,

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_user.c

21 
	~<lšux/kth»ad.h
>

22 
	~<lšux/d–ay.h
>

23 
	~<lšux/pÞl.h
>

24 
	~<lšux/¡ddef.h
>

25 
	~<lšux/¦ab.h
>

27 
	#LOG_PREFIX
 
DEV_USER_NAME


	)

29 #ifdeà
INSIDE_KERNEL_TREE


30 
	~<sc¡/sc¡.h
>

31 
	~<sc¡/sc¡_u£r.h
>

33 
	~"sc¡.h
"

34 
	~"sc¡_u£r.h
"

36 
	~"sc¡_dev_hªdËr.h
"

38 #iâdeà
INSIDE_KERNEL_TREE


39 #ià
defšed
(
CONFIG_HIGHMEM4G
è|| defšed(
CONFIG_HIGHMEM64G
)

40 #w¬nšg 
HIGHMEM
 
k”Ãl
 
cÚfigu¿tiÚs
 
¬e
 
nÙ
 
suµÜ‹d
 
by
 
this
 
moduË
,\

41 
beÿu£
 
nowadays
 
™
 
is
 
nÙ
 
wÜth
 
the
 
	geffÜt
. 
CÚsid”
 
	gchªgšg
\

42 
VMSPLIT
 
ÝtiÚ
 
Ü
 
u£
 
	ga
 64-
b™
 
cÚfigu¿tiÚ
 
	gš¡—d
. 
S“
 
README
 
	gfže
\

43 
	gd‘ažs
.

47 
	#DEV_USER_CMD_HASH_ORDER
 6

	)

48 
	#DEV_USER_ATTACH_TIMEOUT
 (5*
HZ
)

	)

50 
	ssc¡_u£r_dev
 {

51 
rw_£m­hÜe
 
	mdev_rw£m
;

57 
sc¡_cmd_th»ads
 
	mudev_cmd_th»ads
;

60 
li¡_h—d
 
	m»ady_cmd_li¡
;

63 
	mblockšg
:1;

64 
	mþ—nup_dÚe
:1;

65 
	mt¡
:3;

66 
	mqueue_®g
:4;

67 
	ms
:1;

68 
	mswp
:1;

69 
	md_£n£
:1;

70 
	mhas_own_Üd”_mgmt
:1;

72 (*
	mg’”ic_·r£
)(
sc¡_cmd
 *
	mcmd
,

73 (*
	mg‘_block
)(
sc¡_cmd
 *
	mcmd
));

75 
	mblock
;

76 
	mdef_block
;

78 
sc¡_mem_lim
 
	mudev_mem_lim
;

79 
sgv_poÞ
 *
	mpoÞ
;

80 
sgv_poÞ
 *
	mpoÞ_þu¡
;

82 
ušt8_t
 
	m·r£_ty³
;

83 
ušt8_t
 
	mÚ_ä“_cmd_ty³
;

84 
ušt8_t
 
	mmemÜy_»u£_ty³
;

85 
ušt8_t
 
	m·¹Ÿl_Œªsãrs_ty³
;

86 
ušt32_t
 
	m·¹Ÿl_Ën
;

88 
sc¡_dev_ty³
 
	mdevty³
;

91 
	mhªdË_couÁ”
;

92 
li¡_h—d
 
	mucmd_hash
[1 << 
DEV_USER_CMD_HASH_ORDER
];

94 
sc¡_deviû
 *
	msdev
;

96 
	mvœt_id
;

97 
li¡_h—d
 
	mdev_li¡_’Œy
;

98 
	mÇme
[
SCST_MAX_NAME
];

100 
li¡_h—d
 
	mþ—nup_li¡_’Œy
;

101 
com¶‘iÚ
 
	mþ—nup_cm¶
;

105 
	ssc¡_u£r_cmd
 {

106 
sc¡_cmd
 *
	mcmd
;

107 
sc¡_u£r_dev
 *
	mdev
;

109 
©omic_t
 
	mucmd_»f
;

111 
	mbuff_ÿched
:1;

112 
	mbuf_dœty
:1;

113 
	mbackground_exec
:1;

114 
	mabÜ‹d
:1;

116 
sc¡_u£r_cmd
 *
	mbuf_ucmd
;

118 
	mcur_d©a_·ge
;

119 
	mnum_d©a_·ges
;

120 
	mfœ¡_·ge_off£t
;

121 
	mubuff
;

122 
·ge
 **
	md©a_·ges
;

123 
sgv_poÞ_obj
 *
	msgv
;

129 
	m£Á_to_u£r
:1;

130 
	mjammed
:1;

131 
	mthis_¡©e_unjammed
:1;

132 
	m£’_by_u£r
:1;

134 
	m¡©e
;

136 
li¡_h—d
 
	m»ady_cmd_li¡_’Œy
;

138 
	mh
;

139 
li¡_h—d
 
	mhash_li¡_’Œy
;

141 
	mu£r_cmd_·ylßd_Ën
;

142 
sc¡_u£r_g‘_cmd
 
	mu£r_cmd
;

146 
com¶‘iÚ
 *
	mcm¶
;

147 
sc¡_mgmt_cmd
 *
	mmcmd
;

149 
	m»suÉ
;

152 
sc¡_u£r_cmd
 *
dev_u£r_®loc_ucmd
(
sc¡_u£r_dev
 *
dev
,

153 
gå_t
 
gå_mask
);

154 
dev_u£r_ä“_ucmd
(
sc¡_u£r_cmd
 *
ucmd
);

156 
dev_u£r_·r£
(
sc¡_cmd
 *
cmd
);

157 
dev_u£r_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
);

158 
dev_u£r_exec
(
sc¡_cmd
 *
cmd
);

159 
dev_u£r_Ú_ä“_cmd
(
sc¡_cmd
 *
cmd
);

160 
dev_u£r_sk_mgmt_â
(
sc¡_mgmt_cmd
 *
mcmd
,

161 
sc¡_tgt_dev
 *
tgt_dev
);

163 
dev_u£r_disk_dÚe
(
sc¡_cmd
 *
cmd
);

164 
dev_u£r_³_dÚe
(
sc¡_cmd
 *
cmd
);

166 
·ge
 *
dev_u£r_®loc_·ges
(
sÿ‰”li¡
 *
sg
,

167 
gå_t
 
gå_mask
, *
´iv
);

168 
dev_u£r_ä“_sg_’Œ›s
(
sÿ‰”li¡
 *
sg
, 
sg_couÁ
,

169 *
´iv
);

171 
dev_u£r_add_to_»ady
(
sc¡_u£r_cmd
 *
ucmd
);

173 
dev_u£r_unjam_cmd
(
sc¡_u£r_cmd
 *
ucmd
, 
busy
,

174 *
æags
);

176 
dev_u£r_´oûss_»¶y_Ú_ä“
(
sc¡_u£r_cmd
 *
ucmd
);

177 
dev_u£r_´oûss_»¶y_tm_exec
(
sc¡_u£r_cmd
 *
ucmd
,

178 
¡©us
);

179 
dev_u£r_´oûss_»¶y_£ss
(
sc¡_u£r_cmd
 *
ucmd
, 
¡©us
);

180 
dev_u£r_»gi¡”_dev
(
fže
 *file,

181 cÚ¡ 
sc¡_u£r_dev_desc
 *
dev_desc
);

182 
dev_u£r_uÄegi¡”_dev
(
fže
 *file);

183 
dev_u£r_æush_ÿche
(
fže
 *file);

184 
dev_u£r_ÿ·c™y_chªged
(
fže
 *file);

185 
dev_u£r_´—Îoc_bufãr
(
fže
 *fže, 
__u£r
 *
¬g
);

186 
__dev_u£r_£t_Ýt
(
sc¡_u£r_dev
 *
dev
,

187 cÚ¡ 
sc¡_u£r_Ýt
 *
Ýt
);

188 
dev_u£r_£t_Ýt
(
fže
 *fže, cÚ¡ 
sc¡_u£r_Ýt
 *
Ýt
);

189 
dev_u£r_g‘_Ýt
(
fže
 *fže, 
__u£r
 *
¬g
);

191 
dev_u£r_pÞl
(
fže
 *
fžp
, 
pÞl_bË
 *
wa™
);

192 
dev_u£r_ioùl
(
fže
 *fže, 
cmd
,

193 
¬g
);

194 
dev_u£r_»Ëa£
(
šode
 *šode, 
fže
 *file);

195 
dev_u£r_ex™_dev
(
sc¡_u£r_dev
 *
dev
);

197 #ifdeà
CONFIG_SCST_PROC


199 
dev_u£r_»ad_´oc
(
£q_fže
 *
£q
,

200 
sc¡_dev_ty³
 *
dev_ty³
);

204 
ssize_t
 
dev_u£r_sysfs_commªds_show
(
kobjeù
 *
kobj
,

205 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

207 
kobj_©Œibu‹
 
	gdev_u£r_commªds_©Œ
 =

208 
__ATTR
(
commªds
, 
S_IRUGO
, 
dev_u£r_sysfs_commªds_show
, 
NULL
);

210 cÚ¡ 
©Œibu‹
 *
	gdev_u£r_dev_©Œs
[] = {

211 &
dev_u£r_commªds_©Œ
.
©Œ
,

212 
NULL
,

217 
dev_u¤_·r£
(
sc¡_cmd
 *
cmd
);

221 
kmem_ÿche
 *
	gu£r_cmd_ÿch•
;

222 
kmem_ÿche
 *
	gu£r_g‘_cmd_ÿch•
;

224 
DEFINE_MUTEX
(
dev_´iv_mu‹x
);

226 cÚ¡ 
fže_Ý”©iÚs
 
	gdev_u£r_fÝs
 = {

227 .
pÞl
 = 
dev_u£r_pÞl
,

228 .
	guÆocked_ioùl
 = 
dev_u£r_ioùl
,

229 #ifdeà
CONFIG_COMPAT


230 .
	gcom·t_ioùl
 = 
dev_u£r_ioùl
,

232 .
	g»Ëa£
 = 
dev_u£r_»Ëa£
,

235 
sc¡_dev_ty³
 
	gdev_u£r_devty³
 = {

236 .
Çme
 = 
DEV_USER_NAME
,

237 .
	gty³
 = -1,

238 .
	g·r£
 = 
dev_u¤_·r£
,

239 #ifdeà
CONFIG_SCST_PROC


240 .
	g»ad_´oc
 = 
dev_u£r_»ad_´oc
,

242 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

243 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

244 .
	gŒaû_æags
 = &
Œaû_æag
,

248 
	gdev_u£r_majÜ
;

250 
þass
 *
	gdev_u£r_sysfs_þass
;

252 
DEFINE_SPINLOCK
(
dev_li¡_lock
);

253 
LIST_HEAD
(
dev_li¡
);

255 
DEFINE_SPINLOCK
(
þ—nup_lock
);

256 
LIST_HEAD
(
þ—nup_li¡
);

257 
DECLARE_WAIT_QUEUE_HEAD
(
þ—nup_li¡_wa™Q
);

258 
sk_¡ruù
 *
	gþ—nup_th»ad
;

264 
šlše
 
boÞ
 
	$ucmd_g‘_check
(
sc¡_u£r_cmd
 *
ucmd
)

266 
r
 = 
	`©omic_šc_»tuº
(&
ucmd
->
ucmd_»f
);

267 
»s
;

268 ià(
	`uÆik–y
(
r
 == 1)) {

269 
	`TRACE_DBG
("ucmd %°i bešg de¡royed", 
ucmd
);

270 
	`©omic_dec
(&
ucmd
->
ucmd_»f
);

271 
»s
 = 
Œue
;

277 
	`TRACE_DBG
("ucmd %p,‚ew„ef_úˆ%d", 
ucmd
,

278 
	`©omic_»ad
(&
ucmd
->
ucmd_»f
));

279 
»s
 = 
çl£
;

281  
»s
;

282 
	}
}

284 
šlše
 
	$ucmd_g‘
(
sc¡_u£r_cmd
 *
ucmd
)

286 
	`TRACE_DBG
("ucmd %p, ucmd_»à%d", 
ucmd
, 
	`©omic_»ad
(&ucmd->
ucmd_»f
));

287 
	`©omic_šc
(&
ucmd
->
ucmd_»f
);

292 
	`smp_mb__aá”_©omic_šc
();

293 
	}
}

296 
šlše
 
	$ucmd_put
(
sc¡_u£r_cmd
 *
ucmd
)

298 
	`TRACE_DBG
("ucmd %p, ucmd_»à%d", 
ucmd
, 
	`©omic_»ad
(&ucmd->
ucmd_»f
));

300 
	`EXTRACHECKS_BUG_ON
(
	`©omic_»ad
(&
ucmd
->
ucmd_»f
) == 0);

302 ià(
	`©omic_dec_ªd_‹¡
(&
ucmd
->
ucmd_»f
))

303 
	`dev_u£r_ä“_ucmd
(
ucmd
);

304 
	}
}

306 
šlše
 
	$ÿlc_num_pg
(
buf
, 
Ën
)

308 
Ën
 +ð
buf
 & ~
PAGE_MASK
;

309  (
Ën
 >> 
PAGE_SHIFT
è+ (Ö’ & ~
PAGE_MASK
) != 0);

310 
	}
}

312 
	$__dev_u£r_nÙ_»g
()

314 
	`TRACE_MGMT_DBG
("%s", "Device‚ot„egistered");

316 
	}
}

318 
šlše
 
	$dev_u£r_check_»g
(
sc¡_u£r_dev
 *
dev
)

320 ià(
dev
 =ð
NULL
) {

321 
	`__dev_u£r_nÙ_»g
();

322  -
ENODEV
;

325 
	}
}

327 
šlše
 
	$sc¡_u£r_cmd_hashâ
(
h
)

329  
h
 & ((1 << 
DEV_USER_CMD_HASH_ORDER
) - 1);

330 
	}
}

332 
šlše
 
sc¡_u£r_cmd
 *
	$__ucmd_fšd_hash
(
sc¡_u£r_dev
 *
dev
,

333 
h
)

335 
li¡_h—d
 *
h—d
;

336 
sc¡_u£r_cmd
 *
ucmd
;

338 
h—d
 = &
dev
->
ucmd_hash
[
	`sc¡_u£r_cmd_hashâ
(
h
)];

339 
	`li¡_fÜ_—ch_’Œy
(
ucmd
, 
h—d
, 
hash_li¡_’Œy
) {

340 ià(
ucmd
->
h
 == h) {

341 
	`TRACE_DBG
("Found ucmd %p", 
ucmd
);

342  
ucmd
;

345  
NULL
;

346 
	}
}

348 
	$cmd_š£¹_hash
(
sc¡_u£r_cmd
 *
ucmd
)

350 
li¡_h—d
 *
h—d
;

351 
sc¡_u£r_dev
 *
dev
 = 
ucmd
->dev;

352 
sc¡_u£r_cmd
 *
u
;

353 
æags
;

355 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

357 
ucmd
->
h
 = 
dev
->
hªdË_couÁ”
++;

358 
u
 = 
	`__ucmd_fšd_hash
(
dev
, 
ucmd
->
h
);

359 } 
u
 !ð
NULL
);

360 
h—d
 = &
dev
->
ucmd_hash
[
	`sc¡_u£r_cmd_hashâ
(
ucmd
->
h
)];

361 
	`li¡_add_ž
(&
ucmd
->
hash_li¡_’Œy
, 
h—d
);

362 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

364 
	`TRACE_DBG
("In£¹ed ucmd %p, h=%d (dev %s)", 
ucmd
, ucmd->
h
, 
dev
->
Çme
);

366 
	}
}

368 
šlše
 
	$cmd_»move_hash
(
sc¡_u£r_cmd
 *
ucmd
)

370 
æags
;

372 
	`¥š_lock_œq§ve
(&
ucmd
->
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

373 
	`li¡_d–
(&
ucmd
->
hash_li¡_’Œy
);

374 
	`¥š_uÆock_œq»¡Üe
(&
ucmd
->
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

376 
	`TRACE_DBG
("Removed ucmd %p, h=%d", 
ucmd
, ucmd->
h
);

378 
	}
}

380 
	$dev_u£r_ä“_ucmd
(
sc¡_u£r_cmd
 *
ucmd
)

382 
	`TRACE_ENTRY
();

384 
	`TRACE_MEM
("F»ešg ucmd %p", 
ucmd
);

386 
	`cmd_»move_hash
(
ucmd
);

387 
	`EXTRACHECKS_BUG_ON
(
ucmd
->
cmd
 !ð
NULL
);

389 
	`kmem_ÿche_ä“
(
u£r_cmd_ÿch•
, 
ucmd
);

391 
	`TRACE_EXIT
();

393 
	}
}

395 
·ge
 *
	$dev_u£r_®loc_·ges
(
sÿ‰”li¡
 *
sg
,

396 
gå_t
 
gå_mask
, *
´iv
)

398 
sc¡_u£r_cmd
 *
ucmd
 = 
´iv
;

399 
off£t
 = 0;

401 
	`TRACE_ENTRY
();

405 
	`TRACE_MEM
("ucmd %p, ubufà%lx, ucmd->cur_d©a_·g%d", 
ucmd
,

406 
ucmd
->
ubuff
, ucmd->
cur_d©a_·ge
);

408 ià(
ucmd
->
cur_d©a_·ge
 == 0) {

409 
	`TRACE_MEM
("ucmd->first_page_offset %d",

410 
ucmd
->
fœ¡_·ge_off£t
);

411 
off£t
 = 
ucmd
->
fœ¡_·ge_off£t
;

412 
	`ucmd_g‘
(
ucmd
);

415 ià(
ucmd
->
cur_d©a_·ge
 >ðucmd->
num_d©a_·ges
)

416 
out
;

418 
	`sg_£t_·ge
(
sg
, 
ucmd
->
d©a_·ges
[ucmd->
cur_d©a_·ge
],

419 
PAGE_SIZE
 - 
off£t
, offset);

420 
ucmd
->
cur_d©a_·ge
++;

422 
	`TRACE_MEM
("·ge=%p,†’gth=%d, off£t=%d", 
	`sg_·ge
(
sg
), sg->
Ëngth
,

423 
sg
->
off£t
);

424 
	`TRACE_BUFFER
("Pagd©a", 
	`sg_vœt
(
sg
), sg->
Ëngth
);

426 
out
:

427 
	`TRACE_EXIT
();

428  
	`sg_·ge
(
sg
);

429 
	}
}

431 
	$dev_u£r_Ú_ÿched_mem_ä“
(
sc¡_u£r_cmd
 *
ucmd
)

433 
	`TRACE_ENTRY
();

435 
	`TRACE_MEM
("Preparing ON_CACHED_MEM_FREE (ucmd %p, h %d, ubuff %lx)",

436 
ucmd
, ucmd->
h
, ucmd->
ubuff
);

438 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

439 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
Ú_ÿched_mem_ä“
) +

440 (
ucmd
->
u£r_cmd
.
Ú_ÿched_mem_ä“
);

441 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

442 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_ON_CACHED_MEM_FREE
;

443 
ucmd
->
u£r_cmd
.
Ú_ÿched_mem_ä“
.
pbuf
 = ucmd->
ubuff
;

445 
ucmd
->
¡©e
 = 
UCMD_STATE_ON_CACHE_FREEING
;

447 
	`dev_u£r_add_to_»ady
(
ucmd
);

449 
	`TRACE_EXIT
();

451 
	}
}

453 
	$dev_u£r_unm­_buf
(
sc¡_u£r_cmd
 *
ucmd
)

455 
i
;

457 
	`TRACE_ENTRY
();

459 
	`TRACE_MEM
("Unm­pšg d©¨·ge (ucmd %p, ubufà%lx,‚um %d)", 
ucmd
,

460 
ucmd
->
ubuff
, ucmd->
num_d©a_·ges
);

462 
i
 = 0; i < 
ucmd
->
num_d©a_·ges
; i++) {

463 
·ge
 *·gð
ucmd
->
d©a_·ges
[
i
];

465 ià(
ucmd
->
buf_dœty
)

466 
	`S‘PageDœty
(
·ge
);

468 
	`·ge_ÿche_»Ëa£
(
·ge
);

471 
	`kä“
(
ucmd
->
d©a_·ges
);

472 
ucmd
->
d©a_·ges
 = 
NULL
;

474 
	`TRACE_EXIT
();

476 
	}
}

478 
	$__dev_u£r_ä“_sg_’Œ›s
(
sc¡_u£r_cmd
 *
ucmd
)

480 
	`TRACE_ENTRY
();

482 
	`sBUG_ON
(
ucmd
->
d©a_·ges
 =ð
NULL
);

484 
	`TRACE_MEM
("Freeing data…ages (ucmd=%p, ubuff=%lx, buff_cached=%d)",

485 
ucmd
, ucmd->
ubuff
, ucmd->
buff_ÿched
);

487 
	`dev_u£r_unm­_buf
(
ucmd
);

489 ià(
ucmd
->
buff_ÿched
)

490 
	`dev_u£r_Ú_ÿched_mem_ä“
(
ucmd
);

492 
	`ucmd_put
(
ucmd
);

494 
	`TRACE_EXIT
();

496 
	}
}

498 
	$dev_u£r_ä“_sg_’Œ›s
(
sÿ‰”li¡
 *
sg
, 
sg_couÁ
,

499 *
´iv
)

501 
sc¡_u£r_cmd
 *
ucmd
 = 
´iv
;

503 
	`TRACE_MEM
("F»ešg d©¨·ge (sg=%p, sg_couÁ=%d,…riv %p)", 
sg
,

504 
sg_couÁ
, 
ucmd
);

506 
	`__dev_u£r_ä“_sg_’Œ›s
(
ucmd
);

509 
	}
}

511 
šlše
 
	$is_buff_ÿched
(
sc¡_u£r_cmd
 *
ucmd
)

513 
mem_»u£_ty³
 = 
ucmd
->
dev
->
memÜy_»u£_ty³
;

515 ià((
mem_»u£_ty³
 =ð
SCST_USER_MEM_REUSE_ALL
) ||

516 ((
ucmd
->
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_READ
) &&

517 (
mem_»u£_ty³
 =ð
SCST_USER_MEM_REUSE_READ
)) ||

518 ((
ucmd
->
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_WRITE
) &&

519 (
mem_»u£_ty³
 =ð
SCST_USER_MEM_REUSE_WRITE
)))

523 
	}
}

525 
šlše
 
	$is_Ãed_offs_·ge
(
buf
, 
Ën
)

527  ((
buf
 & ~
PAGE_MASK
) != 0) &&

528 ((
buf
 & 
PAGE_MASK
è!ð((buf+
Ën
-1) & PAGE_MASK));

529 
	}
}

535 
	$dev_u£r_®loc_sg
(
sc¡_u£r_cmd
 *
ucmd
, 
ÿched_buff
)

537 
»s
 = 0;

538 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

539 
sc¡_u£r_dev
 *
dev
 = 
ucmd
->dev;

540 
sgv_poÞ
 *
poÞ
;

541 
gå_t
 
gå_mask
;

542 
æags
 = 0;

543 
bufæ’
, 
Üig_bufæ’
;

544 
Ï¡_Ën
 = 0;

545 
out_sg_·ges
 = 0;

547 
	`TRACE_ENTRY
();

549 
gå_mask
 = 
__GFP_NOWARN
;

550 
gå_mask
 |ð(
	`sc¡_cmd_©omic
(
cmd
è? 
GFP_ATOMIC
 : 
GFP_KERNEL
);

552 ià(
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_BIDI
) {

553 
Üig_bufæ’
 = 
cmd
->
bufæ’
;

554 
poÞ
 = 
cmd
->
tgt_dev
->
dh_´iv
;

557 
Ën
 = 
cmd
->
bufæ’
 + 
ucmd
->
fœ¡_·ge_off£t
;

558 
out_sg_·ges
 = (
Ën
 >> 
PAGE_SHIFT
è+ (Ö’ & ~
PAGE_MASK
) != 0);

559 
Üig_bufæ’
 = (
out_sg_·ges
 << 
PAGE_SHIFT
è+ 
cmd
->
out_bufæ’
;

560 
poÞ
 = 
dev
->pool;

562 
bufæ’
 = 
Üig_bufæ’
;

564 
	`EXTRACHECKS_BUG_ON
(
bufæ’
 == 0);

566 ià(
ÿched_buff
) {

567 
æags
 |ð
SGV_POOL_RETURN_OBJ_ON_ALLOC_FAIL
;

568 ià(
ucmd
->
ubuff
 == 0)

569 
æags
 |ð
SGV_POOL_NO_ALLOC_ON_CACHE_MISS
;

571 
	`TRACE_MEM
("%s", "Not cached buff");

572 
æags
 |ð
SGV_POOL_ALLOC_NO_CACHED
;

573 ià(
ucmd
->
ubuff
 == 0) {

574 
»s
 = 1;

575 
out
;

577 
bufæ’
 +ð
ucmd
->
fœ¡_·ge_off£t
;

578 ià(
	`is_Ãed_offs_·ge
(
ucmd
->
ubuff
, 
Üig_bufæ’
))

579 
Ï¡_Ën
 = 
bufæ’
 & ~
PAGE_MASK
;

581 
Ï¡_Ën
 = 
Üig_bufæ’
 & ~
PAGE_MASK
;

583 
ucmd
->
buff_ÿched
 = 
ÿched_buff
;

585 
cmd
->
sg
 = 
	`sgv_poÞ_®loc
(
poÞ
, 
bufæ’
, 
gå_mask
, 
æags
, &cmd->
sg_út
,

586 &
ucmd
->
sgv
, &
dev
->
udev_mem_lim
, ucmd);

587 ià(
cmd
->
sg
 !ð
NULL
) {

588 
sc¡_u£r_cmd
 *
buf_ucmd
 = 
	`sgv_g‘_´iv
(
ucmd
->
sgv
);

590 
	`TRACE_MEM
("Buf ucmd %p (cmd->sg_cnt %d,†ast seg†en %d, "

591 "Ï¡_ËÀ%d, bufæ’ %d)", 
buf_ucmd
, 
cmd
->
sg_út
,

592 
cmd
->
sg
[cmd->
sg_út
-1].
Ëngth
, 
Ï¡_Ën
, 
bufæ’
);

594 
ucmd
->
ubuff
 = 
buf_ucmd
->ubuff;

595 
ucmd
->
buf_ucmd
 = buf_ucmd;

597 
	`EXTRACHECKS_BUG_ON
((
ucmd
->
d©a_·ges
 !ð
NULL
) &&

598 (
ucmd
 !ð
buf_ucmd
));

600 ià(
Ï¡_Ën
 != 0) {

601 
cmd
->
sg
[cmd->
sg_út
-1].
Ëngth
 &ð
PAGE_MASK
;

602 
cmd
->
sg
[cmd->
sg_út
-1].
Ëngth
 +ð
Ï¡_Ën
;

605 
	`TRACE_MEM
("Buf‡lloced (ucmd %p, cached_buff %d, ubuff %lx, "

606 "Ï¡ seg†’ %d)", 
ucmd
, 
ÿched_buff
, ucmd->
ubuff
,

607 
cmd
->
sg
[cmd->
sg_út
-1].
Ëngth
);

609 ià(
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_BIDI
) {

610 
cmd
->
out_sg
 = &cmd->
sg
[
out_sg_·ges
];

611 
cmd
->
out_sg_út
 = cmd->
sg_út
 - 
out_sg_·ges
;

612 
cmd
->
sg_út
 = 
out_sg_·ges
;

613 
	`TRACE_MEM
("cmd %p, out_sg %p, out_sg_cnt %d, sg_cnt %d",

614 
cmd
, cmd->
out_sg
, cmd->
out_sg_út
, cmd->
sg_út
);

617 ià(
	`uÆik–y
(
cmd
->
sg_út
 > cmd->
tgt_dev
->
max_sg_út
)) {

618 
Î
;

619 ià((
Î
 < 10è|| 
	`TRACING_MINOR
()) {

620 
	`PRINT_INFO
("Unableo complete command dueo "

623 
cmd
->
sg_út
, cmd->
tgt_dev
->
max_sg_út
,

624 
cmd
->
tgt
->
sg_bËsize
);

625 
Î
++;

627 
cmd
->
sg
 = 
NULL
;

629 
»s
 = -1;

632 
	`TRACE_MEM
("Buf‚ot‡lloced (ucmd %p, h %d, buff_cached, %d, "

633 "sg_úˆ%d, ubufà%lx, sgv %p", 
ucmd
, ucmd->
h
,

634 
ucmd
->
buff_ÿched
, 
cmd
->
sg_út
, ucmd->
ubuff
, ucmd->
sgv
);

635 ià(
	`uÆik–y
(
cmd
->
sg_út
 == 0)) {

636 
	`TRACE_MEM
("Refu£d‡ÎoÿtiÚ (ucmd %p)", 
ucmd
);

637 
	`sBUG_ON
(
ucmd
->
sgv
 !ð
NULL
);

638 
»s
 = -1;

640 
ucmd
->
¡©e
) {

641 
UCMD_STATE_BUF_ALLOCING
:

642 
»s
 = 1;

644 
UCMD_STATE_EXECING
:

645 
»s
 = -1;

648 
	`sBUG
();

654 
out
:

655 
	`TRACE_EXIT_RES
(
»s
);

656  
»s
;

657 
	}
}

659 
	$dev_u£r_®loc_¥aû
(
sc¡_u£r_cmd
 *
ucmd
)

661 
rc
, 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

662 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

664 
	`TRACE_ENTRY
();

666 
ucmd
->
¡©e
 = 
UCMD_STATE_BUF_ALLOCING
;

667 
	`sc¡_cmd_£t_dh_d©a_buff_®loûd
(
cmd
);

669 
rc
 = 
	`dev_u£r_®loc_sg
(
ucmd
, 
	`is_buff_ÿched
(ucmd));

670 ià(
rc
 == 0)

671 
out
;

672 ià(
rc
 < 0) {

673 
	`sc¡_£t_busy
(
cmd
);

674 
»s
 = 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

675 
out
;

678 ià(!(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) &&

679 !
	`sc¡_is_cmd_loÿl
(
cmd
)) {

680 
	`TRACE_DBG
("D–ayed‡Îoc, ucmd %p", 
ucmd
);

681 
out
;

684 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

685 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
®loc_cmd
) +

686 (
ucmd
->
u£r_cmd
.
®loc_cmd
);

687 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

688 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_ALLOC_MEM
;

689 
ucmd
->
u£r_cmd
.
®loc_cmd
.
£ss_h
 = ()
cmd
->
tgt_dev
;

690 
	`memýy
(
ucmd
->
u£r_cmd
.
®loc_cmd
.
cdb
, 
cmd
->cdb,

691 
	`mš_t
(, 
SCST_MAX_CDB_SIZE
, 
cmd
->
cdb_Ën
));

692 
ucmd
->
u£r_cmd
.
®loc_cmd
.
cdb_Ën
 = 
cmd
->cdb_len;

693 
ucmd
->
u£r_cmd
.
®loc_cmd
.
®loc_Ën
 = ucmd->
buff_ÿched
 ?

694 (
cmd
->
sg_út
 << 
PAGE_SHIFT
è: cmd->
bufæ’
;

695 
ucmd
->
u£r_cmd
.
®loc_cmd
.
queue_ty³
 = 
cmd
->queue_type;

696 
ucmd
->
u£r_cmd
.
®loc_cmd
.
d©a_dœeùiÚ
 = 
cmd
->data_direction;

697 
ucmd
->
u£r_cmd
.
®loc_cmd
.
¢
 = 
cmd
->
tgt_¢
;

699 
	`dev_u£r_add_to_»ady
(
ucmd
);

701 
»s
 = 
SCST_CMD_STATE_STOP
;

703 
out
:

704 
	`TRACE_EXIT_RES
(
»s
);

705  
»s
;

706 
	}
}

708 
sc¡_u£r_cmd
 *
	$dev_u£r_®loc_ucmd
(
sc¡_u£r_dev
 *
dev
,

709 
gå_t
 
gå_mask
)

711 
sc¡_u£r_cmd
 *
ucmd
 = 
NULL
;

713 
	`TRACE_ENTRY
();

715 
ucmd
 = 
	`kmem_ÿche_z®loc
(
u£r_cmd_ÿch•
, 
gå_mask
);

716 ià(
	`uÆik–y
(
ucmd
 =ð
NULL
)) {

717 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate "

718 "u£¸cmd (gå_mask %x)", 
gå_mask
);

719 
out
;

721 
ucmd
->
dev
 = dev;

722 
	`©omic_£t
(&
ucmd
->
ucmd_»f
, 1);

724 
	`cmd_š£¹_hash
(
ucmd
);

726 
	`TRACE_MEM
("ucmd %°®loÿ‹d", 
ucmd
);

728 
out
:

729 
	`TRACE_EXIT_HRES
(()
ucmd
);

730  
ucmd
;

731 
	}
}

733 
	$dev_u£r_g‘_block
(
sc¡_cmd
 *
cmd
)

735 
sc¡_u£r_dev
 *
dev
 = 
cmd
->dev->
dh_´iv
;

740 
	`TRACE_EXIT_RES
(
dev
->
block
);

741  
dev
->
block
;

742 
	}
}

744 
	$dev_u£r_·r£
(
sc¡_cmd
 *
cmd
)

746 
rc
, 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

747 
sc¡_u£r_cmd
 *
ucmd
;

748 
©omic
 = 
	`sc¡_cmd_©omic
(
cmd
);

749 
sc¡_u£r_dev
 *
dev
 = 
cmd
->dev->
dh_´iv
;

750 
gå_t
 
gå_mask
 = 
©omic
 ? 
GFP_ATOMIC
 : 
GFP_KERNEL
;

752 
	`TRACE_ENTRY
();

754 ià(
cmd
->
dh_´iv
 =ð
NULL
) {

755 
ucmd
 = 
	`dev_u£r_®loc_ucmd
(
dev
, 
gå_mask
);

756 ià(
	`uÆik–y
(
ucmd
 =ð
NULL
)) {

757 ià(
©omic
) {

758 
»s
 = 
SCST_CMD_STATE_NEED_THREAD_CTX
;

759 
out
;

761 
	`sc¡_£t_busy
(
cmd
);

762 
out_”rÜ
;

765 
ucmd
->
cmd
 = cmd;

766 
cmd
->
dh_´iv
 = 
ucmd
;

768 
ucmd
 = 
cmd
->
dh_´iv
;

769 
	`TRACE_DBG
("U£d ucmd %p, s‹ %x", 
ucmd
, ucmd->
¡©e
);

772 
	`TRACE_DBG
("ucmd %p, cmd %p, s‹ %x", 
ucmd
, 
cmd
, ucmd->
¡©e
);

774 ià(
ucmd
->
¡©e
 =ð
UCMD_STATE_PARSING
) {

776 
dÚe
;

779 
	`EXTRACHECKS_BUG_ON
(
ucmd
->
¡©e
 !ð
UCMD_STATE_NEW
);

781 
dev
->
·r£_ty³
) {

782 
SCST_USER_PARSE_STANDARD
:

783 
	`TRACE_DBG
("PARSE STANDARD: ucmd %p", 
ucmd
);

784 
rc
 = 
dev
->
	`g’”ic_·r£
(
cmd
, 
dev_u£r_g‘_block
);

785 ià(
rc
 != 0)

786 
out_šv®id
;

789 
SCST_USER_PARSE_EXCEPTION
:

790 
	`TRACE_DBG
("PARSE EXCEPTION: ucmd %p", 
ucmd
);

791 
rc
 = 
dev
->
	`g’”ic_·r£
(
cmd
, 
dev_u£r_g‘_block
);

792 ià((
rc
 =ð0è&& (
cmd
->
Ý_æags
 & 
SCST_INFO_VALID
))

794 ià(
rc
 =ð
SCST_CMD_STATE_NEED_THREAD_CTX
) {

795 
	`TRACE_MEM
("Restarting PARSEohread context "

796 "(ucmd %p)", 
ucmd
);

797 
»s
 = 
SCST_CMD_STATE_NEED_THREAD_CTX
;

798 
out
;

802 
SCST_USER_PARSE_CALL
:

803 
	`TRACE_DBG
("Preparing PARSE for user space (ucmd=%p, h=%d, "

804 "bufæ’ %d)", 
ucmd
, ucmd->
h
, 
cmd
->
bufæ’
);

805 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

806 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
·r£_cmd
) +

807 (
ucmd
->
u£r_cmd
.
·r£_cmd
);

808 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

809 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_PARSE
;

810 
ucmd
->
u£r_cmd
.
·r£_cmd
.
£ss_h
 = ()
cmd
->
tgt_dev
;

811 
	`memýy
(
ucmd
->
u£r_cmd
.
·r£_cmd
.
cdb
, 
cmd
->cdb,

812 
	`mš_t
(, 
SCST_MAX_CDB_SIZE
, 
cmd
->
cdb_Ën
));

813 
ucmd
->
u£r_cmd
.
·r£_cmd
.
cdb_Ën
 = 
cmd
->cdb_len;

814 
ucmd
->
u£r_cmd
.
·r£_cmd
.
timeout
 = 
cmd
->timeouˆ/ 
HZ
;

815 
ucmd
->
u£r_cmd
.
·r£_cmd
.
bufæ’
 = 
cmd
->bufflen;

816 
ucmd
->
u£r_cmd
.
·r£_cmd
.
out_bufæ’
 = 
cmd
->out_bufflen;

817 
ucmd
->
u£r_cmd
.
·r£_cmd
.
queue_ty³
 = 
cmd
->queue_type;

818 
ucmd
->
u£r_cmd
.
·r£_cmd
.
d©a_dœeùiÚ
 = 
cmd
->data_direction;

819 
ucmd
->
u£r_cmd
.
·r£_cmd
.
ex³ùed_v®ues_£t
 =

820 
cmd
->
ex³ùed_v®ues_£t
;

821 
ucmd
->
u£r_cmd
.
·r£_cmd
.
ex³ùed_d©a_dœeùiÚ
 =

822 
cmd
->
ex³ùed_d©a_dœeùiÚ
;

823 
ucmd
->
u£r_cmd
.
·r£_cmd
.
ex³ùed_Œªsãr_Ën
 =

824 
cmd
->
ex³ùed_Œªsãr_Ën
;

825 
ucmd
->
u£r_cmd
.
·r£_cmd
.
ex³ùed_out_Œªsãr_Ën
 =

826 
cmd
->
ex³ùed_out_Œªsãr_Ën
;

827 
ucmd
->
u£r_cmd
.
·r£_cmd
.
¢
 = 
cmd
->
tgt_¢
;

828 
ucmd
->
u£r_cmd
.
·r£_cmd
.
Ý_æags
 = 
cmd
->op_flags;

829 
ucmd
->
¡©e
 = 
UCMD_STATE_PARSING
;

830 
	`dev_u£r_add_to_»ady
(
ucmd
);

831 
»s
 = 
SCST_CMD_STATE_STOP
;

832 
out
;

835 
	`sBUG
();

836 
out
;

839 
dÚe
:

840 ià(
cmd
->
bufæ’
 == 0) {

845 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

848 
out
:

849 
	`TRACE_EXIT_RES
(
»s
);

850  
»s
;

852 
out_šv®id
:

853 
	`PRINT_ERROR
("PARSE fažed (ucmd %p,„ø%d)", 
ucmd
, 
rc
);

854 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

856 
out_”rÜ
:

857 
»s
 = 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

858 
out
;

859 
	}
}

861 
	$dev_u£r_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
)

863 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

864 
sc¡_u£r_cmd
 *
ucmd
 = 
cmd
->
dh_´iv
;

866 
	`TRACE_ENTRY
();

868 
	`EXTRACHECKS_BUG_ON
((
ucmd
->
¡©e
 !ð
UCMD_STATE_NEW
) &&

869 (
ucmd
->
¡©e
 !ð
UCMD_STATE_PARSING
) &&

870 (
ucmd
->
¡©e
 !ð
UCMD_STATE_BUF_ALLOCING
));

872 
»s
 = 
	`dev_u£r_®loc_¥aû
(
ucmd
);

874 
	`TRACE_EXIT_RES
(
»s
);

875  
»s
;

876 
	}
}

878 
	$dev_u£r_æush_dÿche
(
sc¡_u£r_cmd
 *
ucmd
)

880 
sc¡_u£r_cmd
 *
buf_ucmd
 = 
ucmd
->buf_ucmd;

881 
¡¬t
 = 
buf_ucmd
->
ubuff
;

882 
i
, 
bufæ’
 = 
ucmd
->
cmd
->bufflen;

884 
	`TRACE_ENTRY
();

886 ià(
¡¬t
 == 0)

887 
out
;

899 
i
 = 0; (
bufæ’
 > 0è&& (˜< 
buf_ucmd
->
num_d©a_·ges
); i++) {

900 
·ge
 *·g
	`__©Œibu‹__
((
unu£d
));

901 
·ge
 = 
buf_ucmd
->
d©a_·ges
[
i
];

902 #ifdeà
ARCH_HAS_FLUSH_ANON_PAGE


903 
vm_¬—_¡ruù
 *
vma
 = 
	`fšd_vma
(
cu¼’t
->
mm
, 
¡¬t
);

904 ià(
vma
 !ð
NULL
)

905 
	`æush_ªÚ_·ge
(
vma
, 
·ge
, 
¡¬t
);

907 
	`æush_dÿche_·ge
(
·ge
);

908 
¡¬t
 +ð
PAGE_SIZE
;

909 
bufæ’
 -ð
PAGE_SIZE
;

912 
out
:

913 
	`TRACE_EXIT
();

915 
	}
}

917 
	$dev_u£r_exec
(
sc¡_cmd
 *
cmd
)

919 
sc¡_u£r_cmd
 *
ucmd
 = 
cmd
->
dh_´iv
;

920 
»s
 = 
SCST_EXEC_COMPLETED
;

922 
	`TRACE_ENTRY
();

924 
	`TRACE_DBG
("Preparing EXEC for user space (ucmd=%p, h=%d, "

925 "bufæ’ %d, d©a_ËÀ%d, ubufà%lx)", 
ucmd
, ucmd->
h
,

926 
cmd
->
bufæ’
, cmd->
d©a_Ën
, 
ucmd
->
ubuff
);

928 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

929 
	`dev_u£r_æush_dÿche
(
ucmd
);

931 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

932 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
exec_cmd
) +

933 (
ucmd
->
u£r_cmd
.
exec_cmd
);

934 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

935 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_EXEC
;

936 
ucmd
->
u£r_cmd
.
exec_cmd
.
£ss_h
 = ()
cmd
->
tgt_dev
;

937 
	`memýy
(
ucmd
->
u£r_cmd
.
exec_cmd
.
cdb
, 
cmd
->cdb,

938 
	`mš_t
(, 
SCST_MAX_CDB_SIZE
, 
cmd
->
cdb_Ën
));

939 
ucmd
->
u£r_cmd
.
exec_cmd
.
cdb_Ën
 = 
cmd
->cdb_len;

940 
ucmd
->
u£r_cmd
.
exec_cmd
.
bufæ’
 = 
cmd
->bufflen;

941 
ucmd
->
u£r_cmd
.
exec_cmd
.
d©a_Ën
 = 
cmd
->data_len;

942 
ucmd
->
u£r_cmd
.
exec_cmd
.
pbuf
 = ucmd->
ubuff
;

943 ià((
ucmd
->
ubuff
 =ð0è&& (
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_NONE
)) {

944 
ucmd
->
u£r_cmd
.
exec_cmd
.
®loc_Ën
 = ucmd->
buff_ÿched
 ?

945 (
cmd
->
sg_út
 << 
PAGE_SHIFT
è: cmd->
bufæ’
;

947 
ucmd
->
u£r_cmd
.
exec_cmd
.
queue_ty³
 = 
cmd
->queue_type;

948 
ucmd
->
u£r_cmd
.
exec_cmd
.
d©a_dœeùiÚ
 = 
cmd
->data_direction;

949 
ucmd
->
u£r_cmd
.
exec_cmd
.
·¹Ÿl
 = 0;

950 
ucmd
->
u£r_cmd
.
exec_cmd
.
timeout
 = 
cmd
->timeouˆ/ 
HZ
;

951 
ucmd
->
u£r_cmd
.
exec_cmd
.
p_out_buf
 = ucmd->
ubuff
 +

952 (
cmd
->
sg_út
 << 
PAGE_SHIFT
);

953 
ucmd
->
u£r_cmd
.
exec_cmd
.
out_bufæ’
 = 
cmd
->out_bufflen;

954 
ucmd
->
u£r_cmd
.
exec_cmd
.
¢
 = 
cmd
->
tgt_¢
;

956 
ucmd
->
¡©e
 = 
UCMD_STATE_EXECING
;

958 
	`dev_u£r_add_to_»ady
(
ucmd
);

960 
	`TRACE_EXIT_RES
(
»s
);

961  
»s
;

962 
	}
}

964 
	$dev_u£r_ä“_sgv
(
sc¡_u£r_cmd
 *
ucmd
)

966 ià(
ucmd
->
sgv
 !ð
NULL
) {

967 
	`sgv_poÞ_ä“
(
ucmd
->
sgv
, &ucmd->
dev
->
udev_mem_lim
);

968 
ucmd
->
sgv
 = 
NULL
;

969 } ià(
ucmd
->
d©a_·ges
 !ð
NULL
) {

971 
	`ucmd_g‘
(
ucmd
);

972 
	`__dev_u£r_ä“_sg_’Œ›s
(
ucmd
);

975 
	}
}

977 
	$dev_u£r_Ú_ä“_cmd
(
sc¡_cmd
 *
cmd
)

979 
sc¡_u£r_cmd
 *
ucmd
 = 
cmd
->
dh_´iv
;

981 
	`TRACE_ENTRY
();

983 ià(
	`uÆik–y
(
ucmd
 =ð
NULL
))

984 
out
;

986 
	`TRACE_MEM
("ucmd %p, cmd %p, buff_ÿched %d, ubufà%lx", 
ucmd
, ucmd->
cmd
,

987 
ucmd
->
buff_ÿched
, ucmd->
ubuff
);

989 
ucmd
->
cmd
 = 
NULL
;

990 ià((
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
è&& 
ucmd
->
buf_ucmd
 !ð
NULL
)

991 
ucmd
->
buf_ucmd
->
buf_dœty
 = 1;

993 ià(
ucmd
->
dev
->
Ú_ä“_cmd_ty³
 =ð
SCST_USER_ON_FREE_CMD_IGNORE
) {

994 
ucmd
->
¡©e
 = 
UCMD_STATE_ON_FREE_SKIPPED
;

996 
out_»¶y
;

999 ià(
	`uÆik–y
(!
ucmd
->
£’_by_u£r
)) {

1000 
	`TRACE_MGMT_DBG
("NÙ s“Àby u£¸ucmd %p", 
ucmd
);

1001 
out_»¶y
;

1004 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

1005 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
Ú_ä“_cmd
) +

1006 (
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
);

1007 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

1008 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_ON_FREE_CMD
;

1009 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
pbuf
 = ucmd->
ubuff
;

1010 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
»¥_d©a_Ën
 = 
cmd
->resp_data_len;

1011 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
bufãr_ÿched
 = ucmd->
buff_ÿched
;

1012 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
abÜ‹d
 = ucmd->aborted;

1013 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
¡©us
 = 
cmd
->status;

1014 
ucmd
->
u£r_cmd
.
Ú_ä“_cmd
.
d–iv”y_¡©us
 = 
cmd
->delivery_status;

1016 
ucmd
->
¡©e
 = 
UCMD_STATE_ON_FREEING
;

1018 
	`dev_u£r_add_to_»ady
(
ucmd
);

1020 
out
:

1021 
	`TRACE_EXIT
();

1024 
out_»¶y
:

1025 
	`dev_u£r_´oûss_»¶y_Ú_ä“
(
ucmd
);

1026 
out
;

1027 
	}
}

1029 
	$dev_u£r_£t_block
(
sc¡_cmd
 *
cmd
, 
block
)

1031 
sc¡_u£r_dev
 *
dev
 = 
cmd
->dev->
dh_´iv
;

1036 
	`TRACE_DBG
("dev %p,‚ew block %d", 
dev
, 
block
);

1037 ià(
block
 != 0)

1038 
dev
->
block
 = block;

1040 
dev
->
block
 = dev->
def_block
;

1042 
	}
}

1044 
	$dev_u£r_disk_dÚe
(
sc¡_cmd
 *
cmd
)

1046 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

1048 
	`TRACE_ENTRY
();

1050 
»s
 = 
	`sc¡_block_g’”ic_dev_dÚe
(
cmd
, 
dev_u£r_£t_block
);

1052 
	`TRACE_EXIT_RES
(
»s
);

1053  
»s
;

1054 
	}
}

1056 
	$dev_u£r_³_dÚe
(
sc¡_cmd
 *
cmd
)

1058 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

1060 
	`TRACE_ENTRY
();

1062 
»s
 = 
	`sc¡_³_g’”ic_dev_dÚe
(
cmd
, 
dev_u£r_£t_block
);

1064 
	`TRACE_EXIT_RES
(
»s
);

1065  
»s
;

1066 
	}
}

1068 
	$dev_u£r_add_to_»ady
(
sc¡_u£r_cmd
 *
ucmd
)

1070 
sc¡_u£r_dev
 *
dev
 = 
ucmd
->dev;

1071 
æags
;

1072 
do_wake
 = 
	`š_š‹¼u±
();

1074 
	`TRACE_ENTRY
();

1076 ià(
ucmd
->
cmd
)

1077 
do_wake
 |ð
ucmd
->
cmd
->
´•roûssšg_Úly
;

1079 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

1081 
ucmd
->
this_¡©e_unjammed
 = 0;

1083 ià((
ucmd
->
¡©e
 =ð
UCMD_STATE_PARSING
) ||

1084 (
ucmd
->
¡©e
 =ð
UCMD_STATE_BUF_ALLOCING
)) {

1094 
	`TRACE_DBG
("Adding ucmd %p (state %d)o head of„eady "

1095 "cmd†i¡", 
ucmd
, ucmd->
¡©e
);

1096 
	`li¡_add
(&
ucmd
->
»ady_cmd_li¡_’Œy
,

1097 &
dev
->
»ady_cmd_li¡
);

1098 } ià(
	`uÆik–y
(
ucmd
->
¡©e
 =ð
UCMD_STATE_TM_EXECING
) ||

1099 
	`uÆik–y
(
ucmd
->
¡©e
 =ð
UCMD_STATE_ATTACH_SESS
) ||

1100 
	`uÆik–y
(
ucmd
->
¡©e
 =ð
UCMD_STATE_DETACH_SESS
)) {

1101 
	`TRACE_MGMT_DBG
("Adding mgmt ucmd %p (state %d)o head of "

1102 "»ady cmd†i¡", 
ucmd
, ucmd->
¡©e
);

1103 
	`li¡_add
(&
ucmd
->
»ady_cmd_li¡_’Œy
,

1104 &
dev
->
»ady_cmd_li¡
);

1105 
do_wake
 = 1;

1107 ià((
ucmd
->
cmd
 !ð
NULL
) &&

1108 
	`uÆik–y
((
ucmd
->
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))) {

1109 
	`TRACE_DBG
("Adding HQ ucmd %po head of„eady cmd†ist",

1110 
ucmd
);

1111 
	`li¡_add
(&
ucmd
->
»ady_cmd_li¡_’Œy
,

1112 &
dev
->
»ady_cmd_li¡
);

1114 
	`TRACE_DBG
("Addšg ucmd %°tØ»ady cmd†i¡", 
ucmd
);

1115 
	`li¡_add_ž
(&
ucmd
->
»ady_cmd_li¡_’Œy
,

1116 &
dev
->
»ady_cmd_li¡
);

1118 
do_wake
 |ð((
ucmd
->
¡©e
 =ð
UCMD_STATE_ON_CACHE_FREEING
) ||

1119 (
ucmd
->
¡©e
 =ð
UCMD_STATE_ON_FREEING
));

1122 ià(
do_wake
) {

1123 
	`TRACE_DBG
("Wakšg u°dev %p", 
dev
);

1124 
	`wake_up
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
);

1127 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

1129 
	`TRACE_EXIT
();

1131 
	}
}

1133 
	$dev_u£r_m­_buf
(
sc¡_u£r_cmd
 *
ucmd
, 
ubuff
,

1134 
num_pg
)

1136 
»s
 = 0, 
rc
;

1137 
i
;

1138 
sk_¡ruù
 *
tsk
 = 
cu¼’t
;

1140 
	`TRACE_ENTRY
();

1142 ià(
	`uÆik–y
(
ubuff
 == 0))

1143 
out_nomem
;

1145 
	`sBUG_ON
(
ucmd
->
d©a_·ges
 !ð
NULL
);

1147 
ucmd
->
num_d©a_·ges
 = 
num_pg
;

1149 
ucmd
->
d©a_·ges
 =

1150 
	`km®loc
((*
ucmd
->
d©a_·ges
è* ucmd->
num_d©a_·ges
,

1151 
GFP_KERNEL
);

1152 ià(
ucmd
->
d©a_·ges
 =ð
NULL
) {

1153 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate data_pages‡rray "

1154 "Òum_d©a_·ges=%d)", 
ucmd
->
num_d©a_·ges
);

1155 
»s
 = -
ENOMEM
;

1156 
out_nomem
;

1159 
	`TRACE_MEM
("Mapping buffer (ucmd %p, ubuff %lx, ucmd->num_data_pages %d,"

1160 " fœ¡_·ge_off£ˆ%d,†’ %d)", 
ucmd
, 
ubuff
,

1161 
ucmd
->
num_d©a_·ges
, ()(
ubuff
 & ~
PAGE_MASK
),

1162 (
ucmd
->
cmd
 !ð
NULL
è? ucmd->cmd->
bufæ’
 : -1);

1164 
	`down_»ad
(&
tsk
->
mm
->
mm­_£m
);

1165 
rc
 = 
	`g‘_u£r_·ges
(
tsk
,sk->
mm
, 
ubuff
, 
ucmd
->
num_d©a_·ges
,

1166 1 , 0 , 
ucmd
->
d©a_·ges
, 
NULL
);

1167 
	`up_»ad
(&
tsk
->
mm
->
mm­_£m
);

1171 ià(
rc
 < 
ucmd
->
num_d©a_·ges
)

1172 
out_unm­
;

1174 
ucmd
->
ubuff
 = ubuff;

1175 
ucmd
->
fœ¡_·ge_off£t
 = (
ubuff
 & ~
PAGE_MASK
);

1177 
out
:

1178 
	`TRACE_EXIT_RES
(
»s
);

1179  
»s
;

1181 
out_nomem
:

1182 ià(
ucmd
->
cmd
 !ð
NULL
)

1183 
	`sc¡_£t_busy
(
ucmd
->
cmd
);

1186 
out_”r
:

1187 ià(
ucmd
->
cmd
 !ð
NULL
)

1188 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
ucmd
->
cmd
);

1189 
out
;

1191 
out_unm­
:

1192 
	`PRINT_ERROR
("Failedo get %d user…ages (rc %d)",

1193 
ucmd
->
num_d©a_·ges
, 
rc
);

1194 ià(
rc
 > 0) {

1195 
i
 = 0; i < 
rc
; i++)

1196 
	`·ge_ÿche_»Ëa£
(
ucmd
->
d©a_·ges
[
i
]);

1198 
	`kä“
(
ucmd
->
d©a_·ges
);

1199 
ucmd
->
d©a_·ges
 = 
NULL
;

1200 
»s
 = -
EFAULT
;

1201 ià(
ucmd
->
cmd
 !ð
NULL
)

1202 
	`sc¡_£t_cmd_”rÜ
(
ucmd
->
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1203 
out_”r
;

1204 
	}
}

1206 
	$dev_u£r_´oûss_»¶y_®loc
(
sc¡_u£r_cmd
 *
ucmd
,

1207 
sc¡_u£r_»¶y_cmd
 *
»¶y
)

1209 
»s
 = 0;

1210 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

1212 
	`TRACE_ENTRY
();

1214 
	`TRACE_DBG
("ucmd %p,…buà%Îx", 
ucmd
, 
»¶y
->
®loc_»¶y
.
pbuf
);

1216 ià(
	`lik–y
(
»¶y
->
®loc_»¶y
.
pbuf
 != 0)) {

1217 
·ges
;

1218 ià(
ucmd
->
buff_ÿched
) {

1219 ià(
	`uÆik–y
((
»¶y
->
®loc_»¶y
.
pbuf
 & ~
PAGE_MASK
) != 0)) {

1220 
	`PRINT_ERROR
("Supplied…buf %llx isn't "

1222 
»¶y
->
®loc_»¶y
.
pbuf
);

1223 
out_hw”r
;

1225 
·ges
 = 
cmd
->
sg_út
;

1227 
·ges
 = 
	`ÿlc_num_pg
(
»¶y
->
®loc_»¶y
.
pbuf
,

1228 
cmd
->
bufæ’
);

1229 
»s
 = 
	`dev_u£r_m­_buf
(
ucmd
, 
»¶y
->
®loc_»¶y
.
pbuf
, 
·ges
);

1231 
	`sc¡_£t_busy
(
ucmd
->
cmd
);

1232 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
ucmd
->
cmd
);

1235 
out_´oûss
:

1236 
	`sc¡_po¡_®loc_d©a_buf
(
cmd
);

1237 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
çl£
);

1239 
	`TRACE_EXIT_RES
(
»s
);

1240  
»s
;

1242 
out_hw”r
:

1243 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1244 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
ucmd
->
cmd
);

1245 
»s
 = -
EINVAL
;

1246 
out_´oûss
;

1247 
	}
}

1249 
	$dev_u£r_´oûss_»¶y_·r£
(
sc¡_u£r_cmd
 *
ucmd
,

1250 
sc¡_u£r_»¶y_cmd
 *
»¶y
)

1252 
»s
 = 0, 
rc
;

1253 
sc¡_u£r_scsi_cmd_»¶y_·r£
 *
´•ly
 =

1254 &
»¶y
->
·r£_»¶y
;

1255 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

1257 
	`TRACE_ENTRY
();

1259 ià(
´•ly
->
¡©us
 != 0)

1260 
out_¡©us
;

1262 ià(
	`uÆik–y
(
´•ly
->
queue_ty³
 > 
SCST_CMD_QUEUE_ACA
))

1263 
out_šv®
;

1265 ià(
	`uÆik–y
((
´•ly
->
d©a_dœeùiÚ
 !ð
SCST_DATA_WRITE
) &&

1266 (
´•ly
->
d©a_dœeùiÚ
 !ð
SCST_DATA_READ
) &&

1267 (
´•ly
->
d©a_dœeùiÚ
 !ð
SCST_DATA_BIDI
) &&

1268 (
´•ly
->
d©a_dœeùiÚ
 !ð
SCST_DATA_NONE
)))

1269 
out_šv®
;

1271 ià(
	`uÆik–y
((
´•ly
->
d©a_dœeùiÚ
 !ð
SCST_DATA_NONE
) &&

1272 (
´•ly
->
bufæ’
 == 0)))

1273 
out_šv®
;

1275 ià(
	`uÆik–y
((
´•ly
->
bufæ’
 < 0è|| (´•ly->
out_bufæ’
 < 0) ||

1276 (
´•ly
->
d©a_Ën
 < 0)))

1277 
out_šv®
;

1279 ià(
	`uÆik–y
(
´•ly
->
cdb_Ën
 > 
cmd
->cdb_len))

1280 
out_šv®
;

1282 ià(!(
´•ly
->
Ý_æags
 & 
SCST_INFO_VALID
))

1283 
out_šv®
;

1285 
	`TRACE_DBG
("ucmd %p, queue_type %x, data_direction, %x, bufflen %d, "

1286 "d©a_ËÀ%d,…buà%Îx, cdb_ËÀ%d, op_æag %x", 
ucmd
,

1287 
´•ly
->
queue_ty³
,…»¶y->
d©a_dœeùiÚ
,…»¶y->
bufæ’
,

1288 
´•ly
->
d©a_Ën
, 
»¶y
->
®loc_»¶y
.
pbuf
,…»¶y->
cdb_Ën
,

1289 
´•ly
->
Ý_æags
);

1291 
cmd
->
queue_ty³
 = 
´•ly
->queue_type;

1292 
cmd
->
d©a_dœeùiÚ
 = 
´•ly
->data_direction;

1293 
cmd
->
bufæ’
 = 
´•ly
->bufflen;

1294 
cmd
->
out_bufæ’
 = 
´•ly
->out_bufflen;

1295 
cmd
->
d©a_Ën
 = 
´•ly
->data_len;

1296 ià(
´•ly
->
cdb_Ën
 > 0)

1297 
cmd
->
cdb_Ën
 = 
´•ly
->cdb_len;

1298 
cmd
->
Ý_æags
 = 
´•ly
->op_flags;

1300 
out_´oûss
:

1301 
	`sc¡_po¡_·r£
(
cmd
);

1302 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
çl£
);

1304 
	`TRACE_EXIT_RES
(
»s
);

1305  
»s
;

1307 
out_šv®
:

1308 
	`PRINT_ERROR
("Invalid…arse_reply…arameters (LUN %lld, op %x, cmd %p)",

1309 ()
cmd
->
lun
, cmd->
cdb
[0], cmd);

1310 
	`PRINT_BUFFER
("Inv®id…¬£_»¶y", 
»¶y
, (*reply));

1311 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1312 
»s
 = -
EINVAL
;

1313 
out_abnÜm®
;

1315 
out_hw”r_»s_£t
:

1316 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1318 
out_abnÜm®
:

1319 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1320 
out_´oûss
;

1322 
out_¡©us
:

1323 
	`TRACE_DBG
("ucmd %p„eturned withƒrror from user status %x",

1324 
ucmd
, 
´•ly
->
¡©us
);

1326 ià(
´•ly
->
£n£_Ën
 != 0) {

1327 
£n£_Ën
;

1329 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 0);

1330 ià(
»s
 != 0)

1331 
out_hw”r_»s_£t
;

1333 
£n£_Ën
 = 
	`mš_t
(, 
cmd
->
£n£_buæ’
, 
´•ly
->sense_len);

1335 
rc
 = 
	`cÝy_äom_u£r
(
cmd
->
£n£
,

1336 (
__u£r
 *)()
´•ly
->
p£n£_bufãr
,

1337 
£n£_Ën
);

1338 ià(
rc
 != 0) {

1339 
	`PRINT_ERROR
("FažedØcÝy %d s’£' by‹s", 
rc
);

1340 
»s
 = -
EFAULT
;

1341 
out_hw”r_»s_£t
;

1343 
cmd
->
£n£_v®id_Ën
 = 
£n£_Ën
;

1345 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
´•ly
->
¡©us
);

1346 
out_abnÜm®
;

1347 
	}
}

1349 
	$dev_u£r_´oûss_»¶y_Ú_ä“
(
sc¡_u£r_cmd
 *
ucmd
)

1351 
»s
 = 0;

1353 
	`TRACE_ENTRY
();

1355 
	`TRACE_DBG
("ON FREE ucmd %p", 
ucmd
);

1357 
	`dev_u£r_ä“_sgv
(
ucmd
);

1358 
	`ucmd_put
(
ucmd
);

1360 
	`TRACE_EXIT_RES
(
»s
);

1361  
»s
;

1362 
	}
}

1364 
	$dev_u£r_´oûss_»¶y_Ú_ÿche_ä“
(
sc¡_u£r_cmd
 *
ucmd
)

1366 
»s
 = 0;

1368 
	`TRACE_ENTRY
();

1370 
	`TRACE_DBG
("ON CACHE FREE ucmd %p", 
ucmd
);

1372 
	`ucmd_put
(
ucmd
);

1374 
	`TRACE_EXIT_RES
(
»s
);

1375  
»s
;

1376 
	}
}

1378 
	$dev_u£r_´oûss_»¶y_exec
(
sc¡_u£r_cmd
 *
ucmd
,

1379 
sc¡_u£r_»¶y_cmd
 *
»¶y
)

1381 
»s
 = 0;

1382 
sc¡_u£r_scsi_cmd_»¶y_exec
 *
”•ly
 =

1383 &
»¶y
->
exec_»¶y
;

1384 
sc¡_cmd
 *
cmd
 = 
ucmd
->cmd;

1386 
	`TRACE_ENTRY
();

1388 ià(
”•ly
->
»¶y_ty³
 =ð
SCST_EXEC_REPLY_COMPLETED
) {

1389 ià(
ucmd
->
background_exec
) {

1390 
	`TRACE_DBG
("Background ucmd %°fšished", 
ucmd
);

1391 
	`ucmd_put
(
ucmd
);

1392 
out
;

1394 ià(
	`uÆik–y
(
”•ly
->
»¥_d©a_Ën
 > 
cmd
->
bufæ’
))

1395 
out_šv®
;

1396 ià(
	`uÆik–y
((
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_READ
) &&

1397 (
”•ly
->
»¥_d©a_Ën
 != 0)))

1398 
out_šv®
;

1399 } ià(
”•ly
->
»¶y_ty³
 =ð
SCST_EXEC_REPLY_BACKGROUND
) {

1400 ià(
	`uÆik–y
(
ucmd
->
background_exec
))

1401 
out_šv®
;

1402 ià(
	`uÆik–y
((
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) ||

1403 (
cmd
->
»¥_d©a_Ën
 != 0)))

1404 
out_šv®
;

1410 
	`ucmd_g‘
(
ucmd
);

1411 
ucmd
->
background_exec
 = 1;

1412 
	`TRACE_DBG
("Background ucmd %p", 
ucmd
);

1413 
out_com¶
;

1415 
out_šv®
;

1417 
	`TRACE_DBG
("ucmd %p, stu %d,„e¥_d©a_ËÀ%d", 
ucmd
,

1418 
”•ly
->
¡©us
,ƒ»¶y->
»¥_d©a_Ën
);

1420 
cmd
->
©omic
 = 0;

1422 ià(
”•ly
->
»¥_d©a_Ën
 != 0) {

1423 ià(
ucmd
->
ubuff
 == 0) {

1424 
·ges
, 
rc
;

1425 ià(
	`uÆik–y
(
”•ly
->
pbuf
 == 0))

1426 
out_busy
;

1427 ià(
ucmd
->
buff_ÿched
) {

1428 ià(
	`uÆik–y
((
”•ly
->
pbuf
 & ~
PAGE_MASK
) != 0)) {

1429 
	`PRINT_ERROR
("Supplied…buf %llx isn't "

1430 "·g®igÃd", 
”•ly
->
pbuf
);

1431 
out_hw”r
;

1433 
·ges
 = 
cmd
->
sg_út
;

1435 
·ges
 = 
	`ÿlc_num_pg
(
”•ly
->
pbuf
, 
cmd
->
bufæ’
);

1436 
rc
 = 
	`dev_u£r_m­_buf
(
ucmd
, 
”•ly
->
pbuf
, 
·ges
);

1437 ià((
rc
 !ð0è|| (
ucmd
->
ubuff
 == 0))

1438 
out_com¶
;

1440 
rc
 = 
	`dev_u£r_®loc_sg
(
ucmd
, ucmd->
buff_ÿched
);

1441 ià(
	`uÆik–y
(
rc
 != 0))

1442 
out_busy
;

1444 
	`dev_u£r_æush_dÿche
(
ucmd
);

1445 
cmd
->
may_Ãed_dma_sync
 = 1;

1446 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
”•ly
->
»¥_d©a_Ën
);

1447 } ià(
cmd
->
»¥_d©a_Ën
 !ð
”•ly
->resp_data_len) {

1448 ià(
ucmd
->
ubuff
 == 0) {

1453 
cmd
->
»¥_d©a_Ën
 = 
”•ly
->resp_data_len;

1454 
cmd
->
»sid_possibË
 = 1;

1456 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
”•ly
->
»¥_d©a_Ën
);

1459 
cmd
->
¡©us
 = 
”•ly
->status;

1460 ià(
”•ly
->
£n£_Ën
 != 0) {

1461 
£n£_Ën
, 
rc
;

1463 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 0);

1464 ià(
»s
 != 0)

1465 
out_com¶
;

1467 
£n£_Ën
 = 
	`mš_t
(, 
cmd
->
£n£_buæ’
, 
”•ly
->sense_len);

1469 
rc
 = 
	`cÝy_äom_u£r
(
cmd
->
£n£
,

1470 (
__u£r
 *)()
”•ly
->
p£n£_bufãr
,

1471 
£n£_Ën
);

1472 ià(
rc
 != 0) {

1473 
	`PRINT_ERROR
("FažedØcÝy %d s’£' by‹s", 
rc
);

1474 
»s
 = -
EFAULT
;

1475 
out_hw”r_»s_£t
;

1477 
cmd
->
£n£_v®id_Ën
 = 
£n£_Ën
;

1480 
out_com¶
:

1481 
cmd
->
com¶‘ed
 = 1;

1482 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_DIRECT
);

1485 
out
:

1486 
	`TRACE_EXIT_RES
(
»s
);

1487  
»s
;

1489 
out_šv®
:

1490 
	`PRINT_ERROR
("Invalidƒxec_reply…arameters (LUN %lld, op %x, cmd %p)",

1491 ()
cmd
->
lun
, cmd->
cdb
[0], cmd);

1492 
	`PRINT_BUFFER
("Inv®idƒxec_»¶y", 
»¶y
, (*reply));

1494 
out_hw”r
:

1495 
»s
 = -
EINVAL
;

1497 
out_hw”r_»s_£t
:

1498 ià(
ucmd
->
background_exec
) {

1499 
	`ucmd_put
(
ucmd
);

1500 
out
;

1502 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1503 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1504 
out_com¶
;

1507 
out_busy
:

1508 
	`sc¡_£t_busy
(
cmd
);

1509 
out_com¶
;

1510 
	}
}

1512 
	$dev_u£r_´oûss_»¶y
(
sc¡_u£r_dev
 *
dev
,

1513 
sc¡_u£r_»¶y_cmd
 *
»¶y
)

1515 
»s
 = 0;

1516 
sc¡_u£r_cmd
 *
ucmd
;

1517 
¡©e
;

1519 
	`TRACE_ENTRY
();

1521 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1523 
ucmd
 = 
	`__ucmd_fšd_hash
(
dev
, 
»¶y
->
cmd_h
);

1524 ià(
	`uÆik–y
(
ucmd
 =ð
NULL
)) {

1525 
	`TRACE_MGMT_DBG
("cmd_h %d‚Ù found", 
»¶y
->
cmd_h
);

1526 
»s
 = -
ESRCH
;

1527 
out_uÆock
;

1530 ià(
	`uÆik–y
(
	`ucmd_g‘_check
(
ucmd
))) {

1531 
	`TRACE_MGMT_DBG
("Found bešg de¡royed cmd_h %d", 
»¶y
->
cmd_h
);

1532 
»s
 = -
ESRCH
;

1533 
out_uÆock
;

1537 
	`smp_mb
();

1538 ià(
ucmd
->
background_exec
) {

1539 
¡©e
 = 
UCMD_STATE_EXECING
;

1540 
uÆock_´oûss
;

1543 ià(
	`uÆik–y
(
ucmd
->
this_¡©e_unjammed
)) {

1544 
	`TRACE_MGMT_DBG
("Reply on unjammed ucmd %p, ignoring",

1545 
ucmd
);

1546 
out_uÆock_put
;

1549 ià(
	`uÆik–y
(!
ucmd
->
£Á_to_u£r
)) {

1550 
	`TRACE_MGMT_DBG
("Ucmd %p isn't inhe sento user "

1551 "¡©%x", 
ucmd
, ucmd->
¡©e
);

1552 
»s
 = -
EINVAL
;

1553 
out_uÆock_put
;

1556 ià(
	`uÆik–y
(
»¶y
->
subcode
 !ð
ucmd
->
u£r_cmd
.subcode))

1557 
out_wrÚg_¡©e
;

1559 ià(
	`uÆik–y
(
	`_IOC_NR
(
»¶y
->
subcode
è!ð
ucmd
->
¡©e
))

1560 
out_wrÚg_¡©e
;

1562 
¡©e
 = 
ucmd
->state;

1563 
ucmd
->
£Á_to_u£r
 = 0;

1565 
uÆock_´oûss
:

1566 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1568 
¡©e
) {

1569 
UCMD_STATE_PARSING
:

1570 
»s
 = 
	`dev_u£r_´oûss_»¶y_·r£
(
ucmd
, 
»¶y
);

1573 
UCMD_STATE_BUF_ALLOCING
:

1574 
»s
 = 
	`dev_u£r_´oûss_»¶y_®loc
(
ucmd
, 
»¶y
);

1577 
UCMD_STATE_EXECING
:

1578 
»s
 = 
	`dev_u£r_´oûss_»¶y_exec
(
ucmd
, 
»¶y
);

1581 
UCMD_STATE_ON_FREEING
:

1582 
»s
 = 
	`dev_u£r_´oûss_»¶y_Ú_ä“
(
ucmd
);

1585 
UCMD_STATE_ON_CACHE_FREEING
:

1586 
»s
 = 
	`dev_u£r_´oûss_»¶y_Ú_ÿche_ä“
(
ucmd
);

1589 
UCMD_STATE_TM_EXECING
:

1590 
»s
 = 
	`dev_u£r_´oûss_»¶y_tm_exec
(
ucmd
, 
»¶y
->
»suÉ
);

1593 
UCMD_STATE_ATTACH_SESS
:

1594 
UCMD_STATE_DETACH_SESS
:

1595 
»s
 = 
	`dev_u£r_´oûss_»¶y_£ss
(
ucmd
, 
»¶y
->
»suÉ
);

1599 
	`sBUG
();

1603 
out_put
:

1604 
	`ucmd_put
(
ucmd
);

1606 
out
:

1607 
	`TRACE_EXIT_RES
(
»s
);

1608  
»s
;

1610 
out_wrÚg_¡©e
:

1611 
	`PRINT_ERROR
("Command's %p subcode %x doesn't match internal "

1613 "(%x)", 
ucmd
, 
	`_IOC_NR
(
»¶y
->
subcode
), ucmd->
¡©e
,

1614 
»¶y
->
subcode
, 
ucmd
->
u£r_cmd
.subcode);

1615 
»s
 = -
EINVAL
;

1616 
	`dev_u£r_unjam_cmd
(
ucmd
, 0, 
NULL
);

1618 
out_uÆock_put
:

1619 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1620 
out_put
;

1622 
out_uÆock
:

1623 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1624 
out
;

1625 
	}
}

1627 
	$dev_u£r_»¶y_cmd
(
fže
 *fže, 
__u£r
 *
¬g
)

1629 
»s
 = 0, 
rc
;

1630 
sc¡_u£r_dev
 *
dev
;

1631 
sc¡_u£r_»¶y_cmd
 
»¶y
;

1633 
	`TRACE_ENTRY
();

1635 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

1636 
dev
 = 
fže
->
´iv©e_d©a
;

1637 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

1638 ià(
	`uÆik–y
(
»s
 != 0)) {

1639 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

1640 
out
;

1642 
	`down_»ad
(&
dev
->
dev_rw£m
);

1643 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

1645 
rc
 = 
	`cÝy_äom_u£r
(&
»¶y
, 
¬g
, (reply));

1646 ià(
	`uÆik–y
(
rc
 != 0)) {

1647 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

1648 
»s
 = -
EFAULT
;

1649 
out_up
;

1652 
	`TRACE_DBG
("R•ly fÜ dev %s", 
dev
->
Çme
);

1654 
	`TRACE_BUFFER
("R•ly", &
»¶y
, (reply));

1656 
»s
 = 
	`dev_u£r_´oûss_»¶y
(
dev
, &
»¶y
);

1657 ià(
	`uÆik–y
(
»s
 < 0))

1658 
out_up
;

1660 
out_up
:

1661 
	`up_»ad
(&
dev
->
dev_rw£m
);

1663 
out
:

1664 
	`TRACE_EXIT_RES
(
»s
);

1665  
»s
;

1666 
	}
}

1668 
	$dev_u£r_g‘_ext_cdb
(
fže
 *fže, 
__u£r
 *
¬g
)

1670 
»s
 = 0, 
rc
;

1671 
sc¡_u£r_dev
 *
dev
;

1672 
sc¡_u£r_cmd
 *
ucmd
;

1673 
sc¡_cmd
 *
cmd
 = 
NULL
;

1674 
sc¡_u£r_g‘_ext_cdb
 
g‘
;

1676 
	`TRACE_ENTRY
();

1678 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

1679 
dev
 = 
fže
->
´iv©e_d©a
;

1680 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

1681 ià(
	`uÆik–y
(
»s
 != 0)) {

1682 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

1683 
out
;

1685 
	`down_»ad
(&
dev
->
dev_rw£m
);

1686 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

1688 
rc
 = 
	`cÝy_äom_u£r
(&
g‘
, 
¬g
, (get));

1689 ià(
	`uÆik–y
(
rc
 != 0)) {

1690 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

1691 
»s
 = -
EFAULT
;

1692 
out_up
;

1695 
	`TRACE_MGMT_DBG
("G‘ƒxˆcdb fÜ dev %s", 
dev
->
Çme
);

1697 
	`TRACE_BUFFER
("G‘ƒxˆcdb", &
g‘
, (get));

1699 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1701 
ucmd
 = 
	`__ucmd_fšd_hash
(
dev
, 
g‘
.
cmd_h
);

1702 ià(
	`uÆik–y
(
ucmd
 =ð
NULL
)) {

1703 
	`TRACE_MGMT_DBG
("cmd_h %d‚Ù found", 
g‘
.
cmd_h
);

1704 
»s
 = -
ESRCH
;

1705 
out_uÆock
;

1708 ià(
	`uÆik–y
(
	`ucmd_g‘_check
(
ucmd
))) {

1709 
	`TRACE_MGMT_DBG
("Found bešg de¡royed cmd_h %d", 
g‘
.
cmd_h
);

1710 
»s
 = -
ESRCH
;

1711 
out_uÆock
;

1714 ià((
ucmd
->
cmd
 !ð
NULL
è&& (ucmd->
¡©e
 <ð
UCMD_STATE_EXECING
) &&

1715 (
ucmd
->
£Á_to_u£r
 || ucmd->
background_exec
)) {

1716 
cmd
 = 
ucmd
->cmd;

1717 
	`sc¡_cmd_g‘
(
cmd
);

1719 
	`TRACE_MGMT_DBG
("Invalid ucmd state %d for cmd_h %d",

1720 
ucmd
->
¡©e
, 
g‘
.
cmd_h
);

1721 
»s
 = -
EINVAL
;

1722 
out_uÆock
;

1725 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1727 ià(
cmd
 =ð
NULL
)

1728 
out_put
;

1730 
	`BUILD_BUG_ON
((
cmd
->
cdb_buf
è!ð
SCST_MAX_CDB_SIZE
);

1732 ià(
cmd
->
cdb_Ën
 <ð
SCST_MAX_CDB_SIZE
)

1733 
out_cmd_put
;

1735 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cdb_buf
 == cmd->cdb_buf);

1737 
	`TRACE_BUFFER
("EXT CDB", &
cmd
->
cdb
[(cmd->
cdb_buf
)],

1738 
cmd
->
cdb_Ën
 - (cmd->
cdb_buf
));

1739 
rc
 = 
	`cÝy_to_u£r
((
__u£r
 *)()
g‘
.
ext_cdb_bufãr
,

1740 &
cmd
->
cdb
[(cmd->
cdb_buf
)],

1741 
cmd
->
cdb_Ën
 - (cmd->
cdb_buf
));

1742 ià(
	`uÆik–y
(
rc
 != 0)) {

1743 
	`PRINT_ERROR
("FažedØcÝyØu£¸%d by‹s", 
rc
);

1744 
»s
 = -
EFAULT
;

1745 
out_cmd_put
;

1748 
out_cmd_put
:

1749 
	`sc¡_cmd_put
(
cmd
);

1751 
out_put
:

1752 
	`ucmd_put
(
ucmd
);

1754 
out_up
:

1755 
	`up_»ad
(&
dev
->
dev_rw£m
);

1757 
out
:

1758 
	`TRACE_EXIT_RES
(
»s
);

1759  
»s
;

1761 
out_uÆock
:

1762 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1763 
out_up
;

1764 
	}
}

1766 
	$dev_u£r_´oûss_sc¡_commªds
(
sc¡_u£r_dev
 *
dev
)

1767 
	`__»Ëa£s
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

1768 
	`__acquœes
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

1770 
»s
 = 0;

1772 
	`TRACE_ENTRY
();

1774 !
	`li¡_em±y
(&
dev
->
udev_cmd_th»ads
.
aùive_cmd_li¡
)) {

1775 
sc¡_cmd
 *
cmd
 = 
	`li¡_’Œy
(

1776 
dev
->
udev_cmd_th»ads
.
aùive_cmd_li¡
.
Ãxt
, 
	`ty³of
(*
cmd
),

1777 
cmd_li¡_’Œy
);

1778 
	`TRACE_DBG
("D–‘šg cmd %°äom‡ùivcmd†i¡", 
cmd
);

1779 
	`li¡_d–
(&
cmd
->
cmd_li¡_’Œy
);

1780 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1781 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
çl£
);

1782 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1783 
»s
++;

1786 
	`TRACE_EXIT_RES
(
»s
);

1787  
»s
;

1788 
	}
}

1791 
sc¡_u£r_cmd
 *
	$__dev_u£r_g‘_Ãxt_cmd
(
li¡_h—d
 *
cmd_li¡
)

1792 
	`__»Ëa£s
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

1793 
	`__acquœes
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

1795 
sc¡_u£r_cmd
 *
u
;

1797 
agaš
:

1798 
u
 = 
NULL
;

1799 ià(!
	`li¡_em±y
(
cmd_li¡
)) {

1800 
u
 = 
	`li¡_’Œy
(
cmd_li¡
->
Ãxt
, 
	`ty³of
(*u),

1801 
»ady_cmd_li¡_’Œy
);

1803 
	`TRACE_DBG
("Found„—dy ucmd %p", 
u
);

1804 
	`li¡_d–
(&
u
->
»ady_cmd_li¡_’Œy
);

1806 
	`EXTRACHECKS_BUG_ON
(
u
->
this_¡©e_unjammed
);

1808 ià(
u
->
cmd
 !ð
NULL
) {

1809 ià(
u
->
¡©e
 =ð
UCMD_STATE_EXECING
) {

1810 
sc¡_u£r_dev
 *
dev
 = 
u
->dev;

1811 
rc
;

1813 
	`EXTRACHECKS_BUG_ON
(
u
->
jammed
);

1815 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1817 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
u
->
cmd
);

1818 ià(
	`uÆik–y
(
rc
 != 0)) {

1819 
u
->
cmd
->
	`sc¡_cmd_dÚe
(u->cmd,

1820 
SCST_CMD_STATE_DEFAULT
,

1821 
SCST_CONTEXT_DIRECT
);

1826 
	`¥š_lock_œq
(

1827 &
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1828 
agaš
;

1831 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1832 } ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
,

1833 &
u
->
cmd
->
cmd_æags
))) {

1834 
u
->
¡©e
) {

1835 
UCMD_STATE_PARSING
:

1836 
UCMD_STATE_BUF_ALLOCING
:

1837 
	`TRACE_MGMT_DBG
("AbÜtšg ucmd %p", 
u
);

1838 
	`dev_u£r_unjam_cmd
(
u
, 0, 
NULL
);

1839 
agaš
;

1840 
UCMD_STATE_EXECING
:

1841 
	`EXTRACHECKS_BUG_ON
(1);

1845 
u
->
£Á_to_u£r
 = 1;

1846 
u
->
£’_by_u£r
 = 1;

1848  
u
;

1849 
	}
}

1851 
šlše
 
	$‹¡_cmd_th»ads
(
sc¡_u£r_dev
 *
dev
)

1853 
»s
 = !
	`li¡_em±y
(&
dev
->
udev_cmd_th»ads
.
aùive_cmd_li¡
) ||

1854 !
	`li¡_em±y
(&
dev
->
»ady_cmd_li¡
) ||

1855 !
dev
->
blockšg
 || dev->
þ—nup_dÚe
 ||

1856 
	`sigÇl_³ndšg
(
cu¼’t
);

1857  
»s
;

1858 
	}
}

1861 
	$dev_u£r_g‘_Ãxt_cmd
(
sc¡_u£r_dev
 *
dev
,

1862 
sc¡_u£r_cmd
 **
ucmd
)

1864 
»s
 = 0;

1865 
wa™_queue_t
 
wa™
;

1867 
	`TRACE_ENTRY
();

1869 
	`š™_wa™queue_’Œy
(&
wa™
, 
cu¼’t
);

1872 ià(!
	`‹¡_cmd_th»ads
(
dev
)) {

1873 
	`add_wa™_queue_exþusive_h—d
(

1874 &
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
,

1875 &
wa™
);

1877 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

1878 ià(
	`‹¡_cmd_th»ads
(
dev
))

1880 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1881 
	`scheduË
();

1882 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1884 
	`£t_cu¼’t_¡©e
(
TASK_RUNNING
);

1885 
	`»move_wa™_queue
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
,

1886 &
wa™
);

1889 
	`dev_u£r_´oûss_sc¡_commªds
(
dev
);

1891 *
ucmd
 = 
	`__dev_u£r_g‘_Ãxt_cmd
(&
dev
->
»ady_cmd_li¡
);

1892 ià(*
ucmd
 !ð
NULL
)

1895 ià(!
dev
->
blockšg
 || dev->
þ—nup_dÚe
) {

1896 
»s
 = -
EAGAIN
;

1897 
	`TRACE_DBG
("NØ»ady commªds,„‘uºšg %d", 
»s
);

1901 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

1902 
»s
 = -
EINTR
;

1903 
	`TRACE_DBG
("SigÇÈ³ndšg,„‘uºšg %d", 
»s
);

1908 
	`TRACE_EXIT_RES
(
»s
);

1909  
»s
;

1910 
	}
}

1912 
	$dev_u£r_»¶y_g‘_cmd
(
fže
 *fže, 
__u£r
 *
¬g
)

1914 
»s
 = 0, 
rc
;

1915 
sc¡_u£r_dev
 *
dev
;

1916 
sc¡_u£r_g‘_cmd
 *
cmd
;

1917 
sc¡_u£r_»¶y_cmd
 *
»¶y
;

1918 
sc¡_u£r_cmd
 *
ucmd
;

1919 
ušt64_t
 
u»¶y
;

1921 
	`TRACE_ENTRY
();

1923 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

1924 
dev
 = 
fže
->
´iv©e_d©a
;

1925 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

1926 ià(
	`uÆik–y
(
»s
 != 0)) {

1927 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

1928 
out
;

1930 
	`down_»ad
(&
dev
->
dev_rw£m
);

1931 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

1934 
rc
 = 
	`cÝy_äom_u£r
(&
u»¶y
, (
ušt64_t
 
__u£r
 *)

1935 &((
sc¡_u£r_g‘_cmd
 
__u£r
 *)
¬g
)->
´•ly
,

1936 (
u»¶y
));

1937 ià(
	`uÆik–y
(
rc
 != 0)) {

1938 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

1939 
»s
 = -
EFAULT
;

1940 
out_up
;

1943 
	`TRACE_DBG
("u»¶y %Îd (dev %s)", ()
u»¶y
,

1944 
dev
->
Çme
);

1946 
cmd
 = 
	`kmem_ÿche_®loc
(
u£r_g‘_cmd_ÿch•
, 
GFP_KERNEL
);

1947 ià(
	`uÆik–y
(
cmd
 =ð
NULL
)) {

1948 
»s
 = -
ENOMEM
;

1949 
out_up
;

1952 ià(
u»¶y
 != 0) {

1953 
u
 = ()
u»¶y
;

1954 
»¶y
 = (
sc¡_u£r_»¶y_cmd
 *)
cmd
;

1955 
rc
 = 
	`cÝy_äom_u£r
(
»¶y
, (
__u£r
 *)
u
, (*reply));

1956 ià(
	`uÆik–y
(
rc
 != 0)) {

1957 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

1958 
»s
 = -
EFAULT
;

1959 
out_ä“
;

1962 
	`TRACE_BUFFER
("R•ly", 
»¶y
, (*reply));

1964 
»s
 = 
	`dev_u£r_´oûss_»¶y
(
dev
, 
»¶y
);

1965 ià(
	`uÆik–y
(
»s
 < 0))

1966 
out_ä“
;

1969 
	`kmem_ÿche_ä“
(
u£r_g‘_cmd_ÿch•
, 
cmd
);

1971 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1972 
agaš
:

1973 
»s
 = 
	`dev_u£r_g‘_Ãxt_cmd
(
dev
, &
ucmd
);

1974 ià(
»s
 == 0) {

1975 
Ën
;

1982 ià(
	`uÆik–y
(
	`ucmd_g‘_check
(
ucmd
))) {

1984 
agaš
;

1986 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

1988 
	`EXTRACHECKS_BUG_ON
(
ucmd
->
u£r_cmd_·ylßd_Ën
 == 0);

1990 
Ën
 = 
ucmd
->
u£r_cmd_·ylßd_Ën
;

1991 
	`TRACE_DBG
("ucmd %p (user_cmd %p),…ayload_len %d (len %d)",

1992 
ucmd
, &ucmd->
u£r_cmd
, ucmd->
u£r_cmd_·ylßd_Ën
, 
Ën
);

1993 
	`TRACE_BUFFER
("UCMD", &
ucmd
->
u£r_cmd
, 
Ën
);

1994 
rc
 = 
	`cÝy_to_u£r
(
¬g
, &
ucmd
->
u£r_cmd
, 
Ën
);

1995 ià(
	`uÆik–y
(
rc
 != 0)) {

1996 
	`PRINT_ERROR
("Copyo user failed (%d),„equeuing ucmd "

1997 "%°backØh—d oà»ady cmd†i¡", 
rc
, 
ucmd
);

1998 
»s
 = -
EFAULT
;

2000 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2001 
	`li¡_add
(&
ucmd
->
»ady_cmd_li¡_’Œy
,

2002 &
dev
->
»ady_cmd_li¡
);

2003 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2005 #ifdeà
CONFIG_SCST_EXTRACHECKS


2007 
ucmd
->
u£r_cmd_·ylßd_Ën
 = 0;

2009 
	`ucmd_put
(
ucmd
);

2011 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2013 
out_up
:

2014 
	`up_»ad
(&
dev
->
dev_rw£m
);

2016 
out
:

2017 
	`TRACE_EXIT_RES
(
»s
);

2018  
»s
;

2020 
out_ä“
:

2021 
	`kmem_ÿche_ä“
(
u£r_g‘_cmd_ÿch•
, 
cmd
);

2022 
out_up
;

2023 
	}
}

2025 
	$dev_u£r_ioùl
(
fže
 *fže, 
cmd
,

2026 
¬g
)

2028 
»s
, 
rc
;

2030 
	`TRACE_ENTRY
();

2032 
cmd
) {

2033 
SCST_USER_REPLY_AND_GET_CMD
:

2034 
	`TRACE_DBG
("%s", "REPLY_AND_GET_CMD");

2035 
»s
 = 
	`dev_u£r_»¶y_g‘_cmd
(
fže
, (
__u£r
 *)
¬g
);

2038 
SCST_USER_REPLY_CMD
:

2039 
	`TRACE_DBG
("%s", "REPLY_CMD");

2040 
»s
 = 
	`dev_u£r_»¶y_cmd
(
fže
, (
__u£r
 *)
¬g
);

2043 
SCST_USER_GET_EXTENDED_CDB
:

2044 
	`TRACE_DBG
("%s", "GET_EXTENDED_CDB");

2045 
»s
 = 
	`dev_u£r_g‘_ext_cdb
(
fže
, (
__u£r
 *)
¬g
);

2048 
SCST_USER_REGISTER_DEVICE
:

2050 
sc¡_u£r_dev_desc
 *
dev_desc
;

2051 
	`TRACE_DBG
("%s", "REGISTER_DEVICE");

2052 
dev_desc
 = 
	`km®loc
((*dev_desc), 
GFP_KERNEL
);

2053 ià(
dev_desc
 =ð
NULL
) {

2054 
»s
 = -
ENOMEM
;

2055 
out
;

2057 
rc
 = 
	`cÝy_äom_u£r
(
dev_desc
, (
__u£r
 *)
¬g
,

2058 (*
dev_desc
));

2059 ià(
rc
 != 0) {

2060 
	`PRINT_ERROR
("FažedØcÝy %ld u£r' by‹s", 
rc
);

2061 
»s
 = -
EFAULT
;

2062 
	`kä“
(
dev_desc
);

2063 
out
;

2065 
	`TRACE_BUFFER
("dev_desc", 
dev_desc
, (*dev_desc));

2066 
dev_desc
->
Çme
[(dev_desc->name)-1] = '\0';

2067 
dev_desc
->
sgv_Çme
[(dev_desc->sgv_name)-1] = '\0';

2068 
»s
 = 
	`dev_u£r_»gi¡”_dev
(
fže
, 
dev_desc
);

2069 
	`kä“
(
dev_desc
);

2073 
SCST_USER_UNREGISTER_DEVICE
:

2074 
	`TRACE_DBG
("%s", "UNREGISTER_DEVICE");

2075 
»s
 = 
	`dev_u£r_uÄegi¡”_dev
(
fže
);

2078 
SCST_USER_FLUSH_CACHE
:

2079 
	`TRACE_DBG
("%s", "FLUSH_CACHE");

2080 
»s
 = 
	`dev_u£r_æush_ÿche
(
fže
);

2083 
SCST_USER_SET_OPTIONS
:

2085 
sc¡_u£r_Ýt
 
Ýt
;

2086 
	`TRACE_DBG
("%s", "SET_OPTIONS");

2087 
rc
 = 
	`cÝy_äom_u£r
(&
Ýt
, (
__u£r
 *)
¬g
, (opt));

2088 ià(
rc
 != 0) {

2089 
	`PRINT_ERROR
("FažedØcÝy %ld u£r' by‹s", 
rc
);

2090 
»s
 = -
EFAULT
;

2091 
out
;

2093 
	`TRACE_BUFFER
("Ýt", &
Ýt
, (opt));

2094 
»s
 = 
	`dev_u£r_£t_Ýt
(
fže
, &
Ýt
);

2098 
SCST_USER_GET_OPTIONS
:

2099 
	`TRACE_DBG
("%s", "GET_OPTIONS");

2100 
»s
 = 
	`dev_u£r_g‘_Ýt
(
fže
, (
__u£r
 *)
¬g
);

2103 
SCST_USER_DEVICE_CAPACITY_CHANGED
:

2104 
	`TRACE_DBG
("%s", "CAPACITY_CHANGED");

2105 
»s
 = 
	`dev_u£r_ÿ·c™y_chªged
(
fže
);

2108 
SCST_USER_PREALLOC_BUFFER
:

2109 
	`TRACE_DBG
("%s", "PREALLOC_BUFFER");

2110 
»s
 = 
	`dev_u£r_´—Îoc_bufãr
(
fže
, (
__u£r
 *)
¬g
);

2114 
	`PRINT_ERROR
("Inv®id ioùÈcmd %x", 
cmd
);

2115 
»s
 = -
EINVAL
;

2116 
out
;

2119 
out
:

2120 
	`TRACE_EXIT_RES
(
»s
);

2121  
»s
;

2122 
	}
}

2124 
	$dev_u£r_pÞl
(
fže
 *fže, 
pÞl_bË
 *
wa™
)

2126 
»s
 = 0;

2127 
sc¡_u£r_dev
 *
dev
;

2129 
	`TRACE_ENTRY
();

2131 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

2132 
dev
 = 
fže
->
´iv©e_d©a
;

2133 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

2134 ià(
	`uÆik–y
(
»s
 != 0)) {

2135 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

2136 
out
;

2138 
	`down_»ad
(&
dev
->
dev_rw£m
);

2139 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

2141 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2143 ià(!
	`li¡_em±y
(&
dev
->
»ady_cmd_li¡
) ||

2144 !
	`li¡_em±y
(&
dev
->
udev_cmd_th»ads
.
aùive_cmd_li¡
)) {

2145 
»s
 |ð
POLLIN
 | 
POLLRDNORM
;

2146 
out_uÆock
;

2149 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2151 
	`TRACE_DBG
("BefÜpÞl_wa™(è(dev %s)", 
dev
->
Çme
);

2152 
	`pÞl_wa™
(
fže
, &
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
, 
wa™
);

2153 
	`TRACE_DBG
("Aá”…Þl_wa™(è(dev %s)", 
dev
->
Çme
);

2155 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2157 ià(!
	`li¡_em±y
(&
dev
->
»ady_cmd_li¡
) ||

2158 !
	`li¡_em±y
(&
dev
->
udev_cmd_th»ads
.
aùive_cmd_li¡
)) {

2159 
»s
 |ð
POLLIN
 | 
POLLRDNORM
;

2160 
out_uÆock
;

2163 
out_uÆock
:

2164 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2166 
	`up_»ad
(&
dev
->
dev_rw£m
);

2168 
out
:

2169 
	`TRACE_EXIT_HRES
(
»s
);

2170  
»s
;

2171 
	}
}

2177 
	$dev_u£r_unjam_cmd
(
sc¡_u£r_cmd
 *
ucmd
, 
busy
,

2178 *
æags
)

2179 
	`__»Ëa£s
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2180 
	`__acquœes
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2182 
¡©e
 = 
ucmd
->state;

2183 
sc¡_u£r_dev
 *
dev
 = 
ucmd
->dev;

2185 
	`TRACE_ENTRY
();

2187 ià(
ucmd
->
this_¡©e_unjammed
)

2188 
out
;

2190 
	`TRACE_MGMT_DBG
("Unjammšg ucmd %°(busy %d, s‹ %x)", 
ucmd
, 
busy
,

2191 
¡©e
);

2193 
ucmd
->
jammed
 = 1;

2194 
ucmd
->
this_¡©e_unjammed
 = 1;

2195 
ucmd
->
£Á_to_u£r
 = 0;

2197 
¡©e
) {

2198 
UCMD_STATE_PARSING
:

2199 
UCMD_STATE_BUF_ALLOCING
:

2200 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
ucmd
->
cmd
->
cmd_æags
))

2201 
ucmd
->
abÜ‹d
 = 1;

2203 ià(
busy
)

2204 
	`sc¡_£t_busy
(
ucmd
->
cmd
);

2206 
	`sc¡_£t_cmd_”rÜ
(
ucmd
->
cmd
,

2207 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2209 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
ucmd
->
cmd
);

2211 ià(
¡©e
 =ð
UCMD_STATE_PARSING
)

2212 
	`sc¡_po¡_·r£
(
ucmd
->
cmd
);

2214 
	`sc¡_po¡_®loc_d©a_buf
(
ucmd
->
cmd
);

2216 
	`TRACE_MGMT_DBG
("Addšg ucmd %°tØaùivli¡", 
ucmd
);

2217 
	`li¡_add
(&
ucmd
->
cmd
->
cmd_li¡_’Œy
,

2218 &
ucmd
->
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

2219 
	`wake_up
(&
ucmd
->
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

2222 
UCMD_STATE_EXECING
:

2223 ià(
æags
 !ð
NULL
)

2224 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
,

2225 *
æags
);

2227 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2229 
	`TRACE_MGMT_DBG
("EXEC: unjammšg ucmd %p", 
ucmd
);

2231 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
ucmd
->
cmd
->
cmd_æags
))

2232 
ucmd
->
abÜ‹d
 = 1;

2234 ià(
busy
)

2235 
	`sc¡_£t_busy
(
ucmd
->
cmd
);

2237 
	`sc¡_£t_cmd_”rÜ
(
ucmd
->
cmd
,

2238 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2241 
ucmd
->
cmd
->
	`sc¡_cmd_dÚe
(ucmd->cmd, 
SCST_CMD_STATE_DEFAULT
,

2242 
SCST_CONTEXT_THREAD
);

2245 ià(
æags
 !ð
NULL
)

2246 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
,

2247 *
æags
);

2249 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2252 
UCMD_STATE_ON_FREEING
:

2253 
UCMD_STATE_ON_CACHE_FREEING
:

2254 
UCMD_STATE_TM_EXECING
:

2255 
UCMD_STATE_ATTACH_SESS
:

2256 
UCMD_STATE_DETACH_SESS
:

2257 ià(
æags
 !ð
NULL
)

2258 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
,

2259 *
æags
);

2261 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2263 
¡©e
) {

2264 
UCMD_STATE_ON_FREEING
:

2265 
	`dev_u£r_´oûss_»¶y_Ú_ä“
(
ucmd
);

2268 
UCMD_STATE_ON_CACHE_FREEING
:

2269 
	`dev_u£r_´oûss_»¶y_Ú_ÿche_ä“
(
ucmd
);

2272 
UCMD_STATE_TM_EXECING
:

2273 
	`dev_u£r_´oûss_»¶y_tm_exec
(
ucmd
,

2274 
SCST_MGMT_STATUS_FAILED
);

2277 
UCMD_STATE_ATTACH_SESS
:

2278 
UCMD_STATE_DETACH_SESS
:

2279 
	`dev_u£r_´oûss_»¶y_£ss
(
ucmd
, -
EFAULT
);

2283 ià(
æags
 !ð
NULL
)

2284 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
,

2285 *
æags
);

2287 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2291 
	`PRINT_CRIT_ERROR
("WrÚg ucmd s‹ %x", 
¡©e
);

2292 
	`sBUG
();

2296 
out
:

2297 
	`TRACE_EXIT
();

2299 
	}
}

2301 
	$dev_u£r_unjam_dev
(
sc¡_u£r_dev
 *
dev
)

2302 
	`__»Ëa£s
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2303 
	`__acquœes
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
)

2305 
i
, 
»s
 = 0;

2306 
sc¡_u£r_cmd
 *
ucmd
;

2308 
	`TRACE_ENTRY
();

2310 
	`TRACE_MGMT_DBG
("Unjammšg dev %p", 
dev
);

2312 
	`sgv_poÞ_æush
(
dev
->
poÞ
);

2313 
	`sgv_poÞ_æush
(
dev
->
poÞ_þu¡
);

2315 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2317 
»³©
:

2318 
i
 = 0; i < ()
	`ARRAY_SIZE
(
dev
->
ucmd_hash
); i++) {

2319 
li¡_h—d
 *
h—d
 = &
dev
->
ucmd_hash
[
i
];

2321 
	`li¡_fÜ_—ch_’Œy
(
ucmd
, 
h—d
, 
hash_li¡_’Œy
) {

2322 
»s
++;

2324 ià(!
ucmd
->
£Á_to_u£r
)

2327 ià(
	`ucmd_g‘_check
(
ucmd
))

2330 
	`TRACE_MGMT_DBG
("ucmd %p, s‹ %x, sc¡_cmd %p", 
ucmd
,

2331 
ucmd
->
¡©e
, ucmd->
cmd
);

2333 
	`dev_u£r_unjam_cmd
(
ucmd
, 0, 
NULL
);

2335 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2336 
	`ucmd_put
(
ucmd
);

2337 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2339 
»³©
;

2343 ià(
	`dev_u£r_´oûss_sc¡_commªds
(
dev
) != 0)

2344 
»³©
;

2346 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2348 
	`TRACE_EXIT_RES
(
»s
);

2349  
»s
;

2350 
	}
}

2352 
	$dev_u£r_´oûss_»¶y_tm_exec
(
sc¡_u£r_cmd
 *
ucmd
,

2353 
¡©us
)

2355 
»s
 = 0;

2357 
	`TRACE_ENTRY
();

2359 
	`TRACE_MGMT_DBG
("TM„•ly (ucmd %p, fÀ%d, stu %d)", 
ucmd
,

2360 
ucmd
->
u£r_cmd
.
tm_cmd
.
â
, 
¡©us
);

2362 ià(
¡©us
 =ð
SCST_MGMT_STATUS_TASK_NOT_EXIST
) {

2370 
¡©us
 = 
SCST_MGMT_STATUS_SUCCESS
;

2373 
	`sc¡_async_mcmd_com¶‘ed
(
ucmd
->
mcmd
, 
¡©us
);

2375 
	`ucmd_put
(
ucmd
);

2377 
	`TRACE_EXIT_RES
(
»s
);

2378  
»s
;

2379 
	}
}

2381 
	$dev_u£r_abÜt_»ady_commªds
(
sc¡_u£r_dev
 *
dev
)

2383 
sc¡_u£r_cmd
 *
ucmd
;

2384 
æags
;

2386 
	`TRACE_ENTRY
();

2388 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

2389 
agaš
:

2390 
	`li¡_fÜ_—ch_’Œy
(
ucmd
, &
dev
->
»ady_cmd_li¡
, 
»ady_cmd_li¡_’Œy
) {

2391 ià((
ucmd
->
cmd
 !ð
NULL
è&& !ucmd->
£’_by_u£r
 &&

2392 
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
ucmd
->
cmd
->
cmd_æags
)) {

2393 
ucmd
->
¡©e
) {

2394 
UCMD_STATE_PARSING
:

2395 
UCMD_STATE_BUF_ALLOCING
:

2396 
UCMD_STATE_EXECING
:

2397 
	`TRACE_MGMT_DBG
("AbÜtšg„—dy ucmd %p", 
ucmd
);

2398 
	`li¡_d–
(&
ucmd
->
»ady_cmd_li¡_’Œy
);

2399 
	`dev_u£r_unjam_cmd
(
ucmd
, 0, &
æags
);

2400 
agaš
;

2405 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

2407 
	`TRACE_EXIT
();

2409 
	}
}

2412 
	$dev_u£r_sk_mgmt_â
(
sc¡_mgmt_cmd
 *
mcmd
,

2413 
sc¡_tgt_dev
 *
tgt_dev
)

2415 
sc¡_u£r_cmd
 *
ucmd
;

2416 
sc¡_u£r_dev
 *
dev
 = 
tgt_dev
->dev->
dh_´iv
;

2417 
sc¡_u£r_cmd
 *
ucmd_to_abÜt
 = 
NULL
;

2419 
	`TRACE_ENTRY
();

2459 
	`dev_u£r_abÜt_»ady_commªds
(
dev
);

2462 
ucmd
 = 
	`dev_u£r_®loc_ucmd
(
dev
, 
GFP_ATOMIC
|
__GFP_NOFAIL
);

2463 ià(
ucmd
 =ð
NULL
) {

2464 
	`PRINT_CRIT_ERROR
("Unableo‡llocate TM %d message "

2465 "(dev %s)", 
mcmd
->
â
, 
dev
->
Çme
);

2466 
out
;

2469 
ucmd
->
u£r_cmd_·ylßd_Ën
 =

2470 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
tm_cmd
) +

2471 (
ucmd
->
u£r_cmd
.
tm_cmd
);

2472 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

2473 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_TASK_MGMT
;

2474 
ucmd
->
u£r_cmd
.
tm_cmd
.
£ss_h
 = ()
tgt_dev
;

2475 
ucmd
->
u£r_cmd
.
tm_cmd
.
â
 = 
mcmd
->fn;

2476 
ucmd
->
u£r_cmd
.
tm_cmd
.
cmd_¢
 = 
mcmd
->cmd_sn;

2477 
ucmd
->
u£r_cmd
.
tm_cmd
.
cmd_¢_£t
 = 
mcmd
->cmd_sn_set;

2479 ià(
mcmd
->
cmd_to_abÜt
 !ð
NULL
) {

2480 
ucmd_to_abÜt
 = 
mcmd
->
cmd_to_abÜt
->
dh_´iv
;

2481 ià(
ucmd_to_abÜt
 !ð
NULL
)

2482 
ucmd
->
u£r_cmd
.
tm_cmd
.
cmd_h_to_abÜt
 = 
ucmd_to_abÜt
->
h
;

2485 
	`TRACE_MGMT_DBG
("Preparing TM ucmd %p (h %d, fn %d, cmd_to_abort %p, "

2486 "ucmd_to_abÜˆ%p, cmd_h_to_abÜˆ%d, mcmd %p)", 
ucmd
, ucmd->
h
,

2487 
mcmd
->
â
, mcmd->
cmd_to_abÜt
, 
ucmd_to_abÜt
,

2488 
ucmd
->
u£r_cmd
.
tm_cmd
.
cmd_h_to_abÜt
, 
mcmd
);

2490 
ucmd
->
mcmd
 = mcmd;

2491 
ucmd
->
¡©e
 = 
UCMD_STATE_TM_EXECING
;

2493 
	`sc¡_´•¬e_async_mcmd
(
mcmd
);

2495 
	`dev_u£r_add_to_»ady
(
ucmd
);

2497 
out
:

2498 
	`TRACE_EXIT
();

2499  
SCST_DEV_TM_NOT_COMPLETED
;

2500 
	}
}

2502 
	$dev_u£r_©ch
(
sc¡_deviû
 *
sdev
)

2504 
»s
 = 0;

2505 
sc¡_u£r_dev
 *
dev
 = 
NULL
, *
d
;

2507 
	`TRACE_ENTRY
();

2509 
	`¥š_lock
(&
dev_li¡_lock
);

2510 
	`li¡_fÜ_—ch_’Œy
(
d
, &
dev_li¡
, 
dev_li¡_’Œy
) {

2511 ià(
	`¡rcmp
(
d
->
Çme
, 
sdev
->
vœt_Çme
) == 0) {

2512 
dev
 = 
d
;

2516 
	`¥š_uÆock
(&
dev_li¡_lock
);

2517 ià(
dev
 =ð
NULL
) {

2518 
	`PRINT_ERROR
("Deviû % nÙ found", 
sdev
->
vœt_Çme
);

2519 
»s
 = -
EINVAL
;

2520 
out
;

2523 
sdev
->
dh_´iv
 = 
dev
;

2524 
sdev
->
t¡
 = 
dev
->tst;

2525 
sdev
->
queue_®g
 = 
dev
->queue_alg;

2526 
sdev
->
swp
 = 
dev
->swp;

2527 
sdev
->
s
 = 
dev
->tas;

2528 
sdev
->
d_£n£
 = 
dev
->d_sense;

2529 
sdev
->
has_own_Üd”_mgmt
 = 
dev
->has_own_order_mgmt;

2531 
dev
->
sdev
 = sdev;

2533 
	`PRINT_INFO
("Attached user space virtual device \"%s\"",

2534 
dev
->
Çme
);

2536 
out
:

2537 
	`TRACE_EXIT
();

2538  
»s
;

2539 
	}
}

2541 
	$dev_u£r_d‘ach
(
sc¡_deviû
 *
sdev
)

2543 
sc¡_u£r_dev
 *
dev
 = 
sdev
->
dh_´iv
;

2545 
	`TRACE_ENTRY
();

2547 
	`TRACE_DBG
("vœt_id %d", 
sdev
->
vœt_id
);

2549 
	`PRINT_INFO
("Detached user space virtual device \"%s\"",

2550 
dev
->
Çme
);

2553 
sdev
->
dh_´iv
 = 
NULL
;

2554 
dev
->
sdev
 = 
NULL
;

2556 
	`TRACE_EXIT
();

2558 
	}
}

2560 
	$dev_u£r_´oûss_»¶y_£ss
(
sc¡_u£r_cmd
 *
ucmd
, 
¡©us
)

2562 
»s
 = 0;

2563 
æags
;

2565 
	`TRACE_ENTRY
();

2567 
	`TRACE_MGMT_DBG
("ucmd %p, cm¶ %p, stu %d", 
ucmd
, ucmd->
cm¶
, 
¡©us
);

2569 
	`¥š_lock_œq§ve
(&
ucmd
->
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

2571 ià(
ucmd
->
¡©e
 =ð
UCMD_STATE_ATTACH_SESS
) {

2572 
	`TRACE_MGMT_DBG
("%s", "ATTACH_SESS finished");

2573 
ucmd
->
»suÉ
 = 
¡©us
;

2574 } ià(
ucmd
->
¡©e
 =ð
UCMD_STATE_DETACH_SESS
) {

2575 
	`TRACE_MGMT_DBG
("%s", "DETACH_SESS finished");

2577 
	`sBUG
();

2579 ià(
ucmd
->
cm¶
 !ð
NULL
)

2580 
	`com¶‘e_®l
(
ucmd
->
cm¶
);

2582 
	`¥š_uÆock_œq»¡Üe
(&
ucmd
->
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

2584 
	`ucmd_put
(
ucmd
);

2586 
	`TRACE_EXIT_RES
(
»s
);

2587  
»s
;

2588 
	}
}

2590 
	$dev_u£r_©ch_tgt
(
sc¡_tgt_dev
 *
tgt_dev
)

2592 
sc¡_u£r_dev
 *
dev
 = 
tgt_dev
->dev->
dh_´iv
;

2593 
»s
 = 0, 
rc
;

2594 
sc¡_u£r_cmd
 *
ucmd
;

2595 
	`DECLARE_COMPLETION_ONSTACK
(
cm¶
);

2596 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
tgt_dev
->
£ss
->
tgt
->tgtt;

2597 
sc¡_tgt
 *
tgt
 = 
tgt_dev
->
£ss
->tgt;

2599 
	`TRACE_ENTRY
();

2601 
tgt_dev
->
aùive_cmd_th»ads
 = &
dev
->
udev_cmd_th»ads
;

2608 ià(
	`‹¡_b™
(
SCST_TGT_DEV_CLUST_POOL
, &
tgt_dev
->
tgt_dev_æags
))

2609 
tgt_dev
->
dh_´iv
 = 
dev
->
poÞ_þu¡
;

2611 
tgt_dev
->
dh_´iv
 = 
dev
->
poÞ
;

2613 
ucmd
 = 
	`dev_u£r_®loc_ucmd
(
dev
, 
GFP_KERNEL
);

2614 ià(
ucmd
 =ð
NULL
)

2615 
out_nomem
;

2617 
ucmd
->
cm¶
 = &cmpl;

2619 
ucmd
->
u£r_cmd_·ylßd_Ën
 = 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
£ss
) +

2620 (
ucmd
->
u£r_cmd
.
£ss
);

2621 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

2622 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_ATTACH_SESS
;

2623 
ucmd
->
u£r_cmd
.
£ss
.
£ss_h
 = ()
tgt_dev
;

2624 
ucmd
->
u£r_cmd
.
£ss
.
lun
 = (
ušt64_t
)
tgt_dev
->lun;

2625 
ucmd
->
u£r_cmd
.
£ss
.
th»ads_num
 = 
tgt_dev
->£ss->
tgt
->
tg‰
->threads_num;

2626 
ucmd
->
u£r_cmd
.
£ss
.
rd_Úly
 = 
tgt_dev
->
acg_dev
->rd_only;

2627 ià(
tg‰
->
g‘_phys_Œª¥Üt_v”siÚ
 !ð
NULL
)

2628 
ucmd
->
u£r_cmd
.
£ss
.
phys_Œª¥Üt_v”siÚ
 =

2629 
tg‰
->
	`g‘_phys_Œª¥Üt_v”siÚ
(
tgt
);

2630 ià(
tg‰
->
g‘_scsi_Œª¥Üt_v”siÚ
 !ð
NULL
)

2631 
ucmd
->
u£r_cmd
.
£ss
.
scsi_Œª¥Üt_v”siÚ
 =

2632 
tg‰
->
	`g‘_scsi_Œª¥Üt_v”siÚ
(
tgt
);

2633 
	`¡¾ýy
(
ucmd
->
u£r_cmd
.
£ss
.
š™ŸtÜ_Çme
,

2634 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
,

2635 (
ucmd
->
u£r_cmd
.
£ss
.
š™ŸtÜ_Çme
)-1);

2636 
	`¡¾ýy
(
ucmd
->
u£r_cmd
.
£ss
.
rg‘_Çme
,

2637 
tgt_dev
->
£ss
->
tgt
->
tgt_Çme
,

2638 (
ucmd
->
u£r_cmd
.
£ss
.
rg‘_Çme
)-1);

2640 
	`TRACE_MGMT_DBG
("Preparing ATTACH_SESS %p (h %d, sess_h %llx, LUN %llx, "

2642 
ucmd
, ucmd->
h
, ucmd->
u£r_cmd
.
£ss
.
£ss_h
,

2643 
ucmd
->
u£r_cmd
.
£ss
.
lun
, ucmd->u£r_cmd.£ss.
th»ads_num
,

2644 
ucmd
->
u£r_cmd
.
£ss
.
rd_Úly
, ucmd->u£r_cmd.£ss.
š™ŸtÜ_Çme
,

2645 
ucmd
->
u£r_cmd
.
£ss
.
rg‘_Çme
);

2647 
ucmd
->
¡©e
 = 
UCMD_STATE_ATTACH_SESS
;

2649 
	`ucmd_g‘
(
ucmd
);

2651 
	`dev_u£r_add_to_»ady
(
ucmd
);

2653 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(
ucmd
->
cm¶
, 
DEV_USER_ATTACH_TIMEOUT
);

2654 ià(
rc
 > 0)

2655 
»s
 = 
ucmd
->
»suÉ
;

2657 
	`PRINT_ERROR
("%s", "ATTACH_SESS commandimeout");

2658 
»s
 = -
EFAULT
;

2661 
	`sBUG_ON
(
	`œqs_di§bËd
());

2663 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2664 
ucmd
->
cm¶
 = 
NULL
;

2665 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

2667 
	`ucmd_put
(
ucmd
);

2669 
out
:

2670 
	`TRACE_EXIT_RES
(
»s
);

2671  
»s
;

2673 
out_nomem
:

2674 
»s
 = -
ENOMEM
;

2675 
out
;

2676 
	}
}

2678 
	$dev_u£r_d‘ach_tgt
(
sc¡_tgt_dev
 *
tgt_dev
)

2680 
sc¡_u£r_dev
 *
dev
 = 
tgt_dev
->dev->
dh_´iv
;

2681 
sc¡_u£r_cmd
 *
ucmd
;

2683 
	`TRACE_ENTRY
();

2689 
ucmd
 = 
	`dev_u£r_®loc_ucmd
(
dev
, 
GFP_KERNEL
|
__GFP_NOFAIL
);

2690 ià(
ucmd
 =ð
NULL
) {

2691 
	`PRINT_CRIT_ERROR
("Unableo‡llocate DETACH_SESS message "

2692 "(dev %s)", 
dev
->
Çme
);

2693 
out
;

2696 
	`TRACE_MGMT_DBG
("P»·ršg DETACH_SESS %°(h %d, sess_h %Îx)", 
ucmd
,

2697 
ucmd
->
h
, ucmd->
u£r_cmd
.
£ss
.
£ss_h
);

2699 
ucmd
->
u£r_cmd_·ylßd_Ën
 = 
	`off£tof
(
sc¡_u£r_g‘_cmd
, 
£ss
) +

2700 (
ucmd
->
u£r_cmd
.
£ss
);

2701 
ucmd
->
u£r_cmd
.
cmd_h
 = ucmd->
h
;

2702 
ucmd
->
u£r_cmd
.
subcode
 = 
SCST_USER_DETACH_SESS
;

2703 
ucmd
->
u£r_cmd
.
£ss
.
£ss_h
 = ()
tgt_dev
;

2705 
ucmd
->
¡©e
 = 
UCMD_STATE_DETACH_SESS
;

2707 
	`dev_u£r_add_to_»ady
(
ucmd
);

2709 
out
:

2710 
	`TRACE_EXIT
();

2712 
	}
}

2715 
	$dev_u£r_£tup_funùiÚs
(
sc¡_u£r_dev
 *
dev
)

2717 
	`TRACE_ENTRY
();

2719 
dev
->
devty³
.
·r£
 = 
dev_u£r_·r£
;

2720 
dev
->
devty³
.
®loc_d©a_buf
 = 
dev_u£r_®loc_d©a_buf
;

2721 
dev
->
devty³
.
dev_dÚe
 = 
NULL
;

2723 ià(
dev
->
·r£_ty³
 !ð
SCST_USER_PARSE_CALL
) {

2724 
dev
->
devty³
.
ty³
) {

2725 
TYPE_DISK
:

2726 
dev
->
g’”ic_·r£
 = 
sc¡_sbc_g’”ic_·r£
;

2727 
dev
->
devty³
.
dev_dÚe
 = 
dev_u£r_disk_dÚe
;

2730 
TYPE_TAPE
:

2731 
dev
->
g’”ic_·r£
 = 
sc¡_³_g’”ic_·r£
;

2732 
dev
->
devty³
.
dev_dÚe
 = 
dev_u£r_³_dÚe
;

2735 
TYPE_MOD
:

2736 
dev
->
g’”ic_·r£
 = 
sc¡_modisk_g’”ic_·r£
;

2737 
dev
->
devty³
.
dev_dÚe
 = 
dev_u£r_disk_dÚe
;

2740 
TYPE_ROM
:

2741 
dev
->
g’”ic_·r£
 = 
sc¡_cdrom_g’”ic_·r£
;

2742 
dev
->
devty³
.
dev_dÚe
 = 
dev_u£r_disk_dÚe
;

2745 
TYPE_MEDIUM_CHANGER
:

2746 
dev
->
g’”ic_·r£
 = 
sc¡_chªg”_g’”ic_·r£
;

2749 
TYPE_PROCESSOR
:

2750 
dev
->
g’”ic_·r£
 = 
sc¡_´oûssÜ_g’”ic_·r£
;

2753 
TYPE_RAID
:

2754 
dev
->
g’”ic_·r£
 = 
sc¡_¿id_g’”ic_·r£
;

2758 
	`PRINT_INFO
("Unknown SCSIype %x, using PARSE_CALL "

2759 "fÜ it", 
dev
->
devty³
.
ty³
);

2760 
dev
->
·r£_ty³
 = 
SCST_USER_PARSE_CALL
;

2764 
dev
->
g’”ic_·r£
 = 
NULL
;

2765 
dev
->
devty³
.
dev_dÚe
 = 
NULL
;

2768 
	`TRACE_EXIT
();

2770 
	}
}

2772 
	$dev_u£r_check_v”siÚ
(cÚ¡ 
sc¡_u£r_dev_desc
 *
dev_desc
)

2774 
¡r
[(
DEV_USER_VERSION
) > 20 ? (DEV_USER_VERSION) : 20];

2775 
»s
 = 0, 
rc
;

2777 
rc
 = 
	`cÝy_äom_u£r
(
¡r
,

2778 (
__u£r
 *)()
dev_desc
->
liûn£_¡r
,

2779 (
¡r
));

2780 ià(
rc
 != 0) {

2781 
	`PRINT_ERROR
("%s", "Unableo get†icense string");

2782 
»s
 = -
EFAULT
;

2783 
out
;

2785 
¡r
[(str)-1] = '\0';

2787 ià((
	`¡rcmp
(
¡r
, "GPL") != 0) &&

2788 (
	`¡rcmp
(
¡r
, "GPL v2") != 0) &&

2789 (
	`¡rcmp
(
¡r
, "Dual BSD/GPL") != 0) &&

2790 (
	`¡rcmp
(
¡r
, "Dual MIT/GPL") != 0) &&

2791 (
	`¡rcmp
(
¡r
, "Dual MPL/GPL") != 0)) {

2793 
	`PRINT_ERROR
("Unsupported†icense of user device %s (%s). "

2795 
dev_desc
->
Çme
, 
¡r
);

2796 
»s
 = -
EPERM
;

2797 
out
;

2800 
rc
 = 
	`cÝy_äom_u£r
(
¡r
,

2801 (
__u£r
 *)()
dev_desc
->
v”siÚ_¡r
,

2802 (
¡r
));

2803 ià(
rc
 != 0) {

2804 
	`PRINT_ERROR
("%s", "Unableo get version string");

2805 
»s
 = -
EFAULT
;

2806 
out
;

2808 
¡r
[(str)-1] = '\0';

2810 ià(
	`¡rcmp
(
¡r
, 
DEV_USER_VERSION
) != 0) {

2812 
	`PRINT_ERROR
("Incorrect version of user device %s (%s). "

2813 "Ex³ùed: %s", 
dev_desc
->
Çme
, 
¡r
,

2814 
DEV_USER_VERSION
);

2815 
»s
 = -
EINVAL
;

2816 
out
;

2819 
out
:

2820  
»s
;

2821 
	}
}

2823 
	$dev_u£r_»gi¡”_dev
(
fže
 *file,

2824 cÚ¡ 
sc¡_u£r_dev_desc
 *
dev_desc
)

2826 
»s
, 
i
;

2827 
sc¡_u£r_dev
 *
dev
, *
d
;

2828 
block
;

2830 
	`TRACE_ENTRY
();

2832 
»s
 = 
	`dev_u£r_check_v”siÚ
(
dev_desc
);

2833 ià(
»s
 != 0)

2834 
out
;

2836 
dev_desc
->
ty³
) {

2837 
TYPE_DISK
:

2838 
TYPE_ROM
:

2839 
TYPE_MOD
:

2840 ià(
dev_desc
->
block_size
 == 0) {

2841 
	`PRINT_ERROR
("Wrong block size %d",

2842 
dev_desc
->
block_size
);

2843 
»s
 = -
EINVAL
;

2844 
out
;

2846 
block
 = 
	`sc¡_ÿlc_block_shiá
(
dev_desc
->
block_size
);

2847 ià(
block
 == -1) {

2848 
»s
 = -
EINVAL
;

2849 
out
;

2853 
block
 = 
dev_desc
->
block_size
;

2857 ià(!
	`Œy_moduË_g‘
(
THIS_MODULE
)) {

2858 
	`PRINT_ERROR
("%s", "Failo get module");

2859 
»s
 = -
ETXTBSY
;

2860 
out
;

2863 
dev
 = 
	`kz®loc
((*dev), 
GFP_KERNEL
);

2864 ià(
dev
 =ð
NULL
) {

2865 
»s
 = -
ENOMEM
;

2866 
out_put
;

2869 
	`š™_rw£m
(&
dev
->
dev_rw£m
);

2870 
	`INIT_LIST_HEAD
(&
dev
->
»ady_cmd_li¡
);

2871 ià(
fže
->
f_æags
 & 
O_NONBLOCK
) {

2872 
	`TRACE_DBG
("%s", "Non-blocking operations");

2873 
dev
->
blockšg
 = 0;

2875 
dev
->
blockšg
 = 1;

2876 
i
 = 0; i < ()
	`ARRAY_SIZE
(
dev
->
ucmd_hash
); i++)

2877 
	`INIT_LIST_HEAD
(&
dev
->
ucmd_hash
[
i
]);

2879 
	`sc¡_š™_th»ads
(&
dev
->
udev_cmd_th»ads
);

2881 
	`¡¾ýy
(
dev
->
Çme
, 
dev_desc
->name, (dev->name)-1);

2883 
	`sc¡_š™_mem_lim
(&
dev
->
udev_mem_lim
);

2885 
	`sú´štf
(
dev
->
devty³
.
Çme
, (dev->devtype.name), "%s",

2886 (
dev_desc
->
sgv_Çme
[0] =ð'\0'è? 
dev
->
Çme
 :

2887 
dev_desc
->
sgv_Çme
);

2888 
dev
->
poÞ
 = 
	`sgv_poÞ_ü—‹
(dev->
devty³
.
Çme
, 
sgv_no_þu¡”šg
,

2889 
dev_desc
->
sgv_sšgË_®loc_·ges
,

2890 
dev_desc
->
sgv_sh¬ed
,

2891 
dev_desc
->
sgv_purge_š‹rv®
);

2892 ià(
dev
->
poÞ
 =ð
NULL
) {

2893 
»s
 = -
ENOMEM
;

2894 
out_deš™_th»ads
;

2896 
	`sgv_poÞ_£t_®loÿtÜ
(
dev
->
poÞ
, 
dev_u£r_®loc_·ges
,

2897 
dev_u£r_ä“_sg_’Œ›s
);

2899 ià(!
dev_desc
->
sgv_di§bË_þu¡”ed_poÞ
) {

2900 
	`sú´štf
(
dev
->
devty³
.
Çme
, (dev->devtype.name),

2902 (
dev_desc
->
sgv_Çme
[0] =ð'\0'è? 
dev
->
Çme
 :

2903 
dev_desc
->
sgv_Çme
);

2904 
dev
->
poÞ_þu¡
 = 
	`sgv_poÞ_ü—‹
(dev->
devty³
.
Çme
,

2905 
sgv_ž_þu¡”šg
,

2906 
dev_desc
->
sgv_sšgË_®loc_·ges
,

2907 
dev_desc
->
sgv_sh¬ed
,

2908 
dev_desc
->
sgv_purge_š‹rv®
);

2909 ià(
dev
->
poÞ_þu¡
 =ð
NULL
) {

2910 
»s
 = -
ENOMEM
;

2911 
out_ä“0
;

2913 
	`sgv_poÞ_£t_®loÿtÜ
(
dev
->
poÞ_þu¡
, 
dev_u£r_®loc_·ges
,

2914 
dev_u£r_ä“_sg_’Œ›s
);

2916 
dev
->
poÞ_þu¡
 = dev->
poÞ
;

2917 
	`sgv_poÞ_g‘
(
dev
->
poÞ_þu¡
);

2920 
	`sú´štf
(
dev
->
devty³
.
Çme
, (dev->devtype.name), "%s",

2921 
dev
->
Çme
);

2922 
dev
->
devty³
.
ty³
 = 
dev_desc
->type;

2923 
dev
->
devty³
.
th»ads_num
 = -1;

2924 
dev
->
devty³
.
·r£_©omic
 = 1;

2925 
dev
->
devty³
.
®loc_d©a_buf_©omic
 = 1;

2926 
dev
->
devty³
.
dev_dÚe_©omic
 = 1;

2927 #ifdeà
CONFIG_SCST_PROC


2928 
dev
->
devty³
.
no_´oc
 = 1;

2930 
dev
->
devty³
.
dev_©Œs
 = 
dev_u£r_dev_©Œs
;

2932 
dev
->
devty³
.
©ch
 = 
dev_u£r_©ch
;

2933 
dev
->
devty³
.
d‘ach
 = 
dev_u£r_d‘ach
;

2934 
dev
->
devty³
.
©ch_tgt
 = 
dev_u£r_©ch_tgt
;

2935 
dev
->
devty³
.
d‘ach_tgt
 = 
dev_u£r_d‘ach_tgt
;

2936 
dev
->
devty³
.
exec
 = 
dev_u£r_exec
;

2937 
dev
->
devty³
.
Ú_ä“_cmd
 = 
dev_u£r_Ú_ä“_cmd
;

2938 
dev
->
devty³
.
sk_mgmt_â
 = 
dev_u£r_sk_mgmt_â
;

2939 ià(
dev_desc
->
’abË_´_cmds_nÙifiÿtiÚs
)

2940 
dev
->
devty³
.
´_cmds_nÙifiÿtiÚs
 = 1;

2942 
	`š™_com¶‘iÚ
(&
dev
->
þ—nup_cm¶
);

2943 
dev
->
block
 = block;

2944 
dev
->
def_block
 = 
block
;

2946 
»s
 = 
	`__dev_u£r_£t_Ýt
(
dev
, &
dev_desc
->
Ýt
);

2947 ià(
»s
 != 0)

2948 
out_ä“
;

2950 
	`TRACE_MEM
("dev %p,‚am%s", 
dev
, dev->
Çme
);

2952 
	`¥š_lock
(&
dev_li¡_lock
);

2954 
	`li¡_fÜ_—ch_’Œy
(
d
, &
dev_li¡
, 
dev_li¡_’Œy
) {

2955 ià(
	`¡rcmp
(
d
->
Çme
, 
dev
->name) == 0) {

2956 
	`PRINT_ERROR
("Device %s‡lreadyƒxist",

2957 
dev
->
Çme
);

2958 
»s
 = -
EEXIST
;

2959 
	`¥š_uÆock
(&
dev_li¡_lock
);

2960 
out_ä“
;

2964 
	`li¡_add_ž
(&
dev
->
dev_li¡_’Œy
, &
dev_li¡
);

2966 
	`¥š_uÆock
(&
dev_li¡_lock
);

2968 
»s
 = 
	`sc¡_»gi¡”_vœtu®_dev_driv”
(&
dev
->
devty³
);

2969 ià(
»s
 < 0)

2970 
out_d–_ä“
;

2972 
dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(&dev->
devty³
, dev->
Çme
);

2973 ià(
dev
->
vœt_id
 < 0) {

2974 
»s
 = 
dev
->
vœt_id
;

2975 
out_uÄeg_hªdËr
;

2978 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

2979 ià(
fže
->
´iv©e_d©a
 !ð
NULL
) {

2980 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

2981 
	`PRINT_ERROR
("%s", "Device‡lready„egistered");

2982 
»s
 = -
EINVAL
;

2983 
out_uÄeg_drv
;

2985 
fže
->
´iv©e_d©a
 = 
dev
;

2986 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

2988 
out
:

2989 
	`TRACE_EXIT_RES
(
»s
);

2990  
»s
;

2992 
out_uÄeg_drv
:

2993 
	`sc¡_uÄegi¡”_vœtu®_deviû
(
dev
->
vœt_id
);

2995 
out_uÄeg_hªdËr
:

2996 
	`sc¡_uÄegi¡”_vœtu®_dev_driv”
(&
dev
->
devty³
);

2998 
out_d–_ä“
:

2999 
	`¥š_lock
(&
dev_li¡_lock
);

3000 
	`li¡_d–
(&
dev
->
dev_li¡_’Œy
);

3001 
	`¥š_uÆock
(&
dev_li¡_lock
);

3003 
out_ä“
:

3004 
	`sgv_poÞ_d–
(
dev
->
poÞ_þu¡
);

3006 
out_ä“0
:

3007 
	`sgv_poÞ_d–
(
dev
->
poÞ
);

3009 
out_deš™_th»ads
:

3010 
	`sc¡_deš™_th»ads
(&
dev
->
udev_cmd_th»ads
);

3012 
	`kä“
(
dev
);

3014 
out_put
:

3015 
	`moduË_put
(
THIS_MODULE
);

3016 
out
;

3017 
	}
}

3019 
	$dev_u£r_uÄegi¡”_dev
(
fže
 *file)

3021 
»s
;

3022 
sc¡_u£r_dev
 *
dev
;

3024 
	`TRACE_ENTRY
();

3026 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

3027 
dev
 = 
fže
->
´iv©e_d©a
;

3028 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3029 ià(
»s
 != 0) {

3030 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3031 
out
;

3033 
	`down_»ad
(&
dev
->
dev_rw£m
);

3034 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3036 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

3037 ià(
»s
 != 0)

3038 
out_up
;

3040 
	`up_»ad
(&
dev
->
dev_rw£m
);

3042 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

3043 
dev
 = 
fže
->
´iv©e_d©a
;

3044 ià(
dev
 =ð
NULL
) {

3045 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3046 
out_»sume
;

3049 
dev
->
blockšg
 = 0;

3050 
	`wake_up_®l
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
);

3052 
	`down_wr™e
(&
dev
->
dev_rw£m
);

3053 
fže
->
´iv©e_d©a
 = 
NULL
;

3054 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3056 
	`dev_u£r_ex™_dev
(
dev
);

3058 
	`up_wr™e
(&
dev
->
dev_rw£m
);

3060 
	`kä“
(
dev
);

3062 
out_»sume
:

3063 
	`sc¡_»sume_aùiv™y
();

3065 
out
:

3066 
	`TRACE_EXIT_RES
(
»s
);

3067  
»s
;

3069 
out_up
:

3070 
	`up_»ad
(&
dev
->
dev_rw£m
);

3071 
out
;

3072 
	}
}

3074 
	$dev_u£r_æush_ÿche
(
fže
 *file)

3076 
»s
;

3077 
sc¡_u£r_dev
 *
dev
;

3079 
	`TRACE_ENTRY
();

3081 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

3082 
dev
 = 
fže
->
´iv©e_d©a
;

3083 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3084 ià(
»s
 != 0) {

3085 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3086 
out
;

3088 
	`down_»ad
(&
dev
->
dev_rw£m
);

3089 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3091 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

3092 ià(
»s
 != 0)

3093 
out_up
;

3095 
	`sgv_poÞ_æush
(
dev
->
poÞ
);

3096 
	`sgv_poÞ_æush
(
dev
->
poÞ_þu¡
);

3098 
	`sc¡_»sume_aùiv™y
();

3100 
out_up
:

3101 
	`up_»ad
(&
dev
->
dev_rw£m
);

3103 
out
:

3104 
	`TRACE_EXIT_RES
(
»s
);

3105  
»s
;

3106 
	}
}

3108 
	$dev_u£r_ÿ·c™y_chªged
(
fže
 *file)

3110 
»s
;

3111 
sc¡_u£r_dev
 *
dev
;

3113 
	`TRACE_ENTRY
();

3115 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

3116 
dev
 = 
fže
->
´iv©e_d©a
;

3117 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3118 ià(
»s
 != 0) {

3119 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3120 
out
;

3122 
	`down_»ad
(&
dev
->
dev_rw£m
);

3123 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3125 
	`sc¡_ÿ·c™y_d©a_chªged
(
dev
->
sdev
);

3127 
	`up_»ad
(&
dev
->
dev_rw£m
);

3129 
out
:

3130 
	`TRACE_EXIT_RES
(
»s
);

3131  
»s
;

3132 
	}
}

3134 
	$dev_u£r_´—Îoc_bufãr
(
fže
 *fže, 
__u£r
 *
¬g
)

3136 
»s
 = 0, 
rc
;

3137 
sc¡_u£r_dev
 *
dev
;

3138 
sc¡_u£r_´—Îoc_bufãr
 
´e
;

3139 
®igÃd_u64
 
pbuf
;

3140 
ušt32_t
 
bufæ’
;

3141 
sc¡_u£r_cmd
 *
ucmd
;

3142 
·ges
, 
sg_út
;

3143 
sgv_poÞ
 *
poÞ
;

3144 
sÿ‰”li¡
 *
sg
;

3146 
	`TRACE_ENTRY
();

3148 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

3149 
dev
 = 
fže
->
´iv©e_d©a
;

3150 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3151 ià(
	`uÆik–y
(
»s
 != 0)) {

3152 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3153 
out
;

3155 
	`down_»ad
(&
dev
->
dev_rw£m
);

3156 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3158 
rc
 = 
	`cÝy_äom_u£r
(&
´e
.
š
, 
¬g
, (pre.in));

3159 ià(
	`uÆik–y
(
rc
 != 0)) {

3160 
	`PRINT_ERROR
("FažedØcÝy %d u£r' by‹s", 
rc
);

3161 
»s
 = -
EFAULT
;

3162 
out_up
;

3165 
	`TRACE_MEM
("Prealloc buffer with size %dKB for dev %s",

3166 
´e
.
š
.
bufæ’
 / 1024, 
dev
->
Çme
);

3167 
	`TRACE_BUFFER
("IÅuˆ·¿m", &
´e
.
š
, (pre.in));

3169 
pbuf
 = 
´e
.
š
.pbuf;

3170 
bufæ’
 = 
´e
.
š
.bufflen;

3172 
ucmd
 = 
	`dev_u£r_®loc_ucmd
(
dev
, 
GFP_KERNEL
);

3173 ià(
ucmd
 =ð
NULL
) {

3174 
»s
 = -
ENOMEM
;

3175 
out_up
;

3178 
ucmd
->
buff_ÿched
 = 1;

3180 
	`TRACE_MEM
("ucmd %p,…buà%Îx", 
ucmd
, 
pbuf
);

3182 ià(
	`uÆik–y
((
pbuf
 & ~
PAGE_MASK
) != 0)) {

3183 
	`PRINT_ERROR
("Suµl›d…buà%Îx i¢'ˆ·g®igÃd", 
pbuf
);

3184 
»s
 = -
EINVAL
;

3185 
out_put
;

3188 
·ges
 = 
	`ÿlc_num_pg
(
pbuf
, 
bufæ’
);

3189 
»s
 = 
	`dev_u£r_m­_buf
(
ucmd
, 
pbuf
, 
·ges
);

3190 ià(
»s
 != 0)

3191 
out_put
;

3193 ià(
´e
.
š
.
fÜ_þu¡_poÞ
)

3194 
poÞ
 = 
dev
->
poÞ_þu¡
;

3196 
poÞ
 = 
dev
->pool;

3198 
sg
 = 
	`sgv_poÞ_®loc
(
poÞ
, 
bufæ’
, 
GFP_KERNEL
, 
SGV_POOL_ALLOC_GET_NEW
,

3199 &
sg_út
, &
ucmd
->
sgv
, &
dev
->
udev_mem_lim
, ucmd);

3200 ià(
sg
 !ð
NULL
) {

3201 
sc¡_u£r_cmd
 *
buf_ucmd
 = 
	`sgv_g‘_´iv
(
ucmd
->
sgv
);

3203 
	`TRACE_MEM
("Buf ucmd %p (sg_cnt %d,†ast seg†en %d, "

3204 "bufæ’ %d)", 
buf_ucmd
, 
sg_út
,

3205 
sg
[
sg_út
-1].
Ëngth
, 
bufæ’
);

3207 
	`EXTRACHECKS_BUG_ON
(
ucmd
 !ð
buf_ucmd
);

3209 
ucmd
->
buf_ucmd
 = buf_ucmd;

3211 
»s
 = -
ENOMEM
;

3212 
out_put
;

3215 
	`dev_u£r_ä“_sgv
(
ucmd
);

3217 
´e
.
out
.
cmd_h
 = 
ucmd
->
h
;

3218 
rc
 = 
	`cÝy_to_u£r
(
¬g
, &
´e
.
out
, (pre.out));

3219 ià(
	`uÆik–y
(
rc
 != 0)) {

3220 
	`PRINT_ERROR
("FažedØcÝyØu£¸%d by‹s", 
rc
);

3221 
»s
 = -
EFAULT
;

3222 
out_put
;

3225 
out_put
:

3226 
	`ucmd_put
(
ucmd
);

3228 
out_up
:

3229 
	`up_»ad
(&
dev
->
dev_rw£m
);

3231 
out
:

3232 
	`TRACE_EXIT_RES
(
»s
);

3233  
»s
;

3234 
	}
}

3236 
	$__dev_u£r_£t_Ýt
(
sc¡_u£r_dev
 *
dev
,

3237 cÚ¡ 
sc¡_u£r_Ýt
 *
Ýt
)

3239 
»s
 = 0;

3241 
	`TRACE_ENTRY
();

3243 
	`TRACE_DBG
("dev %s,…arse_type %x, on_free_cmd_type %x, "

3245 "·¹Ÿl_ËÀ%d", 
dev
->
Çme
, 
Ýt
->
·r£_ty³
,

3246 
Ýt
->
Ú_ä“_cmd_ty³
, o±->
memÜy_»u£_ty³
,

3247 
Ýt
->
·¹Ÿl_Œªsãrs_ty³
, o±->
·¹Ÿl_Ën
);

3249 ià(
Ýt
->
·r£_ty³
 > 
SCST_USER_MAX_PARSE_OPT
 ||

3250 
Ýt
->
Ú_ä“_cmd_ty³
 > 
SCST_USER_MAX_ON_FREE_CMD_OPT
 ||

3251 
Ýt
->
memÜy_»u£_ty³
 > 
SCST_USER_MAX_MEM_REUSE_OPT
 ||

3252 
Ýt
->
·¹Ÿl_Œªsãrs_ty³
 > 
SCST_USER_MAX_PARTIAL_TRANSFERS_OPT
) {

3253 
	`PRINT_ERROR
("%s", "Invalid option");

3254 
»s
 = -
EINVAL
;

3255 
out
;

3258 ià(((
Ýt
->
t¡
 !ð
SCST_CONTR_MODE_ONE_TASK_SET
) &&

3259 (
Ýt
->
t¡
 !ð
SCST_CONTR_MODE_SEP_TASK_SETS
)) ||

3260 ((
Ýt
->
queue_®g
 !ð
SCST_CONTR_MODE_QUEUE_ALG_RESTRICTED_REORDER
) &&

3261 (
Ýt
->
queue_®g
 !ð
SCST_CONTR_MODE_QUEUE_ALG_UNRESTRICTED_REORDER
)) ||

3262 (
Ýt
->
swp
 > 1è|| (Ýt->
s
 > 1è|| (Ýt->
has_own_Üd”_mgmt
 > 1) ||

3263 (
Ýt
->
d_£n£
 > 1)) {

3264 
	`PRINT_ERROR
("Invalid SCSI option (tst %x, queue_alg %x, swp %x,"

3265 "a %x, d_£n£ %d, has_own_Üd”_mgmˆ%x)", 
Ýt
->
t¡
,

3266 
Ýt
->
queue_®g
, o±->
swp
, o±->
s
, o±->
d_£n£
,

3267 
Ýt
->
has_own_Üd”_mgmt
);

3268 
»s
 = -
EINVAL
;

3269 
out
;

3272 
dev
->
·r£_ty³
 = 
Ýt
->parse_type;

3273 
dev
->
Ú_ä“_cmd_ty³
 = 
Ýt
->on_free_cmd_type;

3274 
dev
->
memÜy_»u£_ty³
 = 
Ýt
->memory_reuse_type;

3275 
dev
->
·¹Ÿl_Œªsãrs_ty³
 = 
Ýt
->partial_transfers_type;

3276 
dev
->
·¹Ÿl_Ën
 = 
Ýt
->partial_len;

3278 
dev
->
t¡
 = 
Ýt
->tst;

3279 
dev
->
queue_®g
 = 
Ýt
->queue_alg;

3280 
dev
->
swp
 = 
Ýt
->swp;

3281 
dev
->
s
 = 
Ýt
->tas;

3282 
dev
->
t¡
 = 
Ýt
->tst;

3283 
dev
->
d_£n£
 = 
Ýt
->d_sense;

3284 
dev
->
has_own_Üd”_mgmt
 = 
Ýt
->has_own_order_mgmt;

3285 ià(
dev
->
sdev
 !ð
NULL
) {

3286 
dev
->
sdev
->
t¡
 = 
Ýt
->tst;

3287 
dev
->
sdev
->
queue_®g
 = 
Ýt
->queue_alg;

3288 
dev
->
sdev
->
swp
 = 
Ýt
->swp;

3289 
dev
->
sdev
->
s
 = 
Ýt
->tas;

3290 
dev
->
sdev
->
d_£n£
 = 
Ýt
->d_sense;

3291 
dev
->
sdev
->
has_own_Üd”_mgmt
 = 
Ýt
->has_own_order_mgmt;

3294 
	`dev_u£r_£tup_funùiÚs
(
dev
);

3296 
out
:

3297 
	`TRACE_EXIT_RES
(
»s
);

3298  
»s
;

3299 
	}
}

3301 
	$dev_u£r_£t_Ýt
(
fže
 *fže, cÚ¡ 
sc¡_u£r_Ýt
 *
Ýt
)

3303 
»s
;

3304 
sc¡_u£r_dev
 *
dev
;

3306 
	`TRACE_ENTRY
();

3308 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

3309 
dev
 = 
fže
->
´iv©e_d©a
;

3310 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3311 ià(
»s
 != 0) {

3312 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3313 
out
;

3315 
	`down_»ad
(&
dev
->
dev_rw£m
);

3316 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3318 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

3319 ià(
»s
 != 0)

3320 
out_up
;

3322 
»s
 = 
	`__dev_u£r_£t_Ýt
(
dev
, 
Ýt
);

3324 
	`sc¡_»sume_aùiv™y
();

3326 
out_up
:

3327 
	`up_»ad
(&
dev
->
dev_rw£m
);

3329 
out
:

3330 
	`TRACE_EXIT_RES
(
»s
);

3331  
»s
;

3332 
	}
}

3334 
	$dev_u£r_g‘_Ýt
(
fže
 *fže, 
__u£r
 *
¬g
)

3336 
»s
, 
rc
;

3337 
sc¡_u£r_dev
 *
dev
;

3338 
sc¡_u£r_Ýt
 
Ýt
;

3340 
	`TRACE_ENTRY
();

3342 
	`mu‹x_lock
(&
dev_´iv_mu‹x
);

3343 
dev
 = 
fže
->
´iv©e_d©a
;

3344 
»s
 = 
	`dev_u£r_check_»g
(
dev
);

3345 ià(
»s
 != 0) {

3346 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3347 
out
;

3349 
	`down_»ad
(&
dev
->
dev_rw£m
);

3350 
	`mu‹x_uÆock
(&
dev_´iv_mu‹x
);

3352 
Ýt
.
·r£_ty³
 = 
dev
->parse_type;

3353 
Ýt
.
Ú_ä“_cmd_ty³
 = 
dev
->on_free_cmd_type;

3354 
Ýt
.
memÜy_»u£_ty³
 = 
dev
->memory_reuse_type;

3355 
Ýt
.
·¹Ÿl_Œªsãrs_ty³
 = 
dev
->partial_transfers_type;

3356 
Ýt
.
·¹Ÿl_Ën
 = 
dev
->partial_len;

3357 
Ýt
.
t¡
 = 
dev
->tst;

3358 
Ýt
.
queue_®g
 = 
dev
->queue_alg;

3359 
Ýt
.
s
 = 
dev
->tas;

3360 
Ýt
.
swp
 = 
dev
->swp;

3361 
Ýt
.
d_£n£
 = 
dev
->d_sense;

3362 
Ýt
.
has_own_Üd”_mgmt
 = 
dev
->has_own_order_mgmt;

3364 
	`TRACE_DBG
("dev %s,…arse_type %x, on_free_cmd_type %x, "

3366 "·¹Ÿl_ËÀ%d", 
dev
->
Çme
, 
Ýt
.
·r£_ty³
,

3367 
Ýt
.
Ú_ä“_cmd_ty³
, o±.
memÜy_»u£_ty³
,

3368 
Ýt
.
·¹Ÿl_Œªsãrs_ty³
, o±.
·¹Ÿl_Ën
);

3370 
rc
 = 
	`cÝy_to_u£r
(
¬g
, &
Ýt
, (opt));

3371 ià(
	`uÆik–y
(
rc
 != 0)) {

3372 
	`PRINT_ERROR
("FažedØcÝyØu£¸%d by‹s", 
rc
);

3373 
»s
 = -
EFAULT
;

3374 
out_up
;

3377 
out_up
:

3378 
	`up_»ad
(&
dev
->
dev_rw£m
);

3380 
out
:

3381 
	`TRACE_EXIT_RES
(
»s
);

3382  
»s
;

3383 
	}
}

3385 
	$dev_u¤_·r£
(
sc¡_cmd
 *
cmd
)

3387 
	`sBUG
();

3388  
SCST_CMD_STATE_DEFAULT
;

3389 
	}
}

3391 
	$dev_u£r_ex™_dev
(
sc¡_u£r_dev
 *
dev
)

3393 
	`TRACE_ENTRY
();

3395 
	`TRACE
(
TRACE_MGMT
, "R–—sšg dev %s", 
dev
->
Çme
);

3397 
	`¥š_lock
(&
dev_li¡_lock
);

3398 
	`li¡_d–
(&
dev
->
dev_li¡_’Œy
);

3399 
	`¥š_uÆock
(&
dev_li¡_lock
);

3401 
dev
->
blockšg
 = 0;

3402 
	`wake_up_®l
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
);

3404 
	`¥š_lock
(&
þ—nup_lock
);

3405 
	`li¡_add_ž
(&
dev
->
þ—nup_li¡_’Œy
, &
þ—nup_li¡
);

3406 
	`¥š_uÆock
(&
þ—nup_lock
);

3408 
	`wake_up
(&
þ—nup_li¡_wa™Q
);

3410 
	`sc¡_uÄegi¡”_vœtu®_deviû
(
dev
->
vœt_id
);

3411 
	`sc¡_uÄegi¡”_vœtu®_dev_driv”
(&
dev
->
devty³
);

3413 
	`sgv_poÞ_æush
(
dev
->
poÞ_þu¡
);

3414 
	`sgv_poÞ_æush
(
dev
->
poÞ
);

3416 
	`TRACE_MGMT_DBG
("UÄegi¡”šg fšished (dev %p)", 
dev
);

3418 
dev
->
þ—nup_dÚe
 = 1;

3420 
	`wake_up
(&
þ—nup_li¡_wa™Q
);

3421 
	`wake_up
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
);

3423 
	`wa™_fÜ_com¶‘iÚ
(&
dev
->
þ—nup_cm¶
);

3425 
	`sgv_poÞ_d–
(
dev
->
poÞ_þu¡
);

3426 
	`sgv_poÞ_d–
(
dev
->
poÞ
);

3428 
	`sc¡_deš™_th»ads
(&
dev
->
udev_cmd_th»ads
);

3430 
	`TRACE_MGMT_DBG
("R–—sšg com¶‘ed (dev %p)", 
dev
);

3432 
	`moduË_put
(
THIS_MODULE
);

3434 
	`TRACE_EXIT
();

3436 
	}
}

3438 
	$__dev_u£r_»Ëa£
(*
¬g
)

3440 
sc¡_u£r_dev
 *
dev
 = 
¬g
;

3441 
	`dev_u£r_ex™_dev
(
dev
);

3442 
	`kä“
(
dev
);

3444 
	}
}

3446 
	$dev_u£r_»Ëa£
(
šode
 *šode, 
fže
 *file)

3448 
sc¡_u£r_dev
 *
dev
;

3449 
sk_¡ruù
 *
t
;

3451 
	`TRACE_ENTRY
();

3453 
dev
 = 
fže
->
´iv©e_d©a
;

3454 ià(
dev
 =ð
NULL
)

3455 
out
;

3456 
fže
->
´iv©e_d©a
 = 
NULL
;

3458 
	`TRACE_MGMT_DBG
("GošgØ»Ëa£ dev %s", 
dev
->
Çme
);

3460 
t
 = 
	`kth»ad_run
(
__dev_u£r_»Ëa£
, 
dev
, "scst_usr_released");

3461 ià(
	`IS_ERR
(
t
)) {

3462 
	`PRINT_CRIT_ERROR
("kthread_run() failed (%ld),„eleasing device "

3464 "™ mighˆd—dlock!", 
	`PTR_ERR
(
t
), 
dev
);

3465 
	`__dev_u£r_»Ëa£
(
dev
);

3468 
out
:

3469 
	`TRACE_EXIT
();

3471 
	}
}

3473 
	$dev_u£r_´oûss_þ—nup
(
sc¡_u£r_dev
 *
dev
)

3475 
sc¡_u£r_cmd
 *
ucmd
;

3476 
rc
 = 0, 
»s
 = 1;

3478 
	`TRACE_ENTRY
();

3480 
	`sBUG_ON
(
dev
->
blockšg
);

3481 
	`wake_up_®l
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_wa™Q
);

3484 
rc1
;

3486 
	`TRACE_DBG
("CËªupšg dev %p", 
dev
);

3488 
rc1
 = 
	`dev_u£r_unjam_dev
(
dev
);

3489 ià((
rc1
 =ð0è&& (
rc
 =ð-
EAGAIN
è&& 
dev
->
þ—nup_dÚe
)

3492 
	`¥š_lock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

3494 
rc
 = 
	`dev_u£r_g‘_Ãxt_cmd
(
dev
, &
ucmd
);

3495 ià(
rc
 == 0)

3496 
	`dev_u£r_unjam_cmd
(
ucmd
, 1, 
NULL
);

3498 
	`¥š_uÆock_œq
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
);

3500 ià(
rc
 =ð-
EAGAIN
) {

3501 ià(!
dev
->
þ—nup_dÚe
) {

3502 
	`TRACE_DBG
("NØmÜcommªd (dev %p)", 
dev
);

3503 
out
;

3508 #ifdeà
CONFIG_SCST_EXTRACHECKS


3510 
i
;

3511 
i
 = 0; i < ()
	`ARRAY_SIZE
(
dev
->
ucmd_hash
); i++) {

3512 
li¡_h—d
 *
h—d
 = &
dev
->
ucmd_hash
[
i
];

3513 
sc¡_u£r_cmd
 *
ucmd2
;

3514 
agaš
:

3515 
	`li¡_fÜ_—ch_’Œy
(
ucmd2
, 
h—d
, 
hash_li¡_’Œy
) {

3516 
	`PRINT_ERROR
("Lo¡ ucmd %°(¡©%x,„eà%d)", 
ucmd2
,

3517 
ucmd2
->
¡©e
, 
	`©omic_»ad
(&ucmd2->
ucmd_»f
));

3518 
	`ucmd_put
(
ucmd2
);

3519 
agaš
;

3525 
	`TRACE_DBG
("CËªupšg dÚ(dev %p)", 
dev
);

3526 
	`com¶‘e_®l
(&
dev
->
þ—nup_cm¶
);

3527 
»s
 = 0;

3529 
out
:

3530 
	`TRACE_EXIT_RES
(
»s
);

3531  
»s
;

3532 
	}
}

3534 #iâdeà
CONFIG_SCST_PROC


3536 
ssize_t
 
	$dev_u£r_sysfs_commªds_show
(
kobjeù
 *
kobj
,

3537 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3539 
pos
 = 0, 
µos
, 
i
;

3540 
sc¡_deviû
 *
dev
;

3541 
sc¡_u£r_dev
 *
udev
;

3542 
æags
;

3544 
	`TRACE_ENTRY
();

3546 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

3547 
udev
 = 
dev
->
dh_´iv
;

3549 
	`¥š_lock_œq§ve
(&
udev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

3550 
i
 = 0; i < ()
	`ARRAY_SIZE
(
udev
->
ucmd_hash
); i++) {

3551 
li¡_h—d
 *
h—d
 = &
udev
->
ucmd_hash
[
i
];

3552 
sc¡_u£r_cmd
 *
ucmd
;

3553 
	`li¡_fÜ_—ch_’Œy
(
ucmd
, 
h—d
, 
hash_li¡_’Œy
) {

3554 
µos
 = 
pos
;

3555 
pos
 +ð
	`sú´štf
(&
buf
[pos],

3556 
SCST_SYSFS_BLOCK_SIZE
 - 
pos
,

3560 
ucmd
, ucmd->
¡©e
,

3561 
	`©omic_»ad
(&
ucmd
->
ucmd_»f
),

3562 
ucmd
->
£Á_to_u£r
, ucmd->
£’_by_u£r
,

3563 
ucmd
->
abÜ‹d
, ucmd->
jammed
, ucmd->
cmd
);

3564 ià(
pos
 >ð
SCST_SYSFS_BLOCK_SIZE
-1) {

3565 
µos
 +ð
	`sú´štf
(&
buf
[ppos],

3566 
SCST_SYSFS_BLOCK_SIZE
 - 
µos
, "...\n");

3567 
pos
 = 
µos
;

3572 
	`¥š_uÆock_œq»¡Üe
(&
udev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

3574 
	`TRACE_EXIT_RES
(
pos
);

3575  
pos
;

3576 
	}
}

3583 
	$dev_u£r_»ad_´oc
(
£q_fže
 *
£q
, 
sc¡_dev_ty³
 *
dev_ty³
)

3585 
»s
 = 0;

3586 
sc¡_u£r_dev
 *
dev
;

3587 
æags
;

3589 
	`TRACE_ENTRY
();

3591 
	`¥š_lock
(&
dev_li¡_lock
);

3593 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
dev_li¡
, 
dev_li¡_’Œy
) {

3594 
i
;

3595 
	`£q_´štf
(
£q
, "Deviû % commªds:\n", 
dev
->
Çme
);

3596 
	`¥š_lock_œq§ve
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

3597 
i
 = 0; i < ()
	`ARRAY_SIZE
(
dev
->
ucmd_hash
); i++) {

3598 
li¡_h—d
 *
h—d
 = &
dev
->
ucmd_hash
[
i
];

3599 
sc¡_u£r_cmd
 *
ucmd
;

3600 
	`li¡_fÜ_—ch_’Œy
(
ucmd
, 
h—d
, 
hash_li¡_’Œy
) {

3601 
	`£q_´štf
(
£q
, "ucmd %p (state %x,„ef %d), "

3604 
ucmd
, ucmd->
¡©e
,

3605 
	`©omic_»ad
(&
ucmd
->
ucmd_»f
),

3606 
ucmd
->
£Á_to_u£r
, ucmd->
£’_by_u£r
,

3607 
ucmd
->
abÜ‹d
, ucmd->
jammed
, ucmd->
cmd
);

3610 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
udev_cmd_th»ads
.
cmd_li¡_lock
, 
æags
);

3612 
	`¥š_uÆock
(&
dev_li¡_lock
);

3614 
	`TRACE_EXIT_RES
(
»s
);

3615  
»s
;

3616 
	}
}

3619 
šlše
 
	$‹¡_þ—nup_li¡
()

3621 
»s
 = !
	`li¡_em±y
(&
þ—nup_li¡
) ||

3622 
	`uÆik–y
(
	`kth»ad_should_¡Ý
());

3623  
»s
;

3624 
	}
}

3626 
	$dev_u£r_þ—nup_th»ad
(*
¬g
)

3628 
	`TRACE_ENTRY
();

3630 
	`PRINT_INFO
("CËªu°th»ad s¹ed, PID %d", 
cu¼’t
->
pid
);

3632 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

3634 
	`¥š_lock
(&
þ—nup_lock
);

3635 !
	`kth»ad_should_¡Ý
()) {

3636 
wa™_queue_t
 
wa™
;

3637 
	`š™_wa™queue_’Œy
(&
wa™
, 
cu¼’t
);

3639 ià(!
	`‹¡_þ—nup_li¡
()) {

3640 
	`add_wa™_queue_exþusive
(&
þ—nup_li¡_wa™Q
, &
wa™
);

3642 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

3643 ià(
	`‹¡_þ—nup_li¡
())

3645 
	`¥š_uÆock
(&
þ—nup_lock
);

3646 
	`scheduË
();

3647 
	`¥š_lock
(&
þ—nup_lock
);

3649 
	`£t_cu¼’t_¡©e
(
TASK_RUNNING
);

3650 
	`»move_wa™_queue
(&
þ—nup_li¡_wa™Q
, &
wa™
);

3660 
sc¡_u£r_dev
 *
dev
;

3661 
	`LIST_HEAD
(
þ_devs
);

3663 !
	`li¡_em±y
(&
þ—nup_li¡
)) {

3664 
rc
;

3666 
dev
 = 
	`li¡_’Œy
(
þ—nup_li¡
.
Ãxt
,

3667 
	`ty³of
(*
dev
), 
þ—nup_li¡_’Œy
);

3668 
	`li¡_d–
(&
dev
->
þ—nup_li¡_’Œy
);

3670 
	`¥š_uÆock
(&
þ—nup_lock
);

3671 
rc
 = 
	`dev_u£r_´oûss_þ—nup
(
dev
);

3672 
	`¥š_lock
(&
þ—nup_lock
);

3674 ià(
rc
 != 0)

3675 
	`li¡_add_ž
(&
dev
->
þ—nup_li¡_’Œy
,

3676 &
þ_devs
);

3679 ià(
	`li¡_em±y
(&
þ_devs
))

3682 
	`¥š_uÆock
(&
þ—nup_lock
);

3683 
	`m¦“p
(100);

3684 
	`¥š_lock
(&
þ—nup_lock
);

3686 !
	`li¡_em±y
(&
þ_devs
)) {

3687 
dev
 = 
	`li¡_’Œy
(
þ_devs
.
Ãxt
, 
	`ty³of
(*dev),

3688 
þ—nup_li¡_’Œy
);

3689 
	`li¡_move_ž
(&
dev
->
þ—nup_li¡_’Œy
,

3690 &
þ—nup_li¡
);

3694 
	`¥š_uÆock
(&
þ—nup_lock
);

3700 
	`sBUG_ON
(!
	`li¡_em±y
(&
þ—nup_li¡
));

3702 
	`PRINT_INFO
("CËªu°th»ad PID %d fšished", 
cu¼’t
->
pid
);

3704 
	`TRACE_EXIT
();

3706 
	}
}

3708 
__š™
 
	$š™_sc¡_u£r
()

3710 
»s
 = 0;

3711 
	smax_g‘_»¶y
 {

3713 
sc¡_u£r_g‘_cmd
 
g
;

3714 
sc¡_u£r_»¶y_cmd
 
r
;

3717 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 21)

3718 
þass_deviû
 *
þass_memb”
;

3720 
deviû
 *
dev
;

3723 
	`TRACE_ENTRY
();

3725 #iâdeà
INSIDE_KERNEL_TREE


3726 #ià
	`defšed
(
CONFIG_HIGHMEM4G
è|| defšed(
CONFIG_HIGHMEM64G
)

3727 
	`PRINT_ERROR
("%s", "HIGHMEM kernel configurations‡re‚ot supported. "

3730 
»s
 = -
EINVAL
;

3731 
out
;

3735 
u£r_cmd_ÿch•
 = 
	`KMEM_CACHE
(
sc¡_u£r_cmd
, 
SCST_SLAB_FLAGS
);

3736 ià(
u£r_cmd_ÿch•
 =ð
NULL
) {

3737 
»s
 = -
ENOMEM
;

3738 
out
;

3741 
u£r_g‘_cmd_ÿch•
 = 
	`KMEM_CACHE
(
max_g‘_»¶y
, 
SCST_SLAB_FLAGS
);

3742 ià(
u£r_g‘_cmd_ÿch•
 =ð
NULL
) {

3743 
»s
 = -
ENOMEM
;

3744 
out_ÿche
;

3747 
dev_u£r_devty³
.
moduË
 = 
THIS_MODULE
;

3749 
»s
 = 
	`sc¡_»gi¡”_vœtu®_dev_driv”
(&
dev_u£r_devty³
);

3750 ià(
»s
 < 0)

3751 
out_ÿche1
;

3753 #ifdeà
CONFIG_SCST_PROC


3754 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(&
dev_u£r_devty³
);

3755 ià(
»s
 != 0)

3756 
out_uÄeg
;

3759 
dev_u£r_sysfs_þass
 = 
	`þass_ü—‹
(
THIS_MODULE
, 
DEV_USER_NAME
);

3760 ià(
	`IS_ERR
(
dev_u£r_sysfs_þass
)) {

3761 
	`PRINT_ERROR
("%s", "Unable create sysfs class for SCST user "

3763 
»s
 = 
	`PTR_ERR
(
dev_u£r_sysfs_þass
);

3764 #ifdeà
CONFIG_SCST_PROC


3765 
out_´oc
;

3767 
out_uÄeg
;

3771 
dev_u£r_majÜ
 = 
	`»gi¡”_chrdev
(0, 
DEV_USER_NAME
, &
dev_u£r_fÝs
);

3772 ià(
dev_u£r_majÜ
 < 0) {

3773 
	`PRINT_ERROR
("»gi¡”_chrdev(èçžed: %d", 
»s
);

3774 
»s
 = 
dev_u£r_majÜ
;

3775 
out_þass
;

3778 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 21)

3779 
þass_memb”
 = 
	`þass_deviû_ü—‹
(
dev_u£r_sysfs_þass
, 
NULL
,

3780 
	`MKDEV
(
dev_u£r_majÜ
, 0), 
NULL
, 
DEV_USER_NAME
);

3781 ià(
	`IS_ERR
(
þass_memb”
)) {

3782 
»s
 = 
	`PTR_ERR
(
þass_memb”
);

3783 
out_chrdev
;

3786 
dev
 = 
	`deviû_ü—‹
(
dev_u£r_sysfs_þass
, 
NULL
,

3787 
	`MKDEV
(
dev_u£r_majÜ
, 0),

3788 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 27)

3789 
NULL
,

3791 
DEV_USER_NAME
);

3792 ià(
	`IS_ERR
(
dev
)) {

3793 
»s
 = 
	`PTR_ERR
(
dev
);

3794 
out_chrdev
;

3798 
þ—nup_th»ad
 = 
	`kth»ad_run
(
dev_u£r_þ—nup_th»ad
, 
NULL
,

3800 ià(
	`IS_ERR
(
þ—nup_th»ad
)) {

3801 
»s
 = 
	`PTR_ERR
(
þ—nup_th»ad
);

3802 
	`PRINT_ERROR
("kth»ad_ü—‹(èçžed: %d", 
»s
);

3803 
out_dev
;

3806 
out
:

3807 
	`TRACE_EXIT_RES
(
»s
);

3808  
»s
;

3810 
out_dev
:

3811 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 21)

3812 
	`þass_deviû_de¡roy
(
dev_u£r_sysfs_þass
, 
	`MKDEV
(
dev_u£r_majÜ
, 0));

3814 
	`deviû_de¡roy
(
dev_u£r_sysfs_þass
, 
	`MKDEV
(
dev_u£r_majÜ
, 0));

3817 
out_chrdev
:

3818 
	`uÄegi¡”_chrdev
(
dev_u£r_majÜ
, 
DEV_USER_NAME
);

3820 
out_þass
:

3821 
	`þass_de¡roy
(
dev_u£r_sysfs_þass
);

3823 #ifdeà
CONFIG_SCST_PROC


3824 
out_´oc
:

3825 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
dev_u£r_devty³
);

3828 
out_uÄeg
:

3829 
	`sc¡_uÄegi¡”_dev_driv”
(&
dev_u£r_devty³
);

3831 
out_ÿche1
:

3832 
	`kmem_ÿche_de¡roy
(
u£r_g‘_cmd_ÿch•
);

3834 
out_ÿche
:

3835 
	`kmem_ÿche_de¡roy
(
u£r_cmd_ÿch•
);

3836 
out
;

3837 
	}
}

3839 
__ex™
 
	$ex™_sc¡_u£r
()

3841 
rc
;

3843 
	`TRACE_ENTRY
();

3845 
rc
 = 
	`kth»ad_¡Ý
(
þ—nup_th»ad
);

3846 ià(
rc
 < 0)

3847 
	`TRACE_MGMT_DBG
("kth»ad_¡Ý(èçžed: %d", 
rc
);

3849 
	`uÄegi¡”_chrdev
(
dev_u£r_majÜ
, 
DEV_USER_NAME
);

3850 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 21)

3851 
	`þass_deviû_de¡roy
(
dev_u£r_sysfs_þass
, 
	`MKDEV
(
dev_u£r_majÜ
, 0));

3853 
	`deviû_de¡roy
(
dev_u£r_sysfs_þass
, 
	`MKDEV
(
dev_u£r_majÜ
, 0));

3855 
	`þass_de¡roy
(
dev_u£r_sysfs_þass
);

3857 #ifdeà
CONFIG_SCST_PROC


3858 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(&
dev_u£r_devty³
);

3860 
	`sc¡_uÄegi¡”_vœtu®_dev_driv”
(&
dev_u£r_devty³
);

3862 
	`kmem_ÿche_de¡roy
(
u£r_g‘_cmd_ÿch•
);

3863 
	`kmem_ÿche_de¡roy
(
u£r_cmd_ÿch•
);

3865 
	`TRACE_EXIT
();

3867 
	}
}

3869 
moduË_š™
(
š™_sc¡_u£r
);

3870 
moduË_ex™
(
ex™_sc¡_u£r
);

3872 
MODULE_AUTHOR
("Vladislav Bolkhovitin");

3873 
MODULE_LICENSE
("GPL");

3874 
MODULE_DESCRIPTION
("User space device handler for SCST");

3875 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_user.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

139 cÚ¡ 
	g__moduË_d•’ds
[]

140 
__u£d


141 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

145 
MODULE_INFO
(
¤cv”siÚ
, "D1CC7C1723155708EAC52DB");

147 cÚ¡ 
rh–d©a
 
_rh–d©a
 
__u£d


148 
__©Œibu‹__
((
£ùiÚ
(".rheldata"))) = {

149 .
rh–_majÜ
 = 6,

150 .
	grh–_mšÜ
 = 4,

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_vdisk.c

25 
	~<lšux/fže.h
>

26 
	~<lšux/fs.h
>

27 
	~<lšux/¡ršg.h
>

28 
	~<lšux/ty³s.h
>

29 
	~<lšux/uni¡d.h
>

30 
	~<lšux/¥šlock.h
>

31 
	~<lšux/š™.h
>

32 
	~<lšux/uio.h
>

33 
	~<lšux/li¡.h
>

34 
	~<lšux/ùy³.h
>

35 
	~<lšux/wr™eback.h
>

36 
	~<lšux/vm®loc.h
>

37 
	~<asm/©omic.h
>

38 
	~<lšux/kth»ad.h
>

39 
	~<lšux/sched.h
>

40 
	~<lšux/d–ay.h
>

41 #iâdeà
INSIDE_KERNEL_TREE


42 
	~<lšux/v”siÚ.h
>

44 
	~<asm/div64.h
>

45 
	~<asm/uÇligÃd.h
>

46 
	~<lšux/¦ab.h
>

47 
	~<lšux/bio.h
>

48 
	~<lšux/üc32c.h
>

50 
	#LOG_PREFIX
 "dev_vdisk"

	)

52 #ifdeà
INSIDE_KERNEL_TREE


53 
	~<sc¡/sc¡.h
>

55 
	~"sc¡.h
"

58 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

60 
	#TRACE_ORDER
 0x80000000

	)

62 
sc¡_Œaû_log
 
	gvdisk_loÿl_Œaû_tbl
[] = {

63 { 
TRACE_ORDER
, "order" },

64 { 0, 
NULL
 }

66 
	#Œaû_log_tbl
 
vdisk_loÿl_Œaû_tbl


	)

68 
	#VDISK_TRACE_TBL_HELP
 ", ord”"

	)

72 
	~"sc¡_dev_hªdËr.h
"

75 
	#SCST_FIO_VENDOR
 "SCST_FIO"

	)

76 
	#SCST_BIO_VENDOR
 "SCST_BIO"

	)

78 
	#SCST_FIO_REV
 " 220"

	)

80 
	#MAX_USN_LEN
 (20+1è

	)

82 
	#INQ_BUF_SZ
 256

	)

83 
	#EVPD
 0x01

	)

84 
	#CMDDT
 0x02

	)

86 
	#MSENSE_BUF_SZ
 256

	)

87 
	#DBD
 0x08

	)

88 
	#WP
 0x80

	)

89 
	#DPOFUA
 0x10

	)

90 
	#WCE
 0x04

	)

92 
	#PF
 0x10

	)

93 
	#SP
 0x01

	)

94 
	#PS
 0x80

	)

96 
	#BYTE
 8

	)

97 
	#DEF_DISK_BLOCKSIZE_SHIFT
 9

	)

98 
	#DEF_DISK_BLOCKSIZE
 (1 << 
DEF_DISK_BLOCKSIZE_SHIFT
)

	)

99 
	#DEF_CDROM_BLOCKSIZE_SHIFT
 11

	)

100 
	#DEF_CDROM_BLOCKSIZE
 (1 << 
DEF_CDROM_BLOCKSIZE_SHIFT
)

	)

101 
	#DEF_SECTORS
 56

	)

102 
	#DEF_HEADS
 255

	)

103 
	#LEN_MEM
 (32 * 1024)

	)

104 
	#DEF_RD_ONLY
 0

	)

105 
	#DEF_WRITE_THROUGH
 0

	)

106 
	#DEF_NV_CACHE
 0

	)

107 
	#DEF_O_DIRECT
 0

	)

108 
	#DEF_REMOVABLE
 0

	)

109 
	#DEF_THIN_PROVISIONED
 0

	)

111 
	#VDISK_NULLIO_SIZE
 (3LL*1024*1024*1024*1024/2)

	)

113 
	#DEF_TST
 
SCST_CONTR_MODE_SEP_TASK_SETS


	)

119 
	#DEF_QUEUE_ALG_WT
 
SCST_CONTR_MODE_QUEUE_ALG_UNRESTRICTED_REORDER


	)

120 
	#DEF_QUEUE_ALG
 
SCST_CONTR_MODE_QUEUE_ALG_UNRESTRICTED_REORDER


	)

121 
	#DEF_SWP
 0

	)

122 
	#DEF_TAS
 0

	)

124 
	#DEF_DSENSE
 
SCST_CONTR_MODE_FIXED_SENSE


	)

126 #ifdeà
CONFIG_SCST_PROC


127 
	#VDISK_PROC_HELP
 "h–p"

	)

130 
	ssc¡_vdisk_dev
 {

131 
ušt32_t
 
	mblock_size
;

132 
ušt64_t
 
	mnblocks
;

133 
	mblock_shiá
;

134 
loff_t
 
	mfže_size
;

141 
¥šlock_t
 
	mæags_lock
;

147 
	mrd_Úly
:1;

148 
	mwt_æag
:1;

149 
	mnv_ÿche
:1;

150 
	mo_dœeù_æag
:1;

151 
	mmedŸ_chªged
:1;

152 
	m´ev’t_®low_medium_»mov®
:1;

153 
	mnuÎio
:1;

154 
	mblockio
:1;

155 
	mcdrom_em±y
:1;

156 
	m»movabË
:1;

157 
	mthš_´ovisiÚed
:1;

159 
	mvœt_id
;

160 
	mÇme
[16+1];

162 *
	mfž’ame
;

164 
ušt16_t
 
	mcommªd_£t_v”siÚ
;

167 
	mt10_dev_id_£t
:1;

168 
	mu¢_£t
:1;

169 
	mt10_dev_id
[16+8+2];

170 
	mu¢
[
MAX_USN_LEN
];

172 
sc¡_deviû
 *
	mdev
;

173 
li¡_h—d
 
	mvdev_li¡_’Œy
;

175 
sc¡_dev_ty³
 *
	mvdev_devt
;

178 
	ssc¡_vdisk_thr
 {

179 
sc¡_thr_d©a_hdr
 
	mhdr
;

180 
fže
 *
	mfd
;

181 
block_deviû
 *
	mbdev
;

182 
iovec
 *
	miv
;

183 
	miv_couÁ
;

186 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 29)

187 
	#DEF_NUM_THREADS
 5

	)

190 
	#DEF_NUM_THREADS
 8

	)

192 
	gnum_th»ads
 = 
DEF_NUM_THREADS
;

194 
moduË_·¿m_Çmed
(
num_th»ads
,‚um_th»ads, , 
S_IRUGO
);

195 
MODULE_PARM_DESC
(
num_th»ads
, "vdiskhreads count");

197 
vdisk_©ch
(
sc¡_deviû
 *
dev
);

198 
vdisk_d‘ach
(
sc¡_deviû
 *
dev
);

199 
vdisk_©ch_tgt
(
sc¡_tgt_dev
 *
tgt_dev
);

200 
vdisk_d‘ach_tgt
(
sc¡_tgt_dev
 *
tgt_dev
);

201 
vdisk_·r£
(
sc¡_cmd
 *);

202 
vdisk_do_job
(
sc¡_cmd
 *
cmd
);

203 
vcdrom_·r£
(
sc¡_cmd
 *);

204 
vcdrom_exec
(
sc¡_cmd
 *
cmd
);

205 
vdisk_exec_»ad
(
sc¡_cmd
 *
cmd
,

206 
sc¡_vdisk_thr
 *
thr
, 
loff_t
 
loff
);

207 
vdisk_exec_wr™e
(
sc¡_cmd
 *
cmd
,

208 
sc¡_vdisk_thr
 *
thr
, 
loff_t
 
loff
);

209 
blockio_exec_rw
(
sc¡_cmd
 *
cmd
, 
sc¡_vdisk_thr
 *
thr
,

210 
u64
 
lba_¡¬t
, 
wr™e
);

211 
vdisk_blockio_æush
(
block_deviû
 *
bdev
, 
gå_t
 
gå_mask
,

212 
boÞ
 
»pÜt_”rÜ
);

213 
vdisk_exec_v”ify
(
sc¡_cmd
 *
cmd
,

214 
sc¡_vdisk_thr
 *
thr
, 
loff_t
 
loff
);

215 
vdisk_exec_»ad_ÿ·c™y
(
sc¡_cmd
 *
cmd
);

216 
vdisk_exec_»ad_ÿ·c™y16
(
sc¡_cmd
 *
cmd
);

217 
vdisk_exec_»pÜt_gs
(
sc¡_cmd
 *
cmd
);

218 
vdisk_exec_šquœy
(
sc¡_cmd
 *
cmd
);

219 
vdisk_exec_»que¡_£n£
(
sc¡_cmd
 *
cmd
);

220 
vdisk_exec_mode_£n£
(
sc¡_cmd
 *
cmd
);

221 
vdisk_exec_mode_£Ëù
(
sc¡_cmd
 *
cmd
);

222 
vdisk_exec_log
(
sc¡_cmd
 *
cmd
);

223 
vdisk_exec_»ad_toc
(
sc¡_cmd
 *
cmd
);

224 
vdisk_exec_´ev’t_®low_medium_»mov®
(
sc¡_cmd
 *
cmd
);

225 
vdisk_exec_unm­
(
sc¡_cmd
 *
cmd
, 
sc¡_vdisk_thr
 *
thr
);

226 
vdisk_fsync
(
sc¡_vdisk_thr
 *
thr
, 
loff_t
 
loff
,

227 
loff_t
 
Ën
, 
sc¡_cmd
 *
cmd
, 
sc¡_deviû
 *
dev
);

228 #ifdeà
CONFIG_SCST_PROC


229 
vdisk_»ad_´oc
(
£q_fže
 *
£q
,

230 
sc¡_dev_ty³
 *
dev_ty³
);

231 
vdisk_wr™e_´oc
(*
bufãr
, **
¡¬t
, 
off_t
 
off£t
,

232 
Ëngth
, *
eof
, 
sc¡_dev_ty³
 *
dev_ty³
);

233 
vcdrom_»ad_´oc
(
£q_fže
 *
£q
,

234 
sc¡_dev_ty³
 *
dev_ty³
);

235 
vcdrom_wr™e_´oc
(*
bufãr
, **
¡¬t
, 
off_t
 
off£t
,

236 
Ëngth
, *
eof
, 
sc¡_dev_ty³
 *
dev_ty³
);

238 
ssize_t
 
vdisk_add_fžeio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
);

239 
ssize_t
 
vdisk_add_blockio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
);

240 
ssize_t
 
vdisk_add_nuÎio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
);

241 
ssize_t
 
vdisk_d–_deviû
(cÚ¡ *
deviû_Çme
);

242 
ssize_t
 
vcdrom_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
);

243 
ssize_t
 
vcdrom_d–_deviû
(cÚ¡ *
deviû_Çme
);

245 
vdisk_sk_mgmt_â
(
sc¡_mgmt_cmd
 *
mcmd
,

246 
sc¡_tgt_dev
 *
tgt_dev
);

247 
ušt64_t
 
vdisk_g’_dev_id_num
(cÚ¡ *
vœt_dev_Çme
);

251 #iâdeà
CONFIG_SCST_PROC


253 
ssize_t
 
vdev_sysfs_size_show
(
kobjeù
 *
kobj
,

254 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

255 
ssize_t
 
vdisk_sysfs_blocksize_show
(
kobjeù
 *
kobj
,

256 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

257 
ssize_t
 
vdisk_sysfs_rd_Úly_show
(
kobjeù
 *
kobj
,

258 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

259 
ssize_t
 
vdisk_sysfs_wt_show
(
kobjeù
 *
kobj
,

260 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

261 
ssize_t
 
vdisk_sysfs__show
(
kobjeù
 *
kobj
,

262 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

263 
ssize_t
 
vdisk_sysfs_nv_ÿche_show
(
kobjeù
 *
kobj
,

264 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

265 
ssize_t
 
vdisk_sysfs_o_dœeù_show
(
kobjeù
 *
kobj
,

266 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

267 
ssize_t
 
vdisk_sysfs_»movabË_show
(
kobjeù
 *
kobj
,

268 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

269 
ssize_t
 
vdev_sysfs_fž’ame_show
(
kobjeù
 *
kobj
,

270 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

271 
ssize_t
 
vdisk_sysfs_»sync_size_¡Üe
(
kobjeù
 *
kobj
,

272 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

273 
ssize_t
 
vdev_sysfs_t10_dev_id_¡Üe
(
kobjeù
 *
kobj
,

274 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

275 
ssize_t
 
vdev_sysfs_t10_dev_id_show
(
kobjeù
 *
kobj
,

276 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

277 
ssize_t
 
vdev_sysfs_u¢_¡Üe
(
kobjeù
 *
kobj
,

278 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

279 
ssize_t
 
vdev_sysfs_u¢_show
(
kobjeù
 *
kobj
,

280 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

282 
ssize_t
 
vcdrom_sysfs_fž’ame_¡Üe
(
kobjeù
 *
kobj
,

283 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

285 
kobj_©Œibu‹
 
	gvdev_size_©Œ
 =

286 
__ATTR
(
size_mb
, 
S_IRUGO
, 
vdev_sysfs_size_show
, 
NULL
);

287 
kobj_©Œibu‹
 
	gvdisk_blocksize_©Œ
 =

288 
__ATTR
(
blocksize
, 
S_IRUGO
, 
vdisk_sysfs_blocksize_show
, 
NULL
);

289 
kobj_©Œibu‹
 
	gvdisk_rd_Úly_©Œ
 =

290 
__ATTR
(
»ad_Úly
, 
S_IRUGO
, 
vdisk_sysfs_rd_Úly_show
, 
NULL
);

291 
kobj_©Œibu‹
 
	gvdisk_wt_©Œ
 =

292 
__ATTR
(
wr™e_through
, 
S_IRUGO
, 
vdisk_sysfs_wt_show
, 
NULL
);

293 
kobj_©Œibu‹
 
	gvdisk__©Œ
 =

294 
__ATTR
(
thš_´ovisiÚed
, 
S_IRUGO
, 
vdisk_sysfs__show
, 
NULL
);

295 
kobj_©Œibu‹
 
	gvdisk_nv_ÿche_©Œ
 =

296 
__ATTR
(
nv_ÿche
, 
S_IRUGO
, 
vdisk_sysfs_nv_ÿche_show
, 
NULL
);

297 
kobj_©Œibu‹
 
	gvdisk_o_dœeù_©Œ
 =

298 
__ATTR
(
o_dœeù
, 
S_IRUGO
, 
vdisk_sysfs_o_dœeù_show
, 
NULL
);

299 
kobj_©Œibu‹
 
	gvdisk_»movabË_©Œ
 =

300 
__ATTR
(
»movabË
, 
S_IRUGO
, 
vdisk_sysfs_»movabË_show
, 
NULL
);

301 
kobj_©Œibu‹
 
	gvdisk_fž’ame_©Œ
 =

302 
__ATTR
(
fž’ame
, 
S_IRUGO
, 
vdev_sysfs_fž’ame_show
, 
NULL
);

303 
kobj_©Œibu‹
 
	gvdisk_»sync_size_©Œ
 =

304 
__ATTR
(
»sync_size
, 
S_IWUSR
, 
NULL
, 
vdisk_sysfs_»sync_size_¡Üe
);

305 
kobj_©Œibu‹
 
	gvdev_t10_dev_id_©Œ
 =

306 
__ATTR
(
t10_dev_id
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_t10_dev_id_show
,

307 
vdev_sysfs_t10_dev_id_¡Üe
);

308 
kobj_©Œibu‹
 
	gvdev_u¢_©Œ
 =

309 
__ATTR
(
u¢
, 
S_IWUSR
|
S_IRUGO
, 
vdev_sysfs_u¢_show
, 
vdev_sysfs_u¢_¡Üe
);

311 
kobj_©Œibu‹
 
	gvcdrom_fž’ame_©Œ
 =

312 
__ATTR
(
fž’ame
, 
S_IRUGO
|
S_IWUSR
, 
vdev_sysfs_fž’ame_show
,

313 
vcdrom_sysfs_fž’ame_¡Üe
);

315 cÚ¡ 
©Œibu‹
 *
	gvdisk_fžeio_©Œs
[] = {

316 &
vdev_size_©Œ
.
©Œ
,

317 &
vdisk_blocksize_©Œ
.
©Œ
,

318 &
vdisk_rd_Úly_©Œ
.
©Œ
,

319 &
vdisk_wt_©Œ
.
©Œ
,

320 &
vdisk__©Œ
.
©Œ
,

321 &
vdisk_nv_ÿche_©Œ
.
©Œ
,

322 &
vdisk_o_dœeù_©Œ
.
©Œ
,

323 &
vdisk_»movabË_©Œ
.
©Œ
,

324 &
vdisk_fž’ame_©Œ
.
©Œ
,

325 &
vdisk_»sync_size_©Œ
.
©Œ
,

326 &
vdev_t10_dev_id_©Œ
.
©Œ
,

327 &
vdev_u¢_©Œ
.
©Œ
,

328 
NULL
,

331 cÚ¡ 
©Œibu‹
 *
	gvdisk_blockio_©Œs
[] = {

332 &
vdev_size_©Œ
.
©Œ
,

333 &
vdisk_blocksize_©Œ
.
©Œ
,

334 &
vdisk_rd_Úly_©Œ
.
©Œ
,

335 &
vdisk_nv_ÿche_©Œ
.
©Œ
,

336 &
vdisk_»movabË_©Œ
.
©Œ
,

337 &
vdisk_fž’ame_©Œ
.
©Œ
,

338 &
vdisk_»sync_size_©Œ
.
©Œ
,

339 &
vdev_t10_dev_id_©Œ
.
©Œ
,

340 &
vdev_u¢_©Œ
.
©Œ
,

341 &
vdisk__©Œ
.
©Œ
,

342 
NULL
,

345 cÚ¡ 
©Œibu‹
 *
	gvdisk_nuÎio_©Œs
[] = {

346 &
vdev_size_©Œ
.
©Œ
,

347 &
vdisk_blocksize_©Œ
.
©Œ
,

348 &
vdisk_rd_Úly_©Œ
.
©Œ
,

349 &
vdisk_»movabË_©Œ
.
©Œ
,

350 &
vdev_t10_dev_id_©Œ
.
©Œ
,

351 &
vdev_u¢_©Œ
.
©Œ
,

352 
NULL
,

355 cÚ¡ 
©Œibu‹
 *
	gvcdrom_©Œs
[] = {

356 &
vdev_size_©Œ
.
©Œ
,

357 &
vcdrom_fž’ame_©Œ
.
©Œ
,

358 &
vdev_t10_dev_id_©Œ
.
©Œ
,

359 &
vdev_u¢_©Œ
.
©Œ
,

360 
NULL
,

366 
DEFINE_MUTEX
(
sc¡_vdisk_mu‹x
);

369 
DEFINE_RWLOCK
(
vdisk_£rŸl_rwlock
);

372 
LIST_HEAD
(
vdev_li¡
);

374 
kmem_ÿche
 *
	gvdisk_thr_ÿch•
;

381 
sc¡_dev_ty³
 
	gvdisk_fže_devty³
 = {

382 .
Çme
 = "vdisk_fileio",

383 .
	gty³
 = 
TYPE_DISK
,

384 .
	gexec_sync
 = 1,

385 .
	gth»ads_num
 = -1,

386 .
	g·r£_©omic
 = 1,

387 .
	gdev_dÚe_©omic
 = 1,

388 .
	g©ch
 = 
vdisk_©ch
,

389 .
	gd‘ach
 = 
vdisk_d‘ach
,

390 .
	g©ch_tgt
 = 
vdisk_©ch_tgt
,

391 .
	gd‘ach_tgt
 = 
vdisk_d‘ach_tgt
,

392 .
	g·r£
 = 
vdisk_·r£
,

393 .
	gexec
 = 
vdisk_do_job
,

394 .
	gsk_mgmt_â
 = 
vdisk_sk_mgmt_â
,

395 #ifdeà
CONFIG_SCST_PROC


396 .
	g»ad_´oc
 = 
vdisk_»ad_´oc
,

397 .
	gwr™e_´oc
 = 
vdisk_wr™e_´oc
,

399 .
	gadd_deviû
 = 
vdisk_add_fžeio_deviû
,

400 .
	gd–_deviû
 = 
vdisk_d–_deviû
,

401 .
	gdev_©Œs
 = 
vdisk_fžeio_©Œs
,

402 .
	gadd_deviû_·¿m‘”s
 = "filename, blocksize, write_through, "

405 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

406 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

407 .
	gŒaû_æags
 = &
Œaû_æag
,

408 .
	gŒaû_tbl
 = 
vdisk_loÿl_Œaû_tbl
,

409 #iâdeà
CONFIG_SCST_PROC


410 .
	gŒaû_tbl_h–p
 = 
VDISK_TRACE_TBL_HELP
,

415 
kmem_ÿche
 *
	gblockio_wÜk_ÿch•
;

417 
sc¡_dev_ty³
 
	gvdisk_blk_devty³
 = {

418 .
Çme
 = "vdisk_blockio",

419 .
	gty³
 = 
TYPE_DISK
,

420 .
	gth»ads_num
 = 1,

421 .
	g·r£_©omic
 = 1,

422 .
	gdev_dÚe_©omic
 = 1,

423 #ifdeà
CONFIG_SCST_PROC


424 .
	gno_´oc
 = 1,

426 .
	g©ch
 = 
vdisk_©ch
,

427 .
	gd‘ach
 = 
vdisk_d‘ach
,

428 .
	g©ch_tgt
 = 
vdisk_©ch_tgt
,

429 .
	gd‘ach_tgt
 = 
vdisk_d‘ach_tgt
,

430 .
	g·r£
 = 
vdisk_·r£
,

431 .
	gexec
 = 
vdisk_do_job
,

432 .
	gsk_mgmt_â
 = 
vdisk_sk_mgmt_â
,

433 #iâdeà
CONFIG_SCST_PROC


434 .
	gadd_deviû
 = 
vdisk_add_blockio_deviû
,

435 .
	gd–_deviû
 = 
vdisk_d–_deviû
,

436 .
	gdev_©Œs
 = 
vdisk_blockio_©Œs
,

437 .
	gadd_deviû_·¿m‘”s
 = "filename, blocksize,‚v_cache,„ead_only, "

440 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

441 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

442 .
	gŒaû_æags
 = &
Œaû_æag
,

443 .
	gŒaû_tbl
 = 
vdisk_loÿl_Œaû_tbl
,

444 #iâdeà
CONFIG_SCST_PROC


445 .
	gŒaû_tbl_h–p
 = 
VDISK_TRACE_TBL_HELP
,

450 
sc¡_dev_ty³
 
	gvdisk_nuÎ_devty³
 = {

451 .
Çme
 = "vdisk_nullio",

452 .
	gty³
 = 
TYPE_DISK
,

453 .
	gth»ads_num
 = 0,

454 .
	g·r£_©omic
 = 1,

455 .
	gdev_dÚe_©omic
 = 1,

456 #ifdeà
CONFIG_SCST_PROC


457 .
	gno_´oc
 = 1,

459 .
	g©ch
 = 
vdisk_©ch
,

460 .
	gd‘ach
 = 
vdisk_d‘ach
,

461 .
	g©ch_tgt
 = 
vdisk_©ch_tgt
,

462 .
	gd‘ach_tgt
 = 
vdisk_d‘ach_tgt
,

463 .
	g·r£
 = 
vdisk_·r£
,

464 .
	gexec
 = 
vdisk_do_job
,

465 .
	gsk_mgmt_â
 = 
vdisk_sk_mgmt_â
,

466 #iâdeà
CONFIG_SCST_PROC


467 .
	gadd_deviû
 = 
vdisk_add_nuÎio_deviû
,

468 .
	gd–_deviû
 = 
vdisk_d–_deviû
,

469 .
	gdev_©Œs
 = 
vdisk_nuÎio_©Œs
,

470 .
	gadd_deviû_·¿m‘”s
 = "blocksize,„ead_only,„emovable",

472 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

473 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

474 .
	gŒaû_æags
 = &
Œaû_æag
,

475 .
	gŒaû_tbl
 = 
vdisk_loÿl_Œaû_tbl
,

476 #iâdeà
CONFIG_SCST_PROC


477 .
	gŒaû_tbl_h–p
 = 
VDISK_TRACE_TBL_HELP
,

482 
sc¡_dev_ty³
 
	gvcdrom_devty³
 = {

483 .
Çme
 = "vcdrom",

484 .
	gty³
 = 
TYPE_ROM
,

485 .
	gexec_sync
 = 1,

486 .
	gth»ads_num
 = -1,

487 .
	g·r£_©omic
 = 1,

488 .
	gdev_dÚe_©omic
 = 1,

489 .
	g©ch
 = 
vdisk_©ch
,

490 .
	gd‘ach
 = 
vdisk_d‘ach
,

491 .
	g©ch_tgt
 = 
vdisk_©ch_tgt
,

492 .
	gd‘ach_tgt
 = 
vdisk_d‘ach_tgt
,

493 .
	g·r£
 = 
vcdrom_·r£
,

494 .
	gexec
 = 
vcdrom_exec
,

495 .
	gsk_mgmt_â
 = 
vdisk_sk_mgmt_â
,

496 #ifdeà
CONFIG_SCST_PROC


497 .
	g»ad_´oc
 = 
vcdrom_»ad_´oc
,

498 .
	gwr™e_´oc
 = 
vcdrom_wr™e_´oc
,

500 .
	gadd_deviû
 = 
vcdrom_add_deviû
,

501 .
	gd–_deviû
 = 
vcdrom_d–_deviû
,

502 .
	gdev_©Œs
 = 
vcdrom_©Œs
,

503 .
	gadd_deviû_·¿m‘”s
 = 
NULL
,

505 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

506 .
	gdeçuÉ_Œaû_æags
 = 
SCST_DEFAULT_DEV_LOG_FLAGS
,

507 .
	gŒaû_æags
 = &
Œaû_æag
,

508 .
	gŒaû_tbl
 = 
vdisk_loÿl_Œaû_tbl
,

509 #iâdeà
CONFIG_SCST_PROC


510 .
	gŒaû_tbl_h–p
 = 
VDISK_TRACE_TBL_HELP
,

515 
sc¡_vdisk_thr
 
	gnuÎio_thr_d©a
;

517 #ifdeà
CONFIG_SCST_PROC


519 *
	gvdisk_´oc_h–p_¡ršg
 =

526 *
	gvcdrom_´oc_h–p_¡ršg
 =

530 
	gsc¡_vdisk_ID
;

532 
moduË_·¿m_Çmed
(
sc¡_vdisk_ID
, sc¡_vdisk_ID, , 
S_IRUGO
);

533 
MODULE_PARM_DESC
(
sc¡_vdisk_ID
, "SCST virtual disk subsystem ID");

537 cÚ¡ *
	$vdev_g‘_fž’ame
(cÚ¡ 
sc¡_vdisk_dev
 *
vœt_dev
)

539 ià(
vœt_dev
->
fž’ame
 !ð
NULL
)

540  
vœt_dev
->
fž’ame
;

543 
	}
}

546 
fže
 *
	$vdev_Ý’_fd
(cÚ¡ 
sc¡_vdisk_dev
 *
vœt_dev
)

548 
Ý’_æags
 = 0;

549 
fže
 *
fd
;

551 
	`TRACE_ENTRY
();

553 ià(
vœt_dev
->
dev
->
rd_Úly
)

554 
Ý’_æags
 |ð
O_RDONLY
;

556 
Ý’_æags
 |ð
O_RDWR
;

557 ià(
vœt_dev
->
o_dœeù_æag
)

558 
Ý’_æags
 |ð
O_DIRECT
;

559 ià(
vœt_dev
->
wt_æag
 && !vœt_dev->
nv_ÿche
)

560 
Ý’_æags
 |ð
O_SYNC
;

561 
	`TRACE_DBG
("Opening file %s, flags 0x%x",

562 
vœt_dev
->
fž’ame
, 
Ý’_æags
);

563 
fd
 = 
	`fžp_Ý’
(
vœt_dev
->
fž’ame
, 
O_LARGEFILE
 | 
Ý’_æags
, 0600);

565 
	`TRACE_EXIT
();

566  
fd
;

567 
	}
}

569 
	$vdisk_blockio_check_æush_suµÜt
(
sc¡_vdisk_dev
 *
vœt_dev
)

571 
šode
 *inode;

572 
fže
 *
fd
;

574 
	`TRACE_ENTRY
();

576 ià(!
vœt_dev
->
blockio
 || vœt_dev->
rd_Úly
 || vœt_dev->
nv_ÿche
)

577 
out
;

579 
fd
 = 
	`fžp_Ý’
(
vœt_dev
->
fž’ame
, 
O_LARGEFILE
, 0600);

580 ià(
	`IS_ERR
(
fd
)) {

581 
	`PRINT_ERROR
("filp_open(%s)„eturnedƒrror %ld",

582 
vœt_dev
->
fž’ame
, 
	`PTR_ERR
(
fd
));

583 
out
;

586 
šode
 = 
fd
->
f_d’Œy
->
d_šode
;

588 ià(!
	`S_ISBLK
(
šode
->
i_mode
)) {

589 
	`PRINT_ERROR
("% i NOT‡ block deviû", 
vœt_dev
->
fž’ame
);

590 
out_þo£
;

593 ià(
	`vdisk_blockio_æush
(
šode
->
i_bdev
, 
GFP_KERNEL
, 
çl£
) != 0) {

594 
	`PRINT_WARNING
("Device %s doesn't support barriers, switching "

596 
vœt_dev
->
fž’ame
);

597 
vœt_dev
->
nv_ÿche
 = 1;

600 
out_þo£
:

601 
	`fžp_þo£
(
fd
, 
NULL
);

603 
out
:

604 
	`TRACE_EXIT
();

606 
	}
}

608 
	$vdisk_check__suµÜt
(
sc¡_vdisk_dev
 *
vœt_dev
)

610 
šode
 *inode;

611 
fže
 *
fd
;

612 
boÞ
 
suµÜ‹d
 = 
çl£
;

614 
	`TRACE_ENTRY
();

616 ià(
vœt_dev
->
rd_Úly
 || !vœt_dev->
thš_´ovisiÚed
)

617 
out
;

619 
fd
 = 
	`fžp_Ý’
(
vœt_dev
->
fž’ame
, 
O_LARGEFILE
, 0600);

620 ià(
	`IS_ERR
(
fd
)) {

621 
	`PRINT_ERROR
("filp_open(%s)„eturnedƒrror %ld",

622 
vœt_dev
->
fž’ame
, 
	`PTR_ERR
(
fd
));

623 
out
;

626 
šode
 = 
fd
->
f_d’Œy
->
d_šode
;

628 ià(
vœt_dev
->
blockio
) {

629 ià(!
	`S_ISBLK
(
šode
->
i_mode
)) {

630 
	`PRINT_ERROR
("%s is NOT‡ block device",

631 
vœt_dev
->
fž’ame
);

632 
out_þo£
;

634 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 31)

635 
suµÜ‹d
 = 
	`blk_queue_disÿrd
(
	`bdev_g‘_queue
(
šode
->
i_bdev
));

637 
suµÜ‹d
 = 
çl£
;

646 
suµÜ‹d
 = (
šode
->
i_Ý
->
Œunÿ‹_¿nge
 !ð
NULL
);

649 ià(!
suµÜ‹d
) {

650 
	`PRINT_WARNING
("Device %s doesn't supporthin "

652 
vœt_dev
->
fž’ame
);

653 
vœt_dev
->
thš_´ovisiÚed
 = 0;

656 
out_þo£
:

657 
	`fžp_þo£
(
fd
, 
NULL
);

659 
out
:

660 
	`TRACE_EXIT
();

662 
	}
}

665 
	$vdisk_g‘_fže_size
(cÚ¡ *
fž’ame
, 
boÞ
 
blockio
,

666 
loff_t
 *
fže_size
)

668 
šode
 *inode;

669 
»s
 = 0;

670 
fže
 *
fd
;

672 
	`TRACE_ENTRY
();

674 *
fže_size
 = 0;

676 
fd
 = 
	`fžp_Ý’
(
fž’ame
, 
O_LARGEFILE
 | 
O_RDONLY
, 0600);

677 ià(
	`IS_ERR
(
fd
)) {

678 
»s
 = 
	`PTR_ERR
(
fd
);

679 
	`PRINT_ERROR
("fžp_Ý’(%sè»tuºedƒ¼Ü %d", 
fž’ame
, 
»s
);

680 
out
;

683 
šode
 = 
fd
->
f_d’Œy
->
d_šode
;

685 ià(
blockio
 && !
	`S_ISBLK
(
šode
->
i_mode
)) {

686 
	`PRINT_ERROR
("Fž% i NOT‡ block deviû", 
fž’ame
);

687 
»s
 = -
EINVAL
;

688 
out_þo£
;

691 ià(
	`S_ISREG
(
šode
->
i_mode
))

693 ià(
	`S_ISBLK
(
šode
->
i_mode
))

694 
šode
 = inode->
i_bdev
->
bd_šode
;

696 
»s
 = -
EINVAL
;

697 
out_þo£
;

700 *
fže_size
 = 
šode
->
i_size
;

702 
out_þo£
:

703 
	`fžp_þo£
(
fd
, 
NULL
);

705 
out
:

706 
	`TRACE_EXIT_RES
(
»s
);

707  
»s
;

708 
	}
}

711 
sc¡_vdisk_dev
 *
	$vdev_fšd
(cÚ¡ *
Çme
)

713 
sc¡_vdisk_dev
 *
»s
, *
vv
;

715 
	`TRACE_ENTRY
();

717 
»s
 = 
NULL
;

718 
	`li¡_fÜ_—ch_’Œy
(
vv
, &
vdev_li¡
, 
vdev_li¡_’Œy
) {

719 ià(
	`¡rcmp
(
vv
->
Çme
,‚ame) == 0) {

720 
»s
 = 
vv
;

725 
	`TRACE_EXIT_HRES
(()
»s
);

726  
»s
;

727 
	}
}

729 
	$vdisk_©ch
(
sc¡_deviû
 *
dev
)

731 
»s
 = 0;

732 
loff_t
 
”r
;

733 
sc¡_vdisk_dev
 *
vœt_dev
;

735 
	`TRACE_ENTRY
();

737 
	`TRACE_DBG
("vœt_id %d (%s)", 
dev
->
vœt_id
, dev->
vœt_Çme
);

739 ià(
dev
->
vœt_id
 == 0) {

740 
	`PRINT_ERROR
("%s", "Not‡ virtual device");

741 
»s
 = -
EINVAL
;

742 
out
;

749 
vœt_dev
 = 
	`vdev_fšd
(
dev
->
vœt_Çme
);

750 ià(
vœt_dev
 =ð
NULL
) {

751 
	`PRINT_ERROR
("Deviû % nÙ found", 
dev
->
vœt_Çme
);

752 
»s
 = -
EINVAL
;

753 
out
;

756 
vœt_dev
->
dev
 = dev;

758 
dev
->
rd_Úly
 = 
vœt_dev
->rd_only;

760 ià(!
vœt_dev
->
cdrom_em±y
) {

761 ià(
vœt_dev
->
nuÎio
)

762 
”r
 = 
VDISK_NULLIO_SIZE
;

764 
»s
 = 
	`vdisk_g‘_fže_size
(
vœt_dev
->
fž’ame
,

765 
vœt_dev
->
blockio
, &
”r
);

766 ià(
»s
 != 0)

767 
out
;

769 
vœt_dev
->
fže_size
 = 
”r
;

771 
	`TRACE_DBG
("sizoàfže: %Îd", ()
”r
);

773 
	`vdisk_blockio_check_æush_suµÜt
(
vœt_dev
);

774 
	`vdisk_check__suµÜt
(
vœt_dev
);

776 
vœt_dev
->
fže_size
 = 0;

778 
vœt_dev
->
nblocks
 = vœt_dev->
fže_size
 >> vœt_dev->
block_shiá
;

780 ià(!
vœt_dev
->
cdrom_em±y
) {

781 
	`PRINT_INFO
("Attached SCSIarget virtual %s %s "

784 (
dev
->
ty³
 =ð
TYPE_DISK
) ? "disk" : "cdrom",

785 
vœt_dev
->
Çme
, 
	`vdev_g‘_fž’ame
(virt_dev),

786 
vœt_dev
->
fže_size
 >> 20, vœt_dev->
block_size
,

787 ()
vœt_dev
->
nblocks
,

788 ()
vœt_dev
->
nblocks
/64/32,

789 
vœt_dev
->
nblocks
 < 64*32

792 
	`PRINT_INFO
("Attachedƒmpty SCSIarget virtual cdrom %s",

793 
vœt_dev
->
Çme
);

796 
dev
->
dh_´iv
 = 
vœt_dev
;

798 
dev
->
t¡
 = 
DEF_TST
;

799 
dev
->
d_£n£
 = 
DEF_DSENSE
;

800 ià(
vœt_dev
->
wt_æag
 && !vœt_dev->
nv_ÿche
)

801 
dev
->
queue_®g
 = 
DEF_QUEUE_ALG_WT
;

803 
dev
->
queue_®g
 = 
DEF_QUEUE_ALG
;

804 
dev
->
swp
 = 
DEF_SWP
;

805 
dev
->
s
 = 
DEF_TAS
;

807 
out
:

808 
	`TRACE_EXIT
();

809  
»s
;

810 
	}
}

813 
	$vdisk_d‘ach
(
sc¡_deviû
 *
dev
)

815 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

817 
	`TRACE_ENTRY
();

819 
	`TRACE_DBG
("vœt_id %d", 
dev
->
vœt_id
);

821 
	`PRINT_INFO
("Detached virtual device %s (\"%s\")",

822 
vœt_dev
->
Çme
, 
	`vdev_g‘_fž’ame
(virt_dev));

825 
dev
->
dh_´iv
 = 
NULL
;

827 
	`TRACE_EXIT
();

829 
	}
}

831 
	$vdisk_ä“_thr_d©a
(
sc¡_thr_d©a_hdr
 *
d
)

833 
sc¡_vdisk_thr
 *
thr
 =

834 
	`cÚš”_of
(
d
, 
sc¡_vdisk_thr
, 
hdr
);

836 
	`TRACE_ENTRY
();

838 ià(
thr
->
fd
)

839 
	`fžp_þo£
(
thr
->
fd
, 
NULL
);

841 
	`kä“
(
thr
->
iv
);

843 
	`kmem_ÿche_ä“
(
vdisk_thr_ÿch•
, 
thr
);

845 
	`TRACE_EXIT
();

847 
	}
}

849 
sc¡_vdisk_thr
 *
	$vdisk_š™_thr_d©a
(

850 
sc¡_tgt_dev
 *
tgt_dev
, 
gå_t
 
gå_mask
)

852 
sc¡_vdisk_thr
 *
»s
;

853 
sc¡_vdisk_dev
 *
vœt_dev
 = 
tgt_dev
->
dev
->
dh_´iv
;

855 
	`TRACE_ENTRY
();

857 
	`EXTRACHECKS_BUG_ON
(
vœt_dev
->
nuÎio
);

859 
»s
 = 
	`kmem_ÿche_z®loc
(
vdisk_thr_ÿch•
, 
gå_mask
);

860 ià(
»s
 =ð
NULL
) {

861 
	`PRINT_ERROR
("Unableo‡llocate struct scst_vdisk_thr"

862 " (siz%zd)", (*
»s
));

863 
out
;

866 ià(!
vœt_dev
->
cdrom_em±y
) {

867 
»s
->
fd
 = 
	`vdev_Ý’_fd
(
vœt_dev
);

868 ià(
	`IS_ERR
(
»s
->
fd
)) {

869 
	`PRINT_ERROR
("filp_open(%s)„eturned‡nƒrror %ld",

870 
vœt_dev
->
fž’ame
, 
	`PTR_ERR
(
»s
->
fd
));

871 
out_ä“
;

873 ià(
vœt_dev
->
blockio
)

874 
»s
->
bdev
 =„es->
fd
->
f_d’Œy
->
d_šode
->
i_bdev
;

876 
»s
->
bdev
 = 
NULL
;

878 
»s
->
fd
 = 
NULL
;

880 
	`sc¡_add_thr_d©a
(
tgt_dev
, &
»s
->
hdr
, 
vdisk_ä“_thr_d©a
);

882 
out
:

883 
	`TRACE_EXIT_HRES
(()
»s
);

884  
»s
;

886 
out_ä“
:

887 
	`kmem_ÿche_ä“
(
vdisk_thr_ÿch•
, 
»s
);

888 
»s
 = 
NULL
;

889 
out
;

890 
	}
}

892 
	$vdisk_©ch_tgt
(
sc¡_tgt_dev
 *
tgt_dev
)

894 
»s
 = 0;

896 
	`TRACE_ENTRY
();

900 
	`TRACE_EXIT_RES
(
»s
);

901  
»s
;

902 
	}
}

904 
	$vdisk_d‘ach_tgt
(
sc¡_tgt_dev
 *
tgt_dev
)

906 
	`TRACE_ENTRY
();

908 
	`sc¡_d–_®l_thr_d©a
(
tgt_dev
);

910 
	`TRACE_EXIT
();

912 
	}
}

914 
	$vdisk_do_job
(
sc¡_cmd
 *
cmd
)

916 
rc
, 
»s
;

917 
ušt64_t
 
lba_¡¬t
 = 0;

918 
loff_t
 
d©a_Ën
 = 0;

919 
ušt8_t
 *
cdb
 = 
cmd
->cdb;

920 
Ýcode
 = 
cdb
[0];

921 
loff_t
 
loff
;

922 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

923 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

924 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

925 
sc¡_thr_d©a_hdr
 *
d
;

926 
sc¡_vdisk_thr
 *
thr
 = 
NULL
;

927 
fua
 = 0;

929 
	`TRACE_ENTRY
();

931 
cmd
->
queue_ty³
) {

932 
SCST_CMD_QUEUE_ORDERED
:

933 
	`TRACE
(
TRACE_ORDER
, "ORDERED cmd %°(Ý %x)", 
cmd
, cmd->
cdb
[0]);

935 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
:

936 
	`TRACE
(
TRACE_ORDER
, "HQ cmd %°(Ý %x)", 
cmd
, cmd->
cdb
[0]);

942 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

943 ià(
	`uÆik–y
(
rc
 != 0))

944 
out_dÚe
;

946 
cmd
->
¡©us
 = 0;

947 
cmd
->
msg_¡©us
 = 0;

948 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

949 
cmd
->
driv”_¡©us
 = 0;

951 ià(!
vœt_dev
->
nuÎio
) {

952 
d
 = 
	`sc¡_fšd_thr_d©a
(
tgt_dev
);

953 ià(
	`uÆik–y
(
d
 =ð
NULL
)) {

954 
thr
 = 
	`vdisk_š™_thr_d©a
(
tgt_dev
,

955 
cmd
->
noio_mem_®loc
 ? 
GFP_NOIO
 : 
GFP_KERNEL
);

956 ià(
thr
 =ð
NULL
) {

957 
	`sc¡_£t_busy
(
cmd
);

958 
out_com¶
;

960 
	`sc¡_thr_d©a_g‘
(&
thr
->
hdr
);

962 
thr
 = 
	`cÚš”_of
(
d
, 
sc¡_vdisk_thr
, 
hdr
);

964 
thr
 = &
nuÎio_thr_d©a
;

965 
	`sc¡_thr_d©a_g‘
(&
thr
->
hdr
);

968 
Ýcode
) {

969 
READ_6
:

970 
WRITE_6
:

971 
VERIFY_6
:

972 
lba_¡¬t
 = (((
cdb
[1] & 0x1fè<< (
BYTE
 * 2)) +

973 (
cdb
[2] << (
BYTE
 * 1)) +

974 (
cdb
[3] << (
BYTE
 * 0)));

975 
d©a_Ën
 = 
cmd
->
bufæ’
;

977 
READ_10
:

978 
READ_12
:

979 
WRITE_10
:

980 
WRITE_12
:

981 
VERIFY
:

982 
WRITE_VERIFY
:

983 
WRITE_VERIFY_12
:

984 
VERIFY_12
:

985 
lba_¡¬t
 |ð((
u64
)
cdb
[2]) << 24;

986 
lba_¡¬t
 |ð((
u64
)
cdb
[3]) << 16;

987 
lba_¡¬t
 |ð((
u64
)
cdb
[4]) << 8;

988 
lba_¡¬t
 |ð((
u64
)
cdb
[5]);

989 
d©a_Ën
 = 
cmd
->
bufæ’
;

991 
READ_16
:

992 
WRITE_16
:

993 
WRITE_VERIFY_16
:

994 
VERIFY_16
:

995 
lba_¡¬t
 |ð((
u64
)
cdb
[2]) << 56;

996 
lba_¡¬t
 |ð((
u64
)
cdb
[3]) << 48;

997 
lba_¡¬t
 |ð((
u64
)
cdb
[4]) << 40;

998 
lba_¡¬t
 |ð((
u64
)
cdb
[5]) << 32;

999 
lba_¡¬t
 |ð((
u64
)
cdb
[6]) << 24;

1000 
lba_¡¬t
 |ð((
u64
)
cdb
[7]) << 16;

1001 
lba_¡¬t
 |ð((
u64
)
cdb
[8]) << 8;

1002 
lba_¡¬t
 |ð((
u64
)
cdb
[9]);

1003 
d©a_Ën
 = 
cmd
->
bufæ’
;

1005 
SYNCHRONIZE_CACHE
:

1006 
lba_¡¬t
 |ð((
u64
)
cdb
[2]) << 24;

1007 
lba_¡¬t
 |ð((
u64
)
cdb
[3]) << 16;

1008 
lba_¡¬t
 |ð((
u64
)
cdb
[4]) << 8;

1009 
lba_¡¬t
 |ð((
u64
)
cdb
[5]);

1010 
d©a_Ën
 = ((
cdb
[7] << (
BYTE
 * 1)) + (cdb[8] << (BYTE * 0)))

1011 << 
vœt_dev
->
block_shiá
;

1012 ià(
d©a_Ën
 == 0)

1013 
d©a_Ën
 = 
vœt_dev
->
fže_size
 -

1014 ((
loff_t
)
lba_¡¬t
 << 
vœt_dev
->
block_shiá
);

1018 
loff
 = (
loff_t
)
lba_¡¬t
 << 
vœt_dev
->
block_shiá
;

1019 
	`TRACE_DBG
("cmd %p,†ba_¡¬ˆ%Îd,†ofà%Îd, d©a_ËÀ%Îd", 
cmd
,

1020 ()
lba_¡¬t
,

1021 ()
loff
,

1022 ()
d©a_Ën
);

1023 ià(
	`uÆik–y
(
loff
 < 0è|| uÆik–y(
d©a_Ën
 < 0) ||

1024 
	`uÆik–y
((
loff
 + 
d©a_Ën
è> 
vœt_dev
->
fže_size
)) {

1025 
	`PRINT_INFO
("Access beyondheƒnd ofhe device "

1027 ()
loff
,

1028 ()
vœt_dev
->
fže_size
,

1029 ()
d©a_Ën
);

1030 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

1031 
sc¡_£n£_block_out_¿nge_”rÜ
));

1032 
out_com¶
;

1035 
Ýcode
) {

1036 
WRITE_10
:

1037 
WRITE_12
:

1038 
WRITE_16
:

1039 
fua
 = (
cdb
[1] & 0x8);

1040 ià(
fua
) {

1041 
	`TRACE
(
TRACE_ORDER
, "FUA:†off=%lld, "

1042 "d©a_Ën=%Îd", ()
loff
,

1043 ()
d©a_Ën
);

1048 
Ýcode
) {

1049 
READ_6
:

1050 
READ_10
:

1051 
READ_12
:

1052 
READ_16
:

1053 ià(
vœt_dev
->
blockio
) {

1054 
	`blockio_exec_rw
(
cmd
, 
thr
, 
lba_¡¬t
, 0);

1055 
out_thr
;

1057 
	`vdisk_exec_»ad
(
cmd
, 
thr
, 
loff
);

1059 
WRITE_6
:

1060 
WRITE_10
:

1061 
WRITE_12
:

1062 
WRITE_16
:

1064 ià(
vœt_dev
->
blockio
) {

1065 
	`blockio_exec_rw
(
cmd
, 
thr
, 
lba_¡¬t
, 1);

1066 
out_thr
;

1068 
	`vdisk_exec_wr™e
(
cmd
, 
thr
, 
loff
);

1070 ià(
fua
)

1071 
	`vdisk_fsync
(
thr
, 
loff
, 
d©a_Ën
, 
cmd
, 
dev
);

1074 
WRITE_VERIFY
:

1075 
WRITE_VERIFY_12
:

1076 
WRITE_VERIFY_16
:

1079 
	`vdisk_exec_wr™e
(
cmd
, 
thr
, 
loff
);

1081 ià(
	`scsi_¡©us_is_good
(
cmd
->
¡©us
))

1082 
	`vdisk_exec_v”ify
(
cmd
, 
thr
, 
loff
);

1085 
SYNCHRONIZE_CACHE
:

1087 
immed
 = 
cdb
[1] & 0x2;

1088 
	`TRACE
(
TRACE_ORDER
, "SYNCHRONIZE_CACHE: "

1090 ()
loff
,

1091 ()
d©a_Ën
, 
immed
);

1092 ià(
immed
) {

1093 
	`sc¡_cmd_g‘
(
cmd
);

1094 
cmd
->
com¶‘ed
 = 1;

1095 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
,

1096 
SCST_CONTEXT_SAME
);

1097 
	`vdisk_fsync
(
thr
, 
loff
, 
d©a_Ën
, 
NULL
, 
dev
);

1099 
	`sc¡_cmd_put
(
cmd
);

1100 
out_thr
;

1102 
	`vdisk_fsync
(
thr
, 
loff
, 
d©a_Ën
, 
cmd
, 
dev
);

1106 
VERIFY_6
:

1107 
VERIFY
:

1108 
VERIFY_12
:

1109 
VERIFY_16
:

1110 
	`vdisk_exec_v”ify
(
cmd
, 
thr
, 
loff
);

1112 
MODE_SENSE
:

1113 
MODE_SENSE_10
:

1114 
	`vdisk_exec_mode_£n£
(
cmd
);

1116 
MODE_SELECT
:

1117 
MODE_SELECT_10
:

1118 
	`vdisk_exec_mode_£Ëù
(
cmd
);

1120 
LOG_SELECT
:

1121 
LOG_SENSE
:

1122 
	`vdisk_exec_log
(
cmd
);

1124 
ALLOW_MEDIUM_REMOVAL
:

1125 
	`vdisk_exec_´ev’t_®low_medium_»mov®
(
cmd
);

1127 
READ_TOC
:

1128 
	`vdisk_exec_»ad_toc
(
cmd
);

1130 
START_STOP
:

1131 
	`vdisk_fsync
(
thr
, 0, 
vœt_dev
->
fže_size
, 
cmd
, 
dev
);

1133 
RESERVE
:

1134 
RESERVE_10
:

1135 
RELEASE
:

1136 
RELEASE_10
:

1137 
TEST_UNIT_READY
:

1139 
INQUIRY
:

1140 
	`vdisk_exec_šquœy
(
cmd
);

1142 
REQUEST_SENSE
:

1143 
	`vdisk_exec_»que¡_£n£
(
cmd
);

1145 
READ_CAPACITY
:

1146 
	`vdisk_exec_»ad_ÿ·c™y
(
cmd
);

1148 
SERVICE_ACTION_IN
:

1149 ià((
cmd
->
cdb
[1] & 0x1fè=ð
SAI_READ_CAPACITY_16
) {

1150 
	`vdisk_exec_»ad_ÿ·c™y16
(
cmd
);

1153 
out_šv®id_Ýcode
;

1154 
UNMAP
:

1155 
	`vdisk_exec_unm­
(
cmd
, 
thr
);

1157 
MAINTENANCE_IN
:

1158 
cmd
->
cdb
[1] & 0x1f) {

1159 
MI_REPORT_TARGET_PGS
:

1160 
	`vdisk_exec_»pÜt_gs
(
cmd
);

1163 
out_šv®id_Ýcode
;

1166 
REPORT_LUNS
:

1168 
out_šv®id_Ýcode
;

1171 
out_com¶
:

1172 
cmd
->
com¶‘ed
 = 1;

1174 
out_dÚe
:

1175 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

1177 
out_thr
:

1178 ià(
	`lik–y
(
thr
 !ð
NULL
))

1179 
	`sc¡_thr_d©a_put
(&
thr
->
hdr
);

1181 
»s
 = 
SCST_EXEC_COMPLETED
;

1183 
	`TRACE_EXIT_RES
(
»s
);

1184  
»s
;

1186 
out_šv®id_Ýcode
:

1187 
	`TRACE_DBG
("Inv®id opcod%d", 
Ýcode
);

1188 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1189 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

1190 
out_com¶
;

1191 
	}
}

1193 
	$vdisk_g‘_block_shiá
(
sc¡_cmd
 *
cmd
)

1195 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

1196  
vœt_dev
->
block_shiá
;

1197 
	}
}

1199 
	$vdisk_·r£
(
sc¡_cmd
 *
cmd
)

1201 
	`sc¡_sbc_g’”ic_·r£
(
cmd
, 
vdisk_g‘_block_shiá
);

1202  
SCST_CMD_STATE_DEFAULT
;

1203 
	}
}

1205 
	$vcdrom_·r£
(
sc¡_cmd
 *
cmd
)

1207 
	`sc¡_cdrom_g’”ic_·r£
(
cmd
, 
vdisk_g‘_block_shiá
);

1208  
SCST_CMD_STATE_DEFAULT
;

1209 
	}
}

1211 
	$vcdrom_exec
(
sc¡_cmd
 *
cmd
)

1213 
»s
 = 
SCST_EXEC_COMPLETED
;

1214 
Ýcode
 = 
cmd
->
cdb
[0];

1215 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

1217 
	`TRACE_ENTRY
();

1219 
cmd
->
¡©us
 = 0;

1220 
cmd
->
msg_¡©us
 = 0;

1221 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

1222 
cmd
->
driv”_¡©us
 = 0;

1224 ià(
vœt_dev
->
cdrom_em±y
 && (
Ýcode
 !ð
INQUIRY
)) {

1225 
	`TRACE_DBG
("%s", "CDROMƒmpty");

1226 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1227 
	`SCST_LOAD_SENSE
(
sc¡_£n£_nÙ_»ady
));

1228 
out_dÚe
;

1231 ià(
vœt_dev
->
medŸ_chªged
 && 
	`sc¡_is_ua_commªd
(
cmd
)) {

1232 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

1233 ià(
vœt_dev
->
medŸ_chªged
) {

1234 
vœt_dev
->
medŸ_chªged
 = 0;

1235 
	`TRACE_DBG
("%s", "Reporting media changed");

1236 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1237 
	`SCST_LOAD_SENSE
(
sc¡_£n£_medium_chªged_UA
));

1238 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

1239 
out_dÚe
;

1241 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

1244 
»s
 = 
	`vdisk_do_job
(
cmd
);

1246 
out
:

1247 
	`TRACE_EXIT_RES
(
»s
);

1248  
»s
;

1250 
out_dÚe
:

1251 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

1252 
out
;

1253 
	}
}

1255 
ušt64_t
 
	$vdisk_g’_dev_id_num
(cÚ¡ *
vœt_dev_Çme
)

1257 
ušt32_t
 
dev_id_num
;

1259 
dev_id_num
 = 
	`üc32c
(0, 
vœt_dev_Çme
, 
	`¡¾’
(virt_dev_name)+1);

1261 #ifdeà
CONFIG_SCST_PROC


1262  ((
ušt64_t
)
sc¡_vdisk_ID
 << 32è| 
dev_id_num
;

1264  ((
ušt64_t
)
	`sc¡_g‘_£tup_id
(è<< 32è| 
dev_id_num
;

1266 
	}
}

1268 
	$vdisk_exec_unm­
(
sc¡_cmd
 *
cmd
, 
sc¡_vdisk_thr
 *
thr
)

1270 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

1271 
ssize_t
 
Ëngth
 = 0;

1272 
fže
 *
fd
 = 
thr
->fd;

1273 
šode
 *inode;

1274 
ušt8_t
 *
add»ss
;

1275 
off£t
, 
desütÜ_Ën
, 
tÙ®_Ën
;

1277 
	`TRACE_ENTRY
();

1279 ià(
	`uÆik–y
(!
vœt_dev
->
thš_´ovisiÚed
)) {

1280 
	`TRACE_DBG
("%s", "Invalid opcode UNMAP");

1281 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1282 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

1283 
out
;

1286 ià(
	`uÆik–y
(
cmd
->
cdb
[1] & 1)) {

1288 
	`TRACE_DBG
("%s", "Invalid ANCHOR field");

1289 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1290 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1291 
out
;

1294 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

1295 ià(
	`uÆik–y
(
Ëngth
 <= 0)) {

1296 ià(
Ëngth
 == 0)

1297 
out_put
;

1298 ià(
Ëngth
 =ð-
ENOMEM
)

1299 
	`sc¡_£t_busy
(
cmd
);

1301 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1302 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1303 
out
;

1306 
šode
 = 
fd
->
f_d’Œy
->
d_šode
;

1308 
tÙ®_Ën
 = 
cmd
->
cdb
[7] << 8 | cmd->cdb[8];

1309 
off£t
 = 8;

1311 
desütÜ_Ën
 = 
add»ss
[2] << 8 |‡ddress[3];

1313 
	`TRACE_DBG
("tÙ®_ËÀ%d, desütÜ_ËÀ%d", 
tÙ®_Ën
, 
desütÜ_Ën
);

1315 ià(
desütÜ_Ën
 == 0)

1316 
out_put
;

1318 ià(
	`uÆik–y
((
desütÜ_Ën
 > (
tÙ®_Ën
 - 8)) ||

1319 ((
desütÜ_Ën
 % 16) != 0))) {

1320 
	`PRINT_ERROR
("Bad descriptor†ength: %d < %d - 8",

1321 
desütÜ_Ën
, 
tÙ®_Ën
);

1322 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1323 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1324 
out_put
;

1327 (
off£t
 - 8è< 
desütÜ_Ën
) {

1328 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 27)

1329 
”r
;

1331 
ušt64_t
 
¡¬t
;

1332 
ušt32_t
 
Ën
;

1333 
¡¬t
 = 
	`be64_to_ýu
(
	`g‘_uÇligÃd
((
__be64
 *)&
add»ss
[
off£t
]));

1334 
off£t
 += 8;

1335 
Ën
 = 
	`be32_to_ýu
(
	`g‘_uÇligÃd
((
__be32
 *)&
add»ss
[
off£t
]));

1336 
off£t
 += 8;

1338 ià((
¡¬t
 > 
vœt_dev
->
nblocks
) ||

1339 ((
¡¬t
 + 
Ën
è> 
vœt_dev
->
nblocks
)) {

1340 
	`PRINT_ERROR
("Device %s:‡ttempto write beyond max "

1341 "size", 
vœt_dev
->
Çme
);

1342 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1343 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1344 
out_put
;

1347 
	`TRACE_DBG
("Unmapping†ba %lld (blocks %d)",

1348 ()
¡¬t
, 
Ën
);

1350 ià(
vœt_dev
->
blockio
) {

1351 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 27)

1352 
gå_t
 
gå
 = 
cmd
->
noio_mem_®loc
 ? 
GFP_NOIO
 : 
GFP_KERNEL
;

1353 #ià
LINUX_VERSION_CODE
 <ð
	`KERNEL_VERSION
(2, 6, 31)

1354 
”r
 = 
	`blkdev_issue_disÿrd
(
šode
->
i_bdev
, 
¡¬t
, 
Ën
,

1355 
gå
);

1356 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 35) \

1357 && !(
LINUX_VERSION_CODE
 =ð
	`KERNEL_VERSION
(2, 6, 34) \

1358 && 
	`defšed
(
CONFIG_SUSE_KERNEL
))

1359 
”r
 = 
	`blkdev_issue_disÿrd
(
šode
->
i_bdev
, 
¡¬t
, 
Ën
,

1360 
gå
, 
DISCARD_FL_WAIT
);

1361 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 37)

1362 
”r
 = 
	`blkdev_issue_disÿrd
(
šode
->
i_bdev
, 
¡¬t
, 
Ën
,

1363 
gå
, 
BLKDEV_IFL_WAIT
);

1365 
”r
 = 
	`blkdev_issue_disÿrd
(
šode
->
i_bdev
, 
¡¬t
, 
Ën
,

1366 
gå
, 0);

1368 ià(
	`uÆik–y
(
”r
 != 0)) {

1369 
	`PRINT_ERROR
("blkdev_issue_discard() for "

1371 ()
¡¬t
, 
Ën
, 
”r
);

1372 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1373 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

1374 
out_put
;

1377 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1378 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

1379 
out_put
;

1382 cÚ¡ 
block_shiá
 = 
vœt_dev
->block_shift;

1383 cÚ¡ 
loff_t
 
a0
 = 
¡¬t
 << 
block_shiá
;

1384 cÚ¡ 
loff_t
 
a2
 = (
¡¬t
 + 
Ën
è<< 
block_shiá
;

1385 cÚ¡ 
loff_t
 
a1
 = 
	`max_t
Öoff_t, 
a2
 & 
PAGE_CACHE_MASK
,

1386 
a0
);

1398 
	`WARN_ON
(!(
a0
 <ð
a1
 &&‡1 <ð
a2
));

1399 
	`WARN_ON
(!((
a1
 & (
PAGE_CACHE_SIZE
 - 1)) == 0 ||

1400 
a0
 =ð
a1
));

1401 ià(
a0
 < 
a1
)

1402 
šode
->
i_Ý
->
	`Œunÿ‹_¿nge
(šode, 
a0
, 
a1
 - 1);

1406 
out_put
:

1407 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

1409 
out
:

1410 
	`TRACE_EXIT
();

1412 
	}
}

1414 
	$vdisk_exec_šquœy
(
sc¡_cmd
 *
cmd
)

1416 
št32_t
 
Ëngth
, 
i
, 
»¥_Ën
 = 0;

1417 
ušt8_t
 *
add»ss
;

1418 
ušt8_t
 *
buf
;

1419 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

1420 
ušt16_t
 
tg_id
;

1422 
	`TRACE_ENTRY
();

1424 
buf
 = 
	`kz®loc
(
INQ_BUF_SZ
, 
GFP_KERNEL
);

1425 ià(
buf
 =ð
NULL
) {

1426 
	`sc¡_£t_busy
(
cmd
);

1427 
out
;

1430 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

1431 
	`TRACE_DBG
("Ëngth %d", 
Ëngth
);

1432 ià(
	`uÆik–y
(
Ëngth
 <= 0)) {

1433 ià(
Ëngth
 < 0) {

1434 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d", 
Ëngth
);

1435 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1436 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1438 
out_ä“
;

1441 ià(
cmd
->
cdb
[1] & 
CMDDT
) {

1442 
	`TRACE_DBG
("%s", "INQUIRY: CMDDT is unsupported");

1443 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1444 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1445 
out_put
;

1448 
buf
[0] = 
cmd
->
dev
->
ty³
;

1450 ià(
cmd
->
cdb
[1] & 
EVPD
) {

1451 ià(0 =ð
cmd
->
cdb
[2]) {

1453 
buf
[3] = 3;

1454 
buf
[4] = 0x0;

1455 
buf
[5] = 0x80;

1456 
buf
[6] = 0x83;

1457 ià(
vœt_dev
->
dev
->
ty³
 =ð
TYPE_DISK
) {

1458 
buf
[3] += 1;

1459 
buf
[7] = 0xB0;

1460 ià(
vœt_dev
->
thš_´ovisiÚed
) {

1461 
buf
[3] += 1;

1462 
buf
[8] = 0xB2;

1465 
»¥_Ën
 = 
buf
[3] + 4;

1466 } ià(0x80 =ð
cmd
->
cdb
[2]) {

1468 
buf
[1] = 0x80;

1469 ià(
cmd
->
tg‰
->
g‘_£rŸl
) {

1470 
buf
[3] = 
cmd
->
tg‰
->
	`g‘_£rŸl
(cmd->
tgt_dev
,

1471 &
buf
[4], 
INQ_BUF_SZ
 - 4);

1473 
u¢_Ën
;

1474 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

1475 
u¢_Ën
 = 
	`¡¾’
(
vœt_dev
->
u¢
);

1476 
buf
[3] = 
u¢_Ën
;

1477 
	`¡ºýy
(&
buf
[4], 
vœt_dev
->
u¢
, 
u¢_Ën
);

1478 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

1480 
»¥_Ën
 = 
buf
[3] + 4;

1481 } ià(0x83 =ð
cmd
->
cdb
[2]) {

1483 
num
 = 4;

1485 
buf
[1] = 0x83;

1487 
buf
[
num
 + 0] = 0x2;

1488 
buf
[
num
 + 1] = 0x1;

1489 ià(
cmd
->
tg‰
->
v’dÜ
)

1490 
	`memýy
(&
buf
[
num
 + 4], 
cmd
->
tg‰
->
v’dÜ
, 8);

1491 ià(
vœt_dev
->
blockio
)

1492 
	`memýy
(&
buf
[
num
 + 4], 
SCST_BIO_VENDOR
, 8);

1494 
	`memýy
(&
buf
[
num
 + 4], 
SCST_FIO_VENDOR
, 8);

1496 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

1497 
i
 = 
	`¡¾’
(
vœt_dev
->
t10_dev_id
);

1498 
	`memýy
(&
buf
[
num
 + 12], 
vœt_dev
->
t10_dev_id
, 
i
);

1499 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

1501 
buf
[
num
 + 3] = 8 + 
i
;

1502 
num
 +ð
buf
[num + 3];

1504 
num
 += 4;

1509 
buf
[
num
 + 0] = 0x01;

1511 
buf
[
num
 + 1] = 0x10 | 0x04;

1513 
	`put_uÇligÃd
(
	`ýu_to_be16
(
cmd
->
tgt
->
»l_tgt_id
),

1514 (
__be16
 *)&
buf
[
num
 + 4 + 2]);

1516 
buf
[
num
 + 3] = 4;

1517 
num
 +ð
buf
[num + 3];

1519 
num
 += 4;

1521 
tg_id
 = 
	`sc¡_lookup_tg_id
(
cmd
->
dev
, cmd->
tgt
);

1522 ià(
tg_id
) {

1526 
buf
[
num
 + 0] = 0x01;

1528 
buf
[
num
 + 1] = 0x10 | 0x05;

1530 
	`put_uÇligÃd
(
	`ýu_to_be16
(
tg_id
),

1531 (
__be16
 *)&
buf
[
num
 + 4 + 2]);

1533 
buf
[
num
 + 3] = 4;

1534 
num
 +ð4 + 
buf
[num + 3];

1540 
buf
[
num
 + 0] = 0x01;

1543 
buf
[
num
 + 1] = 0x02;

1544 
buf
[
num
 + 2] = 0x00;

1545 
buf
[
num
 + 3] = 0x08;

1548 
buf
[
num
 + 4] = 
vœt_dev
->
t10_dev_id
[0];

1549 
buf
[
num
 + 5] = 
vœt_dev
->
t10_dev_id
[1];

1550 
buf
[
num
 + 6] = 
vœt_dev
->
t10_dev_id
[2];

1553 
buf
[
num
 + 7] = 
vœt_dev
->
t10_dev_id
[3];

1554 
buf
[
num
 + 8] = 
vœt_dev
->
t10_dev_id
[4];

1555 
buf
[
num
 + 9] = 
vœt_dev
->
t10_dev_id
[5];

1556 
buf
[
num
 + 10] = 
vœt_dev
->
t10_dev_id
[6];

1557 
buf
[
num
 + 11] = 
vœt_dev
->
t10_dev_id
[7];

1558 
num
 +ð
buf
[num + 3];

1560 
»¥_Ën
 = 
num
;

1561 
buf
[2] = (
»¥_Ën
 >> 8) & 0xFF;

1562 
buf
[3] = 
»¥_Ën
 & 0xFF;

1563 
»¥_Ën
 += 4;

1564 } ià((0xB0 =ð
cmd
->
cdb
[2]) &&

1565 (
vœt_dev
->
dev
->
ty³
 =ð
TYPE_DISK
)) {

1567 
max_Œªsãr
;

1568 
buf
[1] = 0xB0;

1569 
buf
[3] = 0x3C;

1571 
	`put_uÇligÃd
(
	`ýu_to_be16
(
	`max_t
(,

1572 
PAGE_SIZE
/
vœt_dev
->
block_size
, 1)),

1573 (
ušt16_t
 *)&
buf
[6]);

1575 
max_Œªsãr
 = 
	`mš_t
(,

1576 
cmd
->
tgt_dev
->
max_sg_út
 << 
PAGE_SHIFT
,

1577 8*1024*1024è/ 
vœt_dev
->
block_size
;

1578 
	`put_uÇligÃd
(
	`ýu_to_be32
(
max_Œªsãr
),

1579 (
ušt32_t
 *)&
buf
[8]);

1587 
	`put_uÇligÃd
(
	`ýu_to_be32
(
	`mš_t
(,

1588 
max_Œªsãr
,

1589 512*1024 / 
vœt_dev
->
block_size
)),

1590 (
ušt32_t
 *)&
buf
[12]);

1591 ià(
vœt_dev
->
thš_´ovisiÚed
) {

1593 
	`put_uÇligÃd
(
	`__cÚ¡ªt_ýu_to_be32
(0xFFFFFFFF),

1594 (
ušt32_t
 *)&
buf
[20]);

1596 
	`put_uÇligÃd
(
	`__cÚ¡ªt_ýu_to_be32
(0xFFFFFFFF),

1597 (
ušt32_t
 *)&
buf
[24]);

1599 
	`put_uÇligÃd
(
	`__cÚ¡ªt_ýu_to_be32
(1),

1600 (
ušt32_t
 *)&
buf
[28]);

1602 
»¥_Ën
 = 
buf
[3] + 4;

1603 } ià((0xB2 =ð
cmd
->
cdb
[2]) &&

1604 (
vœt_dev
->
dev
->
ty³
 =ð
TYPE_DISK
) &&

1605 
vœt_dev
->
thš_´ovisiÚed
) {

1607 
buf
[1] = 0xB2;

1608 
buf
[3] = 2;

1609 
buf
[5] = 0x80;

1610 
»¥_Ën
 = 
buf
[3] + 4;

1612 
	`TRACE_DBG
("INQUIRY: Unsupported EVPD…age %x",

1613 
cmd
->
cdb
[2]);

1614 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1615 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1616 
out_put
;

1619 
Ën
, 
num
;

1621 ià(
cmd
->
cdb
[2] != 0) {

1622 
	`TRACE_DBG
("INQUIRY: UnsuµÜ‹d…ag%x", 
cmd
->
cdb
[2]);

1623 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1624 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1625 
out_put
;

1628 ià(
vœt_dev
->
»movabË
)

1629 
buf
[1] = 0x80;

1630 
buf
[2] = 5;

1631 
buf
[3] = 0x02;

1632 ià(
cmd
->
tg‰
->
çke_aÿ
)

1633 
buf
[3] |= 0x20;

1634 
buf
[4] = 31;

1635 ià(
	`sc¡_im¶_®ua_cÚfigu»d
(
cmd
->
dev
))

1636 
buf
[5] = 
SCST_INQ_TPGS_MODE_IMPLICIT
;

1637 
buf
[6] = 0x10;

1638 
buf
[7] = 2;

1644 ià(
cmd
->
tg‰
->
v’dÜ
)

1645 
	`memýy
(&
buf
[8], 
cmd
->
tg‰
->
v’dÜ
, 8);

1646 ià(
vœt_dev
->
blockio
)

1647 
	`memýy
(&
buf
[8], 
SCST_BIO_VENDOR
, 8);

1649 
	`memýy
(&
buf
[8], 
SCST_FIO_VENDOR
, 8);

1655 
	`mem£t
(&
buf
[16], ' ', 16);

1656 ià(
cmd
->
tg‰
->
g‘_´oduù_id
)

1657 
cmd
->
tg‰
->
	`g‘_´oduù_id
(cmd->
tgt_dev
, &
buf
[16], 16);

1659 
Ën
 = 
	`mš_t
(
size_t
, 
	`¡¾’
(
vœt_dev
->
Çme
), 16);

1660 
	`memýy
(&
buf
[16], 
vœt_dev
->
Çme
, 
Ën
);

1667 ià(
cmd
->
tg‰
->
»visiÚ
)

1668 
	`memýy
(&
buf
[32], 
cmd
->
tg‰
->
»visiÚ
, 4);

1670 
	`memýy
(&
buf
[32], 
SCST_FIO_REV
, 4);

1674 
buf
[4] += 58 - 36;

1675 
num
 = 0;

1678 
buf
[58 + 
num
] = 0x0;

1679 
buf
[58 + 
num
 + 1] = 0x76;

1680 
num
 += 2;

1683 ià(
cmd
->
tg‰
->
g‘_phys_Œª¥Üt_v”siÚ
 !ð
NULL
) {

1684 
ušt16_t
 
v
 = 
cmd
->
tg‰
->
	`g‘_phys_Œª¥Üt_v”siÚ
(cmd->
tgt
);

1685 ià(
v
 != 0) {

1686 *((
__be16
 *)&
buf
[58 + 
num
]èð
	`ýu_to_be16
(
v
);

1687 
num
 += 2;

1692 ià(
cmd
->
tg‰
->
g‘_scsi_Œª¥Üt_v”siÚ
 !ð
NULL
) {

1693 *((
__be16
 *)&
buf
[58 + 
num
]) =

1694 
	`ýu_to_be16
(
cmd
->
tg‰
->
	`g‘_scsi_Œª¥Üt_v”siÚ
(cmd->
tgt
));

1695 
num
 += 2;

1699 
buf
[58 + 
num
] = 0x3;

1700 
buf
[58 + 
num
 + 1] = 0x12;

1701 
num
 += 2;

1704 ià(
vœt_dev
->
commªd_£t_v”siÚ
 != 0) {

1705 *((
__be16
 *)&
buf
[58 + 
num
]) =

1706 
	`ýu_to_be16
(
vœt_dev
->
commªd_£t_v”siÚ
);

1707 
num
 += 2;

1711 ià(
cmd
->
tg‰
->
g‘_v’d_¥ecific
) {

1713 
num
 = 96 - 58;

1714 
num
 +ð
cmd
->
tg‰
->
	`g‘_v’d_¥ecific
(cmd->
tgt_dev
,

1715 &
buf
[96], 
INQ_BUF_SZ
 - 96);

1718 
buf
[4] +ð
num
;

1719 
»¥_Ën
 = 
buf
[4] + 5;

1722 
	`sBUG_ON
(
»¥_Ën
 >ð
INQ_BUF_SZ
);

1724 ià(
Ëngth
 > 
»¥_Ën
)

1725 
Ëngth
 = 
»¥_Ën
;

1726 
	`memýy
(
add»ss
, 
buf
, 
Ëngth
);

1728 
out_put
:

1729 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

1730 ià(
Ëngth
 < 
cmd
->
»¥_d©a_Ën
)

1731 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

1733 
out_ä“
:

1734 
	`kä“
(
buf
);

1736 
out
:

1737 
	`TRACE_EXIT
();

1739 
	}
}

1741 
	$vdisk_exec_»que¡_£n£
(
sc¡_cmd
 *
cmd
)

1743 
št32_t
 
Ëngth
, 
¦
;

1744 
ušt8_t
 *
add»ss
;

1745 
ušt8_t
 
b
[
SCST_STANDARD_SENSE_LEN
];

1747 
	`TRACE_ENTRY
();

1749 
¦
 = 
	`sc¡_£t_£n£
(
b
, (b), 
cmd
->
dev
->
d_£n£
,

1750 
	`SCST_LOAD_SENSE
(
sc¡_£n£_no_£n£
));

1752 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

1753 
	`TRACE_DBG
("Ëngth %d", 
Ëngth
);

1754 ià(
Ëngth
 < 0) {

1755 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d)", 
Ëngth
);

1756 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1757 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1758 
out
;

1761 
Ëngth
 = 
	`mš
(
¦
,†ength);

1762 
	`memýy
(
add»ss
, 
b
, 
Ëngth
);

1763 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

1765 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

1767 
out
:

1768 
	`TRACE_EXIT
();

1770 
	}
}

1777 
	$vdisk_”r_»cov_pg
(*
p
, 
pcÚŒÞ
,

1778 
sc¡_vdisk_dev
 *
vœt_dev
)

1780 cÚ¡ 
”r_»cov_pg
[] = {0x1, 0xa, 0xc0, 11, 240, 0, 0, 0,

1783 
	`memýy
(
p
, 
”r_»cov_pg
, (err_recov_pg));

1784 ià(1 =ð
pcÚŒÞ
)

1785 
	`mem£t
(
p
 + 2, 0, (
”r_»cov_pg
) - 2);

1786  (
”r_»cov_pg
);

1787 
	}
}

1789 
	$vdisk_discÚÃù_pg
(*
p
, 
pcÚŒÞ
,

1790 
sc¡_vdisk_dev
 *
vœt_dev
)

1792 cÚ¡ 
discÚÃù_pg
[] = {0x2, 0xe, 128, 128, 0, 10, 0, 0,

1795 
	`memýy
(
p
, 
discÚÃù_pg
, (disconnect_pg));

1796 ià(1 =ð
pcÚŒÞ
)

1797 
	`mem£t
(
p
 + 2, 0, (
discÚÃù_pg
) - 2);

1798  (
discÚÃù_pg
);

1799 
	}
}

1801 
	$vdisk_rigid_geo_pg
(*
p
, 
pcÚŒÞ
,

1802 
sc¡_vdisk_dev
 *
vœt_dev
)

1804 
geo_m_pg
[] = {0x04, 0x16, 0, 0, 0, 
DEF_HEADS
, 0, 0,

1807 
št32_t
 
ncyl
, 
n
, 
»m
;

1808 
ušt64_t
 
divid’d
;

1810 
	`memýy
(
p
, 
geo_m_pg
, (geo_m_pg));

1815 
divid’d
 = 
vœt_dev
->
nblocks
;

1816 
»m
 = 
	`do_div
(
divid’d
, 
DEF_HEADS
 * 
DEF_SECTORS
);

1817 
ncyl
 = 
divid’d
;

1818 ià(
»m
 != 0)

1819 
ncyl
++;

1820 
	`memýy
(&
n
, 
p
 + 2, (
u32
));

1821 
n
 =‚ | ((
__fÜû
 
u32
)
	`ýu_to_be32
(
ncyl
) >> 8);

1822 
	`memýy
(
p
 + 2, &
n
, (
u32
));

1823 ià(1 =ð
pcÚŒÞ
)

1824 
	`mem£t
(
p
 + 2, 0, (
geo_m_pg
) - 2);

1825  (
geo_m_pg
);

1826 
	}
}

1828 
	$vdisk_fÜm©_pg
(*
p
, 
pcÚŒÞ
,

1829 
sc¡_vdisk_dev
 *
vœt_dev
)

1831 cÚ¡ 
fÜm©_pg
[] = {0x3, 0x16, 0, 0, 0, 0, 0, 0,

1835 
	`memýy
(
p
, 
fÜm©_pg
, (format_pg));

1836 
p
[10] = (
DEF_SECTORS
 >> 8) & 0xff;

1837 
p
[11] = 
DEF_SECTORS
 & 0xff;

1838 
p
[12] = (
vœt_dev
->
block_size
 >> 8) & 0xff;

1839 
p
[13] = 
vœt_dev
->
block_size
 & 0xff;

1840 ià(1 =ð
pcÚŒÞ
)

1841 
	`mem£t
(
p
 + 2, 0, (
fÜm©_pg
) - 2);

1842  (
fÜm©_pg
);

1843 
	}
}

1845 
	$vdisk_ÿchšg_pg
(*
p
, 
pcÚŒÞ
,

1846 
sc¡_vdisk_dev
 *
vœt_dev
)

1848 cÚ¡ 
ÿchšg_pg
[] = {0x8, 18, 0x10, 0, 0xff, 0xff, 0, 0,

1851 
	`memýy
(
p
, 
ÿchšg_pg
, (caching_pg));

1852 
p
[2] |ð!(
vœt_dev
->
wt_æag
 || vœt_dev->
nv_ÿche
è? 
WCE
 : 0;

1853 ià(1 =ð
pcÚŒÞ
)

1854 
	`mem£t
(
p
 + 2, 0, (
ÿchšg_pg
) - 2);

1855  (
ÿchšg_pg
);

1856 
	}
}

1858 
	$vdisk_ù¾_m_pg
(*
p
, 
pcÚŒÞ
,

1859 
sc¡_vdisk_dev
 *
vœt_dev
)

1861 cÚ¡ 
ù¾_m_pg
[] = {0xa, 0xa, 0, 0, 0, 0, 0, 0,

1864 
	`memýy
(
p
, 
ù¾_m_pg
, (ctrl_m_pg));

1865 
pcÚŒÞ
) {

1867 
p
[2] |ð
vœt_dev
->
dev
->
t¡
 << 5;

1868 
p
[2] |ð
vœt_dev
->
dev
->
d_£n£
 << 2;

1869 
p
[3] |ð
vœt_dev
->
dev
->
queue_®g
 << 4;

1870 
p
[4] |ð
vœt_dev
->
dev
->
swp
 << 3;

1871 
p
[5] |ð
vœt_dev
->
dev
->
s
 << 6;

1874 
	`mem£t
(
p
 + 2, 0, (
ù¾_m_pg
) - 2);

1879 
p
[2] |= 7 << 5;

1880 
p
[3] |= 0xF << 4;

1882 
p
[2] |= 1 << 2;

1883 
p
[4] |= 1 << 3;

1884 
p
[5] |= 1 << 6;

1887 
p
[2] |ð
DEF_TST
 << 5;

1888 
p
[2] |ð
DEF_DSENSE
 << 2;

1889 ià(
vœt_dev
->
wt_æag
 || vœt_dev->
nv_ÿche
)

1890 
p
[3] |ð
DEF_QUEUE_ALG_WT
 << 4;

1892 
p
[3] |ð
DEF_QUEUE_ALG
 << 4;

1893 
p
[4] |ð
DEF_SWP
 << 3;

1894 
p
[5] |ð
DEF_TAS
 << 6;

1897 
	`sBUG
();

1899  (
ù¾_m_pg
);

1900 
	}
}

1902 
	$vdisk_›c_m_pg
(*
p
, 
pcÚŒÞ
,

1903 
sc¡_vdisk_dev
 *
vœt_dev
)

1905 cÚ¡ 
›c_m_pg
[] = {0x1c, 0xa, 0x08, 0, 0, 0, 0, 0,

1907 
	`memýy
(
p
, 
›c_m_pg
, (iec_m_pg));

1908 ià(1 =ð
pcÚŒÞ
)

1909 
	`mem£t
(
p
 + 2, 0, (
›c_m_pg
) - 2);

1910  (
›c_m_pg
);

1911 
	}
}

1913 
	$vdisk_exec_mode_£n£
(
sc¡_cmd
 *
cmd
)

1915 
št32_t
 
Ëngth
;

1916 
ušt8_t
 *
add»ss
;

1917 
ušt8_t
 *
buf
;

1918 
sc¡_vdisk_dev
 *
vœt_dev
;

1919 
ušt32_t
 
blocksize
;

1920 
ušt64_t
 
nblocks
;

1921 
dbd
, 
ty³
;

1922 
pcÚŒÞ
, 
pcode
, 
subpcode
;

1923 
dev_¥ec
;

1924 
m£n£_6
, 
off£t
 = 0, 
Ën
;

1925 *
bp
;

1927 
	`TRACE_ENTRY
();

1929 
buf
 = 
	`kz®loc
(
MSENSE_BUF_SZ
, 
GFP_KERNEL
);

1930 ià(
buf
 =ð
NULL
) {

1931 
	`sc¡_£t_busy
(
cmd
);

1932 
out
;

1935 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

1936 
blocksize
 = 
vœt_dev
->
block_size
;

1937 
nblocks
 = 
vœt_dev
->nblocks;

1939 
ty³
 = 
cmd
->
dev
->type;

1940 
dbd
 = 
cmd
->
cdb
[1] & 
DBD
;

1941 
pcÚŒÞ
 = (
cmd
->
cdb
[2] & 0xc0) >> 6;

1942 
pcode
 = 
cmd
->
cdb
[2] & 0x3f;

1943 
subpcode
 = 
cmd
->
cdb
[3];

1944 
m£n£_6
 = (
MODE_SENSE
 =ð
cmd
->
cdb
[0]);

1945 
dev_¥ec
 = (
vœt_dev
->
dev
->
rd_Úly
 ||

1946 
cmd
->
tgt_dev
->
acg_dev
->
rd_Úly
è? 
WP
 : 0;

1948 ià(!
vœt_dev
->
blockio
)

1949 
dev_¥ec
 |ð
DPOFUA
;

1951 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

1952 ià(
	`uÆik–y
(
Ëngth
 <= 0)) {

1953 ià(
Ëngth
 < 0) {

1954 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d", 
Ëngth
);

1955 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1956 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1958 
out_ä“
;

1961 ià(0x3 =ð
pcÚŒÞ
) {

1962 
	`TRACE_DBG
("%s", "MODE SENSE: Saving values‚ot supported");

1963 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1964 
	`SCST_LOAD_SENSE
(
sc¡_£n£_§všg_·¿ms_unsup
));

1965 
out_put
;

1968 ià(
m£n£_6
) {

1969 
buf
[1] = 
ty³
;

1970 
buf
[2] = 
dev_¥ec
;

1971 
off£t
 = 4;

1973 
buf
[2] = 
ty³
;

1974 
buf
[3] = 
dev_¥ec
;

1975 
off£t
 = 8;

1978 ià(0 !ð
subpcode
) {

1980 
	`TRACE_DBG
("%s", "MODE SENSE: Only subpage 0 is supported");

1981 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1982 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1983 
out_put
;

1986 ià(!
dbd
) {

1988 
buf
[
off£t
 - 1] = 0x08;

1989 ià(
nblocks
 >> 32) {

1990 
buf
[
off£t
 + 0] = 0xFF;

1991 
buf
[
off£t
 + 1] = 0xFF;

1992 
buf
[
off£t
 + 2] = 0xFF;

1993 
buf
[
off£t
 + 3] = 0xFF;

1996 
buf
[
off£t
 + 0] = (
nblocks
 >> (
BYTE
 * 3)) & 0xFF;

1997 
buf
[
off£t
 + 1] = (
nblocks
 >> (
BYTE
 * 2)) & 0xFF;

1998 
buf
[
off£t
 + 2] = (
nblocks
 >> (
BYTE
 * 1)) & 0xFF;

1999 
buf
[
off£t
 + 3] = (
nblocks
 >> (
BYTE
 * 0)) & 0xFF;

2001 
buf
[
off£t
 + 4] = 0;

2002 
buf
[
off£t
 + 5] = (
blocksize
 >> (
BYTE
 * 2)) & 0xFF;

2003 
buf
[
off£t
 + 6] = (
blocksize
 >> (
BYTE
 * 1)) & 0xFF;

2004 
buf
[
off£t
 + 7] = (
blocksize
 >> (
BYTE
 * 0)) & 0xFF;

2006 
off£t
 += 8;

2009 
bp
 = 
buf
 + 
off£t
;

2011 
pcode
) {

2013 
Ën
 = 
	`vdisk_”r_»cov_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

2016 
Ën
 = 
	`vdisk_discÚÃù_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

2019 
Ën
 = 
	`vdisk_fÜm©_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

2022 
Ën
 = 
	`vdisk_rigid_geo_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

2025 
Ën
 = 
	`vdisk_ÿchšg_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

2028 
Ën
 = 
	`vdisk_ù¾_m_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

2031 
Ën
 = 
	`vdisk_›c_m_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

2034 
Ën
 = 
	`vdisk_”r_»cov_pg
(
bp
, 
pcÚŒÞ
, 
vœt_dev
);

2035 
Ën
 +ð
	`vdisk_discÚÃù_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

2036 
Ën
 +ð
	`vdisk_fÜm©_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

2037 
Ën
 +ð
	`vdisk_ÿchšg_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

2038 
Ën
 +ð
	`vdisk_ù¾_m_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

2039 
Ën
 +ð
	`vdisk_›c_m_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

2040 
Ën
 +ð
	`vdisk_rigid_geo_pg
(
bp
 +†’, 
pcÚŒÞ
, 
vœt_dev
);

2043 
	`TRACE_DBG
("MODE SENSE: UnsuµÜ‹d…ag%x", 
pcode
);

2044 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2045 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2046 
out_put
;

2049 
off£t
 +ð
Ën
;

2051 ià(
m£n£_6
)

2052 
buf
[0] = 
off£t
 - 1;

2054 
buf
[0] = ((
off£t
 - 2) >> 8) & 0xff;

2055 
buf
[1] = (
off£t
 - 2) & 0xff;

2058 ià(
off£t
 > 
Ëngth
)

2059 
off£t
 = 
Ëngth
;

2060 
	`memýy
(
add»ss
, 
buf
, 
off£t
);

2062 
out_put
:

2063 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

2064 ià(
off£t
 < 
cmd
->
»¥_d©a_Ën
)

2065 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
off£t
);

2067 
out_ä“
:

2068 
	`kä“
(
buf
);

2070 
out
:

2071 
	`TRACE_EXIT
();

2073 
	}
}

2075 
	$vdisk_£t_wt
(
sc¡_vdisk_dev
 *
vœt_dev
, 
wt
)

2077 
»s
 = 0;

2079 
	`TRACE_ENTRY
();

2081 ià((
vœt_dev
->
wt_æag
 =ð
wt
è|| vœt_dev->
nuÎio
 || vœt_dev->
nv_ÿche
)

2082 
out
;

2084 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

2085 
vœt_dev
->
wt_æag
 = 
wt
;

2086 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

2088 
	`sc¡_dev_d–_®l_thr_d©a
(
vœt_dev
->
dev
);

2090 
out
:

2091 
	`TRACE_EXIT_RES
(
»s
);

2092  
»s
;

2093 
	}
}

2095 
	$vdisk_ù¾_m_pg_£Ëù
(*
p
,

2096 
sc¡_vdisk_dev
 *
vœt_dev
, 
sc¡_cmd
 *
cmd
)

2098 
sc¡_deviû
 *
dev
 = 
vœt_dev
->dev;

2099 
Þd_swp
 = 
dev
->
swp
, 
Þd_s
 = dev->
s
, 
Þd_d£n£
 = dev->
d_£n£
;

2102 
dev
->
t¡
 = (
p
[2] >> 5) & 1;

2103 
dev
->
queue_®g
 = 
p
[3] >> 4;

2105 ià((
dev
->
t¡
 !ð((
p
[2] >> 5è& 1)è|| (dev->
queue_®g
 != (p[3] >> 4))) {

2106 
	`TRACE
(
TRACE_MINOR
|
TRACE_SCSI
, "%s", "MODE SELECT: Changing of "

2108 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2109 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2113 
dev
->
swp
 = (
p
[4] & 0x8) >> 3;

2114 
dev
->
s
 = (
p
[5] & 0x40) >> 6;

2115 
dev
->
d_£n£
 = (
p
[2] & 0x4) >> 2;

2117 
	`PRINT_INFO
("Device %s:‚ew control mode…age…arameters: SWP %x "

2119 
vœt_dev
->
Çme
, 
dev
->
swp
, 
Þd_swp
, dev->
s
, 
Þd_s
,

2120 
dev
->
d_£n£
, 
Þd_d£n£
);

2122 
	}
}

2124 
	$vdisk_exec_mode_£Ëù
(
sc¡_cmd
 *
cmd
)

2126 
št32_t
 
Ëngth
;

2127 
ušt8_t
 *
add»ss
;

2128 
sc¡_vdisk_dev
 *
vœt_dev
;

2129 
m£Ëù_6
, 
off£t
;

2131 
	`TRACE_ENTRY
();

2133 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

2134 
m£Ëù_6
 = (
MODE_SELECT
 =ð
cmd
->
cdb
[0]);

2136 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

2137 ià(
	`uÆik–y
(
Ëngth
 <= 0)) {

2138 ià(
Ëngth
 < 0) {

2139 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d", 
Ëngth
);

2140 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2141 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2143 
out
;

2146 ià(!(
cmd
->
cdb
[1] & 
PF
è|| (cmd->cdb[1] & 
SP
)) {

2147 
	`TRACE
(
TRACE_MINOR
|
TRACE_SCSI
, "MODE SELECT: Unsupported "

2149 
cmd
->
cdb
[1]);

2150 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2151 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2152 
out_put
;

2155 ià(
m£Ëù_6
)

2156 
off£t
 = 4;

2158 
off£t
 = 8;

2160 ià(
add»ss
[
off£t
 - 1] == 8) {

2161 
off£t
 += 8;

2162 } ià(
add»ss
[
off£t
 - 1] != 0) {

2163 
	`PRINT_ERROR
("%s", "MODE SELECT: Wrong…arameters†ist "

2165 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2166 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

2167 
out_put
;

2170 
Ëngth
 > 
off£t
 + 2) {

2171 ià(
add»ss
[
off£t
] & 
PS
) {

2172 
	`PRINT_ERROR
("%s", "MODE SELECT: Illegal PS bit");

2173 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

2174 
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

2175 
out_put
;

2177 ià((
add»ss
[
off£t
] & 0x3f) == 0x8) {

2179 ià(
add»ss
[
off£t
 + 1] != 18) {

2180 
	`PRINT_ERROR
("%s", "MODE SELECT: Invalid "

2182 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

2183 
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

2184 
out_put
;

2186 ià(
	`vdisk_£t_wt
(
vœt_dev
,

2187 (
add»ss
[
off£t
 + 2] & 
WCE
) ? 0 : 1) != 0) {

2188 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2189 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2190 
out_put
;

2193 } ià((
add»ss
[
off£t
] & 0x3f) == 0xA) {

2195 ià(
add»ss
[
off£t
 + 1] != 0xA) {

2196 
	`PRINT_ERROR
("%s", "MODE SELECT: Invalid "

2198 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

2199 
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

2200 
out_put
;

2202 
	`vdisk_ù¾_m_pg_£Ëù
(&
add»ss
[
off£t
], 
vœt_dev
, 
cmd
);

2204 
	`PRINT_ERROR
("MODE SELECT: Invalid„equest %x",

2205 
add»ss
[
off£t
] & 0x3f);

2206 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

2207 
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

2208 
out_put
;

2210 
off£t
 +ð
add»ss
[offset + 1];

2213 
out_put
:

2214 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

2216 
out
:

2217 
	`TRACE_EXIT
();

2219 
	}
}

2221 
	$vdisk_exec_log
(
sc¡_cmd
 *
cmd
)

2223 
	`TRACE_ENTRY
();

2226 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2227 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2229 
	`TRACE_EXIT
();

2231 
	}
}

2233 
	$vdisk_exec_»ad_ÿ·c™y
(
sc¡_cmd
 *
cmd
)

2235 
št32_t
 
Ëngth
;

2236 
ušt8_t
 *
add»ss
;

2237 
sc¡_vdisk_dev
 *
vœt_dev
;

2238 
ušt32_t
 
blocksize
;

2239 
ušt64_t
 
nblocks
;

2240 
ušt8_t
 
bufãr
[8];

2242 
	`TRACE_ENTRY
();

2244 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

2245 
blocksize
 = 
vœt_dev
->
block_size
;

2246 
nblocks
 = 
vœt_dev
->nblocks;

2248 ià((
cmd
->
cdb
[8] & 1) == 0) {

2249 
ušt64_t
 
lba
 = 
	`be64_to_ýu
(
	`g‘_uÇligÃd
((
__be64
 *)&
cmd
->
cdb
[2]));

2250 ià(
lba
 != 0) {

2251 
	`TRACE_DBG
("PMI z”Øªd LBA‚Ù z”Ø(cmd %p)", 
cmd
);

2252 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2253 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2254 
out
;

2259 
	`mem£t
(
bufãr
, 0, (buffer));

2266 ià(
nblocks
 >> 32 || 
vœt_dev
->
thš_´ovisiÚed
) {

2267 
bufãr
[0] = 0xFF;

2268 
bufãr
[1] = 0xFF;

2269 
bufãr
[2] = 0xFF;

2270 
bufãr
[3] = 0xFF;

2272 
bufãr
[0] = ((
nblocks
 - 1è>> (
BYTE
 * 3)) & 0xFF;

2273 
bufãr
[1] = ((
nblocks
 - 1è>> (
BYTE
 * 2)) & 0xFF;

2274 
bufãr
[2] = ((
nblocks
 - 1è>> (
BYTE
 * 1)) & 0xFF;

2275 
bufãr
[3] = ((
nblocks
 - 1è>> (
BYTE
 * 0)) & 0xFF;

2277 
bufãr
[4] = (
blocksize
 >> (
BYTE
 * 3)) & 0xFF;

2278 
bufãr
[5] = (
blocksize
 >> (
BYTE
 * 2)) & 0xFF;

2279 
bufãr
[6] = (
blocksize
 >> (
BYTE
 * 1)) & 0xFF;

2280 
bufãr
[7] = (
blocksize
 >> (
BYTE
 * 0)) & 0xFF;

2282 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

2283 ià(
	`uÆik–y
(
Ëngth
 <= 0)) {

2284 ià(
Ëngth
 < 0) {

2285 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d", 
Ëngth
);

2286 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2287 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2289 
out
;

2292 
Ëngth
 = 
	`mš_t
(,†’gth, (
bufãr
));

2294 
	`memýy
(
add»ss
, 
bufãr
, 
Ëngth
);

2296 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

2298 ià(
Ëngth
 < 
cmd
->
»¥_d©a_Ën
)

2299 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

2301 
out
:

2302 
	`TRACE_EXIT
();

2304 
	}
}

2306 
	$vdisk_exec_»ad_ÿ·c™y16
(
sc¡_cmd
 *
cmd
)

2308 
št32_t
 
Ëngth
;

2309 
ušt8_t
 *
add»ss
;

2310 
sc¡_vdisk_dev
 *
vœt_dev
;

2311 
ušt32_t
 
blocksize
;

2312 
ušt64_t
 
nblocks
;

2313 
ušt8_t
 
bufãr
[32];

2315 
	`TRACE_ENTRY
();

2317 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

2318 
blocksize
 = 
vœt_dev
->
block_size
;

2319 
nblocks
 = 
vœt_dev
->nblocks - 1;

2321 ià((
cmd
->
cdb
[14] & 1) == 0) {

2322 
ušt64_t
 
lba
 = 
	`be64_to_ýu
(
	`g‘_uÇligÃd
((
__be64
 *)&
cmd
->
cdb
[2]));

2323 ià(
lba
 != 0) {

2324 
	`TRACE_DBG
("PMI z”Øªd LBA‚Ù z”Ø(cmd %p)", 
cmd
);

2325 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2326 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2327 
out
;

2331 
	`mem£t
(
bufãr
, 0, (buffer));

2333 
bufãr
[0] = 
nblocks
 >> 56;

2334 
bufãr
[1] = (
nblocks
 >> 48) & 0xFF;

2335 
bufãr
[2] = (
nblocks
 >> 40) & 0xFF;

2336 
bufãr
[3] = (
nblocks
 >> 32) & 0xFF;

2337 
bufãr
[4] = (
nblocks
 >> 24) & 0xFF;

2338 
bufãr
[5] = (
nblocks
 >> 16) & 0xFF;

2339 
bufãr
[6] = (
nblocks
 >> 8) & 0xFF;

2340 
bufãr
[7] = 
nblocks
 & 0xFF;

2342 
bufãr
[8] = (
blocksize
 >> (
BYTE
 * 3)) & 0xFF;

2343 
bufãr
[9] = (
blocksize
 >> (
BYTE
 * 2)) & 0xFF;

2344 
bufãr
[10] = (
blocksize
 >> (
BYTE
 * 1)) & 0xFF;

2345 
bufãr
[11] = (
blocksize
 >> (
BYTE
 * 0)) & 0xFF;

2347 
blocksize
) {

2349 
bufãr
[13] = 3;

2352 
bufãr
[13] = 2;

2355 
bufãr
[13] = 1;

2359 
bufãr
[13] = 0;

2363 ià(
vœt_dev
->
thš_´ovisiÚed
) {

2364 
bufãr
[14] |= 0x80;

2371 
bufãr
[14] |= 0x40;

2375 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

2376 ià(
	`uÆik–y
(
Ëngth
 <= 0)) {

2377 ià(
Ëngth
 < 0) {

2378 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d", 
Ëngth
);

2379 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2380 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2382 
out
;

2385 
Ëngth
 = 
	`mš_t
(,†’gth, (
bufãr
));

2387 
	`memýy
(
add»ss
, 
bufãr
, 
Ëngth
);

2389 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

2391 ià(
Ëngth
 < 
cmd
->
»¥_d©a_Ën
)

2392 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

2394 
out
:

2395 
	`TRACE_EXIT
();

2397 
	}
}

2400 
	$vdisk_exec_»pÜt_gs
(
sc¡_cmd
 *
cmd
)

2402 
sc¡_deviû
 *
dev
;

2403 
ušt8_t
 *
add»ss
;

2404 *
buf
;

2405 
št32_t
 
buf_Ën
;

2406 
ušt32_t
 
®loÿtiÚ_Ëngth
, 
d©a_Ëngth
, 
Ëngth
;

2407 
ušt8_t
 
d©a_fÜm©
;

2408 
»s
;

2410 
	`TRACE_ENTRY
();

2412 
buf_Ën
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

2413 ià(
buf_Ën
 < 0) {

2414 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d", 
buf_Ën
);

2415 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2416 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2417 
out
;

2420 ià(
cmd
->
cdb_Ën
 < 12)

2421 
	`PRINT_WARNING
("received invalid REPORT TARGET PORT GROUPS "

2423 "Ëa¡ 12 by‹s)", 
cmd
->
cdb_Ën
);

2425 
dev
 = 
cmd
->dev;

2426 
d©a_fÜm©
 = 
cmd
->
cdb_Ën
 > 1 ? cmd->
cdb
[1] >> 5 : 0;

2427 
®loÿtiÚ_Ëngth
 = 
cmd
->
cdb_Ën
 >= 10 ?

2428 
	`be32_to_ýu
(
	`g‘_uÇligÃd
((
__be32
 *)(
cmd
->
cdb
 + 6))) : 1024;

2430 
»s
 = 
	`sc¡_tg_g‘_group_šfo
(&
buf
, &
d©a_Ëngth
, 
dev
, 
d©a_fÜm©
);

2431 ià(
»s
 =ð-
ENOMEM
) {

2432 
	`sc¡_£t_busy
(
cmd
);

2433 
out_put
;

2434 } ià(
»s
 < 0) {

2435 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2436 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2437 
out_put
;

2440 
Ëngth
 = 
	`mš_t
(
ušt32_t
, 
	`mš
(
®loÿtiÚ_Ëngth
, 
d©a_Ëngth
), 
buf_Ën
);

2441 
	`memýy
(
add»ss
, 
buf
, 
Ëngth
);

2442 
	`kä“
(
buf
);

2443 ià(
Ëngth
 < 
cmd
->
»¥_d©a_Ën
)

2444 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ëngth
);

2446 
out_put
:

2447 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

2449 
out
:

2450 
	`TRACE_EXIT
();

2452 
	}
}

2454 
	$vdisk_exec_»ad_toc
(
sc¡_cmd
 *
cmd
)

2456 
št32_t
 
Ëngth
, 
off
 = 0;

2457 
ušt8_t
 *
add»ss
;

2458 
sc¡_vdisk_dev
 *
vœt_dev
;

2459 
ušt32_t
 
nblocks
;

2460 
ušt8_t
 
bufãr
[4+8+8] = { 0x00, 0x0a, 0x01, 0x01, 0x00, 0x14,

2463 
	`TRACE_ENTRY
();

2465 ià(
cmd
->
dev
->
ty³
 !ð
TYPE_ROM
) {

2466 
	`PRINT_ERROR
("%s", "READ TOC for‚on-CDROM device");

2467 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2468 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

2469 
out
;

2472 ià(
cmd
->
cdb
[2] & 0x0e ) {

2473 
	`PRINT_ERROR
("%s", "READ TOC: invalid„equested data format");

2474 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2475 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2476 
out
;

2479 ià((
cmd
->
cdb
[6] != 0 && (cmd->cdb[2] & 0x01)) ||

2480 (
cmd
->
cdb
[6] > 1 && cmd->cdb[6] != 0xAA)) {

2481 
	`PRINT_ERROR
("READ TOC: invalid„equestedrack‚umber %x",

2482 
cmd
->
cdb
[6]);

2483 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2484 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2485 
out
;

2488 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

2489 ià(
	`uÆik–y
(
Ëngth
 <= 0)) {

2490 ià(
Ëngth
 < 0) {

2491 
	`PRINT_ERROR
("sc¡_g‘_buf_fuÎ(èçžed: %d", 
Ëngth
);

2492 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2493 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2495 
out
;

2498 
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

2500 
nblocks
 = (
ušt32_t
)
vœt_dev
->nblocks;

2503 
	`mem£t
(
bufãr
, 0, (buffer));

2504 
bufãr
[2] = 0x01;

2505 
bufãr
[3] = 0x01;

2506 
off
 = 4;

2507 ià(
cmd
->
cdb
[6] <= 1) {

2511 
bufãr
[
off
+1] = 0x14;

2513 
bufãr
[
off
+2] = 0x01;

2514 
off
 += 8;

2516 ià(!(
cmd
->
cdb
[2] & 0x01)) {

2518 
bufãr
[
off
+1] = 0x14;

2520 
bufãr
[
off
+2] = 0xAA;

2522 
bufãr
[
off
+4] = (
nblocks
 >> (
BYTE
 * 3)) & 0xFF;

2523 
bufãr
[
off
+5] = (
nblocks
 >> (
BYTE
 * 2)) & 0xFF;

2524 
bufãr
[
off
+6] = (
nblocks
 >> (
BYTE
 * 1)) & 0xFF;

2525 
bufãr
[
off
+7] = (
nblocks
 >> (
BYTE
 * 0)) & 0xFF;

2526 
off
 += 8;

2529 
bufãr
[1] = 
off
 - 2;

2531 ià(
off
 > 
Ëngth
)

2532 
off
 = 
Ëngth
;

2533 
	`memýy
(
add»ss
, 
bufãr
, 
off
);

2535 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

2537 ià(
off
 < 
cmd
->
»¥_d©a_Ën
)

2538 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
off
);

2540 
out
:

2541 
	`TRACE_EXIT
();

2543 
	}
}

2545 
	$vdisk_exec_´ev’t_®low_medium_»mov®
(
sc¡_cmd
 *
cmd
)

2547 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

2549 
	`TRACE_DBG
("PERSIST/PREVENT 0x%02x", 
cmd
->
cdb
[4]);

2551 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

2552 
vœt_dev
->
´ev’t_®low_medium_»mov®
 = 
cmd
->
cdb
[4] & 0x01 ? 1 : 0;

2553 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

2556 
	}
}

2558 
	$vdisk_fsync
(
sc¡_vdisk_thr
 *
thr
, 
loff_t
 
loff
,

2559 
loff_t
 
Ën
, 
sc¡_cmd
 *
cmd
, 
sc¡_deviû
 *
dev
)

2561 
»s
 = 0;

2562 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

2563 
fže
 *file;

2565 
	`TRACE_ENTRY
();

2568 ià(
vœt_dev
->
nv_ÿche
 || vœt_dev->
wt_æag
 ||

2569 
vœt_dev
->
o_dœeù_æag
 || vœt_dev->
nuÎio
)

2570 
out
;

2572 ià(
vœt_dev
->
blockio
) {

2573 
»s
 = 
	`vdisk_blockio_æush
(
thr
->
bdev
,

2574 (
cmd
->
noio_mem_®loc
 ? 
GFP_NOIO
 : 
GFP_KERNEL
), 
Œue
);

2575 
out
;

2578 
fže
 = 
thr
->
fd
;

2580 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 32)

2581 
»s
 = 
	`sync_·ge_¿nge
(
fže
->
f_d’Œy
->
d_šode
, fže->
f_m­pšg
,

2582 
loff
, 
Ën
);

2585 
»s
 = 
	`g’”ic_wr™e_sync
(
fže
, 
loff
, 
Ën
);

2587 
»s
 = 
	`fžem­_wr™e_ªd_wa™_¿nge
(
fže
->
f_m­pšg
, 
loff
, 
Ën
);

2590 ià(
	`uÆik–y
(
»s
 != 0)) {

2591 
	`PRINT_ERROR
("synø¿ngçžed (%d)", 
»s
);

2592 ià(
cmd
 !ð
NULL
) {

2593 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2594 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

2598 
out
:

2599 
	`TRACE_EXIT_RES
(
»s
);

2600  
»s
;

2601 
	}
}

2603 
iovec
 *
	$vdisk_®loc_iv
(
sc¡_cmd
 *
cmd
,

2604 
sc¡_vdisk_thr
 *
thr
)

2606 
iv_couÁ
;

2608 
iv_couÁ
 = 
	`mš_t
(, 
	`sc¡_g‘_buf_couÁ
(
cmd
), 
UIO_MAXIOV
);

2609 ià(
iv_couÁ
 > 
thr
->iv_count) {

2610 
	`kä“
(
thr
->
iv
);

2612 
thr
->
iv
 = 
	`km®loc
((*thr->ivè* 
iv_couÁ
, 
GFP_KERNEL
);

2613 ià(
thr
->
iv
 =ð
NULL
) {

2614 
	`PRINT_ERROR
("UÇbËØ®loÿ‹ iv (%d)", 
iv_couÁ
);

2615 
	`sc¡_£t_busy
(
cmd
);

2616 
out
;

2618 
thr
->
iv_couÁ
 = iv_count;

2621 
out
:

2622  
thr
->
iv
;

2623 
	}
}

2625 
	$vdisk_exec_»ad
(
sc¡_cmd
 *
cmd
,

2626 
sc¡_vdisk_thr
 *
thr
, 
loff_t
 
loff
)

2628 
mm_£gm’t_t
 
Þd_fs
;

2629 
loff_t
 
”r
;

2630 
ssize_t
 
Ëngth
, 
fuÎ_Ën
;

2631 
ušt8_t
 
__u£r
 *
add»ss
;

2632 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

2633 
fže
 *
fd
 = 
thr
->fd;

2634 
iovec
 *
iv
;

2635 
iv_couÁ
, 
i
;

2636 
boÞ
 
fšished
 = 
çl£
;

2638 
	`TRACE_ENTRY
();

2640 ià(
vœt_dev
->
nuÎio
)

2641 
out
;

2643 
iv
 = 
	`vdisk_®loc_iv
(
cmd
, 
thr
);

2644 ià(
iv
 =ð
NULL
)

2645 
out
;

2647 
Ëngth
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, (
ušt8_t
 
__fÜû
 **)&
add»ss
);

2648 ià(
	`uÆik–y
(
Ëngth
 < 0)) {

2649 
	`PRINT_ERROR
("sc¡_g‘_buf_fœ¡(èçžed: %zd", 
Ëngth
);

2650 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2651 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2652 
out
;

2655 
Þd_fs
 = 
	`g‘_fs
();

2656 
	`£t_fs
(
	`g‘_ds
());

2659 
iv_couÁ
 = 0;

2660 
fuÎ_Ën
 = 0;

2661 
i
 = -1;

2662 
Ëngth
 > 0) {

2663 
fuÎ_Ën
 +ð
Ëngth
;

2664 
i
++;

2665 
iv_couÁ
++;

2666 
iv
[
i
].
iov_ba£
 = 
add»ss
;

2667 
iv
[
i
].
iov_Ën
 = 
Ëngth
;

2668 ià(
iv_couÁ
 =ð
UIO_MAXIOV
)

2670 
Ëngth
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
,

2671 (
ušt8_t
 
__fÜû
 **)&
add»ss
);

2673 ià(
Ëngth
 == 0) {

2674 
fšished
 = 
Œue
;

2675 ià(
	`uÆik–y
(
iv_couÁ
 == 0))

2677 } ià(
	`uÆik–y
(
Ëngth
 < 0)) {

2678 
	`PRINT_ERROR
("sc¡_g‘_buf_Ãxt(èçžed: %zd", 
Ëngth
);

2679 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2680 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2681 
out_£t_fs
;

2684 
	`TRACE_DBG
("(iv_couÁ %d, fuÎ_ËÀ%zd)", 
iv_couÁ
, 
fuÎ_Ën
);

2686 ià(
fd
->
f_Ý
->
Î£ek
)

2687 
”r
 = 
fd
->
f_Ý
->
	`Î£ek
(fd, 
loff
, 0 );

2689 
”r
 = 
	`deçuÉ_Î£ek
(
fd
, 
loff
, 0 );

2690 ià(
”r
 !ð
loff
) {

2691 
	`PRINT_ERROR
("lseekrouble %lld != %lld",

2692 ()
”r
,

2693 ()
loff
);

2694 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2695 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2696 
out_£t_fs
;

2700 
”r
 = 
	`vfs_»adv
(
fd
, (
iovec
 
__fÜû
 
__u£r
 *)
iv
, 
iv_couÁ
,

2701 &
fd
->
f_pos
);

2703 ià((
”r
 < 0è|| (”¸< 
fuÎ_Ën
)) {

2704 
	`PRINT_ERROR
("readv()„eturned %lld from %zd",

2705 ()
”r
,

2706 
fuÎ_Ën
);

2707 ià(
”r
 =ð-
EAGAIN
)

2708 
	`sc¡_£t_busy
(
cmd
);

2710 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2711 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

2713 
out_£t_fs
;

2716 
i
 = 0; i < 
iv_couÁ
; i++)

2717 
	`sc¡_put_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

2719 ià(
fšished
)

2722 
loff
 +ð
fuÎ_Ën
;

2723 
Ëngth
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, (
ušt8_t
 
__fÜû
 **)&
add»ss
);

2726 
	`£t_fs
(
Þd_fs
);

2728 
out
:

2729 
	`TRACE_EXIT
();

2732 
out_£t_fs
:

2733 
	`£t_fs
(
Þd_fs
);

2734 
i
 = 0; i < 
iv_couÁ
; i++)

2735 
	`sc¡_put_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

2736 
out
;

2737 
	}
}

2739 
	$vdisk_exec_wr™e
(
sc¡_cmd
 *
cmd
,

2740 
sc¡_vdisk_thr
 *
thr
, 
loff_t
 
loff
)

2742 
mm_£gm’t_t
 
Þd_fs
;

2743 
loff_t
 
”r
;

2744 
ssize_t
 
Ëngth
, 
fuÎ_Ën
, 
§ved_fuÎ_Ën
;

2745 
ušt8_t
 
__u£r
 *
add»ss
;

2746 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

2747 
fže
 *
fd
 = 
thr
->fd;

2748 
iovec
 *
iv
, *
eiv
;

2749 
i
, 
iv_couÁ
, 
eiv_couÁ
;

2750 
boÞ
 
fšished
 = 
çl£
;

2752 
	`TRACE_ENTRY
();

2754 ià(
vœt_dev
->
nuÎio
)

2755 
out
;

2757 
iv
 = 
	`vdisk_®loc_iv
(
cmd
, 
thr
);

2758 ià(
iv
 =ð
NULL
)

2759 
out
;

2761 
Ëngth
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, (
ušt8_t
 
__fÜû
 **)&
add»ss
);

2762 ià(
	`uÆik–y
(
Ëngth
 < 0)) {

2763 
	`PRINT_ERROR
("sc¡_g‘_buf_fœ¡(èçžed: %zd", 
Ëngth
);

2764 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2765 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2766 
out
;

2769 
Þd_fs
 = 
	`g‘_fs
();

2770 
	`£t_fs
(
	`g‘_ds
());

2773 
iv_couÁ
 = 0;

2774 
fuÎ_Ën
 = 0;

2775 
i
 = -1;

2776 
Ëngth
 > 0) {

2777 
fuÎ_Ën
 +ð
Ëngth
;

2778 
i
++;

2779 
iv_couÁ
++;

2780 
iv
[
i
].
iov_ba£
 = 
add»ss
;

2781 
iv
[
i
].
iov_Ën
 = 
Ëngth
;

2782 ià(
iv_couÁ
 =ð
UIO_MAXIOV
)

2784 
Ëngth
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
,

2785 (
ušt8_t
 
__fÜû
 **)&
add»ss
);

2787 ià(
Ëngth
 == 0) {

2788 
fšished
 = 
Œue
;

2789 ià(
	`uÆik–y
(
iv_couÁ
 == 0))

2791 } ià(
	`uÆik–y
(
Ëngth
 < 0)) {

2792 
	`PRINT_ERROR
("sc¡_g‘_buf_Ãxt(èçžed: %zd", 
Ëngth
);

2793 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2794 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2795 
out_£t_fs
;

2798 
§ved_fuÎ_Ën
 = 
fuÎ_Ën
;

2799 
eiv
 = 
iv
;

2800 
eiv_couÁ
 = 
iv_couÁ
;

2801 
»¡¬t
:

2802 
	`TRACE_DBG
("wr™šgÓiv_couÁ %d, fuÎ_ËÀ%zd)", 
eiv_couÁ
, 
fuÎ_Ën
);

2805 ià(
fd
->
f_Ý
->
Î£ek
)

2806 
”r
 = 
fd
->
f_Ý
->
	`Î£ek
(fd, 
loff
, 0 );

2808 
”r
 = 
	`deçuÉ_Î£ek
(
fd
, 
loff
, 0 );

2809 ià(
”r
 !ð
loff
) {

2810 
	`PRINT_ERROR
("lseekrouble %lld != %lld",

2811 ()
”r
,

2812 ()
loff
);

2813 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2814 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2815 
out_£t_fs
;

2819 
”r
 = 
	`vfs_wr™ev
(
fd
, (
iovec
 
__fÜû
 
__u£r
 *)
eiv
, 
eiv_couÁ
,

2820 &
fd
->
f_pos
);

2822 ià(
”r
 < 0) {

2823 
	`PRINT_ERROR
("write()„eturned %lld from %zd",

2824 ()
”r
,

2825 
fuÎ_Ën
);

2826 ià(
”r
 =ð-
EAGAIN
)

2827 
	`sc¡_£t_busy
(
cmd
);

2829 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2830 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

2832 
out_£t_fs
;

2833 } ià(
”r
 < 
fuÎ_Ën
) {

2838 
e
 = 
eiv_couÁ
;

2839 
	`TRACE_MGMT_DBG
("write()„eturned %d from %zd "

2840 "(iv_couÁ=%d)", ()
”r
, 
fuÎ_Ën
,

2841 
eiv_couÁ
);

2842 ià(
”r
 == 0) {

2843 
	`PRINT_INFO
("Suspicious: write()„eturned 0 from "

2844 "%zd (iv_couÁ=%d)", 
fuÎ_Ën
, 
eiv_couÁ
);

2846 
fuÎ_Ën
 -ð
”r
;

2847 
i
 = 0; i < 
e
; i++) {

2848 ià(()
eiv
->
iov_Ën
 < 
”r
) {

2849 
”r
 -ð
eiv
->
iov_Ën
;

2850 
eiv
++;

2851 
eiv_couÁ
--;

2853 
eiv
->
iov_ba£
 =

2854 (
ušt8_t
 
__fÜû
 
__u£r
 *)
eiv
->
iov_ba£
 + 
”r
;

2855 
eiv
->
iov_Ën
 -ð
”r
;

2859 
»¡¬t
;

2862 
i
 = 0; i < 
iv_couÁ
; i++)

2863 
	`sc¡_put_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

2865 ià(
fšished
)

2868 
loff
 +ð
§ved_fuÎ_Ën
;

2869 
Ëngth
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, (
ušt8_t
 
__fÜû
 **)&
add»ss
);

2872 
	`£t_fs
(
Þd_fs
);

2874 
out
:

2875 
	`TRACE_EXIT
();

2878 
out_£t_fs
:

2879 
	`£t_fs
(
Þd_fs
);

2880 
i
 = 0; i < 
iv_couÁ
; i++)

2881 
	`sc¡_put_buf
(
cmd
, (
__fÜû
 *)(
iv
[
i
].
iov_ba£
));

2882 
out
;

2883 
	}
}

2885 
	ssc¡_blockio_wÜk
 {

2886 
©omic_t
 
	mbios_šæight
;

2887 
sc¡_cmd
 *
	mcmd
;

2890 
šlše
 
	$blockio_check_fšish
(
sc¡_blockio_wÜk
 *
blockio_wÜk
)

2893 ià(
	`©omic_dec_ªd_‹¡
(&
blockio_wÜk
->
bios_šæight
)) {

2894 
blockio_wÜk
->
cmd
->
com¶‘ed
 = 1;

2895 
blockio_wÜk
->
cmd
->
	`sc¡_cmd_dÚe
(blockio_work->cmd,

2896 
SCST_CMD_STATE_DEFAULT
, 
	`sc¡_e¡im©e_cÚ‹xt
());

2897 
	`kmem_ÿche_ä“
(
blockio_wÜk_ÿch•
, 
blockio_wÜk
);

2900 
	}
}

2902 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24)

2903 
	$blockio_’dio
(
bio
 *bio, 
by‹s_dÚe
, 
”rÜ
)

2905 
	$blockio_’dio
(
bio
 *bio, 
”rÜ
)

2908 
sc¡_blockio_wÜk
 *
blockio_wÜk
 = 
bio
->
bi_´iv©e
;

2910 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 24)

2911 ià(
bio
->
bi_size
)

2915 ià(
	`uÆik–y
(!
	`bio_æagged
(
bio
, 
BIO_UPTODATE
))) {

2916 ià(
”rÜ
 == 0) {

2917 
	`PRINT_ERROR
("Not upo date bio withƒrror 0 for "

2918 "cmd %p,„‘uºšg -EIO", 
blockio_wÜk
->
cmd
);

2919 
”rÜ
 = -
EIO
;

2923 ià(
	`uÆik–y
(
”rÜ
 != 0)) {

2924 
	`DEFINE_SPINLOCK
(
blockio_’dio_lock
);

2925 
æags
;

2927 
	`PRINT_ERROR
("cmd %°»tuºedƒ¼Ü %d", 
blockio_wÜk
->
cmd
,

2928 
”rÜ
);

2931 
	`¥š_lock_œq§ve
(&
blockio_’dio_lock
, 
æags
);

2933 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 36)

2934 ià(
bio
->
bi_rw
 & (1 << 
BIO_RW
))

2936 ià(
bio
->
bi_rw
 & 
REQ_WRITE
)

2938 
	`sc¡_£t_cmd_”rÜ
(
blockio_wÜk
->
cmd
,

2939 
	`SCST_LOAD_SENSE
(
sc¡_£n£_wr™e_”rÜ
));

2941 
	`sc¡_£t_cmd_”rÜ
(
blockio_wÜk
->
cmd
,

2942 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

2944 
	`¥š_uÆock_œq»¡Üe
(&
blockio_’dio_lock
, 
æags
);

2947 
	`blockio_check_fšish
(
blockio_wÜk
);

2949 
	`bio_put
(
bio
);

2950 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 24)

2955 
	}
}

2957 
	$blockio_exec_rw
(
sc¡_cmd
 *
cmd
, 
sc¡_vdisk_thr
 *
thr
,

2958 
u64
 
lba_¡¬t
, 
wr™e
)

2960 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

2961 
block_deviû
 *
bdev
 = 
thr
->bdev;

2962 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
bdev
);

2963 
Ëngth
, 
max_Ä_vecs
 = 0, 
off£t
;

2964 
·ge
 *page;

2965 
bio
 *biØð
NULL
, *
hbio
 = NULL, *
tbio
 = NULL;

2966 
Ãed_Ãw_bio
;

2967 
sc¡_blockio_wÜk
 *
blockio_wÜk
;

2968 
bios
 = 0;

2969 
gå_t
 
gå_mask
 = (
cmd
->
noio_mem_®loc
 ? 
GFP_NOIO
 : 
GFP_KERNEL
);

2970 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 39)

2971 
blk_¶ug
 
¶ug
;

2974 
	`TRACE_ENTRY
();

2976 ià(
vœt_dev
->
nuÎio
)

2977 
out
;

2980 
blockio_wÜk
 = 
	`kmem_ÿche_®loc
(
blockio_wÜk_ÿch•
, 
gå_mask
);

2981 ià(
blockio_wÜk
 =ð
NULL
)

2982 
out_no_mem
;

2984 
blockio_wÜk
->
cmd
 = cmd;

2986 ià(
q
)

2987 
max_Ä_vecs
 = 
	`mš
(
	`bio_g‘_Ä_vecs
(
bdev
), 
BIO_MAX_PAGES
);

2989 
max_Ä_vecs
 = 1;

2991 
Ãed_Ãw_bio
 = 1;

2993 
Ëngth
 = 
	`sc¡_g‘_sg_·ge_fœ¡
(
cmd
, &
·ge
, &
off£t
);

2994 
Ëngth
 > 0) {

2995 
Ën
, 
by‹s
, 
off
, 
thi¦’
;

2996 
·ge
 *
pg
;

2997 
u64
 
lba_¡¬t0
;

2999 
pg
 = 
·ge
;

3000 
Ën
 = 
Ëngth
;

3001 
off
 = 
off£t
;

3002 
thi¦’
 = 0;

3003 
lba_¡¬t0
 = 
lba_¡¬t
;

3005 
Ën
 > 0) {

3006 
rc
;

3008 ià(
Ãed_Ãw_bio
) {

3009 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

3010 
bio
 = 
	`bio_km®loc
(
gå_mask
, 
max_Ä_vecs
);

3012 
bio
 = 
	`bio_®loc
(
gå_mask
, 
max_Ä_vecs
);

3014 ià(!
bio
) {

3015 
	`PRINT_ERROR
("Failedo create bio "

3017 
cmd
->
g‘_sg_buf_’Œy_num
, cmd);

3018 
out_no_bio
;

3021 
bios
++;

3022 
Ãed_Ãw_bio
 = 0;

3023 
bio
->
bi_’d_io
 = 
blockio_’dio
;

3024 
bio
->
bi_£ùÜ
 = 
lba_¡¬t0
 <<

3025 (
vœt_dev
->
block_shiá
 - 9);

3026 
bio
->
bi_bdev
 = 
bdev
;

3027 
bio
->
bi_´iv©e
 = 
blockio_wÜk
;

3032 #ià
LINUX_VERSION_CODE
 <ð
	`KERNEL_VERSION
(2, 6, 27)

3033 
bio
->
bi_rw
 |ð(1 << 
BIO_RW_FAILFAST
);

3034 #–ià
LINUX_VERSION_CODE
 <ð
	`KERNEL_VERSION
(2, 6, 35)

3035 
bio
->
bi_rw
 |ð(1 << 
BIO_RW_FAILFAST_DEV
) |

3036 (1 << 
BIO_RW_FAILFAST_TRANSPORT
) |

3037 (1 << 
BIO_RW_FAILFAST_DRIVER
);

3039 
bio
->
bi_rw
 |ð
REQ_FAILFAST_DEV
 |

3040 
REQ_FAILFAST_TRANSPORT
 |

3041 
REQ_FAILFAST_DRIVER
;

3044 
bio
->
bi_rw
 |ð
REQ_SYNC
;

3046 ià(!
hbio
)

3047 
hbio
 = 
tbio
 = 
bio
;

3049 
tbio
 =bio->
bi_Ãxt
 = 
bio
;

3052 
by‹s
 = 
	`mš_t
(, 
Ën
, 
PAGE_SIZE
 - 
off
);

3054 
rc
 = 
	`bio_add_·ge
(
bio
, 
pg
, 
by‹s
, 
off
);

3055 ià(
rc
 < 
by‹s
) {

3056 
	`sBUG_ON
(
rc
 != 0);

3057 
Ãed_Ãw_bio
 = 1;

3058 
lba_¡¬t0
 +ð
thi¦’
 >> 
vœt_dev
->
block_shiá
;

3059 
thi¦’
 = 0;

3063 
pg
++;

3064 
thi¦’
 +ð
by‹s
;

3065 
Ën
 -ð
by‹s
;

3066 
off
 = 0;

3069 
lba_¡¬t
 +ð
Ëngth
 >> 
vœt_dev
->
block_shiá
;

3071 
	`sc¡_put_sg_·ge
(
cmd
, 
·ge
, 
off£t
);

3072 
Ëngth
 = 
	`sc¡_g‘_sg_·ge_Ãxt
(
cmd
, &
·ge
, &
off£t
);

3076 
	`©omic_£t
(&
blockio_wÜk
->
bios_šæight
, 
bios
+1);

3078 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 39)

3079 
	`blk_¡¬t_¶ug
(&
¶ug
);

3082 
hbio
) {

3083 
bio
 = 
hbio
;

3084 
hbio
 = hbio->
bi_Ãxt
;

3085 
bio
->
bi_Ãxt
 = 
NULL
;

3086 
	`subm™_bio
((
wr™e
 !ð0), 
bio
);

3089 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 39)

3090 
	`blk_fšish_¶ug
(&
¶ug
);

3092 ià(
q
 && q->
uÅlug_â
)

3093 
q
->
	`uÅlug_â
(q);

3096 
	`blockio_check_fšish
(
blockio_wÜk
);

3098 
out
:

3099 
	`TRACE_EXIT
();

3102 
out_no_bio
:

3103 
hbio
) {

3104 
bio
 = 
hbio
;

3105 
hbio
 = hbio->
bi_Ãxt
;

3106 
	`bio_put
(
bio
);

3108 
	`kmem_ÿche_ä“
(
blockio_wÜk_ÿch•
, 
blockio_wÜk
);

3110 
out_no_mem
:

3111 
	`sc¡_£t_busy
(
cmd
);

3112 
out
;

3113 
	}
}

3115 
	$vdisk_blockio_æush
(
block_deviû
 *
bdev
, 
gå_t
 
gå_mask
,

3116 
boÞ
 
»pÜt_”rÜ
)

3118 
»s
 = 0;

3120 
	`TRACE_ENTRY
();

3122 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 35) \

3123 && !(
	`defšed
(
CONFIG_SUSE_KERNEL
) \

3124 && 
LINUX_VERSION_CODE
 =ð
	`KERNEL_VERSION
(2, 6, 34))

3125 
»s
 = 
	`blkdev_issue_æush
(
bdev
, 
NULL
);

3126 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 37)

3127 
»s
 = 
	`blkdev_issue_æush
(
bdev
, 
gå_mask
, 
NULL
, 
BLKDEV_IFL_WAIT
);

3129 
»s
 = 
	`blkdev_issue_æush
(
bdev
, 
gå_mask
, 
NULL
);

3131 ià((
»s
 !ð0è&& 
»pÜt_”rÜ
)

3132 
	`PRINT_ERROR
("blkdev_issue_æush(èçžed: %d", 
»s
);

3134 
	`TRACE_EXIT_RES
(
»s
);

3135  
»s
;

3136 
	}
}

3138 
	$vdisk_exec_v”ify
(
sc¡_cmd
 *
cmd
,

3139 
sc¡_vdisk_thr
 *
thr
, 
loff_t
 
loff
)

3141 
mm_£gm’t_t
 
Þd_fs
;

3142 
loff_t
 
”r
;

3143 
ssize_t
 
Ëngth
, 
Ën_mem
 = 0;

3144 
ušt8_t
 *
add»ss_§v
, *
add»ss
;

3145 
com·»
;

3146 
sc¡_vdisk_dev
 *
vœt_dev
 = 
cmd
->
dev
->
dh_´iv
;

3147 
fže
 *
fd
 = 
thr
->fd;

3148 
ušt8_t
 *
mem_v”ify
 = 
NULL
;

3150 
	`TRACE_ENTRY
();

3152 ià(
	`vdisk_fsync
(
thr
, 
loff
, 
cmd
->
bufæ’
, cmd, cmd->
dev
) != 0)

3153 
out
;

3164 
Þd_fs
 = 
	`g‘_fs
();

3165 
	`£t_fs
(
	`g‘_ds
());

3167 ià(!
vœt_dev
->
nuÎio
) {

3168 ià(
fd
->
f_Ý
->
Î£ek
)

3169 
”r
 = 
fd
->
f_Ý
->
	`Î£ek
(fd, 
loff
, 0 );

3171 
”r
 = 
	`deçuÉ_Î£ek
(
fd
, 
loff
, 0 );

3172 ià(
”r
 !ð
loff
) {

3173 
	`PRINT_ERROR
("lseekrouble %lld != %lld",

3174 ()
”r
,

3175 ()
loff
);

3176 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3177 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3178 
out_£t_fs
;

3182 
mem_v”ify
 = 
	`vm®loc
(
LEN_MEM
);

3183 ià(
mem_v”ify
 =ð
NULL
) {

3184 
	`PRINT_ERROR
("Unableo‡llocate memory %d for verify",

3185 
LEN_MEM
);

3186 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3187 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3188 
out_£t_fs
;

3191 
Ëngth
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
add»ss
);

3192 
add»ss_§v
 = 
add»ss
;

3193 ià(!
Ëngth
 && 
cmd
->
d©a_Ën
) {

3194 
Ëngth
 = 
cmd
->
d©a_Ën
;

3195 
com·»
 = 0;

3197 
com·»
 = 1;

3199 
Ëngth
 > 0) {

3200 
Ën_mem
 = (
Ëngth
 > 
LEN_MEM
) ? LEN_MEM :†ength;

3201 
	`TRACE_DBG
("V”ify:†’gth %zd -†’_mem %zd", 
Ëngth
, 
Ën_mem
);

3203 ià(!
vœt_dev
->
nuÎio
)

3204 
”r
 = 
	`vfs_»ad
(
fd
, (
__fÜû
 
__u£r
 *)
mem_v”ify
,

3205 
Ën_mem
, &
fd
->
f_pos
);

3207 
”r
 = 
Ën_mem
;

3208 ià((
”r
 < 0è|| (”¸< 
Ën_mem
)) {

3209 
	`PRINT_ERROR
("verify()„eturned %lld from %zd",

3210 ()
”r
, 
Ën_mem
);

3211 ià(
”r
 =ð-
EAGAIN
)

3212 
	`sc¡_£t_busy
(
cmd
);

3214 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3215 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»ad_”rÜ
));

3217 ià(
com·»
)

3218 
	`sc¡_put_buf
(
cmd
, 
add»ss_§v
);

3219 
out_£t_fs
;

3221 ià(
com·»
 && 
	`memcmp
(
add»ss
, 
mem_v”ify
, 
Ën_mem
) != 0) {

3222 
	`TRACE_DBG
("V”ify:ƒ¼Ü memcm°Ëngth %zd", 
Ëngth
);

3223 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3224 
	`SCST_LOAD_SENSE
(
sc¡_£n£_miscom·»_”rÜ
));

3225 
	`sc¡_put_buf
(
cmd
, 
add»ss_§v
);

3226 
out_£t_fs
;

3228 
Ëngth
 -ð
Ën_mem
;

3229 
add»ss
 +ð
Ën_mem
;

3230 ià(
com·»
 && 
Ëngth
 <= 0) {

3231 
	`sc¡_put_buf
(
cmd
, 
add»ss_§v
);

3232 
Ëngth
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
add»ss
);

3233 
add»ss_§v
 = 
add»ss
;

3237 ià(
Ëngth
 < 0) {

3238 
	`PRINT_ERROR
("sc¡_g‘_buf_(èçžed: %zd", 
Ëngth
);

3239 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3240 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3243 
out_£t_fs
:

3244 
	`£t_fs
(
Þd_fs
);

3245 ià(
mem_v”ify
)

3246 
	`vä“
(
mem_v”ify
);

3248 
out
:

3249 
	`TRACE_EXIT
();

3251 
	}
}

3253 
	$vdisk_sk_mgmt_â
(
sc¡_mgmt_cmd
 *
mcmd
,

3254 
sc¡_tgt_dev
 *
tgt_dev
)

3256 
	`TRACE_ENTRY
();

3258 ià((
mcmd
->
â
 =ð
SCST_LUN_RESET
è|| (mcmd->â =ð
SCST_TARGET_RESET
)) {

3260 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

3261 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

3263 
dev
->
t¡
 = 
DEF_TST
;

3264 
dev
->
d_£n£
 = 
DEF_DSENSE
;

3265 ià(
vœt_dev
->
wt_æag
 && !vœt_dev->
nv_ÿche
)

3266 
dev
->
queue_®g
 = 
DEF_QUEUE_ALG_WT
;

3268 
dev
->
queue_®g
 = 
DEF_QUEUE_ALG
;

3269 
dev
->
swp
 = 
DEF_SWP
;

3270 
dev
->
s
 = 
DEF_TAS
;

3272 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

3273 
vœt_dev
->
´ev’t_®low_medium_»mov®
 = 0;

3274 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

3275 } ià(
mcmd
->
â
 =ð
SCST_PR_ABORT_ALL
) {

3276 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

3277 
sc¡_vdisk_dev
 *
vœt_dev
 = 
dev
->
dh_´iv
;

3278 
	`¥š_lock
(&
vœt_dev
->
æags_lock
);

3279 
vœt_dev
->
´ev’t_®low_medium_»mov®
 = 0;

3280 
	`¥š_uÆock
(&
vœt_dev
->
æags_lock
);

3283 
	`TRACE_EXIT
();

3284  
SCST_DEV_TM_NOT_COMPLETED
;

3285 
	}
}

3287 
	$vdisk_»pÜt_»gi¡”šg
(cÚ¡ 
sc¡_vdisk_dev
 *
vœt_dev
)

3289 
buf
[128];

3290 
i
, 
j
;

3292 
i
 = 
	`¢´štf
(
buf
, (buf), "Registering virtual %s device %s ",

3293 
vœt_dev
->
vdev_devt
->
Çme
, virt_dev->name);

3294 
j
 = 
i
;

3296 ià(
vœt_dev
->
wt_æag
)

3297 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "(WRITE_THROUGH");

3299 ià(
vœt_dev
->
nv_ÿche
)

3300 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sNV_CACHE",

3301 (
j
 =ð
i
) ? "(" : ", ");

3303 ià(
vœt_dev
->
rd_Úly
)

3304 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sREAD_ONLY",

3305 (
j
 =ð
i
) ? "(" : ", ");

3307 ià(
vœt_dev
->
o_dœeù_æag
)

3308 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sO_DIRECT",

3309 (
j
 =ð
i
) ? "(" : ", ");

3311 ià(
vœt_dev
->
nuÎio
)

3312 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sNULLIO",

3313 (
j
 =ð
i
) ? "(" : ", ");

3315 ià(
vœt_dev
->
blockio
)

3316 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sBLOCKIO",

3317 (
j
 =ð
i
) ? "(" : ", ");

3319 ià(
vœt_dev
->
»movabË
)

3320 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sREMOVABLE",

3321 (
j
 =ð
i
) ? "(" : ", ");

3323 ià(
vœt_dev
->
thš_´ovisiÚed
)

3324 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sTHIN PROVISIONED",

3325 (
j
 =ð
i
) ? "(" : ", ");

3327 ià(
j
 =ð
i
)

3328 
	`PRINT_INFO
("%s", 
buf
);

3330 
	`PRINT_INFO
("%s)", 
buf
);

3333 
	}
}

3335 
	$vdisk_»sync_size
(
sc¡_vdisk_dev
 *
vœt_dev
)

3337 
loff_t
 
fže_size
;

3338 
»s
 = 0;

3340 
	`sBUG_ON
(
vœt_dev
->
nuÎio
);

3342 
»s
 = 
	`vdisk_g‘_fže_size
(
vœt_dev
->
fž’ame
,

3343 
vœt_dev
->
blockio
, &
fže_size
);

3344 ià(
»s
 != 0)

3345 
out
;

3347 ià(
fže_size
 =ð
vœt_dev
->file_size) {

3348 
	`PRINT_INFO
("Size of virtual disk %s„emainedhe same",

3349 
vœt_dev
->
Çme
);

3350 
out
;

3353 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

3354 ià(
»s
 != 0)

3355 
out
;

3357 
vœt_dev
->
fže_size
 = file_size;

3358 
vœt_dev
->
nblocks
 = vœt_dev->
fže_size
 >> vœt_dev->
block_shiá
;

3360 
	`sc¡_dev_d–_®l_thr_d©a
(
vœt_dev
->
dev
);

3362 
	`PRINT_INFO
("New size of SCSIarget virtual disk %s "

3364 
vœt_dev
->
Çme
, vœt_dev->
fže_size
 >> 20,

3365 
vœt_dev
->
block_size
,

3366 ()
vœt_dev
->
nblocks
,

3367 ()
vœt_dev
->
nblocks
/64/32,

3368 
vœt_dev
->
nblocks
 < 64*32 ? " !WARNING! cyln†ess "

3371 
	`sc¡_ÿ·c™y_d©a_chªged
(
vœt_dev
->
dev
);

3373 
	`sc¡_»sume_aùiv™y
();

3375 
out
:

3376  
»s
;

3377 
	}
}

3379 
	$vdev_ü—‹
(
sc¡_dev_ty³
 *
devt
,

3380 cÚ¡ *
Çme
, 
sc¡_vdisk_dev
 **
»s_vœt_dev
)

3382 
»s
;

3383 
sc¡_vdisk_dev
 *
vœt_dev
;

3384 
ušt64_t
 
dev_id_num
;

3386 
»s
 = -
EEXIST
;

3387 ià(
	`vdev_fšd
(
Çme
))

3388 
out
;

3390 
vœt_dev
 = 
	`kz®loc
((*vœt_dev), 
GFP_KERNEL
);

3391 ià(
vœt_dev
 =ð
NULL
) {

3392 
	`PRINT_ERROR
("Allocation of virtual device %s failed",

3393 
devt
->
Çme
);

3394 
»s
 = -
ENOMEM
;

3395 
out
;

3398 
	`¥š_lock_š™
(&
vœt_dev
->
æags_lock
);

3399 
vœt_dev
->
vdev_devt
 = 
devt
;

3401 
vœt_dev
->
rd_Úly
 = 
DEF_RD_ONLY
;

3402 
vœt_dev
->
»movabË
 = 
DEF_REMOVABLE
;

3403 
vœt_dev
->
thš_´ovisiÚed
 = 
DEF_THIN_PROVISIONED
;

3405 
vœt_dev
->
block_size
 = 
DEF_DISK_BLOCKSIZE
;

3406 
vœt_dev
->
block_shiá
 = 
DEF_DISK_BLOCKSIZE_SHIFT
;

3408 ià(
	`¡¾’
(
Çme
è>ð(
vœt_dev
->name)) {

3409 
	`PRINT_ERROR
("Nam% i toØlÚg (max‡Îowed %zd)", 
Çme
,

3410 (
vœt_dev
->
Çme
)-1);

3411 
»s
 = -
EINVAL
;

3412 
out_ä“
;

3414 
	`¡rýy
(
vœt_dev
->
Çme
,‚ame);

3416 
dev_id_num
 = 
	`vdisk_g’_dev_id_num
(
vœt_dev
->
Çme
);

3418 
	`¢´štf
(
vœt_dev
->
t10_dev_id
, (virt_dev->t10_dev_id),

3419 "%Îx-%s", 
dev_id_num
, 
vœt_dev
->
Çme
);

3420 
	`TRACE_DBG
("t10_dev_id %s", 
vœt_dev
->
t10_dev_id
);

3422 
	`sú´štf
(
vœt_dev
->
u¢
, (vœt_dev->u¢), "%Îx", 
dev_id_num
);

3423 
	`TRACE_DBG
("u¢ %s", 
vœt_dev
->
u¢
);

3425 *
»s_vœt_dev
 = 
vœt_dev
;

3426 
»s
 = 0;

3428 
out
:

3429  
»s
;

3431 
out_ä“
:

3432 
	`kä“
(
vœt_dev
);

3433 
out
;

3434 
	}
}

3436 
	$vdev_de¡roy
(
sc¡_vdisk_dev
 *
vœt_dev
)

3438 
	`kä“
(
vœt_dev
->
fž’ame
);

3439 
	`kä“
(
vœt_dev
);

3441 
	}
}

3443 #iâdeà
CONFIG_SCST_PROC


3445 
	$vdev_·r£_add_dev_·¿ms
(
sc¡_vdisk_dev
 *
vœt_dev
,

3446 *
·¿ms
, cÚ¡ *
®lowed_·¿ms
[])

3448 
»s
 = 0;

3449 
v®
;

3450 *
·¿m
, *
p
, *
µ
;

3452 
	`TRACE_ENTRY
();

3455 
·¿m
 = 
	`sc¡_g‘_Ãxt_tok’_¡r
(&
·¿ms
);

3456 ià(
·¿m
 =ð
NULL
)

3459 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

3460 ià(*
p
 == '\0') {

3461 
	`PRINT_ERROR
("Syntaxƒrror‡t %s (device %s)",

3462 
·¿m
, 
vœt_dev
->
Çme
);

3463 
»s
 = -
EINVAL
;

3464 
out
;

3467 ià(
®lowed_·¿ms
 !ð
NULL
) {

3468 cÚ¡ **
a
 = 
®lowed_·¿ms
;

3469 
boÞ
 
®lowed
 = 
çl£
;

3471 *
a
 !ð
NULL
) {

3472 ià(!
	`¡rÿ£cmp
(*
a
, 
p
)) {

3473 
®lowed
 = 
Œue
;

3476 
a
++;

3479 ià(!
®lowed
) {

3480 
	`PRINT_ERROR
("UnknowÀ·¿m‘” % (deviû %s)", 
p
,

3481 
vœt_dev
->
Çme
);

3482 
»s
 = -
EINVAL
;

3483 
out
;

3487 
µ
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

3488 ià(*
µ
 == '\0') {

3489 
	`PRINT_ERROR
("Parameter %s value missed for device %s",

3490 
p
, 
vœt_dev
->
Çme
);

3491 
»s
 = -
EINVAL
;

3492 
out
;

3495 ià(
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
)[0] != '\0') {

3496 
	`PRINT_ERROR
("Too many…arameter's %s values (device %s)",

3497 
p
, 
vœt_dev
->
Çme
);

3498 
»s
 = -
EINVAL
;

3499 
out
;

3502 ià(!
	`¡rÿ£cmp
("fž’ame", 
p
)) {

3503 ià(*
µ
 != '/') {

3504 
	`PRINT_ERROR
("Filename %s must be global "

3505 "(deviû %s)", 
µ
, 
vœt_dev
->
Çme
);

3506 
»s
 = -
EINVAL
;

3507 
out
;

3510 
vœt_dev
->
fž’ame
 = 
	`k¡rdup
(
µ
, 
GFP_KERNEL
);

3511 ià(
vœt_dev
->
fž’ame
 =ð
NULL
) {

3512 
	`PRINT_ERROR
("Unableo duplicate file‚ame %s "

3513 "(deviû %s)", 
µ
, 
vœt_dev
->
Çme
);

3514 
»s
 = -
ENOMEM
;

3515 
out
;

3520 
»s
 = 
	`¡riù_¡¹oul
(
µ
, 0, &
v®
);

3521 ià(
»s
 != 0) {

3522 
	`PRINT_ERROR
("strict_strtoul() for %s failed: %d "

3523 "(deviû %s)", 
µ
, 
»s
, 
vœt_dev
->
Çme
);

3524 
out
;

3527 ià(!
	`¡rÿ£cmp
("wr™e_through", 
p
)) {

3528 
vœt_dev
->
wt_æag
 = 
v®
;

3529 
	`TRACE_DBG
("WRITE THROUGH %d", 
vœt_dev
->
wt_æag
);

3530 } ià(!
	`¡rÿ£cmp
("nv_ÿche", 
p
)) {

3531 
vœt_dev
->
nv_ÿche
 = 
v®
;

3532 
	`TRACE_DBG
("NON-VOLATILE CACHE %d", 
vœt_dev
->
nv_ÿche
);

3533 } ià(!
	`¡rÿ£cmp
("o_dœeù", 
p
)) {

3535 
vœt_dev
->
o_dœeù_æag
 = 
v®
;

3536 
	`TRACE_DBG
("O_DIRECT %d", 
vœt_dev
->
o_dœeù_æag
);

3538 
	`PRINT_INFO
("O_DIRECT flag doesn't currently"

3540 "š O_DIRECT modš¡—d (deviû %s)", 
vœt_dev
->
Çme
);

3542 } ià(!
	`¡rÿ£cmp
("»ad_Úly", 
p
)) {

3543 
vœt_dev
->
rd_Úly
 = 
v®
;

3544 
	`TRACE_DBG
("READ ONLY %d", 
vœt_dev
->
rd_Úly
);

3545 } ià(!
	`¡rÿ£cmp
("»movabË", 
p
)) {

3546 
vœt_dev
->
»movabË
 = 
v®
;

3547 
	`TRACE_DBG
("REMOVABLE %d", 
vœt_dev
->
»movabË
);

3548 } ià(!
	`¡rÿ£cmp
("thš_´ovisiÚed", 
p
)) {

3549 
vœt_dev
->
thš_´ovisiÚed
 = 
v®
;

3550 
	`TRACE_DBG
("THIN PROVISIONED %d",

3551 
vœt_dev
->
thš_´ovisiÚed
);

3552 } ià(!
	`¡rÿ£cmp
("blocksize", 
p
)) {

3553 
vœt_dev
->
block_size
 = 
v®
;

3554 
vœt_dev
->
block_shiá
 = 
	`sc¡_ÿlc_block_shiá
(

3555 
vœt_dev
->
block_size
);

3556 ià(
vœt_dev
->
block_shiá
 < 9) {

3557 
»s
 = -
EINVAL
;

3558 
out
;

3560 
	`TRACE_DBG
("block_size %d, block_shift %d",

3561 
vœt_dev
->
block_size
,

3562 
vœt_dev
->
block_shiá
);

3564 
	`PRINT_ERROR
("UnknowÀ·¿m‘” % (deviû %s)", 
p
,

3565 
vœt_dev
->
Çme
);

3566 
»s
 = -
EINVAL
;

3567 
out
;

3571 
out
:

3572 
	`TRACE_EXIT_RES
(
»s
);

3573  
»s
;

3574 
	}
}

3577 
	$vdev_fžeio_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

3579 
»s
 = 0;

3580 
sc¡_vdisk_dev
 *
vœt_dev
;

3582 
	`TRACE_ENTRY
();

3584 
»s
 = 
	`vdev_ü—‹
(&
vdisk_fže_devty³
, 
deviû_Çme
, &
vœt_dev
);

3585 ià(
»s
 != 0)

3586 
out
;

3588 
vœt_dev
->
commªd_£t_v”siÚ
 = 0x04C0;

3590 
vœt_dev
->
wt_æag
 = 
DEF_WRITE_THROUGH
;

3591 
vœt_dev
->
nv_ÿche
 = 
DEF_NV_CACHE
;

3592 
vœt_dev
->
o_dœeù_æag
 = 
DEF_O_DIRECT
;

3594 
»s
 = 
	`vdev_·r£_add_dev_·¿ms
(
vœt_dev
, 
·¿ms
, 
NULL
);

3595 ià(
»s
 != 0)

3596 
out_de¡roy
;

3598 ià(
vœt_dev
->
rd_Úly
 && (vœt_dev->
wt_æag
 || vœt_dev->
nv_ÿche
)) {

3599 
	`PRINT_ERROR
("Write options on„ead only device %s",

3600 
vœt_dev
->
Çme
);

3601 
»s
 = -
EINVAL
;

3602 
out_de¡roy
;

3605 ià(
vœt_dev
->
fž’ame
 =ð
NULL
) {

3606 
	`PRINT_ERROR
("FžÇm»quœed (deviû %s)", 
vœt_dev
->
Çme
);

3607 
»s
 = -
EINVAL
;

3608 
out_de¡roy
;

3611 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
, &
vdev_li¡
);

3613 
	`vdisk_»pÜt_»gi¡”šg
(
vœt_dev
);

3615 
vœt_dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(vœt_dev->
vdev_devt
,

3616 
vœt_dev
->
Çme
);

3617 ià(
vœt_dev
->
vœt_id
 < 0) {

3618 
»s
 = 
vœt_dev
->
vœt_id
;

3619 
out_d–
;

3622 
	`TRACE_DBG
("Regi¡”ed vœt_dev % w™h id %d", 
vœt_dev
->
Çme
,

3623 
vœt_dev
->
vœt_id
);

3625 
out
:

3626 
	`TRACE_EXIT_RES
(
»s
);

3627  
»s
;

3629 
out_d–
:

3630 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

3632 
out_de¡roy
:

3633 
	`vdev_de¡roy
(
vœt_dev
);

3634 
out
;

3635 
	}
}

3638 
	$vdev_blockio_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

3640 
»s
 = 0;

3641 cÚ¡ *
®lowed_·¿ms
[] = { "filename", "read_only", "removable",

3643 "thš_´ovisiÚed", 
NULL
 };

3644 
sc¡_vdisk_dev
 *
vœt_dev
;

3646 
	`TRACE_ENTRY
();

3648 
»s
 = 
	`vdev_ü—‹
(&
vdisk_blk_devty³
, 
deviû_Çme
, &
vœt_dev
);

3649 ià(
»s
 != 0)

3650 
out
;

3652 
vœt_dev
->
commªd_£t_v”siÚ
 = 0x04C0;

3654 
vœt_dev
->
blockio
 = 1;

3656 
»s
 = 
	`vdev_·r£_add_dev_·¿ms
(
vœt_dev
, 
·¿ms
, 
®lowed_·¿ms
);

3657 ià(
»s
 != 0)

3658 
out_de¡roy
;

3660 ià(
vœt_dev
->
fž’ame
 =ð
NULL
) {

3661 
	`PRINT_ERROR
("FžÇm»quœed (deviû %s)", 
vœt_dev
->
Çme
);

3662 
»s
 = -
EINVAL
;

3663 
out_de¡roy
;

3666 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
, &
vdev_li¡
);

3668 
	`vdisk_»pÜt_»gi¡”šg
(
vœt_dev
);

3670 
vœt_dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(vœt_dev->
vdev_devt
,

3671 
vœt_dev
->
Çme
);

3672 ià(
vœt_dev
->
vœt_id
 < 0) {

3673 
»s
 = 
vœt_dev
->
vœt_id
;

3674 
out_d–
;

3677 
	`TRACE_DBG
("Regi¡”ed vœt_dev % w™h id %d", 
vœt_dev
->
Çme
,

3678 
vœt_dev
->
vœt_id
);

3680 
out
:

3681 
	`TRACE_EXIT_RES
(
»s
);

3682  
»s
;

3684 
out_d–
:

3685 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

3687 
out_de¡roy
:

3688 
	`vdev_de¡roy
(
vœt_dev
);

3689 
out
;

3690 
	}
}

3693 
	$vdev_nuÎio_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

3695 
»s
 = 0;

3696 cÚ¡ *
®lowed_·¿ms
[] = { "read_only", "removable",

3697 "blocksize", 
NULL
 };

3698 
sc¡_vdisk_dev
 *
vœt_dev
;

3700 
	`TRACE_ENTRY
();

3702 
»s
 = 
	`vdev_ü—‹
(&
vdisk_nuÎ_devty³
, 
deviû_Çme
, &
vœt_dev
);

3703 ià(
»s
 != 0)

3704 
out
;

3706 
vœt_dev
->
commªd_£t_v”siÚ
 = 0x04C0;

3708 
vœt_dev
->
nuÎio
 = 1;

3710 
»s
 = 
	`vdev_·r£_add_dev_·¿ms
(
vœt_dev
, 
·¿ms
, 
®lowed_·¿ms
);

3711 ià(
»s
 != 0)

3712 
out_de¡roy
;

3714 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
, &
vdev_li¡
);

3716 
	`vdisk_»pÜt_»gi¡”šg
(
vœt_dev
);

3718 
vœt_dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(vœt_dev->
vdev_devt
,

3719 
vœt_dev
->
Çme
);

3720 ià(
vœt_dev
->
vœt_id
 < 0) {

3721 
»s
 = 
vœt_dev
->
vœt_id
;

3722 
out_d–
;

3725 
	`TRACE_DBG
("Regi¡”ed vœt_dev % w™h id %d", 
vœt_dev
->
Çme
,

3726 
vœt_dev
->
vœt_id
);

3728 
out
:

3729 
	`TRACE_EXIT_RES
(
»s
);

3730  
»s
;

3732 
out_d–
:

3733 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

3735 
out_de¡roy
:

3736 
	`vdev_de¡roy
(
vœt_dev
);

3737 
out
;

3738 
	}
}

3740 
ssize_t
 
	$vdisk_add_fžeio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

3742 
»s
;

3744 
	`TRACE_ENTRY
();

3746 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
) != 0) {

3747 
»s
 = -
EINTR
;

3748 
out
;

3751 
»s
 = 
	`vdev_fžeio_add_deviû
(
deviû_Çme
, 
·¿ms
);

3753 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

3755 
out
:

3756 
	`TRACE_EXIT_RES
(
»s
);

3757  
»s
;

3758 
	}
}

3760 
ssize_t
 
	$vdisk_add_blockio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

3762 
»s
;

3764 
	`TRACE_ENTRY
();

3766 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
) != 0) {

3767 
»s
 = -
EINTR
;

3768 
out
;

3771 
»s
 = 
	`vdev_blockio_add_deviû
(
deviû_Çme
, 
·¿ms
);

3773 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

3775 
out
:

3776 
	`TRACE_EXIT_RES
(
»s
);

3777  
»s
;

3779 
	}
}

3781 
ssize_t
 
	$vdisk_add_nuÎio_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

3783 
»s
;

3785 
	`TRACE_ENTRY
();

3787 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
) != 0) {

3788 
»s
 = -
EINTR
;

3789 
out
;

3792 
»s
 = 
	`vdev_nuÎio_add_deviû
(
deviû_Çme
, 
·¿ms
);

3794 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

3796 
out
:

3797 
	`TRACE_EXIT_RES
(
»s
);

3798  
»s
;

3800 
	}
}

3805 
	$vdev_d–_deviû
(
sc¡_vdisk_dev
 *
vœt_dev
)

3807 
	`TRACE_ENTRY
();

3809 
	`sc¡_uÄegi¡”_vœtu®_deviû
(
vœt_dev
->
vœt_id
);

3811 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

3813 
	`PRINT_INFO
("Vœtu® deviû % uÄegi¡”ed", 
vœt_dev
->
Çme
);

3814 
	`TRACE_DBG
("vœt_id %d uÄegi¡”ed", 
vœt_dev
->
vœt_id
);

3816 
	`vdev_de¡roy
(
vœt_dev
);

3819 
	}
}

3821 #iâdeà
CONFIG_SCST_PROC


3823 
ssize_t
 
	$vdisk_d–_deviû
(cÚ¡ *
deviû_Çme
)

3825 
»s
 = 0;

3826 
sc¡_vdisk_dev
 *
vœt_dev
;

3828 
	`TRACE_ENTRY
();

3830 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
) != 0) {

3831 
»s
 = -
EINTR
;

3832 
out
;

3835 
vœt_dev
 = 
	`vdev_fšd
(
deviû_Çme
);

3836 ià(
vœt_dev
 =ð
NULL
) {

3837 
	`PRINT_ERROR
("Deviû % nÙ found", 
deviû_Çme
);

3838 
»s
 = -
EINVAL
;

3839 
out_uÆock
;

3842 
	`vdev_d–_deviû
(
vœt_dev
);

3844 
out_uÆock
:

3845 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

3847 
out
:

3848 
	`TRACE_EXIT_RES
(
»s
);

3849  
»s
;

3850 
	}
}

3853 
ssize_t
 
	$__vcdrom_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

3855 
»s
 = 0;

3856 cÚ¡ *
®lowed_·¿ms
[] = { 
NULL
 };

3857 
sc¡_vdisk_dev
 *
vœt_dev
;

3859 
	`TRACE_ENTRY
();

3861 
»s
 = 
	`vdev_ü—‹
(&
vcdrom_devty³
, 
deviû_Çme
, &
vœt_dev
);

3862 ià(
»s
 != 0)

3863 
out
;

3870 
vœt_dev
->
commªd_£t_v”siÚ
 = 0x02A0;

3873 
vœt_dev
->
rd_Úly
 = 1;

3874 
vœt_dev
->
»movabË
 = 1;

3875 
vœt_dev
->
cdrom_em±y
 = 1;

3877 
vœt_dev
->
block_size
 = 
DEF_CDROM_BLOCKSIZE
;

3878 
vœt_dev
->
block_shiá
 = 
DEF_CDROM_BLOCKSIZE_SHIFT
;

3880 
»s
 = 
	`vdev_·r£_add_dev_·¿ms
(
vœt_dev
, 
·¿ms
, 
®lowed_·¿ms
);

3881 ià(
»s
 != 0)

3882 
out_de¡roy
;

3884 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
, &
vdev_li¡
);

3886 
	`vdisk_»pÜt_»gi¡”šg
(
vœt_dev
);

3888 
vœt_dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(vœt_dev->
vdev_devt
,

3889 
vœt_dev
->
Çme
);

3890 ià(
vœt_dev
->
vœt_id
 < 0) {

3891 
»s
 = 
vœt_dev
->
vœt_id
;

3892 
out_d–
;

3895 
	`TRACE_DBG
("Regi¡”ed vœt_dev % w™h id %d", 
vœt_dev
->
Çme
,

3896 
vœt_dev
->
vœt_id
);

3898 
out
:

3899 
	`TRACE_EXIT_RES
(
»s
);

3900  
»s
;

3902 
out_d–
:

3903 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

3905 
out_de¡roy
:

3906 
	`vdev_de¡roy
(
vœt_dev
);

3907 
out
;

3908 
	}
}

3910 
ssize_t
 
	$vcdrom_add_deviû
(cÚ¡ *
deviû_Çme
, *
·¿ms
)

3912 
»s
;

3914 
	`TRACE_ENTRY
();

3916 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
) != 0) {

3917 
»s
 = -
EINTR
;

3918 
out
;

3921 
»s
 = 
	`__vcdrom_add_deviû
(
deviû_Çme
, 
·¿ms
);

3923 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

3925 
out
:

3926 
	`TRACE_EXIT_RES
(
»s
);

3927  
»s
;

3929 
	}
}

3931 
ssize_t
 
	$vcdrom_d–_deviû
(cÚ¡ *
deviû_Çme
)

3933 
»s
 = 0;

3934 
sc¡_vdisk_dev
 *
vœt_dev
;

3936 
	`TRACE_ENTRY
();

3938 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
) != 0) {

3939 
»s
 = -
EINTR
;

3940 
out
;

3943 
vœt_dev
 = 
	`vdev_fšd
(
deviû_Çme
);

3944 ià(
vœt_dev
 =ð
NULL
) {

3945 
	`PRINT_ERROR
("Deviû % nÙ found", 
deviû_Çme
);

3946 
»s
 = -
EINVAL
;

3947 
out_uÆock
;

3950 
	`vdev_d–_deviû
(
vœt_dev
);

3952 
out_uÆock
:

3953 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

3955 
out
:

3956 
	`TRACE_EXIT_RES
(
»s
);

3957  
»s
;

3958 
	}
}

3962 
	$vcdrom_chªge
(
sc¡_vdisk_dev
 *
vœt_dev
,

3963 *
bufãr
)

3965 
loff_t
 
”r
;

3966 *
Þd_â
, *
p
, *
µ
;

3967 cÚ¡ *
fž’ame
 = 
NULL
;

3968 
Ëngth
 = 
	`¡¾’
(
bufãr
);

3969 
»s
 = 0;

3971 
	`TRACE_ENTRY
();

3973 
p
 = 
bufãr
;

3975 
	`is¥aû
(*
p
) && *p != '\0')

3976 
p
++;

3977 
fž’ame
 = 
p
;

3978 
p
 = &
bufãr
[
Ëngth
-1];

3979 
µ
 = &
bufãr
[
Ëngth
];

3980 
	`is¥aû
(*
p
) && (*p != '\0')) {

3981 
µ
 = 
p
;

3982 
p
--;

3984 *
µ
 = '\0';

3986 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

3987 ià(
»s
 != 0)

3988 
out
;

3991 
	`mu‹x_lock
(&
sc¡_mu‹x
);

3993 ià(*
fž’ame
 == '\0') {

3994 
vœt_dev
->
cdrom_em±y
 = 1;

3995 
	`TRACE_DBG
("%s", "No media");

3996 } ià(*
fž’ame
 != '/') {

3997 
	`PRINT_ERROR
("Fž·th \"%s\" i nÙ‡bsÞu‹", 
fž’ame
);

3998 
»s
 = -
EINVAL
;

3999 
out_uÆock
;

4001 
vœt_dev
->
cdrom_em±y
 = 0;

4003 
Þd_â
 = 
vœt_dev
->
fž’ame
;

4005 ià(!
vœt_dev
->
cdrom_em±y
) {

4006 *
â
 = 
	`k¡rdup
(
fž’ame
, 
GFP_KERNEL
);

4007 ià(
â
 =ð
NULL
) {

4008 
	`PRINT_ERROR
("%s", "Allocation of filename failed");

4009 
»s
 = -
ENOMEM
;

4010 
out_uÆock
;

4013 
vœt_dev
->
fž’ame
 = 
â
;

4015 
»s
 = 
	`vdisk_g‘_fže_size
(
vœt_dev
->
fž’ame
,

4016 
vœt_dev
->
blockio
, &
”r
);

4017 ià(
»s
 != 0)

4018 
out_ä“_â
;

4020 
”r
 = 0;

4021 
vœt_dev
->
fž’ame
 = 
NULL
;

4024 ià(
vœt_dev
->
´ev’t_®low_medium_»mov®
) {

4025 
	`PRINT_ERROR
("Prevent medium„emoval for "

4026 "vœtu® deviû w™h‚am%s", 
vœt_dev
->
Çme
);

4027 
»s
 = -
EINVAL
;

4028 
out_ä“_â
;

4031 
vœt_dev
->
fže_size
 = 
”r
;

4032 
vœt_dev
->
nblocks
 = vœt_dev->
fže_size
 >> vœt_dev->
block_shiá
;

4033 ià(!
vœt_dev
->
cdrom_em±y
)

4034 
vœt_dev
->
medŸ_chªged
 = 1;

4036 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4038 
	`sc¡_dev_d–_®l_thr_d©a
(
vœt_dev
->
dev
);

4040 ià(!
vœt_dev
->
cdrom_em±y
) {

4041 
	`PRINT_INFO
("Changed SCSIarget virtual cdrom %s "

4043 " cyÊ=%Îd%s)", 
vœt_dev
->
Çme
,

4044 
	`vdev_g‘_fž’ame
(
vœt_dev
),

4045 
vœt_dev
->
fže_size
 >> 20, vœt_dev->
block_size
,

4046 ()
vœt_dev
->
nblocks
,

4047 ()
vœt_dev
->
nblocks
/64/32,

4048 
vœt_dev
->
nblocks
 < 64*32 ? " !WARNING! cyln†ess "

4051 
	`PRINT_INFO
("Removed media from SCSIarget virtual cdrom %s",

4052 
vœt_dev
->
Çme
);

4055 
	`kä“
(
Þd_â
);

4057 
out_»sume
:

4058 
	`sc¡_»sume_aùiv™y
();

4060 
out
:

4061 
	`TRACE_EXIT_RES
(
»s
);

4062  
»s
;

4064 
out_ä“_â
:

4065 
	`kä“
(
vœt_dev
->
fž’ame
);

4066 
vœt_dev
->
fž’ame
 = 
Þd_â
;

4068 
out_uÆock
:

4069 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4070 
out_»sume
;

4071 
	}
}

4073 #iâdeà
CONFIG_SCST_PROC


4075 
	$vcdrom_sysfs_´oûss_fž’ame_¡Üe
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

4077 
»s
;

4078 
sc¡_deviû
 *
dev
 = 
wÜk
->dev;

4079 
sc¡_vdisk_dev
 *
vœt_dev
;

4081 
	`TRACE_ENTRY
();

4084 
vœt_dev
 = 
dev
->
dh_´iv
;

4086 
»s
 = 
	`vcdrom_chªge
(
vœt_dev
, 
wÜk
->
buf
);

4088 
	`kobjeù_put
(&
dev
->
dev_kobj
);

4090 
	`TRACE_EXIT_RES
(
»s
);

4091  
»s
;

4092 
	}
}

4094 
ssize_t
 
	$vcdrom_sysfs_fž’ame_¡Üe
(
kobjeù
 *
kobj
,

4095 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4097 
»s
;

4098 *
i_buf
;

4099 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

4100 
sc¡_deviû
 *
dev
;

4102 
	`TRACE_ENTRY
();

4104 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4106 
i_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

4107 ià(
i_buf
 =ð
NULL
) {

4108 
	`PRINT_ERROR
("Unableo‡lloc intermediate buffer with size %zd",

4109 
couÁ
+1);

4110 
»s
 = -
ENOMEM
;

4111 
out
;

4114 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
vcdrom_sysfs_´oûss_fž’ame_¡Üe
,

4115 
çl£
, &
wÜk
);

4116 ià(
»s
 != 0)

4117 
out_ä“
;

4119 
wÜk
->
buf
 = 
i_buf
;

4120 
wÜk
->
dev
 = dev;

4122 
	`kobjeù_g‘
(&
dev
->
dev_kobj
);

4124 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

4125 ià(
»s
 == 0)

4126 
»s
 = 
couÁ
;

4128 
out
:

4129 
	`TRACE_EXIT_RES
(
»s
);

4130  
»s
;

4132 
out_ä“
:

4133 
	`kä“
(
i_buf
);

4134 
out
;

4135 
	}
}

4137 
ssize_t
 
	$vdev_sysfs_size_show
(
kobjeù
 *
kobj
,

4138 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4140 
pos
 = 0;

4141 
sc¡_deviû
 *
dev
;

4142 
sc¡_vdisk_dev
 *
vœt_dev
;

4144 
	`TRACE_ENTRY
();

4146 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4147 
vœt_dev
 = 
dev
->
dh_´iv
;

4149 
pos
 = 
	`¥rštf
(
buf
, "%Îd\n", 
vœt_dev
->
fže_size
 / 1024 / 1024);

4151 
	`TRACE_EXIT_RES
(
pos
);

4152  
pos
;

4153 
	}
}

4155 
ssize_t
 
	$vdisk_sysfs_blocksize_show
(
kobjeù
 *
kobj
,

4156 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4158 
pos
 = 0;

4159 
sc¡_deviû
 *
dev
;

4160 
sc¡_vdisk_dev
 *
vœt_dev
;

4162 
	`TRACE_ENTRY
();

4164 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4165 
vœt_dev
 = 
dev
->
dh_´iv
;

4167 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", ()
vœt_dev
->
block_size
,

4168 (
vœt_dev
->
block_size
 =ð
DEF_DISK_BLOCKSIZE
) ? "" :

4169 
SCST_SYSFS_KEY_MARK
 "\n");

4171 
	`TRACE_EXIT_RES
(
pos
);

4172  
pos
;

4173 
	}
}

4175 
ssize_t
 
	$vdisk_sysfs_rd_Úly_show
(
kobjeù
 *
kobj
,

4176 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4178 
pos
 = 0;

4179 
sc¡_deviû
 *
dev
;

4180 
sc¡_vdisk_dev
 *
vœt_dev
;

4182 
	`TRACE_ENTRY
();

4184 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4185 
vœt_dev
 = 
dev
->
dh_´iv
;

4187 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
rd_Úly
 ? 1 : 0,

4188 (
vœt_dev
->
rd_Úly
 =ð
DEF_RD_ONLY
) ? "" :

4189 
SCST_SYSFS_KEY_MARK
 "\n");

4191 
	`TRACE_EXIT_RES
(
pos
);

4192  
pos
;

4193 
	}
}

4195 
ssize_t
 
	$vdisk_sysfs_wt_show
(
kobjeù
 *
kobj
,

4196 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4198 
pos
 = 0;

4199 
sc¡_deviû
 *
dev
;

4200 
sc¡_vdisk_dev
 *
vœt_dev
;

4202 
	`TRACE_ENTRY
();

4204 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4205 
vœt_dev
 = 
dev
->
dh_´iv
;

4207 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
wt_æag
 ? 1 : 0,

4208 (
vœt_dev
->
wt_æag
 =ð
DEF_WRITE_THROUGH
) ? "" :

4209 
SCST_SYSFS_KEY_MARK
 "\n");

4211 
	`TRACE_EXIT_RES
(
pos
);

4212  
pos
;

4213 
	}
}

4215 
ssize_t
 
	$vdisk_sysfs__show
(
kobjeù
 *
kobj
,

4216 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4218 
pos
 = 0;

4219 
sc¡_deviû
 *
dev
;

4220 
sc¡_vdisk_dev
 *
vœt_dev
;

4222 
	`TRACE_ENTRY
();

4224 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4225 
vœt_dev
 = 
dev
->
dh_´iv
;

4227 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
thš_´ovisiÚed
 ? 1 : 0,

4228 (
vœt_dev
->
thš_´ovisiÚed
 =ð
DEF_THIN_PROVISIONED
) ? "" :

4229 
SCST_SYSFS_KEY_MARK
 "\n");

4231 
	`TRACE_EXIT_RES
(
pos
);

4232  
pos
;

4233 
	}
}

4235 
ssize_t
 
	$vdisk_sysfs_nv_ÿche_show
(
kobjeù
 *
kobj
,

4236 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4238 
pos
 = 0;

4239 
sc¡_deviû
 *
dev
;

4240 
sc¡_vdisk_dev
 *
vœt_dev
;

4242 
	`TRACE_ENTRY
();

4244 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4245 
vœt_dev
 = 
dev
->
dh_´iv
;

4247 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
nv_ÿche
 ? 1 : 0,

4248 (
vœt_dev
->
nv_ÿche
 =ð
DEF_NV_CACHE
) ? "" :

4249 
SCST_SYSFS_KEY_MARK
 "\n");

4251 
	`TRACE_EXIT_RES
(
pos
);

4252  
pos
;

4253 
	}
}

4255 
ssize_t
 
	$vdisk_sysfs_o_dœeù_show
(
kobjeù
 *
kobj
,

4256 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4258 
pos
 = 0;

4259 
sc¡_deviû
 *
dev
;

4260 
sc¡_vdisk_dev
 *
vœt_dev
;

4262 
	`TRACE_ENTRY
();

4264 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4265 
vœt_dev
 = 
dev
->
dh_´iv
;

4267 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
vœt_dev
->
o_dœeù_æag
 ? 1 : 0,

4268 (
vœt_dev
->
o_dœeù_æag
 =ð
DEF_O_DIRECT
) ? "" :

4269 
SCST_SYSFS_KEY_MARK
 "\n");

4271 
	`TRACE_EXIT_RES
(
pos
);

4272  
pos
;

4273 
	}
}

4275 
ssize_t
 
	$vdisk_sysfs_»movabË_show
(
kobjeù
 *
kobj
,

4276 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4278 
pos
 = 0;

4279 
sc¡_deviû
 *
dev
;

4280 
sc¡_vdisk_dev
 *
vœt_dev
;

4282 
	`TRACE_ENTRY
();

4284 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4285 
vœt_dev
 = 
dev
->
dh_´iv
;

4287 
pos
 = 
	`¥rštf
(
buf
, "%d\n", 
vœt_dev
->
»movabË
 ? 1 : 0);

4289 ià((
vœt_dev
->
dev
->
ty³
 !ð
TYPE_ROM
) &&

4290 (
vœt_dev
->
»movabË
 !ð
DEF_REMOVABLE
))

4291 
pos
 +ð
	`¥rštf
(&
buf
[pos], "%s\n", 
SCST_SYSFS_KEY_MARK
);

4293 
	`TRACE_EXIT_RES
(
pos
);

4294  
pos
;

4295 
	}
}

4297 
	$vdev_sysfs_´oûss_g‘_fž’ame
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

4299 
»s
 = 0;

4300 
sc¡_deviû
 *
dev
;

4301 
sc¡_vdisk_dev
 *
vœt_dev
;

4303 
	`TRACE_ENTRY
();

4305 
dev
 = 
wÜk
->dev;

4313 !
	`mu‹x_Œylock
(&
sc¡_vdisk_mu‹x
)) {

4314 ià((vÞ©ž
boÞ
)(
dev
->
dev_uÄegi¡”šg
)) {

4315 
	`TRACE_MGMT_DBG
("Skipping being unregistered dev %s",

4316 
dev
->
vœt_Çme
);

4317 
»s
 = -
ENOENT
;

4318 
out_put
;

4320 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

4321 
»s
 = -
EINTR
;

4322 
out_put
;

4324 
	`m¦“p
(100);

4327 
vœt_dev
 = 
dev
->
dh_´iv
;

4329 ià(
vœt_dev
 =ð
NULL
)

4330 
out_uÆock
;

4332 ià(
vœt_dev
->
fž’ame
 !ð
NULL
)

4333 
wÜk
->
»s_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s\n%s\n",

4334 
	`vdev_g‘_fž’ame
(
vœt_dev
), 
SCST_SYSFS_KEY_MARK
);

4336 
wÜk
->
»s_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s\n",

4337 
	`vdev_g‘_fž’ame
(
vœt_dev
));

4339 
out_uÆock
:

4340 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

4342 
out_put
:

4343 
	`kobjeù_put
(&
dev
->
dev_kobj
);

4345 
	`TRACE_EXIT_RES
(
»s
);

4346  
»s
;

4347 
	}
}

4349 
ssize_t
 
	$vdev_sysfs_fž’ame_show
(
kobjeù
 *
kobj
,

4350 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4352 
»s
 = 0;

4353 
sc¡_deviû
 *
dev
;

4354 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

4356 
	`TRACE_ENTRY
();

4358 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4360 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
vdev_sysfs_´oûss_g‘_fž’ame
,

4361 
Œue
, &
wÜk
);

4362 ià(
»s
 != 0)

4363 
out
;

4365 
wÜk
->
dev
 = dev;

4367 
	`kobjeù_g‘
(&
dev
->
dev_kobj
);

4369 
	`sc¡_sysfs_wÜk_g‘
(
wÜk
);

4371 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

4372 ià(
»s
 != 0)

4373 
out_put
;

4375 
»s
 = 
	`¢´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%s\n", 
wÜk
->
»s_buf
);

4377 
out_put
:

4378 
	`sc¡_sysfs_wÜk_put
(
wÜk
);

4380 
out
:

4381 
	`TRACE_EXIT_RES
(
»s
);

4382  
»s
;

4383 
	}
}

4385 
	$vdisk_sysfs_´oûss_»sync_size_¡Üe
(

4386 
sc¡_sysfs_wÜk_™em
 *
wÜk
)

4388 
»s
;

4389 
sc¡_deviû
 *
dev
 = 
wÜk
->dev;

4390 
sc¡_vdisk_dev
 *
vœt_dev
;

4392 
	`TRACE_ENTRY
();

4395 
vœt_dev
 = 
dev
->
dh_´iv
;

4397 
»s
 = 
	`vdisk_»sync_size
(
vœt_dev
);

4399 
	`kobjeù_put
(&
dev
->
dev_kobj
);

4401 
	`TRACE_EXIT_RES
(
»s
);

4402  
»s
;

4403 
	}
}

4405 
ssize_t
 
	$vdisk_sysfs_»sync_size_¡Üe
(
kobjeù
 *
kobj
,

4406 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4408 
»s
;

4409 
sc¡_deviû
 *
dev
;

4410 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

4412 
	`TRACE_ENTRY
();

4414 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4416 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
vdisk_sysfs_´oûss_»sync_size_¡Üe
,

4417 
çl£
, &
wÜk
);

4418 ià(
»s
 != 0)

4419 
out
;

4421 
wÜk
->
dev
 = dev;

4423 
	`kobjeù_g‘
(&
dev
->
dev_kobj
);

4425 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

4426 ià(
»s
 == 0)

4427 
»s
 = 
couÁ
;

4429 
out
:

4430 
	`TRACE_EXIT_RES
(
»s
);

4431  
»s
;

4432 
	}
}

4434 
ssize_t
 
	$vdev_sysfs_t10_dev_id_¡Üe
(
kobjeù
 *
kobj
,

4435 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4437 
»s
, 
i
;

4438 
sc¡_deviû
 *
dev
;

4439 
sc¡_vdisk_dev
 *
vœt_dev
;

4441 
	`TRACE_ENTRY
();

4443 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4444 
vœt_dev
 = 
dev
->
dh_´iv
;

4446 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

4448 ià((
couÁ
 > (
vœt_dev
->
t10_dev_id
)) ||

4449 ((
couÁ
 =ð(
vœt_dev
->
t10_dev_id
)) &&

4450 (
buf
[
couÁ
-1] != '\n'))) {

4451 
	`PRINT_ERROR
("T10 device id isoo†ong (max %zd "

4452 "ch¬aù”s)", (
vœt_dev
->
t10_dev_id
)-1);

4453 
»s
 = -
EINVAL
;

4454 
out_uÆock
;

4457 
	`mem£t
(
vœt_dev
->
t10_dev_id
, 0, (virt_dev->t10_dev_id));

4458 
	`memýy
(
vœt_dev
->
t10_dev_id
, 
buf
, 
couÁ
);

4460 
i
 = 0;

4461 
i
 < (
vœt_dev
->
t10_dev_id
)) {

4462 ià(
vœt_dev
->
t10_dev_id
[
i
] == '\n') {

4463 
vœt_dev
->
t10_dev_id
[
i
] = '\0';

4466 
i
++;

4469 
vœt_dev
->
t10_dev_id_£t
 = 1;

4471 
»s
 = 
couÁ
;

4473 
	`PRINT_INFO
("T10 deviû id fÜ deviû % chªgedØ%s", 
vœt_dev
->
Çme
,

4474 
vœt_dev
->
t10_dev_id
);

4476 
out_uÆock
:

4477 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

4479 
	`TRACE_EXIT_RES
(
»s
);

4480  
»s
;

4481 
	}
}

4483 
ssize_t
 
	$vdev_sysfs_t10_dev_id_show
(
kobjeù
 *
kobj
,

4484 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4486 
pos
 = 0;

4487 
sc¡_deviû
 *
dev
;

4488 
sc¡_vdisk_dev
 *
vœt_dev
;

4490 
	`TRACE_ENTRY
();

4492 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4493 
vœt_dev
 = 
dev
->
dh_´iv
;

4495 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

4496 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
vœt_dev
->
t10_dev_id
,

4497 
vœt_dev
->
t10_dev_id_£t
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

4498 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

4500 
	`TRACE_EXIT_RES
(
pos
);

4501  
pos
;

4502 
	}
}

4504 
ssize_t
 
	$vdev_sysfs_u¢_¡Üe
(
kobjeù
 *
kobj
,

4505 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4507 
»s
, 
i
;

4508 
sc¡_deviû
 *
dev
;

4509 
sc¡_vdisk_dev
 *
vœt_dev
;

4511 
	`TRACE_ENTRY
();

4513 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4514 
vœt_dev
 = 
dev
->
dh_´iv
;

4516 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

4518 ià((
couÁ
 > (
vœt_dev
->
u¢
)) ||

4519 ((
couÁ
 =ð(
vœt_dev
->
u¢
)) &&

4520 (
buf
[
couÁ
-1] != '\n'))) {

4521 
	`PRINT_ERROR
("USN isoo†ong (max %zd "

4522 "ch¬aù”s)", (
vœt_dev
->
u¢
)-1);

4523 
»s
 = -
EINVAL
;

4524 
out_uÆock
;

4527 
	`mem£t
(
vœt_dev
->
u¢
, 0, (virt_dev->usn));

4528 
	`memýy
(
vœt_dev
->
u¢
, 
buf
, 
couÁ
);

4530 
i
 = 0;

4531 
i
 < (
vœt_dev
->
u¢
)) {

4532 ià(
vœt_dev
->
u¢
[
i
] == '\n') {

4533 
vœt_dev
->
u¢
[
i
] = '\0';

4536 
i
++;

4539 
vœt_dev
->
u¢_£t
 = 1;

4541 
»s
 = 
couÁ
;

4543 
	`PRINT_INFO
("USN fÜ deviû % chªgedØ%s", 
vœt_dev
->
Çme
,

4544 
vœt_dev
->
u¢
);

4546 
out_uÆock
:

4547 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

4549 
	`TRACE_EXIT_RES
(
»s
);

4550  
»s
;

4551 
	}
}

4553 
ssize_t
 
	$vdev_sysfs_u¢_show
(
kobjeù
 *
kobj
,

4554 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4556 
pos
 = 0;

4557 
sc¡_deviû
 *
dev
;

4558 
sc¡_vdisk_dev
 *
vœt_dev
;

4560 
	`TRACE_ENTRY
();

4562 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

4563 
vœt_dev
 = 
dev
->
dh_´iv
;

4565 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

4566 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
vœt_dev
->
u¢
,

4567 
vœt_dev
->
u¢_£t
 ? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

4568 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

4570 
	`TRACE_EXIT_RES
(
pos
);

4571  
pos
;

4572 
	}
}

4583 
	$vdisk_»ad_´oc
(
£q_fže
 *
£q
, 
sc¡_dev_ty³
 *
dev_ty³
)

4585 
»s
 = 0;

4586 
sc¡_vdisk_dev
 *
vœt_dev
;

4588 
	`TRACE_ENTRY
();

4590 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
) != 0) {

4591 
»s
 = -
EINTR
;

4592 
out
;

4595 
	`£q_´štf
(
£q
, "%-17s %-11s %-11s %-15s %-45s %-16s\n",

4599 
	`li¡_fÜ_—ch_’Œy
(
vœt_dev
, &
vdev_li¡
, 
vdev_li¡_’Œy
) {

4600 
c
;

4601 ià(
vœt_dev
->
dev
->
ty³
 !ð
TYPE_DISK
)

4603 
	`£q_´štf
(
£q
, "%-17 %-11d %-12d", 
vœt_dev
->
Çme
,

4604 (
ušt32_t
)(
vœt_dev
->
fže_size
 >> 20),

4605 
vœt_dev
->
block_size
);

4606 
c
 = 0;

4607 ià(
vœt_dev
->
wt_æag
) {

4608 
	`£q_´štf
(
£q
, "WT ");

4609 
c
 += 3;

4611 ià(
vœt_dev
->
nv_ÿche
) {

4612 
	`£q_´štf
(
£q
, "NV ");

4613 
c
 += 3;

4615 ià(
vœt_dev
->
dev
 !ð
NULL
) {

4616 ià(
vœt_dev
->
dev
->
rd_Úly
) {

4617 
	`£q_´štf
(
£q
, "RO ");

4618 
c
 += 3;

4620 } ià(
vœt_dev
->
rd_Úly
) {

4621 
	`£q_´štf
(
£q
, "RO ");

4622 
c
 += 3;

4624 ià(
vœt_dev
->
o_dœeù_æag
) {

4625 
	`£q_´štf
(
£q
, "DR ");

4626 
c
 += 3;

4628 ià(
vœt_dev
->
nuÎio
) {

4629 
	`£q_´štf
(
£q
, "NIO ");

4630 
c
 += 4;

4632 ià(
vœt_dev
->
blockio
) {

4633 
	`£q_´štf
(
£q
, "BIO ");

4634 
c
 += 4;

4636 ià(
vœt_dev
->
»movabË
) {

4637 
	`£q_´štf
(
£q
, "RM ");

4638 
c
 += 4;

4640 
c
 < 16) {

4641 
	`£q_´štf
(
£q
, " ");

4642 
c
++;

4644 
	`»ad_lock
(&
vdisk_£rŸl_rwlock
);

4645 
	`£q_´štf
(
£q
, "%-45 %-16s\n", 
	`vdev_g‘_fž’ame
(
vœt_dev
),

4646 
vœt_dev
->
t10_dev_id
);

4647 
	`»ad_uÆock
(&
vdisk_£rŸl_rwlock
);

4649 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

4650 
out
:

4651 
	`TRACE_EXIT_RES
(
»s
);

4652  
»s
;

4653 
	}
}

4658 
	$vdisk_wr™e_´oc
(*
bufãr
, **
¡¬t
, 
off_t
 
off£t
,

4659 
Ëngth
, *
eof
, 
sc¡_dev_ty³
 *
dev_ty³
)

4661 
»s
 = 0, 
aùiÚ
;

4662 *
p
, *
Çme
, *
fž’ame
, *
i_buf
, *
t10_dev_id
;

4663 
sc¡_vdisk_dev
 *
vœt_dev
;

4664 
ušt32_t
 
block_size
 = 
DEF_DISK_BLOCKSIZE
;

4665 
block_shiá
 = 
DEF_DISK_BLOCKSIZE_SHIFT
;

4666 
size_t
 
¦’
;

4668 
	`TRACE_ENTRY
();

4670 ià((
Ëngth
 =ð0è|| (
bufãr
 =ð
NULL
) || (buffer[0] == '\0'))

4671 
out
;

4673 
i_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
Ëngth
, 
bufãr
);

4674 ià(
i_buf
 =ð
NULL
) {

4675 
	`PRINT_ERROR
("Unableo‡lloc intermediate buffer with size %d",

4676 
Ëngth
+1);

4677 
»s
 = -
ENOMEM
;

4678 
out
;

4681 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
) != 0) {

4682 
»s
 = -
EINTR
;

4683 
out_ä“
;

4686 
p
 = 
i_buf
;

4687 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

4688 
p
[
	`¡¾’
(p) - 1] = '\0';

4689 ià(!
	`¡ºcmp
("þo£ ", 
p
, 6)) {

4690 
p
 += 6;

4691 
aùiÚ
 = 0;

4692 } ià(!
	`¡ºcmp
("Ý’ ", 
p
, 5)) {

4693 
p
 += 5;

4694 
aùiÚ
 = 1;

4695 } ià(!
	`¡ºcmp
("»sync_siz", 
p
, 12)) {

4696 
p
 += 12;

4697 
aùiÚ
 = 2;

4698 } ià(!
	`¡ºcmp
("£t_t10_dev_id ", 
p
, 15)) {

4699 
p
 += 15;

4700 
aùiÚ
 = 3;

4702 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

4703 
»s
 = -
EINVAL
;

4704 
out_up
;

4707 
	`is¥aû
(*
p
) && *p != '\0')

4708 
p
++;

4709 
Çme
 = 
p
;

4710 !
	`is¥aû
(*
p
) && *p != '\0')

4711 
p
++;

4712 *
p
++ = '\0';

4713 ià(*
Çme
 == '\0') {

4714 
	`PRINT_ERROR
("%s", "Name„equired");

4715 
»s
 = -
EINVAL
;

4716 
out_up
;

4717 } ià(
	`¡¾’
(
Çme
è>ð(
vœt_dev
->name)) {

4718 
	`PRINT_ERROR
("Name isoo†ong (max %zd "

4719 "ch¬aù”s)", (
vœt_dev
->
Çme
)-1);

4720 
»s
 = -
EINVAL
;

4721 
out_up
;

4724 ià(
aùiÚ
 == 1) {

4726 
	`is¥aû
(*
p
) && *p != '\0')

4727 
p
++;

4728 
fž’ame
 = 
p
;

4729 !
	`is¥aû
(*
p
) && *p != '\0')

4730 
p
++;

4731 *
p
++ = '\0';

4732 ià(*
fž’ame
 == '\0') {

4733 
	`PRINT_ERROR
("%s", "File‚ame„equired");

4734 
»s
 = -
EINVAL
;

4735 
out_up
;

4738 
»s
 = 
	`vdev_ü—‹
(
dev_ty³
, 
Çme
, &
vœt_dev
);

4739 ià(
»s
 != 0)

4740 
out_up
;

4742 
vœt_dev
->
wt_æag
 = 
DEF_WRITE_THROUGH
;

4743 
vœt_dev
->
nv_ÿche
 = 
DEF_NV_CACHE
;

4744 
vœt_dev
->
o_dœeù_æag
 = 
DEF_O_DIRECT
;

4746 
	`is¥aû
(*
p
) && *p != '\0')

4747 
p
++;

4749 ià(
	`isdig™
(*
p
)) {

4750 *
µ
;

4751 
block_size
 = 
	`sim¶e_¡¹oul
(
p
, &
µ
, 0);

4752 
p
 = 
µ
;

4753 ià((*
p
 !ð'\0'è&& !
	`is¥aû
(*p)) {

4754 
	`PRINT_ERROR
("P¬£ƒ¼Ü: \"%s\"", 
p
);

4755 
»s
 = -
EINVAL
;

4756 
out_ä“_vdev
;

4758 
	`is¥aû
(*
p
) && *p != '\0')

4759 
p
++;

4761 
block_shiá
 = 
	`sc¡_ÿlc_block_shiá
(
block_size
);

4762 ià(
block_shiá
 < 9) {

4763 
»s
 = -
EINVAL
;

4764 
out_ä“_vdev
;

4767 
vœt_dev
->
block_size
 = block_size;

4768 
vœt_dev
->
block_shiá
 = block_shift;

4770 *
p
 != '\0') {

4771 ià(!
	`¡ºcmp
("WRITE_THROUGH", 
p
, 13)) {

4772 
p
 += 13;

4773 
vœt_dev
->
wt_æag
 = 1;

4774 
	`TRACE_DBG
("%s", "WRITE_THROUGH");

4775 } ià(!
	`¡ºcmp
("NV_CACHE", 
p
, 8)) {

4776 
p
 += 8;

4777 
vœt_dev
->
nv_ÿche
 = 1;

4778 
	`TRACE_DBG
("%s", "NON-VOLATILE CACHE");

4779 } ià(!
	`¡ºcmp
("READ_ONLY", 
p
, 9)) {

4780 
p
 += 9;

4781 
vœt_dev
->
rd_Úly
 = 1;

4782 
	`TRACE_DBG
("%s", "READ_ONLY");

4783 } ià(!
	`¡ºcmp
("O_DIRECT", 
p
, 8)) {

4784 
p
 += 8;

4787 
vœt_dev
->
o_dœeù_æag
 = 1;

4788 
	`TRACE_DBG
("%s", "O_DIRECT");

4790 
	`PRINT_INFO
("%s flag doesn't currently"

4794 } ià(!
	`¡ºcmp
("NULLIO", 
p
, 6)) {

4795 
p
 += 6;

4796 
vœt_dev
->
nuÎio
 = 1;

4798 
vœt_dev
->
vdev_devt
 = &
vdisk_nuÎ_devty³
;

4799 
	`TRACE_DBG
("%s", "NULLIO");

4800 } ià(!
	`¡ºcmp
("BLOCKIO", 
p
, 7)) {

4801 
p
 += 7;

4802 
vœt_dev
->
blockio
 = 1;

4804 
vœt_dev
->
vdev_devt
 = &
vdisk_blk_devty³
;

4805 
	`TRACE_DBG
("%s", "BLOCKIO");

4806 } ià(!
	`¡ºcmp
("REMOVABLE", 
p
, 9)) {

4807 
p
 += 9;

4808 
vœt_dev
->
»movabË
 = 1;

4809 
	`TRACE_DBG
("%s", "REMOVABLE");

4811 
	`PRINT_ERROR
("UnknowÀæag \"%s\"", 
p
);

4812 
»s
 = -
EINVAL
;

4813 
out_ä“_vdev
;

4815 
	`is¥aû
(*
p
) && *p != '\0')

4816 
p
++;

4819 ià(!
vœt_dev
->
nuÎio
 && (*
fž’ame
 != '/')) {

4820 
	`PRINT_ERROR
("File…ath \"%s\" is‚ot "

4821 "absÞu‹", 
fž’ame
);

4822 
»s
 = -
EINVAL
;

4823 
out_up
;

4826 
vœt_dev
->
fž’ame
 = 
	`k¡rdup
(fž’ame, 
GFP_KERNEL
);

4827 ià(
vœt_dev
->
fž’ame
 =ð
NULL
) {

4828 
	`PRINT_ERROR
("%s", "Allocation of filename failed");

4829 
»s
 = -
ENOMEM
;

4830 
out_ä“_vdev
;

4833 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
,

4834 &
vdev_li¡
);

4836 
	`vdisk_»pÜt_»gi¡”šg
(
vœt_dev
);

4837 
vœt_dev
->
vœt_id
 = 
	`sc¡_»gi¡”_vœtu®_deviû
(

4838 
vœt_dev
->
vdev_devt
, vœt_dev->
Çme
);

4839 ià(
vœt_dev
->
vœt_id
 < 0) {

4840 
»s
 = 
vœt_dev
->
vœt_id
;

4841 
out_ä“_v·th
;

4843 
	`TRACE_DBG
("Added virt_dev (name %s, file‚ame %s, "

4845 "vdev_li¡", 
vœt_dev
->
Çme
,

4846 
	`vdev_g‘_fž’ame
(
vœt_dev
), vœt_dev->
vœt_id
,

4847 
vœt_dev
->
block_size
);

4848 } ià(
aùiÚ
 == 0) {

4849 
vœt_dev
 = 
	`vdev_fšd
(
Çme
);

4850 ià(
vœt_dev
 =ð
NULL
) {

4851 
	`PRINT_ERROR
("Deviû % nÙ found", 
Çme
);

4852 
»s
 = -
EINVAL
;

4853 
out_up
;

4855 
	`vdev_d–_deviû
(
vœt_dev
);

4856 } ià(
aùiÚ
 == 2) {

4857 
vœt_dev
 = 
	`vdev_fšd
(
Çme
);

4858 ià(
vœt_dev
 =ð
NULL
) {

4859 
	`PRINT_ERROR
("Deviû % nÙ found", 
Çme
);

4860 
»s
 = -
EINVAL
;

4861 
out_up
;

4864 
»s
 = 
	`vdisk_»sync_size
(
vœt_dev
);

4865 ià(
»s
 != 0)

4866 
out_up
;

4867 } ià(
aùiÚ
 == 3) {

4868 
vœt_dev
 = 
	`vdev_fšd
(
Çme
);

4869 ià(
vœt_dev
 =ð
NULL
) {

4870 
	`PRINT_ERROR
("Deviû % nÙ found", 
Çme
);

4871 
»s
 = -
EINVAL
;

4872 
out_up
;

4875 
	`is¥aû
(*
p
) && *p != '\0')

4876 
p
++;

4877 
t10_dev_id
 = 
p
;

4878 *
p
 != '\0')

4879 
p
++;

4880 *
p
++ = '\0';

4881 ià(*
t10_dev_id
 == '\0') {

4882 
	`PRINT_ERROR
("%s", "T10 device id„equired");

4883 
»s
 = -
EINVAL
;

4884 
out_up
;

4887 
	`wr™e_lock
(&
vdisk_£rŸl_rwlock
);

4889 
¦’
 = (
	`¡¾’
(
t10_dev_id
è<ð((
vœt_dev
->t10_dev_id)-1) ?

4890 
	`¡¾’
(
t10_dev_id
) :

4891 ((
vœt_dev
->
t10_dev_id
)-1));

4893 
	`mem£t
(
vœt_dev
->
t10_dev_id
, 0, (virt_dev->t10_dev_id));

4894 
	`memýy
(
vœt_dev
->
t10_dev_id
,10_dev_id, 
¦’
);

4896 
	`PRINT_INFO
("T10 device id for device %s changedo %s",

4897 
vœt_dev
->
Çme
, vœt_dev->
t10_dev_id
);

4899 
	`wr™e_uÆock
(&
vdisk_£rŸl_rwlock
);

4901 
»s
 = 
Ëngth
;

4903 
out_up
:

4904 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

4906 
out_ä“
:

4907 
	`kä“
(
i_buf
);

4909 
out
:

4910 
	`TRACE_EXIT_RES
(
»s
);

4911  
»s
;

4913 
out_ä“_v·th
:

4914 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

4915 
	`kä“
(
vœt_dev
->
fž’ame
);

4916 
vœt_dev
->
fž’ame
 = 
NULL
;

4918 
out_ä“_vdev
:

4919 
	`vdev_de¡roy
(
vœt_dev
);

4920 
out_up
;

4921 
	}
}

4926 
	$vcdrom_»ad_´oc
(
£q_fže
 *
£q
,

4927 
sc¡_dev_ty³
 *
dev_ty³
)

4929 
»s
 = 0;

4930 
sc¡_vdisk_dev
 *
vœt_dev
;

4932 
	`TRACE_ENTRY
();

4934 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
) != 0) {

4935 
»s
 = -
EINTR
;

4936 
out
;

4939 
	`£q_´štf
(
£q
, "%-17s %-9s %s\n", "Name", "Size(MB)", "File‚ame");

4941 
	`li¡_fÜ_—ch_’Œy
(
vœt_dev
, &
vdev_li¡
, 
vdev_li¡_’Œy
) {

4942 ià(
vœt_dev
->
dev
->
ty³
 !ð
TYPE_ROM
)

4944 
	`£q_´štf
(
£q
, "%-17 %-9d %s\n", 
vœt_dev
->
Çme
,

4945 (
ušt32_t
)(
vœt_dev
->
fže_size
 >> 20),

4946 
	`vdev_g‘_fž’ame
(
vœt_dev
));

4949 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

4951 
out
:

4952 
	`TRACE_EXIT_RES
(
»s
);

4953  
»s
;

4954 
	}
}

4957 
	$vcdrom_Ý’
(*
p
, *
Çme
)

4959 
sc¡_vdisk_dev
 *
vœt_dev
;

4960 *
fž’ame
;

4961 
»s
 = 0;

4962 
cdrom_em±y
;

4964 
	`is¥aû
(*
p
) && *p != '\0')

4965 
p
++;

4966 
fž’ame
 = 
p
;

4967 !
	`is¥aû
(*
p
) && *p != '\0')

4968 
p
++;

4969 *
p
++ = '\0';

4970 ià(*
fž’ame
 == '\0') {

4971 
cdrom_em±y
 = 1;

4972 
	`TRACE_DBG
("%s", "No media");

4973 } ià(*
fž’ame
 != '/') {

4974 
	`PRINT_ERROR
("Fž·th \"%s\" i nÙ‡bsÞu‹", 
fž’ame
);

4975 
»s
 = -
EINVAL
;

4976 
out
;

4978 
cdrom_em±y
 = 0;

4980 
»s
 = 
	`vdev_ü—‹
(&
vcdrom_devty³
, 
Çme
, &
vœt_dev
);

4981 ià(
»s
 != 0)

4982 
out
;

4984 
vœt_dev
->
cdrom_em±y
 = cdrom_empty;

4985 
vœt_dev
->
rd_Úly
 = 1;

4986 
vœt_dev
->
»movabË
 = 1;

4988 ià(!
vœt_dev
->
cdrom_em±y
) {

4989 
vœt_dev
->
fž’ame
 = 
	`k¡rdup
(fž’ame, 
GFP_KERNEL
);

4990 ià(
vœt_dev
->
fž’ame
 =ð
NULL
) {

4991 
	`PRINT_ERROR
("%s", "Allocation of filename failed");

4992 
»s
 = -
ENOMEM
;

4993 
out_ä“_vdev
;

4997 
	`li¡_add_ž
(&
vœt_dev
->
vdev_li¡_’Œy
, &
vdev_li¡
);

4999 
	`PRINT_INFO
("Regi¡”šg vœtu® CDROM %s", 
Çme
);

5001 
vœt_dev
->
vœt_id
 =

5002 
	`sc¡_»gi¡”_vœtu®_deviû
(&
vcdrom_devty³
,

5003 
vœt_dev
->
Çme
);

5004 ià(
vœt_dev
->
vœt_id
 < 0) {

5005 
»s
 = 
vœt_dev
->
vœt_id
;

5006 
out_ä“_v·th
;

5008 
	`TRACE_DBG
("Added virt_dev (name %s filename %s id %d) "

5009 "tØvdev_li¡", 
vœt_dev
->
Çme
,

5010 
	`vdev_g‘_fž’ame
(
vœt_dev
), vœt_dev->
vœt_id
);

5012 
out
:

5013  
»s
;

5015 
out_ä“_v·th
:

5016 
	`li¡_d–
(&
vœt_dev
->
vdev_li¡_’Œy
);

5017 
	`kä“
(
vœt_dev
->
fž’ame
);

5018 
vœt_dev
->
fž’ame
 = 
NULL
;

5020 
out_ä“_vdev
:

5021 
	`vdev_de¡roy
(
vœt_dev
);

5022 
out
;

5023 
	}
}

5026 
	$vcdrom_þo£
(*
Çme
)

5028 
sc¡_vdisk_dev
 *
vœt_dev
;

5029 
»s
 = 0;

5031 
vœt_dev
 = 
	`vdev_fšd
(
Çme
);

5032 ià(
vœt_dev
 =ð
NULL
) {

5033 
	`PRINT_ERROR
("Virtual device with‚ame "

5034 "% nÙ found", 
Çme
);

5035 
»s
 = -
EINVAL
;

5036 
out
;

5039 
	`vdev_d–_deviû
(
vœt_dev
);

5041 
out
:

5042  
»s
;

5043 
	}
}

5046 
	$vcdrom_´oc_chªge
(*
p
, cÚ¡ *
Çme
)

5048 
sc¡_vdisk_dev
 *
vœt_dev
;

5049 
»s
;

5051 
vœt_dev
 = 
	`vdev_fšd
(
Çme
);

5052 ià(
vœt_dev
 =ð
NULL
) {

5053 
	`PRINT_ERROR
("Virtual cdrom with‚ame "

5054 "% nÙ found", 
Çme
);

5055 
»s
 = -
EINVAL
;

5056 
out
;

5059 
»s
 = 
	`vcdrom_chªge
(
vœt_dev
, 
p
);

5061 
out
:

5062  
»s
;

5063 
	}
}

5068 
	$vcdrom_wr™e_´oc
(*
bufãr
, **
¡¬t
, 
off_t
 
off£t
,

5069 
Ëngth
, *
eof
, 
sc¡_dev_ty³
 *
dev_ty³
)

5071 
»s
 = 0, 
aùiÚ
;

5072 *
p
, *
Çme
, *
i_buf
;

5073 
sc¡_vdisk_dev
 *
vœt_dev
;

5075 
	`TRACE_ENTRY
();

5077 ià((
Ëngth
 =ð0è|| (
bufãr
 =ð
NULL
) || (buffer[0] == '\0'))

5078 
out
;

5080 
i_buf
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
Ëngth
, 
bufãr
);

5081 ià(
i_buf
 =ð
NULL
) {

5082 
	`PRINT_ERROR
("Unableo‡lloc intermediate buffer with size %d",

5083 
Ëngth
+1);

5084 
»s
 = -
ENOMEM
;

5085 
out
;

5088 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_vdisk_mu‹x
) != 0) {

5089 
»s
 = -
EINTR
;

5090 
out_ä“
;

5093 
p
 = 
i_buf
;

5094 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

5095 
p
[
	`¡¾’
(p) - 1] = '\0';

5096 ià(!
	`¡ºcmp
("þo£ ", 
p
, 6)) {

5097 
p
 += 6;

5098 
aùiÚ
 = 0;

5099 } ià(!
	`¡ºcmp
("chªg", 
p
, 7)) {

5100 
p
 += 7;

5101 
aùiÚ
 = 1;

5102 } ià(!
	`¡ºcmp
("Ý’ ", 
p
, 5)) {

5103 
p
 += 5;

5104 
aùiÚ
 = 2;

5106 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

5107 
»s
 = -
EINVAL
;

5108 
out_up
;

5111 
	`is¥aû
(*
p
) && *p != '\0')

5112 
p
++;

5113 
Çme
 = 
p
;

5114 !
	`is¥aû
(*
p
) && *p != '\0')

5115 
p
++;

5116 *
p
++ = '\0';

5117 ià(*
Çme
 == '\0') {

5118 
	`PRINT_ERROR
("%s", "Name„equired");

5119 
»s
 = -
EINVAL
;

5120 
out_up
;

5121 } ià(
	`¡¾’
(
Çme
è>ð(
vœt_dev
->name)) {

5122 
	`PRINT_ERROR
("Name isoo†ong (max %zd "

5123 "ch¬aù”s)", (
vœt_dev
->
Çme
)-1);

5124 
»s
 = -
EINVAL
;

5125 
out_up
;

5128 ià(
aùiÚ
 == 2) {

5130 
»s
 = 
	`vcdrom_Ý’
(
p
, 
Çme
);

5131 ià(
»s
 != 0)

5132 
out_up
;

5133 } ià(
aùiÚ
 == 1) {

5135 
»s
 = 
	`vcdrom_´oc_chªge
(
p
, 
Çme
);

5136 ià(
»s
 != 0)

5137 
out_up
;

5140 
»s
 = 
	`vcdrom_þo£
(
Çme
);

5141 ià(
»s
 != 0)

5142 
out_up
;

5144 
»s
 = 
Ëngth
;

5146 
out_up
:

5147 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

5149 
out_ä“
:

5150 
	`kä“
(
i_buf
);

5152 
out
:

5153 
	`TRACE_EXIT_RES
(
»s
);

5154  
»s
;

5155 
	}
}

5157 
	$vdisk_h–p_šfo_show
(
£q_fže
 *
£q
, *
v
)

5159 *
s
 = (*)
£q
->
´iv©e
;

5161 
	`TRACE_ENTRY
();

5163 
	`£q_´štf
(
£q
, "%s", 
s
);

5165 
	`TRACE_EXIT
();

5167 
	}
}

5169 
sc¡_´oc_d©a
 
	gvdisk_h–p_´oc_d©a
 = {

5170 
SCST_DEF_RW_SEQ_OP
(
NULL
)

5171 .
show
 = 
vdisk_h–p_šfo_show
,

5174 
	$vdisk_´oc_h–p_bužd
(
sc¡_dev_ty³
 *
dev_ty³
)

5176 
»s
 = 0;

5177 
´oc_dœ_’Œy
 *
p
, *
roÙ
;

5179 
	`TRACE_ENTRY
();

5181 
roÙ
 = 
	`sc¡_´oc_g‘_dev_ty³_roÙ
(
dev_ty³
);

5182 
vdisk_h–p_´oc_d©a
.
d©a
 = (
dev_ty³
->
ty³
 =ð
TYPE_DISK
) ?

5183 
vdisk_´oc_h–p_¡ršg
 :

5184 
vcdrom_´oc_h–p_¡ršg
;

5185 
p
 = 
	`sc¡_ü—‹_´oc_’Œy
(
roÙ
, 
VDISK_PROC_HELP
,

5186 &
vdisk_h–p_´oc_d©a
);

5187 ià(
p
 =ð
NULL
) {

5188 
	`PRINT_ERROR
("Notƒnough memoryo„egister dev "

5189 "hªdË¸% ’Œy % š /´oc", "vdisk", 
VDISK_PROC_HELP
);

5190 
»s
 = -
ENOMEM
;

5193 
	`TRACE_EXIT_RES
(
»s
);

5194  
»s
;

5195 
	}
}

5197 
	$vdisk_´oc_h–p_de¡roy
(
sc¡_dev_ty³
 *
dev_ty³
)

5199 
´oc_dœ_’Œy
 *
roÙ
;

5201 
	`TRACE_ENTRY
();

5203 
roÙ
 = 
	`sc¡_´oc_g‘_dev_ty³_roÙ
(
dev_ty³
);

5204 ià(
roÙ
)

5205 
	`»move_´oc_’Œy
(
VDISK_PROC_HELP
, 
roÙ
);

5207 
	`TRACE_EXIT
();

5208 
	}
}

5212 
__š™
 
	$š™_sc¡_vdisk
(
sc¡_dev_ty³
 *
devty³
)

5214 
»s
 = 0;

5216 
	`TRACE_ENTRY
();

5218 
devty³
->
moduË
 = 
THIS_MODULE
;

5220 
»s
 = 
	`sc¡_»gi¡”_vœtu®_dev_driv”
(
devty³
);

5221 ià(
»s
 < 0)

5222 
out
;

5224 #ifdeà
CONFIG_SCST_PROC


5225 ià(!
devty³
->
no_´oc
) {

5226 
»s
 = 
	`sc¡_dev_hªdËr_bužd_¡d_´oc
(
devty³
);

5227 ià(
»s
 < 0)

5228 
out_uÄeg
;

5230 
»s
 = 
	`vdisk_´oc_h–p_bužd
(
devty³
);

5231 ià(
»s
 < 0)

5232 
out_de¡roy_´oc
;

5236 
out
:

5237 
	`TRACE_EXIT_RES
(
»s
);

5238  
»s
;

5240 #ifdeà
CONFIG_SCST_PROC


5241 
out_de¡roy_´oc
:

5242 ià(!
devty³
->
no_´oc
)

5243 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(
devty³
);

5245 
out_uÄeg
:

5246 
	`sc¡_uÄegi¡”_vœtu®_dev_driv”
(
devty³
);

5247 
out
;

5249 
	}
}

5251 
	$ex™_sc¡_vdisk
(
sc¡_dev_ty³
 *
devty³
)

5253 
	`TRACE_ENTRY
();

5255 
	`mu‹x_lock
(&
sc¡_vdisk_mu‹x
);

5257 
sc¡_vdisk_dev
 *
vœt_dev
;

5259 ià(
	`li¡_em±y
(&
vdev_li¡
))

5262 
vœt_dev
 = 
	`li¡_’Œy
(
vdev_li¡
.
Ãxt
, 
	`ty³of
(*virt_dev),

5263 
vdev_li¡_’Œy
);

5265 
	`vdev_d–_deviû
(
vœt_dev
);

5267 
	`mu‹x_uÆock
(&
sc¡_vdisk_mu‹x
);

5269 #ifdeà
CONFIG_SCST_PROC


5270 ià(!
devty³
->
no_´oc
) {

5271 
	`vdisk_´oc_h–p_de¡roy
(
devty³
);

5272 
	`sc¡_dev_hªdËr_de¡roy_¡d_´oc
(
devty³
);

5276 
	`sc¡_uÄegi¡”_vœtu®_dev_driv”
(
devty³
);

5278 
	`TRACE_EXIT
();

5280 
	}
}

5282 
__š™
 
	$š™_sc¡_vdisk_driv”
()

5284 
»s
;

5286 
vdisk_thr_ÿch•
 = 
	`KMEM_CACHE
(
sc¡_vdisk_thr
, 
SCST_SLAB_FLAGS
);

5287 ià(
vdisk_thr_ÿch•
 =ð
NULL
) {

5288 
»s
 = -
ENOMEM
;

5289 
out
;

5292 
blockio_wÜk_ÿch•
 = 
	`KMEM_CACHE
(
sc¡_blockio_wÜk
, 
SCST_SLAB_FLAGS
);

5293 ià(
blockio_wÜk_ÿch•
 =ð
NULL
) {

5294 
»s
 = -
ENOMEM
;

5295 
out_ä“_vdisk_ÿche
;

5298 ià(
num_th»ads
 < 1) {

5299 
	`PRINT_ERROR
("num_threads can‚ot be†esshan 1, use "

5300 "deçuÉ %d", 
DEF_NUM_THREADS
);

5301 
num_th»ads
 = 
DEF_NUM_THREADS
;

5304 
vdisk_fže_devty³
.
th»ads_num
 = 
num_th»ads
;

5305 
vcdrom_devty³
.
th»ads_num
 = 
num_th»ads
;

5307 
	`©omic_£t
(&
nuÎio_thr_d©a
.
hdr
.
»f
, 1);

5309 
»s
 = 
	`š™_sc¡_vdisk
(&
vdisk_fže_devty³
);

5310 ià(
»s
 != 0)

5311 
out_ä“_¦ab
;

5313 
»s
 = 
	`š™_sc¡_vdisk
(&
vdisk_blk_devty³
);

5314 ià(
»s
 != 0)

5315 
out_ä“_vdisk
;

5317 
»s
 = 
	`š™_sc¡_vdisk
(&
vdisk_nuÎ_devty³
);

5318 ià(
»s
 != 0)

5319 
out_ä“_blk
;

5321 
»s
 = 
	`š™_sc¡_vdisk
(&
vcdrom_devty³
);

5322 ià(
»s
 != 0)

5323 
out_ä“_nuÎ
;

5325 
out
:

5326  
»s
;

5328 
out_ä“_nuÎ
:

5329 
	`ex™_sc¡_vdisk
(&
vdisk_nuÎ_devty³
);

5331 
out_ä“_blk
:

5332 
	`ex™_sc¡_vdisk
(&
vdisk_blk_devty³
);

5334 
out_ä“_vdisk
:

5335 
	`ex™_sc¡_vdisk
(&
vdisk_fže_devty³
);

5337 
out_ä“_¦ab
:

5338 
	`kmem_ÿche_de¡roy
(
blockio_wÜk_ÿch•
);

5340 
out_ä“_vdisk_ÿche
:

5341 
	`kmem_ÿche_de¡roy
(
vdisk_thr_ÿch•
);

5342 
out
;

5343 
	}
}

5345 
__ex™
 
	$ex™_sc¡_vdisk_driv”
()

5347 
	`ex™_sc¡_vdisk
(&
vdisk_nuÎ_devty³
);

5348 
	`ex™_sc¡_vdisk
(&
vdisk_blk_devty³
);

5349 
	`ex™_sc¡_vdisk
(&
vdisk_fže_devty³
);

5350 
	`ex™_sc¡_vdisk
(&
vcdrom_devty³
);

5352 
	`kmem_ÿche_de¡roy
(
blockio_wÜk_ÿch•
);

5353 
	`kmem_ÿche_de¡roy
(
vdisk_thr_ÿch•
);

5354 
	}
}

5356 
moduË_š™
(
š™_sc¡_vdisk_driv”
);

5357 
moduË_ex™
(
ex™_sc¡_vdisk_driv”
);

5359 
MODULE_AUTHOR
("Vladislav Bolkhovitin & Leonid Stoljar");

5360 
MODULE_LICENSE
("GPL");

5361 
MODULE_DESCRIPTION
("SCSI disk (type 0)‡nd CDROM (type 5) dev handler for "

5363 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@/root/Desktop/scst-2.2.0/src/dev_handlers/scst_vdisk.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

117 cÚ¡ 
	g__moduË_d•’ds
[]

118 
__u£d


119 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

123 
MODULE_INFO
(
¤cv”siÚ
, "C9A700B115BCA6589EB0EAB");

125 cÚ¡ 
rh–d©a
 
_rh–d©a
 
__u£d


126 
__©Œibu‹__
((
£ùiÚ
(".rheldata"))) = {

127 .
rh–_majÜ
 = 6,

128 .
	grh–_mšÜ
 = 4,

	@/root/Desktop/scst-2.2.0/src/scst.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

144 cÚ¡ 
	g__moduË_d•’ds
[]

145 
__u£d


146 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

150 
MODULE_INFO
(
¤cv”siÚ
, "CCB00EDE976B916890BA2D6");

152 cÚ¡ 
rh–d©a
 
_rh–d©a
 
__u£d


153 
__©Œibu‹__
((
£ùiÚ
(".rheldata"))) = {

154 .
rh–_majÜ
 = 6,

155 .
	grh–_mšÜ
 = 4,

	@/root/Desktop/scst-2.2.0/src/scst_debug.c

23 
	~<lšux/v”siÚ.h
>

25 #iâdeà
INSIDE_KERNEL_TREE


26 
	~<lšux/v”siÚ.h
>

28 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 2, 0)

29 
	~<lšux/expÜt.h
>

32 #ifdeà
INSIDE_KERNEL_TREE


33 
	~<sc¡/sc¡.h
>

34 
	~<sc¡/sc¡_debug.h
>

36 
	~"sc¡.h
"

37 
	~"sc¡_debug.h
"

40 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

42 
	#TRACE_BUF_SIZE
 512

	)

44 
	gŒaû_buf
[
TRACE_BUF_SIZE
];

45 
DEFINE_SPINLOCK
(
Œaû_buf_lock
);

47 
šlše
 
	$g‘_cu¼’t_tid
()

50 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 24)

51  
cu¼’t
->
pid
;

53 ià(
	`š_š‹¼u±
()) {

60  
	`sk_pid_vÄ
(
cu¼’t
);

62 
	}
}

69 
	$debug_´št_´efix
(
Œaû_æag
,

70 cÚ¡ *
´efix
, cÚ¡ *
func
, 
lše
)

72 
i
 = 0;

73 
æags
;

74 
pid
 = 
	`g‘_cu¼’t_tid
();

76 
	`¥š_lock_œq§ve
(&
Œaû_buf_lock
, 
æags
);

78 
Œaû_buf
[0] = '\0';

80 ià(
Œaû_æag
 & 
TRACE_PID
)

81 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
, "[%d]: ", 
pid
);

82 ià(
´efix
 !ð
NULL
)

83 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%s: ",

84 
´efix
);

85 ià(
Œaû_æag
 & 
TRACE_FUNCTION
)

86 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%s:", 
func
);

87 ià(
Œaû_æag
 & 
TRACE_LINE
)

88 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%i:", 
lše
);

90 
	`PRINTN
(
KERN_INFO
, "%s", 
Œaû_buf
);

92 
	`¥š_uÆock_œq»¡Üe
(&
Œaû_buf_lock
, 
æags
);

94  
i
;

95 
	}
}

96 
EXPORT_SYMBOL
(
debug_´št_´efix
);

103 
	$debug_´št_bufãr
(cÚ¡ *
d©a
, 
Ën
)

105 
z
, 
z1
, 
i
;

106 cÚ¡ *
buf
 = (cÚ¡ *è
d©a
;

107 
æags
;

109 ià(
buf
 =ð
NULL
)

112 
	`¥š_lock_œq§ve
(&
Œaû_buf_lock
, 
æags
);

114 
	`PRINT
(
KERN_INFO
, " (h)___0__1__2__3__4__5__6__7__8__9__A__B__C__D__E__F");

115 
z
 = 0, 
z1
 = 0, 
i
 = 0; z < 
Ën
; z++) {

116 ià(
z
 % 16 == 0) {

117 ià(
z
 != 0) {

118 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i,

120 ; (
z1
 < 
z
è&& (
i
 < 
TRACE_BUF_SIZE
 - 1);

121 
z1
++) {

122 ià((
buf
[
z1
] >= 0x20) &&

123 (
buf
[
z1
] < 0x80))

124 
Œaû_buf
[
i
++] = 
buf
[
z1
];

126 
Œaû_buf
[
i
++] = '.';

128 
Œaû_buf
[
i
] = '\0';

129 
	`PRINT
(
KERN_INFO
, "%s", 
Œaû_buf
);

130 
i
 = 0;

132 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i,

133 "%4x: ", 
z
);

135 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, "%02x ",

136 
buf
[
z
]);

139 
i
 +ð
	`¢´štf
(&
Œaû_buf
[i], 
TRACE_BUF_SIZE
 - i, " ");

140 ; (
z1
 < 
z
è&& (
i
 < 
TRACE_BUF_SIZE
 - 1); z1++) {

141 ià((
buf
[
z1
] > 0x20) && (buf[z1] < 0x80))

142 
Œaû_buf
[
i
++] = 
buf
[
z1
];

144 
Œaû_buf
[
i
++] = '.';

146 
Œaû_buf
[
i
] = '\0';

148 
	`PRINT
(
KERN_INFO
, "%s", 
Œaû_buf
);

150 
	`¥š_uÆock_œq»¡Üe
(&
Œaû_buf_lock
, 
æags
);

152 
	}
}

153 
EXPORT_SYMBOL
(
debug_´št_bufãr
);

166 cÚ¡ *
	$debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
)

173 
	#SIZEOF_NAME_BUF
 256

	)

174 
Çme_bufs
[
NR_CPUS
][
SIZEOF_NAME_BUF
];

175 *
Çme_buf
;

176 
æags
;

178 
	`sBUG_ON
(
Œª¥Üt_id
 =ð
NULL
);

180 
	`¥š_lock_œq§ve
(&
Œaû_buf_lock
, 
æags
);

182 
Çme_buf
 = 
Çme_bufs
[
	`smp_´oûssÜ_id
()];

188 
	`mem£t
(
Çme_buf
, 0, 
SIZEOF_NAME_BUF
);

189 
	`smp_mb
();

191 
Œª¥Üt_id
[0] & 0x0f) {

192 
SCSI_TRANSPORTID_PROTOCOLID_ISCSI
:

193 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
, "%s",

194 &
Œª¥Üt_id
[4]);

196 
SCSI_TRANSPORTID_PROTOCOLID_FCP2
:

197 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

199 
Œª¥Üt_id
[8],ransport_id[9],

200 
Œª¥Üt_id
[10],ransport_id[11],

201 
Œª¥Üt_id
[12],ransport_id[13],

202 
Œª¥Üt_id
[14],ransport_id[15]);

204 
SCSI_TRANSPORTID_PROTOCOLID_SPI5
:

205 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

206 "%x:%x", 
	`be16_to_ýu
((
__fÜû
 
__be16
)
Œª¥Üt_id
[2]),

207 
	`be16_to_ýu
((
__fÜû
 
__be16
)
Œª¥Üt_id
[6]));

209 
SCSI_TRANSPORTID_PROTOCOLID_SRP
:

210 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

213 
Œª¥Üt_id
[8],ransport_id[9],

214 
Œª¥Üt_id
[10],ransport_id[11],

215 
Œª¥Üt_id
[12],ransport_id[13],

216 
Œª¥Üt_id
[14],ransport_id[15],

217 
Œª¥Üt_id
[16],ransport_id[17],

218 
Œª¥Üt_id
[18],ransport_id[19],

219 
Œª¥Üt_id
[20],ransport_id[21],

220 
Œª¥Üt_id
[22],ransport_id[23]);

222 
SCSI_TRANSPORTID_PROTOCOLID_SAS
:

223 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

225 
Œª¥Üt_id
[4],ransport_id[5],

226 
Œª¥Üt_id
[6],ransport_id[7],

227 
Œª¥Üt_id
[8],ransport_id[9],

228 
Œª¥Üt_id
[10],ransport_id[11]);

231 
	`sú´štf
(
Çme_buf
, 
SIZEOF_NAME_BUF
,

232 "(NÙ knowÀ´ÙocÞ ID %x)", 
Œª¥Üt_id
[0] & 0x0f);

236 
	`¥š_uÆock_œq»¡Üe
(&
Œaû_buf_lock
, 
æags
);

238  
Çme_buf
;

239 #undeà
SIZEOF_NAME_BUF


240 
	}
}

	@/root/Desktop/scst-2.2.0/src/scst_lib.c

20 
	~<lšux/š™.h
>

21 
	~<lšux/k”Ãl.h
>

22 
	~<lšux/”ºo.h
>

23 
	~<lšux/li¡.h
>

24 
	~<lšux/¥šlock.h
>

25 
	~<lšux/¦ab.h
>

26 
	~<lšux/sched.h
>

27 
	~<lšux/kth»ad.h
>

28 
	~<lšux/cdrom.h
>

29 
	~<lšux/uni¡d.h
>

30 
	~<lšux/¡ršg.h
>

31 
	~<lšux/ùy³.h
>

32 
	~<lšux/d–ay.h
>

33 
	~<lšux/vm®loc.h
>

34 
	~<asm/km­_ty³s.h
>

35 
	~<asm/uÇligÃd.h
>

37 #ifdeà
INSIDE_KERNEL_TREE


38 
	~<sc¡/sc¡.h
>

40 
	~"sc¡.h
"

42 
	~"sc¡_´iv.h
"

43 
	~"sc¡_mem.h
"

44 
	~"sc¡_´es.h
"

46 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)

47 
	sscsi_io_cÚ‹xt
 {

48 *
	md©a
;

49 (*
	mdÚe
)(*
	md©a
, *
	m£n£
, 
	m»suÉ
, 
	m»sid
);

50 
	m£n£
[
SCST_SENSE_BUFFERSIZE
];

52 
kmem_ÿche
 *
	gscsi_io_cÚ‹xt_ÿche
;

55 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 22) \

56 && (!
defšed
(
RHEL_RELEASE_CODE
è|| 
	gRHEL_RELEASE_CODE
 -0 < 5 * 256 + 3) \

57 && !
	$defšed
(
CONFIG_PPC
)

58 
	$¡ºÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
n
)

60 
c1
, 
c2
;

63 
c1
 = 
	`tÞow”
(*
s1
++);

64 
c2
 = 
	`tÞow”
(*
s2
++);

65 } (--
n
 > 0è&& 
c1
 =ð
c2
 && c1 != 0);

66  
c1
 - 
c2
;

67 
	}
}

71 
g‘_Œªs_Ën_1
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

72 
g‘_Œªs_Ën_1_256
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

73 
g‘_Œªs_Ën_2
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

74 
g‘_Œªs_Ën_3
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

75 
g‘_Œªs_Ën_4
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

77 
g‘_bidi_Œªs_Ën_2
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

80 
g‘_Œªs_Ën_block_lim™
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

81 
g‘_Œªs_Ën_»ad_ÿ·c™y
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

82 
g‘_Œªs_Ën_£rv_aù_š
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

83 
g‘_Œªs_Ën_sšgË
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

84 
g‘_Œªs_Ën_nÚe
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

85 
g‘_Œªs_Ën_»ad_pos
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

86 
g‘_Œªs_cdb_Ën_10
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

87 
g‘_Œªs_Ën_´ev’t_®low_medium_»mov®
(
sc¡_cmd
 *
cmd
,

88 
ušt8_t
 
off
);

89 
g‘_Œªs_Ën_3_»ad_–em_¡©
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

90 
g‘_Œªs_Ën_¡¬t_¡Ý
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
);

107 
	#SCST_CDB_MANDATORY
 'M'

	)

108 
	#SCST_CDB_OPTIONAL
 'O'

	)

109 
	#SCST_CDB_VENDOR
 'V'

	)

110 
	#SCST_CDB_RESERVED
 'R'

	)

111 
	#SCST_CDB_NOTSUPP
 ' '

	)

113 
	ssc¡_sdbÝs
 {

114 
ušt8_t
 
	mÝs
;

115 
ušt8_t
 
	mdevkey
[16];

133 cÚ¡ *
	mÝ_Çme
;

134 
ušt8_t
 
	mdœeùiÚ
;

137 
ušt32_t
 
	mæags
;

138 
ušt8_t
 
	moff
;

139 (*
	mg‘_Œªs_Ën
)(
sc¡_cmd
 *
	mcmd
, 
ušt8_t
 
	moff
);

142 
	gsc¡_scsi_Ý_li¡
[256];

144 
	#FLAG_NONE
 0

	)

146 cÚ¡ 
sc¡_sdbÝs
 
	gsc¡_scsi_Ý_bË
[] = {

168 
SCST_DATA_NONE
, 
SCST_SMALL_TIMEOUT
|
SCST_IMPLICIT_HQ
|

169 
SCST_REG_RESERVE_ALLOWED
|

170 
SCST_WRITE_EXCL_ALLOWED
|

171 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


172 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

174 
SCST_EXCL_ACCESS_ALLOWED
,

175 0, 
g‘_Œªs_Ën_nÚe
},

177 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
|
SCST_WRITE_EXCL_ALLOWED
,

178 0, 
g‘_Œªs_Ën_nÚe
},

180 
SCST_DATA_NONE
, 
SCST_WRITE_EXCL_ALLOWED
,

181 0, 
g‘_Œªs_Ën_nÚe
},

183 
SCST_DATA_NONE
, 
SCST_SMALL_TIMEOUT
, 0, 
g‘_Œªs_Ën_nÚe
},

185 
SCST_DATA_READ
, 
SCST_SMALL_TIMEOUT
|
SCST_SKIP_UA
|
SCST_LOCAL_CMD
|

186 
SCST_REG_RESERVE_ALLOWED
|

187 
SCST_WRITE_EXCL_ALLOWED
|

188 
SCST_EXCL_ACCESS_ALLOWED
,

189 4, 
g‘_Œªs_Ën_1
},

191 
SCST_DATA_WRITE
, 
SCST_LONG_TIMEOUT
|
SCST_UNKNOWN_LENGTH
|
SCST_WRITE_MEDIUM
,

192 0, 
g‘_Œªs_Ën_nÚe
},

194 
SCST_DATA_NONE
, 
SCST_WRITE_MEDIUM
, 0, 
g‘_Œªs_Ën_nÚe
},

196 
SCST_DATA_READ
, 
SCST_SMALL_TIMEOUT
|

197 
SCST_REG_RESERVE_ALLOWED
|

198 
SCST_WRITE_EXCL_ALLOWED
|

199 
SCST_EXCL_ACCESS_ALLOWED
,

200 0, 
g‘_Œªs_Ën_block_lim™
},

202 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_Ën_nÚe
},

204 
SCST_DATA_NONE
, 
SCST_WRITE_MEDIUM
, 0, 
g‘_Œªs_Ën_nÚe
},

206 
SCST_DATA_READ
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

207 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


208 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

210 
SCST_WRITE_EXCL_ALLOWED
,

211 4, 
g‘_Œªs_Ën_1_256
},

213 
SCST_DATA_READ
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

214 
SCST_WRITE_EXCL_ALLOWED
,

215 2, 
g‘_Œªs_Ën_3
},

217 
SCST_DATA_READ
, 
FLAG_NONE
, 2, 
g‘_Œªs_Ën_3
},

219 
SCST_DATA_READ
, 
FLAG_NONE
, 2, 
g‘_Œªs_Ën_3
},

221 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

222 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


223 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

225 
SCST_WRITE_MEDIUM
,

226 4, 
g‘_Œªs_Ën_1_256
},

228 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

229 2, 
g‘_Œªs_Ën_3
},

231 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

233 
SCST_DATA_WRITE
, 
FLAG_NONE
, 2, 
g‘_Œªs_Ën_3
},

235 
SCST_DATA_WRITE
, 
FLAG_NONE
, 2, 
g‘_Œªs_Ën_3
},

237 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

239 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

241 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

243 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_Ën_nÚe
},

245 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
|
SCST_WRITE_MEDIUM
,

246 0, 
g‘_Œªs_Ën_nÚe
},

248 
SCST_DATA_READ
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

249 
SCST_WRITE_EXCL_ALLOWED
,

250 2, 
g‘_Œªs_Ën_3
},

252 
SCST_DATA_NONE
, 
SCST_WRITE_MEDIUM
, 0, 
g‘_Œªs_Ën_nÚe
},

254 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

256 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
|

257 
SCST_WRITE_EXCL_ALLOWED
,

258 0, 
g‘_Œªs_Ën_nÚe
},

260 
SCST_DATA_READ
, 
SCST_SMALL_TIMEOUT
|
SCST_IMPLICIT_HQ
|
SCST_SKIP_UA
|

261 
SCST_REG_RESERVE_ALLOWED
|

262 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

263 3, 
g‘_Œªs_Ën_2
},

265 
SCST_DATA_NONE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

266 
SCST_VERIFY_BYTCHK_MISMATCH_ALLOWED
|

267 
SCST_WRITE_EXCL_ALLOWED
,

268 2, 
g‘_Œªs_Ën_3
},

270 
SCST_DATA_READ
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

271 
SCST_WRITE_EXCL_ALLOWED
,

272 2, 
g‘_Œªs_Ën_3
},

274 
SCST_DATA_WRITE
, 
SCST_STRICTLY_SERIALIZED
, 4, 
g‘_Œªs_Ën_1
},

276 
SCST_DATA_NONE
, 
SCST_SMALL_TIMEOUT
|
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

277 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

278 0, 
g‘_Œªs_Ën_nÚe
},

280 
SCST_DATA_NONE
, 
SCST_SMALL_TIMEOUT
|
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

281 
SCST_REG_RESERVE_ALLOWED
|

282 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

283 0, 
g‘_Œªs_Ën_nÚe
},

285 
SCST_DATA_WRITE
, 
SCST_LONG_TIMEOUT
, 2, 
g‘_Œªs_Ën_3
},

287 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
|
SCST_WRITE_MEDIUM
,

288 0, 
g‘_Œªs_Ën_nÚe
},

290 
SCST_DATA_READ
, 
SCST_SMALL_TIMEOUT
, 4, 
g‘_Œªs_Ën_1
},

292 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

294 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_Ën_nÚe
},

296 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

298 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_Ën_¡¬t_¡Ý
},

300 
SCST_DATA_READ
, 
FLAG_NONE
, 3, 
g‘_Œªs_Ën_2
},

302 
SCST_DATA_WRITE
, 
FLAG_NONE
, 4, 
g‘_Œªs_Ën_1
},

304 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0,

305 
g‘_Œªs_Ën_´ev’t_®low_medium_»mov®
},

307 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

311 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

313 
SCST_DATA_WRITE
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_3
},

315 
SCST_DATA_READ
, 
SCST_IMPLICIT_HQ
|

316 
SCST_REG_RESERVE_ALLOWED
|

317 
SCST_WRITE_EXCL_ALLOWED
|

318 
SCST_EXCL_ACCESS_ALLOWED
,

319 0, 
g‘_Œªs_Ën_»ad_ÿ·c™y
},

321 
SCST_DATA_READ
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_3
},

323 
SCST_DATA_READ
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

324 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


325 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

327 
SCST_WRITE_EXCL_ALLOWED
,

328 7, 
g‘_Œªs_Ën_2
},

330 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

332 
SCST_DATA_READ
, 
FLAG_NONE
, 8, 
g‘_Œªs_Ën_1
},

334 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

335 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


336 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

338 
SCST_WRITE_MEDIUM
,

339 7, 
g‘_Œªs_Ën_2
},

341 
SCST_DATA_WRITE
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

343 
SCST_DATA_WRITE
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

345 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
|

346 
SCST_WRITE_EXCL_ALLOWED
,

347 0, 
g‘_Œªs_Ën_nÚe
},

349 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_Ën_nÚe
},

351 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

353 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
|
SCST_WRITE_MEDIUM
,

354 0, 
g‘_Œªs_Ën_nÚe
},

356 
SCST_DATA_READ
, 
SCST_TRANSFER_LEN_TYPE_FIXED
, 0, 
g‘_Œªs_Ën_sšgË
},

358 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

359 7, 
g‘_Œªs_Ën_2
},

361 
SCST_DATA_NONE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

362 
SCST_VERIFY_BYTCHK_MISMATCH_ALLOWED
|

363 
SCST_WRITE_EXCL_ALLOWED
,

364 7, 
g‘_Œªs_Ën_2
},

366 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

368 
SCST_DATA_READ
, 
SCST_SMALL_TIMEOUT
|

369 
SCST_WRITE_EXCL_ALLOWED
,

370 7, 
g‘_Œªs_Ën_»ad_pos
},

372 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

374 
SCST_DATA_NONE
, 
SCST_WRITE_EXCL_ALLOWED
,

375 0, 
g‘_Œªs_Ën_nÚe
},

377 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

379 
SCST_DATA_NONE
, 
SCST_WRITE_EXCL_ALLOWED
,

380 0, 
g‘_Œªs_Ën_nÚe
},

382 
SCST_DATA_READ
, 
SCST_WRITE_EXCL_ALLOWED
,

383 8, 
g‘_Œªs_Ën_1
},

385 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_Ën_nÚe
},

387 
SCST_DATA_READ
, 
FLAG_NONE
, 8, 
g‘_Œªs_Ën_1
},

389 
SCST_DATA_WRITE
, 
FLAG_NONE
, 3, 
g‘_Œªs_Ën_3
},

391 
SCST_DATA_WRITE
, 
FLAG_NONE
, 3, 
g‘_Œªs_Ën_3
},

393 
SCST_DATA_WRITE
, 
SCST_SMALL_TIMEOUT
, 6, 
g‘_Œªs_Ën_3
},

395 
SCST_DATA_READ
, 
SCST_SMALL_TIMEOUT
, 6, 
g‘_Œªs_Ën_3
},

397 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
,

398 0, 
g‘_Œªs_Ën_sšgË
},

400 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

402 
SCST_DATA_WRITE
, 
SCST_WRITE_MEDIUM
, 7, 
g‘_Œªs_Ën_2
},

404 
SCST_DATA_WRITE
, 
SCST_SMALL_TIMEOUT
, 8, 
g‘_Œªs_Ën_1
},

406 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

407 0, 
g‘_Œªs_Ën_sšgË
},

409 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

411 
SCST_DATA_WRITE
, 
SCST_WRITE_MEDIUM
, 7, 
g‘_Œªs_Ën_2
},

413 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

415 
SCST_DATA_READ
, 
SCST_REG_RESERVE_ALLOWED
|

416 
SCST_WRITE_EXCL_ALLOWED
|

417 
SCST_EXCL_ACCESS_ALLOWED
,

418 7, 
g‘_Œªs_Ën_2
},

420 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

422 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

424 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

426 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

428 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

430 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

432 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

434 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

436 
SCST_DATA_WRITE
, 
SCST_STRICTLY_SERIALIZED
, 7, 
g‘_Œªs_Ën_2
},

438 
SCST_DATA_READ
, 
SCST_SMALL_TIMEOUT
|

439 
SCST_REG_RESERVE_ALLOWED
|

440 
SCST_WRITE_EXCL_ALLOWED
|

441 
SCST_EXCL_ACCESS_ALLOWED
,

442 7, 
g‘_Œªs_Ën_2
},

444 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

446 
SCST_DATA_NONE
, 
SCST_WRITE_MEDIUM
, 0, 
g‘_Œªs_Ën_nÚe
},

448 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

450 
SCST_DATA_NONE
, 
SCST_WRITE_MEDIUM
, 0, 
g‘_Œªs_Ën_nÚe
},

452 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

454 
SCST_DATA_READ
|
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

455 
SCST_WRITE_MEDIUM
,

456 7, 
g‘_bidi_Œªs_Ën_2
},

458 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

460 
SCST_DATA_WRITE
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

462 
SCST_DATA_WRITE
, 
SCST_STRICTLY_SERIALIZED
, 7, 
g‘_Œªs_Ën_2
},

464 
SCST_DATA_NONE
, 
SCST_SMALL_TIMEOUT
|
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

465 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

466 0, 
g‘_Œªs_Ën_nÚe
},

468 
SCST_DATA_NONE
, 
SCST_SMALL_TIMEOUT
|
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

469 
SCST_REG_RESERVE_ALLOWED
|

470 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

471 0, 
g‘_Œªs_Ën_nÚe
},

473 
SCST_DATA_NONE
, 
SCST_WRITE_MEDIUM
, 0, 
g‘_Œªs_Ën_nÚe
},

475 
SCST_DATA_READ
, 
SCST_SMALL_TIMEOUT
, 7, 
g‘_Œªs_Ën_2
},

477 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

479 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_2
},

481 
SCST_DATA_WRITE
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_3
},

483 
SCST_DATA_READ
, 
SCST_SMALL_TIMEOUT
|

484 
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

485 
SCST_WRITE_EXCL_ALLOWED
|

486 
SCST_EXCL_ACCESS_ALLOWED
,

487 5, 
g‘_Œªs_Ën_4
},

489 
SCST_DATA_WRITE
, 
SCST_SMALL_TIMEOUT
|

490 
SCST_LOCAL_CMD
|
SCST_SERIALIZED
|

491 
SCST_WRITE_EXCL_ALLOWED
|

492 
SCST_EXCL_ACCESS_ALLOWED
,

493 5, 
g‘_Œªs_Ën_4
},

497 
SCST_DATA_NONE
, 
SCST_WRITE_MEDIUM
, 0, 
g‘_Œªs_Ën_nÚe
},

499 
SCST_DATA_NONE
, 
SCST_WRITE_MEDIUM
, 0, 
g‘_Œªs_Ën_nÚe
},

501 
SCST_DATA_WRITE
, 
SCST_WRITE_MEDIUM
, 10, 
g‘_Œªs_Ën_4
},

503 
SCST_DATA_WRITE
, 
SCST_WRITE_MEDIUM
, 10, 
g‘_Œªs_Ën_4
},

505 
SCST_DATA_WRITE
, 
SCST_WRITE_MEDIUM
, 10, 
g‘_Œªs_Ën_4
},

507 
SCST_DATA_WRITE
, 
FLAG_NONE
, 10, 
g‘_Œªs_Ën_4
},

509 
SCST_DATA_NONE
, 
SCST_REG_RESERVE_ALLOWED
|

510 
SCST_WRITE_EXCL_ALLOWED
|

511 
SCST_EXCL_ACCESS_ALLOWED
,

512 0, 
g‘_Œªs_Ën_nÚe
},

514 
SCST_DATA_NONE
, 
SCST_REG_RESERVE_ALLOWED
|

515 
SCST_WRITE_EXCL_ALLOWED
|

516 
SCST_EXCL_ACCESS_ALLOWED
,

517 0, 
g‘_Œªs_Ën_nÚe
},

519 
SCST_DATA_READ
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

520 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


521 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

523 
SCST_WRITE_EXCL_ALLOWED
,

524 10, 
g‘_Œªs_Ën_4
},

526 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

527 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


528 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

530 
SCST_WRITE_MEDIUM
,

531 10, 
g‘_Œªs_Ën_4
},

533 
SCST_DATA_READ
, 
FLAG_NONE
, 10, 
g‘_Œªs_Ën_4
},

535 
SCST_DATA_WRITE
, 
SCST_WRITE_MEDIUM
, 10, 
g‘_Œªs_Ën_4
},

537 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

538 10, 
g‘_Œªs_Ën_4
},

540 
SCST_DATA_NONE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

541 
SCST_VERIFY_BYTCHK_MISMATCH_ALLOWED
|

542 
SCST_WRITE_EXCL_ALLOWED
,

543 10, 
g‘_Œªs_Ën_4
},

545 
SCST_DATA_NONE
, 
SCST_WRITE_EXCL_ALLOWED
,

546 0, 
g‘_Œªs_Ën_nÚe
},

548 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

550 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
|

551 
SCST_WRITE_EXCL_ALLOWED
,

552 0, 
g‘_Œªs_Ën_nÚe
},

554 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

556 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
|

557 
SCST_WRITE_EXCL_ALLOWED
,

558 0, 
g‘_Œªs_Ën_nÚe
},

560 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

561 10, 
g‘_Œªs_Ën_4
},

563 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
|
SCST_WRITE_MEDIUM
,

564 0, 
g‘_Œªs_Ën_nÚe
},

566 
SCST_DATA_READ
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_£rv_aù_š
},

570 
SCST_DATA_READ
, 
SCST_SMALL_TIMEOUT
|
SCST_IMPLICIT_HQ
|
SCST_SKIP_UA
|

571 
SCST_FULLY_LOCAL_CMD
|
SCST_LOCAL_CMD
|

572 
SCST_REG_RESERVE_ALLOWED
|

573 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

574 6, 
g‘_Œªs_Ën_4
},

576 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_Ën_nÚe
},

578 
SCST_DATA_WRITE
, 
FLAG_NONE
, 8, 
g‘_Œªs_Ën_2
},

580 
SCST_DATA_READ
, 
SCST_REG_RESERVE_ALLOWED
|

581 
SCST_WRITE_EXCL_ALLOWED
|
SCST_EXCL_ACCESS_ALLOWED
,

582 6, 
g‘_Œªs_Ën_4
},

584 
SCST_DATA_READ
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_4
},

586 
SCST_DATA_READ
, 
FLAG_NONE
, 8, 
g‘_Œªs_Ën_2
},

588 
SCST_DATA_WRITE
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_4
},

590 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_Ën_nÚe
},

592 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

594 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_Ën_nÚe
},

596 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

598 
SCST_DATA_READ
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_4
},

600 
SCST_DATA_READ
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

601 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


602 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

604 
SCST_WRITE_EXCL_ALLOWED
,

605 6, 
g‘_Œªs_Ën_4
},

607 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

609 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

610 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


611 
SCST_TEST_IO_IN_SIRQ_ALLOWED
|

613 
SCST_WRITE_MEDIUM
,

614 6, 
g‘_Œªs_Ën_4
},

616 
SCST_DATA_WRITE
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_4
},

618 
SCST_DATA_NONE
, 
SCST_WRITE_MEDIUM
, 0, 
g‘_Œªs_Ën_nÚe
},

620 
SCST_DATA_READ
, 
SCST_UNKNOWN_LENGTH
, 0, 
g‘_Œªs_Ën_nÚe
},

622 
SCST_DATA_READ
, 
FLAG_NONE
, 8, 
g‘_Œªs_Ën_2
},

624 
SCST_DATA_WRITE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|
SCST_WRITE_MEDIUM
,

625 6, 
g‘_Œªs_Ën_4
},

627 
SCST_DATA_NONE
, 
SCST_TRANSFER_LEN_TYPE_FIXED
|

628 
SCST_VERIFY_BYTCHK_MISMATCH_ALLOWED
|

629 
SCST_WRITE_EXCL_ALLOWED
,

630 6, 
g‘_Œªs_Ën_4
},

633 
SCST_DATA_WRITE
, 
FLAG_NONE
, 9, 
g‘_Œªs_Ën_1
},

635 
SCST_DATA_WRITE
, 
FLAG_NONE
, 9, 
g‘_Œªs_Ën_1
},

637 
SCST_DATA_WRITE
, 
FLAG_NONE
, 9, 
g‘_Œªs_Ën_1
},

640 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

642 
SCST_DATA_READ
, 
FLAG_NONE
, 9, 
g‘_Œªs_Ën_1
},

644 
SCST_DATA_WRITE
, 
FLAG_NONE
, 9, 
g‘_Œªs_Ën_1
},

646 
SCST_DATA_WRITE
, 
FLAG_NONE
, 9, 
g‘_Œªs_Ën_2
},

648 
SCST_DATA_READ
, 
SCST_WRITE_EXCL_ALLOWED
,

649 9, 
g‘_Œªs_Ën_1
},

651 
SCST_DATA_READ
, 
FLAG_NONE
, 7, 
g‘_Œªs_Ën_3_»ad_–em_¡©
},

653 
SCST_DATA_READ
, 
SCST_UNKNOWN_LENGTH
, 0, 
g‘_Œªs_Ën_nÚe
},

655 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_Ën_nÚe
},

657 
SCST_DATA_READ
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_4
},

659 
SCST_DATA_NONE
, 
FLAG_NONE
, 0, 
g‘_Œªs_Ën_nÚe
},

661 
SCST_DATA_WRITE
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_4
},

663 
SCST_DATA_READ
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_4
},

665 
SCST_DATA_READ
, 
FLAG_NONE
, 8, 
g‘_Œªs_Ën_2
},

667 
SCST_DATA_WRITE
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_4
},

669 
SCST_DATA_READ
, 
SCST_TRANSFER_LEN_TYPE_FIXED
, 6, 
g‘_Œªs_Ën_3
},

671 
SCST_DATA_READ
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_4
},

673 
SCST_DATA_WRITE
, 
FLAG_NONE
, 8, 
g‘_Œªs_Ën_2
},

675 
SCST_DATA_WRITE
, 
FLAG_NONE
, 6, 
g‘_Œªs_Ën_4
},

677 
SCST_DATA_NONE
, 
SCST_LONG_TIMEOUT
, 0, 
g‘_Œªs_cdb_Ën_10
}

680 
	#SCST_CDB_TBL_SIZE
 (()
	`ARRAY_SIZE
(
sc¡_scsi_Ý_bË
))

	)

682 
sc¡_ä“_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

683 
sc¡_check_š‹º®_£n£
(
sc¡_deviû
 *
dev
, 
»suÉ
,

684 
ušt8_t
 *
£n£
, 
£n£_Ën
);

685 
sc¡_queue_»pÜt_luns_chªged_UA
(
sc¡_£ssiÚ
 *
£ss
,

686 
æags
);

687 
__sc¡_check_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

688 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
);

689 
sc¡_®loc_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

690 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
);

691 
sc¡_ä“_®l_UA
(
sc¡_tgt_dev
 *
tgt_dev
);

692 
sc¡_»Ëa£_¥aû
(
sc¡_cmd
 *
cmd
);

693 
sc¡_þ—r_»£rv©iÚ
(
sc¡_tgt_dev
 *
tgt_dev
);

694 
sc¡_®loc_add_tgt_dev
(
sc¡_£ssiÚ
 *
£ss
,

695 
sc¡_acg_dev
 *
acg_dev
, 
sc¡_tgt_dev
 **
out_tgt_dev
);

696 
sc¡_tgt_»Œy_tim”_â
(
¬g
);

698 #ifdeà
CONFIG_SCST_DEBUG_TM


699 
tm_dbg_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

700 
tm_dbg_deš™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

702 
šlše
 
	$tm_dbg_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
è{
	}
}

703 
šlše
 
	$tm_dbg_deš™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
è{
	}
}

713 
	$sc¡_®loc_£n£
(
sc¡_cmd
 *
cmd
, 
©omic
)

715 
»s
 = 0;

716 
gå_t
 
gå_mask
 = 
©omic
 ? 
GFP_ATOMIC
 : (
GFP_KERNEL
|
__GFP_NOFAIL
);

718 
	`TRACE_ENTRY
();

720 ià(
cmd
->
£n£
 !ð
NULL
)

721 
memz”o
;

723 
cmd
->
£n£
 = 
	`mempoÞ_®loc
(
sc¡_£n£_mempoÞ
, 
gå_mask
);

724 ià(
cmd
->
£n£
 =ð
NULL
) {

725 
	`PRINT_CRIT_ERROR
("Sense memory‡llocation failed (op %x). "

726 "Th£n£ d©¨wžÈblo¡!!", 
cmd
->
cdb
[0]);

727 
»s
 = -
ENOMEM
;

728 
out
;

731 
cmd
->
£n£_buæ’
 = 
SCST_SENSE_BUFFERSIZE
;

733 
memz”o
:

734 
cmd
->
£n£_v®id_Ën
 = 0;

735 
	`mem£t
(
cmd
->
£n£
, 0, cmd->
£n£_buæ’
);

737 
out
:

738 
	`TRACE_EXIT_RES
(
»s
);

739  
»s
;

740 
	}
}

741 
EXPORT_SYMBOL
(
sc¡_®loc_£n£
);

750 
	$sc¡_®loc_£t_£n£
(
sc¡_cmd
 *
cmd
, 
©omic
,

751 cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
)

753 
»s
;

755 
	`TRACE_ENTRY
();

762 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 
©omic
);

763 ià(
»s
 != 0) {

764 
	`PRINT_BUFFER
("Lo¡ s’£", 
£n£
, 
Ën
);

765 
out
;

768 
cmd
->
£n£_v®id_Ën
 = 
Ën
;

769 ià(
cmd
->
£n£_buæ’
 < 
Ën
) {

770 
	`PRINT_WARNING
("Senseruncated (needed %d), shall you increase "

771 "SCST_SENSE_BUFFERSIZE? Op: %x", 
Ën
, 
cmd
->
cdb
[0]);

772 
cmd
->
£n£_v®id_Ën
 = cmd->
£n£_buæ’
;

775 
	`memýy
(
cmd
->
£n£
, s’£, cmd->
£n£_v®id_Ën
);

776 
	`TRACE_BUFFER
("S’£ s‘", 
cmd
->
£n£
, cmd->
£n£_v®id_Ën
);

778 
out
:

779 
	`TRACE_EXIT_RES
(
»s
);

780  
»s
;

781 
	}
}

782 
EXPORT_SYMBOL
(
sc¡_®loc_£t_£n£
);

793 
	$sc¡_£t_cmd_”rÜ_¡©us
(
sc¡_cmd
 *
cmd
, 
¡©us
)

795 
»s
 = 0;

797 
	`TRACE_ENTRY
();

799 ià(
¡©us
 =ð
SAM_STAT_RESERVATION_CONFLICT
) {

800 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR
, "Reservation conflict (dev %s, "

802 
cmd
->
dev
 ? cmd->dev->
vœt_Çme
 : 
NULL
,

803 
cmd
->
£ss
->
š™ŸtÜ_Çme
, cmd->
tgt
->
»l_tgt_id
);

806 ià(
cmd
->
¡©us
 != 0) {

807 
	`TRACE_MGMT_DBG
("cmd %°®»ady ha ¡©u %x s‘", 
cmd
,

808 
cmd
->
¡©us
);

809 
»s
 = -
EEXIST
;

810 
out
;

813 
cmd
->
¡©us
 = status;

814 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

816 
cmd
->
dbl_ua_Üig_»¥_d©a_Ën
 = cmd->
»¥_d©a_Ën
;

817 
cmd
->
dbl_ua_Üig_d©a_dœeùiÚ
 = cmd->
d©a_dœeùiÚ
;

819 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

820 
cmd
->
»¥_d©a_Ën
 = 0;

821 
cmd
->
»sid_possibË
 = 1;

822 
cmd
->
is_£nd_¡©us
 = 1;

824 
cmd
->
com¶‘ed
 = 1;

826 
out
:

827 
	`TRACE_EXIT_RES
(
»s
);

828  
»s
;

829 
	}
}

830 
EXPORT_SYMBOL
(
sc¡_£t_cmd_”rÜ_¡©us
);

832 
	$sc¡_£t_lun_nÙ_suµÜ‹d_»que¡_£n£
(
sc¡_cmd
 *
cmd
,

833 
key
, 
asc
, 
ascq
)

835 
»s
;

836 
£n£_Ën
, 
Ën
;

837 
sÿ‰”li¡
 *
sg
;

839 
	`TRACE_ENTRY
();

841 ià(
cmd
->
¡©us
 != 0) {

842 
	`TRACE_MGMT_DBG
("cmd %°®»ady ha ¡©u %x s‘", 
cmd
,

843 
cmd
->
¡©us
);

844 
»s
 = -
EEXIST
;

845 
out
;

848 ià((
cmd
->
sg
 !ð
NULL
è&& 
	`SCST_SENSE_VALID
(
	`sg_vœt
(cmd->sg))) {

849 
	`TRACE_MGMT_DBG
("cmd %°®»ady ha £n£ s‘", 
cmd
);

850 
»s
 = -
EEXIST
;

851 
out
;

854 ià(
cmd
->
sg
 =ð
NULL
) {

860 ià(
cmd
->
tgt_d©a_buf_®loûd
 && (cmd->
tgt_sg
 !ð
NULL
)) {

861 
cmd
->
sg
 = cmd->
tgt_sg
;

862 
cmd
->
sg_út
 = cmd->
tgt_sg_út
;

863 
	`TRACE_MEM
("Tgˆsg u£d fÜ s’£ fÜ cmd %p", 
cmd
);

864 
go
;

867 ià(
cmd
->
bufæ’
 == 0)

868 
cmd
->
bufæ’
 = cmd->
cdb
[4];

870 
cmd
->
sg
 = 
	`sc¡_®loc
(cmd->
bufæ’
, 
GFP_ATOMIC
, &cmd->
sg_út
);

871 ià(
cmd
->
sg
 =ð
NULL
) {

872 
	`PRINT_ERROR
("Unableo‡lloc sg for REQUEST SENSE"

873 "(£n£ %x/%x/%x)", 
key
, 
asc
, 
ascq
);

874 
»s
 = 1;

875 
out
;

878 
	`TRACE_MEM
("sg %p‡lloced for sense for cmd %p (cnt %d, "

879 "ËÀ%d)", 
cmd
->
sg
, cmd, cmd->
sg_út
, cmd->
bufæ’
);

882 
go
:

883 
sg
 = 
cmd
->sg;

884 
Ën
 = 
sg
->
Ëngth
;

886 
	`TRACE_MEM
("sg %°Ö’ %dèfÜ s’£ fÜ cmd %p", 
sg
, 
Ën
, 
cmd
);

888 
£n£_Ën
 = 
	`sc¡_£t_£n£
(
	`sg_vœt
(
sg
), 
Ën
, 
cmd
->
cdb
[1] & 1,

889 
key
, 
asc
, 
ascq
);

891 
	`TRACE_BUFFER
("S’£ s‘", 
	`sg_vœt
(
sg
), 
£n£_Ën
);

893 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_READ
;

894 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
£n£_Ën
);

896 
»s
 = 0;

897 
cmd
->
com¶‘ed
 = 1;

898 
cmd
->
»sid_possibË
 = 1;

900 
out
:

901 
	`TRACE_EXIT_RES
(
»s
);

902  
»s
;

903 
	}
}

905 
	$sc¡_£t_lun_nÙ_suµÜ‹d_šquœy
(
sc¡_cmd
 *
cmd
)

907 
»s
;

908 
ušt8_t
 *
buf
;

909 
sÿ‰”li¡
 *
sg
;

910 
Ën
;

912 
	`TRACE_ENTRY
();

914 ià(
cmd
->
¡©us
 != 0) {

915 
	`TRACE_MGMT_DBG
("cmd %°®»ady ha ¡©u %x s‘", 
cmd
,

916 
cmd
->
¡©us
);

917 
»s
 = -
EEXIST
;

918 
out
;

921 ià(
cmd
->
sg
 =ð
NULL
) {

927 ià(
cmd
->
tgt_d©a_buf_®loûd
 && (cmd->
tgt_sg
 !ð
NULL
)) {

928 
cmd
->
sg
 = cmd->
tgt_sg
;

929 
cmd
->
sg_út
 = cmd->
tgt_sg_út
;

930 
	`TRACE_MEM
("Tgt used for INQUIRY for‚ot supported "

931 "LUN fÜ cmd %p", 
cmd
);

932 
go
;

935 ià(
cmd
->
bufæ’
 == 0)

936 
cmd
->
bufæ’
 = 
	`mš_t
(, 36, (cmd->
cdb
[3] << 8) | cmd->cdb[4]);

938 
cmd
->
sg
 = 
	`sc¡_®loc
(cmd->
bufæ’
, 
GFP_ATOMIC
, &cmd->
sg_út
);

939 ià(
cmd
->
sg
 =ð
NULL
) {

940 
	`PRINT_ERROR
("%s", "Unableo‡lloc sg for INQUIRY "

942 
»s
 = 1;

943 
out
;

946 
	`TRACE_MEM
("sg %p‡lloced for INQUIRY for‚ot supported LUN for "

947 "cmd %°(úˆ%d,†’ %d)", 
cmd
->
sg
, cmd, cmd->
sg_út
,

948 
cmd
->
bufæ’
);

951 
go
:

952 
sg
 = 
cmd
->sg;

953 
Ën
 = 
sg
->
Ëngth
;

955 
	`TRACE_MEM
("sg %°Ö’ %dèfÜ INQUIRY fÜ cmd %p", 
sg
, 
Ën
, 
cmd
);

957 
buf
 = 
	`sg_vœt
(
sg
);

958 
Ën
 = 
	`mš_t
(, 36,†en);

960 
	`mem£t
(
buf
, 0, 
Ën
);

961 
buf
[0] = 0x7F;

962 
buf
[4] = 
Ën
 - 4;

964 
	`TRACE_BUFFER
("INQUIRY fÜ‚Ù suµÜ‹d LUN s‘", 
buf
, 
Ën
);

966 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_READ
;

967 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
Ën
);

969 
»s
 = 0;

970 
cmd
->
com¶‘ed
 = 1;

971 
cmd
->
»sid_possibË
 = 1;

973 
out
:

974 
	`TRACE_EXIT_RES
(
»s
);

975  
»s
;

976 
	}
}

984 
	$sc¡_£t_cmd_”rÜ
(
sc¡_cmd
 *
cmd
, 
key
, 
asc
, 
ascq
)

986 
»s
;

988 
	`TRACE_ENTRY
();

994 ià((
key
 =ð
ILLEGAL_REQUEST
è&& (
asc
 =ð0x25è&& (
ascq
 == 0)) {

995 ià(
cmd
->
cdb
[0] =ð
REQUEST_SENSE
)

996 
»s
 = 
	`sc¡_£t_lun_nÙ_suµÜ‹d_»que¡_£n£
(
cmd
,

997 
key
, 
asc
, 
ascq
);

998 ià(
cmd
->
cdb
[0] =ð
INQUIRY
)

999 
»s
 = 
	`sc¡_£t_lun_nÙ_suµÜ‹d_šquœy
(
cmd
);

1001 
do_£n£
;

1003 ià(
»s
 > 0)

1004 
do_£n£
;

1006 
out
;

1009 
do_£n£
:

1010 
»s
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_CHECK_CONDITION
);

1011 ià(
»s
 != 0)

1012 
out
;

1014 
»s
 = 
	`sc¡_®loc_£n£
(
cmd
, 1);

1015 ià(
»s
 != 0) {

1016 
	`PRINT_ERROR
("Lost sense data (key %x,‡sc %x,‡scq %x)",

1017 
key
, 
asc
, 
ascq
);

1018 
out
;

1021 
cmd
->
£n£_v®id_Ën
 = 
	`sc¡_£t_£n£
(cmd->
£n£
, cmd->
£n£_buæ’
,

1022 
	`sc¡_g‘_cmd_dev_d_£n£
(
cmd
), 
key
, 
asc
, 
ascq
);

1023 
	`TRACE_BUFFER
("S’£ s‘", 
cmd
->
£n£
, cmd->
£n£_v®id_Ën
);

1025 
out
:

1026 
	`TRACE_EXIT_RES
(
»s
);

1027  
»s
;

1028 
	}
}

1029 
EXPORT_SYMBOL
(
sc¡_£t_cmd_”rÜ
);

1037 
	$sc¡_£t_£n£
(
ušt8_t
 *
bufãr
, 
Ën
, 
boÞ
 
d_£n£
,

1038 
key
, 
asc
, 
ascq
)

1040 
»s
;

1042 
	`sBUG_ON
(
Ën
 == 0);

1044 
	`mem£t
(
bufãr
, 0, 
Ën
);

1046 ià(
d_£n£
) {

1048 ià(
Ën
 < 8) {

1049 
	`PRINT_ERROR
("Length %d of sense bufferoo smallo "

1050 "f™ s’£ %x:%x:%x", 
Ën
, 
key
, 
asc
, 
ascq
);

1053 
bufãr
[0] = 0x72;

1054 ià(
Ën
 > 1)

1055 
bufãr
[1] = 
key
;

1056 ià(
Ën
 > 2)

1057 
bufãr
[2] = 
asc
;

1058 ià(
Ën
 > 3)

1059 
bufãr
[3] = 
ascq
;

1060 
»s
 = 8;

1063 ià(
Ën
 < 18) {

1064 
	`PRINT_ERROR
("Length %d of sense bufferoo smallo "

1065 "f™ s’£ %x:%x:%x", 
Ën
, 
key
, 
asc
, 
ascq
);

1068 
bufãr
[0] = 0x70;

1069 ià(
Ën
 > 2)

1070 
bufãr
[2] = 
key
;

1071 ià(
Ën
 > 7)

1072 
bufãr
[7] = 0x0a;

1073 ià(
Ën
 > 12)

1074 
bufãr
[12] = 
asc
;

1075 ià(
Ën
 > 13)

1076 
bufãr
[13] = 
ascq
;

1077 
»s
 = 18;

1080 
	`TRACE_BUFFER
("S’£ s‘", 
bufãr
, 
»s
);

1081  
»s
;

1082 
	}
}

1083 
EXPORT_SYMBOL
(
sc¡_£t_£n£
);

1092 
boÞ
 
	$sc¡_ª®yze_£n£
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
, 
v®id_mask
,

1093 
key
, 
asc
, 
ascq
)

1095 
boÞ
 
»s
 = 
çl£
;

1098 ià((
£n£
[0] == 0x70) || (sense[0] == 0x71)) {

1102 ià(
v®id_mask
 & 
SCST_SENSE_KEY_VALID
) {

1103 ià(
Ën
 < 3)

1104 
out
;

1105 ià(
£n£
[2] !ð
key
)

1106 
out
;

1110 ià(
v®id_mask
 & 
SCST_SENSE_ASC_VALID
) {

1111 ià(
Ën
 < 13)

1112 
out
;

1113 ià(
£n£
[12] !ð
asc
)

1114 
out
;

1118 ià(
v®id_mask
 & 
SCST_SENSE_ASCQ_VALID
) {

1119 ià(
Ën
 < 14)

1120 
out
;

1121 ià(
£n£
[13] !ð
ascq
)

1122 
out
;

1124 } ià((
£n£
[0] == 0x72) || (sense[0] == 0x73)) {

1128 ià(
v®id_mask
 & 
SCST_SENSE_KEY_VALID
) {

1129 ià(
Ën
 < 2)

1130 
out
;

1131 ià(
£n£
[1] !ð
key
)

1132 
out
;

1136 ià(
v®id_mask
 & 
SCST_SENSE_ASC_VALID
) {

1137 ià(
Ën
 < 3)

1138 
out
;

1139 ià(
£n£
[2] !ð
asc
)

1140 
out
;

1144 ià(
v®id_mask
 & 
SCST_SENSE_ASCQ_VALID
) {

1145 ià(
Ën
 < 4)

1146 
out
;

1147 ià(
£n£
[3] !ð
ascq
)

1148 
out
;

1151 
out
;

1153 
»s
 = 
Œue
;

1155 
out
:

1156 
	`TRACE_EXIT_RES
(()
»s
);

1157  
»s
;

1158 
	}
}

1159 
EXPORT_SYMBOL
(
sc¡_ª®yze_£n£
);

1167 
boÞ
 
	$sc¡_is_ua_£n£
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
)

1169 ià(
	`SCST_SENSE_VALID
(
£n£
))

1170  
	`sc¡_ª®yze_£n£
(
£n£
, 
Ën
,

1171 
SCST_SENSE_KEY_VALID
, 
UNIT_ATTENTION
, 0, 0);

1173  
çl£
;

1174 
	}
}

1175 
EXPORT_SYMBOL
(
sc¡_is_ua_£n£
);

1177 
boÞ
 
	$sc¡_is_ua_glob®
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
)

1179 
boÞ
 
»s
;

1183 ià(
	`sc¡_ª®yze_£n£
(
£n£
, 
Ën
, 
SCST_SENSE_ALL_VALID
,

1184 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
)))

1185 
»s
 = 
Œue
;

1187 
»s
 = 
çl£
;

1189  
»s
;

1190 
	}
}

1198 
	$sc¡_check_cÚv”t_£n£
(
sc¡_cmd
 *
cmd
)

1200 
boÞ
 
d_£n£
;

1202 
	`TRACE_ENTRY
();

1204 ià((
cmd
->
£n£
 =ð
NULL
è|| (cmd->
¡©us
 !ð
SAM_STAT_CHECK_CONDITION
))

1205 
out
;

1207 
d_£n£
 = 
	`sc¡_g‘_cmd_dev_d_£n£
(
cmd
);

1208 ià(
d_£n£
 && ((
cmd
->
£n£
[0] == 0x70) || (cmd->sense[0] == 0x71))) {

1209 
	`TRACE_MGMT_DBG
("Converting fixed senseo descriptor (cmd %p)",

1210 
cmd
);

1211 ià((
cmd
->
£n£_v®id_Ën
 < 18)) {

1212 
	`PRINT_ERROR
("Senseoo smallo convert (%d, "

1213 "ty³: fixed)", 
cmd
->
£n£_buæ’
);

1214 
out
;

1216 
cmd
->
£n£_v®id_Ën
 = 
	`sc¡_£t_£n£
(cmd->
£n£
, cmd->
£n£_buæ’
,

1217 
d_£n£
, 
cmd
->
£n£
[2], cmd->sense[12], cmd->sense[13]);

1218 } ià(!
d_£n£
 && ((
cmd
->
£n£
[0] == 0x72) ||

1219 (
cmd
->
£n£
[0] == 0x73))) {

1220 
	`TRACE_MGMT_DBG
("Converting descriptor senseo fixed (cmd %p)",

1221 
cmd
);

1222 ià((
cmd
->
£n£_buæ’
 < 18è|| (cmd->
£n£_v®id_Ën
 < 8)) {

1223 
	`PRINT_ERROR
("Senseoo smallo convert (%d, "

1225 
cmd
->
£n£_buæ’
, cmd->
£n£_v®id_Ën
);

1226 
out
;

1228 
cmd
->
£n£_v®id_Ën
 = 
	`sc¡_£t_£n£
(cmd->
£n£
,

1229 
cmd
->
£n£_buæ’
, 
d_£n£
,

1230 
cmd
->
£n£
[1], cmd->sense[2], cmd->sense[3]);

1233 
out
:

1234 
	`TRACE_EXIT
();

1236 
	}
}

1237 
EXPORT_SYMBOL
(
sc¡_check_cÚv”t_£n£
);

1239 
	$sc¡_£t_cmd_”rÜ_£n£
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
£n£
,

1240 
Ën
)

1242 
»s
;

1244 
	`TRACE_ENTRY
();

1246 
»s
 = 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_CHECK_CONDITION
);

1247 ià(
»s
 != 0)

1248 
out
;

1250 
»s
 = 
	`sc¡_®loc_£t_£n£
(
cmd
, 1, 
£n£
, 
Ën
);

1252 
out
:

1253 
	`TRACE_EXIT_RES
(
»s
);

1254  
»s
;

1255 
	}
}

1263 
	$sc¡_£t_busy
(
sc¡_cmd
 *
cmd
)

1265 
c
 = 
	`©omic_»ad
(&
cmd
->
£ss
->
£ss_cmd_couÁ
);

1267 
	`TRACE_ENTRY
();

1269 ià((
c
 <ð1è|| (
cmd
->
£ss
->
š™_pha£
 !ð
SCST_SESS_IPH_READY
)) {

1270 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_BUSY
);

1271 
	`TRACE
(
TRACE_FLOW_CONTROL
, "Sending BUSY statuso initiator %s "

1273 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
c
,

1274 
cmd
->
queue_ty³
, cmd->
£ss
->
š™_pha£
);

1276 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_TASK_SET_FULL
);

1277 
	`TRACE
(
TRACE_FLOW_CONTROL
, "Sending QUEUE_FULL statuso "

1279 "£ss->š™_pha£ %d)", 
cmd
->
£ss
->
š™ŸtÜ_Çme
, 
c
,

1280 
cmd
->
queue_ty³
, cmd->
£ss
->
š™_pha£
);

1283 
	`TRACE_EXIT
();

1285 
	}
}

1286 
EXPORT_SYMBOL
(
sc¡_£t_busy
);

1294 
	$sc¡_£t_š™Ÿl_UA
(
sc¡_£ssiÚ
 *
£ss
, 
key
, 
asc
, 
ascq
)

1296 
i
;

1298 
	`TRACE_ENTRY
();

1300 
	`TRACE_MGMT_DBG
("S‘tšg fÜ ses %°š™ŸÈUA %x/%x/%x", 
£ss
, 
key
,

1301 
asc
, 
ascq
);

1304 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1306 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1307 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

1308 
sc¡_tgt_dev
 *
tgt_dev
;

1310 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

1311 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

1312 ià(!
	`li¡_em±y
(&
tgt_dev
->
UA_li¡
)) {

1313 
sc¡_tgt_dev_UA
 *
ua
;

1315 
ua
 = 
	`li¡_’Œy
(
tgt_dev
->
UA_li¡
.
Ãxt
,

1316 
	`ty³of
(*
ua
), 
UA_li¡_’Œy
);

1317 ià(
	`sc¡_ª®yze_£n£
(
ua
->
UA_£n£_bufãr
,

1318 
ua
->
UA_v®id_£n£_Ën
,

1319 
SCST_SENSE_ALL_VALID
,

1320 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
))) {

1321 
ua
->
UA_v®id_£n£_Ën
 = 
	`sc¡_£t_£n£
(

1322 
ua
->
UA_£n£_bufãr
,

1323 (
ua
->
UA_£n£_bufãr
),

1324 
tgt_dev
->
dev
->
d_£n£
,

1325 
key
, 
asc
, 
ascq
);

1327 
	`PRINT_ERROR
("%s",

1330 
	`PRINT_ERROR
("%s", "There's‚o RESET UAo "

1332 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

1336 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1338 
	`TRACE_EXIT
();

1340 
	}
}

1341 
EXPORT_SYMBOL
(
sc¡_£t_š™Ÿl_UA
);

1343 
sc¡_«n
 *
	$sc¡_®loc_«n
(
sc¡_£ssiÚ
 *
£ss
,

1344 
ušt64_t
 
uÅacked_lun
)

1346 
sc¡_«n
 *
«n
;

1348 
	`TRACE_ENTRY
();

1350 
«n
 = 
	`mempoÞ_®loc
(
sc¡_«n_mempoÞ
, 
GFP_KERNEL
);

1351 ià(
«n
 =ð
NULL
) {

1352 
	`PRINT_ERROR
("AEN memory‡llocation failed. Corresponding "

1354 "%s)", 
£ss
->
š™ŸtÜ_Çme
);

1355 
out
;

1357 
	`mem£t
(
«n
, 0, (*aen));

1359 
«n
->
£ss
 = sess;

1360 
	`sc¡_£ss_g‘
(
£ss
);

1362 
«n
->
lun
 = 
	`sc¡_·ck_lun
(
uÅacked_lun
, 
£ss
->
acg
->
addr_m‘hod
);

1364 
out
:

1365 
	`TRACE_EXIT_HRES
(()
«n
);

1366  
«n
;

1367 
	}
}

1369 
	$sc¡_ä“_«n
(
sc¡_«n
 *
«n
)

1371 
	`TRACE_ENTRY
();

1373 
	`sc¡_£ss_put
(
«n
->
£ss
);

1374 
	`mempoÞ_ä“
(
«n
, 
sc¡_«n_mempoÞ
);

1376 
	`TRACE_EXIT
();

1378 
	}
}

1381 
	$sc¡_g’_«n_Ü_ua
(
sc¡_tgt_dev
 *
tgt_dev
,

1382 
key
, 
asc
, 
ascq
)

1384 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
tgt_dev
->
£ss
->
tgt
->tgtt;

1385 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

1386 
¦
;

1388 
	`TRACE_ENTRY
();

1390 ià((
tgt_dev
->
£ss
->
š™_pha£
 !ð
SCST_SESS_IPH_READY
) ||

1391 (
tgt_dev
->
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
))

1392 
out
;

1394 ià(
tg‰
->
»pÜt_«n
 !ð
NULL
) {

1395 
sc¡_«n
 *
«n
;

1396 
rc
;

1398 
«n
 = 
	`sc¡_®loc_«n
(
tgt_dev
->
£ss
,gt_dev->
lun
);

1399 ià(
«n
 =ð
NULL
)

1400 
queue_ua
;

1402 
«n
->
ev’t_â
 = 
SCST_AEN_SCSI
;

1403 
«n
->
«n_£n£_Ën
 = 
	`sc¡_£t_£n£
×’->
«n_£n£
,

1404 (
«n
->
«n_£n£
), 
tgt_dev
->
dev
->
d_£n£
,

1405 
key
, 
asc
, 
ascq
);

1407 
	`TRACE_DBG
("Callingarget's %s„eport_aen(%p)",

1408 
tg‰
->
Çme
, 
«n
);

1409 
rc
 = 
tg‰
->
	`»pÜt_«n
(
«n
);

1410 
	`TRACE_DBG
("Target's %s„eport_aen(%p)„eturned %d",

1411 
tg‰
->
Çme
, 
«n
, 
rc
);

1412 ià(
rc
 =ð
SCST_AEN_RES_SUCCESS
)

1413 
out
;

1415 
	`sc¡_ä“_«n
(
«n
);

1418 
queue_ua
:

1419 
	`TRACE_MGMT_DBG
("AEN‚ot supported, queueing…lain UA (tgt_dev %p)",

1420 
tgt_dev
);

1421 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

1422 
tgt_dev
->
dev
->
d_£n£
, 
key
, 
asc
, 
ascq
);

1423 
	`sc¡_check_£t_UA
(
tgt_dev
, 
£n£_bufãr
, 
¦
, 0);

1425 
out
:

1426 
	`TRACE_EXIT
();

1428 
	}
}

1435 
	$sc¡_ÿ·c™y_d©a_chªged
(
sc¡_deviû
 *
dev
)

1437 
sc¡_tgt_dev
 *
tgt_dev
;

1439 
	`TRACE_ENTRY
();

1441 ià(
dev
->
ty³
 !ð
TYPE_DISK
) {

1442 
	`TRACE_MGMT_DBG
("Deviceype %d isn't for CAPACITY DATA "

1443 "CHANGED UA", 
dev
->
ty³
);

1444 
out
;

1447 
	`TRACE_MGMT_DBG
("CAPACITY DATA CHANGED (dev %p)", 
dev
);

1449 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1451 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1452 
dev_tgt_dev_li¡_’Œy
) {

1453 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

1454 
	`SCST_LOAD_SENSE
(
sc¡_£n£_ÿ·c™y_d©a_chªged
));

1457 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1459 
out
:

1460 
	`TRACE_EXIT
();

1462 
	}
}

1463 
EXPORT_SYMBOL_GPL
(
sc¡_ÿ·c™y_d©a_chªged
);

1465 
šlše
 
boÞ
 
	$sc¡_is_»pÜt_luns_chªged_ty³
(
ty³
)

1467 
ty³
) {

1468 
TYPE_DISK
:

1469 
TYPE_TAPE
:

1470 
TYPE_PRINTER
:

1471 
TYPE_PROCESSOR
:

1472 
TYPE_WORM
:

1473 
TYPE_ROM
:

1474 
TYPE_SCANNER
:

1475 
TYPE_MOD
:

1476 
TYPE_MEDIUM_CHANGER
:

1477 
TYPE_RAID
:

1478 
TYPE_ENCLOSURE
:

1479  
Œue
;

1481  
çl£
;

1483 
	}
}

1486 
	$sc¡_queue_»pÜt_luns_chªged_UA
(
sc¡_£ssiÚ
 *
£ss
,

1487 
æags
)

1489 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

1490 
li¡_h—d
 *
h—d
;

1491 
sc¡_tgt_dev
 *
tgt_dev
;

1492 
i
;

1494 
	`TRACE_ENTRY
();

1496 
	`TRACE_MGMT_DBG
("Queueing REPORTED LUNS DATA CHANGED UA "

1497 "(£s %p)", 
£ss
);

1499 
	`loÿl_bh_di§bË
();

1501 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1502 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

1504 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

1505 
£ss_tgt_dev_li¡_’Œy
) {

1507 
	`¥š_lock
(&
tgt_dev
->
tgt_dev_lock
);

1511 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1512 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

1514 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

1515 
¦
;

1517 ià(!
	`sc¡_is_»pÜt_luns_chªged_ty³
(

1518 
tgt_dev
->
dev
->
ty³
))

1521 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

1522 
tgt_dev
->
dev
->
d_£n£
,

1523 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
));

1525 
	`__sc¡_check_£t_UA
(
tgt_dev
, 
£n£_bufãr
,

1526 
¦
, 
æags
 | 
SCST_SET_UA_FLAG_GLOBAL
);

1530 
i
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; i >= 0; i--) {

1531 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

1533 
	`li¡_fÜ_—ch_’Œy_»v”£
(
tgt_dev
, 
h—d
,

1534 
£ss_tgt_dev_li¡_’Œy
) {

1535 
	`¥š_uÆock
(&
tgt_dev
->
tgt_dev_lock
);

1539 
	`loÿl_bh_’abË
();

1541 
	`TRACE_EXIT
();

1543 
	}
}

1546 
	$sc¡_»pÜt_luns_chªged_£ss
(
sc¡_£ssiÚ
 *
£ss
)

1548 
i
;

1549 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
£ss
->
tgt
->tgtt;

1550 
d_£n£
 = 0;

1551 
ušt64_t
 
lun
 = 0;

1553 
	`TRACE_ENTRY
();

1555 ià((
£ss
->
š™_pha£
 !ð
SCST_SESS_IPH_READY
) ||

1556 (
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
))

1557 
out
;

1559 
	`TRACE_DBG
("REPORTED LUNS DATA CHANGED (£s %p)", 
£ss
);

1561 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1562 
li¡_h—d
 *
h—d
;

1563 
sc¡_tgt_dev
 *
tgt_dev
;

1565 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

1567 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

1568 
£ss_tgt_dev_li¡_’Œy
) {

1569 ià(
	`sc¡_is_»pÜt_luns_chªged_ty³
(

1570 
tgt_dev
->
dev
->
ty³
)) {

1571 
lun
 = 
tgt_dev
->lun;

1572 
d_£n£
 = 
tgt_dev
->
dev
->d_sense;

1573 
found
;

1578 
found
:

1579 ià(
tg‰
->
»pÜt_«n
 !ð
NULL
) {

1580 
sc¡_«n
 *
«n
;

1581 
rc
;

1583 
«n
 = 
	`sc¡_®loc_«n
(
£ss
, 
lun
);

1584 ià(
«n
 =ð
NULL
)

1585 
queue_ua
;

1587 
«n
->
ev’t_â
 = 
SCST_AEN_SCSI
;

1588 
«n
->
«n_£n£_Ën
 = 
	`sc¡_£t_£n£
×’->
«n_£n£
,

1589 (
«n
->
«n_£n£
), 
d_£n£
,

1590 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
));

1592 
	`TRACE_DBG
("Callingarget's %s„eport_aen(%p)",

1593 
tg‰
->
Çme
, 
«n
);

1594 
rc
 = 
tg‰
->
	`»pÜt_«n
(
«n
);

1595 
	`TRACE_DBG
("Target's %s„eport_aen(%p)„eturned %d",

1596 
tg‰
->
Çme
, 
«n
, 
rc
);

1597 ià(
rc
 =ð
SCST_AEN_RES_SUCCESS
)

1598 
out
;

1600 
	`sc¡_ä“_«n
(
«n
);

1603 
queue_ua
:

1604 
	`sc¡_queue_»pÜt_luns_chªged_UA
(
£ss
, 0);

1606 
out
:

1607 
	`TRACE_EXIT
();

1609 
	}
}

1612 
	$sc¡_»pÜt_luns_chªged
(
sc¡_acg
 *
acg
)

1614 
sc¡_£ssiÚ
 *
£ss
;

1616 
	`TRACE_ENTRY
();

1618 
	`TRACE_MGMT_DBG
("REPORTED LUNS DATA CHANGED (acg %s)", 
acg
->
acg_Çme
);

1620 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
, 
acg_£ss_li¡_’Œy
) {

1621 
	`sc¡_»pÜt_luns_chªged_£ss
(
£ss
);

1624 
	`TRACE_EXIT
();

1626 
	}
}

1636 
	$sc¡_«n_dÚe
(
sc¡_«n
 *
«n
)

1638 
	`TRACE_ENTRY
();

1640 
	`TRACE_MGMT_DBG
("AEN %°(â %dèdÚ(š™ŸtÜ %s)", 
«n
,

1641 
«n
->
ev’t_â
,‡’->
£ss
->
š™ŸtÜ_Çme
);

1643 ià(
«n
->
d–iv”y_¡©us
 =ð
SCST_AEN_RES_SUCCESS
)

1644 
out_ä“
;

1646 ià(
«n
->
ev’t_â
 !ð
SCST_AEN_SCSI
)

1647 
out_ä“
;

1649 
	`TRACE_MGMT_DBG
("Delivery of SCSI AEN failed (initiator %s)",

1650 
«n
->
£ss
->
š™ŸtÜ_Çme
);

1652 ià(
	`sc¡_ª®yze_£n£
(
«n
->
«n_£n£
,‡’->
«n_£n£_Ën
,

1653 
SCST_SENSE_ALL_VALID
, 
	`SCST_LOAD_SENSE
(

1654 
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
))) {

1655 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1656 
	`sc¡_queue_»pÜt_luns_chªged_UA
(
«n
->
£ss
,

1657 
SCST_SET_UA_FLAG_AT_HEAD
);

1658 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1660 
li¡_h—d
 *
h—d
;

1661 
sc¡_tgt_dev
 *
tgt_dev
;

1662 
ušt64_t
 
lun
;

1664 
lun
 = 
	`sc¡_uÅack_lun
((
ušt8_t
 *)&
«n
->lun, (aen->lun));

1666 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1669 
h—d
 = &
«n
->
£ss
->
£ss_tgt_dev_li¡
[
	`SESS_TGT_DEV_LIST_HASH_FN
(
lun
)];

1670 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

1671 
£ss_tgt_dev_li¡_’Œy
) {

1672 ià(
tgt_dev
->
lun
 ==†un) {

1673 
	`TRACE_MGMT_DBG
("Requeuing failed AEN UA for "

1674 "tgt_dev %p", 
tgt_dev
);

1675 
	`sc¡_check_£t_UA
(
tgt_dev
, 
«n
->
«n_£n£
,

1676 
«n
->
«n_£n£_Ën
,

1677 
SCST_SET_UA_FLAG_AT_HEAD
);

1682 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1685 
out_ä“
:

1686 
	`sc¡_ä“_«n
(
«n
);

1688 
	`TRACE_EXIT
();

1690 
	}
}

1691 
EXPORT_SYMBOL
(
sc¡_«n_dÚe
);

1693 
	$sc¡_»queue_ua
(
sc¡_cmd
 *
cmd
)

1695 
	`TRACE_ENTRY
();

1697 ià(
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

1698 
SCST_SENSE_ALL_VALID
,

1699 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
))) {

1700 
	`TRACE_MGMT_DBG
("Requeuing REPORTED LUNS DATA CHANGED UA "

1701 "fÜ d–iv”y fažed cmd %p", 
cmd
);

1702 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1703 
	`sc¡_queue_»pÜt_luns_chªged_UA
(
cmd
->
£ss
,

1704 
SCST_SET_UA_FLAG_AT_HEAD
);

1705 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1707 
	`TRACE_MGMT_DBG
("Requeušg UA fÜ d–iv”y fažed cmd %p", 
cmd
);

1708 
	`sc¡_check_£t_UA
(
cmd
->
tgt_dev
, cmd->
£n£
,

1709 
cmd
->
£n£_v®id_Ën
, 
SCST_SET_UA_FLAG_AT_HEAD
);

1712 
	`TRACE_EXIT
();

1714 
	}
}

1717 
	$sc¡_check_»assign_£ss
(
sc¡_£ssiÚ
 *
£ss
)

1719 
sc¡_acg
 *
acg
, *
Þd_acg
;

1720 
sc¡_acg_dev
 *
acg_dev
;

1721 
i
, 
rc
;

1722 
li¡_h—d
 *
h—d
;

1723 
sc¡_tgt_dev
 *
tgt_dev
;

1724 
boÞ
 
luns_chªged
 = 
çl£
;

1725 
boÞ
 
add_çžed
, 
som‘hšg_ä“d
, 
nÙ_Ãeded_ä“d
 = 
çl£
;

1727 
	`TRACE_ENTRY
();

1729 ià(
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
)

1730 
out
;

1732 
	`TRACE_MGMT_DBG
("Checking„eassignment for sess %p (initiator %s)",

1733 
£ss
, sess->
š™ŸtÜ_Çme
);

1735 
acg
 = 
	`sc¡_fšd_acg
(
£ss
);

1736 ià(
acg
 =ð
£ss
->acg) {

1737 
	`TRACE_MGMT_DBG
("NØ»assignm’ˆfÜ ses %p", 
£ss
);

1738 
out
;

1741 
	`TRACE_MGMT_DBG
("sess %p will be„eassigned from‡cg %so‡cg %s",

1742 
£ss
, sess->
acg
->
acg_Çme
,‡cg->acg_name);

1744 
Þd_acg
 = 
£ss
->
acg
;

1745 
£ss
->
acg
 = 
NULL
;

1747 
»Œy_add
:

1748 
add_çžed
 = 
çl£
;

1749 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

1750 
šq_chªged_ua_Ãeded
 = 0;

1752 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1753 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

1755 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

1756 
£ss_tgt_dev_li¡_’Œy
) {

1757 ià((
tgt_dev
->
dev
 =ð
acg_dev
->dev) &&

1758 (
tgt_dev
->
lun
 =ð
acg_dev
->lun) &&

1759 (
tgt_dev
->
acg_dev
->
rd_Úly
 ==‡cg_dev->rd_only)) {

1760 
	`TRACE_MGMT_DBG
("sess %p:gt_dev %p for "

1762 
£ss
, 
tgt_dev
,

1763 ()
tgt_dev
->
lun
);

1764 
tgt_dev
->
acg_dev
 =‡cg_dev;

1765 
Ãxt
;

1766 } ià(
tgt_dev
->
lun
 =ð
acg_dev
->lun)

1767 
šq_chªged_ua_Ãeded
 = 1;

1771 
luns_chªged
 = 
Œue
;

1773 
	`TRACE_MGMT_DBG
("sess %p: Allocing‚ewgt_dev for LUN %lld",

1774 
£ss
, ()
acg_dev
->
lun
);

1776 
rc
 = 
	`sc¡_®loc_add_tgt_dev
(
£ss
, 
acg_dev
, &
tgt_dev
);

1777 ià(
rc
 =ð-
EPERM
)

1779 ià(
rc
 != 0) {

1780 
add_çžed
 = 
Œue
;

1784 
tgt_dev
->
šq_chªged_ua_Ãeded
 = inq_changed_ua_needed ||

1785 
nÙ_Ãeded_ä“d
;

1786 
Ãxt
:

1790 
som‘hšg_ä“d
 = 
çl£
;

1791 
nÙ_Ãeded_ä“d
 = 
Œue
;

1792 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1793 
sc¡_tgt_dev
 *
t
;

1794 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

1796 
	`li¡_fÜ_—ch_’Œy_§ã
(
tgt_dev
, 
t
, 
h—d
,

1797 
£ss_tgt_dev_li¡_’Œy
) {

1798 ià(
tgt_dev
->
acg_dev
->
acg
 !=‡cg) {

1799 
	`TRACE_MGMT_DBG
("sess %p: Deleting‚ot used "

1801 
£ss
, 
tgt_dev
,

1802 ()
tgt_dev
->
lun
);

1803 
luns_chªged
 = 
Œue
;

1804 
som‘hšg_ä“d
 = 
Œue
;

1805 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

1810 ià(
add_çžed
 && 
som‘hšg_ä“d
) {

1811 
	`TRACE_MGMT_DBG
("£s %p: R‘ryšg‡ddšg‚ewgt_devs", 
£ss
);

1812 
»Œy_add
;

1815 
£ss
->
acg
 =‡cg;

1817 
	`TRACE_DBG
("Movšg ses %°äom‡cg % tØacg %s", 
£ss
,

1818 
Þd_acg
->
acg_Çme
, 
acg
->acg_name);

1819 
	`li¡_move_ž
(&
£ss
->
acg_£ss_li¡_’Œy
, &
acg
->
acg_£ss_li¡
);

1821 #iâdeà
CONFIG_SCST_PROC


1822 
	`sc¡_»ü—‹_£ss_luns_lšk
(
£ss
);

1826 ià(
luns_chªged
) {

1827 
	`sc¡_»pÜt_luns_chªged_£ss
(
£ss
);

1829 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1830 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

1832 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

1833 
£ss_tgt_dev_li¡_’Œy
) {

1834 ià(
tgt_dev
->
šq_chªged_ua_Ãeded
) {

1835 
	`TRACE_MGMT_DBG
("sess %p: Setting "

1837 "Ñgt_dev %p)", 
£ss
, 
tgt_dev
);

1839 
tgt_dev
->
šq_chªged_ua_Ãeded
 = 0;

1841 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

1842 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šqu”y_d©a_chªged
));

1848 
out
:

1849 
	`TRACE_EXIT
();

1851 
	}
}

1854 
	$sc¡_check_»assign_£ssiÚs
()

1856 
sc¡_tgt_‹m¶©e
 *
tg‰
;

1858 
	`TRACE_ENTRY
();

1860 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

1861 
sc¡_tgt
 *
tgt
;

1862 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

1863 
sc¡_£ssiÚ
 *
£ss
;

1864 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
,

1865 
£ss_li¡_’Œy
) {

1866 
	`sc¡_check_»assign_£ss
(
£ss
);

1871 
	`TRACE_EXIT
();

1873 
	}
}

1875 
	$sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(cÚ¡ 
sc¡_cmd
 *
cmd
)

1877 
»s
;

1879 
	`TRACE_ENTRY
();

1881 
cmd
->
¡©e
) {

1882 
SCST_CMD_STATE_INIT_WAIT
:

1883 
SCST_CMD_STATE_INIT
:

1884 
SCST_CMD_STATE_PARSE
:

1885 ià(
cmd
->
´•roûssšg_Úly
) {

1886 
»s
 = 
SCST_CMD_STATE_PREPROCESSING_DONE
;

1889 
SCST_CMD_STATE_DEV_DONE
:

1890 ià(
cmd
->
š‹º®
)

1891 
»s
 = 
SCST_CMD_STATE_FINISHED_INTERNAL
;

1893 
»s
 = 
SCST_CMD_STATE_PRE_XMIT_RESP
;

1896 
SCST_CMD_STATE_PRE_DEV_DONE
:

1897 
SCST_CMD_STATE_MODE_SELECT_CHECKS
:

1898 
»s
 = 
SCST_CMD_STATE_DEV_DONE
;

1901 
SCST_CMD_STATE_PRE_XMIT_RESP
:

1902 
»s
 = 
SCST_CMD_STATE_XMIT_RESP
;

1905 
SCST_CMD_STATE_PREPROCESSING_DONE
:

1906 
SCST_CMD_STATE_PREPROCESSING_DONE_CALLED
:

1907 ià(
cmd
->
tgt_dev
 =ð
NULL
)

1908 
»s
 = 
SCST_CMD_STATE_PRE_XMIT_RESP
;

1910 
»s
 = 
SCST_CMD_STATE_PRE_DEV_DONE
;

1913 
SCST_CMD_STATE_PREPARE_SPACE
:

1914 ià(
cmd
->
´•roûssšg_Úly
) {

1915 
»s
 = 
SCST_CMD_STATE_PREPROCESSING_DONE
;

1918 
SCST_CMD_STATE_RDY_TO_XFER
:

1919 
SCST_CMD_STATE_DATA_WAIT
:

1920 
SCST_CMD_STATE_TGT_PRE_EXEC
:

1921 
SCST_CMD_STATE_START_EXEC
:

1922 
SCST_CMD_STATE_SEND_FOR_EXEC
:

1923 
SCST_CMD_STATE_LOCAL_EXEC
:

1924 
SCST_CMD_STATE_REAL_EXEC
:

1925 
SCST_CMD_STATE_REAL_EXECUTING
:

1926 
»s
 = 
SCST_CMD_STATE_PRE_DEV_DONE
;

1930 
	`PRINT_CRIT_ERROR
("Wrong cmd state %d (cmd %p, op %x)",

1931 
cmd
->
¡©e
, cmd, cmd->
cdb
[0]);

1932 
	`sBUG
();

1934 
»s
 = 
SCST_CMD_STATE_LAST_ACTIVE
;

1937 
	`TRACE_EXIT_RES
(
»s
);

1938  
»s
;

1939 
	}
}

1949 
	$sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
sc¡_cmd
 *
cmd
)

1951 
	`TRACE_ENTRY
();

1953 #ifdeà
CONFIG_SCST_EXTRACHECKS


1954 
cmd
->
¡©e
) {

1955 
SCST_CMD_STATE_XMIT_RESP
:

1956 
SCST_CMD_STATE_FINISHED
:

1957 
SCST_CMD_STATE_FINISHED_INTERNAL
:

1958 
SCST_CMD_STATE_XMIT_WAIT
:

1959 
	`PRINT_CRIT_ERROR
("Wrong cmd state %d (cmd %p, op %x)",

1960 
cmd
->
¡©e
, cmd, cmd->
cdb
[0]);

1961 
	`sBUG
();

1965 
cmd
->
¡©e
 = 
	`sc¡_g‘_cmd_abnÜm®_dÚe_¡©e
(cmd);

1967 
cmd
->
¡©e
) {

1968 
SCST_CMD_STATE_INIT_WAIT
:

1969 
SCST_CMD_STATE_INIT
:

1970 
SCST_CMD_STATE_PARSE
:

1971 
SCST_CMD_STATE_PREPROCESSING_DONE
:

1972 
SCST_CMD_STATE_PREPROCESSING_DONE_CALLED
:

1973 
SCST_CMD_STATE_PREPARE_SPACE
:

1974 
SCST_CMD_STATE_RDY_TO_XFER
:

1975 
SCST_CMD_STATE_DATA_WAIT
:

1976 
cmd
->
wr™e_Ën
 = 0;

1977 
cmd
->
»sid_possibË
 = 1;

1979 
SCST_CMD_STATE_TGT_PRE_EXEC
:

1980 
SCST_CMD_STATE_SEND_FOR_EXEC
:

1981 
SCST_CMD_STATE_START_EXEC
:

1982 
SCST_CMD_STATE_LOCAL_EXEC
:

1983 
SCST_CMD_STATE_REAL_EXEC
:

1984 
SCST_CMD_STATE_REAL_EXECUTING
:

1985 
SCST_CMD_STATE_DEV_DONE
:

1986 
SCST_CMD_STATE_PRE_DEV_DONE
:

1987 
SCST_CMD_STATE_MODE_SELECT_CHECKS
:

1988 
SCST_CMD_STATE_PRE_XMIT_RESP
:

1989 
SCST_CMD_STATE_FINISHED_INTERNAL
:

1992 
	`PRINT_CRIT_ERROR
("Wrong cmd state %d (cmd %p, op %x)",

1993 
cmd
->
¡©e
, cmd, cmd->
cdb
[0]);

1994 
	`sBUG
();

1998 #ifdeà
CONFIG_SCST_EXTRACHECKS


1999 ià(((
cmd
->
¡©e
 !ð
SCST_CMD_STATE_PRE_XMIT_RESP
) &&

2000 (
cmd
->
¡©e
 !ð
SCST_CMD_STATE_PREPROCESSING_DONE
)) &&

2001 (
cmd
->
tgt_dev
 =ð
NULL
è&& !cmd->
š‹º®
) {

2002 
	`PRINT_CRIT_ERROR
("Wrong‚ot inited cmd state %d (cmd %p, "

2003 "Ý %x)", 
cmd
->
¡©e
, cmd, cmd->
cdb
[0]);

2004 
	`sBUG
();

2008 
	`TRACE_EXIT_RES
(
cmd
->
¡©e
);

2009  
cmd
->
¡©e
;

2010 
	}
}

2011 
EXPORT_SYMBOL_GPL
(
sc¡_£t_cmd_abnÜm®_dÚe_¡©e
);

2013 
	$sc¡_z”o_wr™e_»¡
(
sc¡_cmd
 *
cmd
)

2015 
Ën
, 
offs
 = 0;

2016 
ušt8_t
 *
buf
;

2018 
	`TRACE_ENTRY
();

2020 
Ën
 = 
	`sc¡_g‘_sg_buf_fœ¡
(
cmd
, &
buf
, *cmd->
wr™e_sg
,

2021 *
cmd
->
wr™e_sg_út
);

2022 
Ën
 > 0) {

2023 
cur_offs
;

2025 ià(
offs
 + 
Ën
 <ð
cmd
->
wr™e_Ën
)

2026 
Ãxt
;

2027 ià(
offs
 >ð
cmd
->
wr™e_Ën
)

2028 
cur_offs
 = 0;

2030 
cur_offs
 = 
cmd
->
wr™e_Ën
 - 
offs
;

2032 
	`mem£t
(&
buf
[
cur_offs
], 0, 
Ën
 - cur_offs);

2034 
Ãxt
:

2035 
offs
 +ð
Ën
;

2036 
	`sc¡_put_sg_buf
(
cmd
, 
buf
, *cmd->
wr™e_sg
, *cmd->
wr™e_sg_út
);

2037 
Ën
 = 
	`sc¡_g‘_sg_buf_Ãxt
(
cmd
, &
buf
, *cmd->
wr™e_sg
,

2038 *
cmd
->
wr™e_sg_út
);

2041 
	`TRACE_EXIT
();

2043 
	}
}

2045 
	$sc¡_adju¡_sg
(
sc¡_cmd
 *
cmd
, 
sÿ‰”li¡
 *
sg
,

2046 *
sg_út
, 
adju¡_Ën
)

2048 
i
, 
j
, 
l
;

2050 
	`TRACE_ENTRY
();

2052 
l
 = 0;

2053 
i
 = 0, 
j
 = 0; i < *
sg_út
; i++, j++) {

2054 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 24)

2055 
	`TRACE_DBG
("˜%d, j %d, sg_úˆ%d, sg %p,…age_lšk %lx", 
i
, 
j
,

2056 *
sg_út
, 
sg
, sg[
j
].
·ge_lšk
);

2058 
	`TRACE_DBG
("˜%d, j %d, sg_úˆ%d, sg %p,…age_lšk %lx", 
i
, 
j
,

2059 *
sg_út
, 
sg
, 0UL);

2061 ià(
	`uÆik–y
(
	`sg_is_chaš
(&
sg
[
j
]))) {

2062 
sg
 = 
	`sg_chaš_±r
(&sg[
j
]);

2063 
j
 = 0;

2065 
l
 +ð
sg
[
j
].
Ëngth
;

2066 ià(
l
 >ð
adju¡_Ën
) {

2067 
Ëá
 = 
adju¡_Ën
 - (
l
 - 
sg
[
j
].
Ëngth
);

2068 #ifdeà
CONFIG_SCST_DEBUG


2069 
	`TRACE
(
TRACE_SG_OP
|
TRACE_MEMORY
, "cmd %p (tag %llu), "

2072 
cmd
, ()cmd->
g
,

2073 
sg
, *
sg_út
, 
adju¡_Ën
, 
i
, 
j
,

2074 
sg
[
j
].
Ëngth
, 
Ëá
);

2076 
cmd
->
Üig_sg
 = 
sg
;

2077 
cmd
->
p_Üig_sg_út
 = 
sg_út
;

2078 
cmd
->
Üig_sg_út
 = *
sg_út
;

2079 
cmd
->
Üig_sg_’Œy
 = 
j
;

2080 
cmd
->
Üig_’Œy_Ën
 = 
sg
[
j
].
Ëngth
;

2081 *
sg_út
 = (
Ëá
 > 0è? 
j
+1 : j;

2082 
sg
[
j
].
Ëngth
 = 
Ëá
;

2083 
cmd
->
sg_buff_modif›d
 = 1;

2088 
	`TRACE_EXIT
();

2090 
	}
}

2097 
	$sc¡_»¡Üe_sg_buff
(
sc¡_cmd
 *
cmd
)

2099 
	`TRACE_MEM
("cmd %p, sg %p, orig_sg_entry %d, "

2100 "Üig_’Œy_ËÀ%d, orig_sg_úˆ%d", 
cmd
, cmd->
Üig_sg
,

2101 
cmd
->
Üig_sg_’Œy
, cmd->
Üig_’Œy_Ën
,

2102 
cmd
->
Üig_sg_út
);

2103 
cmd
->
Üig_sg
[cmd->
Üig_sg_’Œy
].
Ëngth
 = cmd->
Üig_’Œy_Ën
;

2104 *
cmd
->
p_Üig_sg_út
 = cmd->
Üig_sg_út
;

2105 
cmd
->
sg_buff_modif›d
 = 0;

2106 
	}
}

2107 
EXPORT_SYMBOL
(
sc¡_»¡Üe_sg_buff
);

2117 
	$sc¡_£t_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
, 
»¥_d©a_Ën
)

2119 
	`TRACE_ENTRY
();

2121 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

2122 
cmd
->
»¥_d©a_Ën
 =„esp_data_len;

2124 ià(
»¥_d©a_Ën
 =ð
cmd
->
bufæ’
)

2125 
out
;

2127 
	`TRACE_DBG
("cmd %p,„e¥_d©a_ËÀ%d", 
cmd
, 
»¥_d©a_Ën
);

2129 
	`sc¡_adju¡_sg
(
cmd
, cmd->
sg
, &cmd->
sg_út
, 
»¥_d©a_Ën
);

2131 
cmd
->
»sid_possibË
 = 1;

2133 
out
:

2134 
	`TRACE_EXIT
();

2136 
	}
}

2137 
EXPORT_SYMBOL_GPL
(
sc¡_£t_»¥_d©a_Ën
);

2139 
	$sc¡_lim™_sg_wr™e_Ën
(
sc¡_cmd
 *
cmd
)

2141 
	`TRACE_ENTRY
();

2143 
	`TRACE_MEM
("Limiting sg write†eno %d (cmd %p, sg %p, sg_cnt %d)",

2144 
cmd
->
wr™e_Ën
, cmd, *cmd->
wr™e_sg
, *cmd->
wr™e_sg_út
);

2146 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

2147 
	`sc¡_adju¡_sg
(
cmd
, *cmd->
wr™e_sg
, cmd->
wr™e_sg_út
, cmd->
wr™e_Ën
);

2149 
	`TRACE_EXIT
();

2151 
	}
}

2153 
	$sc¡_adju¡_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
)

2155 
	`TRACE_ENTRY
();

2157 ià(!
cmd
->
ex³ùed_v®ues_£t
) {

2158 
cmd
->
adju¡ed_»¥_d©a_Ën
 = cmd->
»¥_d©a_Ën
;

2159 
out
;

2162 
cmd
->
adju¡ed_»¥_d©a_Ën
 = 
	`mš
(cmd->
»¥_d©a_Ën
,

2163 
cmd
->
ex³ùed_Œªsãr_Ën
);

2165 ià(
cmd
->
adju¡ed_»¥_d©a_Ën
 !ðcmd->
»¥_d©a_Ën
) {

2166 
	`TRACE_MEM
("Adjusting„esp_data_leno %d (cmd %p, sg %p, "

2167 "sg_úˆ%d)", 
cmd
->
adju¡ed_»¥_d©a_Ën
, cmd, cmd->
sg
,

2168 
cmd
->
sg_út
);

2169 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

2170 
	`sc¡_adju¡_sg
(
cmd
, cmd->
sg
, &cmd->
sg_út
,

2171 
cmd
->
adju¡ed_»¥_d©a_Ën
);

2174 
out
:

2175 
	`TRACE_EXIT
();

2177 
	}
}

2184 
	$sc¡_cmd_£t_wr™e_nÙ_»ûived_d©a_Ën
(
sc¡_cmd
 *
cmd
,

2185 
nÙ_»ûived
)

2187 
	`TRACE_ENTRY
();

2189 ià(!
cmd
->
ex³ùed_v®ues_£t
) {

2195 
	`TRACE_MGMT_DBG
("NØex³ùed v®ue £t, ignÜšg (cmd %p)", 
cmd
);

2196 
out
;

2199 
cmd
->
»sid_possibË
 = 1;

2201 ià((
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_READ
) &&

2202 (
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)) {

2203 
cmd
->
wr™e_Ën
 = cmd->
ex³ùed_out_Œªsãr_Ën
 - 
nÙ_»ûived
;

2204 ià(
cmd
->
wr™e_Ën
 =ðcmd->
out_bufæ’
)

2205 
out
;

2206 } ià(
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

2207 
cmd
->
wr™e_Ën
 = cmd->
ex³ùed_Œªsãr_Ën
 - 
nÙ_»ûived
;

2208 ià(
cmd
->
wr™e_Ën
 =ðcmd->
bufæ’
)

2209 
out
;

2217 
	`TRACE_DBG
("cmd %p,‚Ù_»ûived %d, wr™e_ËÀ%d", 
cmd
, 
nÙ_»ûived
,

2218 
cmd
->
wr™e_Ën
);

2220 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

2221 
	`sc¡_lim™_sg_wr™e_Ën
(
cmd
);

2223 
out
:

2224 
	`TRACE_EXIT
();

2226 
	}
}

2227 
EXPORT_SYMBOL
(
sc¡_cmd_£t_wr™e_nÙ_»ûived_d©a_Ën
);

2235 
boÞ
 
	$__sc¡_g‘_»sid
(
sc¡_cmd
 *
cmd
, *
»sid
, *
bidi_out_»sid
)

2237 
boÞ
 
»s
;

2239 
	`TRACE_ENTRY
();

2241 *
»sid
 = 0;

2242 ià(
bidi_out_»sid
 !ð
NULL
)

2243 *
bidi_out_»sid
 = 0;

2245 ià(!
cmd
->
ex³ùed_v®ues_£t
) {

2251 
	`TRACE_MGMT_DBG
("Noƒxpected values set,„eturning‚o„esidual "

2252 "(cmd %p)", 
cmd
);

2253 
»s
 = 
çl£
;

2254 
out
;

2257 ià(
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_READ
) {

2258 *
»sid
 = 
cmd
->
ex³ùed_Œªsãr_Ën
 - cmd->
»¥_d©a_Ën
;

2259 ià((
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
è&& 
bidi_out_»sid
) {

2260 ià(
cmd
->
wr™e_Ën
 < cmd->
ex³ùed_out_Œªsãr_Ën
)

2261 *
bidi_out_»sid
 = 
cmd
->
ex³ùed_out_Œªsãr_Ën
 -

2262 
cmd
->
wr™e_Ën
;

2264 *
bidi_out_»sid
 = 
cmd
->
wr™e_Ën
 - cmd->
out_bufæ’
;

2266 } ià(
cmd
->
ex³ùed_d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

2267 ià(
cmd
->
wr™e_Ën
 < cmd->
ex³ùed_Œªsãr_Ën
)

2268 *
»sid
 = 
cmd
->
ex³ùed_Œªsãr_Ën
 - cmd->
wr™e_Ën
;

2270 *
»sid
 = 
cmd
->
wr™e_Ën
 - cmd->
bufæ’
;

2273 
»s
 = 
Œue
;

2275 
	`TRACE_DBG
("cmd %p,„esid %d, bidi_out_resid %d (resp_data_len %d, "

2276 "ex³ùed_d©a_dœeùiÚ %d, wr™e_ËÀ%d, bufæ’ %d)", 
cmd
,

2277 *
»sid
, 
bidi_out_»sid
 ? *bidi_out_»sid : 0, 
cmd
->
»¥_d©a_Ën
,

2278 
cmd
->
ex³ùed_d©a_dœeùiÚ
, cmd->
wr™e_Ën
, cmd->
bufæ’
);

2280 
out
:

2281 
	`TRACE_EXIT_RES
(
»s
);

2282  
»s
;

2283 
	}
}

2284 
EXPORT_SYMBOL
(
__sc¡_g‘_»sid
);

2287 
	$sc¡_queue_»Œy_cmd
(
sc¡_cmd
 *
cmd
, 
fšished_cmds
)

2289 
sc¡_tgt
 *
tgt
 = 
cmd
->tgt;

2290 
»s
 = 0;

2291 
æags
;

2293 
	`TRACE_ENTRY
();

2295 
	`¥š_lock_œq§ve
(&
tgt
->
tgt_lock
, 
æags
);

2296 
tgt
->
»Œy_cmds
++;

2303 
	`smp_mb
();

2304 
	`TRACE_RETRY
("TGT QUEUE FULL: incrementing„etry_cmds %d",

2305 
tgt
->
»Œy_cmds
);

2306 ià(
fšished_cmds
 !ð
	`©omic_»ad
(&
tgt
->finished_cmds)) {

2308 
tgt
->
»Œy_cmds
--;

2309 
	`TRACE_RETRY
("Some command(s) finished, direct„etry "

2311 "»Œy_cmds=%d)", 
fšished_cmds
,

2312 
	`©omic_»ad
(&
tgt
->
fšished_cmds
),gt->
»Œy_cmds
);

2313 
»s
 = -1;

2314 
out_uÆock_tgt
;

2317 
	`TRACE_RETRY
("Addšg cmd %°tØ»Œy cmd†i¡", 
cmd
);

2318 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
, &
tgt
->
»Œy_cmd_li¡
);

2320 ià(!
tgt
->
»Œy_tim”_aùive
) {

2321 
tgt
->
»Œy_tim”
.
expœes
 = 
jiff›s
 + 
SCST_TGT_RETRY_TIMEOUT
;

2322 
	`add_tim”
(&
tgt
->
»Œy_tim”
);

2323 
tgt
->
»Œy_tim”_aùive
 = 1;

2326 
out_uÆock_tgt
:

2327 
	`¥š_uÆock_œq»¡Üe
(&
tgt
->
tgt_lock
, 
æags
);

2329 
	`TRACE_EXIT_RES
(
»s
);

2330  
»s
;

2331 
	}
}

2340 
	$sc¡_upd©e_hw_³ndšg_¡¬t
(
sc¡_cmd
 *
cmd
)

2342 
æags
;

2344 
	`TRACE_ENTRY
();

2347 
	`¥š_lock_œq§ve
(&
cmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

2348 
cmd
->
hw_³ndšg_¡¬t
 = 
jiff›s
;

2349 
	`TRACE_MGMT_DBG
("Updated hw_pending_starto %ld (cmd %p)",

2350 
cmd
->
hw_³ndšg_¡¬t
, cmd);

2351 
	`¥š_uÆock_œq»¡Üe
(&
cmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

2353 
	`TRACE_EXIT
();

2355 
	}
}

2356 
EXPORT_SYMBOL_GPL
(
sc¡_upd©e_hw_³ndšg_¡¬t
);

2362 
	$sc¡_check_hw_³ndšg_cmd
(
sc¡_cmd
 *
cmd
,

2363 
cur_time
, 
max_time
,

2364 
sc¡_£ssiÚ
 *
£ss
, *
æags
,

2365 
sc¡_tgt_‹m¶©e
 *
tg‰
)

2367 
»s
 = -1;

2369 
	`TRACE_DBG
("cmd %p, hw_pending %d,…rocime %ld, "

2370 "³ndšgim%ld", 
cmd
, cmd->
cmd_hw_³ndšg
,

2371 ()(
cur_time
 - 
cmd
->
¡¬t_time
è/ 
HZ
,

2372 ()(
cur_time
 - 
cmd
->
hw_³ndšg_¡¬t
è/ 
HZ
);

2374 ià(
	`time_befÜe
(
cur_time
, 
cmd
->
¡¬t_time
 + 
max_time
)) {

2376 
out
;

2379 ià(!
cmd
->
cmd_hw_³ndšg
) {

2380 
»s
 = 0;

2381 
out
;

2384 ià(
	`time_befÜe
(
cur_time
, 
cmd
->
hw_³ndšg_¡¬t
 + 
max_time
)) {

2385 
»s
 = 0;

2386 
out
;

2389 
	`TRACE_MGMT_DBG
("Cmd %p HW…ending foroo†ong %ld (state %x)",

2390 
cmd
, (
cur_time
 - cmd->
hw_³ndšg_¡¬t
è/ 
HZ
,

2391 
cmd
->
¡©e
);

2393 
cmd
->
cmd_hw_³ndšg
 = 0;

2395 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, *
æags
);

2396 
tg‰
->
	`Ú_hw_³ndšg_cmd_timeout
(
cmd
);

2397 
	`¥š_lock_œq§ve
(&
£ss
->
£ss_li¡_lock
, *
æags
);

2399 
»s
 = 1;

2401 
out
:

2402 
	`TRACE_EXIT_RES
(
»s
);

2403  
»s
;

2404 
	}
}

2406 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

2407 
	$sc¡_hw_³ndšg_wÜk_â
(*
p
)

2409 
	$sc¡_hw_³ndšg_wÜk_â
(
d–ayed_wÜk
 *
wÜk
)

2412 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

2413 
sc¡_£ssiÚ
 *
£ss
 = (sc¡_£ssiÚ *)
p
;

2415 
sc¡_£ssiÚ
 *
£ss
 = 
	`cÚš”_of
(
wÜk
, scst_session,

2416 
hw_³ndšg_wÜk
);

2418 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
£ss
->
tgt
->tgtt;

2419 
sc¡_cmd
 *
cmd
;

2420 
cur_time
 = 
jiff›s
;

2421 
æags
;

2422 
max_time
 = 
tg‰
->
max_hw_³ndšg_time
 * 
HZ
;

2424 
	`TRACE_ENTRY
();

2426 
	`TRACE_DBG
("HW…’dšg wÜk (£s %p, maxim%ld)", 
£ss
, 
max_time
/
HZ
);

2428 
	`þ—r_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
, &
£ss
->
£ss_aæags
);

2430 
	`¥š_lock_œq§ve
(&
£ss
->
£ss_li¡_lock
, 
æags
);

2432 
»¡¬t
:

2433 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
, 
£ss_cmd_li¡_’Œy
) {

2434 
rc
;

2436 
rc
 = 
	`sc¡_check_hw_³ndšg_cmd
(
cmd
, 
cur_time
, 
max_time
, 
£ss
,

2437 &
æags
, 
tg‰
);

2438 ià(
rc
 < 0)

2440 ià(
rc
 == 0)

2443 
»¡¬t
;

2446 ià(!
	`li¡_em±y
(&
£ss
->
£ss_cmd_li¡
)) {

2451 
	`TRACE_DBG
("Sched HW…ending work for sess %p (maxime %d)",

2452 
£ss
, 
tg‰
->
max_hw_³ndšg_time
);

2453 
	`£t_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
, &
£ss
->
£ss_aæags
);

2454 
	`scheduË_d–ayed_wÜk
(&
£ss
->
hw_³ndšg_wÜk
,

2455 
tg‰
->
max_hw_³ndšg_time
 * 
HZ
);

2458 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

2460 
	`TRACE_EXIT
();

2462 
	}
}

2464 
boÞ
 
	$__sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
ušt16_t
 
id
,

2465 cÚ¡ 
sc¡_tgt
 *
t
)

2467 
boÞ
 
»s
 = 
Œue
;

2468 
sc¡_tgt_‹m¶©e
 *
tg‰
;

2470 
	`TRACE_ENTRY
();

2472 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
,

2473 
sc¡_‹m¶©e_li¡_’Œy
) {

2474 
sc¡_tgt
 *
tgt
;

2475 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

2476 ià(
tgt
 =ð
t
)

2478 ià((
tgt
->
tg‰
->
is_rg‘_’abËd
 !ð
NULL
) &&

2479 !
tgt
->
tg‰
->
	`is_rg‘_’abËd
(tgt))

2481 ià(
id
 =ð
tgt
->
»l_tgt_id
) {

2482 
»s
 = 
çl£
;

2488 
	`TRACE_EXIT_RES
(
»s
);

2489  
»s
;

2490 
	}
}

2493 
boÞ
 
	$sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
ušt16_t
 
id
,

2494 cÚ¡ 
sc¡_tgt
 *
t
)

2496 
boÞ
 
»s
;

2498 
	`TRACE_ENTRY
();

2500 
	`mu‹x_lock
(&
sc¡_mu‹x
);

2501 
»s
 = 
	`__sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
id
, 
t
);

2502 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2504 
	`TRACE_EXIT_RES
(
»s
);

2505  
»s
;

2506 
	}
}

2508 
	$g’_»Ïtive_rg‘_pÜt_id
(
ušt16_t
 *
id
)

2510 
»s
 = -
EOVERFLOW
;

2511 
¹i
 = 
SCST_MIN_REL_TGT_ID
, 
¹i_´ev
;

2513 
	`TRACE_ENTRY
();

2515 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2516 
»s
 = -
EINTR
;

2517 
out
;

2520 
¹i_´ev
 = 
¹i
;

2522 ià(
	`__sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
¹i
, 
NULL
)) {

2523 *
id
 = (
ušt16_t
)
¹i
++;

2524 
»s
 = 0;

2525 
out_uÆock
;

2527 
¹i
++;

2528 ià(
¹i
 > 
SCST_MAX_REL_TGT_ID
)

2529 
¹i
 = 
SCST_MIN_REL_TGT_ID
;

2530 } 
¹i
 !ð
¹i_´ev
);

2532 
	`PRINT_ERROR
("%s", "Unableo create unique„elativearget…ort id");

2534 
out_uÆock
:

2535 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2537 
out
:

2538 
	`TRACE_EXIT_RES
(
»s
);

2539  
»s
;

2540 
	}
}

2543 
	$sc¡_®loc_tgt
(
sc¡_tgt_‹m¶©e
 *
tg‰
, 
sc¡_tgt
 **
tgt
)

2545 
sc¡_tgt
 *
t
;

2546 
»s
 = 0;

2548 
	`TRACE_ENTRY
();

2550 
t
 = 
	`kz®loc
((*t), 
GFP_KERNEL
);

2551 ià(
t
 =ð
NULL
) {

2552 
	`PRINT_ERROR
("%s", "Allocation ofgt failed");

2553 
»s
 = -
ENOMEM
;

2554 
out
;

2557 
	`INIT_LIST_HEAD
(&
t
->
£ss_li¡
);

2558 
	`š™_wa™queue_h—d
(&
t
->
uÄeg_wa™Q
);

2559 
t
->
tg‰
 =gtt;

2560 
t
->
sg_bËsize
 = 
tg‰
->sg_tablesize;

2561 
	`¥š_lock_š™
(&
t
->
tgt_lock
);

2562 
	`INIT_LIST_HEAD
(&
t
->
»Œy_cmd_li¡
);

2563 
	`©omic_£t
(&
t
->
fšished_cmds
, 0);

2564 
	`š™_tim”
(&
t
->
»Œy_tim”
);

2565 
t
->
»Œy_tim”
.
d©a
 = ()t;

2566 
t
->
»Œy_tim”
.
funùiÚ
 = 
sc¡_tgt_»Œy_tim”_â
;

2568 #ifdeà
CONFIG_SCST_PROC


2569 
»s
 = 
	`g’_»Ïtive_rg‘_pÜt_id
(&
t
->
»l_tgt_id
);

2570 ià(
»s
 != 0) {

2571 
	`sc¡_ä“_tgt
(
t
);

2572 
out
;

2575 
	`INIT_LIST_HEAD
(&
t
->
tgt_acg_li¡
);

2578 *
tgt
 = 
t
;

2580 
out
:

2581 
	`TRACE_EXIT_HRES
(
»s
);

2582  
»s
;

2583 
	}
}

2586 
	$sc¡_ä“_tgt
(
sc¡_tgt
 *
tgt
)

2588 
	`TRACE_ENTRY
();

2590 
	`kä“
(
tgt
->
tgt_Çme
);

2591 
	`kä“
(
tgt
->
tgt_comm’t
);

2592 #ifdeà
CONFIG_SCST_PROC


2593 
	`kä“
(
tgt
->
deçuÉ_group_Çme
);

2596 
	`kä“
(
tgt
);

2598 
	`TRACE_EXIT
();

2600 
	}
}

2602 
	$sc¡_š™_Üd”_d©a
(
sc¡_Üd”_d©a
 *
Üd”_d©a
)

2604 
i
;

2605 
	`¥š_lock_š™
(&
Üd”_d©a
->
¢_lock
);

2606 
	`INIT_LIST_HEAD
(&
Üd”_d©a
->
deã¼ed_cmd_li¡
);

2607 
	`INIT_LIST_HEAD
(&
Üd”_d©a
->
sk³d_¢_li¡
);

2608 
Üd”_d©a
->
cu¼_¢
 = (
	`ty³of
(order_data->curr_sn))(-300);

2609 
Üd”_d©a
->
ex³ùed_¢
 = ord”_d©a->
cu¼_¢
 + 1;

2610 
Üd”_d©a
->
num_ä“_¢_¦Ùs
 = 
	`ARRAY_SIZE
(Üd”_d©a->
¢_¦Ùs
)-1;

2611 
Üd”_d©a
->
cur_¢_¦Ù
 = &Üd”_d©a->
¢_¦Ùs
[0];

2612 
i
 = 0; i < ()
	`ARRAY_SIZE
(
Üd”_d©a
->
¢_¦Ùs
); i++)

2613 
	`©omic_£t
(&
Üd”_d©a
->
¢_¦Ùs
[
i
], 0);

2615 
	}
}

2618 
	$sc¡_®loc_deviû
(
gå_t
 
gå_mask
, 
sc¡_deviû
 **
out_dev
)

2620 
sc¡_deviû
 *
dev
;

2621 
»s
 = 0;

2623 
	`TRACE_ENTRY
();

2625 
dev
 = 
	`kz®loc
((*dev), 
gå_mask
);

2626 ià(
dev
 =ð
NULL
) {

2627 
	`PRINT_ERROR
("%s", "Allocation of scst_device failed");

2628 
»s
 = -
ENOMEM
;

2629 
out
;

2632 
dev
->
hªdËr
 = &
sc¡_nuÎ_devty³
;

2633 
	`©omic_£t
(&
dev
->
dev_cmd_couÁ
, 0);

2634 
	`sc¡_š™_mem_lim
(&
dev
->
dev_mem_lim
);

2635 
	`¥š_lock_š™
(&
dev
->
dev_lock
);

2636 
	`INIT_LIST_HEAD
(&
dev
->
blocked_cmd_li¡
);

2637 
	`INIT_LIST_HEAD
(&
dev
->
dev_tgt_dev_li¡
);

2638 
	`INIT_LIST_HEAD
(&
dev
->
dev_acg_dev_li¡
);

2639 
dev
->
dev_doubË_ua_possibË
 = 1;

2640 
dev
->
queue_®g
 = 
SCST_CONTR_MODE_QUEUE_ALG_UNRESTRICTED_REORDER
;

2642 
	`mu‹x_š™
(&
dev
->
dev_´_mu‹x
);

2643 
dev
->
´_g’”©iÚ
 = 0;

2644 
dev
->
´_is_£t
 = 0;

2645 
dev
->
´_hÞd”
 = 
NULL
;

2646 
dev
->
´_scÝe
 = 
SCOPE_LU
;

2647 
dev
->
´_ty³
 = 
TYPE_UNSPECIFIED
;

2648 
	`INIT_LIST_HEAD
(&
dev
->
dev_»gi¡¿Ás_li¡
);

2650 
	`sc¡_š™_Üd”_d©a
(&
dev
->
dev_Üd”_d©a
);

2652 
	`sc¡_š™_th»ads
(&
dev
->
dev_cmd_th»ads
);

2654 *
out_dev
 = 
dev
;

2656 
out
:

2657 
	`TRACE_EXIT_RES
(
»s
);

2658  
»s
;

2659 
	}
}

2661 
	$sc¡_ä“_deviû
(
sc¡_deviû
 *
dev
)

2663 
	`TRACE_ENTRY
();

2665 #ifdeà
CONFIG_SCST_EXTRACHECKS


2666 ià(!
	`li¡_em±y
(&
dev
->
dev_tgt_dev_li¡
) ||

2667 !
	`li¡_em±y
(&
dev
->
dev_acg_dev_li¡
)) {

2668 
	`PRINT_CRIT_ERROR
("%s: dev_tgt_dev_list or dev_acg_dev_list "

2669 "i nÙƒm±y!", 
__func__
);

2670 
	`sBUG
();

2674 
	`sc¡_deš™_th»ads
(&
dev
->
dev_cmd_th»ads
);

2676 
	`kä“
(
dev
->
vœt_Çme
);

2677 
	`kä“
(
dev
);

2679 
	`TRACE_EXIT
();

2681 
	}
}

2690 
	$sc¡_š™_mem_lim
(
sc¡_mem_lim
 *
mem_lim
)

2692 
	`©omic_£t
(&
mem_lim
->
®loûd_·ges
, 0);

2693 
mem_lim
->
max_®lowed_·ges
 =

2694 ((
ušt64_t
)
sc¡_max_dev_cmd_mem
 << 10è>> (
PAGE_SHIFT
 - 10);

2695 
	}
}

2696 
EXPORT_SYMBOL_GPL
(
sc¡_š™_mem_lim
);

2698 
sc¡_acg_dev
 *
	$sc¡_®loc_acg_dev
(
sc¡_acg
 *
acg
,

2699 
sc¡_deviû
 *
dev
, 
ušt64_t
 
lun
)

2701 
sc¡_acg_dev
 *
»s
;

2703 
	`TRACE_ENTRY
();

2705 
»s
 = 
	`kmem_ÿche_z®loc
(
sc¡_acgd_ÿch•
, 
GFP_KERNEL
);

2706 ià(
»s
 =ð
NULL
) {

2707 
	`PRINT_ERROR
("%s", "Allocation of scst_acg_dev failed");

2708 
out
;

2711 
»s
->
dev
 = dev;

2712 
»s
->
acg
 =‡cg;

2713 
»s
->
lun
 =†un;

2715 
out
:

2716 
	`TRACE_EXIT_HRES
(
»s
);

2717  
»s
;

2718 
	}
}

2724 
	$sc¡_d–_ä“_acg_dev
(
sc¡_acg_dev
 *
acg_dev
, 
boÞ
 
d–_sysfs
)

2726 
	`TRACE_ENTRY
();

2728 
	`TRACE_DBG
("Removing‡cg_dev %p from‡cg_dev_list‡nd dev_acg_dev_list",

2729 
acg_dev
);

2730 
	`li¡_d–
(&
acg_dev
->
acg_dev_li¡_’Œy
);

2731 
	`li¡_d–
(&
acg_dev
->
dev_acg_dev_li¡_’Œy
);

2733 ià(
d–_sysfs
)

2734 
	`sc¡_acg_dev_sysfs_d–
(
acg_dev
);

2736 
	`kmem_ÿche_ä“
(
sc¡_acgd_ÿch•
, 
acg_dev
);

2738 
	`TRACE_EXIT
();

2740 
	}
}

2743 
	$sc¡_acg_add_lun
(
sc¡_acg
 *
acg
, 
kobjeù
 *
·»Á
,

2744 
sc¡_deviû
 *
dev
, 
ušt64_t
 
lun
, 
»ad_Úly
,

2745 
boÞ
 
g’_sc¡_»pÜt_luns_chªged
, 
sc¡_acg_dev
 **
out_acg_dev
)

2747 
»s
 = 0;

2748 
sc¡_acg_dev
 *
acg_dev
;

2749 
sc¡_tgt_dev
 *
tgt_dev
;

2750 
sc¡_£ssiÚ
 *
£ss
;

2751 
	`LIST_HEAD
(
tmp_tgt_dev_li¡
);

2753 
	`TRACE_ENTRY
();

2755 
	`INIT_LIST_HEAD
(&
tmp_tgt_dev_li¡
);

2757 
acg_dev
 = 
	`sc¡_®loc_acg_dev
(
acg
, 
dev
, 
lun
);

2758 ià(
acg_dev
 =ð
NULL
) {

2759 
»s
 = -
ENOMEM
;

2760 
out
;

2762 
acg_dev
->
rd_Úly
 = 
»ad_Úly
;

2764 
	`TRACE_DBG
("Adding‡cg_dev %po‡cg_dev_list‡nd dev_acg_dev_list",

2765 
acg_dev
);

2766 
	`li¡_add_ž
(&
acg_dev
->
acg_dev_li¡_’Œy
, &
acg
->
acg_dev_li¡
);

2767 
	`li¡_add_ž
(&
acg_dev
->
dev_acg_dev_li¡_’Œy
, &
dev
->
dev_acg_dev_li¡
);

2769 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
, 
acg_£ss_li¡_’Œy
) {

2770 
»s
 = 
	`sc¡_®loc_add_tgt_dev
(
£ss
, 
acg_dev
, &
tgt_dev
);

2771 ià(
»s
 =ð-
EPERM
)

2773 ià(
»s
 != 0)

2774 
out_ä“
;

2776 
	`li¡_add_ž
(&
tgt_dev
->
exŒa_tgt_dev_li¡_’Œy
,

2777 &
tmp_tgt_dev_li¡
);

2780 
»s
 = 
	`sc¡_acg_dev_sysfs_ü—‹
(
acg_dev
, 
·»Á
);

2781 ià(
»s
 != 0)

2782 
out_ä“
;

2784 ià(
g’_sc¡_»pÜt_luns_chªged
)

2785 
	`sc¡_»pÜt_luns_chªged
(
acg
);

2787 
	`PRINT_INFO
("Added device %so group %s (LUN %lld, "

2788 "rd_Úly %d)", 
dev
->
vœt_Çme
, 
acg
->
acg_Çme
,

2789 ()
lun
, 
»ad_Úly
);

2791 ià(
out_acg_dev
 !ð
NULL
)

2792 *
out_acg_dev
 = 
acg_dev
;

2794 
out
:

2795 
	`TRACE_EXIT_RES
(
»s
);

2796  
»s
;

2798 
out_ä“
:

2799 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
tmp_tgt_dev_li¡
,

2800 
exŒa_tgt_dev_li¡_’Œy
) {

2801 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

2803 
	`sc¡_d–_ä“_acg_dev
(
acg_dev
, 
çl£
);

2804 
out
;

2805 
	}
}

2808 
	$sc¡_acg_d–_lun
(
sc¡_acg
 *
acg
, 
ušt64_t
 
lun
,

2809 
boÞ
 
g’_sc¡_»pÜt_luns_chªged
)

2811 
»s
 = 0;

2812 
sc¡_acg_dev
 *
acg_dev
 = 
NULL
, *
a
;

2813 
sc¡_tgt_dev
 *
tgt_dev
, *
‰
;

2815 
	`TRACE_ENTRY
();

2817 
	`li¡_fÜ_—ch_’Œy
(
a
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

2818 ià(
a
->
lun
 ==†un) {

2819 
acg_dev
 = 
a
;

2823 ià(
acg_dev
 =ð
NULL
) {

2824 
	`PRINT_ERROR
("Deviû i nÙ found iÀgrou°%s", 
acg
->
acg_Çme
);

2825 
»s
 = -
EINVAL
;

2826 
out
;

2829 
	`li¡_fÜ_—ch_’Œy_§ã
(
tgt_dev
, 
‰
, &
acg_dev
->
dev
->
dev_tgt_dev_li¡
,

2830 
dev_tgt_dev_li¡_’Œy
) {

2831 ià(
tgt_dev
->
acg_dev
 ==‡cg_dev)

2832 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

2835 
	`sc¡_d–_ä“_acg_dev
(
acg_dev
, 
Œue
);

2837 ià(
g’_sc¡_»pÜt_luns_chªged
)

2838 
	`sc¡_»pÜt_luns_chªged
(
acg
);

2840 
	`PRINT_INFO
("Removed LUN %Îd from grou°%s", ()
lun
,

2841 
acg
->
acg_Çme
);

2843 
out
:

2844 
	`TRACE_EXIT_RES
(
»s
);

2845  
»s
;

2846 
	}
}

2849 
sc¡_acg
 *
	$sc¡_®loc_add_acg
(
sc¡_tgt
 *
tgt
,

2850 cÚ¡ *
acg_Çme
, 
boÞ
 
tgt_acg
)

2852 
sc¡_acg
 *
acg
;

2854 
	`TRACE_ENTRY
();

2856 
acg
 = 
	`kz®loc
((*acg), 
GFP_KERNEL
);

2857 ià(
acg
 =ð
NULL
) {

2858 
	`PRINT_ERROR
("%s", "Allocation of‡cg failed");

2859 
out
;

2862 
acg
->
tgt
 =gt;

2863 
	`INIT_LIST_HEAD
(&
acg
->
acg_dev_li¡
);

2864 
	`INIT_LIST_HEAD
(&
acg
->
acg_£ss_li¡
);

2865 
	`INIT_LIST_HEAD
(&
acg
->
aú_li¡
);

2866 
	`ýumask_cÝy
(&
acg
->
acg_ýu_mask
, &
deçuÉ_ýu_mask
);

2867 
acg
->
acg_Çme
 = 
	`k¡rdup
×cg_Çme, 
GFP_KERNEL
);

2868 ià(
acg
->
acg_Çme
 =ð
NULL
) {

2869 
	`PRINT_ERROR
("%s", "Allocation of‡cg_name failed");

2870 
out_ä“
;

2873 #ifdeà
CONFIG_SCST_PROC


2874 
acg
->
addr_m‘hod
 = 
tgt
 &&gt->
tg‰
 ?gt->tg‰->
´eã¼ed_addr_m‘hod


2875 : 
SCST_LUN_ADDR_METHOD_PERIPHERAL
;

2877 
	`TRACE_DBG
("Addšg‡cg % tØsc¡_acg_li¡", 
acg_Çme
);

2878 
	`li¡_add_ž
(&
acg
->
acg_li¡_’Œy
, &
sc¡_acg_li¡
);

2880 
	`sc¡_check_»assign_£ssiÚs
();

2882 
acg
->
addr_m‘hod
 = 
tgt
->
tg‰
->
´eã¼ed_addr_m‘hod
;

2884 ià(
tgt_acg
) {

2885 
rc
;

2887 
	`TRACE_DBG
("Addšg‡cg '%s'Ødeviû '%s'‡cg_li¡", 
acg_Çme
,

2888 
tgt
->
tgt_Çme
);

2889 
	`li¡_add_ž
(&
acg
->
acg_li¡_’Œy
, &
tgt
->
tgt_acg_li¡
);

2890 
acg
->
tgt_acg
 = 1;

2892 
rc
 = 
	`sc¡_acg_sysfs_ü—‹
(
tgt
, 
acg
);

2893 ià(
rc
 != 0)

2894 
out_d–
;

2898 
out
:

2899 
	`TRACE_EXIT_HRES
(
acg
);

2900  
acg
;

2902 #iâdeà
CONFIG_SCST_PROC


2903 
out_d–
:

2904 
	`li¡_d–
(&
acg
->
acg_li¡_’Œy
);

2907 
out_ä“
:

2908 
	`kä“
(
acg
);

2909 
acg
 = 
NULL
;

2910 
out
;

2911 
	}
}

2914 
	$sc¡_d–_ä“_acg
(
sc¡_acg
 *
acg
)

2916 
sc¡_aú
 *
aú
, *
aút
;

2917 
sc¡_acg_dev
 *
acg_dev
, *
acg_dev_tmp
;

2919 
	`TRACE_ENTRY
();

2921 
	`TRACE_DBG
("CË¬šg‡cg % äom†i¡", 
acg
->
acg_Çme
);

2923 
	`sBUG_ON
(!
	`li¡_em±y
(&
acg
->
acg_£ss_li¡
));

2926 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
acg_dev_tmp
, &
acg
->
acg_dev_li¡
,

2927 
acg_dev_li¡_’Œy
) {

2928 
sc¡_tgt_dev
 *
tgt_dev
, *
‰
;

2929 
	`li¡_fÜ_—ch_’Œy_§ã
(
tgt_dev
, 
‰
,

2930 &
acg_dev
->
dev
->
dev_tgt_dev_li¡
,

2931 
dev_tgt_dev_li¡_’Œy
) {

2932 ià(
tgt_dev
->
acg_dev
 ==‡cg_dev)

2933 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

2935 
	`sc¡_d–_ä“_acg_dev
(
acg_dev
, 
Œue
);

2939 
	`li¡_fÜ_—ch_’Œy_§ã
(
aú
, 
aút
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

2940 
	`sc¡_d–_ä“_aú
(
aú
,

2941 
	`li¡_is_Ï¡
(&
aú
->
aú_li¡_’Œy
, &
acg
->
aú_li¡
));

2943 
	`INIT_LIST_HEAD
(&
acg
->
aú_li¡
);

2945 #ifdeà
CONFIG_SCST_PROC


2946 
	`li¡_d–
(&
acg
->
acg_li¡_’Œy
);

2948 ià(
acg
->
tgt_acg
) {

2949 
	`TRACE_DBG
("Removšg‡cg % äom†i¡", 
acg
->
acg_Çme
);

2950 
	`li¡_d–
(&
acg
->
acg_li¡_’Œy
);

2952 
	`sc¡_acg_sysfs_d–
(
acg
);

2954 
acg
->
tgt
->
deçuÉ_acg
 = 
NULL
;

2957 
	`sBUG_ON
(!
	`li¡_em±y
(&
acg
->
acg_£ss_li¡
));

2958 
	`sBUG_ON
(!
	`li¡_em±y
(&
acg
->
acg_dev_li¡
));

2959 
	`sBUG_ON
(!
	`li¡_em±y
(&
acg
->
aú_li¡
));

2961 
	`kä“
(
acg
->
acg_Çme
);

2962 
	`kä“
(
acg
);

2964 
	`TRACE_EXIT
();

2966 
	}
}

2968 #iâdeà
CONFIG_SCST_PROC


2971 
sc¡_acg
 *
	$sc¡_tgt_fšd_acg
(
sc¡_tgt
 *
tgt
, cÚ¡ *
Çme
)

2973 
sc¡_acg
 *
acg
, *
acg_»t
 = 
NULL
;

2975 
	`TRACE_ENTRY
();

2977 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
tgt
->
tgt_acg_li¡
, 
acg_li¡_’Œy
) {

2978 ià(
	`¡rcmp
(
acg
->
acg_Çme
, 
Çme
) == 0) {

2979 
acg_»t
 = 
acg
;

2984 
	`TRACE_EXIT
();

2985  
acg_»t
;

2986 
	}
}

2991 
sc¡_tgt_dev
 *
	$sc¡_fšd_sh¬ed_io_tgt_dev
(

2992 
sc¡_tgt_dev
 *
tgt_dev
)

2994 
sc¡_tgt_dev
 *
»s
 = 
NULL
;

2995 
sc¡_acg
 *
acg
 = 
tgt_dev
->
acg_dev
->acg;

2996 
sc¡_tgt_dev
 *
t
;

2998 
	`TRACE_ENTRY
();

3000 
	`TRACE_DBG
("tgt_dev %s (acg %p, io_grouping_type %d)",

3001 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
, 
acg
,‡cg->
acg_io_groupšg_ty³
);

3003 
acg
->
acg_io_groupšg_ty³
) {

3004 
SCST_IO_GROUPING_AUTO
:

3005 ià(
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
 =ð
NULL
)

3006 
out
;

3008 
	`li¡_fÜ_—ch_’Œy
(
t
, &
tgt_dev
->
dev
->
dev_tgt_dev_li¡
,

3009 
dev_tgt_dev_li¡_’Œy
) {

3010 ià((
t
 =ð
tgt_dev
) ||

3011 (
t
->
£ss
->
š™ŸtÜ_Çme
 =ð
NULL
) ||

3012 (
t
->
aùive_cmd_th»ads
 =ð
NULL
))

3015 
	`TRACE_DBG
("ˆ%s", 
t
->
£ss
->
š™ŸtÜ_Çme
);

3019 ià(
	`¡rcmp
(
t
->
£ss
->
š™ŸtÜ_Çme
,

3020 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
) == 0)

3021 
found
;

3025 
SCST_IO_GROUPING_THIS_GROUP_ONLY
:

3026 
	`li¡_fÜ_—ch_’Œy
(
t
, &
tgt_dev
->
dev
->
dev_tgt_dev_li¡
,

3027 
dev_tgt_dev_li¡_’Œy
) {

3028 ià((
t
 =ð
tgt_dev
è|| (t->
aùive_cmd_th»ads
 =ð
NULL
))

3031 
	`TRACE_DBG
("ˆ% ×cg %p)", 
t
->
£ss
->
š™ŸtÜ_Çme
,

3032 
t
->
acg_dev
->
acg
);

3034 ià(
t
->
acg_dev
->
acg
 ==‡cg)

3035 
found
;

3039 
SCST_IO_GROUPING_NEVER
:

3040 
out
;

3043 
	`li¡_fÜ_—ch_’Œy
(
t
, &
tgt_dev
->
dev
->
dev_tgt_dev_li¡
,

3044 
dev_tgt_dev_li¡_’Œy
) {

3045 ià((
t
 =ð
tgt_dev
è|| (t->
aùive_cmd_th»ads
 =ð
NULL
))

3048 
	`TRACE_DBG
("t %s (acg %p, io_grouping_type %d)",

3049 
t
->
£ss
->
š™ŸtÜ_Çme
,->
acg_dev
->
acg
,

3050 
t
->
acg_dev
->
acg
->
acg_io_groupšg_ty³
);

3052 ià(
t
->
acg_dev
->
acg
->
acg_io_groupšg_ty³
 ==

3053 
acg
->
acg_io_groupšg_ty³
)

3054 
found
;

3059 
out
:

3060 
	`TRACE_EXIT_HRES
(()
»s
);

3061  
»s
;

3063 
found
:

3064 ià(
t
->
aùive_cmd_th»ads
 =ð&
sc¡_maš_cmd_th»ads
) {

3065 
»s
 = 
t
;

3066 
	`TRACE_MGMT_DBG
("Goingo share‡sync IO context %p (res %p, "

3068 
t
->
aic_k“³r
->
aic
, 
»s
,->
£ss
->
š™ŸtÜ_Çme
,

3069 
t
->
dev
->
vœt_Çme
,

3070 
t
->
acg_dev
->
acg
->
acg_io_groupšg_ty³
);

3072 
»s
 = 
t
;

3073 ià(!*(vÞ©ž
boÞ
*)&
»s
->
aùive_cmd_th»ads
->
io_cÚ‹xt_»ady
) {

3074 
	`TRACE_MGMT_DBG
("IO context for %p‚ot yet "

3075 "š™Ÿlized, wa™šg...", 
t
);

3076 
	`m¦“p
(100);

3077 
found
;

3079 
	`smp_rmb
();

3080 
	`TRACE_MGMT_DBG
("Goingo share IO context %p (res %p, ini %s, "

3082 
»s
->
aùive_cmd_th»ads
->
io_cÚ‹xt
,„es,

3083 
t
->
£ss
->
š™ŸtÜ_Çme
,->
dev
->
vœt_Çme
,

3084 
t
->
aùive_cmd_th»ads
,

3085 
t
->
acg_dev
->
acg
->
acg_io_groupšg_ty³
);

3087 
out
;

3088 
	}
}

3090 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
	$sc¡_·r£_th»ads_poÞ_ty³
(cÚ¡ *
p
,

3091 
Ën
)

3093 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
»s
;

3095 ià(
	`¡ºÿ£cmp
(
p
, 
SCST_THREADS_POOL_PER_INITIATOR_STR
,

3096 
	`mš_t
(, 
	`¡¾’
(
SCST_THREADS_POOL_PER_INITIATOR_STR
),

3097 
Ën
)) == 0)

3098 
»s
 = 
SCST_THREADS_POOL_PER_INITIATOR
;

3099 ià(
	`¡ºÿ£cmp
(
p
, 
SCST_THREADS_POOL_SHARED_STR
,

3100 
	`mš_t
(, 
	`¡¾’
(
SCST_THREADS_POOL_SHARED_STR
),

3101 
Ën
)) == 0)

3102 
»s
 = 
SCST_THREADS_POOL_SHARED
;

3104 
	`PRINT_ERROR
("UnknowÀth»ad poÞy³ %s", 
p
);

3105 
»s
 = 
SCST_THREADS_POOL_TYPE_INVALID
;

3108  
»s
;

3109 
	}
}

3111 
	$sc¡_ioc_k“³r_th»ad
(*
¬g
)

3113 
sc¡_async_io_cÚ‹xt_k“³r
 *
aic_k“³r
 =

3114 (
sc¡_async_io_cÚ‹xt_k“³r
 *)
¬g
;

3116 
	`TRACE_ENTRY
();

3118 
	`TRACE_MGMT_DBG
("AIC %°k“³¸th»ad % (PID %dè¡¬‹d", 
aic_k“³r
,

3119 
cu¼’t
->
comm
, cu¼’t->
pid
);

3121 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

3123 
	`sBUG_ON
(
aic_k“³r
->
aic
 !ð
NULL
);

3125 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 25)

3126 
aic_k“³r
->
aic
 = 
	`g‘_io_cÚ‹xt
(
GFP_KERNEL
, -1);

3128 
	`TRACE_MGMT_DBG
("Alloced‚ew‡sync IO context %p (aic %p)",

3129 
aic_k“³r
->
aic
,‡ic_keeper);

3132 
	`put_io_cÚ‹xt
(
aic_k“³r
->
aic
);

3135 
aic_k“³r
->
aic_»ady
 = 
Œue
;

3136 
	`wake_up_®l
(&
aic_k“³r
->
aic_k“³r_wa™Q
);

3138 
	`wa™_ev’t_š‹¼u±ibË
(
aic_k“³r
->
aic_k“³r_wa™Q
,

3139 
	`kth»ad_should_¡Ý
());

3141 
	`TRACE_MGMT_DBG
("AIC %°k“³¸th»ad % (PID %dèfšished", 
aic_k“³r
,

3142 
cu¼’t
->
comm
, cu¼’t->
pid
);

3144 
	`TRACE_EXIT
();

3146 
	}
}

3149 
	$sc¡_tgt_dev_£tup_th»ads
(
sc¡_tgt_dev
 *
tgt_dev
)

3151 
»s
 = 0;

3152 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

3153 
sc¡_async_io_cÚ‹xt_k“³r
 *
aic_k“³r
;

3155 
	`TRACE_ENTRY
();

3157 ià(
dev
->
th»ads_num
 < 0)

3158 
out
;

3160 ià(
dev
->
th»ads_num
 == 0) {

3161 
sc¡_tgt_dev
 *
sh¬ed_io_tgt_dev
;

3162 
tgt_dev
->
aùive_cmd_th»ads
 = &
sc¡_maš_cmd_th»ads
;

3164 
sh¬ed_io_tgt_dev
 = 
	`sc¡_fšd_sh¬ed_io_tgt_dev
(
tgt_dev
);

3165 ià(
sh¬ed_io_tgt_dev
 !ð
NULL
) {

3166 
aic_k“³r
 = 
sh¬ed_io_tgt_dev
->aic_keeper;

3167 
	`k»f_g‘
(&
aic_k“³r
->
aic_k“³r_k»f
);

3169 
	`TRACE_MGMT_DBG
("Linking‡sync io context %p "

3171 
aic_k“³r
->
aic
, 
tgt_dev
,

3172 
tgt_dev
->
dev
->
vœt_Çme
);

3175 
aic_k“³r
 = 
	`kz®loc
((*aic_k“³r), 
GFP_KERNEL
);

3176 ià(
aic_k“³r
 =ð
NULL
) {

3177 
	`PRINT_ERROR
("Unableo‡lloc‡ic_keeper "

3178 "(siz%zd)", (*
aic_k“³r
));

3179 
»s
 = -
ENOMEM
;

3180 
out
;

3183 
	`k»f_š™
(&
aic_k“³r
->
aic_k“³r_k»f
);

3184 
	`š™_wa™queue_h—d
(&
aic_k“³r
->
aic_k“³r_wa™Q
);

3186 
aic_k“³r
->
aic_k“³r_thr
 =

3187 
	`kth»ad_run
(
sc¡_ioc_k“³r_th»ad
,

3188 
aic_k“³r
, "aic_keeper");

3189 ià(
	`IS_ERR
(
aic_k“³r
->
aic_k“³r_thr
)) {

3190 
	`PRINT_ERROR
("Error„unning ioc_keeper "

3191 "th»ad (tgt_dev %p)", 
tgt_dev
);

3192 
»s
 = 
	`PTR_ERR
(
aic_k“³r
->
aic_k“³r_thr
);

3193 
out_ä“_k“³r
;

3196 
	`wa™_ev’t
(
aic_k“³r
->
aic_k“³r_wa™Q
,

3197 
aic_k“³r
->
aic_»ady
);

3199 
	`TRACE_MGMT_DBG
("Created‡sync io context %p "

3201 
aic_k“³r
->
aic
, 
tgt_dev
,

3202 
tgt_dev
->
dev
->
vœt_Çme
);

3205 
tgt_dev
->
async_io_cÚ‹xt
 = 
aic_k“³r
->
aic
;

3206 
tgt_dev
->
aic_k“³r
 =‡ic_keeper;

3208 
»s
 = 
	`sc¡_add_th»ads
(
tgt_dev
->
aùive_cmd_th»ads
, 
NULL
, NULL,

3209 
tgt_dev
->
£ss
->
tgt
->
tg‰
->
th»ads_num
);

3210 
out
;

3213 
dev
->
th»ads_poÞ_ty³
) {

3214 
SCST_THREADS_POOL_PER_INITIATOR
:

3216 
sc¡_tgt_dev
 *
sh¬ed_io_tgt_dev
;

3218 
	`sc¡_š™_th»ads
(&
tgt_dev
->
tgt_dev_cmd_th»ads
);

3220 
tgt_dev
->
aùive_cmd_th»ads
 = &tgt_dev->
tgt_dev_cmd_th»ads
;

3222 
sh¬ed_io_tgt_dev
 = 
	`sc¡_fšd_sh¬ed_io_tgt_dev
(
tgt_dev
);

3223 ià(
sh¬ed_io_tgt_dev
 !ð
NULL
) {

3224 
	`TRACE_MGMT_DBG
("Linking io context %p for "

3226 
sh¬ed_io_tgt_dev
->
aùive_cmd_th»ads
->
io_cÚ‹xt
,

3227 
tgt_dev
,gt_dev->
aùive_cmd_th»ads
);

3229 
tgt_dev
->
aùive_cmd_th»ads
->
io_cÚ‹xt
 =

3230 
sh¬ed_io_tgt_dev
->
aùive_cmd_th»ads
->
io_cÚ‹xt
;

3233 
»s
 = 
	`sc¡_add_th»ads
(
tgt_dev
->
aùive_cmd_th»ads
, 
NULL
,

3234 
tgt_dev
,

3235 
dev
->
th»ads_num
 + 
tgt_dev
->
£ss
->
tgt
->
tg‰
->threads_num);

3236 ià(
»s
 != 0) {

3238 
tgt_dev
->
aùive_cmd_th»ads
->
io_cÚ‹xt
 = 
NULL
;

3242 
SCST_THREADS_POOL_SHARED
:

3244 
tgt_dev
->
aùive_cmd_th»ads
 = &
dev
->
dev_cmd_th»ads
;

3246 
»s
 = 
	`sc¡_add_th»ads
(
tgt_dev
->
aùive_cmd_th»ads
, 
dev
, 
NULL
,

3247 
tgt_dev
->
£ss
->
tgt
->
tg‰
->
th»ads_num
);

3251 
	`PRINT_CRIT_ERROR
("Unknownhreads…oolype %d (dev %s)",

3252 
dev
->
th»ads_poÞ_ty³
, dev->
vœt_Çme
);

3253 
	`sBUG
();

3257 
out
:

3258 ià(
»s
 == 0)

3259 
	`tm_dbg_š™_tgt_dev
(
tgt_dev
);

3261 
	`TRACE_EXIT_RES
(
»s
);

3262  
»s
;

3264 
out_ä“_k“³r
:

3265 
	`kä“
(
aic_k“³r
);

3266 
out
;

3267 
	}
}

3269 
	$sc¡_aic_k“³r_»Ëa£
(
k»f
 *kref)

3271 
sc¡_async_io_cÚ‹xt_k“³r
 *
aic_k“³r
;

3273 
	`TRACE_ENTRY
();

3275 
aic_k“³r
 = 
	`cÚš”_of
(
k»f
, 
sc¡_async_io_cÚ‹xt_k“³r
,

3276 
aic_k“³r_k»f
);

3278 
	`kth»ad_¡Ý
(
aic_k“³r
->
aic_k“³r_thr
);

3280 
	`kä“
(
aic_k“³r
);

3282 
	`TRACE_EXIT
();

3284 
	}
}

3287 
	$sc¡_tgt_dev_¡Ý_th»ads
(
sc¡_tgt_dev
 *
tgt_dev
)

3289 
	`TRACE_ENTRY
();

3291 ià(
tgt_dev
->
dev
->
th»ads_num
 < 0)

3292 
out_deš™
;

3294 ià(
tgt_dev
->
aùive_cmd_th»ads
 =ð&
sc¡_maš_cmd_th»ads
) {

3296 
	`k»f_put
(&
tgt_dev
->
aic_k“³r
->
aic_k“³r_k»f
,

3297 
sc¡_aic_k“³r_»Ëa£
);

3298 
tgt_dev
->
async_io_cÚ‹xt
 = 
NULL
;

3299 
tgt_dev
->
aic_k“³r
 = 
NULL
;

3300 } ià(
tgt_dev
->
aùive_cmd_th»ads
 =ð&tgt_dev->
dev
->
dev_cmd_th»ads
) {

3302 
	`sc¡_d–_th»ads
(
tgt_dev
->
aùive_cmd_th»ads
,

3303 
tgt_dev
->
£ss
->
tgt
->
tg‰
->
th»ads_num
);

3304 } ià(
tgt_dev
->
aùive_cmd_th»ads
 =ð&tgt_dev->
tgt_dev_cmd_th»ads
) {

3306 
	`sc¡_d–_th»ads
(
tgt_dev
->
aùive_cmd_th»ads
, -1);

3307 
	`sc¡_deš™_th»ads
(&
tgt_dev
->
tgt_dev_cmd_th»ads
);

3310 
out_deš™
:

3311 
	`tm_dbg_deš™_tgt_dev
(
tgt_dev
);

3312 
tgt_dev
->
aùive_cmd_th»ads
 = 
NULL
;

3314 
	`TRACE_EXIT
();

3316 
	}
}

3322 
	$sc¡_®loc_add_tgt_dev
(
sc¡_£ssiÚ
 *
£ss
,

3323 
sc¡_acg_dev
 *
acg_dev
, 
sc¡_tgt_dev
 **
out_tgt_dev
)

3325 
»s
 = 0;

3326 
ši_sg
, 
ši_unchecked_i§_dma
, 
ši_u£_þu¡”šg
;

3327 
sc¡_tgt_dev
 *
tgt_dev
;

3328 
sc¡_deviû
 *
dev
 = 
acg_dev
->dev;

3329 
li¡_h—d
 *
h—d
;

3330 
¦
;

3331 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

3333 
	`TRACE_ENTRY
();

3335 
tgt_dev
 = 
	`kmem_ÿche_z®loc
(
sc¡_tgtd_ÿch•
, 
GFP_KERNEL
);

3336 ià(
tgt_dev
 =ð
NULL
) {

3337 
	`PRINT_ERROR
("%s", "Allocation of scst_tgt_dev failed");

3338 
»s
 = -
ENOMEM
;

3339 
out
;

3342 
tgt_dev
->
dev
 = dev;

3343 
tgt_dev
->
lun
 = 
acg_dev
->lun;

3344 
tgt_dev
->
acg_dev
 =‡cg_dev;

3345 
tgt_dev
->
£ss
 = sess;

3346 
	`©omic_£t
(&
tgt_dev
->
tgt_dev_cmd_couÁ
, 0);

3348 
	`sc¡_sgv_poÞ_u£_nÜm
(
tgt_dev
);

3350 ià(
dev
->
scsi_dev
 !ð
NULL
) {

3351 
ši_sg
 = 
dev
->
scsi_dev
->
ho¡
->
sg_bËsize
;

3352 
ši_unchecked_i§_dma
 = 
dev
->
scsi_dev
->
ho¡
->
unchecked_i§_dma
;

3353 
ši_u£_þu¡”šg
 = (
dev
->
scsi_dev
->
ho¡
->
u£_þu¡”šg
 ==

3354 
ENABLE_CLUSTERING
);

3356 
ši_sg
 = (1 << 15) ;

3357 
ši_unchecked_i§_dma
 = 0;

3358 
ši_u£_þu¡”šg
 = 0;

3360 
tgt_dev
->
max_sg_út
 = 
	`mš
(
ši_sg
, 
£ss
->
tgt
->
sg_bËsize
);

3362 ià((
£ss
->
tgt
->
tg‰
->
u£_þu¡”šg
 || 
ši_u£_þu¡”šg
) &&

3363 !
£ss
->
tgt
->
tg‰
->
no_þu¡”šg
)

3364 
	`sc¡_sgv_poÞ_u£_nÜm_þu¡
(
tgt_dev
);

3366 ià(
£ss
->
tgt
->
tg‰
->
unchecked_i§_dma
 || 
ši_unchecked_i§_dma
)

3367 
	`sc¡_sgv_poÞ_u£_dma
(
tgt_dev
);

3369 
	`TRACE_MGMT_DBG
("Device %s on SCST†un=%lld",

3370 
dev
->
vœt_Çme
, ()
tgt_dev
->
lun
);

3372 
	`¥š_lock_š™
(&
tgt_dev
->
tgt_dev_lock
);

3373 
	`INIT_LIST_HEAD
(&
tgt_dev
->
UA_li¡
);

3374 
	`¥š_lock_š™
(&
tgt_dev
->
thr_d©a_lock
);

3375 
	`INIT_LIST_HEAD
(&
tgt_dev
->
thr_d©a_li¡
);

3377 
	`sc¡_š™_Üd”_d©a
(&
tgt_dev
->
tgt_dev_Üd”_d©a
);

3378 ià(
dev
->
t¡
 =ð
SCST_CONTR_MODE_SEP_TASK_SETS
)

3379 
tgt_dev
->
cu¼_Üd”_d©a
 = &tgt_dev->
tgt_dev_Üd”_d©a
;

3381 
tgt_dev
->
cu¼_Üd”_d©a
 = &
dev
->
dev_Üd”_d©a
;

3383 ià(
dev
->
hªdËr
->
·r£_©omic
 &&

3384 
dev
->
hªdËr
->
®loc_d©a_buf_©omic
 &&

3385 (
£ss
->
tgt
->
tg‰
->
´•roûssšg_dÚe
 =ð
NULL
)) {

3386 ià(
£ss
->
tgt
->
tg‰
->
rdy_to_xãr_©omic
)

3387 
	`__£t_b™
(
SCST_TGT_DEV_AFTER_INIT_WR_ATOMIC
,

3388 &
tgt_dev
->
tgt_dev_æags
);

3390 ià(
dev
->
hªdËr
->
dev_dÚe_©omic
 &&

3391 
£ss
->
tgt
->
tg‰
->
xm™_»¥Ú£_©omic
) {

3392 
	`__£t_b™
(
SCST_TGT_DEV_AFTER_EXEC_ATOMIC
,

3393 &
tgt_dev
->
tgt_dev_æags
);

3396 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

3397 
dev
->
d_£n£
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

3398 
	`sc¡_®loc_£t_UA
(
tgt_dev
, 
£n£_bufãr
, 
¦
, 0);

3400 ià(
£ss
->
tgt
->
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
) {

3401 ià(!
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
)) {

3402 
	`PRINT_WARNING
("Initiators fromarget %s can't connect "

3405 "P”si¡’ˆRe£rv©iÚs", 
£ss
->
tgt
->
tg‰
->
Çme
,

3406 
dev
->
vœt_Çme
);

3407 
»s
 = -
EPERM
;

3408 
out_ä“
;

3410 
dev
->
nÙ_´_suµÜtšg_tgt_devs_num
++;

3413 
»s
 = 
	`sc¡_´_š™_tgt_dev
(
tgt_dev
);

3414 ià(
»s
 != 0)

3415 
out_dec_ä“
;

3417 
»s
 = 
	`sc¡_tgt_dev_£tup_th»ads
(
tgt_dev
);

3418 ià(
»s
 != 0)

3419 
out_´_þ—r
;

3421 ià(
dev
->
hªdËr
 && dev->hªdËr->
©ch_tgt
) {

3422 
	`TRACE_DBG
("C®lšg dev hªdËr' ©ch_tgt(%p)", 
tgt_dev
);

3423 
»s
 = 
dev
->
hªdËr
->
	`©ch_tgt
(
tgt_dev
);

3424 
	`TRACE_DBG
("%s", "Dev handler's‡ttach_tgt()„eturned");

3425 ià(
»s
 != 0) {

3426 
	`PRINT_ERROR
("Device handler's %s‡ttach_tgt() "

3427 "çžed: %d", 
dev
->
hªdËr
->
Çme
, 
»s
);

3428 
out_¡Ý_th»ads
;

3432 
»s
 = 
	`sc¡_tgt_dev_sysfs_ü—‹
(
tgt_dev
);

3433 ià(
»s
 != 0)

3434 
out_d‘ach
;

3436 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

3437 
	`li¡_add_ž
(&
tgt_dev
->
dev_tgt_dev_li¡_’Œy
, &
dev
->
dev_tgt_dev_li¡
);

3438 ià(
dev
->
dev_»£rved
)

3439 
	`__£t_b™
(
SCST_TGT_DEV_RESERVED
, &
tgt_dev
->
tgt_dev_æags
);

3440 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

3442 
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
	`SESS_TGT_DEV_LIST_HASH_FN
(
tgt_dev
->
lun
)];

3443 
	`li¡_add_ž
(&
tgt_dev
->
£ss_tgt_dev_li¡_’Œy
, 
h—d
);

3445 *
out_tgt_dev
 = 
tgt_dev
;

3447 
out
:

3448 
	`TRACE_EXIT_RES
(
»s
);

3449  
»s
;

3451 
out_d‘ach
:

3452 ià(
dev
->
hªdËr
 && dev->hªdËr->
d‘ach_tgt
) {

3453 
	`TRACE_DBG
("Calling dev handler's detach_tgt(%p)",

3454 
tgt_dev
);

3455 
dev
->
hªdËr
->
	`d‘ach_tgt
(
tgt_dev
);

3456 
	`TRACE_DBG
("%s", "Dev handler's detach_tgt()„eturned");

3459 
out_¡Ý_th»ads
:

3460 
	`sc¡_tgt_dev_¡Ý_th»ads
(
tgt_dev
);

3462 
out_´_þ—r
:

3463 
	`sc¡_´_þ—r_tgt_dev
(
tgt_dev
);

3465 
out_dec_ä“
:

3466 ià(
tgt_dev
->
£ss
->
tgt
->
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
)

3467 
dev
->
nÙ_´_suµÜtšg_tgt_devs_num
--;

3469 
out_ä“
:

3470 
	`sc¡_ä“_®l_UA
(
tgt_dev
);

3471 
	`kmem_ÿche_ä“
(
sc¡_tgtd_ÿch•
, 
tgt_dev
);

3472 
out
;

3473 
	}
}

3476 
	$sc¡_Ãxus_loss
(
sc¡_tgt_dev
 *
tgt_dev
, 
boÞ
 
queue_UA
)

3478 
	`TRACE_ENTRY
();

3480 
	`sc¡_þ—r_»£rv©iÚ
(
tgt_dev
);

3487 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

3488 
	`sc¡_ä“_®l_UA
(
tgt_dev
);

3489 
	`mem£t
(
tgt_dev
->
tgt_dev_£n£
, 0, (tgt_dev->tgt_dev_sense));

3490 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

3493 ià(
queue_UA
) {

3494 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

3495 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

3496 
tgt_dev
->
dev
->
d_£n£
,

3497 
	`SCST_LOAD_SENSE
(
sc¡_£n£_Ãxus_loss_UA
));

3498 
	`sc¡_check_£t_UA
(
tgt_dev
, 
£n£_bufãr
, 
¦
, 0);

3501 
	`TRACE_EXIT
();

3503 
	}
}

3509 
	$sc¡_ä“_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

3511 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

3513 
	`TRACE_ENTRY
();

3515 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

3516 
	`li¡_d–
(&
tgt_dev
->
dev_tgt_dev_li¡_’Œy
);

3517 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

3519 
	`li¡_d–
(&
tgt_dev
->
£ss_tgt_dev_li¡_’Œy
);

3521 
	`sc¡_tgt_dev_sysfs_d–
(
tgt_dev
);

3523 ià(
tgt_dev
->
£ss
->
tgt
->
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
)

3524 
dev
->
nÙ_´_suµÜtšg_tgt_devs_num
--;

3526 
	`sc¡_þ—r_»£rv©iÚ
(
tgt_dev
);

3527 
	`sc¡_´_þ—r_tgt_dev
(
tgt_dev
);

3528 
	`sc¡_ä“_®l_UA
(
tgt_dev
);

3530 ià(
dev
->
hªdËr
 && dev->hªdËr->
d‘ach_tgt
) {

3531 
	`TRACE_DBG
("Calling dev handler's detach_tgt(%p)",

3532 
tgt_dev
);

3533 
dev
->
hªdËr
->
	`d‘ach_tgt
(
tgt_dev
);

3534 
	`TRACE_DBG
("%s", "Dev handler's detach_tgt()„eturned");

3537 
	`sc¡_tgt_dev_¡Ý_th»ads
(
tgt_dev
);

3539 
	`sBUG_ON
(!
	`li¡_em±y
(&
tgt_dev
->
thr_d©a_li¡
));

3541 
	`kmem_ÿche_ä“
(
sc¡_tgtd_ÿch•
, 
tgt_dev
);

3543 
	`TRACE_EXIT
();

3545 
	}
}

3548 
	$sc¡_£ss_®loc_tgt_devs
(
sc¡_£ssiÚ
 *
£ss
)

3550 
»s
 = 0;

3551 
sc¡_acg_dev
 *
acg_dev
;

3552 
sc¡_tgt_dev
 *
tgt_dev
;

3554 
	`TRACE_ENTRY
();

3556 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
£ss
->
acg
->
acg_dev_li¡
,

3557 
acg_dev_li¡_’Œy
) {

3558 
»s
 = 
	`sc¡_®loc_add_tgt_dev
(
£ss
, 
acg_dev
, &
tgt_dev
);

3559 ià(
»s
 =ð-
EPERM
)

3561 ià(
»s
 != 0)

3562 
out_ä“
;

3565 
out
:

3566 
	`TRACE_EXIT
();

3567  
»s
;

3569 
out_ä“
:

3570 
	`sc¡_£ss_ä“_tgt_devs
(
£ss
);

3571 
out
;

3572 
	}
}

3578 
	$sc¡_£ss_ä“_tgt_devs
(
sc¡_£ssiÚ
 *
£ss
)

3580 
i
;

3581 
sc¡_tgt_dev
 *
tgt_dev
, *
t
;

3583 
	`TRACE_ENTRY
();

3586 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

3587 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

3588 
	`li¡_fÜ_—ch_’Œy_§ã
(
tgt_dev
, 
t
, 
h—d
,

3589 
£ss_tgt_dev_li¡_’Œy
) {

3590 
	`sc¡_ä“_tgt_dev
(
tgt_dev
);

3592 
	`INIT_LIST_HEAD
(
h—d
);

3595 
	`TRACE_EXIT
();

3597 
	}
}

3600 
	$sc¡_acg_add_aú
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
)

3602 
»s
 = 0;

3603 
sc¡_aú
 *
aú
;

3604 *
nm
;

3606 
	`TRACE_ENTRY
();

3608 
	`li¡_fÜ_—ch_’Œy
(
aú
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

3609 ià(
	`¡rcmp
(
aú
->
Çme
,‚ame) == 0) {

3610 
	`PRINT_ERROR
("Name %s‡lreadyƒxists in group %s",

3611 
Çme
, 
acg
->
acg_Çme
);

3612 
»s
 = -
EEXIST
;

3613 
out
;

3617 
aú
 = 
	`kz®loc
((*aú), 
GFP_KERNEL
);

3618 ià(
aú
 =ð
NULL
) {

3619 
	`PRINT_ERROR
("%s", "Unableo‡llocate scst_acn");

3620 
»s
 = -
ENOMEM
;

3621 
out
;

3624 
aú
->
acg
 =‡cg;

3626 
nm
 = 
	`k¡rdup
(
Çme
, 
GFP_KERNEL
);

3627 ià(
nm
 =ð
NULL
) {

3628 
	`PRINT_ERROR
("%s", "Unableo‡llocate scst_acn->name");

3629 
»s
 = -
ENOMEM
;

3630 
out_ä“
;

3632 
aú
->
Çme
 = 
nm
;

3634 
»s
 = 
	`sc¡_aú_sysfs_ü—‹
(
aú
);

3635 ià(
»s
 != 0)

3636 
out_ä“_nm
;

3638 
	`li¡_add_ž
(&
aú
->
aú_li¡_’Œy
, &
acg
->
aú_li¡
);

3640 
out
:

3641 ià(
»s
 == 0) {

3642 
	`PRINT_INFO
("Added‚am% tØgrou°%s", 
Çme
, 
acg
->
acg_Çme
);

3643 
	`sc¡_check_»assign_£ssiÚs
();

3646 
	`TRACE_EXIT_RES
(
»s
);

3647  
»s
;

3649 
out_ä“_nm
:

3650 
	`kä“
(
nm
);

3652 
out_ä“
:

3653 
	`kä“
(
aú
);

3654 
out
;

3655 
	}
}

3658 
	$sc¡_d–_ä“_aú
(
sc¡_aú
 *
aú
, 
boÞ
 
»assign
)

3660 
	`TRACE_ENTRY
();

3662 
	`li¡_d–
(&
aú
->
aú_li¡_’Œy
);

3664 
	`sc¡_aú_sysfs_d–
(
aú
);

3666 
	`kä“
(
aú
->
Çme
);

3667 
	`kä“
(
aú
);

3669 ià(
»assign
)

3670 
	`sc¡_check_»assign_£ssiÚs
();

3672 
	`TRACE_EXIT
();

3674 
	}
}

3677 
sc¡_aú
 *
	$sc¡_fšd_aú
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
)

3679 
sc¡_aú
 *
aú
;

3681 
	`TRACE_ENTRY
();

3683 
	`TRACE_DBG
("TryšgØfšd‚am'%s'", 
Çme
);

3685 
	`li¡_fÜ_—ch_’Œy
(
aú
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

3686 ià(
	`¡rcmp
(
aú
->
Çme
,‚ame) == 0) {

3687 
	`TRACE_DBG
("%s", "Found");

3688 
out
;

3691 
aú
 = 
NULL
;

3692 
out
:

3693 
	`TRACE_EXIT
();

3694  
aú
;

3695 
	}
}

3697 #ifdeà
CONFIG_SCST_PROC


3699 
	$sc¡_acg_»move_Çme
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
, 
boÞ
 
»assign
)

3701 
»s
 = -
EINVAL
;

3702 
sc¡_aú
 *
aú
;

3704 
	`TRACE_ENTRY
();

3706 
	`li¡_fÜ_—ch_’Œy
(
aú
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

3707 ià(
	`¡rcmp
(
aú
->
Çme
,‚ame) == 0) {

3708 
	`sc¡_d–_ä“_aú
(
aú
, 
çl£
);

3709 
»s
 = 0;

3714 ià(
»s
 == 0) {

3715 
	`PRINT_INFO
("Removed‚am'%s' from grou°'%s'", 
Çme
,

3716 
acg
->
acg_Çme
);

3717 ià(
»assign
)

3718 
	`sc¡_check_»assign_£ssiÚs
();

3720 
	`PRINT_ERROR
("UÇbËØfšd‚am'%s' iÀgrou°'%s'", 
Çme
,

3721 
acg
->
acg_Çme
);

3723 
	`TRACE_EXIT_RES
(
»s
);

3724  
»s
;

3725 
	}
}

3728 
sc¡_cmd
 *
	$sc¡_ü—‹_´•¬e_š‹º®_cmd
(

3729 
sc¡_cmd
 *
Üig_cmd
, cÚ¡ 
ušt8_t
 *
cdb
,

3730 
cdb_Ën
, 
bufsize
)

3732 
sc¡_cmd
 *
»s
;

3733 
rc
;

3734 
gå_t
 
gå_mask
 = 
	`sc¡_cmd_©omic
(
Üig_cmd
è? 
GFP_ATOMIC
 : 
GFP_KERNEL
;

3736 
	`TRACE_ENTRY
();

3738 
»s
 = 
	`sc¡_®loc_cmd
(
cdb
, 
cdb_Ën
, 
gå_mask
);

3739 ià(
»s
 =ð
NULL
)

3740 
out
;

3742 
»s
->
cmd_th»ads
 = 
Üig_cmd
->cmd_threads;

3743 
»s
->
£ss
 = 
Üig_cmd
->sess;

3744 
»s
->
©omic
 = 
	`sc¡_cmd_©omic
(
Üig_cmd
);

3745 
»s
->
š‹º®
 = 1;

3746 
»s
->
tg‰
 = 
Üig_cmd
->tgtt;

3747 
»s
->
tgt
 = 
Üig_cmd
->tgt;

3748 
»s
->
dev
 = 
Üig_cmd
->dev;

3749 
»s
->
tgt_dev
 = 
Üig_cmd
->tgt_dev;

3750 
»s
->
cur_Üd”_d©a
 = 
Üig_cmd
->
tgt_dev
->
cu¼_Üd”_d©a
;

3751 
»s
->
lun
 = 
Üig_cmd
->lun;

3752 
»s
->
queue_ty³
 = 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
;

3753 
»s
->
d©a_dœeùiÚ
 = 
SCST_DATA_UNKNOWN
;

3754 
»s
->
Üig_cmd
 = orig_cmd;

3755 
»s
->
bufæ’
 = 
bufsize
;

3757 
	`sc¡_£ss_g‘
(
»s
->
£ss
);

3758 ià(
»s
->
tgt_dev
 !ð
NULL
)

3759 
»s
->
ýu_cmd_couÁ”
 = 
	`sc¡_g‘
();

3761 
rc
 = 
	`sc¡_´e_·r£
(
»s
);

3762 
	`sBUG_ON
(
rc
 != 0);

3764 
»s
->
¡©e
 = 
SCST_CMD_STATE_PARSE
;

3766 
out
:

3767 
	`TRACE_EXIT_HRES
(()
»s
);

3768  
»s
;

3769 
	}
}

3771 
	$sc¡_´•¬e_»que¡_£n£
(
sc¡_cmd
 *
Üig_cmd
)

3773 
»s
 = 0;

3774 cÚ¡ 
ušt8_t
 
»que¡_£n£
[6] = {

3775 
REQUEST_SENSE
, 0, 0, 0, 
SCST_SENSE_BUFFERSIZE
, 0

3777 
sc¡_cmd
 *
rs_cmd
;

3779 
	`TRACE_ENTRY
();

3781 ià(
Üig_cmd
->
£n£
 !ð
NULL
) {

3782 
	`TRACE_MEM
("Releasing sense %p (orig_cmd %p)",

3783 
Üig_cmd
->
£n£
, orig_cmd);

3784 
	`mempoÞ_ä“
(
Üig_cmd
->
£n£
, 
sc¡_£n£_mempoÞ
);

3785 
Üig_cmd
->
£n£
 = 
NULL
;

3788 
rs_cmd
 = 
	`sc¡_ü—‹_´•¬e_š‹º®_cmd
(
Üig_cmd
,

3789 
»que¡_£n£
, (request_sense),

3790 
SCST_SENSE_BUFFERSIZE
);

3791 ià(
rs_cmd
 =ð
NULL
)

3792 
out_”rÜ
;

3794 
rs_cmd
->
cdb
[1] |ð
	`sc¡_g‘_cmd_dev_d_£n£
(
Üig_cmd
);

3795 
rs_cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_READ
;

3796 
rs_cmd
->
ex³ùed_d©a_dœeùiÚ
 =„s_cmd->
d©a_dœeùiÚ
;

3797 
rs_cmd
->
ex³ùed_Œªsãr_Ën
 = 
SCST_SENSE_BUFFERSIZE
;

3798 
rs_cmd
->
ex³ùed_v®ues_£t
 = 1;

3800 
	`TRACE_MGMT_DBG
("Adding REQUEST SENSE cmd %po head of‡ctive "

3801 "cmd†i¡", 
rs_cmd
);

3802 
	`¥š_lock_œq
(&
rs_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

3803 
	`li¡_add
(&
rs_cmd
->
cmd_li¡_’Œy
, &rs_cmd->
cmd_th»ads
->
aùive_cmd_li¡
);

3804 
	`wake_up
(&
rs_cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

3805 
	`¥š_uÆock_œq
(&
rs_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

3807 
out
:

3808 
	`TRACE_EXIT_RES
(
»s
);

3809  
»s
;

3811 
out_”rÜ
:

3812 
»s
 = -1;

3813 
out
;

3814 
	}
}

3816 
	$sc¡_com¶‘e_»que¡_£n£
(
sc¡_cmd
 *
»q_cmd
)

3818 
sc¡_cmd
 *
Üig_cmd
 = 
»q_cmd
->orig_cmd;

3819 
ušt8_t
 *
buf
;

3820 
Ën
;

3822 
	`TRACE_ENTRY
();

3824 
	`sBUG_ON
(
Üig_cmd
 =ð
NULL
);

3826 
Ën
 = 
	`sc¡_g‘_buf_fuÎ
(
»q_cmd
, &
buf
);

3828 ià(
	`scsi_¡©us_is_good
(
»q_cmd
->
¡©us
è&& (
Ën
 > 0) &&

3829 
	`SCST_SENSE_VALID
(
buf
è&& (!
	`SCST_NO_SENSE
(buf))) {

3830 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "REQUEST SENSE„eturned",

3831 
buf
, 
Ën
);

3832 
	`sc¡_®loc_£t_£n£
(
Üig_cmd
, 
	`sc¡_cmd_©omic
(
»q_cmd
), 
buf
,

3833 
Ën
);

3835 
	`PRINT_ERROR
("%s", "Unableo gethe sense via "

3837 
	`sc¡_£t_cmd_”rÜ
(
Üig_cmd
,

3838 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3841 ià(
Ën
 > 0)

3842 
	`sc¡_put_buf_fuÎ
(
»q_cmd
, 
buf
);

3844 
	`TRACE_MGMT_DBG
("Adding orig cmd %po head of‡ctive "

3845 "cmd†i¡", 
Üig_cmd
);

3846 
	`¥š_lock_œq
(&
Üig_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

3847 
	`li¡_add
(&
Üig_cmd
->
cmd_li¡_’Œy
, &Üig_cmd->
cmd_th»ads
->
aùive_cmd_li¡
);

3848 
	`wake_up
(&
Üig_cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

3849 
	`¥š_uÆock_œq
(&
Üig_cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

3851 
	`TRACE_EXIT
();

3853 
	}
}

3855 
	$sc¡_fšish_š‹º®_cmd
(
sc¡_cmd
 *
cmd
)

3857 
»s
;

3859 
	`TRACE_ENTRY
();

3861 
	`sBUG_ON
(!
cmd
->
š‹º®
);

3863 ià(
cmd
->
cdb
[0] =ð
REQUEST_SENSE
)

3864 
	`sc¡_com¶‘e_»que¡_£n£
(
cmd
);

3866 
	`__sc¡_cmd_put
(
cmd
);

3868 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

3870 
	`TRACE_EXIT_HRES
(
»s
);

3871  
»s
;

3872 
	}
}

3874 
	$sc¡_£nd_»Ëa£
(
sc¡_deviû
 *
dev
)

3876 
scsi_deviû
 *
scsi_dev
;

3877 
cdb
[6];

3878 
ušt8_t
 
£n£
[
SCSI_SENSE_BUFFERSIZE
];

3879 
rc
, 
i
;

3881 
	`TRACE_ENTRY
();

3883 ià(
dev
->
scsi_dev
 =ð
NULL
)

3884 
out
;

3886 
scsi_dev
 = 
dev
->scsi_dev;

3888 
i
 = 0; i < 5; i++) {

3889 
	`mem£t
(
cdb
, 0, (cdb));

3890 
cdb
[0] = 
RELEASE
;

3891 
cdb
[1] = (
scsi_dev
->
scsi_Ëv–
 <ð
SCSI_2
) ?

3892 ((
scsi_dev
->
lun
 << 5) & 0xe0) : 0;

3894 
	`mem£t
(
£n£
, 0, (sense));

3896 
	`TRACE
(
TRACE_DEBUG
 | 
TRACE_SCSI
, "%s", "Sending RELEASE„eqo "

3898 
rc
 = 
	`scsi_execu‹
(
scsi_dev
, 
cdb
, 
SCST_DATA_NONE
, 
NULL
, 0,

3899 
£n£
, 15, 0, 0

3900 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2,6,29)

3901 , 
NULL


3904 
	`TRACE_DBG
("MODE_SENSE dÚe: %x", 
rc
);

3906 ià(
	`scsi_¡©us_is_good
(
rc
)) {

3909 
	`PRINT_ERROR
("RELEASE fažed: %d", 
rc
);

3910 
	`PRINT_BUFFER
("RELEASE s’£", 
£n£
, (sense));

3911 
	`sc¡_check_š‹º®_£n£
(
dev
, 
rc
, 
£n£
,

3912 (
£n£
));

3916 
out
:

3917 
	`TRACE_EXIT
();

3919 
	}
}

3922 
	$sc¡_þ—r_»£rv©iÚ
(
sc¡_tgt_dev
 *
tgt_dev
)

3924 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

3925 
»Ëa£
 = 0;

3927 
	`TRACE_ENTRY
();

3929 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

3930 ià(
dev
->
dev_»£rved
 &&

3931 !
	`‹¡_b™
(
SCST_TGT_DEV_RESERVED
, &
tgt_dev
->
tgt_dev_æags
)) {

3933 
sc¡_tgt_dev
 *
tgt_dev_tmp
;

3934 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev_tmp
, &
dev
->
dev_tgt_dev_li¡
,

3935 
dev_tgt_dev_li¡_’Œy
) {

3936 
	`þ—r_b™
(
SCST_TGT_DEV_RESERVED
,

3937 &
tgt_dev_tmp
->
tgt_dev_æags
);

3939 
dev
->
dev_»£rved
 = 0;

3940 
»Ëa£
 = 1;

3942 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

3944 ià(
»Ëa£
)

3945 
	`sc¡_£nd_»Ëa£
(
dev
);

3947 
	`TRACE_EXIT
();

3949 
	}
}

3951 
sc¡_£ssiÚ
 *
	$sc¡_®loc_£ssiÚ
(
sc¡_tgt
 *
tgt
, 
gå_t
 
gå_mask
,

3952 cÚ¡ *
š™ŸtÜ_Çme
)

3954 
sc¡_£ssiÚ
 *
£ss
;

3955 
i
;

3957 
	`TRACE_ENTRY
();

3959 
£ss
 = 
	`kmem_ÿche_z®loc
(
sc¡_£ss_ÿch•
, 
gå_mask
);

3960 ià(
£ss
 =ð
NULL
) {

3961 
	`PRINT_ERROR
("%s", "Allocation of scst_session failed");

3962 
out
;

3965 
£ss
->
š™_pha£
 = 
SCST_SESS_IPH_INITING
;

3966 
£ss
->
shut_pha£
 = 
SCST_SESS_SPH_READY
;

3967 
	`©omic_£t
(&
£ss
->
»fút
, 0);

3968 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

3969 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

3970 
	`INIT_LIST_HEAD
(
h—d
);

3972 
	`¥š_lock_š™
(&
£ss
->
£ss_li¡_lock
);

3973 
	`INIT_LIST_HEAD
(&
£ss
->
£ss_cmd_li¡
);

3974 
£ss
->
tgt
 =gt;

3975 
	`INIT_LIST_HEAD
(&
£ss
->
š™_deã¼ed_cmd_li¡
);

3976 
	`INIT_LIST_HEAD
(&
£ss
->
š™_deã¼ed_mcmd_li¡
);

3977 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 20))

3978 
	`INIT_DELAYED_WORK
(&
£ss
->
hw_³ndšg_wÜk
,

3979 ((*)(
wÜk_¡ruù
 *))
sc¡_hw_³ndšg_wÜk_â
);

3981 
	`INIT_WORK
(&
£ss
->
hw_³ndšg_wÜk
, 
sc¡_hw_³ndšg_wÜk_â
, sess);

3984 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


3985 
	`¥š_lock_š™
(&
£ss
->
Ït_lock
);

3988 
£ss
->
š™ŸtÜ_Çme
 = 
	`k¡rdup
(š™ŸtÜ_Çme, 
gå_mask
);

3989 ià(
£ss
->
š™ŸtÜ_Çme
 =ð
NULL
) {

3990 
	`PRINT_ERROR
("%s", "Unableo dup sess->initiator_name");

3991 
out_ä“
;

3994 
out
:

3995 
	`TRACE_EXIT
();

3996  
£ss
;

3998 
out_ä“
:

3999 
	`kmem_ÿche_ä“
(
sc¡_£ss_ÿch•
, 
£ss
);

4000 
£ss
 = 
NULL
;

4001 
out
;

4002 
	}
}

4004 
	$sc¡_ä“_£ssiÚ
(
sc¡_£ssiÚ
 *
£ss
)

4006 
	`TRACE_ENTRY
();

4008 
	`mu‹x_lock
(&
sc¡_mu‹x
);

4010 
	`sc¡_£ss_ä“_tgt_devs
(
£ss
);

4012 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4014 #iâdeà
CONFIG_SCST_PROC


4015 
	`sc¡_£ss_sysfs_d–
(
£ss
);

4017 ià(
£ss
->
uÄeg_dÚe_â
) {

4018 
	`TRACE_DBG
("C®lšg uÄeg_dÚe_â(%p)", 
£ss
);

4019 
£ss
->
	`uÄeg_dÚe_â
(sess);

4020 
	`TRACE_DBG
("%s", "unreg_done_fn()„eturned");

4023 
	`mu‹x_lock
(&
sc¡_mu‹x
);

4030 
	`TRACE_DBG
("Removšg ses %°äomhli¡", 
£ss
);

4031 
	`li¡_d–
(&
£ss
->
£ss_li¡_’Œy
);

4032 
	`TRACE_DBG
("Removšg sessiÚ %°äom‡cg %s", 
£ss
, sess->
acg
->
acg_Çme
);

4033 
	`li¡_d–
(&
£ss
->
acg_£ss_li¡_’Œy
);

4036 
	`wake_up_®l
(&
£ss
->
tgt
->
uÄeg_wa™Q
);

4042 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4044 
	`kä“
(
£ss
->
Œª¥Üt_id
);

4045 
	`kä“
(
£ss
->
š™ŸtÜ_Çme
);

4047 
	`kmem_ÿche_ä“
(
sc¡_£ss_ÿch•
, 
£ss
);

4049 
	`TRACE_EXIT
();

4051 
	}
}

4053 
	$sc¡_ä“_£ssiÚ_ÿÎback
(
sc¡_£ssiÚ
 *
£ss
)

4055 
com¶‘iÚ
 *
c
;

4057 
	`TRACE_ENTRY
();

4059 
	`TRACE_DBG
("F»ešg sessiÚ %p", 
£ss
);

4061 
	`ÿnûl_d–ayed_wÜk_sync
(&
£ss
->
hw_³ndšg_wÜk
);

4063 
c
 = 
£ss
->
shutdown_com¶
;

4065 
	`mu‹x_lock
(&
sc¡_mu‹x
);

4071 
£ss
->
shut_pha£
 = 
SCST_SESS_SPH_UNREG_DONE_CALLING
;

4072 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4074 
	`sc¡_ä“_£ssiÚ
(
£ss
);

4076 ià(
c
)

4077 
	`com¶‘e_®l
(
c
);

4079 
	`TRACE_EXIT
();

4081 
	}
}

4083 
	$sc¡_sched_£ssiÚ_ä“
(
sc¡_£ssiÚ
 *
£ss
)

4085 
æags
;

4087 
	`TRACE_ENTRY
();

4089 ià(
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_SHUTDOWN
) {

4090 
	`PRINT_CRIT_ERROR
("session %p is goingo shutdown with unknown "

4091 "shuˆpha£ %lx", 
£ss
, sess->
shut_pha£
);

4092 
	`sBUG
();

4095 
	`¥š_lock_œq§ve
(&
sc¡_mgmt_lock
, 
æags
);

4096 
	`TRACE_DBG
("Addšg ses %°tØsc¡_£ss_shut_li¡", 
£ss
);

4097 
	`li¡_add_ž
(&
£ss
->
£ss_shut_li¡_’Œy
, &
sc¡_£ss_shut_li¡
);

4098 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mgmt_lock
, 
æags
);

4100 
	`wake_up
(&
sc¡_mgmt_wa™Q
);

4102 
	`TRACE_EXIT
();

4104 
	}
}

4109 
	$sc¡_cmd_g‘
(
sc¡_cmd
 *
cmd
)

4111 
	`__sc¡_cmd_g‘
(
cmd
);

4112 
	}
}

4113 
EXPORT_SYMBOL
(
sc¡_cmd_g‘
);

4118 
	$sc¡_cmd_put
(
sc¡_cmd
 *
cmd
)

4120 
	`__sc¡_cmd_put
(
cmd
);

4121 
	}
}

4122 
EXPORT_SYMBOL
(
sc¡_cmd_put
);

4127 
	$sc¡_cmd_£t_ext_cdb
(
sc¡_cmd
 *
cmd
,

4128 
ušt8_t
 *
ext_cdb
, 
ext_cdb_Ën
,

4129 
gå_t
 
gå_mask
)

4131 
Ën
 = 
cmd
->
cdb_Ën
 + 
ext_cdb_Ën
;

4133 
	`TRACE_ENTRY
();

4135 ià(
Ën
 <ð(
cmd
->
cdb_buf
))

4136 
cÝy
;

4138 ià(
	`uÆik–y
(
Ën
 > 
SCST_MAX_LONG_CDB_SIZE
)) {

4139 
	`PRINT_ERROR
("ToØbig CDB (%d)", 
Ën
);

4140 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

4141 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

4142 
out
;

4145 
cmd
->
cdb
 = 
	`km®loc
(
Ën
, 
gå_mask
);

4146 ià(
	`uÆik–y
(
cmd
->
cdb
 =ð
NULL
)) {

4147 
	`PRINT_ERROR
("UÇbËØ®loøex‹nded CDB (siz%d)", 
Ën
);

4148 
out_”r
;

4151 
	`memýy
(
cmd
->
cdb
, cmd->
cdb_buf
, cmd->
cdb_Ën
);

4153 
cÝy
:

4154 
	`memýy
(&
cmd
->
cdb
[cmd->
cdb_Ën
], 
ext_cdb
, 
ext_cdb_Ën
);

4156 
cmd
->
cdb_Ën
 = cmd->cdb_ËÀ+ 
ext_cdb_Ën
;

4158 
out
:

4159 
	`TRACE_EXIT
();

4162 
out_”r
:

4163 
cmd
->
cdb
 = cmd->
cdb_buf
;

4164 
	`sc¡_£t_busy
(
cmd
);

4165 
out
;

4166 
	}
}

4167 
EXPORT_SYMBOL
(
sc¡_cmd_£t_ext_cdb
);

4169 
sc¡_cmd
 *
	$sc¡_®loc_cmd
(cÚ¡ 
ušt8_t
 *
cdb
,

4170 
cdb_Ën
, 
gå_t
 
gå_mask
)

4172 
sc¡_cmd
 *
cmd
;

4174 
	`TRACE_ENTRY
();

4176 
cmd
 = 
	`kmem_ÿche_z®loc
(
sc¡_cmd_ÿch•
, 
gå_mask
);

4177 ià(
cmd
 =ð
NULL
) {

4178 
	`TRACE
(
TRACE_OUT_OF_MEM
, "%s", "Allocation of scst_cmd failed");

4179 
out
;

4182 
cmd
->
¡©e
 = 
SCST_CMD_STATE_INIT_WAIT
;

4183 
cmd
->
¡¬t_time
 = 
jiff›s
;

4184 
	`©omic_£t
(&
cmd
->
cmd_»f
, 1);

4185 
cmd
->
cmd_th»ads
 = &
sc¡_maš_cmd_th»ads
;

4186 
	`INIT_LIST_HEAD
(&
cmd
->
mgmt_cmd_li¡
);

4187 
cmd
->
cdb
 = cmd->
cdb_buf
;

4188 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_SIMPLE
;

4189 
cmd
->
timeout
 = 
SCST_DEFAULT_TIMEOUT
;

4190 
cmd
->
»Œ›s
 = 0;

4191 
cmd
->
d©a_Ën
 = -1;

4192 
cmd
->
is_£nd_¡©us
 = 1;

4193 
cmd
->
»¥_d©a_Ën
 = -1;

4194 
cmd
->
wr™e_sg
 = &cmd->
sg
;

4195 
cmd
->
wr™e_sg_út
 = &cmd->
sg_út
;

4197 
cmd
->
dbl_ua_Üig_d©a_dœeùiÚ
 = 
SCST_DATA_UNKNOWN
;

4198 
cmd
->
dbl_ua_Üig_»¥_d©a_Ën
 = -1;

4200 ià(
	`uÆik–y
(
cdb_Ën
 == 0)) {

4201 
	`PRINT_ERROR
("%s", "Wrong CDB†en 0, finishing cmd");

4202 
out_ä“
;

4203 } ià(
cdb_Ën
 <ð
SCST_MAX_CDB_SIZE
) {

4205 
	`memýy
(
cmd
->
cdb
, cdb, 
cdb_Ën
);

4207 ià(
	`uÆik–y
(
cdb_Ën
 > 
SCST_MAX_LONG_CDB_SIZE
)) {

4208 
	`PRINT_ERROR
("ToØbig CDB (%d), fšishšg cmd", 
cdb_Ën
);

4209 
out_ä“
;

4211 
cmd
->
cdb
 = 
	`km®loc
(
cdb_Ën
, 
gå_mask
);

4212 ià(
	`uÆik–y
(
cmd
->
cdb
 =ð
NULL
)) {

4213 
	`PRINT_ERROR
("Unableo‡llocƒxtended CDB (size %d)",

4214 
cdb_Ën
);

4215 
out_ä“
;

4217 
	`memýy
(
cmd
->
cdb
, cdb, 
cdb_Ën
);

4220 
cmd
->
cdb_Ën
 = cdb_len;

4222 
out
:

4223 
	`TRACE_EXIT
();

4224  
cmd
;

4226 
out_ä“
:

4227 
	`kmem_ÿche_ä“
(
sc¡_cmd_ÿch•
, 
cmd
);

4228 
cmd
 = 
NULL
;

4229 
out
;

4230 
	}
}

4232 
	$sc¡_de¡roy_put_cmd
(
sc¡_cmd
 *
cmd
)

4234 
	`sc¡_£ss_put
(
cmd
->
£ss
);

4239 ià(
	`lik–y
(
cmd
->
tgt_dev
 !ð
NULL
))

4240 
	`sc¡_put
(
cmd
->
ýu_cmd_couÁ”
);

4242 
	`sc¡_de¡roy_cmd
(
cmd
);

4244 
	}
}

4247 
	$sc¡_ä“_cmd
(
sc¡_cmd
 *
cmd
)

4249 
de¡roy
 = 1;

4251 
	`TRACE_ENTRY
();

4253 
	`TRACE_DBG
("Freeing cmd %p (tag %llu)",

4254 
cmd
, ()cmd->
g
);

4256 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)))

4257 
	`TRACE_MGMT_DBG
("F»ešg‡bÜ‹d cmd %p", 
cmd
);

4259 
	`EXTRACHECKS_BUG_ON
(
cmd
->
unblock_dev
 || cmd->
dec_Ú_dev_Ãeded
 ||

4260 
cmd
->
dec_´_»ad”s_couÁ_Ãeded
);

4266 ià(!
cmd
->
tgt_d©a_buf_®loûd
)

4267 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

4269 ià((
cmd
->
tg‰
->
Ú_ä“_cmd
 !ð
NULL
è&& 
	`lik–y
(!cmd->
š‹º®
)) {

4270 
	`TRACE_DBG
("C®lšg¬g‘' Ú_ä“_cmd(%p)", 
cmd
);

4271 
	`sc¡_£t_cur_¡¬t
(
cmd
);

4272 
cmd
->
tg‰
->
	`Ú_ä“_cmd
(cmd);

4273 
	`sc¡_£t_tgt_Ú_ä“_time
(
cmd
);

4274 
	`TRACE_DBG
("%s", "Target's on_free_cmd()„eturned");

4277 ià(
	`lik–y
(
cmd
->
dev
 !ð
NULL
)) {

4278 
sc¡_dev_ty³
 *
hªdËr
 = 
cmd
->
dev
->handler;

4279 ià(
hªdËr
->
Ú_ä“_cmd
 !ð
NULL
) {

4280 
	`TRACE_DBG
("Calling dev handler %s on_free_cmd(%p)",

4281 
hªdËr
->
Çme
, 
cmd
);

4282 
	`sc¡_£t_cur_¡¬t
(
cmd
);

4283 
hªdËr
->
	`Ú_ä“_cmd
(
cmd
);

4284 
	`sc¡_£t_dev_Ú_ä“_time
(
cmd
);

4285 
	`TRACE_DBG
("Dev handler %s on_free_cmd()„eturned",

4286 
hªdËr
->
Çme
);

4290 
	`sc¡_»Ëa£_¥aû
(
cmd
);

4292 ià(
	`uÆik–y
(
cmd
->
£n£
 !ð
NULL
)) {

4293 
	`TRACE_MEM
("R–—sšg s’£ %°(cmd %p)", 
cmd
->
£n£
, cmd);

4294 
	`mempoÞ_ä“
(
cmd
->
£n£
, 
sc¡_£n£_mempoÞ
);

4295 
cmd
->
£n£
 = 
NULL
;

4298 ià(
	`lik–y
(
cmd
->
tgt_dev
 !ð
NULL
)) {

4299 #ifdeà
CONFIG_SCST_EXTRACHECKS


4300 ià(
	`uÆik–y
(!
cmd
->
£Á_fÜ_exec
è&& !cmd->
š‹º®
) {

4301 
	`PRINT_ERROR
("Finishing‚otƒxecuted cmd %p (opcode "

4303 
cmd
, cmd->
cdb
[0], cmd->
tg‰
->
Çme
,

4304 ()
cmd
->
lun
,

4305 
cmd
->
¢
, cmd->
cur_Üd”_d©a
->
ex³ùed_¢
);

4306 
	`sc¡_unblock_deã¼ed
(
cmd
->
cur_Üd”_d©a
, cmd);

4310 ià(
	`uÆik–y
(
cmd
->
out_of_¢
)) {

4311 
	`TRACE_SN
("Out of SN cmd %p (tag %llu, sn %d), "

4312 "de¡roy=%d", 
cmd
,

4313 ()
cmd
->
g
,

4314 
cmd
->
¢
, 
de¡roy
);

4315 
de¡roy
 = 
	`‹¡_ªd_£t_b™
(
SCST_CMD_CAN_BE_DESTROYED
,

4316 &
cmd
->
cmd_æags
);

4320 ià(
cmd
->
cdb
 !ðcmd->
cdb_buf
)

4321 
	`kä“
(
cmd
->
cdb
);

4323 ià(
	`lik–y
(
de¡roy
))

4324 
	`sc¡_de¡roy_put_cmd
(
cmd
);

4326 
	`TRACE_EXIT
();

4328 
	}
}

4331 
	$sc¡_check_»Œ›s
(
sc¡_tgt
 *
tgt
)

4333 
Ãed_wake_up
 = 0;

4335 
	`TRACE_ENTRY
();

4341 
	`©omic_šc
(&
tgt
->
fšished_cmds
);

4343 
	`smp_mb__aá”_©omic_šc
();

4344 ià(
	`uÆik–y
(
tgt
->
»Œy_cmds
 > 0)) {

4345 
sc¡_cmd
 *
c
, *
tc
;

4346 
æags
;

4348 
	`TRACE_RETRY
("Checking„etry cmd†ist (retry_cmds %d)",

4349 
tgt
->
»Œy_cmds
);

4351 
	`¥š_lock_œq§ve
(&
tgt
->
tgt_lock
, 
æags
);

4352 
	`li¡_fÜ_—ch_’Œy_§ã
(
c
, 
tc
, &
tgt
->
»Œy_cmd_li¡
,

4353 
cmd_li¡_’Œy
) {

4354 
tgt
->
»Œy_cmds
--;

4356 
	`TRACE_RETRY
("Moving„etry cmd %po head of‡ctive "

4358 
c
, 
tgt
->
»Œy_cmds
);

4359 
	`¥š_lock
(&
c
->
cmd_th»ads
->
cmd_li¡_lock
);

4360 
	`li¡_move
(&
c
->
cmd_li¡_’Œy
,

4361 &
c
->
cmd_th»ads
->
aùive_cmd_li¡
);

4362 
	`wake_up
(&
c
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

4363 
	`¥š_uÆock
(&
c
->
cmd_th»ads
->
cmd_li¡_lock
);

4365 
Ãed_wake_up
++;

4366 ià(
Ãed_wake_up
 >= 2)

4369 
	`¥š_uÆock_œq»¡Üe
(&
tgt
->
tgt_lock
, 
æags
);

4372 
	`TRACE_EXIT
();

4374 
	}
}

4376 
	$sc¡_tgt_»Œy_tim”_â
(
¬g
)

4378 
sc¡_tgt
 *
tgt
 = (sc¡_tgˆ*)
¬g
;

4379 
æags
;

4381 
	`TRACE_RETRY
("R‘ryim”ƒxpœed (»Œy_cmd %d)", 
tgt
->
»Œy_cmds
);

4383 
	`¥š_lock_œq§ve
(&
tgt
->
tgt_lock
, 
æags
);

4384 
tgt
->
»Œy_tim”_aùive
 = 0;

4385 
	`¥š_uÆock_œq»¡Üe
(&
tgt
->
tgt_lock
, 
æags
);

4387 
	`sc¡_check_»Œ›s
(
tgt
);

4389 
	`TRACE_EXIT
();

4391 
	}
}

4393 
sc¡_mgmt_cmd
 *
	$sc¡_®loc_mgmt_cmd
(
gå_t
 
gå_mask
)

4395 
sc¡_mgmt_cmd
 *
mcmd
;

4397 
	`TRACE_ENTRY
();

4399 
mcmd
 = 
	`mempoÞ_®loc
(
sc¡_mgmt_mempoÞ
, 
gå_mask
);

4400 ià(
mcmd
 =ð
NULL
) {

4401 
	`PRINT_CRIT_ERROR
("%s", "Allocation of management command "

4403 
out
;

4405 
	`mem£t
(
mcmd
, 0, (*mcmd));

4407 
out
:

4408 
	`TRACE_EXIT
();

4409  
mcmd
;

4410 
	}
}

4412 
	$sc¡_ä“_mgmt_cmd
(
sc¡_mgmt_cmd
 *
mcmd
)

4414 
æags
;

4416 
	`TRACE_ENTRY
();

4418 
	`¥š_lock_œq§ve
(&
mcmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

4419 
	`©omic_dec
(&
mcmd
->
£ss
->
£ss_cmd_couÁ
);

4420 
	`¥š_uÆock_œq»¡Üe
(&
mcmd
->
£ss
->
£ss_li¡_lock
, 
æags
);

4422 
	`sc¡_£ss_put
(
mcmd
->
£ss
);

4424 ià(
mcmd
->
mcmd_tgt_dev
 !ð
NULL
)

4425 
	`sc¡_put
(
mcmd
->
ýu_cmd_couÁ”
);

4427 
	`mempoÞ_ä“
(
mcmd
, 
sc¡_mgmt_mempoÞ
);

4429 
	`TRACE_EXIT
();

4431 
	}
}

4433 
boÞ
 
	$sc¡_Ú_sg_bËsize_low
(
sc¡_cmd
 *
cmd
, 
boÞ
 
out
)

4435 
boÞ
 
»s
;

4436 
sg_út
 = 
out
 ? 
cmd
->
out_sg_út
 : cmd->sg_cnt;

4437 
Î
;

4438 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

4440 
	`TRACE_ENTRY
();

4442 ià(
sg_út
 > 
cmd
->
tgt
->
sg_bËsize
) {

4444 
çžed
;

4447 ià(
tgt_dev
->
dev
->
hªdËr
->
Ú_sg_bËsize_low
 =ð
NULL
)

4448 
çžed
;

4450 
»s
 = 
tgt_dev
->
dev
->
hªdËr
->
	`Ú_sg_bËsize_low
(
cmd
);

4452 
	`TRACE_DBG
("Ú_sg_bËsize_low(%pè»tuºed %d", 
cmd
, 
»s
);

4454 
out
:

4455 
	`TRACE_EXIT_RES
(
»s
);

4456  
»s
;

4458 
çžed
:

4459 
»s
 = 
çl£
;

4460 ià((
Î
 < 10è|| 
	`TRACING_MINOR
()) {

4461 
	`PRINT_INFO
("Unableo complete command dueo SG IO count "

4463 
out
 ? "OUT bufãr, " : "", 
cmd
->
sg_út
,

4464 
tgt_dev
->
max_sg_út
, 
cmd
->
tgt
->
sg_bËsize
);

4465 
Î
++;

4467 
out
;

4468 
	}
}

4470 
	$sc¡_®loc_¥aû
(
sc¡_cmd
 *
cmd
)

4472 
gå_t
 
gå_mask
;

4473 
»s
 = -
ENOMEM
;

4474 
©omic
 = 
	`sc¡_cmd_©omic
(
cmd
);

4475 
æags
;

4476 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

4478 
	`TRACE_ENTRY
();

4480 
gå_mask
 = 
tgt_dev
->gå_mask | (
©omic
 ? 
GFP_ATOMIC
 : 
GFP_KERNEL
);

4482 
æags
 = 
©omic
 ? 
SGV_POOL_NO_ALLOC_ON_CACHE_MISS
 : 0;

4483 ià(
cmd
->
no_sgv
)

4484 
æags
 |ð
SGV_POOL_ALLOC_NO_CACHED
;

4486 
cmd
->
sg
 = 
	`sgv_poÞ_®loc
(
tgt_dev
->
poÞ
, cmd->
bufæ’
, 
gå_mask
, 
æags
,

4487 &
cmd
->
sg_út
, &cmd->
sgv
, &cmd->
dev
->
dev_mem_lim
, 
NULL
);

4488 ià(
cmd
->
sg
 =ð
NULL
)

4489 
out
;

4491 ià(
	`uÆik–y
(
cmd
->
sg_út
 > 
tgt_dev
->
max_sg_út
))

4492 ià(!
	`sc¡_Ú_sg_bËsize_low
(
cmd
, 
çl£
))

4493 
out_sg_ä“
;

4495 ià(
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_BIDI
)

4496 
sucûss
;

4498 
cmd
->
out_sg
 = 
	`sgv_poÞ_®loc
(
tgt_dev
->
poÞ
, cmd->
out_bufæ’
, 
gå_mask
,

4499 
æags
, &
cmd
->
out_sg_út
, &cmd->
out_sgv
,

4500 &
cmd
->
dev
->
dev_mem_lim
, 
NULL
);

4501 ià(
cmd
->
out_sg
 =ð
NULL
)

4502 
out_sg_ä“
;

4504 ià(
	`uÆik–y
(
cmd
->
out_sg_út
 > 
tgt_dev
->
max_sg_út
))

4505 ià(!
	`sc¡_Ú_sg_bËsize_low
(
cmd
, 
Œue
))

4506 
out_out_sg_ä“
;

4508 
sucûss
:

4509 
»s
 = 0;

4511 
out
:

4512 
	`TRACE_EXIT
();

4513  
»s
;

4515 
out_out_sg_ä“
:

4516 
	`sgv_poÞ_ä“
(
cmd
->
out_sgv
, &cmd->
dev
->
dev_mem_lim
);

4517 
cmd
->
out_sgv
 = 
NULL
;

4518 
cmd
->
out_sg
 = 
NULL
;

4519 
cmd
->
out_sg_út
 = 0;

4521 
out_sg_ä“
:

4522 
	`sgv_poÞ_ä“
(
cmd
->
sgv
, &cmd->
dev
->
dev_mem_lim
);

4523 
cmd
->
sgv
 = 
NULL
;

4524 
cmd
->
sg
 = 
NULL
;

4525 
cmd
->
sg_út
 = 0;

4526 
out
;

4527 
	}
}

4529 
	$sc¡_»Ëa£_¥aû
(
sc¡_cmd
 *
cmd
)

4531 
	`TRACE_ENTRY
();

4533 ià(
cmd
->
sgv
 =ð
NULL
) {

4534 ià((
cmd
->
sg
 !ð
NULL
) &&

4535 !(
cmd
->
tgt_d©a_buf_®loûd
 || cmd->
dh_d©a_buf_®loûd
)) {

4536 
	`TRACE_MEM
("F»ešg sg %°fÜ cmd %°(úˆ%d)", 
cmd
->
sg
,

4537 
cmd
, cmd->
sg_út
);

4538 
	`sc¡_ä“
(
cmd
->
sg
, cmd->
sg_út
);

4539 
out_z”o
;

4541 
out
;

4544 ià(
cmd
->
tgt_d©a_buf_®loûd
 || cmd->
dh_d©a_buf_®loûd
) {

4545 
	`TRACE_MEM
("%s", "*data_buf_alloced set,„eturning");

4546 
out
;

4549 ià(
cmd
->
out_sgv
 !ð
NULL
) {

4550 
	`sgv_poÞ_ä“
(
cmd
->
out_sgv
, &cmd->
dev
->
dev_mem_lim
);

4551 
cmd
->
out_sgv
 = 
NULL
;

4552 
cmd
->
out_sg_út
 = 0;

4553 
cmd
->
out_sg
 = 
NULL
;

4554 
cmd
->
out_bufæ’
 = 0;

4557 
	`sgv_poÞ_ä“
(
cmd
->
sgv
, &cmd->
dev
->
dev_mem_lim
);

4559 
out_z”o
:

4560 
cmd
->
sgv
 = 
NULL
;

4561 
cmd
->
sg_út
 = 0;

4562 
cmd
->
sg
 = 
NULL
;

4563 
cmd
->
bufæ’
 = 0;

4564 
cmd
->
d©a_Ën
 = 0;

4566 
out
:

4567 
	`TRACE_EXIT
();

4569 
	}
}

4571 #ià!((
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)è&& 
defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)è&& !defšed(
HAVE_SG_COPY
)

4578 
	$sg_cÝy_–em
(
sÿ‰”li¡
 **
pd¡_sg
, 
size_t
 *
pd¡_Ën
,

4579 
size_t
 *
pd¡_offs
, 
sÿ‰”li¡
 *
¤c_sg
,

4580 
size_t
 
cÝy_Ën
,

4581 
km_ty³
 
d_km_ty³
, km_ty³ 
s_km_ty³
)

4583 
»s
 = 0;

4584 
sÿ‰”li¡
 *
d¡_sg
;

4585 
size_t
 
¤c_Ën
, 
d¡_Ën
, 
¤c_offs
, 
d¡_offs
;

4586 
·ge
 *
¤c_·ge
, *
d¡_·ge
;

4588 
d¡_sg
 = *
pd¡_sg
;

4589 
d¡_Ën
 = *
pd¡_Ën
;

4590 
d¡_offs
 = *
pd¡_offs
;

4591 
d¡_·ge
 = 
	`sg_·ge
(
d¡_sg
);

4593 
¤c_·ge
 = 
	`sg_·ge
(
¤c_sg
);

4594 
¤c_Ën
 = 
¤c_sg
->
Ëngth
;

4595 
¤c_offs
 = 
¤c_sg
->
off£t
;

4598 *
§ddr
, *
daddr
;

4599 
size_t
 
n
;

4601 
§ddr
 = 
	`km­_©omic
(
¤c_·ge
 +

4602 (
¤c_offs
 >> 
PAGE_SHIFT
), 
s_km_ty³
) +

4603 (
¤c_offs
 & ~
PAGE_MASK
);

4604 
daddr
 = 
	`km­_©omic
(
d¡_·ge
 +

4605 (
d¡_offs
 >> 
PAGE_SHIFT
), 
d_km_ty³
) +

4606 (
d¡_offs
 & ~
PAGE_MASK
);

4608 ià(((
¤c_offs
 & ~
PAGE_MASK
) == 0) &&

4609 ((
d¡_offs
 & ~
PAGE_MASK
) == 0) &&

4610 (
¤c_Ën
 >ð
PAGE_SIZE
è&& (
d¡_Ën
 >= PAGE_SIZE) &&

4611 (
cÝy_Ën
 >ð
PAGE_SIZE
)) {

4612 
	`cÝy_·ge
(
daddr
, 
§ddr
);

4613 
n
 = 
PAGE_SIZE
;

4615 
n
 = 
	`mš_t
(
size_t
, 
PAGE_SIZE
 - (
d¡_offs
 & ~
PAGE_MASK
),

4616 
PAGE_SIZE
 - (
¤c_offs
 & ~
PAGE_MASK
));

4617 
n
 = 
	`mš
Ò, 
¤c_Ën
);

4618 
n
 = 
	`mš
Ò, 
d¡_Ën
);

4619 
n
 = 
	`mš_t
(
size_t
,‚, 
cÝy_Ën
);

4620 
	`memýy
(
daddr
, 
§ddr
, 
n
);

4622 
d¡_offs
 +ð
n
;

4623 
¤c_offs
 +ð
n
;

4625 
	`kunm­_©omic
(
§ddr
, 
s_km_ty³
);

4626 
	`kunm­_©omic
(
daddr
, 
d_km_ty³
);

4628 
»s
 +ð
n
;

4629 
cÝy_Ën
 -ð
n
;

4630 ià(
cÝy_Ën
 == 0)

4631 
out
;

4633 
¤c_Ën
 -ð
n
;

4634 
d¡_Ën
 -ð
n
;

4635 ià(
d¡_Ën
 == 0) {

4636 
d¡_sg
 = 
	`sg_Ãxt
(dst_sg);

4637 ià(
d¡_sg
 =ð
NULL
)

4638 
out
;

4639 
d¡_·ge
 = 
	`sg_·ge
(
d¡_sg
);

4640 
d¡_Ën
 = 
d¡_sg
->
Ëngth
;

4641 
d¡_offs
 = 
d¡_sg
->
off£t
;

4643 } 
¤c_Ën
 > 0);

4645 
out
:

4646 *
pd¡_sg
 = 
d¡_sg
;

4647 *
pd¡_Ën
 = 
d¡_Ën
;

4648 *
pd¡_offs
 = 
d¡_offs
;

4649  
»s
;

4650 
	}
}

4666 
	$sg_cÝy
(
sÿ‰”li¡
 *
d¡_sg
, sÿ‰”li¡ *
¤c_sg
,

4667 
ÃÁs_to_cÝy
, 
size_t
 
cÝy_Ën
,

4668 
km_ty³
 
d_km_ty³
, km_ty³ 
s_km_ty³
)

4670 
»s
 = 0;

4671 
size_t
 
d¡_Ën
, 
d¡_offs
;

4673 ià(
cÝy_Ën
 == 0)

4674 
cÝy_Ën
 = 0x7FFFFFFF;

4676 ià(
ÃÁs_to_cÝy
 == 0)

4677 
ÃÁs_to_cÝy
 = 0x7FFFFFFF;

4679 
d¡_Ën
 = 
d¡_sg
->
Ëngth
;

4680 
d¡_offs
 = 
d¡_sg
->
off£t
;

4683 
cÝ›d
 = 
	`sg_cÝy_–em
(&
d¡_sg
, &
d¡_Ën
, &
d¡_offs
,

4684 
¤c_sg
, 
cÝy_Ën
, 
d_km_ty³
, 
s_km_ty³
);

4685 
cÝy_Ën
 -ð
cÝ›d
;

4686 
»s
 +ð
cÝ›d
;

4687 ià((
cÝy_Ën
 =ð0è|| (
d¡_sg
 =ð
NULL
))

4688 
out
;

4690 
ÃÁs_to_cÝy
--;

4691 ià(
ÃÁs_to_cÝy
 == 0)

4692 
out
;

4694 
¤c_sg
 = 
	`sg_Ãxt
(src_sg);

4695 } 
¤c_sg
 !ð
NULL
);

4697 
out
:

4698  
»s
;

4699 
	}
}

4703 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 30)è&& 
defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

4704 
	$scsi_’d_async
(
»que¡
 *
»q
, 
”rÜ
)

4706 
scsi_io_cÚ‹xt
 *
sioc
 = 
»q
->
’d_io_d©a
;

4708 
	`TRACE_DBG
("sioø%p, cmd %p", 
sioc
, sioc->
d©a
);

4710 ià(
sioc
->
dÚe
)

4711 #ià
LINUX_VERSION_CODE
 <ð
	`KERNEL_VERSION
(2, 6, 30)

4712 
sioc
->
	`dÚe
(sioc->
d©a
, sioc->
£n£
, 
»q
->
”rÜs
,„eq->
d©a_Ën
);

4714 
sioc
->
	`dÚe
(sioc->
d©a
, sioc->
£n£
, 
»q
->
”rÜs
,„eq->
»sid_Ën
);

4717 
	`kmem_ÿche_ä“
(
scsi_io_cÚ‹xt_ÿche
, 
sioc
);

4719 
	`__blk_put_»que¡
(
»q
->
q
,„eq);

4721 
	}
}

4729 
sc¡_scsi_exec_async
(
sc¡_cmd
 *
cmd
, *
d©a
,

4730 (*
dÚe
)(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
))

4732 
»s
 = 0;

4733 
»que¡_queue
 *
q
 = 
cmd
->
dev
->
scsi_dev
->request_queue;

4734 
»que¡
 *
rq
;

4735 
scsi_io_cÚ‹xt
 *
sioc
;

4736 
wr™e
 = (
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
è? 
WRITE
 : 
READ
;

4737 
gå_t
 
gå
 = 
cmd
->
noio_mem_®loc
 ? 
GFP_NOIO
 : 
GFP_KERNEL
;

4738 
cmd_Ën
 = 
cmd
->
cdb_Ën
;

4740 
sioc
 = 
	`kmem_ÿche_z®loc
(
scsi_io_cÚ‹xt_ÿche
, 
gå
);

4741 ià(
sioc
 =ð
NULL
) {

4742 
»s
 = -
ENOMEM
;

4743 
out
;

4746 
rq
 = 
	`blk_g‘_»que¡
(
q
, 
wr™e
, 
gå
);

4747 ià(
rq
 =ð
NULL
) {

4748 
»s
 = -
ENOMEM
;

4749 
out_ä“_sioc
;

4752 
rq
->
cmd_ty³
 = 
REQ_TYPE_BLOCK_PC
;

4753 
rq
->
cmd_æags
 |ð
REQ_QUIET
;

4755 ià(
cmd
->
sg
 =ð
NULL
)

4756 
dÚe
;

4758 ià(
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_BIDI
) {

4759 
»que¡
 *
Ãxt_rq
;

4761 ià(!
	`‹¡_b™
(
QUEUE_FLAG_BIDI
, &
q
->
queue_æags
)) {

4762 
»s
 = -
EOPNOTSUPP
;

4763 
out_ä“_rq
;

4766 
»s
 = 
	`blk_rq_m­_k”n_sg
(
rq
, 
cmd
->
out_sg
, cmd->
out_sg_út
, 
gå
);

4767 ià(
»s
 != 0) {

4768 
	`TRACE_DBG
("blk_rq_m­_k”n_sg(èçžed: %d", 
»s
);

4769 
out_ä“_rq
;

4772 
Ãxt_rq
 = 
	`blk_g‘_»que¡
(
q
, 
READ
, 
gå
);

4773 ià(
Ãxt_rq
 =ð
NULL
) {

4774 
»s
 = -
ENOMEM
;

4775 
out_ä“_unm­
;

4777 
rq
->
Ãxt_rq
 =‚ext_rq;

4778 
Ãxt_rq
->
cmd_ty³
 = 
rq
->cmd_type;

4780 
»s
 = 
	`blk_rq_m­_k”n_sg
(
Ãxt_rq
, 
cmd
->
sg
, cmd->
sg_út
, 
gå
);

4781 ià(
»s
 != 0) {

4782 
	`TRACE_DBG
("blk_rq_m­_k”n_sg(èçžed: %d", 
»s
);

4783 
out_ä“_unm­
;

4786 
»s
 = 
	`blk_rq_m­_k”n_sg
(
rq
, 
cmd
->
sg
, cmd->
sg_út
, 
gå
);

4787 ià(
»s
 != 0) {

4788 
	`TRACE_DBG
("blk_rq_m­_k”n_sg(èçžed: %d", 
»s
);

4789 
out_ä“_rq
;

4793 
dÚe
:

4794 
	`TRACE_DBG
("sioø%p, cmd %p", 
sioc
, 
cmd
);

4796 
sioc
->
d©a
 = data;

4797 
sioc
->
dÚe
 = done;

4799 
rq
->
cmd_Ën
 = cmd_len;

4800 ià(
rq
->
cmd_Ën
 <ð
BLK_MAX_CDB
) {

4801 
	`mem£t
(
rq
->
cmd
, 0, 
BLK_MAX_CDB
);

4802 
	`memýy
(
rq
->
cmd
, cmd->
cdb
, cmd->
cdb_Ën
);

4804 
rq
->
cmd
 = cmd->
cdb
;

4806 
rq
->
£n£
 = 
sioc
->sense;

4807 
rq
->
£n£_Ën
 = (
sioc
->
£n£
);

4808 
rq
->
timeout
 = 
cmd
->timeout;

4809 
rq
->
»Œ›s
 = 
cmd
->retries;

4810 
rq
->
’d_io_d©a
 = 
sioc
;

4812 
	`blk_execu‹_rq_nowa™
(
rq
->
q
, 
NULL
,„q,

4813 (
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
), 
scsi_’d_async
);

4814 
out
:

4815  
»s
;

4817 
out_ä“_unm­
:

4818 ià(
rq
->
Ãxt_rq
 !ð
NULL
) {

4819 
	`blk_put_»que¡
(
rq
->
Ãxt_rq
);

4820 
rq
->
Ãxt_rq
 = 
NULL
;

4822 
	`blk_rq_unm­_k”n_sg
(
rq
, 
»s
);

4824 
out_ä“_rq
:

4825 
	`blk_put_»que¡
(
rq
);

4827 
out_ä“_sioc
:

4828 
	`kmem_ÿche_ä“
(
scsi_io_cÚ‹xt_ÿche
, 
sioc
);

4829 
out
;

4830 
	}
}

4831 
EXPORT_SYMBOL
(
sc¡_scsi_exec_async
);

4841 
	$sc¡_cÝy_sg
(
sc¡_cmd
 *
cmd
, 
sc¡_sg_cÝy_dœ
 
cÝy_dœ
)

4843 
sÿ‰”li¡
 *
¤c_sg
, *
d¡_sg
;

4844 
to_cÝy
;

4845 
©omic
 = 
	`sc¡_cmd_©omic
(
cmd
);

4847 
	`TRACE_ENTRY
();

4849 ià(
cÝy_dœ
 =ð
SCST_SG_COPY_FROM_TARGET
) {

4850 ià(
cmd
->
d©a_dœeùiÚ
 !ð
SCST_DATA_BIDI
) {

4851 
¤c_sg
 = 
cmd
->
tgt_sg
;

4852 
d¡_sg
 = 
cmd
->
sg
;

4853 
to_cÝy
 = 
cmd
->
bufæ’
;

4855 
	`TRACE_MEM
("BIDI cmd %p", 
cmd
);

4856 
¤c_sg
 = 
cmd
->
tgt_out_sg
;

4857 
d¡_sg
 = 
cmd
->
out_sg
;

4858 
to_cÝy
 = 
cmd
->
out_bufæ’
;

4861 
¤c_sg
 = 
cmd
->
sg
;

4862 
d¡_sg
 = 
cmd
->
tgt_sg
;

4863 
to_cÝy
 = 
cmd
->
»¥_d©a_Ën
;

4866 
	`TRACE_MEM
("cmd %p, copy_dir %d, src_sg %p, dst_sg %p,o_copy %lld",

4867 
cmd
, 
cÝy_dœ
, 
¤c_sg
, 
d¡_sg
, ()
to_cÝy
);

4869 ià(
	`uÆik–y
(
¤c_sg
 =ð
NULL
è|| uÆik–y(
d¡_sg
 == NULL)) {

4874 
out
;

4877 
	`sg_cÝy
(
d¡_sg
, 
¤c_sg
, 0, 
to_cÝy
,

4878 
©omic
 ? 
KM_SOFTIRQ0
 : 
KM_USER0
,

4879 
©omic
 ? 
KM_SOFTIRQ1
 : 
KM_USER1
);

4881 
out
:

4882 
	`TRACE_EXIT
();

4884 
	}
}

4885 
EXPORT_SYMBOL_GPL
(
sc¡_cÝy_sg
);

4896 
	$sc¡_g‘_buf_fuÎ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 **
buf
)

4898 
»s
 = 0;

4900 
	`TRACE_ENTRY
();

4902 
	`EXTRACHECKS_BUG_ON
(
cmd
->
sg_buff_vm®loÿ‹d
);

4904 ià(
	`sc¡_g‘_buf_couÁ
(
cmd
) > 1) {

4905 
Ën
;

4906 
ušt8_t
 *
tmp_buf
;

4907 
fuÎ_size
;

4909 
fuÎ_size
 = 0;

4910 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
tmp_buf
);

4911 
Ën
 > 0) {

4912 
fuÎ_size
 +ð
Ën
;

4913 
	`sc¡_put_buf
(
cmd
, 
tmp_buf
);

4914 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
tmp_buf
);

4917 *
buf
 = 
	`vm®loc
(
fuÎ_size
);

4918 ià(*
buf
 =ð
NULL
) {

4919 
	`TRACE
(
TRACE_OUT_OF_MEM
, "vmalloc() failed for opcode "

4920 "%x", 
cmd
->
cdb
[0]);

4921 
»s
 = -
ENOMEM
;

4922 
out
;

4924 
cmd
->
sg_buff_vm®loÿ‹d
 = 1;

4926 ià(
	`sc¡_cmd_g‘_d©a_dœeùiÚ
(
cmd
è=ð
SCST_DATA_WRITE
) {

4927 
ušt8_t
 *
buf_±r
;

4929 
buf_±r
 = *
buf
;

4931 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
tmp_buf
);

4932 
Ën
 > 0) {

4933 
	`memýy
(
buf_±r
, 
tmp_buf
, 
Ën
);

4934 
buf_±r
 +ð
Ën
;

4936 
	`sc¡_put_buf
(
cmd
, 
tmp_buf
);

4937 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
tmp_buf
);

4940 
»s
 = 
fuÎ_size
;

4942 
»s
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, 
buf
);

4944 
out
:

4945 
	`TRACE_EXIT_RES
(
»s
);

4946  
»s
;

4947 
	}
}

4948 
EXPORT_SYMBOL
(
sc¡_g‘_buf_fuÎ
);

4958 
	$sc¡_put_buf_fuÎ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
buf
)

4960 
	`TRACE_ENTRY
();

4962 ià(
buf
 =ð
NULL
)

4963 
out
;

4965 ià(
cmd
->
sg_buff_vm®loÿ‹d
) {

4966 ià(
	`sc¡_cmd_g‘_d©a_dœeùiÚ
(
cmd
è=ð
SCST_DATA_READ
) {

4967 
Ën
;

4968 
ušt8_t
 *
tmp_buf
, *
buf_p
;

4970 
buf_p
 = 
buf
;

4972 
Ën
 = 
	`sc¡_g‘_buf_fœ¡
(
cmd
, &
tmp_buf
);

4973 
Ën
 > 0) {

4974 
	`memýy
(
tmp_buf
, 
buf_p
, 
Ën
);

4975 
buf_p
 +ð
Ën
;

4977 
	`sc¡_put_buf
(
cmd
, 
tmp_buf
);

4978 
Ën
 = 
	`sc¡_g‘_buf_Ãxt
(
cmd
, &
tmp_buf
);

4983 
cmd
->
sg_buff_vm®loÿ‹d
 = 0;

4985 
	`vä“
(
buf
);

4987 
	`sc¡_put_buf
(
cmd
, 
buf
);

4989 
out
:

4990 
	`TRACE_EXIT
();

4992 
	}
}

4993 
EXPORT_SYMBOL
(
sc¡_put_buf_fuÎ
);

4995 cÚ¡ 
	gSCST_CDB_LENGTH
[8] = { 6, 10, 10, 0, 16, 12, 0, 0 };

4997 
	#SCST_CDB_GROUP
(
Ýcode
è((Ýcod>> 5è& 0x7)

	)

4998 
	#SCST_GET_CDB_LEN
(
Ýcode
è
SCST_CDB_LENGTH
[
	`SCST_CDB_GROUP
(Ýcode)]

	)

5002 
	$g‘_Œªs_cdb_Ën_10
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5004 
cmd
->
cdb_Ën
 = 10;

5005 
cmd
->
bufæ’
 = 0;

5007 
	}
}

5009 
	$g‘_Œªs_Ën_block_lim™
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5011 
cmd
->
bufæ’
 = 6;

5013 
	}
}

5015 
	$g‘_Œªs_Ën_»ad_ÿ·c™y
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5017 
cmd
->
bufæ’
 = 8;

5019 
	}
}

5021 
	$g‘_Œªs_Ën_£rv_aù_š
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5023 
»s
 = 0;

5025 
	`TRACE_ENTRY
();

5027 ià((
cmd
->
cdb
[1] & 0x1fè=ð
SAI_READ_CAPACITY_16
) {

5028 
cmd
->
Ý_Çme
 = "READ CAPACITY(16)";

5029 
cmd
->
bufæ’
 = 
	`be32_to_ýu
(
	`g‘_uÇligÃd
((
__be32
 *)&cmd->
cdb
[10]));

5030 
cmd
->
Ý_æags
 |ð
SCST_IMPLICIT_HQ
 | 
SCST_REG_RESERVE_ALLOWED
 |

5031 
SCST_WRITE_EXCL_ALLOWED
 | 
SCST_EXCL_ACCESS_ALLOWED
;

5033 
cmd
->
Ý_æags
 |ð
SCST_UNKNOWN_LENGTH
;

5035 
	`TRACE_EXIT_RES
(
»s
);

5036  
»s
;

5037 
	}
}

5039 
	$g‘_Œªs_Ën_sšgË
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5041 
cmd
->
bufæ’
 = 1;

5043 
	}
}

5045 
	$g‘_Œªs_Ën_»ad_pos
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5047 
ušt8_t
 *
p
 = (ušt8_ˆ*)
cmd
->
cdb
 + 
off
;

5048 
»s
 = 0;

5050 
cmd
->
bufæ’
 = 0;

5051 
cmd
->
bufæ’
 |ð((
u32
)
p
[0]) << 8;

5052 
cmd
->
bufæ’
 |ð((
u32
)
p
[1]);

5054 
cmd
->
cdb
[1] & 0x1f) {

5058 ià(
cmd
->
bufæ’
 != 0) {

5059 
	`PRINT_ERROR
("READ POSITION: Invalid‚on-zero (%d) "

5061 
cmd
->
bufæ’
, cmd->
cdb
[1] & 0x1f);

5062 
out_šv®
;

5067 
cmd
->
cdb
[1] & 0x1f) {

5070 
cmd
->
bufæ’
 = 20;

5073 
cmd
->
bufæ’
 = 32;

5076 
cmd
->
bufæ’
 = 
	`max
(28, cmd->bufflen);

5079 
	`PRINT_ERROR
("READ POSITION: Invalid service‡ction %x",

5080 
cmd
->
cdb
[1] & 0x1f);

5081 
out_šv®
;

5084 
out
:

5085  
»s
;

5087 
out_šv®
:

5088 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

5089 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

5090 
»s
 = 1;

5091 
out
;

5092 
	}
}

5094 
	$g‘_Œªs_Ën_´ev’t_®low_medium_»mov®
(
sc¡_cmd
 *
cmd
,

5095 
ušt8_t
 
off
)

5097 ià((
cmd
->
cdb
[4] & 3) == 0)

5098 
cmd
->
Ý_æags
 |ð
SCST_REG_RESERVE_ALLOWED
 |

5099 
SCST_WRITE_EXCL_ALLOWED
 | 
SCST_EXCL_ACCESS_ALLOWED
;

5101 
	}
}

5103 
	$g‘_Œªs_Ën_¡¬t_¡Ý
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5105 ià((
cmd
->
cdb
[4] & 0xF1) == 0x1)

5106 
cmd
->
Ý_æags
 |ð
SCST_REG_RESERVE_ALLOWED
 |

5107 
SCST_WRITE_EXCL_ALLOWED
 | 
SCST_EXCL_ACCESS_ALLOWED
;

5109 
	}
}

5111 
	$g‘_Œªs_Ën_3_»ad_–em_¡©
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5113 cÚ¡ 
ušt8_t
 *
p
 = 
cmd
->
cdb
 + 
off
;

5115 
cmd
->
bufæ’
 = 0;

5116 
cmd
->
bufæ’
 |ð((
u32
)
p
[0]) << 16;

5117 
cmd
->
bufæ’
 |ð((
u32
)
p
[1]) << 8;

5118 
cmd
->
bufæ’
 |ð((
u32
)
p
[2]);

5120 ià((
cmd
->
cdb
[6] & 0x2) == 0x2)

5121 
cmd
->
Ý_æags
 |ð
SCST_REG_RESERVE_ALLOWED
 |

5122 
SCST_WRITE_EXCL_ALLOWED
 | 
SCST_EXCL_ACCESS_ALLOWED
;

5124 
	}
}

5126 
	$g‘_Œªs_Ën_1
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5128 
cmd
->
bufæ’
 = (
u32
)cmd->
cdb
[
off
];

5130 
	}
}

5132 
	$g‘_Œªs_Ën_1_256
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5134 
cmd
->
bufæ’
 = (
u32
)cmd->
cdb
[
off
];

5135 ià(
cmd
->
bufæ’
 == 0)

5136 
cmd
->
bufæ’
 = 256;

5138 
	}
}

5140 
	$g‘_Œªs_Ën_2
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5142 cÚ¡ 
ušt8_t
 *
p
 = 
cmd
->
cdb
 + 
off
;

5144 
cmd
->
bufæ’
 = 0;

5145 
cmd
->
bufæ’
 |ð((
u32
)
p
[0]) << 8;

5146 
cmd
->
bufæ’
 |ð((
u32
)
p
[1]);

5149 
	}
}

5151 
	$g‘_Œªs_Ën_3
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5153 cÚ¡ 
ušt8_t
 *
p
 = 
cmd
->
cdb
 + 
off
;

5155 
cmd
->
bufæ’
 = 0;

5156 
cmd
->
bufæ’
 |ð((
u32
)
p
[0]) << 16;

5157 
cmd
->
bufæ’
 |ð((
u32
)
p
[1]) << 8;

5158 
cmd
->
bufæ’
 |ð((
u32
)
p
[2]);

5161 
	}
}

5163 
	$g‘_Œªs_Ën_4
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5165 cÚ¡ 
ušt8_t
 *
p
 = 
cmd
->
cdb
 + 
off
;

5167 
cmd
->
bufæ’
 = 0;

5168 
cmd
->
bufæ’
 |ð((
u32
)
p
[0]) << 24;

5169 
cmd
->
bufæ’
 |ð((
u32
)
p
[1]) << 16;

5170 
cmd
->
bufæ’
 |ð((
u32
)
p
[2]) << 8;

5171 
cmd
->
bufæ’
 |ð((
u32
)
p
[3]);

5174 
	}
}

5176 
	$g‘_Œªs_Ën_nÚe
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5178 
cmd
->
bufæ’
 = 0;

5180 
	}
}

5182 
	$g‘_bidi_Œªs_Ën_2
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 
off
)

5184 cÚ¡ 
ušt8_t
 *
p
 = 
cmd
->
cdb
 + 
off
;

5186 
cmd
->
bufæ’
 = 0;

5187 
cmd
->
bufæ’
 |ð((
u32
)
p
[0]) << 8;

5188 
cmd
->
bufæ’
 |ð((
u32
)
p
[1]);

5190 
cmd
->
out_bufæ’
 = cmd->
bufæ’
;

5193 
	}
}

5205 
	$sc¡_g‘_cdb_šfo
(
sc¡_cmd
 *
cmd
)

5207 
dev_ty³
 = 
cmd
->
dev
->
ty³
;

5208 
i
, 
»s
 = 0;

5209 
ušt8_t
 
Ý
;

5210 cÚ¡ 
sc¡_sdbÝs
 *
±r
 = 
NULL
;

5212 
	`TRACE_ENTRY
();

5214 
Ý
 = 
cmd
->
cdb
[0];

5216 
	`TRACE_DBG
("opcode=%02x, cdblen=%d bytes,blsize=%d, "

5217 "dev_ty³=%d", 
Ý
, 
	`SCST_GET_CDB_LEN
(Ý), 
SCST_CDB_TBL_SIZE
,

5218 
dev_ty³
);

5220 
i
 = 
sc¡_scsi_Ý_li¡
[
Ý
];

5221 
i
 < 
SCST_CDB_TBL_SIZE
 && 
sc¡_scsi_Ý_bË
[i].
Ýs
 =ð
Ý
) {

5222 ià(
sc¡_scsi_Ý_bË
[
i
].
devkey
[
dev_ty³
] !ð
SCST_CDB_NOTSUPP
) {

5223 
±r
 = &
sc¡_scsi_Ý_bË
[
i
];

5224 
	`TRACE_DBG
("op = 0x%02x+'%c%c%c%c%c%c%c%c%c%c'+<%s>",

5225 
±r
->
Ýs
,…Œ->
devkey
[0],

5226 
±r
->
devkey
[1],

5227 
±r
->
devkey
[2],

5228 
±r
->
devkey
[3],

5229 
±r
->
devkey
[4],

5230 
±r
->
devkey
[5],

5231 
±r
->
devkey
[6],

5232 
±r
->
devkey
[7],

5233 
±r
->
devkey
[8],

5234 
±r
->
devkey
[9],

5235 
±r
->
Ý_Çme
);

5236 
	`TRACE_DBG
("direction=%d flags=%d off=%d",

5237 
±r
->
dœeùiÚ
,

5238 
±r
->
æags
,

5239 
±r
->
off
);

5242 
i
++;

5245 ià(
	`uÆik–y
(
±r
 =ð
NULL
)) {

5247 
	`TRACE
(
TRACE_MINOR
, "UnknowÀÝcod0x%x fÜy³ %d", 
Ý
,

5248 
dev_ty³
);

5249 
»s
 = -1;

5250 
out
;

5253 
cmd
->
cdb_Ën
 = 
	`SCST_GET_CDB_LEN
(
Ý
);

5254 
cmd
->
Ý_Çme
 = 
±r
->op_name;

5255 
cmd
->
d©a_dœeùiÚ
 = 
±r
->
dœeùiÚ
;

5256 
cmd
->
Ý_æags
 = 
±r
->
æags
 | 
SCST_INFO_VALID
;

5257 
»s
 = (*
±r
->
g‘_Œªs_Ën
)(
cmd
,…Œ->
off
);

5259 
out
:

5260 
	`TRACE_EXIT_RES
(
»s
);

5261  
»s
;

5262 
	}
}

5263 
EXPORT_SYMBOL_GPL
(
sc¡_g‘_cdb_šfo
);

5266 
__be64
 
	$sc¡_·ck_lun
(cÚ¡ 
ušt64_t
 
lun
, 
sc¡_lun_addr_m‘hod
 
addr_m‘hod
)

5268 
ušt64_t
 
»s
 = 0;

5270 ià(
lun
) {

5271 
»s
 = (
addr_m‘hod
 << 14è| (
lun
 & 0x3fff);

5272 
»s
 =„es << 48;

5275 
	`TRACE_EXIT_HRES
(
»s
 >> 48);

5276  
	`ýu_to_be64
(
»s
);

5277 
	}
}

5284 
ušt64_t
 
	$sc¡_uÅack_lun
(cÚ¡ 
ušt8_t
 *
lun
, 
Ën
)

5286 
ušt64_t
 
»s
 = 
NO_SUCH_LUN
;

5287 
add»ss_m‘hod
;

5289 
	`TRACE_ENTRY
();

5291 
	`TRACE_BUFF_FLAG
(
TRACE_DEBUG
, "Raw LUN", 
lun
, 
Ën
);

5293 ià(
	`uÆik–y
(
Ën
 < 2)) {

5294 
	`PRINT_ERROR
("Illegal†un†ength %d,ƒxpected 2 bytes or "

5295 "mÜe", 
Ën
);

5296 
out
;

5299 ià(
Ën
 > 2) {

5300 
Ën
) {

5302 ià((*((
__be64
 *)
lun
) &

5303 
	`__cÚ¡ªt_ýu_to_be64
(0x0000FFFFFFFFFFFFLL)) != 0)

5304 
out_”r
;

5307 ià(*((
__be16
 *)&
lun
[2]) != 0)

5308 
out_”r
;

5311 ià(*((
__be32
 *)&
lun
[2]) != 0)

5312 
out_”r
;

5315 
out_”r
;

5319 
add»ss_m‘hod
 = (*
lun
) >> 6;

5320 
add»ss_m‘hod
) {

5321 
SCST_LUN_ADDR_METHOD_PERIPHERAL
:

5322 
SCST_LUN_ADDR_METHOD_FLAT
:

5323 
SCST_LUN_ADDR_METHOD_LUN
:

5324 
»s
 = *(
lun
 + 1) | (((*lun) & 0x3f) << 8);

5327 
SCST_LUN_ADDR_METHOD_EXTENDED_LUN
:

5329 
	`PRINT_ERROR
("Unimplemented LUN‡ddressing method %u",

5330 
add»ss_m‘hod
);

5334 
out
:

5335 
	`TRACE_EXIT_RES
(()
»s
);

5336  
»s
;

5338 
out_”r
:

5339 
	`PRINT_ERROR
("%s", "Multi-level LUN unimplemented");

5340 
out
;

5341 
	}
}

5354 
	$sc¡_ÿlc_block_shiá
(
£ùÜ_size
)

5356 
block_shiá
 = 0;

5357 
t
;

5359 ià(
£ùÜ_size
 == 0)

5360 
£ùÜ_size
 = 512;

5362 
t
 = 
£ùÜ_size
;

5364 ià((
t
 & 1) != 0)

5366 
t
 >>= 1;

5367 
block_shiá
++;

5369 ià(
block_shiá
 < 9) {

5370 
	`PRINT_ERROR
("WrÚg seùÜ siz%d", 
£ùÜ_size
);

5371 
block_shiá
 = -1;

5374 
	`TRACE_EXIT_RES
(
block_shiá
);

5375  
block_shiá
;

5376 
	}
}

5377 
EXPORT_SYMBOL_GPL
(
sc¡_ÿlc_block_shiá
);

5384 
sc¡_sbc_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

5385 (*
g‘_block_shiá
)(
sc¡_cmd
 *
cmd
))

5387 
»s
 = 0;

5389 
	`TRACE_ENTRY
();

5396 
	`TRACE_DBG
("op_name <%s> direct %d flags %dransfer_len %d",

5397 
cmd
->
Ý_Çme
, cmd->
d©a_dœeùiÚ
, cmd->
Ý_æags
, cmd->
bufæ’
);

5399 
cmd
->
cdb
[0]) {

5400 
VERIFY_6
:

5401 
VERIFY
:

5402 
VERIFY_12
:

5403 
VERIFY_16
:

5404 ià((
cmd
->
cdb
[1] & 
BYTCHK
) == 0) {

5405 
cmd
->
d©a_Ën
 = cmd->
bufæ’
 << 
	`g‘_block_shiá
(cmd);

5406 
cmd
->
bufæ’
 = 0;

5407 
£t_timeout
;

5409 
cmd
->
d©a_Ën
 = 0;

5416 ià(
cmd
->
Ý_æags
 & 
SCST_TRANSFER_LEN_TYPE_FIXED
) {

5417 
block_shiá
 = 
	`g‘_block_shiá
(
cmd
);

5422 
cmd
->
bufæ’
 = cmd->bufæ’ << 
block_shiá
;

5423 
cmd
->
out_bufæ’
 = cmd->out_bufæ’ << 
block_shiá
;

5426 
£t_timeout
:

5427 ià((
cmd
->
Ý_æags
 & (
SCST_SMALL_TIMEOUT
 | 
SCST_LONG_TIMEOUT
)) == 0)

5428 
cmd
->
timeout
 = 
SCST_GENERIC_DISK_REG_TIMEOUT
;

5429 ià(
cmd
->
Ý_æags
 & 
SCST_SMALL_TIMEOUT
)

5430 
cmd
->
timeout
 = 
SCST_GENERIC_DISK_SMALL_TIMEOUT
;

5431 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

5432 
cmd
->
timeout
 = 
SCST_GENERIC_DISK_LONG_TIMEOUT
;

5434 
	`TRACE_DBG
("res %d, bufflen %d, data_len %d, direct %d",

5435 
»s
, 
cmd
->
bufæ’
, cmd->
d©a_Ën
, cmd->
d©a_dœeùiÚ
);

5437 
	`TRACE_EXIT_RES
(
»s
);

5438  
»s
;

5439 
	}
}

5440 
EXPORT_SYMBOL_GPL
(
sc¡_sbc_g’”ic_·r£
);

5447 
sc¡_cdrom_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

5448 (*
g‘_block_shiá
)(
sc¡_cmd
 *
cmd
))

5450 
»s
 = 0;

5452 
	`TRACE_ENTRY
();

5459 
	`TRACE_DBG
("op_name <%s> direct %d flags %dransfer_len %d",

5460 
cmd
->
Ý_Çme
, cmd->
d©a_dœeùiÚ
, cmd->
Ý_æags
, cmd->
bufæ’
);

5462 
cmd
->
cdb
[1] &= 0x1f;

5464 
cmd
->
cdb
[0]) {

5465 
VERIFY_6
:

5466 
VERIFY
:

5467 
VERIFY_12
:

5468 
VERIFY_16
:

5469 ià((
cmd
->
cdb
[1] & 
BYTCHK
) == 0) {

5470 
cmd
->
d©a_Ën
 = cmd->
bufæ’
 << 
	`g‘_block_shiá
(cmd);

5471 
cmd
->
bufæ’
 = 0;

5472 
£t_timeout
;

5480 ià(
cmd
->
Ý_æags
 & 
SCST_TRANSFER_LEN_TYPE_FIXED
) {

5481 
block_shiá
 = 
	`g‘_block_shiá
(
cmd
);

5482 
cmd
->
bufæ’
 = cmd->bufæ’ << 
block_shiá
;

5483 
cmd
->
out_bufæ’
 = cmd->out_bufæ’ << 
block_shiá
;

5486 
£t_timeout
:

5487 ià((
cmd
->
Ý_æags
 & (
SCST_SMALL_TIMEOUT
 | 
SCST_LONG_TIMEOUT
)) == 0)

5488 
cmd
->
timeout
 = 
SCST_GENERIC_CDROM_REG_TIMEOUT
;

5489 ià(
cmd
->
Ý_æags
 & 
SCST_SMALL_TIMEOUT
)

5490 
cmd
->
timeout
 = 
SCST_GENERIC_CDROM_SMALL_TIMEOUT
;

5491 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

5492 
cmd
->
timeout
 = 
SCST_GENERIC_CDROM_LONG_TIMEOUT
;

5494 
	`TRACE_DBG
("»s=%d, bufæ’=%d, dœeù=%d", 
»s
, 
cmd
->
bufæ’
,

5495 
cmd
->
d©a_dœeùiÚ
);

5497 
	`TRACE_EXIT
();

5498  
»s
;

5499 
	}
}

5500 
EXPORT_SYMBOL_GPL
(
sc¡_cdrom_g’”ic_·r£
);

5507 
sc¡_modisk_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

5508 (*
g‘_block_shiá
)(
sc¡_cmd
 *
cmd
))

5510 
»s
 = 0;

5512 
	`TRACE_ENTRY
();

5519 
	`TRACE_DBG
("op_name <%s> direct %d flags %dransfer_len %d",

5520 
cmd
->
Ý_Çme
, cmd->
d©a_dœeùiÚ
, cmd->
Ý_æags
, cmd->
bufæ’
);

5522 
cmd
->
cdb
[1] &= 0x1f;

5524 
cmd
->
cdb
[0]) {

5525 
VERIFY_6
:

5526 
VERIFY
:

5527 
VERIFY_12
:

5528 
VERIFY_16
:

5529 ià((
cmd
->
cdb
[1] & 
BYTCHK
) == 0) {

5530 
cmd
->
d©a_Ën
 = cmd->
bufæ’
 << 
	`g‘_block_shiá
(cmd);

5531 
cmd
->
bufæ’
 = 0;

5532 
£t_timeout
;

5540 ià(
cmd
->
Ý_æags
 & 
SCST_TRANSFER_LEN_TYPE_FIXED
) {

5541 
block_shiá
 = 
	`g‘_block_shiá
(
cmd
);

5542 
cmd
->
bufæ’
 = cmd->bufæ’ << 
block_shiá
;

5543 
cmd
->
out_bufæ’
 = cmd->out_bufæ’ << 
block_shiá
;

5546 
£t_timeout
:

5547 ià((
cmd
->
Ý_æags
 & (
SCST_SMALL_TIMEOUT
 | 
SCST_LONG_TIMEOUT
)) == 0)

5548 
cmd
->
timeout
 = 
SCST_GENERIC_MODISK_REG_TIMEOUT
;

5549 ià(
cmd
->
Ý_æags
 & 
SCST_SMALL_TIMEOUT
)

5550 
cmd
->
timeout
 = 
SCST_GENERIC_MODISK_SMALL_TIMEOUT
;

5551 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

5552 
cmd
->
timeout
 = 
SCST_GENERIC_MODISK_LONG_TIMEOUT
;

5554 
	`TRACE_DBG
("»s=%d, bufæ’=%d, dœeù=%d", 
»s
, 
cmd
->
bufæ’
,

5555 
cmd
->
d©a_dœeùiÚ
);

5557 
	`TRACE_EXIT_RES
(
»s
);

5558  
»s
;

5559 
	}
}

5560 
EXPORT_SYMBOL_GPL
(
sc¡_modisk_g’”ic_·r£
);

5567 
sc¡_³_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

5568 (*
g‘_block_size
)(
sc¡_cmd
 *
cmd
))

5570 
»s
 = 0;

5572 
	`TRACE_ENTRY
();

5579 
	`TRACE_DBG
("op_name <%s> direct %d flags %dransfer_len %d",

5580 
cmd
->
Ý_Çme
, cmd->
d©a_dœeùiÚ
, cmd->
Ý_æags
, cmd->
bufæ’
);

5582 ià(
cmd
->
cdb
[0] =ð
READ_POSITION
) {

5583 
tþp
 = 
cmd
->
cdb
[1] & 4;

5584 
lÚg_b™
 = 
cmd
->
cdb
[1] & 2;

5585 
bt
 = 
cmd
->
cdb
[1] & 1;

5587 ià((
tþp
 =ð
lÚg_b™
è&& (!
bt
 || !long_bit)) {

5588 
cmd
->
bufæ’
 =

5589 
tþp
 ? 
POSITION_LEN_LONG
 : 
POSITION_LEN_SHORT
;

5590 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_READ
;

5592 
cmd
->
bufæ’
 = 0;

5593 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

5597 ià(
cmd
->
Ý_æags
 & 
SCST_TRANSFER_LEN_TYPE_FIXED
 & cmd->
cdb
[1]) {

5598 
block_size
 = 
	`g‘_block_size
(
cmd
);

5599 
cmd
->
bufæ’
 = cmd->bufæ’ * 
block_size
;

5600 
cmd
->
out_bufæ’
 = cmd->out_bufæ’ * 
block_size
;

5603 ià((
cmd
->
Ý_æags
 & (
SCST_SMALL_TIMEOUT
 | 
SCST_LONG_TIMEOUT
)) == 0)

5604 
cmd
->
timeout
 = 
SCST_GENERIC_TAPE_REG_TIMEOUT
;

5605 ià(
cmd
->
Ý_æags
 & 
SCST_SMALL_TIMEOUT
)

5606 
cmd
->
timeout
 = 
SCST_GENERIC_TAPE_SMALL_TIMEOUT
;

5607 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

5608 
cmd
->
timeout
 = 
SCST_GENERIC_TAPE_LONG_TIMEOUT
;

5610 
	`TRACE_EXIT_RES
(
»s
);

5611  
»s
;

5612 
	}
}

5613 
EXPORT_SYMBOL_GPL
(
sc¡_³_g’”ic_·r£
);

5615 
	$sc¡_nuÎ_·r£
(
sc¡_cmd
 *
cmd
)

5617 
»s
 = 0;

5619 
	`TRACE_ENTRY
();

5626 
	`TRACE_DBG
("op_name <%s> direct %d flags %dransfer_len %d",

5627 
cmd
->
Ý_Çme
, cmd->
d©a_dœeùiÚ
, cmd->
Ý_æags
, cmd->
bufæ’
);

5629 
cmd
->
cdb
[0]) {

5635 
	`TRACE_DBG
("res %d bufflen %d direct %d",

5636 
»s
, 
cmd
->
bufæ’
, cmd->
d©a_dœeùiÚ
);

5638 
	`TRACE_EXIT
();

5639  
»s
;

5640 
	}
}

5647 
sc¡_chªg”_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

5648 (*
nÙhšg
)(
sc¡_cmd
 *
cmd
))

5650 
»s
 = 
	`sc¡_nuÎ_·r£
(
cmd
);

5652 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

5653 
cmd
->
timeout
 = 
SCST_GENERIC_CHANGER_LONG_TIMEOUT
;

5655 
cmd
->
timeout
 = 
SCST_GENERIC_CHANGER_TIMEOUT
;

5657  
»s
;

5658 
	}
}

5659 
EXPORT_SYMBOL_GPL
(
sc¡_chªg”_g’”ic_·r£
);

5666 
sc¡_´oûssÜ_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

5667 (*
nÙhšg
)(
sc¡_cmd
 *
cmd
))

5669 
»s
 = 
	`sc¡_nuÎ_·r£
(
cmd
);

5671 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

5672 
cmd
->
timeout
 = 
SCST_GENERIC_PROCESSOR_LONG_TIMEOUT
;

5674 
cmd
->
timeout
 = 
SCST_GENERIC_PROCESSOR_TIMEOUT
;

5676  
»s
;

5677 
	}
}

5678 
EXPORT_SYMBOL_GPL
(
sc¡_´oûssÜ_g’”ic_·r£
);

5685 
sc¡_¿id_g’”ic_·r£
(
sc¡_cmd
 *
cmd
,

5686 (*
nÙhšg
)(
sc¡_cmd
 *
cmd
))

5688 
»s
 = 
	`sc¡_nuÎ_·r£
(
cmd
);

5690 ià(
cmd
->
Ý_æags
 & 
SCST_LONG_TIMEOUT
)

5691 
cmd
->
timeout
 = 
SCST_GENERIC_RAID_LONG_TIMEOUT
;

5693 
cmd
->
timeout
 = 
SCST_GENERIC_RAID_TIMEOUT
;

5695  
»s
;

5696 
	}
}

5697 
EXPORT_SYMBOL_GPL
(
sc¡_¿id_g’”ic_·r£
);

5710 
sc¡_block_g’”ic_dev_dÚe
(
sc¡_cmd
 *
cmd
,

5711 (*
£t_block_shiá
)(
sc¡_cmd
 *
cmd
, 
block_shiá
))

5713 
Ýcode
 = 
cmd
->
cdb
[0];

5714 
¡©us
 = 
cmd
->status;

5715 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

5717 
	`TRACE_ENTRY
();

5725 ià((
¡©us
 =ð
SAM_STAT_GOOD
è|| (¡©u =ð
SAM_STAT_CONDITION_MET
)) {

5726 
Ýcode
) {

5727 
READ_CAPACITY
:

5730 
bufãr_size
, 
£ùÜ_size
, 
sh
;

5731 
ušt8_t
 *
bufãr
;

5733 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
bufãr
);

5734 ià(
	`uÆik–y
(
bufãr_size
 <= 0)) {

5735 ià(
bufãr_size
 < 0) {

5736 
	`PRINT_ERROR
("%s: Unableo gethe"

5737 " bufã¸(%d)", 
__func__
, 
bufãr_size
);

5739 
out
;

5742 
£ùÜ_size
 =

5743 ((
bufãr
[4] << 24) | (buffer[5] << 16) |

5744 (
bufãr
[6] << 8) | (buffer[7] << 0));

5745 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

5746 ià(
£ùÜ_size
 != 0)

5747 
sh
 = 
	`sc¡_ÿlc_block_shiá
(
£ùÜ_size
);

5749 
sh
 = 0;

5750 
	`£t_block_shiá
(
cmd
, 
sh
);

5751 
	`TRACE_DBG
("block_shiá %d", 
sh
);

5760 
	`TRACE_DBG
("cmd->is_send_status=%x, cmd->resp_data_len=%d, "

5761 "»s=%d", 
cmd
->
is_£nd_¡©us
, cmd->
»¥_d©a_Ën
, 
»s
);

5763 
out
:

5764 
	`TRACE_EXIT_RES
(
»s
);

5765  
»s
;

5766 
	}
}

5767 
EXPORT_SYMBOL_GPL
(
sc¡_block_g’”ic_dev_dÚe
);

5774 
sc¡_³_g’”ic_dev_dÚe
(
sc¡_cmd
 *
cmd
,

5775 (*
£t_block_size
)(
sc¡_cmd
 *
cmd
, 
block_shiá
))

5777 
Ýcode
 = 
cmd
->
cdb
[0];

5778 
»s
 = 
SCST_CMD_STATE_DEFAULT
;

5779 
bufãr_size
, 
bs
;

5780 
ušt8_t
 *
bufãr
 = 
NULL
;

5782 
	`TRACE_ENTRY
();

5790 ià(
cmd
->
¡©us
 !ð
SAM_STAT_GOOD
)

5791 
out
;

5793 
Ýcode
) {

5794 
MODE_SENSE
:

5795 
MODE_SELECT
:

5796 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
bufãr
);

5797 ià(
	`uÆik–y
(
bufãr_size
 <= 0)) {

5798 ià(
bufãr_size
 < 0) {

5799 
	`PRINT_ERROR
("%s: Unableo gethe buffer (%d)",

5800 
__func__
, 
bufãr_size
);

5802 
out
;

5807 
Ýcode
) {

5808 
MODE_SENSE
:

5809 
	`TRACE_DBG
("%s", "MODE_SENSE");

5810 ià((
cmd
->
cdb
[2] & 0xC0) == 0) {

5811 ià(
bufãr
[3] == 8) {

5812 
bs
 = (
bufãr
[9] << 16) |

5813 (
bufãr
[10] << 8) | buffer[11];

5814 
	`£t_block_size
(
cmd
, 
bs
);

5818 
MODE_SELECT
:

5819 
	`TRACE_DBG
("%s", "MODE_SELECT");

5820 ià(
bufãr
[3] == 8) {

5821 
bs
 = (
bufãr
[9] << 16) | (buffer[10] << 8) |

5822 (
bufãr
[11]);

5823 
	`£t_block_size
(
cmd
, 
bs
);

5831 
Ýcode
) {

5832 
MODE_SENSE
:

5833 
MODE_SELECT
:

5834 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

5838 
out
:

5839 
	`TRACE_EXIT_RES
(
»s
);

5840  
»s
;

5841 
	}
}

5842 
EXPORT_SYMBOL_GPL
(
sc¡_³_g’”ic_dev_dÚe
);

5844 
	$sc¡_check_š‹º®_£n£
(
sc¡_deviû
 *
dev
, 
»suÉ
,

5845 
ušt8_t
 *
£n£
, 
£n£_Ën
)

5847 
	`TRACE_ENTRY
();

5849 ià(
	`ho¡_by‹
(
»suÉ
è=ð
DID_RESET
) {

5850 
¦
;

5851 
	`TRACE
(
TRACE_MGMT
, "DID_RESET„eceived for device %s, "

5852 "Œigg”šg„e£ˆUA", 
dev
->
vœt_Çme
);

5853 
¦
 = 
	`sc¡_£t_£n£
(
£n£
, 
£n£_Ën
, 
dev
->
d_£n£
,

5854 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

5855 
	`sc¡_dev_check_£t_UA
(
dev
, 
NULL
, 
£n£
, 
¦
);

5856 } ià((
	`¡©us_by‹
(
»suÉ
è=ð
CHECK_CONDITION
) &&

5857 
	`sc¡_is_ua_£n£
(
£n£
, 
£n£_Ën
))

5858 
	`sc¡_dev_check_£t_UA
(
dev
, 
NULL
, 
£n£
, 
£n£_Ën
);

5860 
	`TRACE_EXIT
();

5862 
	}
}

5870 
dma_d©a_dœeùiÚ
 
	$sc¡_to_dma_dœ
(
sc¡_dœ
)

5872 cÚ¡ 
dma_d©a_dœeùiÚ
 
Œ_tbl
[] = { 
DMA_NONE
,

5873 
DMA_TO_DEVICE
, 
DMA_FROM_DEVICE
, 
DMA_BIDIRECTIONAL
, 
DMA_NONE
 };

5875  
Œ_tbl
[
sc¡_dœ
];

5876 
	}
}

5877 
EXPORT_SYMBOL
(
sc¡_to_dma_dœ
);

5885 
dma_d©a_dœeùiÚ
 
	$sc¡_to_tgt_dma_dœ
(
sc¡_dœ
)

5887 cÚ¡ 
dma_d©a_dœeùiÚ
 
Œ_tbl
[] = { 
DMA_NONE
,

5888 
DMA_FROM_DEVICE
, 
DMA_TO_DEVICE
, 
DMA_BIDIRECTIONAL
, 
DMA_NONE
 };

5890  
Œ_tbl
[
sc¡_dœ
];

5891 
	}
}

5892 
EXPORT_SYMBOL
(
sc¡_to_tgt_dma_dœ
);

5900 
	$sc¡_obš_deviû_·¿m‘”s
(
sc¡_deviû
 *
dev
)

5902 
rc
, 
i
;

5903 
ušt8_t
 
cmd
[16];

5904 
ušt8_t
 
bufãr
[4+0x0A];

5905 
ušt8_t
 
£n£_bufãr
[
SCSI_SENSE_BUFFERSIZE
];

5907 
	`TRACE_ENTRY
();

5909 
	`EXTRACHECKS_BUG_ON
(
dev
->
scsi_dev
 =ð
NULL
);

5911 
i
 = 0; i < 5; i++) {

5913 
	`mem£t
(
cmd
, 0, (cmd));

5915 
cmd
[0] = 
MODE_SENSE_10
;

5916 
cmd
[1] = 0;

5917 
cmd
[2] = 0x0A;

5918 
cmd
[8] = (
bufãr
);

5920 
cmd
[0] = 
MODE_SENSE
;

5921 
cmd
[1] = 8;

5922 
cmd
[2] = 0x0A;

5923 
cmd
[4] = (
bufãr
);

5926 
	`mem£t
(
bufãr
, 0, (buffer));

5927 
	`mem£t
(
£n£_bufãr
, 0, (sense_buffer));

5929 
	`TRACE
(
TRACE_SCSI
, "%s", "Doing internal MODE_SENSE");

5930 
rc
 = 
	`scsi_execu‹
(
dev
->
scsi_dev
, 
cmd
, 
SCST_DATA_READ
, 
bufãr
,

5931 (
bufãr
), 
£n£_bufãr
, 15, 0, 0

5932 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2,6,29)

5933 , 
NULL


5937 
	`TRACE_DBG
("MODE_SENSE dÚe: %x", 
rc
);

5939 ià(
	`scsi_¡©us_is_good
(
rc
)) {

5940 
q
;

5942 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "Returned control mode "

5943 "·gd©a", 
bufãr
, (buffer));

5945 
dev
->
t¡
 = 
bufãr
[4+2] >> 5;

5946 
q
 = 
bufãr
[4+3] >> 4;

5947 ià(
q
 > 
SCST_CONTR_MODE_QUEUE_ALG_UNRESTRICTED_REORDER
) {

5948 
	`PRINT_ERROR
("Too big QUEUE ALG %x, dev %s",

5949 
dev
->
queue_®g
, dev->
vœt_Çme
);

5951 
dev
->
queue_®g
 = 
q
;

5952 
dev
->
swp
 = (
bufãr
[4+4] & 0x8) >> 3;

5953 
dev
->
s
 = (
bufãr
[4+5] & 0x40) >> 6;

5954 
dev
->
d_£n£
 = (
bufãr
[4+2] & 0x4) >> 2;

5962 
dev
->
has_own_Üd”_mgmt
 = !dev->
queue_®g
;

5964 
	`PRINT_INFO
("Device %s: TST %x, QUEUE ALG %x, SWP %x, "

5966 
dev
->
vœt_Çme
, dev->
t¡
, dev->
queue_®g
,

5967 
dev
->
swp
, dev->
s
, dev->
d_£n£
,

5968 
dev
->
has_own_Üd”_mgmt
);

5970 
out
;

5972 
	`sc¡_check_š‹º®_£n£
(
dev
, 
rc
, 
£n£_bufãr
,

5973 (
£n£_bufãr
));

5975 ià((
	`¡©us_by‹
(
rc
è=ð
CHECK_CONDITION
) &&

5976 
	`SCST_SENSE_VALID
(
£n£_bufãr
)) {

5982 ià(
	`SCST_SENSE_VALID
(
£n£_bufãr
)) {

5984 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "Returned sense "

5985 "d©a", 
£n£_bufãr
,

5986 (
£n£_bufãr
));

5987 ià(
	`sc¡_ª®yze_£n£
(
£n£_bufãr
,

5988 (
£n£_bufãr
),

5989 
SCST_SENSE_KEY_VALID
,

5990 
ILLEGAL_REQUEST
, 0, 0)) {

5991 
	`PRINT_INFO
("Device %s doesn't support "

5992 "MODE SENSE", 
dev
->
vœt_Çme
);

5994 } ià(
	`sc¡_ª®yze_£n£
(
£n£_bufãr
,

5995 (
£n£_bufãr
),

5996 
SCST_SENSE_KEY_VALID
,

5997 
NOT_READY
, 0, 0)) {

5998 
	`PRINT_ERROR
("Device %s‚ot„eady",

5999 
dev
->
vœt_Çme
);

6003 
	`PRINT_INFO
("Internal MODE SENSEo "

6005 
dev
->
vœt_Çme
, 
rc
);

6006 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "MODE SENSE sense",

6007 
£n£_bufãr
, (sense_buffer));

6008 
	`ho¡_by‹
(
rc
)) {

6009 
DID_RESET
:

6010 
DID_ABORT
:

6011 
DID_SOFT_ERROR
:

6014 
brk
;

6016 
	`driv”_by‹
(
rc
)) {

6017 
DRIVER_BUSY
:

6018 
DRIVER_SOFT
:

6021 
brk
;

6026 
brk
:

6027 
	`PRINT_WARNING
("Unableo get device's %s control mode…age, using "

6029 "TAS %x, D_SENSE %d, has_own_Üd”_mgmˆ%d", 
dev
->
vœt_Çme
,

6030 
dev
->
t¡
, dev->
queue_®g
, dev->
swp
, dev->
s
, dev->
d_£n£
,

6031 
dev
->
has_own_Üd”_mgmt
);

6033 
out
:

6034 
	`TRACE_EXIT
();

6036 
	}
}

6037 
EXPORT_SYMBOL_GPL
(
sc¡_obš_deviû_·¿m‘”s
);

6040 
	$sc¡_´oûss_»£t
(
sc¡_deviû
 *
dev
,

6041 
sc¡_£ssiÚ
 *
Üigš©Ü
, 
sc¡_cmd
 *
exþude_cmd
,

6042 
sc¡_mgmt_cmd
 *
mcmd
, 
boÞ
 
£tUA
)

6044 
sc¡_tgt_dev
 *
tgt_dev
;

6045 
sc¡_cmd
 *
cmd
, *
tcmd
;

6047 
	`TRACE_ENTRY
();

6050 ià(
dev
->
dev_»£rved
) {

6051 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

6052 
dev_tgt_dev_li¡_’Œy
) {

6053 
	`TRACE_MGMT_DBG
("Clearing RESERVE'ation for "

6055 ()
tgt_dev
->
lun
);

6056 
	`þ—r_b™
(
SCST_TGT_DEV_RESERVED
,

6057 &
tgt_dev
->
tgt_dev_æags
);

6059 
dev
->
dev_»£rved
 = 0;

6067 
dev
->
dev_doubË_ua_possibË
 = 1;

6069 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

6070 
dev_tgt_dev_li¡_’Œy
) {

6071 
sc¡_£ssiÚ
 *
£ss
 = 
tgt_dev
->sess;

6077 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

6078 
	`sc¡_ä“_®l_UA
(
tgt_dev
);

6079 
	`mem£t
(
tgt_dev
->
tgt_dev_£n£
, 0,

6080 (
tgt_dev
->
tgt_dev_£n£
));

6081 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

6084 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

6086 
	`TRACE_DBG
("S—rchšg iÀ£s cmd†i¡ (£ss=%p)", 
£ss
);

6087 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
,

6088 
£ss_cmd_li¡_’Œy
) {

6089 ià(
cmd
 =ð
exþude_cmd
)

6091 ià((
cmd
->
tgt_dev
 ==gt_dev) ||

6092 ((
cmd
->
tgt_dev
 =ð
NULL
) &&

6093 (
cmd
->
lun
 =ð
tgt_dev
->lun))) {

6094 
	`sc¡_abÜt_cmd
(
cmd
, 
mcmd
,

6095 (
tgt_dev
->
£ss
 !ð
Üigš©Ü
), 0);

6098 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

6101 
	`li¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
tcmd
, &
dev
->
blocked_cmd_li¡
,

6102 
blocked_cmd_li¡_’Œy
) {

6103 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

6104 
	`li¡_d–
(&
cmd
->
blocked_cmd_li¡_’Œy
);

6105 
	`TRACE_MGMT_DBG
("Adding‡borted blocked cmd %p "

6106 "tØaùivcmd†i¡", 
cmd
);

6107 
	`¥š_lock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6108 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

6109 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

6110 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

6111 
	`¥š_uÆock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6115 ià(
£tUA
) {

6116 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

6117 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

6118 
dev
->
d_£n£
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

6119 
	`sc¡_dev_check_£t_loÿl_UA
(
dev
, 
exþude_cmd
, 
£n£_bufãr
, 
¦
);

6122 
	`TRACE_EXIT
();

6124 
	}
}

6127 
	$sc¡_tgt_dev_d–_ä“_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

6128 
sc¡_tgt_dev_UA
 *
ua
)

6130 
	`li¡_d–
(&
ua
->
UA_li¡_’Œy
);

6131 ià(
	`li¡_em±y
(&
tgt_dev
->
UA_li¡
))

6132 
	`þ—r_b™
(
SCST_TGT_DEV_UA_PENDING
, &
tgt_dev
->
tgt_dev_æags
);

6133 
	`mempoÞ_ä“
(
ua
, 
sc¡_ua_mempoÞ
);

6134 
	}
}

6137 
	$sc¡_£t_³ndšg_UA
(
sc¡_cmd
 *
cmd
)

6139 
»s
 = 0, 
i
;

6140 
sc¡_tgt_dev_UA
 *
UA_’Œy
;

6141 
boÞ
 
fœ¡
 = 
Œue
, 
glob®_uÆock
 = 
çl£
;

6142 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

6144 
	`TRACE_ENTRY
();

6152 
	`smp_rmb
();

6153 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

6154 
	`TRACE_MGMT_DBG
("NÙ s‘…’dšg UA fÜ‡bÜ‹d cmd %p", 
cmd
);

6155 
»s
 = -1;

6156 
out
;

6159 
	`TRACE_MGMT_DBG
("S‘tšg…’dšg UA cmd %p", 
cmd
);

6161 
	`¥š_lock_bh
(&
cmd
->
tgt_dev
->
tgt_dev_lock
);

6163 
agaš
:

6165 ià(
	`li¡_em±y
(&
cmd
->
tgt_dev
->
UA_li¡
)) {

6166 
	`TRACE_DBG
("%s",

6168 
»s
 = -1;

6169 
out_uÆock
;

6172 
UA_’Œy
 = 
	`li¡_’Œy
(
cmd
->
tgt_dev
->
UA_li¡
.
Ãxt
, 
	`ty³of
(*UA_entry),

6173 
UA_li¡_’Œy
);

6175 
	`TRACE_DBG
("next %p UA_entry %p",

6176 
cmd
->
tgt_dev
->
UA_li¡
.
Ãxt
, 
UA_’Œy
);

6178 ià(
UA_’Œy
->
glob®_UA
 && 
fœ¡
) {

6179 
	`TRACE_MGMT_DBG
("Glob® UA %°d‘eùed", 
UA_’Œy
);

6181 
	`¥š_uÆock_bh
(&
cmd
->
tgt_dev
->
tgt_dev_lock
);

6189 
	`loÿl_bh_di§bË
();

6191 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

6192 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

6193 
sc¡_tgt_dev
 *
tgt_dev
;

6194 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

6195 
£ss_tgt_dev_li¡_’Œy
) {

6197 
	`¥š_lock
(&
tgt_dev
->
tgt_dev_lock
);

6201 
fœ¡
 = 
çl£
;

6202 
glob®_uÆock
 = 
Œue
;

6203 
agaš
;

6206 ià(
	`sc¡_£t_cmd_”rÜ_£n£
(
cmd
, 
UA_’Œy
->
UA_£n£_bufãr
,

6207 
UA_’Œy
->
UA_v®id_£n£_Ën
) != 0)

6208 
out_uÆock
;

6210 
cmd
->
ua_ignÜe
 = 1;

6212 
	`li¡_d–
(&
UA_’Œy
->
UA_li¡_’Œy
);

6214 ià(
UA_’Œy
->
glob®_UA
) {

6215 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

6216 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

6217 
sc¡_tgt_dev
 *
tgt_dev
;

6219 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

6220 
£ss_tgt_dev_li¡_’Œy
) {

6221 
sc¡_tgt_dev_UA
 *
ua
;

6222 
	`li¡_fÜ_—ch_’Œy
(
ua
, &
tgt_dev
->
UA_li¡
,

6223 
UA_li¡_’Œy
) {

6224 ià(
ua
->
glob®_UA
 &&

6225 
	`memcmp
(
ua
->
UA_£n£_bufãr
,

6226 
UA_’Œy
->
UA_£n£_bufãr
,

6227 (
ua
->
UA_£n£_bufãr
)) == 0) {

6228 
	`TRACE_MGMT_DBG
("Freeing‚ot "

6230 
ua
);

6231 
	`sc¡_tgt_dev_d–_ä“_UA
(
tgt_dev
,

6232 
ua
);

6240 
	`mempoÞ_ä“
(
UA_’Œy
, 
sc¡_ua_mempoÞ
);

6242 ià(
	`li¡_em±y
(&
cmd
->
tgt_dev
->
UA_li¡
)) {

6243 
	`þ—r_b™
(
SCST_TGT_DEV_UA_PENDING
,

6244 &
cmd
->
tgt_dev
->
tgt_dev_æags
);

6247 
out_uÆock
:

6248 ià(
glob®_uÆock
) {

6249 
i
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; i >= 0; i--) {

6250 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

6251 
sc¡_tgt_dev
 *
tgt_dev
;

6252 
	`li¡_fÜ_—ch_’Œy_»v”£
(
tgt_dev
, 
h—d
,

6253 
£ss_tgt_dev_li¡_’Œy
) {

6254 
	`¥š_uÆock
(&
tgt_dev
->
tgt_dev_lock
);

6258 
	`loÿl_bh_’abË
();

6259 
	`¥š_lock_bh
(&
cmd
->
tgt_dev
->
tgt_dev_lock
);

6262 
	`¥š_uÆock_bh
(&
cmd
->
tgt_dev
->
tgt_dev_lock
);

6264 
out
:

6265 
	`TRACE_EXIT_RES
(
»s
);

6266  
»s
;

6267 
	}
}

6270 
	$sc¡_®loc_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

6271 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
)

6273 
sc¡_tgt_dev_UA
 *
UA_’Œy
 = 
NULL
;

6275 
	`TRACE_ENTRY
();

6277 
UA_’Œy
 = 
	`mempoÞ_®loc
(
sc¡_ua_mempoÞ
, 
GFP_ATOMIC
);

6278 ià(
UA_’Œy
 =ð
NULL
) {

6279 
	`PRINT_CRIT_ERROR
("%s", "UNIT ATTENTION memory "

6282 
	`PRINT_BUFFER
("Lo¡ UA", 
£n£
, 
£n£_Ën
);

6283 
out
;

6285 
	`mem£t
(
UA_’Œy
, 0, (*UA_entry));

6287 
UA_’Œy
->
glob®_UA
 = (
æags
 & 
SCST_SET_UA_FLAG_GLOBAL
) != 0;

6288 ià(
UA_’Œy
->
glob®_UA
)

6289 
	`TRACE_MGMT_DBG
("Queuešg glob® UA %p", 
UA_’Œy
);

6291 ià(
£n£_Ën
 > ()(
UA_’Œy
->
UA_£n£_bufãr
)) {

6292 
	`PRINT_WARNING
("Senseruncated (needed %d), shall you increase "

6293 "SCST_SENSE_BUFFERSIZE?", 
£n£_Ën
);

6294 
£n£_Ën
 = (
UA_’Œy
->
UA_£n£_bufãr
);

6296 
	`memýy
(
UA_’Œy
->
UA_£n£_bufãr
, 
£n£
, 
£n£_Ën
);

6297 
UA_’Œy
->
UA_v®id_£n£_Ën
 = 
£n£_Ën
;

6299 
	`£t_b™
(
SCST_TGT_DEV_UA_PENDING
, &
tgt_dev
->
tgt_dev_æags
);

6301 
	`TRACE_MGMT_DBG
("Addšg‚ew UAØtgt_dev %p", 
tgt_dev
);

6303 ià(
æags
 & 
SCST_SET_UA_FLAG_AT_HEAD
)

6304 
	`li¡_add
(&
UA_’Œy
->
UA_li¡_’Œy
, &
tgt_dev
->
UA_li¡
);

6306 
	`li¡_add_ž
(&
UA_’Œy
->
UA_li¡_’Œy
, &
tgt_dev
->
UA_li¡
);

6308 
out
:

6309 
	`TRACE_EXIT
();

6311 
	}
}

6314 
	$__sc¡_check_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

6315 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
)

6317 
sk_UA
 = 0;

6318 
sc¡_tgt_dev_UA
 *
UA_’Œy_tmp
;

6319 
Ën
 = 
	`mš_t
(, (
UA_’Œy_tmp
->
UA_£n£_bufãr
), 
£n£_Ën
);

6321 
	`TRACE_ENTRY
();

6323 
	`li¡_fÜ_—ch_’Œy
(
UA_’Œy_tmp
, &
tgt_dev
->
UA_li¡
,

6324 
UA_li¡_’Œy
) {

6325 ià(
	`memcmp
(
£n£
, 
UA_’Œy_tmp
->
UA_£n£_bufãr
, 
Ën
) == 0) {

6326 
	`TRACE_MGMT_DBG
("%s", "UA‡lreadyƒxists");

6327 
sk_UA
 = 1;

6332 ià(
sk_UA
 == 0)

6333 
	`sc¡_®loc_£t_UA
(
tgt_dev
, 
£n£
, 
Ën
, 
æags
);

6335 
	`TRACE_EXIT
();

6337 
	}
}

6339 
	$sc¡_check_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

6340 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
)

6342 
	`TRACE_ENTRY
();

6344 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

6345 
	`__sc¡_check_£t_UA
(
tgt_dev
, 
£n£
, 
£n£_Ën
, 
æags
);

6346 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

6348 
	`TRACE_EXIT
();

6350 
	}
}

6353 
	$sc¡_dev_check_£t_loÿl_UA
(
sc¡_deviû
 *
dev
,

6354 
sc¡_cmd
 *
exþude
, cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
)

6356 
sc¡_tgt_dev
 *
tgt_dev
, *
exþude_tgt_dev
 = 
NULL
;

6358 
	`TRACE_ENTRY
();

6360 ià(
exþude
 !ð
NULL
)

6361 
exþude_tgt_dev
 = 
exþude
->
tgt_dev
;

6363 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

6364 
dev_tgt_dev_li¡_’Œy
) {

6365 ià(
tgt_dev
 !ð
exþude_tgt_dev
)

6366 
	`sc¡_check_£t_UA
(
tgt_dev
, 
£n£
, 
£n£_Ën
, 0);

6369 
	`TRACE_EXIT
();

6371 
	}
}

6374 
	$__sc¡_dev_check_£t_UA
(
sc¡_deviû
 *
dev
,

6375 
sc¡_cmd
 *
exþude
, cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
)

6377 
	`TRACE_ENTRY
();

6379 
	`TRACE_MGMT_DBG
("Proûssšg UA dev %s", 
dev
->
vœt_Çme
);

6382 ià(
	`sc¡_ª®yze_£n£
(
£n£
, 
£n£_Ën
, 
SCST_SENSE_ASC_VALID
,

6383 0, 
SCST_SENSE_ASC_UA_RESET
, 0))

6384 
	`sc¡_´oûss_»£t
(
dev
,

6385 (
exþude
 !ð
NULL
è?ƒxþude->
£ss
 : NULL,

6386 
exþude
, 
NULL
, 
çl£
);

6388 
	`sc¡_dev_check_£t_loÿl_UA
(
dev
, 
exþude
, 
£n£
, 
£n£_Ën
);

6390 
	`TRACE_EXIT
();

6392 
	}
}

6395 
	$sc¡_ä“_®l_UA
(
sc¡_tgt_dev
 *
tgt_dev
)

6397 
sc¡_tgt_dev_UA
 *
UA_’Œy
, *
t
;

6399 
	`TRACE_ENTRY
();

6401 
	`li¡_fÜ_—ch_’Œy_§ã
(
UA_’Œy
, 
t
,

6402 &
tgt_dev
->
UA_li¡
, 
UA_li¡_’Œy
) {

6403 
	`TRACE_MGMT_DBG
("Clearing UA forgt_dev LUN %lld",

6404 ()
tgt_dev
->
lun
);

6405 
	`li¡_d–
(&
UA_’Œy
->
UA_li¡_’Œy
);

6406 
	`mempoÞ_ä“
(
UA_’Œy
, 
sc¡_ua_mempoÞ
);

6408 
	`INIT_LIST_HEAD
(&
tgt_dev
->
UA_li¡
);

6409 
	`þ—r_b™
(
SCST_TGT_DEV_UA_PENDING
, &
tgt_dev
->
tgt_dev_æags
);

6411 
	`TRACE_EXIT
();

6413 
	}
}

6416 
sc¡_cmd
 *
	$__sc¡_check_deã¼ed_commªds
(
sc¡_Üd”_d©a
 *
Üd”_d©a
)

6418 
sc¡_cmd
 *
»s
 = 
NULL
, *
cmd
, *
t
;

6419 
	`ty³of
(
Üd”_d©a
->
ex³ùed_¢
)ƒxpected_sn = order_data->expected_sn;

6421 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

6423 ià(
	`uÆik–y
(
Üd”_d©a
->
hq_cmd_couÁ
 != 0))

6424 
out_uÆock
;

6426 
»¡¬t
:

6427 
	`li¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
t
, &
Üd”_d©a
->
deã¼ed_cmd_li¡
,

6428 
¢_cmd_li¡_’Œy
) {

6429 
	`EXTRACHECKS_BUG_ON
(
cmd
->
queue_ty³
 ==

6430 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
);

6431 ià(
cmd
->
¢
 =ð
ex³ùed_¢
) {

6432 
	`TRACE_SN
("Deferred command %p (sn %d, set %d) found",

6433 
cmd
, cmd->
¢
, cmd->
¢_£t
);

6434 
Üd”_d©a
->
def_cmd_couÁ
--;

6435 
	`li¡_d–
(&
cmd
->
¢_cmd_li¡_’Œy
);

6436 ià(
»s
 =ð
NULL
)

6437 
»s
 = 
cmd
;

6439 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6440 
	`TRACE_SN
("Adding cmd %po‡ctive cmd†ist",

6441 
cmd
);

6442 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

6443 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

6444 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

6445 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6449 ià(
»s
 !ð
NULL
)

6450 
out_uÆock
;

6452 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
Üd”_d©a
->
sk³d_¢_li¡
,

6453 
¢_cmd_li¡_’Œy
) {

6454 
	`EXTRACHECKS_BUG_ON
(
cmd
->
queue_ty³
 ==

6455 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
);

6456 ià(
cmd
->
¢
 =ð
ex³ùed_¢
) {

6457 
©omic_t
 *
¦Ù
 = 
cmd
->
¢_¦Ù
;

6463 
	`TRACE_SN
("cmd %p (tag %llu) with skipped sn %d found",

6464 
cmd
,

6465 ()
cmd
->
g
,

6466 
cmd
->
¢
);

6467 
Üd”_d©a
->
def_cmd_couÁ
--;

6468 
	`li¡_d–
(&
cmd
->
¢_cmd_li¡_’Œy
);

6469 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

6470 ià(
	`‹¡_ªd_£t_b™
(
SCST_CMD_CAN_BE_DESTROYED
,

6471 &
cmd
->
cmd_æags
))

6472 
	`sc¡_de¡roy_put_cmd
(
cmd
);

6473 
	`sc¡_šc_ex³ùed_¢
(
Üd”_d©a
, 
¦Ù
);

6474 
ex³ùed_¢
 = 
Üd”_d©a
->expected_sn;

6475 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

6476 
»¡¬t
;

6480 
out_uÆock
:

6481 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

6482  
»s
;

6483 
	}
}

6497 
sc¡_add_thr_d©a
(
sc¡_tgt_dev
 *
tgt_dev
,

6498 
sc¡_thr_d©a_hdr
 *
d©a
,

6499 (*
ä“_â
è(
sc¡_thr_d©a_hdr
 *
d©a
))

6501 
d©a
->
owÃr_thr
 = 
cu¼’t
;

6502 
	`©omic_£t
(&
d©a
->
»f
, 1);

6503 
	`EXTRACHECKS_BUG_ON
(
ä“_â
 =ð
NULL
);

6504 
d©a
->
ä“_â
 = free_fn;

6505 
	`¥š_lock
(&
tgt_dev
->
thr_d©a_lock
);

6506 
	`li¡_add_ž
(&
d©a
->
thr_d©a_li¡_’Œy
, &
tgt_dev
->
thr_d©a_li¡
);

6507 
	`¥š_uÆock
(&
tgt_dev
->
thr_d©a_lock
);

6508 
	}
}

6509 
EXPORT_SYMBOL_GPL
(
sc¡_add_thr_d©a
);

6516 
	$sc¡_d–_®l_thr_d©a
(
sc¡_tgt_dev
 *
tgt_dev
)

6518 
	`¥š_lock
(&
tgt_dev
->
thr_d©a_lock
);

6519 !
	`li¡_em±y
(&
tgt_dev
->
thr_d©a_li¡
)) {

6520 
sc¡_thr_d©a_hdr
 *
d
 = 
	`li¡_’Œy
(

6521 
tgt_dev
->
thr_d©a_li¡
.
Ãxt
, 
	`ty³of
(*
d
),

6522 
thr_d©a_li¡_’Œy
);

6523 
	`li¡_d–
(&
d
->
thr_d©a_li¡_’Œy
);

6524 
	`¥š_uÆock
(&
tgt_dev
->
thr_d©a_lock
);

6525 
	`sc¡_thr_d©a_put
(
d
);

6526 
	`¥š_lock
(&
tgt_dev
->
thr_d©a_lock
);

6528 
	`¥š_uÆock
(&
tgt_dev
->
thr_d©a_lock
);

6530 
	}
}

6531 
EXPORT_SYMBOL_GPL
(
sc¡_d–_®l_thr_d©a
);

6538 
	$sc¡_dev_d–_®l_thr_d©a
(
sc¡_deviû
 *
dev
)

6540 
sc¡_tgt_dev
 *
tgt_dev
;

6542 
	`TRACE_ENTRY
();

6544 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6546 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

6547 
dev_tgt_dev_li¡_’Œy
) {

6548 
	`sc¡_d–_®l_thr_d©a
(
tgt_dev
);

6551 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6553 
	`TRACE_EXIT
();

6555 
	}
}

6556 
EXPORT_SYMBOL_GPL
(
sc¡_dev_d–_®l_thr_d©a
);

6559 
sc¡_thr_d©a_hdr
 *
	$__sc¡_fšd_thr_d©a_locked
(

6560 
sc¡_tgt_dev
 *
tgt_dev
, 
sk_¡ruù
 *
tsk
)

6562 
sc¡_thr_d©a_hdr
 *
»s
 = 
NULL
, *
d
;

6564 
	`li¡_fÜ_—ch_’Œy
(
d
, &
tgt_dev
->
thr_d©a_li¡
, 
thr_d©a_li¡_’Œy
) {

6565 ià(
d
->
owÃr_thr
 =ð
tsk
) {

6566 
»s
 = 
d
;

6567 
	`sc¡_thr_d©a_g‘
(
»s
);

6571  
»s
;

6572 
	}
}

6579 
sc¡_thr_d©a_hdr
 *
	$__sc¡_fšd_thr_d©a
(
sc¡_tgt_dev
 *
tgt_dev
,

6580 
sk_¡ruù
 *
tsk
)

6582 
sc¡_thr_d©a_hdr
 *
»s
;

6584 
	`¥š_lock
(&
tgt_dev
->
thr_d©a_lock
);

6585 
»s
 = 
	`__sc¡_fšd_thr_d©a_locked
(
tgt_dev
, 
tsk
);

6586 
	`¥š_uÆock
(&
tgt_dev
->
thr_d©a_lock
);

6588  
»s
;

6589 
	}
}

6590 
EXPORT_SYMBOL_GPL
(
__sc¡_fšd_thr_d©a
);

6592 
boÞ
 
	$sc¡_d–_thr_d©a
(
sc¡_tgt_dev
 *
tgt_dev
, 
sk_¡ruù
 *
tsk
)

6594 
boÞ
 
»s
;

6595 
sc¡_thr_d©a_hdr
 *
td
;

6597 
	`¥š_lock
(&
tgt_dev
->
thr_d©a_lock
);

6599 
td
 = 
	`__sc¡_fšd_thr_d©a_locked
(
tgt_dev
, 
tsk
);

6600 ià(
td
 !ð
NULL
) {

6601 
	`li¡_d–
(&
td
->
thr_d©a_li¡_’Œy
);

6602 
»s
 = 
Œue
;

6604 
»s
 = 
çl£
;

6606 
	`¥š_uÆock
(&
tgt_dev
->
thr_d©a_lock
);

6608 ià(
td
 !ð
NULL
) {

6610 
	`sc¡_thr_d©a_put
(
td
);

6611 
	`sc¡_thr_d©a_put
(
td
);

6614  
»s
;

6615 
	}
}

6617 
	$__sc¡_unblock_deã¼ed
(
sc¡_Üd”_d©a
 *
Üd”_d©a
,

6618 
sc¡_cmd
 *
out_of_¢_cmd
)

6620 
	`EXTRACHECKS_BUG_ON
(!
out_of_¢_cmd
->
¢_£t
);

6622 ià(
out_of_¢_cmd
->
¢
 =ð
Üd”_d©a
->
ex³ùed_¢
) {

6623 
	`sc¡_šc_ex³ùed_¢
(
Üd”_d©a
, 
out_of_¢_cmd
->
¢_¦Ù
);

6624 
	`sc¡_make_deã¼ed_commªds_aùive
(
Üd”_d©a
);

6626 
out_of_¢_cmd
->
out_of_¢
 = 1;

6627 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

6628 
Üd”_d©a
->
def_cmd_couÁ
++;

6629 
	`li¡_add_ž
(&
out_of_¢_cmd
->
¢_cmd_li¡_’Œy
,

6630 &
Üd”_d©a
->
sk³d_¢_li¡
);

6631 
	`TRACE_SN
("out_of_sn_cmd %p with sn %d‡ddedo skipped_sn_list"

6632 " (ex³ùed_¢ %d)", 
out_of_¢_cmd
, out_of_¢_cmd->
¢
,

6633 
Üd”_d©a
->
ex³ùed_¢
);

6634 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

6638 
	}
}

6640 
	$sc¡_unblock_deã¼ed
(
sc¡_Üd”_d©a
 *
Üd”_d©a
,

6641 
sc¡_cmd
 *
out_of_¢_cmd
)

6643 
	`TRACE_ENTRY
();

6645 ià(!
out_of_¢_cmd
->
¢_£t
) {

6646 
	`TRACE_SN
("cmd %°w™houˆ¢", 
out_of_¢_cmd
);

6647 
out
;

6650 
	`__sc¡_unblock_deã¼ed
(
Üd”_d©a
, 
out_of_¢_cmd
);

6652 
out
:

6653 
	`TRACE_EXIT
();

6655 
	}
}

6658 
	$sc¡_block_dev
(
sc¡_deviû
 *
dev
)

6660 
dev
->
block_couÁ
++;

6661 
	`TRACE_MGMT_DBG
("Deviû BLOCK (Ãw couÁ %d), dev %s", 
dev
->
block_couÁ
,

6662 
dev
->
vœt_Çme
);

6663 
	}
}

6666 
boÞ
 
	$__sc¡_check_blocked_dev
(
sc¡_cmd
 *
cmd
)

6668 
»s
 = 
çl£
;

6669 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

6671 
	`TRACE_ENTRY
();

6673 
	`EXTRACHECKS_BUG_ON
(
cmd
->
unblock_dev
);

6675 ià(
	`uÆik–y
(
cmd
->
š‹º®
è&& (cmd->
cdb
[0] =ð
REQUEST_SENSE
)) {

6680 
out
;

6683 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)))

6684 
out
;

6686 ià(
dev
->
block_couÁ
 > 0) {

6687 
	`TRACE_MGMT_DBG
("Delaying cmd %p dueo blocking "

6688 "Ñag %Îu, o°%x, dev %s)", 
cmd
,

6689 ()
cmd
->
g
, cmd->
cdb
[0],

6690 
dev
->
vœt_Çme
);

6691 
out_block
;

6692 } ià(
	`sc¡_is_¡riùly_£rŸlized_cmd
(
cmd
)) {

6693 
	`TRACE_MGMT_DBG
("cmd %p (tag %llu, op %x): blocking further "

6694 "cmd Ú dev % dutØ¡riù s”Ÿliz©iÚ", 
cmd
,

6695 ()
cmd
->
g
, cmd->
cdb
[0],

6696 
dev
->
vœt_Çme
);

6697 
	`sc¡_block_dev
(
dev
);

6698 ià(
dev
->
Ú_dev_cmd_couÁ
 > 1) {

6699 
	`TRACE_MGMT_DBG
("Delaying strictly serialized cmd %p "

6700 "(dev %s, on_dev_cmd tØwa™ %d)", 
cmd
,

6701 
dev
->
vœt_Çme
, dev->
Ú_dev_cmd_couÁ
-1);

6702 
	`EXTRACHECKS_BUG_ON
(
dev
->
¡riùly_£rŸlized_cmd_wa™šg
);

6703 
dev
->
¡riùly_£rŸlized_cmd_wa™šg
 = 1;

6704 
out_block
;

6706 
cmd
->
unblock_dev
 = 1;

6707 } ià((
dev
->
dev_doubË_ua_possibË
è|| 
	`sc¡_is_£rŸlized_cmd
(
cmd
)) {

6708 
	`TRACE_MGMT_DBG
("cmd %p (tag %llu, op %x): blocking further cmds "

6709 "Ú dev % dutØ%s", 
cmd
, ()cmd->
g
,

6710 
cmd
->
cdb
[0], 
dev
->
vœt_Çme
,

6711 
dev
->
dev_doubË_ua_possibË
 ? "possible double„eset UA" :

6713 
	`sc¡_block_dev
(
dev
);

6714 
cmd
->
unblock_dev
 = 1;

6716 
	`TRACE_MGMT_DBG
("NØblock fÜ deviû %s", 
dev
->
vœt_Çme
);

6718 
out
:

6719 
	`TRACE_EXIT_RES
(
»s
);

6720  
»s
;

6722 
out_block
:

6723 ià(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
)

6724 
	`li¡_add
(&
cmd
->
blocked_cmd_li¡_’Œy
,

6725 &
dev
->
blocked_cmd_li¡
);

6727 
	`li¡_add_ž
(&
cmd
->
blocked_cmd_li¡_’Œy
,

6728 &
dev
->
blocked_cmd_li¡
);

6729 
»s
 = 
Œue
;

6730 
out
;

6731 
	}
}

6734 
	$sc¡_unblock_dev
(
sc¡_deviû
 *
dev
)

6736 
	`TRACE_ENTRY
();

6738 
	`TRACE_MGMT_DBG
("Device UNBLOCK(new %d), dev %s",

6739 
dev
->
block_couÁ
-1, dev->
vœt_Çme
);

6741 #ifdeà
CONFIG_SMP


6742 
	`EXTRACHECKS_BUG_ON
(!
	`¥š_is_locked
(&
dev
->
dev_lock
));

6745 ià(--
dev
->
block_couÁ
 == 0) {

6746 
sc¡_cmd
 *
cmd
, *
tcmd
;

6747 
æags
;

6749 
	`loÿl_œq_§ve
(
æags
);

6750 
	`li¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
tcmd
, &
dev
->
blocked_cmd_li¡
,

6751 
blocked_cmd_li¡_’Œy
) {

6752 
boÞ
 
¡riùly_£rŸlized
;

6753 
	`li¡_d–
(&
cmd
->
blocked_cmd_li¡_’Œy
);

6754 
	`TRACE_MGMT_DBG
("Adding blocked cmd %po‡ctive cmd "

6755 "li¡", 
cmd
);

6756 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6757 ià(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
)

6758 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

6759 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

6761 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

6762 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

6763 
¡riùly_£rŸlized
 = 
	`sc¡_is_¡riùly_£rŸlized_cmd
(
cmd
);

6764 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

6765 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

6766 ià(
dev
->
¡riùly_£rŸlized_cmd_wa™šg
 && 
¡riùly_£rŸlized
)

6769 
	`loÿl_œq_»¡Üe
(
æags
);

6771 
dev
->
¡riùly_£rŸlized_cmd_wa™šg
 = 0;

6774 
	`sBUG_ON
(
dev
->
block_couÁ
 < 0);

6776 
	`TRACE_EXIT
();

6778 
	}
}

6780 
	$sc¡_Ú_hq_cmd_»¥Ú£
(
sc¡_cmd
 *
cmd
)

6782 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
cmd
->
cur_Üd”_d©a
;

6784 
	`TRACE_ENTRY
();

6786 ià(!
cmd
->
hq_cmd_šûd
)

6787 
out
;

6789 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

6790 
Üd”_d©a
->
hq_cmd_couÁ
--;

6791 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

6793 
	`EXTRACHECKS_BUG_ON
(
Üd”_d©a
->
hq_cmd_couÁ
 < 0);

6800 ià(
Üd”_d©a
->
hq_cmd_couÁ
 == 0)

6801 
	`sc¡_make_deã¼ed_commªds_aùive
(
Üd”_d©a
);

6803 
out
:

6804 
	`TRACE_EXIT
();

6806 
	}
}

6808 
	$sc¡_¡Üe_£n£
(
sc¡_cmd
 *
cmd
)

6810 
	`TRACE_ENTRY
();

6812 ià(
	`SCST_SENSE_VALID
(
cmd
->
£n£
) &&

6813 !
	`‹¡_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
) &&

6814 (
cmd
->
tgt_dev
 !ð
NULL
)) {

6815 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

6817 
	`TRACE_DBG
("StÜšg s’£ (cmd %p)", 
cmd
);

6819 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

6821 ià(
cmd
->
£n£_v®id_Ën
 <ð(
tgt_dev
->
tgt_dev_£n£
))

6822 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 = 
cmd
->
£n£_v®id_Ën
;

6824 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 = Ñgt_dev->
tgt_dev_£n£
);

6825 
	`PRINT_ERROR
("Stored senseruncatedo size %d "

6826 "Ò“ded %d)", 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
,

6827 
cmd
->
£n£_v®id_Ën
);

6829 
	`memýy
(
tgt_dev
->
tgt_dev_£n£
, 
cmd
->
£n£
,

6830 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
);

6832 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

6835 
	`TRACE_EXIT
();

6837 
	}
}

6839 
	$sc¡_xm™_´oûss_abÜ‹d_cmd
(
sc¡_cmd
 *
cmd
)

6841 
	`TRACE_ENTRY
();

6843 
	`TRACE_MGMT_DBG
("AbÜ‹d cmd %°dÚ(cmd_»à%d)", 
cmd
,

6844 
	`©omic_»ad
(&
cmd
->
cmd_»f
));

6846 
	`sc¡_dÚe_cmd_mgmt
(
cmd
);

6848 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
)) {

6849 ià(
cmd
->
com¶‘ed
) {

6851 
out
;

6855 ià(
	`‹¡_b™
(
SCST_CMD_DEVICE_TAS
, &
cmd
->
cmd_æags
)) {

6856 
	`TRACE_MGMT_DBG
("Flag ABORTED OTHER set for cmd %p "

6857 "Ñag %Îu),„‘uºšg TASK ABORTED ", 
cmd
,

6858 ()
cmd
->
g
);

6859 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_TASK_ABORTED
);

6861 
	`TRACE_MGMT_DBG
("Flag ABORTED OTHER set for cmd %p "

6864 
cmd
, ()cmd->
g
);

6870 
	`þ—r_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
);

6874 
out
:

6875 
	`TRACE_EXIT
();

6877 
	}
}

6891 
	$sc¡_g‘_max_lun_commªds
(
sc¡_£ssiÚ
 *
£ss
, 
ušt64_t
 
lun
)

6893  
SCST_MAX_TGT_DEV_COMMANDS
;

6894 
	}
}

6895 
EXPORT_SYMBOL
(
sc¡_g‘_max_lun_commªds
);

6902 
	$sc¡_»assign_³rsi¡’t_£ss_¡©es
(
sc¡_£ssiÚ
 *
Ãw_£ss
,

6903 
sc¡_£ssiÚ
 *
Þd_£ss
)

6905 
sc¡_deviû
 *
dev
;

6907 
	`TRACE_ENTRY
();

6909 
	`TRACE_PR
("Reassigning…ersistent states from old_sess %po "

6910 "Ãw_£s %p", 
Þd_£ss
, 
Ãw_£ss
);

6912 ià((
Ãw_£ss
 =ð
NULL
è|| (
Þd_£ss
 == NULL)) {

6913 
	`TRACE_DBG
("%s", "new_sess or old_sess is NULL");

6914 
out
;

6917 ià(
Ãw_£ss
 =ð
Þd_£ss
) {

6918 
	`TRACE_DBG
("%s", "new_sess or old_sess‡rehe same");

6919 
out
;

6922 ià((
Ãw_£ss
->
Œª¥Üt_id
 =ð
NULL
) ||

6923 (
Þd_£ss
->
Œª¥Üt_id
 =ð
NULL
)) {

6924 
	`TRACE_DBG
("%s", "new_sess or old_sess doesn't support PRs");

6925 
out
;

6928 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6930 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

6931 
sc¡_tgt_dev
 *
tgt_dev
;

6932 
sc¡_tgt_dev
 *
Ãw_tgt_dev
 = 
NULL
, *
Þd_tgt_dev
 = NULL;

6934 
	`TRACE_DBG
("Proûssšg dev %s", 
dev
->
vœt_Çme
);

6936 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

6937 
dev_tgt_dev_li¡_’Œy
) {

6938 ià(
tgt_dev
->
£ss
 =ð
Ãw_£ss
) {

6939 
Ãw_tgt_dev
 = 
tgt_dev
;

6940 ià(
Þd_tgt_dev
 !ð
NULL
)

6943 ià(
tgt_dev
->
£ss
 =ð
Þd_£ss
) {

6944 
Þd_tgt_dev
 = 
tgt_dev
;

6945 ià(
Ãw_tgt_dev
 !ð
NULL
)

6950 ià((
Ãw_tgt_dev
 =ð
NULL
è|| (
Þd_tgt_dev
 == NULL)) {

6951 
	`TRACE_DBG
("new_tgt_dev %p or old_sess %p is NULL, "

6952 "skpšg (dev %s)", 
Ãw_tgt_dev
, 
Þd_tgt_dev
,

6953 
dev
->
vœt_Çme
);

6957 
	`sc¡_´_wr™e_lock
(
dev
);

6959 ià(
Þd_tgt_dev
->
»gi¡¿Á
 !ð
NULL
) {

6960 
	`TRACE_PR
("Reassigning„eg %p fromgt_dev %po %p",

6961 
Þd_tgt_dev
->
»gi¡¿Á
, old_tgt_dev,

6962 
Ãw_tgt_dev
);

6964 ià(
Ãw_tgt_dev
->
»gi¡¿Á
 !ð
NULL
)

6965 
Ãw_tgt_dev
->
»gi¡¿Á
->
tgt_dev
 = 
NULL
;

6967 
Ãw_tgt_dev
->
»gi¡¿Á
 = 
Þd_tgt_dev
->registrant;

6968 
Ãw_tgt_dev
->
»gi¡¿Á
->
tgt_dev
 =‚ew_tgt_dev;

6970 
Þd_tgt_dev
->
»gi¡¿Á
 = 
NULL
;

6973 
	`sc¡_´_wr™e_uÆock
(
dev
);

6976 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6978 
out
:

6979 
	`TRACE_EXIT
();

6981 
	}
}

6982 
EXPORT_SYMBOL
(
sc¡_»assign_³rsi¡’t_£ss_¡©es
);

6991 *
	$sc¡_g‘_Ãxt_Ëxem
(**
tok’_¡r
)

6993 *
p
 = *
tok’_¡r
;

6994 *
q
;

6995 cÚ¡ 
bÏnk
 = '\0';

6997 ià((
tok’_¡r
 =ð
NULL
) || (*token_str == NULL))

6998  (*)&
bÏnk
;

7000 
p
 = *
tok’_¡r
; (*°!ð'\0'è&& (
	`is¥aû
(*p) || (*p == '='));…++)

7003 
q
 = 
p
; (*q !ð'\0'è&& !
	`is¥aû
(*q) && (*q != '='); q++)

7006 ià(*
q
 != '\0')

7007 *
q
++ = '\0';

7009 *
tok’_¡r
 = 
q
;

7010  
p
;

7011 
	}
}

7012 
EXPORT_SYMBOL_GPL
(
sc¡_g‘_Ãxt_Ëxem
);

7021 
	$sc¡_»¡Üe_tok’_¡r
(*
´ev_Ëxem
, *
tok’_¡r
)

7023 ià(&
´ev_Ëxem
[
	`¡¾’
Õ»v_Ëxem)] !ð
tok’_¡r
)

7024 
´ev_Ëxem
[
	`¡¾’
(prev_lexem)] = ' ';

7026 
	}
}

7027 
EXPORT_SYMBOL_GPL
(
sc¡_»¡Üe_tok’_¡r
);

7036 *
	$sc¡_g‘_Ãxt_tok’_¡r
(**
šput_¡r
)

7038 *
p
 = *
šput_¡r
;

7039 
i
 = 0;

7041 (
p
[
i
] != '\n') && (p[i] != ';') && (p[i] != '\0'))

7042 
i
++;

7044 ià(
i
 == 0)

7045  
NULL
;

7047 ià(
p
[
i
] == '\0')

7048 *
šput_¡r
 = &
p
[
i
];

7050 *
šput_¡r
 = &
p
[
i
+1];

7052 
p
[
i
] = '\0';

7054  
p
;

7055 
	}
}

7056 
EXPORT_SYMBOL_GPL
(
sc¡_g‘_Ãxt_tok’_¡r
);

7058 
__š™
 
	$sc¡_scsi_Ý_li¡_š™
()

7060 
i
;

7061 
ušt8_t
 
Ý
 = 0xff;

7063 
	`TRACE_ENTRY
();

7065 
i
 = 0; i < 256; i++)

7066 
sc¡_scsi_Ý_li¡
[
i
] = 
SCST_CDB_TBL_SIZE
;

7068 
i
 = 0; i < 
SCST_CDB_TBL_SIZE
; i++) {

7069 ià(
sc¡_scsi_Ý_bË
[
i
].
Ýs
 !ð
Ý
) {

7070 
Ý
 = 
sc¡_scsi_Ý_bË
[
i
].
Ýs
;

7071 
sc¡_scsi_Ý_li¡
[
Ý
] = 
i
;

7075 
	`TRACE_EXIT
();

7077 
	}
}

7079 
__š™
 
	$sc¡_lib_š™
()

7081 
»s
 = 0;

7083 
	`sc¡_scsi_Ý_li¡_š™
();

7085 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

7086 
scsi_io_cÚ‹xt_ÿche
 = 
	`kmem_ÿche_ü—‹
("scst_scsi_io_context",

7087 (
scsi_io_cÚ‹xt
),

7088 0, 0, 
NULL
);

7089 ià(!
scsi_io_cÚ‹xt_ÿche
) {

7090 
	`PRINT_ERROR
("%s", "Can't init scsi io context cache");

7091 
»s
 = -
ENOMEM
;

7092 
out
;

7095 
out
:

7097 
	`TRACE_EXIT_RES
(
»s
);

7098  
»s
;

7099 
	}
}

7101 
	$sc¡_lib_ex™
()

7103 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 30)

7104 
	`BUILD_BUG_ON
(
SCST_MAX_CDB_SIZE
 !ð
BLK_MAX_CDB
);

7105 
	`BUILD_BUG_ON
(
SCST_SENSE_BUFFERSIZE
 < 
SCSI_SENSE_BUFFERSIZE
);

7107 
	`kmem_ÿche_de¡roy
(
scsi_io_cÚ‹xt_ÿche
);

7109 
	}
}

7111 #ifdeà
CONFIG_SCST_DEBUG


7121 
	$sc¡_¿ndom
()

7123 
In™ed
;

7124 
RªdomV®ue
;

7125 
	`DEFINE_SPINLOCK
(
lock
);

7127 
rv
;

7128 
lo
;

7129 
hi
;

7130 
æags
;

7132 
	`¥š_lock_œq§ve
(&
lock
, 
æags
);

7133 ià(!
In™ed
) {

7134 
RªdomV®ue
 = 
jiff›s
;

7135 
In™ed
 = 1;

7137 
rv
 = 
RªdomV®ue
;

7138 
hi
 = 
rv
 / 127773;

7139 
lo
 = 
rv
 % 127773;

7140 
rv
 = 16807 * 
lo
 - 2836 * 
hi
;

7141 ià(
rv
 <= 0)

7142 
rv
 += 2147483647;

7143 
RªdomV®ue
 = 
rv
;

7144 
	`¥š_uÆock_œq»¡Üe
(&
lock
, 
æags
);

7145  
rv
;

7146 
	}
}

7147 
EXPORT_SYMBOL_GPL
(
sc¡_¿ndom
);

7150 #ifdeà
CONFIG_SCST_DEBUG_TM


7152 
	#TM_DBG_STATE_ABORT
 0

	)

7153 
	#TM_DBG_STATE_RESET
 1

	)

7154 
	#TM_DBG_STATE_OFFLINE
 2

	)

7156 
	#INIT_TM_DBG_STATE
 
TM_DBG_STATE_ABORT


	)

7158 
tm_dbg_tim”_â
(
¬g
);

7160 
DEFINE_SPINLOCK
(
sc¡_tm_dbg_lock
);

7163 
	mtm_dbg_»Ëa£
:1;

7164 
	mtm_dbg_blocked
:1;

7165 } 
	gtm_dbg_æags
;

7166 
LIST_HEAD
(
tm_dbg_d–ayed_cmd_li¡
);

7167 
	gtm_dbg_d–ayed_cmds_couÁ
;

7168 
	gtm_dbg_·s£d_cmds_couÁ
;

7169 
	gtm_dbg_¡©e
;

7170 
	gtm_dbg_Ú_¡©e_·s£s
;

7171 
DEFINE_TIMER
(
tm_dbg_tim”
, 
tm_dbg_tim”_â
, 0, 0);

7172 
sc¡_tgt_dev
 *
	gtm_dbg_tgt_dev
;

7174 cÚ¡ 
	gtm_dbg_Ú_¡©e_num_·s£s
[] = { 5, 1, 0x7ffffff };

7176 
	$tm_dbg_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

7178 ià(
tgt_dev
->
lun
 == 6) {

7179 
æags
;

7181 ià(
tm_dbg_tgt_dev
 !ð
NULL
)

7182 
	`tm_dbg_deš™_tgt_dev
(
tm_dbg_tgt_dev
);

7184 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

7185 
tm_dbg_¡©e
 = 
INIT_TM_DBG_STATE
;

7186 
tm_dbg_Ú_¡©e_·s£s
 =

7187 
tm_dbg_Ú_¡©e_num_·s£s
[
tm_dbg_¡©e
];

7188 
tm_dbg_tgt_dev
 = 
tgt_dev
;

7189 
	`PRINT_INFO
("LUN %lld connected from initiator %s is under "

7191 ()
tgt_dev
->
lun
,

7192 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
,gt_dev);

7193 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

7196 
	}
}

7198 
	$tm_dbg_deš™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

7200 ià(
tm_dbg_tgt_dev
 =ð
tgt_dev
) {

7201 
æags
;

7202 
	`TRACE_MGMT_DBG
("Deš™ TM debuggšggt_dev %p", 
tgt_dev
);

7203 
	`d–_tim”_sync
(&
tm_dbg_tim”
);

7204 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

7205 
tm_dbg_tgt_dev
 = 
NULL
;

7206 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

7209 
	}
}

7211 
	$tm_dbg_tim”_â
(
¬g
)

7213 
	`TRACE_MGMT_DBG
("%s", "delayed cmdimerƒxpired");

7214 
tm_dbg_æags
.
tm_dbg_»Ëa£
 = 1;

7216 
	`smp_wmb
();

7217 
	`wake_up_®l
(&
tm_dbg_tgt_dev
->
aùive_cmd_th»ads
->
cmd_li¡_wa™Q
);

7219 
	}
}

7222 
	$tm_dbg_d–ay_cmd
(
sc¡_cmd
 *
cmd
)

7224 
tm_dbg_¡©e
) {

7225 
TM_DBG_STATE_ABORT
:

7226 ià(
tm_dbg_d–ayed_cmds_couÁ
 == 0) {

7227 
d
 = 58*
HZ
 + (
	`sc¡_¿ndom
() % (4*HZ));

7228 
	`TRACE_MGMT_DBG
("STATE ABORT: delaying cmd %p (tag %llu)"

7230 "tm_dbg_Ú_¡©e_·s£s=%d", 
cmd
, cmd->
g
,

7231 
d
/
HZ
, (d%HZ)*100/HZ, d, 
tm_dbg_Ú_¡©e_·s£s
);

7232 
	`mod_tim”
(&
tm_dbg_tim”
, 
jiff›s
 + 
d
);

7234 
tm_dbg_æags
.
tm_dbg_blocked
 = 1;

7237 
	`TRACE_MGMT_DBG
("Delaying‡notherimed cmd %p "

7239 "tm_dbg_Ú_¡©e_·s£s=%d", 
cmd
, cmd->
g
,

7240 
tm_dbg_d–ayed_cmds_couÁ
,

7241 
tm_dbg_Ú_¡©e_·s£s
);

7242 ià(
tm_dbg_d–ayed_cmds_couÁ
 == 2)

7243 
tm_dbg_æags
.
tm_dbg_blocked
 = 0;

7247 
TM_DBG_STATE_RESET
:

7248 
TM_DBG_STATE_OFFLINE
:

7249 
	`TRACE_MGMT_DBG
("STATE RESET/OFFLINE: delaying cmd %p "

7251 "tm_dbg_Ú_¡©e_·s£s=%d", 
cmd
, cmd->
g
,

7252 
tm_dbg_d–ayed_cmds_couÁ
, 
tm_dbg_Ú_¡©e_·s£s
);

7253 
tm_dbg_æags
.
tm_dbg_blocked
 = 1;

7257 
	`sBUG
();

7260 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

7261 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
, &
tm_dbg_d–ayed_cmd_li¡
);

7262 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

7263 
cmd
->
tm_dbg_d–ayed
 = 1;

7264 
tm_dbg_d–ayed_cmds_couÁ
++;

7266 
	}
}

7269 
	$tm_dbg_check_»Ëa£d_cmds
()

7271 ià(
tm_dbg_æags
.
tm_dbg_»Ëa£
) {

7272 
sc¡_cmd
 *
cmd
, *
tc
;

7273 
	`¥š_lock_œq
(&
sc¡_tm_dbg_lock
);

7274 
	`li¡_fÜ_—ch_’Œy_§ã_»v”£
(
cmd
, 
tc
,

7275 &
tm_dbg_d–ayed_cmd_li¡
, 
cmd_li¡_’Œy
) {

7276 
	`TRACE_MGMT_DBG
("Releasingimed cmd %p (tag %llu), "

7277 "d–ayed_cmds_couÁ=%d", 
cmd
, cmd->
g
,

7278 
tm_dbg_d–ayed_cmds_couÁ
);

7279 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

7280 
	`li¡_move
(&
cmd
->
cmd_li¡_’Œy
,

7281 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

7282 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

7284 
tm_dbg_æags
.
tm_dbg_»Ëa£
 = 0;

7285 
	`¥š_uÆock_œq
(&
sc¡_tm_dbg_lock
);

7287 
	}
}

7290 
	$tm_dbg_chªge_¡©e
()

7292 
tm_dbg_æags
.
tm_dbg_blocked
 = 0;

7293 ià(--
tm_dbg_Ú_¡©e_·s£s
 == 0) {

7294 
tm_dbg_¡©e
) {

7295 
TM_DBG_STATE_ABORT
:

7296 
	`TRACE_MGMT_DBG
("%s", "Changing "

7298 
tm_dbg_¡©e
 = 
TM_DBG_STATE_RESET
;

7299 
tm_dbg_æags
.
tm_dbg_blocked
 = 0;

7301 
TM_DBG_STATE_RESET
:

7302 
TM_DBG_STATE_OFFLINE
:

7303 #ifdeà
CONFIG_SCST_TM_DBG_GO_OFFLINE


7304 
	`TRACE_MGMT_DBG
("%s", "Changing "

7306 
tm_dbg_¡©e
 = 
TM_DBG_STATE_OFFLINE
;

7308 
	`TRACE_MGMT_DBG
("%s", "Changing "

7310 
tm_dbg_¡©e
 = 
TM_DBG_STATE_ABORT
;

7314 
	`sBUG
();

7316 
tm_dbg_Ú_¡©e_·s£s
 =

7317 
tm_dbg_Ú_¡©e_num_·s£s
[
tm_dbg_¡©e
];

7320 
	`TRACE_MGMT_DBG
("%s", "Deletingimer");

7321 
	`d–_tim”_sync
(&
tm_dbg_tim”
);

7323 
	}
}

7326 
	$tm_dbg_check_cmd
(
sc¡_cmd
 *
cmd
)

7328 
»s
 = 0;

7329 
æags
;

7331 ià(
cmd
->
tm_dbg_immut
)

7332 
out
;

7334 ià(
cmd
->
tm_dbg_d–ayed
) {

7335 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

7336 
	`TRACE_MGMT_DBG
("Processing delayed cmd %p (tag %llu), "

7337 "d–ayed_cmds_couÁ=%d", 
cmd
, cmd->
g
,

7338 
tm_dbg_d–ayed_cmds_couÁ
);

7340 
cmd
->
tm_dbg_immut
 = 1;

7341 
tm_dbg_d–ayed_cmds_couÁ
--;

7342 ià((
tm_dbg_d–ayed_cmds_couÁ
 == 0) &&

7343 (
tm_dbg_¡©e
 =ð
TM_DBG_STATE_ABORT
))

7344 
	`tm_dbg_chªge_¡©e
();

7345 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

7346 } ià(
cmd
->
tgt_dev
 && (
tm_dbg_tgt_dev
 == cmd->tgt_dev)) {

7348 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

7349 ià(
tm_dbg_æags
.
tm_dbg_blocked
 ||

7350 (++
tm_dbg_·s£d_cmds_couÁ
 % 50) == 0) {

7351 
	`tm_dbg_d–ay_cmd
(
cmd
);

7352 
»s
 = 1;

7354 
cmd
->
tm_dbg_immut
 = 1;

7355 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

7358 
out
:

7359  
»s
;

7360 
	}
}

7363 
	$tm_dbg_»Ëa£_cmd
(
sc¡_cmd
 *
cmd
)

7365 
sc¡_cmd
 *
c
;

7366 
æags
;

7368 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

7369 
	`li¡_fÜ_—ch_’Œy
(
c
, &
tm_dbg_d–ayed_cmd_li¡
,

7370 
cmd_li¡_’Œy
) {

7371 ià(
c
 =ð
cmd
) {

7372 
	`TRACE_MGMT_DBG
("Abort„equest for "

7375 
c
, c->
g
, 
tm_dbg_d–ayed_cmds_couÁ
);

7377 ià(!
	`‹¡_b™
(
SCST_CMD_ABORTED_OTHER
,

7378 &
cmd
->
cmd_æags
)) {

7380 ià(((
	`sc¡_¿ndom
() % 10) == 5)) {

7381 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

7382 
	`SCST_LOAD_SENSE
(

7383 
sc¡_£n£_h¬dw_”rÜ
));

7388 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

7389 
	`li¡_move
(&
c
->
cmd_li¡_’Œy
,

7390 &
c
->
cmd_th»ads
->
aùive_cmd_li¡
);

7391 
	`wake_up
(&
c
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

7392 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

7396 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

7398 
	}
}

7401 
	$tm_dbg_sk_mgmt
(
sc¡_deviû
 *
dev
, cÚ¡ *
â
, 
fÜû
)

7403 
æags
;

7405 ià(
dev
 !ð
NULL
) {

7406 ià(
tm_dbg_tgt_dev
 =ð
NULL
)

7407 
out
;

7409 ià(
tm_dbg_tgt_dev
->
dev
 != dev)

7410 
out
;

7413 
	`¥š_lock_œq§ve
(&
sc¡_tm_dbg_lock
, 
æags
);

7414 ià((
tm_dbg_¡©e
 !ð
TM_DBG_STATE_OFFLINE
è|| 
fÜû
) {

7415 
	`TRACE_MGMT_DBG
("%s: f»ešg %d d–ayed cmds", 
â
,

7416 
tm_dbg_d–ayed_cmds_couÁ
);

7417 
	`tm_dbg_chªge_¡©e
();

7418 
tm_dbg_æags
.
tm_dbg_»Ëa£
 = 1;

7423 
	`smp_wmb
();

7424 ià(
tm_dbg_tgt_dev
 !ð
NULL
)

7425 
	`wake_up_®l
(&
tm_dbg_tgt_dev
->
aùive_cmd_th»ads
->
cmd_li¡_wa™Q
);

7427 
	`TRACE_MGMT_DBG
("%s: whžOFFLINE s‹, došg‚Ùhšg", 
â
);

7429 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_tm_dbg_lock
, 
æags
);

7431 
out
:

7433 
	}
}

7435 
	$tm_dbg_is_»Ëa£
()

7437  
tm_dbg_æags
.
tm_dbg_»Ëa£
;

7438 
	}
}

7441 #ifdeà
CONFIG_SCST_DEBUG_SN


7442 
	$sc¡_check_debug_¢
(
sc¡_cmd
 *
cmd
)

7444 
	`DEFINE_SPINLOCK
(
lock
);

7445 
ty³
;

7446 
út
;

7447 
æags
;

7448 
Þd
 = 
cmd
->
queue_ty³
;

7450 
	`¥š_lock_œq§ve
(&
lock
, 
æags
);

7452 ià(
út
 == 0) {

7453 ià((
	`sc¡_¿ndom
() % 1000) == 500) {

7454 ià((
	`sc¡_¿ndom
() % 3) == 1)

7455 
ty³
 = 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
;

7457 
ty³
 = 
SCST_CMD_QUEUE_ORDERED
;

7459 
út
 = 
	`sc¡_¿ndom
() % 10;

7460 } 
út
 == 0);

7462 
out_uÆock
;

7465 
cmd
->
queue_ty³
 = 
ty³
;

7466 
út
--;

7468 ià(((
	`sc¡_¿ndom
() % 1000) == 750))

7469 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_ORDERED
;

7470 ià(((
	`sc¡_¿ndom
() % 1000) == 751))

7471 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
;

7472 ià(((
	`sc¡_¿ndom
() % 1000) == 752))

7473 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_SIMPLE
;

7475 
	`TRACE_SN
("DbgSN chªged cmd %p: %d/%d (úˆ%d)", 
cmd
, 
Þd
,

7476 
cmd
->
queue_ty³
, 
út
);

7478 
out_uÆock
:

7479 
	`¥š_uÆock_œq»¡Üe
(&
lock
, 
æags
);

7481 
	}
}

7484 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


7486 
ušt64_t
 
	$sc¡_g‘_n£c
()

7488 
time¥ec
 
ts
;

7489 
	`ktime_g‘_ts
(&
ts
);

7490  (
ušt64_t
)
ts
.
tv_£c
 * 1000000000 +s.
tv_n£c
;

7491 
	}
}

7493 
	$sc¡_£t_¡¬t_time
(
sc¡_cmd
 *
cmd
)

7495 
cmd
->
¡¬t
 = 
	`sc¡_g‘_n£c
();

7496 
	`TRACE_DBG
("cmd %p: s¹ %Îd", 
cmd
, cmd->
¡¬t
);

7497 
	}
}

7499 
	$sc¡_£t_cur_¡¬t
(
sc¡_cmd
 *
cmd
)

7501 
cmd
->
cu¼_¡¬t
 = 
	`sc¡_g‘_n£c
();

7502 
	`TRACE_DBG
("cmd %p: cur_¡¬ˆ%Îd", 
cmd
, cmd->
cu¼_¡¬t
);

7503 
	}
}

7505 
	$sc¡_£t_·r£_time
(
sc¡_cmd
 *
cmd
)

7507 
cmd
->
·r£_time
 +ð
	`sc¡_g‘_n£c
(è- cmd->
cu¼_¡¬t
;

7508 
	`TRACE_DBG
("cmd %p:…¬£_tim%Îd", 
cmd
, cmd->
·r£_time
);

7509 
	}
}

7511 
	$sc¡_£t_®loc_buf_time
(
sc¡_cmd
 *
cmd
)

7513 
cmd
->
®loc_buf_time
 +ð
	`sc¡_g‘_n£c
(è- cmd->
cu¼_¡¬t
;

7514 
	`TRACE_DBG
("cmd %p:‡Îoc_buf_tim%Îd", 
cmd
, cmd->
®loc_buf_time
);

7515 
	}
}

7517 
	$sc¡_£t_»¡¬t_wa™šg_time
(
sc¡_cmd
 *
cmd
)

7519 
cmd
->
»¡¬t_wa™šg_time
 +ð
	`sc¡_g‘_n£c
(è- cmd->
cu¼_¡¬t
;

7520 
	`TRACE_DBG
("cmd %p:„e¡¬t_wa™šg_tim%Îd", 
cmd
,

7521 
cmd
->
»¡¬t_wa™šg_time
);

7522 
	}
}

7524 
	$sc¡_£t_rdy_to_xãr_time
(
sc¡_cmd
 *
cmd
)

7526 
cmd
->
rdy_to_xãr_time
 +ð
	`sc¡_g‘_n£c
(è- cmd->
cu¼_¡¬t
;

7527 
	`TRACE_DBG
("cmd %p:„dy_to_xãr_tim%Îd", 
cmd
, cmd->
rdy_to_xãr_time
);

7528 
	}
}

7530 
	$sc¡_£t_´e_exec_time
(
sc¡_cmd
 *
cmd
)

7532 
cmd
->
´e_exec_time
 +ð
	`sc¡_g‘_n£c
(è- cmd->
cu¼_¡¬t
;

7533 
	`TRACE_DBG
("cmd %p:…»_exec_tim%Îd", 
cmd
, cmd->
´e_exec_time
);

7534 
	}
}

7536 
	$sc¡_£t_exec_time
(
sc¡_cmd
 *
cmd
)

7538 
cmd
->
exec_time
 +ð
	`sc¡_g‘_n£c
(è- cmd->
cu¼_¡¬t
;

7539 
	`TRACE_DBG
("cmd %p:ƒxec_tim%Îd", 
cmd
, cmd->
exec_time
);

7540 
	}
}

7542 
	$sc¡_£t_dev_dÚe_time
(
sc¡_cmd
 *
cmd
)

7544 
cmd
->
dev_dÚe_time
 +ð
	`sc¡_g‘_n£c
(è- cmd->
cu¼_¡¬t
;

7545 
	`TRACE_DBG
("cmd %p: dev_dÚe_tim%Îd", 
cmd
, cmd->
dev_dÚe_time
);

7546 
	}
}

7548 
	$sc¡_£t_xm™_time
(
sc¡_cmd
 *
cmd
)

7550 
cmd
->
xm™_time
 +ð
	`sc¡_g‘_n£c
(è- cmd->
cu¼_¡¬t
;

7551 
	`TRACE_DBG
("cmd %p: xm™_tim%Îd", 
cmd
, cmd->
xm™_time
);

7552 
	}
}

7554 
	$sc¡_£t_tgt_Ú_ä“_time
(
sc¡_cmd
 *
cmd
)

7556 
cmd
->
tgt_Ú_ä“_time
 +ð
	`sc¡_g‘_n£c
(è- cmd->
cu¼_¡¬t
;

7557 
	`TRACE_DBG
("cmd %p:gt_Ú_ä“_tim%Îd", 
cmd
, cmd->
tgt_Ú_ä“_time
);

7558 
	}
}

7560 
	$sc¡_£t_dev_Ú_ä“_time
(
sc¡_cmd
 *
cmd
)

7562 
cmd
->
dev_Ú_ä“_time
 +ð
	`sc¡_g‘_n£c
(è- cmd->
cu¼_¡¬t
;

7563 
	`TRACE_DBG
("cmd %p: dev_Ú_ä“_tim%Îd", 
cmd
, cmd->
dev_Ú_ä“_time
);

7564 
	}
}

7566 
	$sc¡_upd©e_Ït_¡©s
(
sc¡_cmd
 *
cmd
)

7568 
ušt64_t
 
fšish
, 
sc¡_time
, 
tgt_time
, 
dev_time
;

7569 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

7570 
d©a_Ën
;

7571 
i
;

7572 
sc¡_ext_Ï‹ncy_¡©
 *
Ï‹ncy_¡©
, *
dev_Ï‹ncy_¡©
;

7574 
fšish
 = 
	`sc¡_g‘_n£c
();

7577 
d©a_Ën
 = 
cmd
->
bufæ’
;

7578 
i
 = 
SCST_LATENCY_STAT_INDEX_OTHER
;

7579 ià(
d©a_Ën
 <ð
SCST_IO_SIZE_THRESHOLD_SMALL
)

7580 
i
 = 
SCST_LATENCY_STAT_INDEX_SMALL
;

7581 ià(
d©a_Ën
 <ð
SCST_IO_SIZE_THRESHOLD_MEDIUM
)

7582 
i
 = 
SCST_LATENCY_STAT_INDEX_MEDIUM
;

7583 ià(
d©a_Ën
 <ð
SCST_IO_SIZE_THRESHOLD_LARGE
)

7584 
i
 = 
SCST_LATENCY_STAT_INDEX_LARGE
;

7585 ià(
d©a_Ën
 <ð
SCST_IO_SIZE_THRESHOLD_VERY_LARGE
)

7586 
i
 = 
SCST_LATENCY_STAT_INDEX_VERY_LARGE
;

7587 
Ï‹ncy_¡©
 = &
£ss
->
£ss_Ï‹ncy_¡©
[
i
];

7588 ià(
cmd
->
tgt_dev
 !ð
NULL
)

7589 
dev_Ï‹ncy_¡©
 = &
cmd
->
tgt_dev
->dev_Ï‹ncy_¡©[
i
];

7591 
dev_Ï‹ncy_¡©
 = 
NULL
;

7594 
sc¡_time
 = 
fšish
 - 
cmd
->
¡¬t
 - (cmd->
·r£_time
 +

7595 
cmd
->
®loc_buf_time
 + cmd->
»¡¬t_wa™šg_time
 +

7596 
cmd
->
rdy_to_xãr_time
 + cmd->
´e_exec_time
 +

7597 
cmd
->
exec_time
 + cmd->
dev_dÚe_time
 + cmd->
xm™_time
 +

7598 
cmd
->
tgt_Ú_ä“_time
 + cmd->
dev_Ú_ä“_time
);

7599 
tgt_time
 = 
cmd
->
®loc_buf_time
 + cmd->
»¡¬t_wa™šg_time
 +

7600 
cmd
->
rdy_to_xãr_time
 + cmd->
´e_exec_time
 +

7601 
cmd
->
xm™_time
 + cmd->
tgt_Ú_ä“_time
;

7602 
dev_time
 = 
cmd
->
·r£_time
 + cmd->
exec_time
 + cmd->
dev_dÚe_time
 +

7603 
cmd
->
dev_Ú_ä“_time
;

7605 
	`¥š_lock_bh
(&
£ss
->
Ït_lock
);

7608 
£ss
->
sc¡_time
 += scst_time;

7609 
£ss
->
tgt_time
 +=gt_time;

7610 
£ss
->
dev_time
 += dev_time;

7611 
£ss
->
´oûs£d_cmds
++;

7613 ià((
£ss
->
mš_sc¡_time
 == 0) ||

7614 (
£ss
->
mš_sc¡_time
 > 
sc¡_time
))

7615 
£ss
->
mš_sc¡_time
 = 
sc¡_time
;

7616 ià((
£ss
->
mš_tgt_time
 == 0) ||

7617 (
£ss
->
mš_tgt_time
 > 
tgt_time
))

7618 
£ss
->
mš_tgt_time
 = 
tgt_time
;

7619 ià((
£ss
->
mš_dev_time
 == 0) ||

7620 (
£ss
->
mš_dev_time
 > 
dev_time
))

7621 
£ss
->
mš_dev_time
 = 
dev_time
;

7623 ià(
£ss
->
max_sc¡_time
 < 
sc¡_time
)

7624 
£ss
->
max_sc¡_time
 = 
sc¡_time
;

7625 ià(
£ss
->
max_tgt_time
 < 
tgt_time
)

7626 
£ss
->
max_tgt_time
 = 
tgt_time
;

7627 ià(
£ss
->
max_dev_time
 < 
dev_time
)

7628 
£ss
->
max_dev_time
 = 
dev_time
;

7631 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) {

7632 
Ï‹ncy_¡©
->
sc¡_time_rd
 +ð
sc¡_time
;

7633 
Ï‹ncy_¡©
->
tgt_time_rd
 +ð
tgt_time
;

7634 
Ï‹ncy_¡©
->
dev_time_rd
 +ð
dev_time
;

7635 
Ï‹ncy_¡©
->
´oûs£d_cmds_rd
++;

7637 ià((
Ï‹ncy_¡©
->
mš_sc¡_time_rd
 == 0) ||

7638 (
Ï‹ncy_¡©
->
mš_sc¡_time_rd
 > 
sc¡_time
))

7639 
Ï‹ncy_¡©
->
mš_sc¡_time_rd
 = 
sc¡_time
;

7640 ià((
Ï‹ncy_¡©
->
mš_tgt_time_rd
 == 0) ||

7641 (
Ï‹ncy_¡©
->
mš_tgt_time_rd
 > 
tgt_time
))

7642 
Ï‹ncy_¡©
->
mš_tgt_time_rd
 = 
tgt_time
;

7643 ià((
Ï‹ncy_¡©
->
mš_dev_time_rd
 == 0) ||

7644 (
Ï‹ncy_¡©
->
mš_dev_time_rd
 > 
dev_time
))

7645 
Ï‹ncy_¡©
->
mš_dev_time_rd
 = 
dev_time
;

7647 ià(
Ï‹ncy_¡©
->
max_sc¡_time_rd
 < 
sc¡_time
)

7648 
Ï‹ncy_¡©
->
max_sc¡_time_rd
 = 
sc¡_time
;

7649 ià(
Ï‹ncy_¡©
->
max_tgt_time_rd
 < 
tgt_time
)

7650 
Ï‹ncy_¡©
->
max_tgt_time_rd
 = 
tgt_time
;

7651 ià(
Ï‹ncy_¡©
->
max_dev_time_rd
 < 
dev_time
)

7652 
Ï‹ncy_¡©
->
max_dev_time_rd
 = 
dev_time
;

7654 ià(
dev_Ï‹ncy_¡©
 !ð
NULL
) {

7655 
dev_Ï‹ncy_¡©
->
sc¡_time_rd
 +ð
sc¡_time
;

7656 
dev_Ï‹ncy_¡©
->
tgt_time_rd
 +ð
tgt_time
;

7657 
dev_Ï‹ncy_¡©
->
dev_time_rd
 +ð
dev_time
;

7658 
dev_Ï‹ncy_¡©
->
´oûs£d_cmds_rd
++;

7660 ià((
dev_Ï‹ncy_¡©
->
mš_sc¡_time_rd
 == 0) ||

7661 (
dev_Ï‹ncy_¡©
->
mš_sc¡_time_rd
 > 
sc¡_time
))

7662 
dev_Ï‹ncy_¡©
->
mš_sc¡_time_rd
 = 
sc¡_time
;

7663 ià((
dev_Ï‹ncy_¡©
->
mš_tgt_time_rd
 == 0) ||

7664 (
dev_Ï‹ncy_¡©
->
mš_tgt_time_rd
 > 
tgt_time
))

7665 
dev_Ï‹ncy_¡©
->
mš_tgt_time_rd
 = 
tgt_time
;

7666 ià((
dev_Ï‹ncy_¡©
->
mš_dev_time_rd
 == 0) ||

7667 (
dev_Ï‹ncy_¡©
->
mš_dev_time_rd
 > 
dev_time
))

7668 
dev_Ï‹ncy_¡©
->
mš_dev_time_rd
 = 
dev_time
;

7670 ià(
dev_Ï‹ncy_¡©
->
max_sc¡_time_rd
 < 
sc¡_time
)

7671 
dev_Ï‹ncy_¡©
->
max_sc¡_time_rd
 = 
sc¡_time
;

7672 ià(
dev_Ï‹ncy_¡©
->
max_tgt_time_rd
 < 
tgt_time
)

7673 
dev_Ï‹ncy_¡©
->
max_tgt_time_rd
 = 
tgt_time
;

7674 ià(
dev_Ï‹ncy_¡©
->
max_dev_time_rd
 < 
dev_time
)

7675 
dev_Ï‹ncy_¡©
->
max_dev_time_rd
 = 
dev_time
;

7677 } ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

7678 
Ï‹ncy_¡©
->
sc¡_time_wr
 +ð
sc¡_time
;

7679 
Ï‹ncy_¡©
->
tgt_time_wr
 +ð
tgt_time
;

7680 
Ï‹ncy_¡©
->
dev_time_wr
 +ð
dev_time
;

7681 
Ï‹ncy_¡©
->
´oûs£d_cmds_wr
++;

7683 ià((
Ï‹ncy_¡©
->
mš_sc¡_time_wr
 == 0) ||

7684 (
Ï‹ncy_¡©
->
mš_sc¡_time_wr
 > 
sc¡_time
))

7685 
Ï‹ncy_¡©
->
mš_sc¡_time_wr
 = 
sc¡_time
;

7686 ià((
Ï‹ncy_¡©
->
mš_tgt_time_wr
 == 0) ||

7687 (
Ï‹ncy_¡©
->
mš_tgt_time_wr
 > 
tgt_time
))

7688 
Ï‹ncy_¡©
->
mš_tgt_time_wr
 = 
tgt_time
;

7689 ià((
Ï‹ncy_¡©
->
mš_dev_time_wr
 == 0) ||

7690 (
Ï‹ncy_¡©
->
mš_dev_time_wr
 > 
dev_time
))

7691 
Ï‹ncy_¡©
->
mš_dev_time_wr
 = 
dev_time
;

7693 ià(
Ï‹ncy_¡©
->
max_sc¡_time_wr
 < 
sc¡_time
)

7694 
Ï‹ncy_¡©
->
max_sc¡_time_wr
 = 
sc¡_time
;

7695 ià(
Ï‹ncy_¡©
->
max_tgt_time_wr
 < 
tgt_time
)

7696 
Ï‹ncy_¡©
->
max_tgt_time_wr
 = 
tgt_time
;

7697 ià(
Ï‹ncy_¡©
->
max_dev_time_wr
 < 
dev_time
)

7698 
Ï‹ncy_¡©
->
max_dev_time_wr
 = 
dev_time
;

7700 ià(
dev_Ï‹ncy_¡©
 !ð
NULL
) {

7701 
dev_Ï‹ncy_¡©
->
sc¡_time_wr
 +ð
sc¡_time
;

7702 
dev_Ï‹ncy_¡©
->
tgt_time_wr
 +ð
tgt_time
;

7703 
dev_Ï‹ncy_¡©
->
dev_time_wr
 +ð
dev_time
;

7704 
dev_Ï‹ncy_¡©
->
´oûs£d_cmds_wr
++;

7706 ià((
dev_Ï‹ncy_¡©
->
mš_sc¡_time_wr
 == 0) ||

7707 (
dev_Ï‹ncy_¡©
->
mš_sc¡_time_wr
 > 
sc¡_time
))

7708 
dev_Ï‹ncy_¡©
->
mš_sc¡_time_wr
 = 
sc¡_time
;

7709 ià((
dev_Ï‹ncy_¡©
->
mš_tgt_time_wr
 == 0) ||

7710 (
dev_Ï‹ncy_¡©
->
mš_tgt_time_wr
 > 
tgt_time
))

7711 
dev_Ï‹ncy_¡©
->
mš_tgt_time_wr
 = 
tgt_time
;

7712 ià((
dev_Ï‹ncy_¡©
->
mš_dev_time_wr
 == 0) ||

7713 (
dev_Ï‹ncy_¡©
->
mš_dev_time_wr
 > 
dev_time
))

7714 
dev_Ï‹ncy_¡©
->
mš_dev_time_wr
 = 
dev_time
;

7716 ià(
dev_Ï‹ncy_¡©
->
max_sc¡_time_wr
 < 
sc¡_time
)

7717 
dev_Ï‹ncy_¡©
->
max_sc¡_time_wr
 = 
sc¡_time
;

7718 ià(
dev_Ï‹ncy_¡©
->
max_tgt_time_wr
 < 
tgt_time
)

7719 
dev_Ï‹ncy_¡©
->
max_tgt_time_wr
 = 
tgt_time
;

7720 ià(
dev_Ï‹ncy_¡©
->
max_dev_time_wr
 < 
dev_time
)

7721 
dev_Ï‹ncy_¡©
->
max_dev_time_wr
 = 
dev_time
;

7725 
	`¥š_uÆock_bh
(&
£ss
->
Ït_lock
);

7727 
	`TRACE_DBG
("cmd %p: finish %lld, scst_time %lld, "

7728 "tgt_tim%Îd, dev_tim%Îd", 
cmd
, 
fšish
, 
sc¡_time
,

7729 
tgt_time
, 
dev_time
);

7731 
	}
}

	@/root/Desktop/scst-2.2.0/src/scst_main.c

20 
	~<lšux/moduË.h
>

22 
	~<lšux/š™.h
>

23 
	~<lšux/k”Ãl.h
>

24 
	~<lšux/”ºo.h
>

25 
	~<lšux/li¡.h
>

26 
	~<lšux/¥šlock.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<lšux/sched.h
>

29 
	~<lšux/uni¡d.h
>

30 
	~<lšux/¡ršg.h
>

31 
	~<lšux/kth»ad.h
>

32 
	~<lšux/d–ay.h
>

33 
	~<lšux/lockd•.h
>

35 #ifdeà
INSIDE_KERNEL_TREE


36 
	~<sc¡/sc¡.h
>

38 
	~"sc¡.h
"

40 
	~"sc¡_´iv.h
"

41 
	~"sc¡_mem.h
"

42 
	~"sc¡_´es.h
"

44 #ià
defšed
(
CONFIG_HIGHMEM4G
è|| defšed(
CONFIG_HIGHMEM64G
)

45 #w¬nšg 
HIGHMEM
 
k”Ãl
 
cÚfigu¿tiÚs
 
¬e
 
fuÎy
 
suµÜ‹d
, 
but
 
nÙ
 \

46 
»comm’ded
 
³rfÜmªû
 
	g»asÚs
. 
CÚsid”
 
chªgšg
 
	gVMSPLIT
 \

47 
ÝtiÚ
 
Ü
 
u£
 
	ga
 64-
b™
 
cÚfigu¿tiÚ
 
	gš¡—d
. 
S“
 
README
 
fže
 \

48 
	gd‘ažs
.

51 #ià!
defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

52 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 30)

53 #ià!
defšed
(
CONFIG_SCST_STRICT_SERIALIZING
)

54 #w¬nšg 
P©ch
 
sc¡_exec_»q_fifo
-<
k”Ãl
-
v”siÚ
> 
was
 
nÙ
 
­¶›d
 
Ú
 \

55 
your
 
k”Ãl
 
ªd
 
CONFIG_SCST_STRICT_SERIALIZING
 
is
 
nÙ
 
	gdefšed
. \

56 
	gPass
-
through
 
dev
 
hªdËrs
 
wžl
 
nÙ
 
	gwÜk
.

59 #w¬nšg 
P©ch
 
sc¡_exec_»q_fifo
-<
k”Ãl
-
v”siÚ
> 
was
 
nÙ
 
­¶›d
 
Ú
 \

60 
your
 
	gk”Ãl
. 
	gPass
-
through
 
dev
 
hªdËrs
 
wžl
 
nÙ
 
	gwÜk
.

79 
mu‹x
 
	gsc¡_mu‹x
;

80 
EXPORT_SYMBOL_GPL
(
sc¡_mu‹x
);

87 
mu‹x
 
	gsc¡_mu‹x2
;

90 
li¡_h—d
 
	gsc¡_‹m¶©e_li¡
;

91 
li¡_h—d
 
	gsc¡_dev_li¡
;

94 
li¡_h—d
 
	gsc¡_dev_ty³_li¡
;

95 
li¡_h—d
 
	gsc¡_vœtu®_dev_ty³_li¡
;

97 
¥šlock_t
 
	gsc¡_maš_lock
;

99 
kmem_ÿche
 *
	gsc¡_mgmt_ÿch•
;

100 
mempoÞ_t
 *
	gsc¡_mgmt_mempoÞ
;

101 
kmem_ÿche
 *
	gsc¡_mgmt_¡ub_ÿch•
;

102 
mempoÞ_t
 *
	gsc¡_mgmt_¡ub_mempoÞ
;

103 
kmem_ÿche
 *
	gsc¡_ua_ÿch•
;

104 
mempoÞ_t
 *
	gsc¡_ua_mempoÞ
;

105 
kmem_ÿche
 *
	gsc¡_£n£_ÿch•
;

106 
mempoÞ_t
 *
	gsc¡_£n£_mempoÞ
;

107 
kmem_ÿche
 *
	gsc¡_«n_ÿch•
;

108 
mempoÞ_t
 *
	gsc¡_«n_mempoÞ
;

109 
kmem_ÿche
 *
	gsc¡_tgtd_ÿch•
;

110 
kmem_ÿche
 *
	gsc¡_£ss_ÿch•
;

111 
kmem_ÿche
 *
	gsc¡_acgd_ÿch•
;

113 #ifdeà
CONFIG_SCST_PROC


114 
li¡_h—d
 
	gsc¡_acg_li¡
;

115 
sc¡_acg
 *
	gsc¡_deçuÉ_acg
;

117 
	gsc¡_£tup_id
;

120 
¥šlock_t
 
	gsc¡_š™_lock
;

121 
wa™_queue_h—d_t
 
	gsc¡_š™_cmd_li¡_wa™Q
;

122 
li¡_h—d
 
	gsc¡_š™_cmd_li¡
;

123 
	gsc¡_š™_pÞl_út
;

125 
kmem_ÿche
 *
	gsc¡_cmd_ÿch•
;

127 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

128 
	gsc¡_Œaû_æag
;

131 
	gsc¡_max_skËt_cmd
 = 
SCST_DEF_MAX_TASKLET_CMD
;

133 
	gsc¡_æags
;

135 
sc¡_cmd_th»ads
 
	gsc¡_maš_cmd_th»ads
;

137 
sc¡_³rýu_šfo
 
	gsc¡_³rýu_šfos
[
NR_CPUS
];

139 
¥šlock_t
 
	gsc¡_mcmd_lock
;

140 
li¡_h—d
 
	gsc¡_aùive_mgmt_cmd_li¡
;

141 
li¡_h—d
 
	gsc¡_d–ayed_mgmt_cmd_li¡
;

142 
wa™_queue_h—d_t
 
	gsc¡_mgmt_cmd_li¡_wa™Q
;

144 
wa™_queue_h—d_t
 
	gsc¡_mgmt_wa™Q
;

145 
¥šlock_t
 
	gsc¡_mgmt_lock
;

146 
li¡_h—d
 
	gsc¡_£ss_š™_li¡
;

147 
li¡_h—d
 
	gsc¡_£ss_shut_li¡
;

149 
wa™_queue_h—d_t
 
	gsc¡_dev_cmd_wa™Q
;

151 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 29)

152 #ifdeà
CONFIG_LOCKDEP


153 
lock_þass_key
 
	gsc¡_su¥’d_key
;

154 
lockd•_m­
 
	gsc¡_su¥’d_d•_m­
 =

155 
STATIC_LOCKDEP_MAP_INIT
("sc¡_su¥’d_aùiv™y", &
sc¡_su¥’d_key
);

158 
mu‹x
 
	gsc¡_su¥’d_mu‹x
;

160 
li¡_h—d
 
	gsc¡_cmd_th»ads_li¡
;

162 
	gsc¡_th»ads
;

163 
sk_¡ruù
 *
	gsc¡_š™_cmd_th»ad
;

164 
sk_¡ruù
 *
	gsc¡_mgmt_th»ad
;

165 
sk_¡ruù
 *
	gsc¡_mgmt_cmd_th»ad
;

167 
	gsu¥’d_couÁ
;

169 
	gsc¡_vœt_dev_Ï¡_id
;

171 
ýumask_t
 
	gdeçuÉ_ýu_mask
;

173 
	gsc¡_max_cmd_mem
;

174 
	gsc¡_max_dev_cmd_mem
;

176 
moduË_·¿m_Çmed
(
sc¡_th»ads
, scst_threads, , 0);

177 
MODULE_PARM_DESC
(
sc¡_th»ads
, "SCSIargethreads count");

179 
moduË_·¿m_Çmed
(
sc¡_max_cmd_mem
, sc¡_max_cmd_mem, , 
S_IRUGO
);

180 
MODULE_PARM_DESC
(
sc¡_max_cmd_mem
, "Maximum memory‡llowedo be consumed by "

183 
moduË_·¿m_Çmed
(
sc¡_max_dev_cmd_mem
, sc¡_max_dev_cmd_mem, , 
S_IRUGO
);

184 
MODULE_PARM_DESC
(
sc¡_max_dev_cmd_mem
, "Maximum memory‡llowedo be consumed "

187 
sc¡_dev_ty³
 
	gsc¡_nuÎ_devty³
 = {

188 .
Çme
 = "none",

189 .
	gth»ads_num
 = -1,

192 
__sc¡_»sume_aùiv™y
();

208 
	$__sc¡_»gi¡”_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
,

209 cÚ¡ *
v”siÚ
)

211 
»s
 = 0;

212 
sc¡_tgt_‹m¶©e
 *
t
;

214 
	`TRACE_ENTRY
();

216 
	`INIT_LIST_HEAD
(&
v‰
->
tgt_li¡
);

218 ià(
	`¡rcmp
(
v”siÚ
, 
SCST_INTERFACE_VERSION
) != 0) {

219 
	`PRINT_ERROR
("IncÜ»ù v”siÚ oàrg‘ %s", 
v‰
->
Çme
);

220 
»s
 = -
EINVAL
;

221 
out
;

224 ià(!
v‰
->
d‘eù
) {

225 
	`PRINT_ERROR
("Target driver %s must have "

226 "d‘eù(èm‘hod.", 
v‰
->
Çme
);

227 
»s
 = -
EINVAL
;

228 
out
;

231 ià(!
v‰
->
»Ëa£
) {

232 
	`PRINT_ERROR
("Target driver %s must have "

233 "»Ëa£(èm‘hod.", 
v‰
->
Çme
);

234 
»s
 = -
EINVAL
;

235 
out
;

238 ià(!
v‰
->
xm™_»¥Ú£
) {

239 
	`PRINT_ERROR
("Target driver %s must have "

240 "xm™_»¥Ú£(èm‘hod.", 
v‰
->
Çme
);

241 
»s
 = -
EINVAL
;

242 
out
;

245 ià(
v‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
)

246 
	`PRINT_WARNING
("Target driver %s doesn't support Persistent "

247 "Re£rv©iÚs", 
v‰
->
Çme
);

249 ià(
v‰
->
th»ads_num
 < 0) {

250 
	`PRINT_ERROR
("Wronghreads_num value %d for "

251 "rg‘ \"%s\"", 
v‰
->
th»ads_num
,

252 
v‰
->
Çme
);

253 
»s
 = -
EINVAL
;

254 
out
;

257 #iâdeà
CONFIG_SCST_PROC


258 ià((!
v‰
->
’abË_rg‘
 || !v‰->
is_rg‘_’abËd
) &&

259 !
v‰
->
’abËd_©Œ_nÙ_Ãeded
)

260 
	`PRINT_WARNING
("Target driver %s doesn't haveƒnable_target() "

264 "deviû Ü‚Ødeviû ©‡Î!", 
v‰
->
Çme
);

266 ià(((
v‰
->
add_rg‘
 !ð
NULL
è&& (v‰->
d–_rg‘
 == NULL)) ||

267 ((
v‰
->
add_rg‘
 =ð
NULL
è&& (v‰->
d–_rg‘
 != NULL))) {

268 
	`PRINT_ERROR
("Target driver %s mustƒither define both "

269 "add_rg‘(èªd d–_rg‘(), o¸nÚe.", 
v‰
->
Çme
);

270 
»s
 = -
EINVAL
;

271 
out
;

275 ià(
v‰
->
rdy_to_xãr
 =ð
NULL
)

276 
v‰
->
rdy_to_xãr_©omic
 = 1;

278 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

279 ià(
»s
 != 0)

280 
out
;

281 
	`li¡_fÜ_—ch_’Œy
(
t
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

282 ià(
	`¡rcmp
(
t
->
Çme
, 
v‰
->name) == 0) {

283 
	`PRINT_ERROR
("Target driver %s‡lready„egistered",

284 
v‰
->
Çme
);

285 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

286 
out_uÆock
;

289 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

291 #iâdeà
CONFIG_SCST_PROC


292 
»s
 = 
	`sc¡_tg‰_sysfs_ü—‹
(
v‰
);

293 ià(
»s
 != 0)

294 
out
;

296 ià(!
v‰
->
no_´oc_’Œy
) {

297 
»s
 = 
	`sc¡_bužd_´oc_rg‘_dœ_’Œ›s
(
v‰
);

298 ià(
»s
 < 0)

299 
out
;

303 
	`mu‹x_lock
(&
sc¡_mu‹x
);

304 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

305 
	`li¡_add_ž
(&
v‰
->
sc¡_‹m¶©e_li¡_’Œy
, &
sc¡_‹m¶©e_li¡
);

306 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

307 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

309 
	`TRACE_DBG
("%s", "Callingarget driver's detect()");

310 
»s
 = 
v‰
->
	`d‘eù
(vtt);

311 
	`TRACE_DBG
("T¬g‘ driv”' d‘eù(è»tuºed %d", 
»s
);

312 ià(
»s
 < 0) {

313 
	`PRINT_ERROR
("%s", "The detect()„outine failed");

314 
»s
 = -
EINVAL
;

315 
out_d–
;

318 
	`PRINT_INFO
("T¬g‘em¶©% »gi¡”ed sucûssfuÎy", 
v‰
->
Çme
);

320 
out
:

321 
	`TRACE_EXIT_RES
(
»s
);

322  
»s
;

324 
out_d–
:

325 #ifdeà
CONFIG_SCST_PROC


326 
	`sc¡_þ—nup_´oc_rg‘_dœ_’Œ›s
(
v‰
);

328 
	`sc¡_tg‰_sysfs_d–
(
v‰
);

331 
	`mu‹x_lock
(&
sc¡_mu‹x
);

333 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

334 
	`li¡_d–
(&
v‰
->
sc¡_‹m¶©e_li¡_’Œy
);

335 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

337 
out_uÆock
:

338 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

339 
out
;

340 
	}
}

341 
EXPORT_SYMBOL_GPL
(
__sc¡_»gi¡”_rg‘_‹m¶©e
);

343 
	$sc¡_check_nÚ_g¶_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
)

345 
»s
;

347 
	`TRACE_ENTRY
();

349 ià(
v‰
->
sk_mgmt_afãùed_cmds_dÚe
 || v‰->
th»ads_num
 ||

350 
v‰
->
Ú_hw_³ndšg_cmd_timeout
) {

351 
	`PRINT_ERROR
("Not‡llowed functionality in‚on-GPL version for "

352 "rg‘em¶©%s", 
v‰
->
Çme
);

353 
»s
 = -
EPERM
;

354 
out
;

357 
»s
 = 0;

359 
out
:

360 
	`TRACE_EXIT_RES
(
»s
);

361  
»s
;

362 
	}
}

378 
	$__sc¡_»gi¡”_rg‘_‹m¶©e_nÚ_g¶
(
sc¡_tgt_‹m¶©e
 *
v‰
,

379 cÚ¡ *
v”siÚ
)

381 
»s
;

383 
	`TRACE_ENTRY
();

385 
»s
 = 
	`sc¡_check_nÚ_g¶_rg‘_‹m¶©e
(
v‰
);

386 ià(
»s
 != 0)

387 
out
;

389 
»s
 = 
	`__sc¡_»gi¡”_rg‘_‹m¶©e
(
v‰
, 
v”siÚ
);

391 
out
:

392 
	`TRACE_EXIT_RES
(
»s
);

393  
»s
;

394 
	}
}

395 
EXPORT_SYMBOL
(
__sc¡_»gi¡”_rg‘_‹m¶©e_nÚ_g¶
);

405 
	$sc¡_uÄegi¡”_rg‘_‹m¶©e
(
sc¡_tgt_‹m¶©e
 *
v‰
)

407 
sc¡_tgt
 *
tgt
;

408 
sc¡_tgt_‹m¶©e
 *
t
;

409 
found
 = 0;

411 
	`TRACE_ENTRY
();

413 
	`mu‹x_lock
(&
sc¡_mu‹x
);

415 
	`li¡_fÜ_—ch_’Œy
(
t
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

416 ià(
	`¡rcmp
(
t
->
Çme
, 
v‰
->name) == 0) {

417 
found
 = 1;

421 ià(!
found
) {

422 
	`PRINT_ERROR
("T¬g‘ driv” % i¢'ˆ»gi¡”ed", 
v‰
->
Çme
);

423 
out_”r_up
;

426 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

427 
	`li¡_d–
(&
v‰
->
sc¡_‹m¶©e_li¡_’Œy
);

428 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

430 #iâdeà
CONFIG_SCST_PROC


432 
v‰
->
tg‰_aùive_sysfs_wÜks_couÁ
 > 0) {

433 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

434 
	`m¦“p
(100);

435 
	`mu‹x_lock
(&
sc¡_mu‹x
);

439 
»¡¬t
:

440 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
v‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

441 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

442 
	`sc¡_uÄegi¡”_rg‘
(
tgt
);

443 
	`mu‹x_lock
(&
sc¡_mu‹x
);

444 
»¡¬t
;

447 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

449 #ifdeà
CONFIG_SCST_PROC


450 
	`sc¡_þ—nup_´oc_rg‘_dœ_’Œ›s
(
v‰
);

452 
	`sc¡_tg‰_sysfs_d–
(
v‰
);

455 
	`PRINT_INFO
("T¬g‘em¶©% uÄegi¡”ed sucûssfuÎy", 
v‰
->
Çme
);

457 
out
:

458 
	`TRACE_EXIT
();

461 
out_”r_up
:

462 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

463 
out
;

464 
	}
}

465 
EXPORT_SYMBOL
(
sc¡_uÄegi¡”_rg‘_‹m¶©e
);

473 
sc¡_tgt
 *
	$sc¡_»gi¡”_rg‘
(
sc¡_tgt_‹m¶©e
 *
v‰
,

474 cÚ¡ *
rg‘_Çme
)

476 
sc¡_tgt
 *
tgt
, *
t
;

477 
rc
 = 0;

479 
	`TRACE_ENTRY
();

481 
rc
 = 
	`sc¡_®loc_tgt
(
v‰
, &
tgt
);

482 ià(
rc
 != 0)

483 
out
;

485 ià(
rg‘_Çme
 !ð
NULL
) {

486 #ifdeà
CONFIG_SCST_PROC


487 
tgt
->
deçuÉ_group_Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s_%s",

488 
SCST_DEFAULT_ACG_NAME
,

489 
rg‘_Çme
);

490 ià(
tgt
->
deçuÉ_group_Çme
 =ð
NULL
) {

491 
	`PRINT_ERROR
("Allocation of default "

492 "grou°Çmçžed (tgˆ%s)", 
rg‘_Çme
);

493 
rc
 = -
ENOMEM
;

494 
out_ä“_tgt
;

499 
tgt
->
tgt_Çme
 = 
	`k¡rdup
(
rg‘_Çme
, 
GFP_KERNEL
);

500 ià(
tgt
->
tgt_Çme
 =ð
NULL
) {

501 
	`PRINT_ERROR
("Allocation ofgt‚ame %s failed",

502 
rg‘_Çme
);

503 
rc
 = -
ENOMEM
;

504 
out_ä“_tgt
;

507 
tgt_num
;

509 
	`PRINT_WARNING
("Usage of‡utogenerated SCSTarget‚ames "

513 "Çme š¡—d", 
v‰
->
Çme
);

515 
tgt
->
tgt_Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%s%s%d", 
v‰
->
Çme
,

516 
SCST_DEFAULT_TGT_NAME_SUFFIX
, 
tgt_num
);

517 ià(
tgt
->
tgt_Çme
 =ð
NULL
) {

518 
	`PRINT_ERROR
("Allocation ofgt‚ame failed "

519 "Ñem¶©Çm%s)", 
v‰
->
Çme
);

520 
rc
 = -
ENOMEM
;

521 
out_ä“_tgt
;

523 
tgt_num
++;

526 
rc
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

527 ià(
rc
 != 0)

528 
out_ä“_tgt
;

530 
	`li¡_fÜ_—ch_’Œy
(
t
, &
v‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

531 ià(
	`¡rcmp
(
t
->
tgt_Çme
, 
tgt
->tgt_name) == 0) {

532 
	`PRINT_ERROR
("rg‘ % ®»adyƒxi¡s", 
tgt
->
tgt_Çme
);

533 
rc
 = -
EEXIST
;

534 
out_uÆock
;

538 #ifdeà
CONFIG_SCST_PROC


539 
rc
 = 
	`sc¡_bužd_´oc_rg‘_’Œ›s
(
tgt
);

540 ià(
rc
 < 0)

541 
out_uÆock
;

543 
rc
 = 
	`sc¡_tgt_sysfs_ü—‹
(
tgt
);

544 ià(
rc
 < 0)

545 
out_uÆock
;

547 
tgt
->
deçuÉ_acg
 = 
	`sc¡_®loc_add_acg
Ñgt,gt->
tgt_Çme
, 
çl£
);

548 ià(
tgt
->
deçuÉ_acg
 =ð
NULL
)

549 
out_sysfs_d–
;

552 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

553 
	`li¡_add_ž
(&
tgt
->
tgt_li¡_’Œy
, &
v‰
->
tgt_li¡
);

554 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

556 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

558 #ifdeà
CONFIG_SCST_PROC


559 
	`PRINT_INFO
("Target %s (rel ID %d) foremplate %s„egistered "

560 "sucûssfuÎy", 
tgt
->
tgt_Çme
,gt->
»l_tgt_id
, 
v‰
->
Çme
);

562 
	`PRINT_INFO
("Target %s foremplate %s„egistered successfully",

563 
tgt
->
tgt_Çme
, 
v‰
->
Çme
);

566 
	`TRACE_DBG
("tgˆ%p", 
tgt
);

568 
out
:

569 
	`TRACE_EXIT
();

570  
tgt
;

572 #iâdeà
CONFIG_SCST_PROC


573 
out_sysfs_d–
:

574 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

575 
	`sc¡_tgt_sysfs_d–
(
tgt
);

576 
out_ä“_tgt
;

579 
out_uÆock
:

580 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

582 
out_ä“_tgt
:

584 
	`sc¡_ä“_tgt
(
tgt
);

585 
tgt
 = 
NULL
;

586 
out
;

587 
	}
}

588 
EXPORT_SYMBOL
(
sc¡_»gi¡”_rg‘
);

590 
šlše
 
	$‹¡_£ss_li¡
(
sc¡_tgt
 *
tgt
)

592 
»s
;

593 
	`mu‹x_lock
(&
sc¡_mu‹x
);

594 
»s
 = 
	`li¡_em±y
(&
tgt
->
£ss_li¡
);

595 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

596  
»s
;

597 
	}
}

605 
	$sc¡_uÄegi¡”_rg‘
(
sc¡_tgt
 *
tgt
)

607 
sc¡_£ssiÚ
 *
£ss
;

608 
sc¡_tgt_‹m¶©e
 *
v‰
 = 
tgt
->
tg‰
;

609 #iâdeà
CONFIG_SCST_PROC


610 
sc¡_acg
 *
acg
, *
acg_tmp
;

613 
	`TRACE_ENTRY
();

615 
	`TRACE_DBG
("%s", "Callingarget driver's„elease()");

616 
tgt
->
tg‰
->
	`»Ëa£
(tgt);

617 
	`TRACE_DBG
("%s", "Target driver's„elease()„eturned");

619 
	`mu‹x_lock
(&
sc¡_mu‹x
);

620 
agaš
:

621 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
, 
£ss_li¡_’Œy
) {

622 ià(
£ss
->
shut_pha£
 =ð
SCST_SESS_SPH_READY
) {

627 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

628 
	`sc¡_uÄegi¡”_£ssiÚ
(
£ss
, 0, 
NULL
);

629 
	`mu‹x_lock
(&
sc¡_mu‹x
);

630 
agaš
;

633 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

635 
	`TRACE_DBG
("%s", "Waiting for sessions shutdown");

636 
	`wa™_ev’t
(
tgt
->
uÄeg_wa™Q
, 
	`‹¡_£ss_li¡
(tgt));

637 
	`TRACE_DBG
("%s", "wait_event()„eturned");

639 
	`sc¡_su¥’d_aùiv™y
(
çl£
);

640 
	`mu‹x_lock
(&
sc¡_mu‹x
);

642 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

643 
	`li¡_d–
(&
tgt
->
tgt_li¡_’Œy
);

644 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

646 
	`d–_tim”_sync
(&
tgt
->
»Œy_tim”
);

648 
	`sc¡_tg_tgt_»move_by_tgt
(
tgt
);

650 #ifdeà
CONFIG_SCST_PROC


651 
	`sc¡_þ—nup_´oc_rg‘_’Œ›s
(
tgt
);

653 
	`sc¡_d–_ä“_acg
(
tgt
->
deçuÉ_acg
);

655 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg
, 
acg_tmp
, &
tgt
->
tgt_acg_li¡
,

656 
acg_li¡_’Œy
) {

657 
	`sc¡_d–_ä“_acg
(
acg
);

661 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

662 
	`sc¡_»sume_aùiv™y
();

664 #iâdeà
CONFIG_SCST_PROC


665 
	`sc¡_tgt_sysfs_d–
(
tgt
);

668 
	`PRINT_INFO
("Target %s foremplate %s unregistered successfully",

669 
tgt
->
tgt_Çme
, 
v‰
->
Çme
);

671 
	`sc¡_ä“_tgt
(
tgt
);

673 
	`TRACE_DBG
("UÄegi¡”šggˆ%°fšished", 
tgt
);

675 
	`TRACE_EXIT
();

677 
	}
}

678 
EXPORT_SYMBOL
(
sc¡_uÄegi¡”_rg‘
);

680 
	$sc¡_g‘_cmd_couÁ”
()

682 
i
, 
»s
 = 0;

683 
i
 = 0; i < ()
	`ARRAY_SIZE
(
sc¡_³rýu_šfos
); i++)

684 
»s
 +ð
	`©omic_»ad
(&
sc¡_³rýu_šfos
[
i
].
ýu_cmd_couÁ
);

685  
»s
;

686 
	}
}

688 
	$sc¡_su¥_wa™
(
boÞ
 
š‹¼u±ibË
)

690 
»s
 = 0;

692 
	`TRACE_ENTRY
();

694 ià(
š‹¼u±ibË
) {

695 
»s
 = 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
sc¡_dev_cmd_wa™Q
,

696 (
	`sc¡_g‘_cmd_couÁ”
() == 0),

697 
SCST_SUSPENDING_TIMEOUT
);

698 ià(
»s
 <= 0) {

699 
	`__sc¡_»sume_aùiv™y
();

700 ià(
»s
 == 0)

701 
»s
 = -
EBUSY
;

703 
»s
 = 0;

705 
	`wa™_ev’t
(
sc¡_dev_cmd_wa™Q
, 
	`sc¡_g‘_cmd_couÁ”
() == 0);

707 
	`TRACE_MGMT_DBG
("wa™_ev’t(è»tuºed %d", 
»s
);

709 
	`TRACE_EXIT_RES
(
»s
);

710  
»s
;

711 
	}
}

726 
	$sc¡_su¥’d_aùiv™y
(
boÞ
 
š‹¼u±ibË
)

728 
»s
 = 0;

729 
boÞ
 
»p
 = 
çl£
;

731 
	`TRACE_ENTRY
();

733 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

734 
	`rwlock_acquœe_»ad
(&
sc¡_su¥’d_d•_m­
, 0, 0, 
_RET_IP_
);

737 ià(
š‹¼u±ibË
) {

738 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_su¥’d_mu‹x
) != 0) {

739 
»s
 = -
EINTR
;

740 
out
;

743 
	`mu‹x_lock
(&
sc¡_su¥’d_mu‹x
);

745 
	`TRACE_MGMT_DBG
("su¥’d_couÁ %d", 
su¥’d_couÁ
);

746 
su¥’d_couÁ
++;

747 ià(
su¥’d_couÁ
 > 1)

748 
out_up
;

750 
	`£t_b™
(
SCST_FLAG_SUSPENDING
, &
sc¡_æags
);

751 
	`£t_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
);

757 
	`smp_mb__aá”_£t_b™
();

768 ià(
	`sc¡_g‘_cmd_couÁ”
() != 0) {

769 
	`PRINT_INFO
("Waiting for %d‡ctive commandso complete... This "

777 "kžËd.", 
	`sc¡_g‘_cmd_couÁ”
());

778 
»p
 = 
Œue
;

780 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

781 
	`lock_cÚ‹nded
(&
sc¡_su¥’d_d•_m­
, 
_RET_IP_
);

785 
»s
 = 
	`sc¡_su¥_wa™
(
š‹¼u±ibË
);

786 ià(
»s
 != 0)

787 
out_þ—r
;

789 
	`þ—r_b™
(
SCST_FLAG_SUSPENDING
, &
sc¡_æags
);

791 
	`smp_mb__aá”_þ—r_b™
();

793 
	`TRACE_MGMT_DBG
("Waiting for %d‡ctive commands finallyo complete",

794 
	`sc¡_g‘_cmd_couÁ”
());

796 
»s
 = 
	`sc¡_su¥_wa™
(
š‹¼u±ibË
);

797 ià(
»s
 != 0)

798 
out_þ—r
;

800 ià(
»p
)

801 
	`PRINT_INFO
("%s", "All‡ctive commands completed");

803 
out_up
:

804 
	`mu‹x_uÆock
(&
sc¡_su¥’d_mu‹x
);

806 
out
:

807 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

808 ià(
»s
 == 0)

809 
	`lock_acquœed
(&
sc¡_su¥’d_d•_m­
, 
_RET_IP_
);

811 
	`rwlock_»Ëa£
(&
sc¡_su¥’d_d•_m­
, 1, 
_RET_IP_
);

814 
	`TRACE_EXIT_RES
(
»s
);

815  
»s
;

817 
out_þ—r
:

818 
	`þ—r_b™
(
SCST_FLAG_SUSPENDING
, &
sc¡_æags
);

820 
	`smp_mb__aá”_þ—r_b™
();

821 
out_up
;

822 
	}
}

823 
EXPORT_SYMBOL_GPL
(
sc¡_su¥’d_aùiv™y
);

825 
	$__sc¡_»sume_aùiv™y
()

827 
sc¡_cmd_th»ads
 *
l
;

829 
	`TRACE_ENTRY
();

831 
su¥’d_couÁ
--;

832 
	`TRACE_MGMT_DBG
("su¥’d_couÁ %d†eá", 
su¥’d_couÁ
);

833 ià(
su¥’d_couÁ
 > 0)

834 
out
;

836 
	`þ—r_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
);

841 
	`smp_mb__aá”_þ—r_b™
();

843 
	`li¡_fÜ_—ch_’Œy
(
l
, &
sc¡_cmd_th»ads_li¡
, 
li¡s_li¡_’Œy
) {

844 
	`wake_up_®l
(&
l
->
cmd_li¡_wa™Q
);

846 
	`wake_up_®l
(&
sc¡_š™_cmd_li¡_wa™Q
);

848 
	`¥š_lock_œq
(&
sc¡_mcmd_lock
);

849 ià(!
	`li¡_em±y
(&
sc¡_d–ayed_mgmt_cmd_li¡
)) {

850 
sc¡_mgmt_cmd
 *
m
;

851 
m
 = 
	`li¡_’Œy
(
sc¡_d–ayed_mgmt_cmd_li¡
.
Ãxt
, 
	`ty³of
(*m),

852 
mgmt_cmd_li¡_’Œy
);

853 
	`TRACE_MGMT_DBG
("Moving delayed mgmt cmd %po head of‡ctive "

854 "mgmˆcmd†i¡", 
m
);

855 
	`li¡_move
(&
m
->
mgmt_cmd_li¡_’Œy
, &
sc¡_aùive_mgmt_cmd_li¡
);

857 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

858 
	`wake_up_®l
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

860 
out
:

861 
	`TRACE_EXIT
();

863 
	}
}

870 
	$sc¡_»sume_aùiv™y
()

872 
	`TRACE_ENTRY
();

874 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 29)

875 
	`rwlock_»Ëa£
(&
sc¡_su¥’d_d•_m­
, 1, 
_RET_IP_
);

878 
	`mu‹x_lock
(&
sc¡_su¥’d_mu‹x
);

879 
	`__sc¡_»sume_aùiv™y
();

880 
	`mu‹x_uÆock
(&
sc¡_su¥’d_mu‹x
);

882 
	`TRACE_EXIT
();

884 
	}
}

885 
EXPORT_SYMBOL_GPL
(
sc¡_»sume_aùiv™y
);

887 
	$sc¡_»gi¡”_deviû
(
scsi_deviû
 *
scsidp
)

889 
»s
;

890 
sc¡_deviû
 *
dev
, *
d
;

891 #ifdeà
CONFIG_SCST_PROC


892 
sc¡_dev_ty³
 *
dt
;

895 
	`TRACE_ENTRY
();

897 #ifdeà
CONFIG_SCST_PROC


898 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

899 ià(
»s
 != 0)

900 
out
;

903 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

904 ià(
»s
 != 0)

905 #ifdeà
CONFIG_SCST_PROC


906 
out_»sume
;

908 
out
;

911 
»s
 = 
	`sc¡_®loc_deviû
(
GFP_KERNEL
, &
dev
);

912 ià(
»s
 != 0)

913 
out_uÆock
;

915 
dev
->
ty³
 = 
scsidp
->type;

917 
dev
->
vœt_Çme
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%d:%d:%d:%d",

918 
scsidp
->
ho¡
->
ho¡_no
,

919 
scsidp
->
chªÃl
, scsidp->
id
, scsidp->
lun
);

920 ià(
dev
->
vœt_Çme
 =ð
NULL
) {

921 
	`PRINT_ERROR
("%s", "Unableo‡lloc device‚ame");

922 
»s
 = -
ENOMEM
;

923 
out_ä“_dev
;

926 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

927 ià(
	`¡rcmp
(
d
->
vœt_Çme
, 
dev
->virt_name) == 0) {

928 
	`PRINT_ERROR
("Deviû % ®»adyƒxi¡s", 
dev
->
vœt_Çme
);

929 
»s
 = -
EEXIST
;

930 
out_ä“_dev
;

934 
dev
->
scsi_dev
 = 
scsidp
;

936 
	`li¡_add_ž
(&
dev
->
dev_li¡_’Œy
, &
sc¡_dev_li¡
);

938 #ifdeà
CONFIG_SCST_PROC


943 
	`li¡_fÜ_—ch_’Œy
(
dt
, &
sc¡_dev_ty³_li¡
, 
dev_ty³_li¡_’Œy
) {

944 ià(
dt
->
ty³
 =ð
scsidp
->type) {

945 
»s
 = 
	`sc¡_assign_dev_hªdËr
(
dev
, 
dt
);

946 ià(
»s
 != 0)

947 
out_d–
;

952 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

953 
	`sc¡_»sume_aùiv™y
();

955 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

957 
»s
 = 
	`sc¡_dev_sysfs_ü—‹
(
dev
);

958 ià(
»s
 != 0)

959 
out_d–
;

962 
	`PRINT_INFO
("Attachedo scsi%d, channel %d, id %d,†un %d, "

963 "ty³ %d", 
scsidp
->
ho¡
->
ho¡_no
, scsidp->
chªÃl
,

964 
scsidp
->
id
, scsidp->
lun
, scsidp->
ty³
);

966 
out
:

967 
	`TRACE_EXIT_RES
(
»s
);

968  
»s
;

970 
out_d–
:

971 
	`li¡_d–
(&
dev
->
dev_li¡_’Œy
);

973 
out_ä“_dev
:

974 
	`sc¡_ä“_deviû
(
dev
);

976 
out_uÆock
:

977 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

978 #ifdeà
CONFIG_SCST_PROC


979 
out_»sume
:

980 
	`sc¡_»sume_aùiv™y
();

982 
out
;

983 
	}
}

985 
	$sc¡_uÄegi¡”_deviû
(
scsi_deviû
 *
scsidp
)

987 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

988 
sc¡_acg_dev
 *
acg_dev
, *
¯
;

990 
	`TRACE_ENTRY
();

992 
	`sc¡_su¥’d_aùiv™y
(
çl£
);

993 
	`mu‹x_lock
(&
sc¡_mu‹x
);

995 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

996 ià(
d
->
scsi_dev
 =ð
scsidp
) {

997 
dev
 = 
d
;

998 
	`TRACE_DBG
("Deviû %°found", 
dev
);

1002 ià(
dev
 =ð
NULL
) {

1003 
	`PRINT_ERROR
("SCST device for SCSI device %d:%d:%d:%d‚ot found",

1004 
scsidp
->
ho¡
->
ho¡_no
, scsidp->
chªÃl
, scsidp->
id
,

1005 
scsidp
->
lun
);

1006 
out_uÆock
;

1009 
dev
->
dev_uÄegi¡”šg
 = 1;

1011 
	`li¡_d–
(&
dev
->
dev_li¡_’Œy
);

1013 
	`sc¡_dg_dev_»move_by_dev
(
dev
);

1015 
	`sc¡_assign_dev_hªdËr
(
dev
, &
sc¡_nuÎ_devty³
);

1017 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
¯
, &
dev
->
dev_acg_dev_li¡
,

1018 
dev_acg_dev_li¡_’Œy
) {

1019 
	`sc¡_acg_d–_lun
(
acg_dev
->
acg
,‡cg_dev->
lun
, 
Œue
);

1022 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1024 
	`sc¡_»sume_aùiv™y
();

1026 
	`sc¡_dev_sysfs_d–
(
dev
);

1028 
	`PRINT_INFO
("Detached from scsi%d, channel %d, id %d,†un %d,ype %d",

1029 
scsidp
->
ho¡
->
ho¡_no
, scsidp->
chªÃl
, scsidp->
id
,

1030 
scsidp
->
lun
, scsidp->
ty³
);

1032 
	`sc¡_ä“_deviû
(
dev
);

1034 
out
:

1035 
	`TRACE_EXIT
();

1038 
out_uÆock
:

1039 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1040 
	`sc¡_»sume_aùiv™y
();

1041 
out
;

1042 
	}
}

1044 
	$sc¡_dev_hªdËr_check
(
sc¡_dev_ty³
 *
dev_hªdËr
)

1046 
»s
 = 0;

1048 ià(
dev_hªdËr
->
·r£
 =ð
NULL
) {

1049 
	`PRINT_ERROR
("scst dev handler %s must have "

1050 "·r£(èm‘hod.", 
dev_hªdËr
->
Çme
);

1051 
»s
 = -
EINVAL
;

1052 
out
;

1055 #iâdeà
CONFIG_SCST_PROC


1056 ià(((
dev_hªdËr
->
add_deviû
 !ð
NULL
) &&

1057 (
dev_hªdËr
->
d–_deviû
 =ð
NULL
)) ||

1058 ((
dev_hªdËr
->
add_deviû
 =ð
NULL
) &&

1059 (
dev_hªdËr
->
d–_deviû
 !ð
NULL
))) {

1060 
	`PRINT_ERROR
("Dev handler %s mustƒither define both "

1062 
dev_hªdËr
->
Çme
);

1063 
»s
 = -
EINVAL
;

1064 
out
;

1068 ià(
dev_hªdËr
->
®loc_d©a_buf
 =ð
NULL
)

1069 
dev_hªdËr
->
®loc_d©a_buf_©omic
 = 1;

1071 ià(
dev_hªdËr
->
dev_dÚe
 =ð
NULL
)

1072 
dev_hªdËr
->
dev_dÚe_©omic
 = 1;

1074 
out
:

1075 
	`TRACE_EXIT_RES
(
»s
);

1076  
»s
;

1077 
	}
}

1079 
	$sc¡_check_deviû_Çme
(cÚ¡ *
dev_Çme
)

1081 
»s
 = 0;

1083 ià(
	`¡rchr
(
dev_Çme
, '/'è!ð
NULL
) {

1084 
	`PRINT_ERROR
("Dev‚ame %s contains illegal character '/'",

1085 
dev_Çme
);

1086 
»s
 = -
EINVAL
;

1089 
	`TRACE_EXIT_RES
(
»s
);

1090  
»s
;

1091 
	}
}

1102 
	$sc¡_»gi¡”_vœtu®_deviû
(
sc¡_dev_ty³
 *
dev_hªdËr
,

1103 cÚ¡ *
dev_Çme
)

1105 
»s
;

1106 
sc¡_deviû
 *
dev
, *
d
;

1107 
boÞ
 
sysfs_d–
 = 
çl£
;

1109 
	`TRACE_ENTRY
();

1111 ià(
dev_hªdËr
 =ð
NULL
) {

1112 
	`PRINT_ERROR
("%s: valid device handler must be supplied",

1113 
__func__
);

1114 
»s
 = -
EINVAL
;

1115 
out
;

1118 ià(
dev_Çme
 =ð
NULL
) {

1119 
	`PRINT_ERROR
("%s: deviû‚ammu¡ bnÚ-NULL", 
__func__
);

1120 
»s
 = -
EINVAL
;

1121 
out
;

1124 
»s
 = 
	`sc¡_check_deviû_Çme
(
dev_Çme
);

1125 ià(
»s
 != 0)

1126 
out
;

1128 
»s
 = 
	`sc¡_dev_hªdËr_check
(
dev_hªdËr
);

1129 ià(
»s
 != 0)

1130 
out
;

1132 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

1133 ià(
»s
 != 0)

1134 
out
;

1136 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1137 ià(
»s
 != 0)

1138 
out_»sume
;

1140 
»s
 = 
	`sc¡_®loc_deviû
(
GFP_KERNEL
, &
dev
);

1141 ià(
»s
 != 0)

1142 
out_uÆock
;

1144 
dev
->
ty³
 = 
dev_hªdËr
->type;

1145 
dev
->
scsi_dev
 = 
NULL
;

1146 
dev
->
vœt_Çme
 = 
	`k¡rdup
(
dev_Çme
, 
GFP_KERNEL
);

1147 ià(
dev
->
vœt_Çme
 =ð
NULL
) {

1148 
	`PRINT_ERROR
("Unableo‡llocate virt_name for dev %s",

1149 
dev_Çme
);

1150 
»s
 = -
ENOMEM
;

1151 
out_ä“_dev
;

1155 
dev
->
vœt_id
 = 
sc¡_vœt_dev_Ï¡_id
++;

1156 ià(
dev
->
vœt_id
 > 0)

1158 
sc¡_vœt_dev_Ï¡_id
 = 1;

1161 
»s
 = 
dev
->
vœt_id
;

1163 
»s
 = 
	`sc¡_´_š™_dev
(
dev
);

1164 ià(
»s
 != 0)

1165 
out_ä“_dev
;

1167 #iâdeà
CONFIG_SCST_PROC


1172 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1174 
»s
 = 
	`sc¡_dev_sysfs_ü—‹
(
dev
);

1175 ià(
»s
 != 0)

1176 
out_lock_´_þ—r_dev
;

1178 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1181 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1182 ià(
	`¡rcmp
(
d
->
vœt_Çme
, 
dev_Çme
) == 0) {

1183 
	`PRINT_ERROR
("Deviû % ®»adyƒxi¡s", 
dev_Çme
);

1184 
»s
 = -
EEXIST
;

1185 
sysfs_d–
 = 
Œue
;

1186 
out_´_þ—r_dev
;

1190 
»s
 = 
	`sc¡_assign_dev_hªdËr
(
dev
, 
dev_hªdËr
);

1191 ià(
»s
 != 0) {

1192 
sysfs_d–
 = 
Œue
;

1193 
out_´_þ—r_dev
;

1196 
	`li¡_add_ž
(&
dev
->
dev_li¡_’Œy
, &
sc¡_dev_li¡
);

1198 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1199 
	`sc¡_»sume_aùiv™y
();

1201 
»s
 = 
dev
->
vœt_id
;

1203 
	`PRINT_INFO
("A‰achedØvœtu® deviû % (id %d)", 
dev_Çme
, 
»s
);

1205 
out
:

1206 
	`TRACE_EXIT_RES
(
»s
);

1207  
»s
;

1209 #iâdeà
CONFIG_SCST_PROC


1210 
out_lock_´_þ—r_dev
:

1211 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1214 
out_´_þ—r_dev
:

1215 
	`sc¡_´_þ—r_dev
(
dev
);

1217 
out_ä“_dev
:

1218 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1219 ià(
sysfs_d–
)

1220 
	`sc¡_dev_sysfs_d–
(
dev
);

1221 
	`sc¡_ä“_deviû
(
dev
);

1222 
out_»sume
;

1224 
out_uÆock
:

1225 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1227 
out_»sume
:

1228 
	`sc¡_»sume_aùiv™y
();

1229 
out
;

1230 
	}
}

1231 
EXPORT_SYMBOL_GPL
(
sc¡_»gi¡”_vœtu®_deviû
);

1237 
	$sc¡_uÄegi¡”_vœtu®_deviû
(
id
)

1239 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

1240 
sc¡_acg_dev
 *
acg_dev
, *
¯
;

1242 
	`TRACE_ENTRY
();

1244 
	`sc¡_su¥’d_aùiv™y
(
çl£
);

1245 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1247 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1248 ià(
d
->
vœt_id
 =ð
id
) {

1249 
dev
 = 
d
;

1250 
	`TRACE_DBG
("Vœtu® deviû %°(id %dèfound", 
dev
, 
id
);

1254 ià(
dev
 =ð
NULL
) {

1255 
	`PRINT_ERROR
("Vœtu® deviû (id %dènÙ found", 
id
);

1256 
out_uÆock
;

1259 
dev
->
dev_uÄegi¡”šg
 = 1;

1261 
	`li¡_d–
(&
dev
->
dev_li¡_’Œy
);

1263 
	`sc¡_´_þ—r_dev
(
dev
);

1265 
	`sc¡_dg_dev_»move_by_dev
(
dev
);

1267 
	`sc¡_assign_dev_hªdËr
(
dev
, &
sc¡_nuÎ_devty³
);

1269 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
¯
, &
dev
->
dev_acg_dev_li¡
,

1270 
dev_acg_dev_li¡_’Œy
) {

1271 
	`sc¡_acg_d–_lun
(
acg_dev
->
acg
,‡cg_dev->
lun
, 
Œue
);

1274 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1275 
	`sc¡_»sume_aùiv™y
();

1277 
	`sc¡_dev_sysfs_d–
(
dev
);

1279 
	`PRINT_INFO
("Detached from virtual device %s (id %d)",

1280 
dev
->
vœt_Çme
, dev->
vœt_id
);

1282 
	`sc¡_ä“_deviû
(
dev
);

1284 
out
:

1285 
	`TRACE_EXIT
();

1288 
out_uÆock
:

1289 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1290 
	`sc¡_»sume_aùiv™y
();

1291 
out
;

1292 
	}
}

1293 
EXPORT_SYMBOL_GPL
(
sc¡_uÄegi¡”_vœtu®_deviû
);

1306 
	$__sc¡_»gi¡”_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
,

1307 cÚ¡ *
v”siÚ
)

1309 
»s
, 
exi¡
;

1310 
sc¡_dev_ty³
 *
dt
;

1311 #ifdeà
CONFIG_SCST_PROC


1312 
sc¡_deviû
 *
dev
;

1315 
	`TRACE_ENTRY
();

1317 
»s
 = -
EINVAL
;

1318 ià(
	`¡rcmp
(
v”siÚ
, 
SCST_INTERFACE_VERSION
) != 0) {

1319 
	`PRINT_ERROR
("Incorrect version of dev handler %s",

1320 
dev_ty³
->
Çme
);

1321 
out
;

1324 
»s
 = 
	`sc¡_dev_hªdËr_check
(
dev_ty³
);

1325 ià(
»s
 != 0)

1326 
out
;

1328 #ià!
	`defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

1329 ià(
dev_ty³
->
exec
 =ð
NULL
) {

1330 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 30)

1331 #ià!
	`defšed
(
CONFIG_SCST_STRICT_SERIALIZING
)

1332 
	`PRINT_ERROR
("Pass-through dev handlers (handler \"%s\")‚ot "

1335 "CONFIG_SCST_STRICT_SERIALIZING", 
dev_ty³
->
Çme
);

1336 
»s
 = -
EINVAL
;

1337 
out
;

1340 
	`PRINT_ERROR
("Pass-through dev handlers (handler \"%s\")‚ot "

1342 "sc¡_exec_»q_fifo-<k”Ãl-v”siÚ>", 
dev_ty³
->
Çme
);

1343 
»s
 = -
EINVAL
;

1344 
out
;

1349 #ifdeà
CONFIG_SCST_PROC


1350 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

1351 ià(
»s
 != 0)

1352 
out
;

1355 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1356 ià(
»s
 != 0)

1357 #ifdeà
CONFIG_SCST_PROC


1358 
out_»sume
;

1360 
out
;

1363 
exi¡
 = 0;

1364 
	`li¡_fÜ_—ch_’Œy
(
dt
, &
sc¡_dev_ty³_li¡
, 
dev_ty³_li¡_’Œy
) {

1365 ià(
	`¡rcmp
(
dt
->
Çme
, 
dev_ty³
->name) == 0) {

1366 
	`PRINT_ERROR
("Deviceype handler \"%s\"‡lready "

1367 "exi¡s", 
dt
->
Çme
);

1368 
exi¡
 = 1;

1372 ià(
exi¡
)

1373 
out_uÆock
;

1375 
	`li¡_add_ž
(&
dev_ty³
->
dev_ty³_li¡_’Œy
, &
sc¡_dev_ty³_li¡
);

1377 #ifdeà
CONFIG_SCST_PROC


1378 ià(!
dev_ty³
->
no_´oc
) {

1379 
»s
 = 
	`sc¡_bužd_´oc_dev_hªdËr_dœ_’Œ›s
(
dev_ty³
);

1380 ià(
»s
 < 0)

1381 
out_uÆock
;

1388 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1389 ià(
dev
->
scsi_dev
 =ð
NULL
 || dev->
hªdËr
 !ð&
sc¡_nuÎ_devty³
)

1391 ià(
dev
->
scsi_dev
->
ty³
 =ð
dev_ty³
->type)

1392 
	`sc¡_assign_dev_hªdËr
(
dev
, 
dev_ty³
);

1395 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1396 
	`sc¡_»sume_aùiv™y
();

1398 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1400 
»s
 = 
	`sc¡_devt_sysfs_ü—‹
(
dev_ty³
);

1401 ià(
»s
 < 0)

1402 
out
;

1405 
	`PRINT_INFO
("Device handler \"%s\" forype %d„egistered "

1406 "sucûssfuÎy", 
dev_ty³
->
Çme
, dev_ty³->
ty³
);

1408 
out
:

1409 
	`TRACE_EXIT_RES
(
»s
);

1410  
»s
;

1412 
out_uÆock
:

1413 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1414 #ifdeà
CONFIG_SCST_PROC


1415 
out_»sume
:

1416 
	`sc¡_»sume_aùiv™y
();

1418 
out
;

1419 
	}
}

1420 
EXPORT_SYMBOL_GPL
(
__sc¡_»gi¡”_dev_driv”
);

1425 
	$sc¡_uÄegi¡”_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
)

1427 
sc¡_deviû
 *
dev
;

1428 
sc¡_dev_ty³
 *
dt
;

1429 
found
 = 0;

1431 
	`TRACE_ENTRY
();

1433 
	`sc¡_su¥’d_aùiv™y
(
çl£
);

1434 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1436 
	`li¡_fÜ_—ch_’Œy
(
dt
, &
sc¡_dev_ty³_li¡
, 
dev_ty³_li¡_’Œy
) {

1437 ià(
	`¡rcmp
(
dt
->
Çme
, 
dev_ty³
->name) == 0) {

1438 
found
 = 1;

1442 ià(!
found
) {

1443 
	`PRINT_ERROR
("Dev handler \"%s\" isn't„egistered",

1444 
dev_ty³
->
Çme
);

1445 
out_up
;

1448 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1449 ià(
dev
->
hªdËr
 =ð
dev_ty³
) {

1450 
	`sc¡_assign_dev_hªdËr
(
dev
, &
sc¡_nuÎ_devty³
);

1451 
	`TRACE_DBG
("Dev hªdË¸»moved from deviû %p", 
dev
);

1455 
	`li¡_d–
(&
dev_ty³
->
dev_ty³_li¡_’Œy
);

1457 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1458 
	`sc¡_»sume_aùiv™y
();

1460 #ifdeà
CONFIG_SCST_PROC


1461 
	`sc¡_þ—nup_´oc_dev_hªdËr_dœ_’Œ›s
(
dev_ty³
);

1463 
	`sc¡_devt_sysfs_d–
(
dev_ty³
);

1466 
	`PRINT_INFO
("Device handler \"%s\" forype %d unloaded",

1467 
dev_ty³
->
Çme
, dev_ty³->
ty³
);

1469 
out
:

1470 
	`TRACE_EXIT
();

1473 
out_up
:

1474 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1475 
	`sc¡_»sume_aùiv™y
();

1476 
out
;

1477 
	}
}

1478 
EXPORT_SYMBOL_GPL
(
sc¡_uÄegi¡”_dev_driv”
);

1491 
	$__sc¡_»gi¡”_vœtu®_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
,

1492 cÚ¡ *
v”siÚ
)

1494 
»s
;

1496 
	`TRACE_ENTRY
();

1498 ià(
	`¡rcmp
(
v”siÚ
, 
SCST_INTERFACE_VERSION
) != 0) {

1499 
	`PRINT_ERROR
("Incorrect version of virtual dev handler %s",

1500 
dev_ty³
->
Çme
);

1501 
»s
 = -
EINVAL
;

1502 
out
;

1505 
»s
 = 
	`sc¡_dev_hªdËr_check
(
dev_ty³
);

1506 ià(
»s
 != 0)

1507 
out
;

1509 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1510 ià(
»s
 != 0)

1511 
out
;

1512 
	`li¡_add_ž
(&
dev_ty³
->
dev_ty³_li¡_’Œy
, &
sc¡_vœtu®_dev_ty³_li¡
);

1513 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1515 #ifdeà
CONFIG_SCST_PROC


1516 ià(!
dev_ty³
->
no_´oc
) {

1517 
»s
 = 
	`sc¡_bužd_´oc_dev_hªdËr_dœ_’Œ›s
(
dev_ty³
);

1518 ià(
»s
 < 0)

1519 
out
;

1522 
»s
 = 
	`sc¡_devt_sysfs_ü—‹
(
dev_ty³
);

1523 ià(
»s
 < 0)

1524 
out
;

1527 ià(
dev_ty³
->
ty³
 != -1) {

1528 
	`PRINT_INFO
("Virtual device handler %s forype %d "

1529 "»gi¡”ed sucûssfuÎy", 
dev_ty³
->
Çme
,

1530 
dev_ty³
->
ty³
);

1532 
	`PRINT_INFO
("Virtual device handler \"%s\"„egistered "

1533 "sucûssfuÎy", 
dev_ty³
->
Çme
);

1536 
out
:

1537 
	`TRACE_EXIT_RES
(
»s
);

1538  
»s
;

1539 
	}
}

1540 
EXPORT_SYMBOL_GPL
(
__sc¡_»gi¡”_vœtu®_dev_driv”
);

1545 
	$sc¡_uÄegi¡”_vœtu®_dev_driv”
(
sc¡_dev_ty³
 *
dev_ty³
)

1547 
	`TRACE_ENTRY
();

1549 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1552 
	`li¡_d–
(&
dev_ty³
->
dev_ty³_li¡_’Œy
);

1554 #iâdeà
CONFIG_SCST_PROC


1556 
dev_ty³
->
devt_aùive_sysfs_wÜks_couÁ
 > 0) {

1557 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1558 
	`m¦“p
(100);

1559 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1563 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1565 #ifdeà
CONFIG_SCST_PROC


1566 ià(!
dev_ty³
->
no_´oc
)

1567 
	`sc¡_þ—nup_´oc_dev_hªdËr_dœ_’Œ›s
(
dev_ty³
);

1569 
	`sc¡_devt_sysfs_d–
(
dev_ty³
);

1572 
	`PRINT_INFO
("Deviû hªdË¸\"%s\" uÆßded", 
dev_ty³
->
Çme
);

1574 
	`TRACE_EXIT
();

1576 
	}
}

1577 
EXPORT_SYMBOL_GPL
(
sc¡_uÄegi¡”_vœtu®_dev_driv”
);

1580 
	$sc¡_add_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
,

1581 
sc¡_deviû
 *
dev
, 
sc¡_tgt_dev
 *
tgt_dev
, 
num
)

1583 
»s
 = 0, 
i
;

1584 
sc¡_cmd_th»ad_t
 *
thr
;

1585 
n
 = 0, 
tgt_dev_num
 = 0;

1587 
	`TRACE_ENTRY
();

1589 ià(
num
 == 0) {

1590 
»s
 = 0;

1591 
out
;

1594 
	`li¡_fÜ_—ch_’Œy
(
thr
, &
cmd_th»ads
->
th»ads_li¡
, 
th»ad_li¡_’Œy
) {

1595 
n
++;

1598 
	`TRACE_DBG
("cmd_threads %p, dev %s,gt_dev %p,‚um %d,‚ %d",

1599 
cmd_th»ads
, 
dev
 ? dev->
vœt_Çme
 : 
NULL
, 
tgt_dev
, 
num
, 
n
);

1601 ià(
tgt_dev
 !ð
NULL
) {

1602 
sc¡_tgt_dev
 *
t
;

1603 
	`li¡_fÜ_—ch_’Œy
(
t
, &
tgt_dev
->
dev
->
dev_tgt_dev_li¡
,

1604 
dev_tgt_dev_li¡_’Œy
) {

1605 ià(
t
 =ð
tgt_dev
)

1607 
tgt_dev_num
++;

1611 
i
 = 0; i < 
num
; i++) {

1612 
thr
 = 
	`km®loc
((*thr), 
GFP_KERNEL
);

1613 ià(!
thr
) {

1614 
»s
 = -
ENOMEM
;

1615 
	`PRINT_ERROR
("FažØ®loÿ‹h¸%d", 
»s
);

1616 
out_wa™
;

1619 ià(
dev
 !ð
NULL
) {

1620 
thr
->
cmd_th»ad
 = 
	`kth»ad_ü—‹
(
sc¡_cmd_th»ad
,

1621 
cmd_th»ads
, "%.13s%d", 
dev
->
vœt_Çme
, 
n
++);

1622 } ià(
tgt_dev
 !ð
NULL
) {

1623 
thr
->
cmd_th»ad
 = 
	`kth»ad_ü—‹
(
sc¡_cmd_th»ad
,

1624 
cmd_th»ads
, "%.10s%d_%d",

1625 
tgt_dev
->
dev
->
vœt_Çme
, 
tgt_dev_num
, 
n
++);

1627 
thr
->
cmd_th»ad
 = 
	`kth»ad_ü—‹
(
sc¡_cmd_th»ad
,

1628 
cmd_th»ads
, "sc¡d%d", 
n
++);

1630 ià(
	`IS_ERR
(
thr
->
cmd_th»ad
)) {

1631 
»s
 = 
	`PTR_ERR
(
thr
->
cmd_th»ad
);

1632 
	`PRINT_ERROR
("kth»ad_ü—‹(èçžed: %d", 
»s
);

1633 
	`kä“
(
thr
);

1634 
out_wa™
;

1637 ià(
tgt_dev
 !ð
NULL
) {

1638 
rc
;

1643 #ià
	`defšed
(
RHEL_MAJOR
) && RHEL_MAJOR -0 <= 5

1644 
rc
 = 
	`£t_ýus_®lowed
(
thr
->
cmd_th»ad
,

1645 
tgt_dev
->
acg_dev
->
acg
->
acg_ýu_mask
);

1647 
rc
 = 
	`£t_ýus_®lowed_±r
(
thr
->
cmd_th»ad
,

1648 &
tgt_dev
->
acg_dev
->
acg
->
acg_ýu_mask
);

1650 ià(
rc
 != 0)

1651 
	`PRINT_ERROR
("Setting CPU‡ffinity failed: "

1652 "%d", 
rc
);

1655 
	`li¡_add
(&
thr
->
th»ad_li¡_’Œy
, &
cmd_th»ads
->
th»ads_li¡
);

1656 
cmd_th»ads
->
Ä_th»ads
++;

1658 
	`TRACE_DBG
("Addedhr %pohreads†ist (nr_threads %d,‚ %d)",

1659 
thr
, 
cmd_th»ads
->
Ä_th»ads
, 
n
);

1661 
	`wake_up_´oûss
(
thr
->
cmd_th»ad
);

1664 
out_wa™
:

1665 ià(
i
 > 0 && 
cmd_th»ads
 !ð&
sc¡_maš_cmd_th»ads
) {

1670 !*(vÞ©ž
boÞ
*)&
cmd_th»ads
->
io_cÚ‹xt_»ady
) {

1671 
	`TRACE_DBG
("Waiting for io_context for cmd_threads %p "

1672 "š™Ÿlized", 
cmd_th»ads
);

1673 
	`m¦“p
(50);

1675 
	`smp_rmb
();

1678 ià(
»s
 != 0)

1679 
	`sc¡_d–_th»ads
(
cmd_th»ads
, 
i
);

1681 
out
:

1682 
	`TRACE_EXIT_RES
(
»s
);

1683  
»s
;

1684 
	}
}

1687 
	$sc¡_d–_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
, 
num
)

1689 
sc¡_cmd_th»ad_t
 *
ù
, *
tmp
;

1691 
	`TRACE_ENTRY
();

1693 ià(
num
 == 0)

1694 
out
;

1696 
	`li¡_fÜ_—ch_’Œy_§ã_»v”£
(
ù
, 
tmp
, &
cmd_th»ads
->
th»ads_li¡
,

1697 
th»ad_li¡_’Œy
) {

1698 
rc
;

1699 
sc¡_deviû
 *
dev
;

1701 
rc
 = 
	`kth»ad_¡Ý
(
ù
->
cmd_th»ad
);

1702 ià(
rc
 !ð0 &&„ø!ð-
EINTR
)

1703 
	`TRACE_MGMT_DBG
("kth»ad_¡Ý(èçžed: %d", 
rc
);

1705 
	`li¡_d–
(&
ù
->
th»ad_li¡_’Œy
);

1707 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1708 
sc¡_tgt_dev
 *
tgt_dev
;

1709 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1710 
dev_tgt_dev_li¡_’Œy
) {

1711 
	`sc¡_d–_thr_d©a
(
tgt_dev
, 
ù
->
cmd_th»ad
);

1715 
	`kä“
(
ù
);

1717 
cmd_th»ads
->
Ä_th»ads
--;

1719 --
num
;

1720 ià(
num
 == 0)

1724 
	`EXTRACHECKS_BUG_ON
((
cmd_th»ads
->
Ä_th»ads
 == 0) &&

1725 (
cmd_th»ads
->
io_cÚ‹xt
 !ð
NULL
));

1727 
out
:

1728 
	`TRACE_EXIT
();

1730 
	}
}

1733 
	$sc¡_¡Ý_dev_th»ads
(
sc¡_deviû
 *
dev
)

1735 
sc¡_tgt_dev
 *
tgt_dev
;

1737 
	`TRACE_ENTRY
();

1739 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1740 
dev_tgt_dev_li¡_’Œy
) {

1741 
	`sc¡_tgt_dev_¡Ý_th»ads
(
tgt_dev
);

1744 ià((
dev
->
th»ads_num
 > 0) &&

1745 (
dev
->
th»ads_poÞ_ty³
 =ð
SCST_THREADS_POOL_SHARED
))

1746 
	`sc¡_d–_th»ads
(&
dev
->
dev_cmd_th»ads
, -1);

1748 
	`TRACE_EXIT
();

1750 
	}
}

1753 
	$sc¡_ü—‹_dev_th»ads
(
sc¡_deviû
 *
dev
)

1755 
»s
 = 0;

1756 
sc¡_tgt_dev
 *
tgt_dev
;

1758 
	`TRACE_ENTRY
();

1760 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1761 
dev_tgt_dev_li¡_’Œy
) {

1762 
»s
 = 
	`sc¡_tgt_dev_£tup_th»ads
(
tgt_dev
);

1763 ià(
»s
 != 0)

1764 
out_”r
;

1767 ià((
dev
->
th»ads_num
 > 0) &&

1768 (
dev
->
th»ads_poÞ_ty³
 =ð
SCST_THREADS_POOL_SHARED
)) {

1769 
»s
 = 
	`sc¡_add_th»ads
(&
dev
->
dev_cmd_th»ads
, dev, 
NULL
,

1770 
dev
->
th»ads_num
);

1771 ià(
»s
 != 0)

1772 
out_”r
;

1775 
out
:

1776 
	`TRACE_EXIT_RES
(
»s
);

1777  
»s
;

1779 
out_”r
:

1780 
	`sc¡_¡Ý_dev_th»ads
(
dev
);

1781 
out
;

1782 
	}
}

1785 
	$sc¡_assign_dev_hªdËr
(
sc¡_deviû
 *
dev
,

1786 
sc¡_dev_ty³
 *
hªdËr
)

1788 
»s
 = 0;

1789 
sc¡_tgt_dev
 *
tgt_dev
;

1790 
	`LIST_HEAD
(
©ched_tgt_devs
);

1792 
	`TRACE_ENTRY
();

1794 
	`sBUG_ON
(
hªdËr
 =ð
NULL
);

1796 ià(
dev
->
hªdËr
 == handler)

1797 
out
;

1799 ià(
dev
->
hªdËr
 =ð
NULL
)

1800 
assign
;

1802 ià(
dev
->
hªdËr
->
d‘ach_tgt
) {

1803 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1804 
dev_tgt_dev_li¡_’Œy
) {

1805 
	`TRACE_DBG
("Calling dev handler's detach_tgt(%p)",

1806 
tgt_dev
);

1807 
dev
->
hªdËr
->
	`d‘ach_tgt
(
tgt_dev
);

1808 
	`TRACE_DBG
("%s", "Dev handler's detach_tgt()„eturned");

1817 
	`sc¡_devt_dev_sysfs_d–
(
dev
);

1819 ià(
dev
->
hªdËr
->
d‘ach
) {

1820 
	`TRACE_DBG
("%s", "Calling dev handler's detach()");

1821 
dev
->
hªdËr
->
	`d‘ach
(dev);

1822 
	`TRACE_DBG
("%s", "Old handler's detach()„eturned");

1825 
	`sc¡_¡Ý_dev_th»ads
(
dev
);

1827 
assign
:

1828 
dev
->
hªdËr
 = handler;

1830 ià(
hªdËr
 =ð
NULL
)

1831 
out
;

1833 
dev
->
th»ads_num
 = 
hªdËr
->threads_num;

1834 
dev
->
th»ads_poÞ_ty³
 = 
hªdËr
->threads_pool_type;

1836 ià(
hªdËr
->
©ch
) {

1837 
	`TRACE_DBG
("C®lšg‚ew dev hªdËr' ©ch(%p)", 
dev
);

1838 
»s
 = 
hªdËr
->
	`©ch
(
dev
);

1839 
	`TRACE_DBG
("New dev hªdËr' ©ch(è»tuºed %d", 
»s
);

1840 ià(
»s
 != 0) {

1841 
	`PRINT_ERROR
("New device handler's %s‡ttach() "

1842 "çžed: %d", 
hªdËr
->
Çme
, 
»s
);

1843 
out
;

1847 
»s
 = 
	`sc¡_devt_dev_sysfs_ü—‹
(
dev
);

1848 ià(
»s
 != 0)

1849 
out_d‘ach
;

1851 ià(
hªdËr
->
©ch_tgt
) {

1852 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1853 
dev_tgt_dev_li¡_’Œy
) {

1854 
	`TRACE_DBG
("Calling dev handler's‡ttach_tgt(%p)",

1855 
tgt_dev
);

1856 
»s
 = 
hªdËr
->
	`©ch_tgt
(
tgt_dev
);

1857 
	`TRACE_DBG
("%s", "Dev handler's‡ttach_tgt()„eturned");

1858 ià(
»s
 != 0) {

1859 
	`PRINT_ERROR
("Device handler's %s‡ttach_tgt() "

1860 "çžed: %d", 
hªdËr
->
Çme
, 
»s
);

1861 
out_”r_»move_sysfs
;

1863 
	`li¡_add_ž
(&
tgt_dev
->
exŒa_tgt_dev_li¡_’Œy
,

1864 &
©ched_tgt_devs
);

1868 
»s
 = 
	`sc¡_ü—‹_dev_th»ads
(
dev
);

1869 ià(
»s
 != 0)

1870 
out_”r_d‘ach_tgt
;

1872 
out
:

1873 
	`TRACE_EXIT_RES
(
»s
);

1874  
»s
;

1876 
out_”r_d‘ach_tgt
:

1877 ià(
hªdËr
 && hªdËr->
d‘ach_tgt
) {

1878 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
©ched_tgt_devs
,

1879 
exŒa_tgt_dev_li¡_’Œy
) {

1880 
	`TRACE_DBG
("Calling handler's detach_tgt(%p)",

1881 
tgt_dev
);

1882 
hªdËr
->
	`d‘ach_tgt
(
tgt_dev
);

1883 
	`TRACE_DBG
("%s", "Handler's detach_tgt()„eturned");

1887 
out_”r_»move_sysfs
:

1888 
	`sc¡_devt_dev_sysfs_d–
(
dev
);

1890 
out_d‘ach
:

1891 ià(
hªdËr
 && hªdËr->
d‘ach
) {

1892 
	`TRACE_DBG
("%s", "Calling handler's detach()");

1893 
hªdËr
->
	`d‘ach
(
dev
);

1894 
	`TRACE_DBG
("%s", "Handler's detach()„eturned");

1897 
dev
->
hªdËr
 = &
sc¡_nuÎ_devty³
;

1898 
dev
->
th»ads_num
 = 
sc¡_nuÎ_devty³
.threads_num;

1899 
dev
->
th»ads_poÞ_ty³
 = 
sc¡_nuÎ_devty³
.threads_pool_type;

1900 
out
;

1901 
	}
}

1908 
	$sc¡_š™_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
)

1910 
	`TRACE_ENTRY
();

1912 
	`¥š_lock_š™
(&
cmd_th»ads
->
cmd_li¡_lock
);

1913 
	`INIT_LIST_HEAD
(&
cmd_th»ads
->
aùive_cmd_li¡
);

1914 
	`š™_wa™queue_h—d
(&
cmd_th»ads
->
cmd_li¡_wa™Q
);

1915 
	`INIT_LIST_HEAD
(&
cmd_th»ads
->
th»ads_li¡
);

1916 
	`mu‹x_š™
(&
cmd_th»ads
->
io_cÚ‹xt_mu‹x
);

1918 
	`mu‹x_lock
(&
sc¡_su¥’d_mu‹x
);

1919 
	`li¡_add_ž
(&
cmd_th»ads
->
li¡s_li¡_’Œy
,

1920 &
sc¡_cmd_th»ads_li¡
);

1921 
	`mu‹x_uÆock
(&
sc¡_su¥’d_mu‹x
);

1923 
	`TRACE_EXIT
();

1925 
	}
}

1926 
EXPORT_SYMBOL_GPL
(
sc¡_š™_th»ads
);

1933 
	$sc¡_deš™_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
)

1935 
	`TRACE_ENTRY
();

1937 
	`mu‹x_lock
(&
sc¡_su¥’d_mu‹x
);

1938 
	`li¡_d–
(&
cmd_th»ads
->
li¡s_li¡_’Œy
);

1939 
	`mu‹x_uÆock
(&
sc¡_su¥’d_mu‹x
);

1941 
	`sBUG_ON
(
cmd_th»ads
->
io_cÚ‹xt
);

1943 
	`TRACE_EXIT
();

1945 
	}
}

1946 
EXPORT_SYMBOL_GPL
(
sc¡_deš™_th»ads
);

1948 
	$sc¡_¡Ý_glob®_th»ads
()

1950 
	`TRACE_ENTRY
();

1952 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1954 
	`sc¡_d–_th»ads
(&
sc¡_maš_cmd_th»ads
, -1);

1956 ià(
sc¡_mgmt_cmd_th»ad
)

1957 
	`kth»ad_¡Ý
(
sc¡_mgmt_cmd_th»ad
);

1958 ià(
sc¡_mgmt_th»ad
)

1959 
	`kth»ad_¡Ý
(
sc¡_mgmt_th»ad
);

1960 ià(
sc¡_š™_cmd_th»ad
)

1961 
	`kth»ad_¡Ý
(
sc¡_š™_cmd_th»ad
);

1963 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1965 
	`TRACE_EXIT
();

1967 
	}
}

1970 
	$sc¡_¡¬t_glob®_th»ads
(
num
)

1972 
»s
;

1974 
	`TRACE_ENTRY
();

1976 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1978 
»s
 = 
	`sc¡_add_th»ads
(&
sc¡_maš_cmd_th»ads
, 
NULL
, NULL, 
num
);

1979 ià(
»s
 < 0)

1980 
out_uÆock
;

1982 
sc¡_š™_cmd_th»ad
 = 
	`kth»ad_run
(
sc¡_š™_th»ad
,

1983 
NULL
, "scst_initd");

1984 ià(
	`IS_ERR
(
sc¡_š™_cmd_th»ad
)) {

1985 
»s
 = 
	`PTR_ERR
(
sc¡_š™_cmd_th»ad
);

1986 
	`PRINT_ERROR
("kth»ad_ü—‹(èfÜ in™ cmd fažed: %d", 
»s
);

1987 
sc¡_š™_cmd_th»ad
 = 
NULL
;

1988 
out_uÆock
;

1991 
sc¡_mgmt_cmd_th»ad
 = 
	`kth»ad_run
(
sc¡_tm_th»ad
,

1992 
NULL
, "scsi_tm");

1993 ià(
	`IS_ERR
(
sc¡_mgmt_cmd_th»ad
)) {

1994 
»s
 = 
	`PTR_ERR
(
sc¡_mgmt_cmd_th»ad
);

1995 
	`PRINT_ERROR
("kth»ad_ü—‹(èfÜ TM fažed: %d", 
»s
);

1996 
sc¡_mgmt_cmd_th»ad
 = 
NULL
;

1997 
out_uÆock
;

2000 
sc¡_mgmt_th»ad
 = 
	`kth»ad_run
(
sc¡_glob®_mgmt_th»ad
,

2001 
NULL
, "scst_mgmtd");

2002 ià(
	`IS_ERR
(
sc¡_mgmt_th»ad
)) {

2003 
»s
 = 
	`PTR_ERR
(
sc¡_mgmt_th»ad
);

2004 
	`PRINT_ERROR
("kth»ad_ü—‹(èfÜ mgmˆçžed: %d", 
»s
);

2005 
sc¡_mgmt_th»ad
 = 
NULL
;

2006 
out_uÆock
;

2009 
out_uÆock
:

2010 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2012 
	`TRACE_EXIT_RES
(
»s
);

2013  
»s
;

2014 
	}
}

2016 #iâdeà
CONFIG_SCST_PROC


2023 
	$sc¡_g‘_£tup_id
()

2025  
sc¡_£tup_id
;

2026 
	}
}

2027 
EXPORT_SYMBOL_GPL
(
sc¡_g‘_£tup_id
);

2030 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26)

2031 
	$sc¡_add
(
þass_deviû
 *
cdev
, 
þass_š‹rçû
 *
štf
)

2033 
	$sc¡_add
(
deviû
 *
cdev
, 
þass_š‹rçû
 *
štf
)

2036 
scsi_deviû
 *
scsidp
;

2037 
»s
 = 0;

2039 
	`TRACE_ENTRY
();

2041 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 26)

2042 
scsidp
 = 
	`to_scsi_deviû
(
cdev
->
dev
);

2044 
scsidp
 = 
	`to_scsi_deviû
(
cdev
->
·»Á
);

2047 ià((
scsidp
->
ho¡
->
ho¡t
->
Çme
 =ð
NULL
) ||

2048 (
	`¡rcmp
(
scsidp
->
ho¡
->
ho¡t
->
Çme
, 
SCST_LOCAL_NAME
) != 0))

2049 
»s
 = 
	`sc¡_»gi¡”_deviû
(
scsidp
);

2051 
	`TRACE_EXIT
();

2052  
»s
;

2053 
	}
}

2055 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26)

2056 
	$sc¡_»move
(
þass_deviû
 *
cdev
, 
þass_š‹rçû
 *
štf
)

2058 
	$sc¡_»move
(
deviû
 *
cdev
, 
þass_š‹rçû
 *
štf
)

2061 
scsi_deviû
 *
scsidp
;

2063 
	`TRACE_ENTRY
();

2065 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 26)

2066 
scsidp
 = 
	`to_scsi_deviû
(
cdev
->
dev
);

2068 
scsidp
 = 
	`to_scsi_deviû
(
cdev
->
·»Á
);

2071 ià((
scsidp
->
ho¡
->
ho¡t
->
Çme
 =ð
NULL
) ||

2072 (
	`¡rcmp
(
scsidp
->
ho¡
->
ho¡t
->
Çme
, 
SCST_LOCAL_NAME
) != 0))

2073 
	`sc¡_uÄegi¡”_deviû
(
scsidp
);

2075 
	`TRACE_EXIT
();

2077 
	}
}

2079 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26)

2080 
þass_š‹rçû
 
	gsc¡_š‹rçû
 = {

2081 .
add
 = 
sc¡_add
,

2082 .
	g»move
 = 
sc¡_»move
,

2085 
þass_š‹rçû
 
	gsc¡_š‹rçû
 = {

2086 .
add_dev
 = 
sc¡_add
,

2087 .
	g»move_dev
 = 
sc¡_»move
,

2091 
__š™
 
	$sc¡_´št_cÚfig
()

2093 
buf
[128];

2094 
i
, 
j
;

2096 
i
 = 
	`¢´štf
(
buf
, (buf), "Enabled features: ");

2097 
j
 = 
i
;

2099 #ifdeà
CONFIG_SCST_STRICT_SERIALIZING


2100 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "STRICT_SERIALIZING");

2103 #ifdeà
CONFIG_SCST_EXTRACHECKS


2104 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sEXTRACHECKS",

2105 (
j
 =ð
i
) ? "" : ", ");

2108 #ifdeà
CONFIG_SCST_TRACING


2109 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sTRACING",

2110 (
j
 =ð
i
) ? "" : ", ");

2113 #ifdeà
CONFIG_SCST_DEBUG


2114 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sDEBUG",

2115 (
j
 =ð
i
) ? "" : ", ");

2118 #ifdeà
CONFIG_SCST_DEBUG_TM


2119 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sDEBUG_TM",

2120 (
j
 =ð
i
) ? "" : ", ");

2123 #ifdeà
CONFIG_SCST_DEBUG_RETRY


2124 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sDEBUG_RETRY",

2125 (
j
 =ð
i
) ? "" : ", ");

2128 #ifdeà
CONFIG_SCST_DEBUG_OOM


2129 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sDEBUG_OOM",

2130 (
j
 =ð
i
) ? "" : ", ");

2133 #ifdeà
CONFIG_SCST_DEBUG_SN


2134 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sDEBUG_SN",

2135 (
j
 =ð
i
) ? "" : ", ");

2138 #ifdeà
CONFIG_SCST_USE_EXPECTED_VALUES


2139 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sUSE_EXPECTED_VALUES",

2140 (
j
 =ð
i
) ? "" : ", ");

2143 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


2144 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i,

2146 (
j
 =ð
i
) ? "" : ", ");

2149 #ifdeà
CONFIG_SCST_STRICT_SECURITY


2150 
i
 +ð
	`¢´štf
(&
buf
[i], (buf) - i, "%sSTRICT_SECURITY",

2151 (
j
 =ð
i
) ? "" : ", ");

2154 ià(
j
 !ð
i
)

2155 
	`PRINT_INFO
("%s", 
buf
);

2156 
	}
}

2158 
__š™
 
	$š™_sc¡
()

2160 
»s
, 
i
;

2161 
sc¡_num_ýus
;

2163 
	`TRACE_ENTRY
();

2166 
scsi_£n£_hdr
 *
shdr
;

2167 
sc¡_Üd”_d©a
 *
o
;

2168 
sc¡_cmd
 *
c
;

2169 
	`BUILD_BUG_ON
(
SCST_SENSE_BUFFERSIZE
 < (*
shdr
));

2170 
	`BUILD_BUG_ON
((
o
->
cu¼_¢
è!ð(o->
ex³ùed_¢
));

2171 
	`BUILD_BUG_ON
((
c
->
¢
è!ð(
o
->
ex³ùed_¢
));

2174 
	`mu‹x_š™
(&
sc¡_mu‹x
);

2175 
	`mu‹x_š™
(&
sc¡_mu‹x2
);

2176 
	`INIT_LIST_HEAD
(&
sc¡_‹m¶©e_li¡
);

2177 
	`INIT_LIST_HEAD
(&
sc¡_dev_li¡
);

2178 
	`INIT_LIST_HEAD
(&
sc¡_dev_ty³_li¡
);

2179 
	`INIT_LIST_HEAD
(&
sc¡_vœtu®_dev_ty³_li¡
);

2180 
	`¥š_lock_š™
(&
sc¡_maš_lock
);

2181 #ifdeà
CONFIG_SCST_PROC


2182 
	`INIT_LIST_HEAD
(&
sc¡_acg_li¡
);

2184 
	`¥š_lock_š™
(&
sc¡_š™_lock
);

2185 
	`š™_wa™queue_h—d
(&
sc¡_š™_cmd_li¡_wa™Q
);

2186 
	`INIT_LIST_HEAD
(&
sc¡_š™_cmd_li¡
);

2187 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

2188 
sc¡_Œaû_æag
 = 
SCST_DEFAULT_LOG_FLAGS
;

2190 
	`¥š_lock_š™
(&
sc¡_mcmd_lock
);

2191 
	`INIT_LIST_HEAD
(&
sc¡_aùive_mgmt_cmd_li¡
);

2192 
	`INIT_LIST_HEAD
(&
sc¡_d–ayed_mgmt_cmd_li¡
);

2193 
	`š™_wa™queue_h—d
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

2194 
	`š™_wa™queue_h—d
(&
sc¡_mgmt_wa™Q
);

2195 
	`¥š_lock_š™
(&
sc¡_mgmt_lock
);

2196 
	`INIT_LIST_HEAD
(&
sc¡_£ss_š™_li¡
);

2197 
	`INIT_LIST_HEAD
(&
sc¡_£ss_shut_li¡
);

2198 
	`š™_wa™queue_h—d
(&
sc¡_dev_cmd_wa™Q
);

2199 
	`mu‹x_š™
(&
sc¡_su¥’d_mu‹x
);

2200 
	`INIT_LIST_HEAD
(&
sc¡_cmd_th»ads_li¡
);

2201 
	`ýus_£Î
(
deçuÉ_ýu_mask
);

2203 
	`sc¡_š™_th»ads
(&
sc¡_maš_cmd_th»ads
);

2205 
»s
 = 
	`sc¡_lib_š™
();

2206 ià(
»s
 != 0)

2207 
out_deš™_th»ads
;

2209 
sc¡_num_ýus
 = 
	`num_Úlše_ýus
();

2213 ià(
sc¡_th»ads
 == 0)

2214 
sc¡_th»ads
 = 
sc¡_num_ýus
;

2216 ià(
sc¡_th»ads
 < 1) {

2217 
	`PRINT_ERROR
("%s", "scst_threads can‚ot be†esshan 1");

2218 
sc¡_th»ads
 = 
sc¡_num_ýus
;

2221 
	#INIT_CACHEP
(
p
, 
s
, 
o
) do { \

2222 
p
 = 
	`KMEM_CACHE
(
s
, 
SCST_SLAB_FLAGS
); \

2223 
	`TRACE_MEM
("SÏb c»©e: % © %°siz%zd", #s, 
p
, \

2224 (
s
)); \

2225 ià(
p
 =ð
NULL
) { \

2226 
»s
 = -
ENOMEM
; \

2227 
o
; \

2229 } 0)

	)

2231 
	`INIT_CACHEP
(
sc¡_mgmt_ÿch•
, 
sc¡_mgmt_cmd
, 
out_lib_ex™
);

2232 
	`INIT_CACHEP
(
sc¡_mgmt_¡ub_ÿch•
, 
sc¡_mgmt_cmd_¡ub
,

2233 
out_de¡roy_mgmt_ÿche
);

2234 
	`INIT_CACHEP
(
sc¡_ua_ÿch•
, 
sc¡_tgt_dev_UA
,

2235 
out_de¡roy_mgmt_¡ub_ÿche
);

2237 
	ssc¡_£n£
 { 
ušt8_t
 
s
[
SCST_SENSE_BUFFERSIZE
]; };

2238 
	`INIT_CACHEP
(
sc¡_£n£_ÿch•
, 
sc¡_£n£
,

2239 
out_de¡roy_ua_ÿche
);

2241 
	`INIT_CACHEP
(
sc¡_«n_ÿch•
, 
sc¡_«n
, 
out_de¡roy_£n£_ÿche
);

2242 
	`INIT_CACHEP
(
sc¡_cmd_ÿch•
, 
sc¡_cmd
, 
out_de¡roy_«n_ÿche
);

2243 
	`INIT_CACHEP
(
sc¡_£ss_ÿch•
, 
sc¡_£ssiÚ
, 
out_de¡roy_cmd_ÿche
);

2244 
	`INIT_CACHEP
(
sc¡_tgtd_ÿch•
, 
sc¡_tgt_dev
, 
out_de¡roy_£ss_ÿche
);

2245 
	`INIT_CACHEP
(
sc¡_acgd_ÿch•
, 
sc¡_acg_dev
, 
out_de¡roy_tgt_ÿche
);

2247 
sc¡_mgmt_mempoÞ
 = 
	`mempoÞ_ü—‹
(64, 
mempoÞ_®loc_¦ab
,

2248 
mempoÞ_ä“_¦ab
, 
sc¡_mgmt_ÿch•
);

2249 ià(
sc¡_mgmt_mempoÞ
 =ð
NULL
) {

2250 
»s
 = -
ENOMEM
;

2251 
out_de¡roy_acg_ÿche
;

2259 
sc¡_mgmt_¡ub_mempoÞ
 = 
	`mempoÞ_ü—‹
(1024, 
mempoÞ_®loc_¦ab
,

2260 
mempoÞ_ä“_¦ab
, 
sc¡_mgmt_¡ub_ÿch•
);

2261 ià(
sc¡_mgmt_¡ub_mempoÞ
 =ð
NULL
) {

2262 
»s
 = -
ENOMEM
;

2263 
out_de¡roy_mgmt_mempoÞ
;

2266 
sc¡_ua_mempoÞ
 = 
	`mempoÞ_ü—‹
(512, 
mempoÞ_®loc_¦ab
,

2267 
mempoÞ_ä“_¦ab
, 
sc¡_ua_ÿch•
);

2268 ià(
sc¡_ua_mempoÞ
 =ð
NULL
) {

2269 
»s
 = -
ENOMEM
;

2270 
out_de¡roy_mgmt_¡ub_mempoÞ
;

2273 
sc¡_£n£_mempoÞ
 = 
	`mempoÞ_ü—‹
(1024, 
mempoÞ_®loc_¦ab
,

2274 
mempoÞ_ä“_¦ab
, 
sc¡_£n£_ÿch•
);

2275 ià(
sc¡_£n£_mempoÞ
 =ð
NULL
) {

2276 
»s
 = -
ENOMEM
;

2277 
out_de¡roy_ua_mempoÞ
;

2280 
sc¡_«n_mempoÞ
 = 
	`mempoÞ_ü—‹
(100, 
mempoÞ_®loc_¦ab
,

2281 
mempoÞ_ä“_¦ab
, 
sc¡_«n_ÿch•
);

2282 ià(
sc¡_«n_mempoÞ
 =ð
NULL
) {

2283 
»s
 = -
ENOMEM
;

2284 
out_de¡roy_£n£_mempoÞ
;

2287 
»s
 = 
	`sc¡_sysfs_š™
();

2288 ià(
»s
 != 0)

2289 
out_de¡roy_«n_mempoÞ
;

2291 
	`sc¡_tg_š™
();

2293 ià(
sc¡_max_cmd_mem
 == 0) {

2294 
sysšfo
 
si
;

2295 
	`si_memšfo
(&
si
);

2296 #ià
BITS_PER_LONG
 == 32

2297 
sc¡_max_cmd_mem
 = 
	`mš
(

2298 (((
ušt64_t
)(
si
.
tÙ®¿m
 - si.
tÙ®high
è<< 
PAGE_SHIFT
)

2299 >> 20è>> 2, (
ušt64_t
)1 << 30);

2301 
sc¡_max_cmd_mem
 = (((
si
.
tÙ®¿m
 - si.
tÙ®high
è<< 
PAGE_SHIFT
)

2306 ià(
sc¡_max_dev_cmd_mem
 != 0) {

2307 ià(
sc¡_max_dev_cmd_mem
 > 
sc¡_max_cmd_mem
) {

2308 
	`PRINT_ERROR
("scst_max_dev_cmd_mem (%d) > "

2310 
sc¡_max_dev_cmd_mem
,

2311 
sc¡_max_cmd_mem
);

2312 
sc¡_max_dev_cmd_mem
 = 
sc¡_max_cmd_mem
;

2315 
sc¡_max_dev_cmd_mem
 = 
sc¡_max_cmd_mem
 * 2 / 5;

2317 
»s
 = 
	`sc¡_sgv_poÞs_š™
(

2318 ((
ušt64_t
)
sc¡_max_cmd_mem
 << 10è>> (
PAGE_SHIFT
 - 10), 0);

2319 ià(
»s
 != 0)

2320 
out_sysfs_þ—nup
;

2322 #ifdeà
CONFIG_SCST_PROC


2323 
sc¡_deçuÉ_acg
 = 
	`sc¡_®loc_add_acg
(
NULL
, 
SCST_DEFAULT_ACG_NAME
, 
çl£
);

2324 ià(
sc¡_deçuÉ_acg
 =ð
NULL
) {

2325 
»s
 = -
ENOMEM
;

2326 
out_de¡roy_sgv_poÞ
;

2330 
»s
 = 
	`scsi_»gi¡”_š‹rçû
(&
sc¡_š‹rçû
);

2331 ià(
»s
 != 0)

2332 #ifdeà
CONFIG_SCST_PROC


2333 
out_ä“_acg
;

2335 
out_de¡roy_sgv_poÞ
;

2338 
i
 = 0; i < ()
	`ARRAY_SIZE
(
sc¡_³rýu_šfos
); i++) {

2339 
	`©omic_£t
(&
sc¡_³rýu_šfos
[
i
].
ýu_cmd_couÁ
, 0);

2340 
	`¥š_lock_š™
(&
sc¡_³rýu_šfos
[
i
].
skËt_lock
);

2341 
	`INIT_LIST_HEAD
(&
sc¡_³rýu_šfos
[
i
].
skËt_cmd_li¡
);

2342 
	`skËt_š™
(&
sc¡_³rýu_šfos
[
i
].
skËt
,

2343 (*)
sc¡_cmd_skËt
,

2344 ()&
sc¡_³rýu_šfos
[
i
]);

2347 
	`TRACE_DBG
("%d CPU found, s¹šg %dh»ads", 
sc¡_num_ýus
,

2348 
sc¡_th»ads
);

2350 
»s
 = 
	`sc¡_¡¬t_glob®_th»ads
(
sc¡_th»ads
);

2351 ià(
»s
 < 0)

2352 
out_th»ad_ä“
;

2354 #ifdeà
CONFIG_SCST_PROC


2355 
»s
 = 
	`sc¡_´oc_š™_moduË
();

2356 ià(
»s
 != 0)

2357 
out_th»ad_ä“
;

2360 
	`PRINT_INFO
("SCST version %s†oaded successfully (max mem for "

2361 "commªd %dMB,…” deviû %dMB)", 
SCST_VERSION_STRING
,

2362 
sc¡_max_cmd_mem
, 
sc¡_max_dev_cmd_mem
);

2364 
	`sc¡_´št_cÚfig
();

2366 
out
:

2367 
	`TRACE_EXIT_RES
(
»s
);

2368  
»s
;

2370 
out_th»ad_ä“
:

2371 
	`sc¡_¡Ý_glob®_th»ads
();

2373 
	`scsi_uÄegi¡”_š‹rçû
(&
sc¡_š‹rçû
);

2375 #ifdeà
CONFIG_SCST_PROC


2376 
out_ä“_acg
:

2377 
	`sc¡_d–_ä“_acg
(
sc¡_deçuÉ_acg
);

2380 
out_de¡roy_sgv_poÞ
:

2381 
	`sc¡_sgv_poÞs_deš™
();

2382 
	`sc¡_tg_þ—nup
();

2384 
out_sysfs_þ—nup
:

2385 
	`sc¡_sysfs_þ—nup
();

2387 
out_de¡roy_«n_mempoÞ
:

2388 
	`mempoÞ_de¡roy
(
sc¡_«n_mempoÞ
);

2390 
out_de¡roy_£n£_mempoÞ
:

2391 
	`mempoÞ_de¡roy
(
sc¡_£n£_mempoÞ
);

2393 
out_de¡roy_ua_mempoÞ
:

2394 
	`mempoÞ_de¡roy
(
sc¡_ua_mempoÞ
);

2396 
out_de¡roy_mgmt_¡ub_mempoÞ
:

2397 
	`mempoÞ_de¡roy
(
sc¡_mgmt_¡ub_mempoÞ
);

2399 
out_de¡roy_mgmt_mempoÞ
:

2400 
	`mempoÞ_de¡roy
(
sc¡_mgmt_mempoÞ
);

2402 
out_de¡roy_acg_ÿche
:

2403 
	`kmem_ÿche_de¡roy
(
sc¡_acgd_ÿch•
);

2405 
out_de¡roy_tgt_ÿche
:

2406 
	`kmem_ÿche_de¡roy
(
sc¡_tgtd_ÿch•
);

2408 
out_de¡roy_£ss_ÿche
:

2409 
	`kmem_ÿche_de¡roy
(
sc¡_£ss_ÿch•
);

2411 
out_de¡roy_cmd_ÿche
:

2412 
	`kmem_ÿche_de¡roy
(
sc¡_cmd_ÿch•
);

2414 
out_de¡roy_«n_ÿche
:

2415 
	`kmem_ÿche_de¡roy
(
sc¡_«n_ÿch•
);

2417 
out_de¡roy_£n£_ÿche
:

2418 
	`kmem_ÿche_de¡roy
(
sc¡_£n£_ÿch•
);

2420 
out_de¡roy_ua_ÿche
:

2421 
	`kmem_ÿche_de¡roy
(
sc¡_ua_ÿch•
);

2423 
out_de¡roy_mgmt_¡ub_ÿche
:

2424 
	`kmem_ÿche_de¡roy
(
sc¡_mgmt_¡ub_ÿch•
);

2426 
out_de¡roy_mgmt_ÿche
:

2427 
	`kmem_ÿche_de¡roy
(
sc¡_mgmt_ÿch•
);

2429 
out_lib_ex™
:

2430 
	`sc¡_lib_ex™
();

2432 
out_deš™_th»ads
:

2433 
	`sc¡_deš™_th»ads
(&
sc¡_maš_cmd_th»ads
);

2434 
out
;

2435 
	}
}

2437 
__ex™
 
	$ex™_sc¡
()

2439 
	`TRACE_ENTRY
();

2443 #ifdeà
CONFIG_SCST_PROC


2444 
	`sc¡_´oc_þ—nup_moduË
();

2447 
	`sc¡_¡Ý_glob®_th»ads
();

2449 
	`sc¡_deš™_th»ads
(&
sc¡_maš_cmd_th»ads
);

2451 
	`scsi_uÄegi¡”_š‹rçû
(&
sc¡_š‹rçû
);

2452 #ifdeà
CONFIG_SCST_PROC


2453 
	`sc¡_d–_ä“_acg
(
sc¡_deçuÉ_acg
);

2456 
	`sc¡_sgv_poÞs_deš™
();

2458 
	`sc¡_tg_þ—nup
();

2460 
	`sc¡_sysfs_þ—nup
();

2462 
	#DEINIT_CACHEP
(
p
) do { \

2463 
	`kmem_ÿche_de¡roy
(
p
); \

2464 
p
 = 
NULL
; \

2465 } 0)

	)

2467 
	`mempoÞ_de¡roy
(
sc¡_mgmt_mempoÞ
);

2468 
	`mempoÞ_de¡roy
(
sc¡_mgmt_¡ub_mempoÞ
);

2469 
	`mempoÞ_de¡roy
(
sc¡_ua_mempoÞ
);

2470 
	`mempoÞ_de¡roy
(
sc¡_£n£_mempoÞ
);

2471 
	`mempoÞ_de¡roy
(
sc¡_«n_mempoÞ
);

2473 
	`DEINIT_CACHEP
(
sc¡_mgmt_ÿch•
);

2474 
	`DEINIT_CACHEP
(
sc¡_mgmt_¡ub_ÿch•
);

2475 
	`DEINIT_CACHEP
(
sc¡_ua_ÿch•
);

2476 
	`DEINIT_CACHEP
(
sc¡_£n£_ÿch•
);

2477 
	`DEINIT_CACHEP
(
sc¡_«n_ÿch•
);

2478 
	`DEINIT_CACHEP
(
sc¡_cmd_ÿch•
);

2479 
	`DEINIT_CACHEP
(
sc¡_£ss_ÿch•
);

2480 
	`DEINIT_CACHEP
(
sc¡_tgtd_ÿch•
);

2481 
	`DEINIT_CACHEP
(
sc¡_acgd_ÿch•
);

2483 
	`sc¡_lib_ex™
();

2485 
	`PRINT_INFO
("%s", "SCST unloaded");

2487 
	`TRACE_EXIT
();

2489 
	}
}

2491 
moduË_š™
(
š™_sc¡
);

2492 
moduË_ex™
(
ex™_sc¡
);

2494 
MODULE_AUTHOR
("Vladislav Bolkhovitin");

2495 
MODULE_LICENSE
("GPL");

2496 
MODULE_DESCRIPTION
("SCSIarget core");

2497 
MODULE_VERSION
(
SCST_VERSION_STRING
);

	@/root/Desktop/scst-2.2.0/src/scst_mem.c

19 
	~<lšux/š™.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/li¡.h
>

23 
	~<lšux/¥šlock.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/sched.h
>

26 
	~<lšux/mm.h
>

27 
	~<lšux/uni¡d.h
>

28 
	~<lšux/¡ršg.h
>

30 #ifdeà
INSIDE_KERNEL_TREE


31 
	~<sc¡/sc¡.h
>

33 
	~"sc¡.h
"

35 
	~"sc¡_´iv.h
"

36 
	~"sc¡_mem.h
"

38 
	#SGV_DEFAULT_PURGE_INTERVAL
 (60 * 
HZ
)

	)

39 
	#SGV_MIN_SHRINK_INTERVAL
 (1 * 
HZ
)

	)

42 
	#MAX_PAGES_PER_POOL
 50

	)

44 
sgv_poÞ
 *
	gsgv_nÜm_þu¡_poÞ
, *
	gsgv_nÜm_poÞ
, *
	gsgv_dma_poÞ
;

46 
©omic_t
 
	gsgv_·ges_tÙ®
 = 
ATOMIC_INIT
(0);

49 
	gsgv_hi_wmk
;

50 
	gsgv_lo_wmk
;

52 
	gsgv_max_loÿl_·ges
, 
	gsgv_max_Œªs_·ges
;

54 
DEFINE_SPINLOCK
(
sgv_poÞs_lock
);

55 
DEFINE_MUTEX
(
sgv_poÞs_mu‹x
);

58 
sgv_poÞ
 *
	gsgv_cur_purge_poÞ
;

59 
LIST_HEAD
(
sgv_aùive_poÞs_li¡
);

61 
©omic_t
 
	gsgv_»Ëa£s_Ú_hiwmk
 = 
ATOMIC_INIT
(0);

62 
©omic_t
 
	gsgv_»Ëa£s_Ú_hiwmk_çžed
 = 
ATOMIC_INIT
(0);

64 
©omic_t
 
	gsgv_Ùh”_tÙ®_®loc
 = 
ATOMIC_INIT
(0);

66 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 23))

67 
shršk”
 *
	gsgv_shršk”
;

69 
shršk”
 
	gsgv_shršk”
;

76 
LIST_HEAD
(
sgv_poÞs_li¡
);

78 #iâdeà
CONFIG_SCST_PROC


79 
kobjeù
 *
	gsc¡_sgv_kobj
;

80 
sc¡_sgv_sysfs_ü—‹
(
sgv_poÞ
 *
poÞ
);

81 
sc¡_sgv_sysfs_d–
(
sgv_poÞ
 *
poÞ
);

84 
šlše
 
boÞ
 
	$sgv_poÞ_þu¡”ed
(cÚ¡ 
sgv_poÞ
 *
poÞ
)

86  
poÞ
->
þu¡”šg_ty³
 !ð
sgv_no_þu¡”šg
;

87 
	}
}

89 
	$sc¡_sgv_poÞ_u£_nÜm
(
sc¡_tgt_dev
 *
tgt_dev
)

91 
tgt_dev
->
gå_mask
 = 
__GFP_NOWARN
;

92 
tgt_dev
->
poÞ
 = 
sgv_nÜm_poÞ
;

93 
	`þ—r_b™
(
SCST_TGT_DEV_CLUST_POOL
, &
tgt_dev
->
tgt_dev_æags
);

94 
	}
}

96 
	$sc¡_sgv_poÞ_u£_nÜm_þu¡
(
sc¡_tgt_dev
 *
tgt_dev
)

98 
	`TRACE_MEM
("%s", "Use clustering");

99 
tgt_dev
->
gå_mask
 = 
__GFP_NOWARN
;

100 
tgt_dev
->
poÞ
 = 
sgv_nÜm_þu¡_poÞ
;

101 
	`£t_b™
(
SCST_TGT_DEV_CLUST_POOL
, &
tgt_dev
->
tgt_dev_æags
);

102 
	}
}

104 
	$sc¡_sgv_poÞ_u£_dma
(
sc¡_tgt_dev
 *
tgt_dev
)

106 
	`TRACE_MEM
("%s", "Use ISA DMA memory");

107 
tgt_dev
->
gå_mask
 = 
__GFP_NOWARN
 | 
GFP_DMA
;

108 
tgt_dev
->
poÞ
 = 
sgv_dma_poÞ
;

109 
	`þ—r_b™
(
SCST_TGT_DEV_CLUST_POOL
, &
tgt_dev
->
tgt_dev_æags
);

110 
	}
}

113 
	$sgv_dtÜ_ªd_ä“
(
sgv_poÞ_obj
 *
obj
)

115 
sgv_poÞ
 *
poÞ
 = 
obj
->
owÃr_poÞ
;

117 
	`TRACE_MEM
("De¡royšg sgv obj %p", 
obj
);

119 ià(
obj
->
sg_couÁ
 != 0) {

120 
poÞ
->
®loc_âs
.
	`ä“_·ges_â
(
obj
->
sg_’Œ›s
,

121 
obj
->
sg_couÁ
, obj->
®loÿtÜ_´iv
);

123 ià(
obj
->
sg_’Œ›s
 !ðobj->
sg_’Œ›s_d©a
) {

124 ià(
obj
->
Œªs_tbl
 !=

125 (
Œªs_tbl_’t
 *)
obj
->
sg_’Œ›s_d©a
) {

127 
	`kä“
(
obj
->
Œªs_tbl
);

128 
obj
->
Œªs_tbl
 = 
NULL
;

130 
	`kä“
(
obj
->
sg_’Œ›s
);

133 
	`kmem_ÿche_ä“
(
poÞ
->
ÿches
[
obj
->
ÿche_num
], obj);

135 
	}
}

138 
šlše
 
	$sgv_d–_äom_aùive
(
sgv_poÞ
 *
poÞ
)

140 
li¡_h—d
 *
Ãxt
;

142 
	`TRACE_MEM
("D–‘šg sgv…oÞ %°äomhaùivli¡", 
poÞ
);

144 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

146 
Ãxt
 = 
poÞ
->
sgv_aùive_poÞs_li¡_’Œy
.next;

147 
	`li¡_d–
(&
poÞ
->
sgv_aùive_poÞs_li¡_’Œy
);

149 ià(
sgv_cur_purge_poÞ
 =ð
poÞ
) {

150 
	`TRACE_MEM
("Sgv…oÞ %°i sgv cu¸purgpoÞ", 
poÞ
);

152 ià(
Ãxt
 =ð&
sgv_aùive_poÞs_li¡
)

153 
Ãxt
 =‚ext->next;

155 ià(
Ãxt
 =ð&
sgv_aùive_poÞs_li¡
) {

156 
sgv_cur_purge_poÞ
 = 
NULL
;

157 
	`TRACE_MEM
("%s", "Sgv‡ctive†ist‚owƒmpty");

159 
sgv_cur_purge_poÞ
 = 
	`li¡_’Œy
(
Ãxt
, 
	`ty³of
(*
poÞ
),

160 
sgv_aùive_poÞs_li¡_’Œy
);

161 
	`TRACE_MEM
("New sgv cur…urge…ool %p",

162 
sgv_cur_purge_poÞ
);

166 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

168 
	}
}

171 
	$sgv_dec_ÿched_’Œ›s
(
sgv_poÞ
 *
poÞ
, 
·ges
)

173 
poÞ
->
ÿched_’Œ›s
--;

174 
poÞ
->
ÿched_·ges
 -ð
·ges
;

176 ià(
poÞ
->
ÿched_’Œ›s
 == 0)

177 
	`sgv_d–_äom_aùive
(
poÞ
);

180 
	}
}

183 
	$__sgv_purge_äom_ÿche
(
sgv_poÞ_obj
 *
obj
)

185 
·ges
 = 
obj
->pages;

186 
sgv_poÞ
 *
poÞ
 = 
obj
->
owÃr_poÞ
;

188 
	`TRACE_MEM
("Purging sgv obj %p from…ool %p (new cached_entries %d)",

189 
obj
, 
poÞ
,…oÞ->
ÿched_’Œ›s
-1);

191 
	`li¡_d–
(&
obj
->
sÜ‹d_»cyþšg_li¡_’Œy
);

192 
	`li¡_d–
(&
obj
->
»cyþšg_li¡_’Œy
);

194 
poÞ
->
šaùive_ÿched_·ges
 -ð
·ges
;

195 
	`sgv_dec_ÿched_’Œ›s
(
poÞ
, 
·ges
);

197 
	`©omic_sub
(
·ges
, &
sgv_·ges_tÙ®
);

200 
	}
}

203 
boÞ
 
	$sgv_purge_äom_ÿche
(
sgv_poÞ_obj
 *
obj
, 
mš_š‹rv®
,

204 
cur_time
)

206 
	`EXTRACHECKS_BUG_ON
(
mš_š‹rv®
 < 0);

208 
	`TRACE_MEM
("Checking if sgv obj %p should be…urged (curime %ld, "

209 "objim%ld,imtØpurg%ld)", 
obj
, 
cur_time
,

210 
obj
->
time_¡amp
, obj->time_¡am°+ 
mš_š‹rv®
);

212 ià(
	`time_aá”_eq
(
cur_time
, (
obj
->
time_¡amp
 + 
mš_š‹rv®
))) {

213 
	`__sgv_purge_äom_ÿche
(
obj
);

214  
Œue
;

216  
çl£
;

217 
	}
}

220 
	$sgv_shršk_poÞ
(
sgv_poÞ
 *
poÞ
, 
Ä
, 
mš_š‹rv®
,

221 
cur_time
)

223 
ä“d
 = 0;

225 
	`TRACE_ENTRY
();

227 
	`TRACE_MEM
("Tryingo shrink…ool %p (nr %d, min_interval %d)",

228 
poÞ
, 
Ä
, 
mš_š‹rv®
);

230 ià(
poÞ
->
purge_š‹rv®
 < 0) {

231 
	`TRACE_MEM
("NÙ shrškabË…oÞ %p, skpšg", 
poÞ
);

232 
out
;

235 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

237 !
	`li¡_em±y
(&
poÞ
->
sÜ‹d_»cyþšg_li¡
) &&

238 (
	`©omic_»ad
(&
sgv_·ges_tÙ®
è> 
sgv_lo_wmk
)) {

239 
sgv_poÞ_obj
 *
obj
 = 
	`li¡_’Œy
(

240 
poÞ
->
sÜ‹d_»cyþšg_li¡
.
Ãxt
,

241 
sgv_poÞ_obj
, 
sÜ‹d_»cyþšg_li¡_’Œy
);

243 ià(
	`sgv_purge_äom_ÿche
(
obj
, 
mš_š‹rv®
, 
cur_time
)) {

244 
·ges
 = 
obj
->pages;

246 
ä“d
 +ð
·ges
;

247 
Ä
 -ð
·ges
;

249 
	`TRACE_MEM
("%d…ages…urged from…ool %p (nr†eft %d, "

250 "tÙ® f»ed %d)", 
·ges
, 
poÞ
, 
Ä
, 
ä“d
);

252 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

253 
	`sgv_dtÜ_ªd_ä“
(
obj
);

254 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

258 ià((
Ä
 <ð0è|| (
ä“d
 >ð
MAX_PAGES_PER_POOL
)) {

259 ià(
ä“d
 >ð
MAX_PAGES_PER_POOL
)

260 
	`TRACE_MEM
("%d…ages…urged from…ool %p, "

261 "Ëavšg", 
ä“d
, 
poÞ
);

266 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

268 
out
:

269 
	`TRACE_EXIT_RES
(
Ä
);

270  
Ä
;

271 
	}
}

274 
	$__sgv_shršk
(
Ä
, 
mš_š‹rv®
)

276 
sgv_poÞ
 *
poÞ
;

277 
cur_time
 = 
jiff›s
;

278 
´ev_Ä
 = 
Ä
;

279 
boÞ
 
cœþe
 = 
çl£
;

281 
	`TRACE_ENTRY
();

283 
	`TRACE_MEM
("Tryingo shrink %d…ages from‡ll sgv…ools "

284 "(mš_š‹rv® %d)", 
Ä
, 
mš_š‹rv®
);

286 
Ä
 > 0) {

287 
li¡_h—d
 *
Ãxt
;

289 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

291 
poÞ
 = 
sgv_cur_purge_poÞ
;

292 ià(
poÞ
 =ð
NULL
) {

293 ià(
	`li¡_em±y
(&
sgv_aùive_poÞs_li¡
)) {

294 
	`TRACE_MEM
("%s", "Active…ools†ist isƒmpty");

295 
out_uÆock
;

298 
poÞ
 = 
	`li¡_’Œy
(
sgv_aùive_poÞs_li¡
.
Ãxt
,

299 
	`ty³of
(*
poÞ
),

300 
sgv_aùive_poÞs_li¡_’Œy
);

302 
	`sgv_poÞ_g‘
(
poÞ
);

304 
Ãxt
 = 
poÞ
->
sgv_aùive_poÞs_li¡_’Œy
.next;

305 ià(
Ãxt
 =ð&
sgv_aùive_poÞs_li¡
) {

306 ià(
cœþe
 && (
´ev_Ä
 =ð
Ä
)) {

307 
	`TRACE_MEM
("Full circle done, but‚o…rogress, "

308 "Ëavšg (Ä %d)", 
Ä
);

309 
out_uÆock_put
;

311 
cœþe
 = 
Œue
;

312 
´ev_Ä
 = 
Ä
;

314 
Ãxt
 =‚ext->next;

317 
sgv_cur_purge_poÞ
 = 
	`li¡_’Œy
(
Ãxt
, 
	`ty³of
(*
poÞ
),

318 
sgv_aùive_poÞs_li¡_’Œy
);

319 
	`TRACE_MEM
("New cu¸purgpoÞ %p", 
sgv_cur_purge_poÞ
);

321 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

323 
Ä
 = 
	`sgv_shršk_poÞ
(
poÞ
,‚r, 
mš_š‹rv®
, 
cur_time
);

325 
	`sgv_poÞ_put
(
poÞ
);

328 
out
:

329 
	`TRACE_EXIT_RES
(
Ä
);

330  
Ä
;

332 
out_uÆock
:

333 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

334 
out
;

336 
out_uÆock_put
:

337 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

338 
	`sgv_poÞ_put
(
poÞ
);

339 
out
;

340 
	}
}

342 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 35è&& (!
defšed
(
RHEL_MAJOR
) || RHEL_MAJOR -0 < 6)

343 
	$sgv_shršk
(
Ä
, 
gå_t
 
gåm
)

344 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 0, 0)

345 
	$sgv_shršk
(
shršk”
 *shršk”, 
Ä
, 
gå_t
 
gåm
)

347 
	$sgv_shršk
(
shršk”
 *shršk”, 
shršk_cÚŒÞ
 *
sc
)

350 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(3, 0, 0)

351 
Ä
 = 
sc
->
Ä_to_sÿn
;

354 
	`TRACE_ENTRY
();

356 ià(
Ä
 > 0) {

357 
Ä
 = 
	`__sgv_shršk
Òr, 
SGV_MIN_SHRINK_INTERVAL
);

358 
	`TRACE_MEM
("Leá %d", 
Ä
);

360 
sgv_poÞ
 *
poÞ
;

361 
šaùive_·ges
 = 0;

363 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

364 
	`li¡_fÜ_—ch_’Œy
(
poÞ
, &
sgv_aùive_poÞs_li¡
,

365 
sgv_aùive_poÞs_li¡_’Œy
) {

366 ià(
poÞ
->
purge_š‹rv®
 > 0)

367 
šaùive_·ges
 +ð
poÞ
->
šaùive_ÿched_·ges
;

369 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

371 
Ä
 = 
	`max
(()0, 
šaùive_·ges
 - 
sgv_lo_wmk
);

372 
	`TRACE_MEM
("Cª f»%d (tÙ® %d)", 
Ä
,

373 
	`©omic_»ad
(&
sgv_·ges_tÙ®
));

376 
	`TRACE_EXIT_RES
(
Ä
);

377  
Ä
;

378 
	}
}

380 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

381 
	$sgv_purge_wÜk_â
(*
p
)

383 
	$sgv_purge_wÜk_â
(
d–ayed_wÜk
 *
wÜk
)

386 
cur_time
 = 
jiff›s
;

387 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

388 
sgv_poÞ
 *
poÞ
 = (sgv_poÞ *)
p
;

390 
sgv_poÞ
 *
poÞ
 = 
	`cÚš”_of
(
wÜk
, sgv_pool,

391 
sgv_purge_wÜk
);

394 
	`TRACE_ENTRY
();

396 
	`TRACE_MEM
("PurgwÜk fÜ…oÞ %p", 
poÞ
);

398 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

400 
poÞ
->
purge_wÜk_scheduËd
 = 
çl£
;

402 !
	`li¡_em±y
(&
poÞ
->
sÜ‹d_»cyþšg_li¡
)) {

403 
sgv_poÞ_obj
 *
obj
 = 
	`li¡_’Œy
(

404 
poÞ
->
sÜ‹d_»cyþšg_li¡
.
Ãxt
,

405 
sgv_poÞ_obj
, 
sÜ‹d_»cyþšg_li¡_’Œy
);

407 ià(
	`sgv_purge_äom_ÿche
(
obj
, 
poÞ
->
purge_š‹rv®
, 
cur_time
)) {

408 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

409 
	`sgv_dtÜ_ªd_ä“
(
obj
);

410 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

417 
	`TRACE_MEM
("Rescheduling…urge work for…ool %p (delay "

418 "%d HZ/%d sec)", 
poÞ
,…oÞ->
purge_š‹rv®
,

419 
poÞ
->
purge_š‹rv®
/
HZ
);

420 
	`scheduË_d–ayed_wÜk
(&
poÞ
->
sgv_purge_wÜk
,

421 
poÞ
->
purge_š‹rv®
);

422 
poÞ
->
purge_wÜk_scheduËd
 = 
Œue
;

427 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

429 
	`TRACE_MEM
("L—všg…urgwÜk fÜ…oÞ %p", 
poÞ
);

431 
	`TRACE_EXIT
();

433 
	}
}

435 
	$sgv_check_fuÎ_þu¡”šg
(
sÿ‰”li¡
 *
sg
, 
cur
, 
hšt
)

437 
»s
 = -1;

438 
i
 = 
hšt
;

439 
pâ_cur
 = 
	`·ge_to_pâ
(
	`sg_·ge
(&
sg
[
cur
]));

440 
Ën_cur
 = 
sg
[
cur
].
Ëngth
;

441 
pâ_cur_Ãxt
 = 
pâ_cur
 + (
Ën_cur
 >> 
PAGE_SHIFT
);

442 
fuÎ_·ge_cur
 = (
Ën_cur
 & (
PAGE_SIZE
 - 1)) == 0;

443 
pâ
, 
pâ_Ãxt
;

444 
boÞ
 
fuÎ_·ge
;

447 
	`TRACE_MEM
("pfn_cur %ld,…fn_cur_next %ld,†en_cur %d, full_page_cur %d",

448 
pâ_cur
, 
pâ_cur_Ãxt
, 
Ën_cur
, 
fuÎ_·ge_cur
);

452 ià(
i
 >= 0) {

453 
pâ
 = 
	`·ge_to_pâ
(
	`sg_·ge
(&
sg
[
i
]));

454 
pâ_Ãxt
 = 
pâ
 + (
sg
[
i
].
Ëngth
 >> 
PAGE_SHIFT
);

455 
fuÎ_·ge
 = (
sg
[
i
].
Ëngth
 & (
PAGE_SIZE
 - 1)) == 0;

457 ià((
pâ
 =ð
pâ_cur_Ãxt
è&& 
fuÎ_·ge_cur
)

458 
out_h—d
;

460 ià((
pâ_Ãxt
 =ð
pâ_cur
è&& 
fuÎ_·ge
)

461 
out_ž
;

465 
i
 = 
cur
 - 1; i >= 0; i--) {

466 
pâ
 = 
	`·ge_to_pâ
(
	`sg_·ge
(&
sg
[
i
]));

467 
pâ_Ãxt
 = 
pâ
 + (
sg
[
i
].
Ëngth
 >> 
PAGE_SHIFT
);

468 
fuÎ_·ge
 = (
sg
[
i
].
Ëngth
 & (
PAGE_SIZE
 - 1)) == 0;

470 ià((
pâ
 =ð
pâ_cur_Ãxt
è&& 
fuÎ_·ge_cur
)

471 
out_h—d
;

473 ià((
pâ_Ãxt
 =ð
pâ_cur
è&& 
fuÎ_·ge
)

474 
out_ž
;

477 
out
:

478  
»s
;

480 
out_ž
:

481 
	`TRACE_MEM
("SG segm’ˆ%d wžÈbž m”ged w™h segm’ˆ%d", 
cur
, 
i
);

482 
sg
[
i
].
Ëngth
 +ð
Ën_cur
;

483 
	`sg_þ—r
(&
sg
[
cur
]);

484 
»s
 = 
i
;

485 
out
;

487 
out_h—d
:

488 
	`TRACE_MEM
("SG segm’ˆ%d wžÈbh—d m”ged w™h segm’ˆ%d", 
cur
, 
i
);

489 
	`sg_assign_·ge
(&
sg
[
i
], 
	`sg_·ge
(&sg[
cur
]));

490 
sg
[
i
].
Ëngth
 +ð
Ën_cur
;

491 
	`sg_þ—r
(&
sg
[
cur
]);

492 
»s
 = 
i
;

493 
out
;

494 
	}
}

496 
	$sgv_check_ž_þu¡”šg
(
sÿ‰”li¡
 *
sg
, 
cur
, 
hšt
)

498 
»s
 = -1;

499 
pâ_cur
 = 
	`·ge_to_pâ
(
	`sg_·ge
(&
sg
[
cur
]));

500 
Ën_cur
 = 
sg
[
cur
].
Ëngth
;

501 
´ev
;

502 
pâ_´ev
;

503 
boÞ
 
fuÎ_·ge
;

505 #ifdeà
SCST_HIGHMEM


506 ià(
·ge
 >ð
highmem_¡¬t_·ge
) {

507 
	`TRACE_MEM
("%s", "HIGHMEM…age‡llocated,‚o clustering")

508 
out
;

513 
	`TRACE_MEM
("pfn_cur %ld,…fn_cur_next %ld,†en_cur %d, full_page_cur %d",

514 
pâ_cur
, 
pâ_cur_Ãxt
, 
Ën_cur
, 
fuÎ_·ge_cur
);

517 ià(
cur
 == 0)

518 
out
;

520 
´ev
 = 
cur
 - 1;

521 
pâ_´ev
 = 
	`·ge_to_pâ
(
	`sg_·ge
(&
sg
[
´ev
])) +

522 (
sg
[
´ev
].
Ëngth
 >> 
PAGE_SHIFT
);

523 
fuÎ_·ge
 = (
sg
[
´ev
].
Ëngth
 & (
PAGE_SIZE
 - 1)) == 0;

525 ià((
pâ_´ev
 =ð
pâ_cur
è&& 
fuÎ_·ge
) {

526 
	`TRACE_MEM
("SG segment %d will beail merged with segment %d",

527 
cur
, 
´ev
);

528 
sg
[
´ev
].
Ëngth
 +ð
Ën_cur
;

529 
	`sg_þ—r
(&
sg
[
cur
]);

530 
»s
 = 
´ev
;

533 
out
:

534  
»s
;

535 
	}
}

537 
	$sgv_ä“_sys_sg_’Œ›s
(
sÿ‰”li¡
 *
sg
, 
sg_couÁ
,

538 *
´iv
)

540 
i
;

542 
	`TRACE_MEM
("sg=%p, sg_couÁ=%d", 
sg
, 
sg_couÁ
);

544 
i
 = 0; i < 
sg_couÁ
; i++) {

545 
·ge
 *
p
 = 
	`sg_·ge
(&
sg
[
i
]);

546 
Ën
 = 
sg
[
i
].
Ëngth
;

547 
·ges
 =

548 (
Ën
 >> 
PAGE_SHIFT
è+ (Ö’ & ~
PAGE_MASK
) != 0);

550 
	`TRACE_MEM
("page %lx,†en %d,…ages %d",

551 ()
p
, 
Ën
, 
·ges
);

553 
·ges
 > 0) {

554 
Üd”
 = 0;

556 
	`TRACE_MEM
("free_pages(): order %d,…age %lx",

557 
Üd”
, ()
p
);

559 
	`__ä“_·ges
(
p
, 
Üd”
);

561 
·ges
 -ð1 << 
Üd”
;

562 
p
 +ð1 << 
Üd”
;

565 
	}
}

567 
·ge
 *
	$sgv_®loc_sys_·ges
(
sÿ‰”li¡
 *
sg
,

568 
gå_t
 
gå_mask
, *
´iv
)

570 
·ge
 *·gð
	`®loc_·ges
(
gå_mask
, 0);

572 
	`sg_£t_·ge
(
sg
, 
·ge
, 
PAGE_SIZE
, 0);

573 
	`TRACE_MEM
("·ge=%p, sg=%p,…riv=%p", 
·ge
, 
sg
, 
´iv
);

574 ià(
·ge
 =ð
NULL
) {

575 
	`TRACE
(
TRACE_OUT_OF_MEM
, "%s", "Allocation of "

578  
·ge
;

579 
	}
}

581 
	$sgv_®loc_sg_’Œ›s
(
sÿ‰”li¡
 *
sg
, 
·ges
,

582 
gå_t
 
gå_mask
, 
sgv_þu¡”šg_ty³s
 
þu¡”šg_ty³
,

583 
Œªs_tbl_’t
 *
Œªs_tbl
,

584 cÚ¡ 
sgv_poÞ_®loc_âs
 *
®loc_âs
, *
´iv
)

586 
sg_couÁ
 = 0;

587 
pg
, 
i
, 
j
;

588 
m”ged
 = -1;

590 
	`TRACE_MEM
("·ges=%d, clu¡”šg_ty³=%d", 
·ges
, 
þu¡”šg_ty³
);

593 
gå_mask
 |ð
__GFP_COLD
;

595 #ifdeà
CONFIG_SCST_STRICT_SECURITY


596 
gå_mask
 |ð
__GFP_ZERO
;

599 
pg
 = 0;…g < 
·ges
;…g++) {

600 *
rc
;

601 #ifdeà
CONFIG_SCST_DEBUG_OOM


602 ià(((
gå_mask
 & 
__GFP_NOFAIL
) != __GFP_NOFAIL) &&

603 ((
	`sc¡_¿ndom
() % 10000) == 55))

604 
rc
 = 
NULL
;

607 
rc
 = 
®loc_âs
->
	`®loc_·ges_â
(&
sg
[
sg_couÁ
], 
gå_mask
,

608 
´iv
);

609 ià(
rc
 =ð
NULL
)

610 
out_no_mem
;

618 ià(
þu¡”šg_ty³
 =ð
sgv_fuÎ_þu¡”šg
)

619 
m”ged
 = 
	`sgv_check_fuÎ_þu¡”šg
(
sg
, 
sg_couÁ
, merged);

620 ià(
þu¡”šg_ty³
 =ð
sgv_ž_þu¡”šg
)

621 
m”ged
 = 
	`sgv_check_ž_þu¡”šg
(
sg
, 
sg_couÁ
, merged);

623 
m”ged
 = -1;

625 ià(
m”ged
 == -1)

626 
sg_couÁ
++;

628 
	`TRACE_MEM
("pg=%d, m”ged=%d, sg_couÁ=%d", 
pg
, 
m”ged
,

629 
sg_couÁ
);

632 ià((
þu¡”šg_ty³
 !ð
sgv_no_þu¡”šg
è&& (
Œªs_tbl
 !ð
NULL
)) {

633 
pg
 = 0;

634 
i
 = 0; i < 
·ges
; i++) {

635 
n
 = (
sg
[
i
].
Ëngth
 >> 
PAGE_SHIFT
) +

636 ((
sg
[
i
].
Ëngth
 & ~
PAGE_MASK
) != 0);

637 
Œªs_tbl
[
i
].
pg_couÁ
 = 
pg
;

638 
j
 = 0; j < 
n
; j++)

639 
Œªs_tbl
[
pg
++].
sg_num
 = 
i
+1;

640 
	`TRACE_MEM
("i=%d,‚=%d,…g_couÁ=%d", 
i
, 
n
,

641 
Œªs_tbl
[
i
].
pg_couÁ
);

645 
out
:

646 
	`TRACE_MEM
("sg_couÁ=%d", 
sg_couÁ
);

647  
sg_couÁ
;

649 
out_no_mem
:

650 
®loc_âs
->
	`ä“_·ges_â
(
sg
, 
sg_couÁ
, 
´iv
);

651 
sg_couÁ
 = 0;

652 
out
;

653 
	}
}

655 
	$sgv_®loc_¬¿ys
(
sgv_poÞ_obj
 *
obj
,

656 
·ges_to_®loc
, 
gå_t
 
gå_mask
)

658 
sz
, 
tsz
 = 0;

659 
»s
 = 0;

661 
	`TRACE_ENTRY
();

663 
sz
 = 
·ges_to_®loc
 * (
obj
->
sg_’Œ›s
[0]);

665 
obj
->
sg_’Œ›s
 = 
	`km®loc
(
sz
, 
gå_mask
);

666 ià(
	`uÆik–y
(
obj
->
sg_’Œ›s
 =ð
NULL
)) {

667 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Allocation of sgv_pool_obj "

668 "SG veùÜ fažed (siz%d)", 
sz
);

669 
»s
 = -
ENOMEM
;

670 
out
;

673 
	`sg_š™_bË
(
obj
->
sg_’Œ›s
, 
·ges_to_®loc
);

675 ià(
	`sgv_poÞ_þu¡”ed
(
obj
->
owÃr_poÞ
)) {

676 ià(
·ges_to_®loc
 <ð
sgv_max_Œªs_·ges
) {

677 
obj
->
Œªs_tbl
 =

678 (
Œªs_tbl_’t
 *)
obj
->
sg_’Œ›s_d©a
;

684 
tsz
 = 
·ges_to_®loc
 * (
obj
->
Œªs_tbl
[0]);

685 
obj
->
Œªs_tbl
 = 
	`kz®loc
(
tsz
, 
gå_mask
);

686 ià(
	`uÆik–y
(
obj
->
Œªs_tbl
 =ð
NULL
)) {

687 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Allocation of "

688 "Œªs_tbÈçžed (siz%d)", 
tsz
);

689 
»s
 = -
ENOMEM
;

690 
out_ä“
;

695 
	`TRACE_MEM
("pages_to_alloc %d, sz %d,sz %d, obj %p, sg_entries %p, "

696 "Œªs_tbÈ%p", 
·ges_to_®loc
, 
sz
, 
tsz
, 
obj
, obj->
sg_’Œ›s
,

697 
obj
->
Œªs_tbl
);

699 
out
:

700 
	`TRACE_EXIT_RES
(
»s
);

701  
»s
;

703 
out_ä“
:

704 
	`kä“
(
obj
->
sg_’Œ›s
);

705 
obj
->
sg_’Œ›s
 = 
NULL
;

706 
out
;

707 
	}
}

709 
sgv_poÞ_obj
 *
	$sgv_g‘_obj
(
sgv_poÞ
 *
poÞ
, 
ÿche_num
,

710 
·ges
, 
gå_t
 
gå_mask
, 
boÞ
 
g‘_Ãw
)

712 
sgv_poÞ_obj
 *
obj
;

714 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

716 ià(
	`uÆik–y
(
g‘_Ãw
)) {

718 
g‘_Ãw
;

721 ià(
	`lik–y
(!
	`li¡_em±y
(&
poÞ
->
»cyþšg_li¡s
[
ÿche_num
]))) {

722 
obj
 = 
	`li¡_’Œy
(
poÞ
->
»cyþšg_li¡s
[
ÿche_num
].
Ãxt
,

723 
sgv_poÞ_obj
, 
»cyþšg_li¡_’Œy
);

725 
	`li¡_d–
(&
obj
->
sÜ‹d_»cyþšg_li¡_’Œy
);

726 
	`li¡_d–
(&
obj
->
»cyþšg_li¡_’Œy
);

728 
poÞ
->
šaùive_ÿched_·ges
 -ð
·ges
;

730 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

731 
out
;

734 
g‘_Ãw
:

735 ià(
poÞ
->
ÿched_’Œ›s
 == 0) {

736 
	`TRACE_MEM
("Addšg…oÞ %°tØthaùivli¡", 
poÞ
);

737 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

738 
	`li¡_add_ž
(&
poÞ
->
sgv_aùive_poÞs_li¡_’Œy
,

739 &
sgv_aùive_poÞs_li¡
);

740 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

743 
poÞ
->
ÿched_’Œ›s
++;

744 
poÞ
->
ÿched_·ges
 +ð
·ges
;

746 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

748 
	`TRACE_MEM
("New cachedƒÁr› %d (poÞ %p)", 
poÞ
->
ÿched_’Œ›s
,

749 
poÞ
);

751 
obj
 = 
	`kmem_ÿche_®loc
(
poÞ
->
ÿches
[
ÿche_num
],

752 
gå_mask
 & ~(
__GFP_HIGHMEM
|
GFP_DMA
));

753 ià(
	`lik–y
(
obj
)) {

754 
	`mem£t
(
obj
, 0, (*obj));

755 
obj
->
ÿche_num
 = cache_num;

756 
obj
->
·ges
 =…ages;

757 
obj
->
owÃr_poÞ
 = 
poÞ
;

759 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

760 
	`sgv_dec_ÿched_’Œ›s
(
poÞ
, 
·ges
);

761 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

764 
out
:

765  
obj
;

766 
	}
}

768 
	$sgv_put_obj
(
sgv_poÞ_obj
 *
obj
)

770 
sgv_poÞ
 *
poÞ
 = 
obj
->
owÃr_poÞ
;

771 
li¡_h—d
 *
’Œy
;

772 
li¡_h—d
 *
li¡
 = &
poÞ
->
»cyþšg_li¡s
[
obj
->
ÿche_num
];

773 
·ges
 = 
obj
->pages;

775 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

777 
	`TRACE_MEM
("sgv %p, cachnum %d,…age %d, sg_couÁ %d", 
obj
,

778 
obj
->
ÿche_num
, 
·ges
, obj->
sg_couÁ
);

780 ià(
	`sgv_poÞ_þu¡”ed
(
poÞ
)) {

782 
	`__li¡_fÜ_—ch
(
’Œy
, 
li¡
) {

783 
sgv_poÞ_obj
 *
tmp
 = 
	`li¡_’Œy
(
’Œy
,

784 
sgv_poÞ_obj
, 
»cyþšg_li¡_’Œy
);

786 
	`TRACE_MEM
("tmp %p, cache‚um %d,…ages %d, sg_count %d",

787 
tmp
,mp->
ÿche_num
,mp->
·ges
,mp->
sg_couÁ
);

789 ià(
obj
->
sg_couÁ
 <ð
tmp
->sg_count)

792 
’Œy
 =ƒÁry->
´ev
;

794 
’Œy
 = 
li¡
;

796 
	`TRACE_MEM
("Addšg iÀ%°Öi¡ %p)", 
’Œy
, 
li¡
);

797 
	`li¡_add
(&
obj
->
»cyþšg_li¡_’Œy
, 
’Œy
);

799 
	`li¡_add_ž
(&
obj
->
sÜ‹d_»cyþšg_li¡_’Œy
,

800 &
poÞ
->
sÜ‹d_»cyþšg_li¡
);

802 
obj
->
time_¡amp
 = 
jiff›s
;

804 
poÞ
->
šaùive_ÿched_·ges
 +ð
·ges
;

806 ià(!
poÞ
->
purge_wÜk_scheduËd
) {

807 
	`TRACE_MEM
("Schedulšg…urgwÜk fÜ…oÞ %p", 
poÞ
);

808 
poÞ
->
purge_wÜk_scheduËd
 = 
Œue
;

809 
	`scheduË_d–ayed_wÜk
(&
poÞ
->
sgv_purge_wÜk
,

810 
poÞ
->
purge_š‹rv®
);

813 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

815 
	}
}

818 
	$sgv_hiwmk_check
(
·ges_to_®loc
)

820 
»s
 = 0;

821 
·ges
 = 
·ges_to_®loc
;

823 
·ges
 +ð
	`©omic_»ad
(&
sgv_·ges_tÙ®
);

825 ià(
	`uÆik–y
(
·ges
 > 
sgv_hi_wmk
)) {

826 
·ges
 -ð
sgv_hi_wmk
;

827 
	`©omic_šc
(&
sgv_»Ëa£s_Ú_hiwmk
);

829 
·ges
 = 
	`__sgv_shršk
(pages, 0);

830 ià(
·ges
 > 0) {

831 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Requested‡mount of "

836 "sc¡_max_cmd_mem?", 
·ges_to_®loc
,

837 
sgv_hi_wmk
);

838 
	`©omic_šc
(&
sgv_»Ëa£s_Ú_hiwmk_çžed
);

839 
»s
 = -
ENOMEM
;

840 
out_uÆock
;

844 
	`©omic_add
(
·ges_to_®loc
, &
sgv_·ges_tÙ®
);

846 
out_uÆock
:

847 
	`TRACE_MEM
("·ges_to_®loø%d,‚ewÙ® %d", 
·ges_to_®loc
,

848 
	`©omic_»ad
(&
sgv_·ges_tÙ®
));

850  
»s
;

851 
	}
}

854 
	$sgv_hiwmk_uncheck
(
·ges
)

856 
	`©omic_sub
(
·ges
, &
sgv_·ges_tÙ®
);

857 
	`TRACE_MEM
("·ge %d,‚ewÙ® %d", 
·ges
,

858 
	`©omic_»ad
(&
sgv_·ges_tÙ®
));

860 
	}
}

863 
boÞ
 
	$sgv_check_®lowed_mem
(
sc¡_mem_lim
 *
mem_lim
, 
·ges
)

865 
®loûd
;

866 
boÞ
 
»s
 = 
Œue
;

868 
®loûd
 = 
	`©omic_add_»tuº
(
·ges
, &
mem_lim
->
®loûd_·ges
);

869 ià(
	`uÆik–y
(
®loûd
 > 
mem_lim
->
max_®lowed_·ges
)) {

870 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Requested‡mount of memory "

874 "sc¡_max_dev_cmd_mem?", 
·ges
,

875 
mem_lim
->
max_®lowed_·ges
);

876 
	`©omic_sub
(
·ges
, &
mem_lim
->
®loûd_·ges
);

877 
»s
 = 
çl£
;

880 
	`TRACE_MEM
("mem_lim %p,…age %d,„e %d,‚ew‡Îoûd %d", 
mem_lim
,

881 
·ges
, 
»s
, 
	`©omic_»ad
(&
mem_lim
->
®loûd_·ges
));

883  
»s
;

884 
	}
}

887 
	$sgv_uncheck_®lowed_mem
(
sc¡_mem_lim
 *
mem_lim
, 
·ges
)

889 
	`©omic_sub
(
·ges
, &
mem_lim
->
®loûd_·ges
);

891 
	`TRACE_MEM
("mem_lim %p,…age %d,‚ew‡Îoûd %d", 
mem_lim
,

892 
·ges
, 
	`©omic_»ad
(&
mem_lim
->
®loûd_·ges
));

894 
	}
}

911 
sÿ‰”li¡
 *
	$sgv_poÞ_®loc
(
sgv_poÞ
 *
poÞ
, 
size
,

912 
gå_t
 
gå_mask
, 
æags
, *
couÁ
,

913 
sgv_poÞ_obj
 **
sgv
, 
sc¡_mem_lim
 *
mem_lim
, *
´iv
)

915 
sgv_poÞ_obj
 *
obj
;

916 
ÿche_num
, 
·ges
, 
út
;

917 
sÿ‰”li¡
 *
»s
 = 
NULL
;

918 
·ges_to_®loc
;

919 
no_ÿched
 = 
æags
 & 
SGV_POOL_ALLOC_NO_CACHED
;

920 
boÞ
 
®lowed_mem_checked
 = 
çl£
, 
hiwmk_checked
 = false;

922 
	`TRACE_ENTRY
();

924 ià(
	`uÆik–y
(
size
 == 0))

925 
out
;

927 
	`EXTRACHECKS_BUG_ON
((
gå_mask
 & 
__GFP_NOFAIL
) == __GFP_NOFAIL);

929 
·ges
 = ((
size
 + 
PAGE_SIZE
 - 1è>> 
PAGE_SHIFT
);

930 ià(
poÞ
->
sšgË_®loc_·ges
 == 0) {

931 
·ges_Üd”
 = 
	`g‘_Üd”
(
size
);

932 
ÿche_num
 = 
·ges_Üd”
;

933 
·ges_to_®loc
 = (1 << 
·ges_Üd”
);

935 
ÿche_num
 = 0;

936 
·ges_to_®loc
 = 
	`max
(
poÞ
->
sšgË_®loc_·ges
, 
·ges
);

939 
	`TRACE_MEM
("size=%d,…ages=%d,…ages_to_alloc=%d, cache‚um=%d, "

940 "æags=%x,‚o_ÿched=%d, *sgv=%p", 
size
, 
·ges
,

941 
·ges_to_®loc
, 
ÿche_num
, 
æags
, 
no_ÿched
, *
sgv
);

943 ià(*
sgv
 !ð
NULL
) {

944 
obj
 = *
sgv
;

946 
	`TRACE_MEM
("Suµl›d obj %p, cachnum %d", 
obj
, obj->
ÿche_num
);

948 
	`EXTRACHECKS_BUG_ON
(
obj
->
sg_couÁ
 != 0);

950 ià(
	`uÆik–y
(!
	`sgv_check_®lowed_mem
(
mem_lim
, 
·ges_to_®loc
)))

951 
out_çž_ä“_sg_’Œ›s
;

952 
®lowed_mem_checked
 = 
Œue
;

954 ià(
	`uÆik–y
(
	`sgv_hiwmk_check
(
·ges_to_®loc
) != 0))

955 
out_çž_ä“_sg_’Œ›s
;

956 
hiwmk_checked
 = 
Œue
;

957 } ià((
·ges_to_®loc
 <ð
poÞ
->
max_ÿched_·ges
è&& !
no_ÿched
) {

958 ià(
	`uÆik–y
(!
	`sgv_check_®lowed_mem
(
mem_lim
, 
·ges_to_®loc
)))

959 
out_çž
;

960 
®lowed_mem_checked
 = 
Œue
;

962 
obj
 = 
	`sgv_g‘_obj
(
poÞ
, 
ÿche_num
, 
·ges_to_®loc
, 
gå_mask
,

963 
æags
 & 
SGV_POOL_ALLOC_GET_NEW
);

964 ià(
	`uÆik–y
(
obj
 =ð
NULL
)) {

965 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Allocation of "

966 "sgv_poÞ_obj fažed (siz%d)", 
size
);

967 
out_çž
;

970 ià(
obj
->
sg_couÁ
 != 0) {

971 
	`TRACE_MEM
("Cached obj %p", 
obj
);

972 
	`©omic_šc
(&
poÞ
->
ÿche_acc
[
ÿche_num
].
h™_®loc
);

973 
sucûss
;

976 ià(
æags
 & 
SGV_POOL_NO_ALLOC_ON_CACHE_MISS
) {

977 ià(!(
æags
 & 
SGV_POOL_RETURN_OBJ_ON_ALLOC_FAIL
))

978 
out_çž_ä“
;

981 
	`TRACE_MEM
("B¿nd‚ew obj %p", 
obj
);

983 ià(
·ges_to_®loc
 <ð
sgv_max_loÿl_·ges
) {

984 
obj
->
sg_’Œ›s
 = obj->
sg_’Œ›s_d©a
;

985 
	`sg_š™_bË
(
obj
->
sg_’Œ›s
, 
·ges_to_®loc
);

986 
	`TRACE_MEM
("sg_’Œ› %p", 
obj
->
sg_’Œ›s
);

987 ià(
	`sgv_poÞ_þu¡”ed
(
poÞ
)) {

988 
obj
->
Œªs_tbl
 = (
Œªs_tbl_’t
 *)

989 (
obj
->
sg_’Œ›s
 + 
·ges_to_®loc
);

990 
	`TRACE_MEM
("Œªs_tbÈ%p", 
obj
->
Œªs_tbl
);

998 ià(
	`uÆik–y
(
	`sgv_®loc_¬¿ys
(
obj
, 
·ges_to_®loc
,

999 
gå_mask
) != 0))

1000 
out_çž_ä“
;

1003 ià((
æags
 & 
SGV_POOL_NO_ALLOC_ON_CACHE_MISS
) &&

1004 (
æags
 & 
SGV_POOL_RETURN_OBJ_ON_ALLOC_FAIL
))

1005 
out_»tuº
;

1007 
obj
->
®loÿtÜ_´iv
 = 
´iv
;

1009 ià(
	`uÆik–y
(
	`sgv_hiwmk_check
(
·ges_to_®loc
) != 0))

1010 
out_çž_ä“_sg_’Œ›s
;

1011 
hiwmk_checked
 = 
Œue
;

1013 
sz
;

1015 
·ges_to_®loc
 = 
·ges
;

1017 ià(
	`uÆik–y
(!
	`sgv_check_®lowed_mem
(
mem_lim
, 
·ges_to_®loc
)))

1018 
out_çž
;

1019 
®lowed_mem_checked
 = 
Œue
;

1021 ià(
æags
 & 
SGV_POOL_NO_ALLOC_ON_CACHE_MISS
)

1022 
out_»tuº2
;

1024 
sz
 = (*
obj
è+ 
·ges
 * (obj->
sg_’Œ›s
[0]);

1026 
obj
 = 
	`km®loc
(
sz
, 
gå_mask
);

1027 ià(
	`uÆik–y
(
obj
 =ð
NULL
)) {

1028 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Allocation of "

1029 "sgv_poÞ_obj fažed (siz%d)", 
size
);

1030 
out_çž
;

1032 
	`mem£t
(
obj
, 0, (*obj));

1034 
obj
->
owÃr_poÞ
 = 
poÞ
;

1035 
ÿche_num
 = -1;

1036 
obj
->
ÿche_num
 = cache_num;

1037 
obj
->
·ges
 = 
·ges_to_®loc
;

1038 
obj
->
®loÿtÜ_´iv
 = 
´iv
;

1040 
obj
->
sg_’Œ›s
 = obj->
sg_’Œ›s_d©a
;

1041 
	`sg_š™_bË
(
obj
->
sg_’Œ›s
, 
·ges
);

1043 ià(
	`uÆik–y
(
	`sgv_hiwmk_check
(
·ges_to_®loc
) != 0))

1044 
out_çž_ä“_sg_’Œ›s
;

1045 
hiwmk_checked
 = 
Œue
;

1047 
	`TRACE_MEM
("Big o¸no_ÿched obj %°(siz%d)", 
obj
, 
sz
);

1050 
obj
->
sg_couÁ
 = 
	`sgv_®loc_sg_’Œ›s
(obj->
sg_’Œ›s
,

1051 
·ges_to_®loc
, 
gå_mask
, 
poÞ
->
þu¡”šg_ty³
,

1052 
obj
->
Œªs_tbl
, &
poÞ
->
®loc_âs
, 
´iv
);

1053 ià(
	`uÆik–y
(
obj
->
sg_couÁ
 <= 0)) {

1054 
obj
->
sg_couÁ
 = 0;

1055 ià((
æags
 & 
SGV_POOL_RETURN_OBJ_ON_ALLOC_FAIL
) &&

1056 (
ÿche_num
 >= 0))

1057 
out_»tuº1
;

1059 
out_çž_ä“_sg_’Œ›s
;

1062 ià(
ÿche_num
 >= 0) {

1063 
	`©omic_add
(
·ges_to_®loc
 - 
obj
->
sg_couÁ
,

1064 &
poÞ
->
ÿche_acc
[
ÿche_num
].
m”ged
);

1066 ià(
no_ÿched
) {

1067 
	`©omic_add
(
·ges_to_®loc
,

1068 &
poÞ
->
Ùh”_·ges
);

1069 
	`©omic_add
(
·ges_to_®loc
 - 
obj
->
sg_couÁ
,

1070 &
poÞ
->
Ùh”_m”ged
);

1072 
	`©omic_add
(
·ges_to_®loc
,

1073 &
poÞ
->
big_·ges
);

1074 
	`©omic_add
(
·ges_to_®loc
 - 
obj
->
sg_couÁ
,

1075 &
poÞ
->
big_m”ged
);

1079 
sucûss
:

1080 ià(
ÿche_num
 >= 0) {

1081 
sg
;

1082 
	`©omic_šc
(&
poÞ
->
ÿche_acc
[
ÿche_num
].
tÙ®_®loc
);

1083 ià(
	`sgv_poÞ_þu¡”ed
(
poÞ
))

1084 
út
 = 
obj
->
Œªs_tbl
[
·ges
-1].
sg_num
;

1086 
út
 = 
·ges
;

1087 
sg
 = 
út
-1;

1088 
obj
->
Üig_sg
 = 
sg
;

1089 
obj
->
Üig_Ëngth
 = obj->
sg_’Œ›s
[
sg
].
Ëngth
;

1090 ià(
	`sgv_poÞ_þu¡”ed
(
poÞ
)) {

1091 
obj
->
sg_’Œ›s
[
sg
].
Ëngth
 =

1092 (
·ges
 - 
obj
->
Œªs_tbl
[
sg
].
pg_couÁ
è<< 
PAGE_SHIFT
;

1095 
út
 = 
obj
->
sg_couÁ
;

1096 ià(
no_ÿched
)

1097 
	`©omic_šc
(&
poÞ
->
Ùh”_®loc
);

1099 
	`©omic_šc
(&
poÞ
->
big_®loc
);

1102 *
couÁ
 = 
út
;

1103 
»s
 = 
obj
->
sg_’Œ›s
;

1104 *
sgv
 = 
obj
;

1106 ià(
size
 & ~
PAGE_MASK
)

1107 
obj
->
sg_’Œ›s
[
út
-1].
Ëngth
 -=

1108 
PAGE_SIZE
 - (
size
 & ~
PAGE_MASK
);

1110 
	`TRACE_MEM
("obj=%p, sg_entries %p (size=%d,…ages=%d, sg_count=%d, "

1111 "couÁ=%d,†a¡_Ën=%d)", 
obj
, obj->
sg_’Œ›s
, 
size
, 
·ges
,

1112 
obj
->
sg_couÁ
, *
couÁ
, obj->
sg_’Œ›s
[obj->
Üig_sg
].
Ëngth
);

1114 
out
:

1115 
	`TRACE_EXIT_HRES
(
»s
);

1116  
»s
;

1118 
out_»tuº
:

1119 
obj
->
®loÿtÜ_´iv
 = 
´iv
;

1120 
obj
->
owÃr_poÞ
 = 
poÞ
;

1122 
out_»tuº1
:

1123 *
sgv
 = 
obj
;

1124 
	`TRACE_MEM
("R‘uºšg fažed obj %°(couÁ %d)", 
obj
, *
couÁ
);

1126 
out_»tuº2
:

1127 *
couÁ
 = 
·ges_to_®loc
;

1128 
»s
 = 
NULL
;

1129 
out_uncheck
;

1131 
out_çž_ä“_sg_’Œ›s
:

1132 ià(
obj
->
sg_’Œ›s
 !ðobj->
sg_’Œ›s_d©a
) {

1133 ià(
obj
->
Œªs_tbl
 !=

1134 (
Œªs_tbl_’t
 *)
obj
->
sg_’Œ›s_d©a
) {

1136 
	`kä“
(
obj
->
Œªs_tbl
);

1137 
obj
->
Œªs_tbl
 = 
NULL
;

1139 
	`kä“
(
obj
->
sg_’Œ›s
);

1140 
obj
->
sg_’Œ›s
 = 
NULL
;

1143 
out_çž_ä“
:

1144 ià(
ÿche_num
 >= 0) {

1145 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1146 
	`sgv_dec_ÿched_’Œ›s
(
poÞ
, 
·ges_to_®loc
);

1147 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1149 
	`kmem_ÿche_ä“
(
poÞ
->
ÿches
[
obj
->
ÿche_num
], obj);

1151 
	`kä“
(
obj
);

1153 
out_çž
:

1154 
»s
 = 
NULL
;

1155 *
couÁ
 = 0;

1156 *
sgv
 = 
NULL
;

1157 
	`TRACE_MEM
("%s", "Allocation failed");

1159 
out_uncheck
:

1160 ià(
hiwmk_checked
)

1161 
	`sgv_hiwmk_uncheck
(
·ges_to_®loc
);

1162 ià(
®lowed_mem_checked
)

1163 
	`sgv_uncheck_®lowed_mem
(
mem_lim
, 
·ges_to_®loc
);

1164 
out
;

1165 
	}
}

1166 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_®loc
);

1174 *
	$sgv_g‘_´iv
(
sgv_poÞ_obj
 *
obj
)

1176  
obj
->
®loÿtÜ_´iv
;

1177 
	}
}

1178 
EXPORT_SYMBOL_GPL
(
sgv_g‘_´iv
);

1188 
	$sgv_poÞ_ä“
(
sgv_poÞ_obj
 *
obj
, 
sc¡_mem_lim
 *
mem_lim
)

1190 
·ges
 = (
obj
->
sg_couÁ
 != 0) ? obj->pages : 0;

1192 
	`TRACE_MEM
("Freeing obj %p, cache‚um %d,…ages %d, sg_entries %p, "

1193 "sg_couÁ %d,‡ÎoÿtÜ_´iv %p", 
obj
, obj->
ÿche_num
, 
·ges
,

1194 
obj
->
sg_’Œ›s
, obj->
sg_couÁ
, obj->
®loÿtÜ_´iv
);

1209 
sÿ‰”li¡
 *
sg
 = 
obj
->
sg_’Œ›s
;

1210 
i
;

1211 
i
 = 0; i < 
obj
->
sg_couÁ
; i++) {

1212 
·ge
 *
p
 = 
	`sg_·ge
(&
sg
[
i
]);

1213 
Ën
 = 
sg
[
i
].
Ëngth
;

1214 
·ges
 = (
Ën
 >> 
PAGE_SHIFT
è+ (Ö’ & ~
PAGE_MASK
) != 0);

1215 
·ges
 > 0) {

1216 ià(
	`©omic_»ad
(&
p
->
_couÁ
) != 1) {

1217 
	`PRINT_WARNING
("Freeing…age %p with "

1220 
p
, 
	`©omic_»ad
(&p->
_couÁ
));

1221 
	`WARN_ON
(1);

1223 
·ges
--;

1224 
p
++;

1230 ià(
obj
->
ÿche_num
 >= 0) {

1231 
obj
->
sg_’Œ›s
[obj->
Üig_sg
].
Ëngth
 = obj->
Üig_Ëngth
;

1232 
	`sgv_put_obj
(
obj
);

1234 
obj
->
owÃr_poÞ
->
®loc_âs
.
	`ä“_·ges_â
(obj->
sg_’Œ›s
,

1235 
obj
->
sg_couÁ
, obj->
®loÿtÜ_´iv
);

1236 
	`kä“
(
obj
);

1237 
	`sgv_hiwmk_uncheck
(
·ges
);

1240 
	`sgv_uncheck_®lowed_mem
(
mem_lim
, 
·ges
);

1242 
	}
}

1243 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_ä“
);

1252 
sÿ‰”li¡
 *
	$sc¡_®loc
(
size
, 
gå_t
 
gå_mask
, *
couÁ
)

1254 
sÿ‰”li¡
 *
»s
;

1255 
·ges
 = (
size
 >> 
PAGE_SHIFT
è+ ((siz& ~
PAGE_MASK
) != 0);

1256 
sgv_poÞ_®loc_âs
 
sys_®loc_âs
 = {

1257 
sgv_®loc_sys_·ges
, 
sgv_ä“_sys_sg_’Œ›s
 };

1258 
no_çž
 = ((
gå_mask
 & 
__GFP_NOFAIL
) == __GFP_NOFAIL);

1259 
út
;

1261 
	`TRACE_ENTRY
();

1263 
	`©omic_šc
(&
sgv_Ùh”_tÙ®_®loc
);

1265 ià(
	`uÆik–y
(
	`sgv_hiwmk_check
(
·ges
) != 0)) {

1266 ià(!
no_çž
) {

1267 
»s
 = 
NULL
;

1268 
out
;

1275 
	`sgv_hiwmk_uncheck
(-
·ges
);

1279 
»s
 = 
	`km®loc
(
·ges
*(*»s), 
gå_mask
);

1280 ià(
»s
 =ð
NULL
) {

1281 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate sg for %d…ages",

1282 
·ges
);

1283 
out_uncheck
;

1286 
	`sg_š™_bË
(
»s
, 
·ges
);

1293 
út
 = 
	`sgv_®loc_sg_’Œ›s
(
»s
, 
·ges
, 
gå_mask
, 
sgv_no_þu¡”šg
,

1294 
NULL
, &
sys_®loc_âs
, NULL);

1295 ià(
út
 <= 0)

1296 
out_ä“
;

1298 ià(
size
 & ~
PAGE_MASK
)

1299 
»s
[
út
-1].
Ëngth
 -ð
PAGE_SIZE
 - (
size
 & ~
PAGE_MASK
);

1301 *
couÁ
 = 
út
;

1303 
out
:

1304 
	`TRACE_MEM
("AÎoûd sg %°(couÁ %d,‚o_çž %d)", 
»s
, *
couÁ
, 
no_çž
);

1306 
	`TRACE_EXIT_HRES
(
»s
);

1307  
»s
;

1309 
out_ä“
:

1310 
	`kä“
(
»s
);

1311 
»s
 = 
NULL
;

1313 
out_uncheck
:

1314 ià(!
no_çž
)

1315 
	`sgv_hiwmk_uncheck
(
·ges
);

1316 
out
;

1317 
	}
}

1318 
EXPORT_SYMBOL_GPL
(
sc¡_®loc
);

1325 
	$sc¡_ä“
(
sÿ‰”li¡
 *
sg
, 
couÁ
)

1327 
	`TRACE_MEM
("F»ešg sg=%p", 
sg
);

1329 
	`sgv_hiwmk_uncheck
(
couÁ
);

1331 
	`sgv_ä“_sys_sg_’Œ›s
(
sg
, 
couÁ
, 
NULL
);

1332 
	`kä“
(
sg
);

1334 
	}
}

1335 
EXPORT_SYMBOL_GPL
(
sc¡_ä“
);

1338 
	$sgv_poÞ_š™_ÿche
(
sgv_poÞ
 *
poÞ
, 
ÿche_num
)

1340 
size
;

1341 
·ges
;

1342 
sgv_poÞ_obj
 *
obj
;

1344 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
ÿche_num
].
tÙ®_®loc
, 0);

1345 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
ÿche_num
].
h™_®loc
, 0);

1346 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
ÿche_num
].
m”ged
, 0);

1348 ià(
poÞ
->
sšgË_®loc_·ges
 == 0)

1349 
·ges
 = 1 << 
ÿche_num
;

1351 
·ges
 = 
poÞ
->
sšgË_®loc_·ges
;

1353 ià(
·ges
 <ð
sgv_max_loÿl_·ges
) {

1354 
size
 = (*
obj
è+ 
·ges
 *

1355 ((
obj
->
sg_’Œ›s
[0]) +

1356 ((
poÞ
->
þu¡”šg_ty³
 !ð
sgv_no_þu¡”šg
) ?

1357 (
obj
->
Œªs_tbl
[0]) : 0));

1358 } ià(
·ges
 <ð
sgv_max_Œªs_·ges
) {

1363 
size
 = (*
obj
è+ 
·ges
 *

1364 (((
poÞ
->
þu¡”šg_ty³
 !ð
sgv_no_þu¡”šg
) ?

1365 (
obj
->
Œªs_tbl
[0]) : 0));

1367 
size
 = (*
obj
);

1371 
	`TRACE_MEM
("·ges=%d, size=%d", 
·ges
, 
size
);

1373 
	`sú´štf
(
poÞ
->
ÿche_Çmes
[
ÿche_num
],

1374 (
poÞ
->
ÿche_Çmes
[
ÿche_num
]),

1375 "%s-%uK", 
poÞ
->
Çme
, (
·ges
 << 
PAGE_SHIFT
) >> 10);

1376 
poÞ
->
ÿches
[
ÿche_num
] = 
	`kmem_ÿche_ü—‹
(

1377 
poÞ
->
ÿche_Çmes
[
ÿche_num
], 
size
, 0, 
SCST_SLAB_FLAGS
, 
NULL


1378 #ià(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 23))

1379 , 
NULL
);

1384 
	}
}

1387 
	$sgv_poÞ_š™
(
sgv_poÞ
 *
poÞ
, cÚ¡ *
Çme
,

1388 
sgv_þu¡”šg_ty³s
 
þu¡”šg_ty³
, 
sšgË_®loc_·ges
,

1389 
purge_š‹rv®
)

1391 
»s
 = -
ENOMEM
;

1392 
i
;

1394 
	`TRACE_ENTRY
();

1396 ià(
sšgË_®loc_·ges
 < 0) {

1397 
	`PRINT_ERROR
("Wrong single_alloc_pages value %d",

1398 
sšgË_®loc_·ges
);

1399 
»s
 = -
EINVAL
;

1400 
out
;

1403 
	`mem£t
(
poÞ
, 0, (*pool));

1405 
	`©omic_£t
(&
poÞ
->
big_®loc
, 0);

1406 
	`©omic_£t
(&
poÞ
->
big_·ges
, 0);

1407 
	`©omic_£t
(&
poÞ
->
big_m”ged
, 0);

1408 
	`©omic_£t
(&
poÞ
->
Ùh”_®loc
, 0);

1409 
	`©omic_£t
(&
poÞ
->
Ùh”_·ges
, 0);

1410 
	`©omic_£t
(&
poÞ
->
Ùh”_m”ged
, 0);

1412 
poÞ
->
þu¡”šg_ty³
 = clustering_type;

1413 
poÞ
->
sšgË_®loc_·ges
 = single_alloc_pages;

1414 ià(
purge_š‹rv®
 != 0) {

1415 
poÞ
->
purge_š‹rv®
 =…urge_interval;

1416 ià(
purge_š‹rv®
 < 0) {

1418 
poÞ
->
purge_wÜk_scheduËd
 = 1;

1421 
poÞ
->
purge_š‹rv®
 = 
SGV_DEFAULT_PURGE_INTERVAL
;

1422 ià(
sšgË_®loc_·ges
 == 0) {

1423 
poÞ
->
max_ÿches
 = 
SGV_POOL_ELEMENTS
;

1424 
poÞ
->
max_ÿched_·ges
 = 1 << (
SGV_POOL_ELEMENTS
 - 1);

1426 
poÞ
->
max_ÿches
 = 1;

1427 
poÞ
->
max_ÿched_·ges
 = 
sšgË_®loc_·ges
;

1429 
poÞ
->
®loc_âs
.
®loc_·ges_â
 = 
sgv_®loc_sys_·ges
;

1430 
poÞ
->
®loc_âs
.
ä“_·ges_â
 = 
sgv_ä“_sys_sg_’Œ›s
;

1432 
	`TRACE_MEM
("name %s, sizeof(*obj)=%zd, clustering_type=%d, "

1434 
Çme
, (
sgv_poÞ_obj
), 
þu¡”šg_ty³
,

1435 
sšgË_®loc_·ges
, 
poÞ
->
max_ÿches
,…oÞ->
max_ÿched_·ges
);

1437 
	`¡¾ýy
(
poÞ
->
Çme
,‚ame, (pool->name)-1);

1439 
poÞ
->
owÃr_mm
 = 
cu¼’t
->
mm
;

1441 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1442 
	`sgv_poÞ_š™_ÿche
(
poÞ
, 
i
);

1443 ià(
poÞ
->
ÿches
[
i
] =ð
NULL
) {

1444 
	`PRINT_ERROR
("Allocation of sgv_pool "

1445 "ÿch%s(%dèçžed", 
Çme
, 
i
);

1446 
out_ä“
;

1450 
	`©omic_£t
(&
poÞ
->
sgv_poÞ_»f
, 1);

1451 
	`¥š_lock_š™
(&
poÞ
->
sgv_poÞ_lock
);

1452 
	`INIT_LIST_HEAD
(&
poÞ
->
sÜ‹d_»cyþšg_li¡
);

1453 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++)

1454 
	`INIT_LIST_HEAD
(&
poÞ
->
»cyþšg_li¡s
[
i
]);

1456 #ià(
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 20))

1457 
	`INIT_DELAYED_WORK
(&
poÞ
->
sgv_purge_wÜk
,

1458 ((*)(
wÜk_¡ruù
 *))
sgv_purge_wÜk_â
);

1460 
	`INIT_WORK
(&
poÞ
->
sgv_purge_wÜk
, 
sgv_purge_wÜk_â
,…ool);

1463 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

1464 
	`li¡_add_ž
(&
poÞ
->
sgv_poÞs_li¡_’Œy
, &
sgv_poÞs_li¡
);

1465 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

1467 #iâdeà
CONFIG_SCST_PROC


1468 
»s
 = 
	`sc¡_sgv_sysfs_ü—‹
(
poÞ
);

1469 ià(
»s
 != 0)

1470 
out_d–
;

1473 
»s
 = 0;

1475 
out
:

1476 
	`TRACE_EXIT_RES
(
»s
);

1477  
»s
;

1479 #iâdeà
CONFIG_SCST_PROC


1480 
out_d–
:

1481 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

1482 
	`li¡_d–
(&
poÞ
->
sgv_poÞs_li¡_’Œy
);

1483 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

1486 
out_ä“
:

1487 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1488 ià(
poÞ
->
ÿches
[
i
]) {

1489 
	`kmem_ÿche_de¡roy
(
poÞ
->
ÿches
[
i
]);

1490 
poÞ
->
ÿches
[
i
] = 
NULL
;

1494 
out
;

1495 
	}
}

1497 
	$sgv_ev®u©e_loÿl_max_·ges
()

1499 
¥aû4sgv_‰bl
 = 
PAGE_SIZE
 - (
sgv_poÞ_obj
);

1501 
sgv_max_loÿl_·ges
 = 
¥aû4sgv_‰bl
 /

1502 ((
Œªs_tbl_’t
è+ (
sÿ‰”li¡
));

1504 
sgv_max_Œªs_·ges
 = 
¥aû4sgv_‰bl
 / (
Œªs_tbl_’t
);

1506 
	`TRACE_MEM
("sgv_max_local_pages %d, sgv_max_trans_pages %d",

1507 
sgv_max_loÿl_·ges
, 
sgv_max_Œªs_·ges
);

1509 
	}
}

1516 
	$sgv_poÞ_æush
(
sgv_poÞ
 *
poÞ
)

1518 
i
;

1520 
	`TRACE_ENTRY
();

1522 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1523 
sgv_poÞ_obj
 *
obj
;

1525 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1527 !
	`li¡_em±y
(&
poÞ
->
»cyþšg_li¡s
[
i
])) {

1528 
obj
 = 
	`li¡_’Œy
(
poÞ
->
»cyþšg_li¡s
[
i
].
Ãxt
,

1529 
sgv_poÞ_obj
, 
»cyþšg_li¡_’Œy
);

1531 
	`__sgv_purge_äom_ÿche
(
obj
);

1533 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1535 
	`EXTRACHECKS_BUG_ON
(
obj
->
owÃr_poÞ
 !ð
poÞ
);

1536 
	`sgv_dtÜ_ªd_ä“
(
obj
);

1538 
	`¥š_lock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1540 
	`¥š_uÆock_bh
(&
poÞ
->
sgv_poÞ_lock
);

1543 
	`TRACE_EXIT
();

1545 
	}
}

1546 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_æush
);

1548 
	$sgv_poÞ_de¡roy
(
sgv_poÞ
 *
poÞ
)

1550 
i
;

1552 
	`TRACE_ENTRY
();

1554 
	`ÿnûl_d–ayed_wÜk_sync
(&
poÞ
->
sgv_purge_wÜk
);

1556 
	`sgv_poÞ_æush
(
poÞ
);

1558 
	`mu‹x_lock
(&
sgv_poÞs_mu‹x
);

1559 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

1560 
	`li¡_d–
(&
poÞ
->
sgv_poÞs_li¡_’Œy
);

1561 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

1562 
	`mu‹x_uÆock
(&
sgv_poÞs_mu‹x
);

1564 #iâdeà
CONFIG_SCST_PROC


1565 
	`sc¡_sgv_sysfs_d–
(
poÞ
);

1568 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1569 ià(
poÞ
->
ÿches
[
i
])

1570 
	`kmem_ÿche_de¡roy
(
poÞ
->
ÿches
[
i
]);

1571 
poÞ
->
ÿches
[
i
] = 
NULL
;

1574 
	`kä“
(
poÞ
);

1576 
	`TRACE_EXIT
();

1578 
	}
}

1590 
sgv_poÞ_£t_®loÿtÜ
(
sgv_poÞ
 *
poÞ
,

1591 
·ge
 *(*
®loc_·ges_â
)(
sÿ‰”li¡
 *, 
gå_t
, *),

1592 (*
ä“_·ges_â
)(
sÿ‰”li¡
 *, , *))

1594 
poÞ
->
®loc_âs
.
®loc_·ges_â
 =‡lloc_pages_fn;

1595 
poÞ
->
®loc_âs
.
ä“_·ges_â
 = free_pages_fn;

1597 
	}
}

1598 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_£t_®loÿtÜ
);

1624 
sgv_poÞ
 *
	$sgv_poÞ_ü—‹
(cÚ¡ *
Çme
,

1625 
sgv_þu¡”šg_ty³s
 
þu¡”šg_ty³
,

1626 
sšgË_®loc_·ges
, 
boÞ
 
sh¬ed
, 
purge_š‹rv®
)

1628 
sgv_poÞ
 *
poÞ
;

1629 
rc
;

1631 
	`TRACE_ENTRY
();

1633 
	`mu‹x_lock
(&
sgv_poÞs_mu‹x
);

1635 
	`li¡_fÜ_—ch_’Œy
(
poÞ
, &
sgv_poÞs_li¡
, 
sgv_poÞs_li¡_’Œy
) {

1636 ià(
	`¡rcmp
(
poÞ
->
Çme
,‚ame) == 0) {

1637 ià(
sh¬ed
) {

1638 ià(
poÞ
->
owÃr_mm
 !ð
cu¼’t
->
mm
) {

1639 
	`PRINT_ERROR
("Attempt of‡ shared use "

1641 "difã»Á MM", 
Çme
);

1642 
out_uÆock
;

1644 
	`sgv_poÞ_g‘
(
poÞ
);

1645 
out_uÆock
;

1647 
	`PRINT_ERROR
("SGV…oÞ % ®»adyƒxi¡s", 
Çme
);

1648 
poÞ
 = 
NULL
;

1649 
out_uÆock
;

1654 
poÞ
 = 
	`kz®loc
((*poÞ), 
GFP_KERNEL
);

1655 ià(
poÞ
 =ð
NULL
) {

1656 
	`PRINT_ERROR
("Allocation of sgv_pool failed (size %zd)",

1657 (*
poÞ
));

1658 
out_uÆock
;

1661 
rc
 = 
	`sgv_poÞ_š™
(
poÞ
, 
Çme
, 
þu¡”šg_ty³
, 
sšgË_®loc_·ges
,

1662 
purge_š‹rv®
);

1663 ià(
rc
 != 0)

1664 
out_ä“
;

1666 
out_uÆock
:

1667 
	`mu‹x_uÆock
(&
sgv_poÞs_mu‹x
);

1669 
	`TRACE_EXIT_RES
(
poÞ
 !ð
NULL
);

1670  
poÞ
;

1672 
out_ä“
:

1673 
	`kä“
(
poÞ
);

1674 
out_uÆock
;

1675 
	}
}

1676 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_ü—‹
);

1683 
	$sgv_poÞ_g‘
(
sgv_poÞ
 *
poÞ
)

1685 
	`©omic_šc
(&
poÞ
->
sgv_poÞ_»f
);

1686 
	`TRACE_MEM
("Incrementing sgv…ool %p„ef (new value %d)",

1687 
poÞ
, 
	`©omic_»ad
(&poÞ->
sgv_poÞ_»f
));

1689 
	}
}

1690 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_g‘
);

1698 
	$sgv_poÞ_put
(
sgv_poÞ
 *
poÞ
)

1700 
	`TRACE_MEM
("Decrementing sgv…ool %p„ef (new value %d)",

1701 
poÞ
, 
	`©omic_»ad
(&poÞ->
sgv_poÞ_»f
)-1);

1702 ià(
	`©omic_dec_ªd_‹¡
(&
poÞ
->
sgv_poÞ_»f
))

1703 
	`sgv_poÞ_de¡roy
(
poÞ
);

1705 
	}
}

1706 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_put
);

1716 
	$sgv_poÞ_d–
(
sgv_poÞ
 *
poÞ
)

1718 
	`TRACE_ENTRY
();

1720 
	`sgv_poÞ_put
(
poÞ
);

1722 
	`TRACE_EXIT
();

1724 
	}
}

1725 
EXPORT_SYMBOL_GPL
(
sgv_poÞ_d–
);

1728 
	$sc¡_sgv_poÞs_š™
(
mem_hwm¬k
, 
mem_lwm¬k
)

1730 
»s
 = 0;

1732 
	`TRACE_ENTRY
();

1734 
sgv_hi_wmk
 = 
mem_hwm¬k
;

1735 
sgv_lo_wmk
 = 
mem_lwm¬k
;

1737 
	`sgv_ev®u©e_loÿl_max_·ges
();

1739 
sgv_nÜm_poÞ
 = 
	`sgv_poÞ_ü—‹
("sgv", 
sgv_no_þu¡”šg
, 0, 
çl£
, 0);

1740 ià(
sgv_nÜm_poÞ
 =ð
NULL
)

1741 
out_”r
;

1743 
sgv_nÜm_þu¡_poÞ
 = 
	`sgv_poÞ_ü—‹
("sgv-clust",

1744 
sgv_fuÎ_þu¡”šg
, 0, 
çl£
, 0);

1745 ià(
sgv_nÜm_þu¡_poÞ
 =ð
NULL
)

1746 
out_ä“_nÜm
;

1748 
sgv_dma_poÞ
 = 
	`sgv_poÞ_ü—‹
("sgv-dma", 
sgv_no_þu¡”šg
, 0,

1749 
çl£
, 0);

1750 ià(
sgv_dma_poÞ
 =ð
NULL
)

1751 
out_ä“_þu¡
;

1753 #ià(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 23))

1754 
sgv_shršk”
 = 
	`£t_shršk”
(
DEFAULT_SEEKS
, 
sgv_shršk
);

1756 
sgv_shršk”
.
shršk
 = 
sgv_shršk
;

1757 
sgv_shršk”
.
£eks
 = 
DEFAULT_SEEKS
;

1758 
	`»gi¡”_shršk”
(&
sgv_shršk”
);

1761 
out
:

1762 
	`TRACE_EXIT_RES
(
»s
);

1763  
»s
;

1765 
out_ä“_þu¡
:

1766 
	`sgv_poÞ_de¡roy
(
sgv_nÜm_þu¡_poÞ
);

1768 
out_ä“_nÜm
:

1769 
	`sgv_poÞ_de¡roy
(
sgv_nÜm_poÞ
);

1771 
out_”r
:

1772 
»s
 = -
ENOMEM
;

1773 
out
;

1774 
	}
}

1776 
	$sc¡_sgv_poÞs_deš™
()

1778 
	`TRACE_ENTRY
();

1780 #ià(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 23))

1781 
	`»move_shršk”
(
sgv_shršk”
);

1783 
	`uÄegi¡”_shršk”
(&
sgv_shršk”
);

1786 
	`sgv_poÞ_de¡roy
(
sgv_dma_poÞ
);

1787 
	`sgv_poÞ_de¡roy
(
sgv_nÜm_poÞ
);

1788 
	`sgv_poÞ_de¡roy
(
sgv_nÜm_þu¡_poÞ
);

1790 
	`æush_scheduËd_wÜk
();

1792 
	`TRACE_EXIT
();

1794 
	}
}

1796 #ifdeà
CONFIG_SCST_PROC


1798 
	$sgv_do_´oc_»ad
(
£q_fže
 *
£q
, cÚ¡ 
sgv_poÞ
 *
poÞ
)

1800 
i
, 
tÙ®
 = 0, 
h™
 = 0, 
m”ged
 = 0, 
®loÿ‹d
 = 0;

1801 
ß
, 
om
;

1803 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1804 
t
;

1806 
h™
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1807 
tÙ®
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
);

1809 
t
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
) -

1810 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1811 ià(
poÞ
->
sšgË_®loc_·ges
 == 0)

1812 
®loÿ‹d
 +ð
t
 * (1 << 
i
);

1814 
®loÿ‹d
 +ð
t
 * 
poÞ
->
sšgË_®loc_·ges
;

1815 
m”ged
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].merged);

1818 
	`£q_´štf
(
£q
, "\n%-30 %-11d %-11d %-11d %d/%d/%d\n", 
poÞ
->
Çme
,

1819 
h™
, 
tÙ®
, (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0,

1820 
poÞ
->
ÿched_·ges
,…oÞ->
šaùive_ÿched_·ges
,

1821 
poÞ
->
ÿched_’Œ›s
);

1823 
i
 = 0; i < 
poÞ
->
max_ÿches
; i++) {

1824 
t
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
) -

1825 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1826 ià(
poÞ
->
sšgË_®loc_·ges
 == 0)

1827 
®loÿ‹d
 = 
t
 * (1 << 
i
);

1829 
®loÿ‹d
 = 
t
 * 
poÞ
->
sšgË_®loc_·ges
;

1830 
m”ged
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].merged);

1832 
	`£q_´štf
(
£q
, " %-28s %-11d %-11d %d\n",

1833 
poÞ
->
ÿche_Çmes
[
i
],

1834 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
),

1835 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
),

1836 (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0);

1839 
®loÿ‹d
 = 
	`©omic_»ad
(&
poÞ
->
big_·ges
);

1840 
m”ged
 = 
	`©omic_»ad
(&
poÞ
->
big_m”ged
);

1841 
ß
 = 
	`©omic_»ad
(&
poÞ
->
Ùh”_·ges
);

1842 
om
 = 
	`©omic_»ad
(&
poÞ
->
Ùh”_m”ged
);

1844 
	`£q_´štf
(
£q
, " %-40s %d/%-9d %d/%d\n", "big/other",

1845 
	`©omic_»ad
(&
poÞ
->
big_®loc
),‡tomic_»ad(&poÞ->
Ùh”_®loc
),

1846 (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0,

1847 (
ß
 !ð0è? 
om
/oa : 0);

1850 
	}
}

1852 
	$sgv_´ocšfo_show
(
£q_fže
 *
£q
, *
v
)

1854 
sgv_poÞ
 *
poÞ
;

1855 
šaùive_·ges
 = 0;

1857 
	`TRACE_ENTRY
();

1859 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

1860 
	`li¡_fÜ_—ch_’Œy
(
poÞ
, &
sgv_aùive_poÞs_li¡
,

1861 
sgv_aùive_poÞs_li¡_’Œy
) {

1862 
šaùive_·ges
 +ð
poÞ
->
šaùive_ÿched_·ges
;

1864 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

1866 
	`£q_´štf
(
£q
, "%-42s %d/%d\n%-42s %d/%d\n%-42s %d/%d\n\n",

1867 "IÇùive/aùiv·ges", 
šaùive_·ges
,

1868 
	`©omic_»ad
(&
sgv_·ges_tÙ®
è- 
šaùive_·ges
,

1869 "Hi/lØw©”m¬k [·ges]", 
sgv_hi_wmk
, 
sgv_lo_wmk
,

1871 
	`©omic_»ad
(&
sgv_»Ëa£s_Ú_hiwmk
),

1872 
	`©omic_»ad
(&
sgv_»Ëa£s_Ú_hiwmk_çžed
));

1874 
	`£q_´štf
(
£q
, "%-30s %-11s %-11s %-11s %-11s", "Name", "Hit", "Total",

1877 
	`mu‹x_lock
(&
sgv_poÞs_mu‹x
);

1878 
	`li¡_fÜ_—ch_’Œy
(
poÞ
, &
sgv_poÞs_li¡
, 
sgv_poÞs_li¡_’Œy
) {

1879 
	`sgv_do_´oc_»ad
(
£q
, 
poÞ
);

1881 
	`mu‹x_uÆock
(&
sgv_poÞs_mu‹x
);

1883 
	`£q_´štf
(
£q
, "\n%-42s %-11d\n", "other",

1884 
	`©omic_»ad
(&
sgv_Ùh”_tÙ®_®loc
));

1886 
	`TRACE_EXIT
();

1888 
	}
}

1892 
ssize_t
 
	$sgv_sysfs_¡©_show
(
kobjeù
 *
kobj
,

1893 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1895 
sgv_poÞ
 *
poÞ
;

1896 
i
, 
tÙ®
 = 0, 
h™
 = 0, 
m”ged
 = 0, 
®loÿ‹d
 = 0;

1897 
ß
, 
om
, 
»s
;

1899 
poÞ
 = 
	`cÚš”_of
(
kobj
, 
sgv_poÞ
, 
sgv_kobj
);

1901 
i
 = 0; i < 
SGV_POOL_ELEMENTS
; i++) {

1902 
t
;

1904 
h™
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1905 
tÙ®
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
);

1907 
t
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
) -

1908 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1909 
®loÿ‹d
 +ð
t
 * (1 << 
i
);

1910 
m”ged
 +ð
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].merged);

1913 
»s
 = 
	`¥rštf
(
buf
, "%-30s %-11s %-11s %-11s %-11s", "Name", "Hit", "Total",

1916 
»s
 +ð
	`¥rštf
(&
buf
[res], "\n%-30s %-11d %-11d %-11d %d/%d/%d\n",

1917 
poÞ
->
Çme
, 
h™
, 
tÙ®
,

1918 (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0,

1919 
poÞ
->
ÿched_·ges
,…oÞ->
šaùive_ÿched_·ges
,

1920 
poÞ
->
ÿched_’Œ›s
);

1922 
i
 = 0; i < 
SGV_POOL_ELEMENTS
; i++) {

1923 
t
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
) -

1924 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
);

1925 
®loÿ‹d
 = 
t
 * (1 << 
i
);

1926 
m”ged
 = 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].merged);

1928 
»s
 +ð
	`¥rštf
(&
buf
[res], " %-28s %-11d %-11d %d\n",

1929 
poÞ
->
ÿche_Çmes
[
i
],

1930 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
),

1931 
	`©omic_»ad
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
),

1932 (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0);

1935 
®loÿ‹d
 = 
	`©omic_»ad
(&
poÞ
->
big_·ges
);

1936 
m”ged
 = 
	`©omic_»ad
(&
poÞ
->
big_m”ged
);

1937 
ß
 = 
	`©omic_»ad
(&
poÞ
->
Ùh”_·ges
);

1938 
om
 = 
	`©omic_»ad
(&
poÞ
->
Ùh”_m”ged
);

1940 
»s
 +ð
	`¥rštf
(&
buf
[res], " %-40s %d/%-9d %d/%d\n", "big/other",

1941 
	`©omic_»ad
(&
poÞ
->
big_®loc
),‡tomic_»ad(&poÞ->
Ùh”_®loc
),

1942 (
®loÿ‹d
 !ð0è? 
m”ged
*100/allocated : 0,

1943 (
ß
 !ð0è? 
om
/oa : 0);

1945  
»s
;

1946 
	}
}

1948 
ssize_t
 
	$sgv_sysfs_¡©_»£t
(
kobjeù
 *
kobj
,

1949 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1951 
sgv_poÞ
 *
poÞ
;

1952 
i
;

1954 
	`TRACE_ENTRY
();

1956 
poÞ
 = 
	`cÚš”_of
(
kobj
, 
sgv_poÞ
, 
sgv_kobj
);

1958 
i
 = 0; i < 
SGV_POOL_ELEMENTS
; i++) {

1959 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
i
].
h™_®loc
, 0);

1960 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
i
].
tÙ®_®loc
, 0);

1961 
	`©omic_£t
(&
poÞ
->
ÿche_acc
[
i
].
m”ged
, 0);

1964 
	`©omic_£t
(&
poÞ
->
big_·ges
, 0);

1965 
	`©omic_£t
(&
poÞ
->
big_m”ged
, 0);

1966 
	`©omic_£t
(&
poÞ
->
big_®loc
, 0);

1967 
	`©omic_£t
(&
poÞ
->
Ùh”_·ges
, 0);

1968 
	`©omic_£t
(&
poÞ
->
Ùh”_m”ged
, 0);

1969 
	`©omic_£t
(&
poÞ
->
Ùh”_®loc
, 0);

1971 
	`PRINT_INFO
("Sti¡ic fÜ SGV…oÞ % »£t", 
poÞ
->
Çme
);

1973 
	`TRACE_EXIT_RES
(
couÁ
);

1974  
couÁ
;

1975 
	}
}

1977 
ssize_t
 
	$sgv_sysfs_glob®_¡©_show
(
kobjeù
 *
kobj
,

1978 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1980 
sgv_poÞ
 *
poÞ
;

1981 
šaùive_·ges
 = 0, 
»s
;

1983 
	`TRACE_ENTRY
();

1985 
	`¥š_lock_bh
(&
sgv_poÞs_lock
);

1986 
	`li¡_fÜ_—ch_’Œy
(
poÞ
, &
sgv_aùive_poÞs_li¡
,

1987 
sgv_aùive_poÞs_li¡_’Œy
) {

1988 
šaùive_·ges
 +ð
poÞ
->
šaùive_ÿched_·ges
;

1990 
	`¥š_uÆock_bh
(&
sgv_poÞs_lock
);

1992 
»s
 = 
	`¥rštf
(
buf
, "%-42s %d/%d\n%-42s %d/%d\n%-42s %d/%d\n"

1994 "IÇùive/aùiv·ges", 
šaùive_·ges
,

1995 
	`©omic_»ad
(&
sgv_·ges_tÙ®
è- 
šaùive_·ges
,

1996 "Hi/lØw©”m¬k [·ges]", 
sgv_hi_wmk
, 
sgv_lo_wmk
,

1998 
	`©omic_»ad
(&
sgv_»Ëa£s_Ú_hiwmk
),

1999 
	`©omic_»ad
(&
sgv_»Ëa£s_Ú_hiwmk_çžed
),

2000 "Oth”‡Îocs", 
	`©omic_»ad
(&
sgv_Ùh”_tÙ®_®loc
));

2002 
	`TRACE_EXIT
();

2003  
»s
;

2004 
	}
}

2006 
ssize_t
 
	$sgv_sysfs_glob®_¡©_»£t
(
kobjeù
 *
kobj
,

2007 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2009 
	`TRACE_ENTRY
();

2011 
	`©omic_£t
(&
sgv_»Ëa£s_Ú_hiwmk
, 0);

2012 
	`©omic_£t
(&
sgv_»Ëa£s_Ú_hiwmk_çžed
, 0);

2013 
	`©omic_£t
(&
sgv_Ùh”_tÙ®_®loc
, 0);

2015 
	`PRINT_INFO
("%s", "Global SGV…ool statistics„eset");

2017 
	`TRACE_EXIT_RES
(
couÁ
);

2018  
couÁ
;

2019 
	}
}

2021 
kobj_©Œibu‹
 
	gsgv_¡©_©Œ
 =

2022 
__ATTR
(
¡©s
, 
S_IRUGO
 | 
S_IWUSR
, 
sgv_sysfs_¡©_show
,

2023 
sgv_sysfs_¡©_»£t
);

2025 
©Œibu‹
 *
	gsgv_©Œs
[] = {

2026 &
sgv_¡©_©Œ
.
©Œ
,

2027 
NULL
,

2030 
	$sgv_kobj_»Ëa£
(
kobjeù
 *
kobj
)

2032 
sgv_poÞ
 *
poÞ
;

2034 
	`TRACE_ENTRY
();

2036 
poÞ
 = 
	`cÚš”_of
(
kobj
, 
sgv_poÞ
, 
sgv_kobj
);

2037 ià(
poÞ
->
sgv_kobj_»Ëa£_cm¶
 !ð
NULL
)

2038 
	`com¶‘e_®l
(
poÞ
->
sgv_kobj_»Ëa£_cm¶
);

2040 
	`TRACE_EXIT
();

2042 
	}
}

2044 
kobj_ty³
 
	gsgv_poÞ_kty³
 = {

2045 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

2046 .
	g»Ëa£
 = 
sgv_kobj_»Ëa£
,

2047 .
	gdeçuÉ_©Œs
 = 
sgv_©Œs
,

2050 
	$sc¡_sgv_sysfs_ü—‹
(
sgv_poÞ
 *
poÞ
)

2052 
»s
;

2054 
	`TRACE_ENTRY
();

2056 
»s
 = 
	`kobjeù_š™_ªd_add
(&
poÞ
->
sgv_kobj
, &
sgv_poÞ_kty³
,

2057 
sc¡_sgv_kobj
, 
poÞ
->
Çme
);

2058 ià(
»s
 != 0) {

2059 
	`PRINT_ERROR
("Cª'ˆadd sgv…oÞ % tØsysfs", 
poÞ
->
Çme
);

2060 
out
;

2063 
out
:

2064 
	`TRACE_EXIT_RES
(
»s
);

2065  
»s
;

2066 
	}
}

2068 
	$sc¡_sgv_sysfs_d–
(
sgv_poÞ
 *
poÞ
)

2070 
rc
;

2071 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

2073 
	`TRACE_ENTRY
();

2075 
poÞ
->
sgv_kobj_»Ëa£_cm¶
 = &
c
;

2077 
	`kobjeù_d–
(&
poÞ
->
sgv_kobj
);

2078 
	`kobjeù_put
(&
poÞ
->
sgv_kobj
);

2080 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(
poÞ
->
sgv_kobj_»Ëa£_cm¶
, 
HZ
);

2081 ià(
rc
 == 0) {

2082 
	`PRINT_INFO
("Waiting for„eleasing sysfsƒntry "

2083 "fÜ SGV…oÞ % (%d„efs)...", 
poÞ
->
Çme
,

2084 
	`©omic_»ad
(&
poÞ
->
sgv_kobj
.
k»f
.
»fcouÁ
));

2085 
	`wa™_fÜ_com¶‘iÚ
(
poÞ
->
sgv_kobj_»Ëa£_cm¶
);

2086 
	`PRINT_INFO
("Done waiting for„eleasing sysfs "

2087 "’Œy fÜ SGV…oÞ %s", 
poÞ
->
Çme
);

2090 
	`TRACE_EXIT
();

2091 
	}
}

2093 
kobj_©Œibu‹
 
	gsgv_glob®_¡©_©Œ
 =

2094 
__ATTR
(
glob®_¡©s
, 
S_IRUGO
 | 
S_IWUSR
, 
sgv_sysfs_glob®_¡©_show
,

2095 
sgv_sysfs_glob®_¡©_»£t
);

2097 
©Œibu‹
 *
	gsgv_deçuÉ_©Œs
[] = {

2098 &
sgv_glob®_¡©_©Œ
.
©Œ
,

2099 
NULL
,

2102 
	$sc¡_sysfs_»Ëa£
(
kobjeù
 *
kobj
)

2104 
	`kä“
(
kobj
);

2105 
	}
}

2107 
kobj_ty³
 
	gsgv_kty³
 = {

2108 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

2109 .
	g»Ëa£
 = 
sc¡_sysfs_»Ëa£
,

2110 .
	gdeçuÉ_©Œs
 = 
sgv_deçuÉ_©Œs
,

2116 
	$sc¡_add_sgv_kobj
(
kobjeù
 *
·»Á
, cÚ¡ *
Çme
)

2118 
»s
;

2120 
	`WARN_ON
(
sc¡_sgv_kobj
);

2121 
»s
 = -
ENOMEM
;

2122 
sc¡_sgv_kobj
 = 
	`kz®loc
((*sc¡_sgv_kobj), 
GFP_KERNEL
);

2123 ià(!
sc¡_sgv_kobj
)

2124 
out
;

2125 
»s
 = 
	`kobjeù_š™_ªd_add
(
sc¡_sgv_kobj
, &
sgv_kty³
, 
·»Á
, 
Çme
);

2126 ià(
»s
 != 0)

2127 
out_ä“
;

2128 
out
:

2129  
»s
;

2130 
out_ä“
:

2131 
	`kobjeù_put
(
sc¡_sgv_kobj
);

2132 
sc¡_sgv_kobj
 = 
NULL
;

2133 
out
;

2134 
	}
}

2139 
	$sc¡_d–_put_sgv_kobj
()

2141 
	`WARN_ON
(!
sc¡_sgv_kobj
);

2142 
	`kobjeù_d–
(
sc¡_sgv_kobj
);

2143 
	`kobjeù_put
(
sc¡_sgv_kobj
);

2144 
sc¡_sgv_kobj
 = 
NULL
;

2145 
	}
}

	@/root/Desktop/scst-2.2.0/src/scst_mem.h

19 
	~<lšux/sÿ‰”li¡.h
>

20 
	~<lšux/wÜkqueue.h
>

22 
	#SGV_POOL_ELEMENTS
 11

	)

29 
	sŒªs_tbl_’t
 {

30 
	msg_num
;

31 
	mpg_couÁ
;

37 
	ssgv_poÞ_obj
 {

38 
	mÿche_num
;

39 
	m·ges
;

42 
	mtime_¡amp
;

44 
li¡_h—d
 
	m»cyþšg_li¡_’Œy
;

45 
li¡_h—d
 
	msÜ‹d_»cyþšg_li¡_’Œy
;

47 
sgv_poÞ
 *
	mowÃr_poÞ
;

48 
	mÜig_sg
;

49 
	mÜig_Ëngth
;

50 
	msg_couÁ
;

51 *
	m®loÿtÜ_´iv
;

52 
Œªs_tbl_’t
 *
	mŒªs_tbl
;

53 
sÿ‰”li¡
 *
	msg_’Œ›s
;

54 
sÿ‰”li¡
 
	msg_’Œ›s_d©a
[0];

60 
	ssgv_poÞ_ÿche_acc
 {

61 
©omic_t
 
	mtÙ®_®loc
, 
	mh™_®loc
;

62 
©omic_t
 
	mm”ged
;

68 
	ssgv_poÞ_®loc_âs
 {

69 
	m·ge
 *(*
	m®loc_·ges_â
)(
sÿ‰”li¡
 *
	msg
, 
gå_t
 
	mgå_mask
,

70 *
	m´iv
);

71 (*
	mä“_·ges_â
)(
sÿ‰”li¡
 *
	msg
, 
	msg_couÁ
,

72 *
	m´iv
);

78 
	ssgv_poÞ
 {

79 
sgv_þu¡”šg_ty³s
 
	mþu¡”šg_ty³
;

80 
	msšgË_®loc_·ges
;

81 
	mmax_ÿched_·ges
;

83 
sgv_poÞ_®loc_âs
 
	m®loc_âs
;

86 
kmem_ÿche
 *
	mÿches
[
SGV_POOL_ELEMENTS
];

88 
¥šlock_t
 
	msgv_poÞ_lock
;

90 
	mpurge_š‹rv®
;

93 
	mpurge_wÜk_scheduËd
:1;

96 
li¡_h—d
 
	msÜ‹d_»cyþšg_li¡
;

98 
	mšaùive_ÿched_·ges
;

101 
li¡_h—d
 
	m»cyþšg_li¡s
[
SGV_POOL_ELEMENTS
];

103 
	mÿched_·ges
, 
	mÿched_’Œ›s
;

105 
sgv_poÞ_ÿche_acc
 
	mÿche_acc
[
SGV_POOL_ELEMENTS
];

107 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 20))

108 
d–ayed_wÜk
 
	msgv_purge_wÜk
;

110 
wÜk_¡ruù
 
	msgv_purge_wÜk
;

113 
li¡_h—d
 
	msgv_aùive_poÞs_li¡_’Œy
;

115 
©omic_t
 
	mbig_®loc
, 
	mbig_·ges
, 
	mbig_m”ged
;

116 
©omic_t
 
	mÙh”_®loc
, 
	mÙh”_·ges
, 
	mÙh”_m”ged
;

118 
©omic_t
 
	msgv_poÞ_»f
;

120 
	mmax_ÿches
;

123 
	mÿche_Çmes
[
SGV_POOL_ELEMENTS
][
SCST_MAX_NAME
 + 10];

124 
	mÇme
[
SCST_MAX_NAME
 + 10];

126 
mm_¡ruù
 *
	mowÃr_mm
;

128 
li¡_h—d
 
	msgv_poÞs_li¡_’Œy
;

130 
kobjeù
 
	msgv_kobj
;

133 
com¶‘iÚ
 *
	msgv_kobj_»Ëa£_cm¶
;

136 
šlše
 
sÿ‰”li¡
 *
	$sgv_poÞ_sg
(
sgv_poÞ_obj
 *
obj
)

138  
obj
->
sg_’Œ›s
;

139 
	}
}

141 
sc¡_sgv_poÞs_š™
(
mem_hwm¬k
, 
mem_lwm¬k
);

142 
sc¡_sgv_poÞs_deš™
();

144 #ifdeà
CONFIG_SCST_PROC


145 
sgv_´ocšfo_show
(
£q_fže
 *
£q
, *
v
);

148 
sc¡_sgv_poÞ_u£_nÜm
(
sc¡_tgt_dev
 *
tgt_dev
);

149 
sc¡_sgv_poÞ_u£_nÜm_þu¡
(
sc¡_tgt_dev
 *
tgt_dev
);

150 
sc¡_sgv_poÞ_u£_dma
(
sc¡_tgt_dev
 *
tgt_dev
);

	@/root/Desktop/scst-2.2.0/src/scst_module.c

22 
	~<lšux/moduË.h
>

23 
	~<lšux/š™.h
>

25 
	~<sc¡.h
>

27 
__š™
 
	$š™_this_sc¡_driv”
()

29 
»s
;

31 
	`TRACE_ENTRY
();

33 
»s
 = 
	`sc¡_»gi¡”_rg‘_‹m¶©e
(&
driv”_rg‘_‹m¶©e
);

34 
	`TRACE_DBG
("sc¡_»gi¡”_rg‘_‹m¶©e(è»tuºed %d", 
»s
);

35 ià(
»s
 < 0)

36 
out
;

38 #ifdeà
SCST_REGISTER_INITIATOR_DRIVER


39 
driv”_‹m¶©e
.
moduË
 = 
THIS_MODULE
;

40 
	`scsi_»gi¡”_moduË
(
MODULE_SCSI_HA
, &
driv”_‹m¶©e
);

41 
	`TRACE_DBG
("driver_template.present=%d",

42 
driv”_‹m¶©e
.
´e£Á
);

43 ià(
driv”_‹m¶©e
.
´e£Á
 == 0) {

44 
»s
 = -
ENODEV
;

45 
MOD_DEC_USE_COUNT
;

46 
out
;

50 
out
:

51 
	`TRACE_EXIT_RES
(
»s
);

52  
»s
;

53 
	}
}

55 
__ex™
 
	$ex™_this_sc¡_driv”
()

57 
	`TRACE_ENTRY
();

59 #ifdeà
SCST_REGISTER_INITIATOR_DRIVER


60 
	`scsi_uÄegi¡”_moduË
(
MODULE_SCSI_HA
, &
driv”_‹m¶©e
);

63 
	`sc¡_uÄegi¡”_rg‘_‹m¶©e
(&
driv”_rg‘_‹m¶©e
);

65 
	`TRACE_EXIT
();

67 
	}
}

69 
moduË_š™
(
š™_this_sc¡_driv”
);

70 
moduË_ex™
(
ex™_this_sc¡_driv”
);

	@/root/Desktop/scst-2.2.0/src/scst_pres.c

19 
	~<lšux/š™.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/li¡.h
>

23 
	~<lšux/¥šlock.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/sched.h
>

26 
	~<lšux/uni¡d.h
>

27 
	~<lšux/¡ršg.h
>

28 
	~<lšux/kth»ad.h
>

29 
	~<lšux/d–ay.h
>

30 #ifdeà
CONFIG_SCST_PROC


31 
	~<lšux/´oc_fs.h
>

32 
	~<lšux/£q_fže.h
>

34 
	~<lšux/time.h
>

35 
	~<lšux/ùy³.h
>

36 
	~<asm/by‹Üd”.h
>

37 
	~<lšux/sysÿÎs.h
>

38 
	~<lšux/fže.h
>

39 
	~<lšux/fs.h
>

40 
	~<lšux/fúŽ.h
>

41 
	~<lšux/uacûss.h
>

42 
	~<lšux/Çmei.h
>

43 #iâdeà
INSIDE_KERNEL_TREE


44 
	~<lšux/v”siÚ.h
>

46 
	~<lšux/vm®loc.h
>

47 
	~<asm/uÇligÃd.h
>

49 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2,6,25)

50 
	~<lšux/mouÁ.h
>

53 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 29)

54 
	~<lšux/wr™eback.h
>

57 #ifdeà
INSIDE_KERNEL_TREE


58 
	~<sc¡/sc¡.h
>

59 
	~<sc¡/sc¡_cÚ¡.h
>

61 
	~"sc¡.h
"

62 
	~"sc¡_cÚ¡.h
"

64 
	~"sc¡_´iv.h
"

65 
	~"sc¡_´es.h
"

67 
	#SCST_PR_ROOT_ENTRY
 "´"

	)

68 
	#SCST_PR_FILE_SIGN
 0xBBEEEEAAEEBBDD77LLU

	)

69 
	#SCST_PR_FILE_VERSION
 1LLU

	)

71 
	#FILE_BUFFER_SIZE
 512

	)

73 #iâdeà
isbÏnk


74 
	#isbÏnk
(
c
è((cè=ð' ' || (cè=ð'\t')

	)

77 
šlše
 
	$tid_size
(cÚ¡ 
ušt8_t
 *
tid
)

79 
	`sBUG_ON
(
tid
 =ð
NULL
);

81 ià((
tid
[0] & 0x0fè=ð
SCSI_TRANSPORTID_PROTOCOLID_ISCSI
)

82  
	`be16_to_ýu
(
	`g‘_uÇligÃd
((
__be16
 *)&
tid
[2])) + 4;

84  
TID_COMMON_SIZE
;

85 
	}
}

88 
šlše
 
	$tid_£cu»
(
ušt8_t
 *
tid
)

90 ià((
tid
[0] & 0x0fè=ð
SCSI_TRANSPORTID_PROTOCOLID_ISCSI
) {

91 
size
 = 
	`tid_size
(
tid
);

92 
tid
[
size
 - 1] = '\0';

96 
	}
}

99 
boÞ
 
	$tid_equ®
(cÚ¡ 
ušt8_t
 *
tid_a
, cÚ¡ ušt8_ˆ*
tid_b
)

101 
Ën
;

103 ià(
tid_a
 =ð
NULL
 || 
tid_b
 == NULL)

104  
çl£
;

106 ià((
tid_a
[0] & 0x0fè!ð(
tid_b
[0] & 0x0f)) {

107 
	`TRACE_DBG
("%s", "Different…rotocol IDs");

108  
çl£
;

111 ià((
tid_a
[0] & 0x0fè=ð
SCSI_TRANSPORTID_PROTOCOLID_ISCSI
) {

112 cÚ¡ 
ušt8_t
 
tid_a_fmt
 = 
tid_a
[0] & 0xc0;

113 cÚ¡ 
ušt8_t
 
tid_b_fmt
 = 
tid_b
[0] & 0xc0;

114 
tid_a_Ën
, 
tid_a_max
 = 
	`tid_size
(
tid_a
) - 4;

115 
tid_b_Ën
, 
tid_b_max
 = 
	`tid_size
(
tid_b
) - 4;

116 
i
;

118 
tid_a
 += 4;

119 
tid_b
 += 4;

121 ià(
tid_a_fmt
 == 0x00)

122 
tid_a_Ën
 = 
	`¡ºËn
(
tid_a
, 
tid_a_max
);

123 ià(
tid_a_fmt
 == 0x40) {

124 ià(
tid_a_fmt
 !ð
tid_b_fmt
) {

125 
ušt8_t
 *
p
 = 
	`¡ºchr
(
tid_a
, 
tid_a_max
, ',');

126 ià(
p
 =ð
NULL
)

127 
out_”rÜ
;

128 
tid_a_Ën
 = 
p
 - 
tid_a
;

130 
	`sBUG_ON
(
tid_a_Ën
 > 
tid_a_max
);

131 
	`sBUG_ON
(
tid_a_Ën
 < 0);

133 
tid_a_Ën
 = 
	`¡ºËn
(
tid_a
, 
tid_a_max
);

135 
out_”rÜ
;

137 ià(
tid_b_fmt
 == 0x00)

138 
tid_b_Ën
 = 
	`¡ºËn
(
tid_b
, 
tid_b_max
);

139 ià(
tid_b_fmt
 == 0x40) {

140 ià(
tid_a_fmt
 !ð
tid_b_fmt
) {

141 
ušt8_t
 *
p
 = 
	`¡ºchr
(
tid_b
, 
tid_b_max
, ',');

142 ià(
p
 =ð
NULL
)

143 
out_”rÜ
;

144 
tid_b_Ën
 = 
p
 - 
tid_b
;

146 
	`sBUG_ON
(
tid_b_Ën
 > 
tid_b_max
);

147 
	`sBUG_ON
(
tid_b_Ën
 < 0);

149 
tid_b_Ën
 = 
	`¡ºËn
(
tid_b
, 
tid_b_max
);

151 
out_”rÜ
;

153 ià(
tid_a_Ën
 !ð
tid_b_Ën
)

154  
çl£
;

156 
Ën
 = 
tid_a_Ën
;

159 
i
 = 0; i < 
Ën
; i++)

160 ià(
	`tÞow”
(
tid_a
[
i
]è!ðtÞow”(
tid_b
[i]))

161  
çl£
;

162  
Œue
;

164 
Ën
 = 
TID_COMMON_SIZE
;

166  
	`memcmp
(
tid_a
, 
tid_b
, 
Ën
) == 0;

168 
out_”rÜ
:

169 
	`PRINT_ERROR
("%s", "Invalid initiator…ortransport id");

170  
çl£
;

171 
	}
}

174 
šlše
 
	$sc¡_´_£t_hÞd”
(
sc¡_deviû
 *
dev
,

175 
sc¡_dev_»gi¡¿Á
 *
hÞd”
, 
ušt8_t
 
scÝe
, ušt8_ˆ
ty³
)

177 
dev
->
´_is_£t
 = 1;

178 
dev
->
´_scÝe
 = 
scÝe
;

179 
dev
->
´_ty³
 = 
ty³
;

180 ià(
dev
->
´_ty³
 !ð
TYPE_EXCLUSIVE_ACCESS_ALL_REG
 &&

181 
dev
->
´_ty³
 !ð
TYPE_WRITE_EXCLUSIVE_ALL_REG
)

182 
dev
->
´_hÞd”
 = 
hÞd”
;

183 
	}
}

186 
boÞ
 
	$sc¡_´_is_hÞd”
(
sc¡_deviû
 *
dev
,

187 
sc¡_dev_»gi¡¿Á
 *
»g
)

189 
boÞ
 
»s
 = 
çl£
;

191 
	`TRACE_ENTRY
();

193 ià(!
dev
->
´_is_£t
)

194 
out
;

196 ià(
dev
->
´_ty³
 =ð
TYPE_EXCLUSIVE_ACCESS_ALL_REG
 ||

197 
dev
->
´_ty³
 =ð
TYPE_WRITE_EXCLUSIVE_ALL_REG
) {

198 
»s
 = (
»g
 !ð
NULL
);

200 
»s
 = (
dev
->
´_hÞd”
 =ð
»g
);

202 
out
:

203 
	`TRACE_EXIT_RES
(
»s
);

204  
»s
;

205 
	}
}

207 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

210 
	$sc¡_´_dump_´s
(
sc¡_deviû
 *
dev
, 
boÞ
 
fÜû
)

212 ià(!
fÜû
) {

213 #ià
	`defšed
(
CONFIG_SCST_DEBUG
)

214 ià((
Œaû_æag
 & 
TRACE_PRES
) == 0)

216 
out
;

219 
	`PRINT_INFO
("P”si¡’ˆ»£rv©iÚ fÜ deviû %s:", 
dev
->
vœt_Çme
);

221 ià(
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
))

222 
	`PRINT_INFO
("%s", " No„egistrants");

224 
sc¡_dev_»gi¡¿Á
 *
»g
;

225 
i
 = 0;

226 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

227 
dev_»gi¡¿Ás_li¡_’Œy
) {

228 
	`PRINT_INFO
(" [%d]„egistrant %s/%d, key %016llx "

229 "Ôeg %p,gt_dev %p)", 
i
++,

230 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

231 
»g
->
Œª¥Üt_id
),

232 
»g
->
»l_tgt_id
,„eg->
key
,„eg,„eg->
tgt_dev
);

236 ià(
dev
->
´_is_£t
) {

237 
sc¡_dev_»gi¡¿Á
 *
hÞd”
 = 
dev
->
´_hÞd”
;

238 ià(
hÞd”
 !ð
NULL
)

239 
	`PRINT_INFO
("Reservation holder is %s/%d (key %016llx, "

241 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

242 
hÞd”
->
Œª¥Üt_id
),

243 
hÞd”
->
»l_tgt_id
, hÞd”->
key
, 
dev
->
´_scÝe
,

244 
dev
->
´_ty³
, 
hÞd”
, hÞd”->
tgt_dev
);

246 
	`PRINT_INFO
("All„egistrants‡re„eservation holders "

247 "(scÝ%x,y³ %x)", 
dev
->
´_scÝe
,

248 
dev
->
´_ty³
);

250 
	`PRINT_INFO
("%s", "Not„eserved");

252 
out
:

254 
	}
}

259 
	$sc¡_´_fšd_»gi¡¿Ás_li¡_®l
(
sc¡_deviû
 *
dev
,

260 
sc¡_dev_»gi¡¿Á
 *
exþude_»g
, 
li¡_h—d
 *
li¡
)

262 
sc¡_dev_»gi¡¿Á
 *
»g
;

264 
	`TRACE_ENTRY
();

266 
	`TRACE_PR
("Finding‡ll„egistered„ecords for device '%s' "

268 
dev
->
vœt_Çme
, 
exþude_»g
->
key
);

270 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

271 
dev_»gi¡¿Ás_li¡_’Œy
) {

272 ià(
»g
 =ð
exþude_»g
)

274 
	`TRACE_PR
("Adding„egistrant %s/%d (%p)o find†ist (key %016llx)",

275 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

276 
»g
->
»l_tgt_id
,„eg,„eg->
key
);

277 
	`li¡_add_ž
(&
»g
->
aux_li¡_’Œy
, 
li¡
);

280 
	`TRACE_EXIT
();

282 
	}
}

285 
	$sc¡_´_fšd_»gi¡¿Ás_li¡_key
(
sc¡_deviû
 *
dev
,

286 
__be64
 
key
, 
li¡_h—d
 *
li¡
)

288 
sc¡_dev_»gi¡¿Á
 *
»g
;

290 
	`TRACE_ENTRY
();

292 
	`TRACE_PR
("Finding„egistrants for device '%s' with key %016llx",

293 
dev
->
vœt_Çme
, 
key
);

295 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

296 
dev_»gi¡¿Ás_li¡_’Œy
) {

297 ià(
»g
->
key
 == key) {

298 
	`TRACE_PR
("Adding„egistrant %s/%d (%p)ohe find "

300 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

301 
»g
->
Œª¥Üt_id
),

302 
»g
->
»l_tgt_id
,„eg->
tgt_dev
, 
key
);

303 
	`li¡_add_ž
(&
»g
->
aux_li¡_’Œy
, 
li¡
);

307 
	`TRACE_EXIT
();

309 
	}
}

312 
sc¡_dev_»gi¡¿Á
 *
	$sc¡_´_fšd_»g
(

313 
sc¡_deviû
 *
dev
, cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
,

314 cÚ¡ 
ušt16_t
 
»l_tgt_id
)

316 
sc¡_dev_»gi¡¿Á
 *
»g
, *
»s
 = 
NULL
;

318 
	`TRACE_ENTRY
();

320 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

321 
dev_»gi¡¿Ás_li¡_’Œy
) {

322 ià((
»g
->
»l_tgt_id
 ==„el_tgt_id) &&

323 
	`tid_equ®
(
»g
->
Œª¥Üt_id
,ransport_id)) {

324 
»s
 = 
»g
;

329 
	`TRACE_EXIT_HRES
(
»s
);

330  
»s
;

331 
	}
}

334 
	$sc¡_´_þ—r_»£rv©iÚ
(
sc¡_deviû
 *
dev
)

336 
	`TRACE_ENTRY
();

338 
	`WARN_ON
(!
dev
->
´_is_£t
);

340 
dev
->
´_is_£t
 = 0;

341 
dev
->
´_scÝe
 = 
SCOPE_LU
;

342 
dev
->
´_ty³
 = 
TYPE_UNSPECIFIED
;

344 
dev
->
´_hÞd”
 = 
NULL
;

346 
	`TRACE_EXIT
();

348 
	}
}

351 
	$sc¡_´_þ—r_hÞd”
(
sc¡_deviû
 *
dev
)

353 
	`TRACE_ENTRY
();

355 
	`WARN_ON
(!
dev
->
´_is_£t
);

357 ià(
dev
->
´_ty³
 =ð
TYPE_WRITE_EXCLUSIVE_ALL_REG
 ||

358 
dev
->
´_ty³
 =ð
TYPE_EXCLUSIVE_ACCESS_ALL_REG
) {

359 ià(
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
))

360 
	`sc¡_´_þ—r_»£rv©iÚ
(
dev
);

362 
	`sc¡_´_þ—r_»£rv©iÚ
(
dev
);

364 
dev
->
´_hÞd”
 = 
NULL
;

366 
	`TRACE_EXIT
();

368 
	}
}

371 
sc¡_dev_»gi¡¿Á
 *
	$sc¡_´_add_»gi¡¿Á
(

372 
sc¡_deviû
 *
dev
, cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
,

373 cÚ¡ 
ušt16_t
 
»l_tgt_id
, 
__be64
 
key
,

374 
boÞ
 
dev_lock_locked
)

376 
sc¡_dev_»gi¡¿Á
 *
»g
;

377 
sc¡_tgt_dev
 *
t
;

378 
gå_t
 
gå_æags
 = 
dev_lock_locked
 ? 
GFP_ATOMIC
 : 
GFP_KERNEL
;

380 
	`TRACE_ENTRY
();

382 
	`sBUG_ON
(
dev
 =ð
NULL
);

383 
	`sBUG_ON
(
Œª¥Üt_id
 =ð
NULL
);

385 
	`TRACE_PR
("Registering %s/%d (dev %s)",

386 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
Œª¥Üt_id
),

387 
»l_tgt_id
, 
dev
->
vœt_Çme
);

389 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
, 
Œª¥Üt_id
, 
»l_tgt_id
);

390 ià(
»g
 !ð
NULL
) {

395 
	`PRINT_ERROR
("Regi¡¿Á %p/%d (dev %sè®»adyƒxi¡s!", 
»g
,

396 
»l_tgt_id
, 
dev
->
vœt_Çme
);

397 
	`PRINT_BUFFER
("T¿n¥ÜtID", 
Œª¥Üt_id
, 24);

398 
	`WARN_ON
(1);

399 
»g
 = 
NULL
;

400 
out
;

403 
»g
 = 
	`kz®loc
((*»g), 
gå_æags
);

404 ià(
»g
 =ð
NULL
) {

405 
	`PRINT_ERROR
("%s", "Unableo‡llocate„egistration„ecord");

406 
out
;

409 
»g
->
Œª¥Üt_id
 = 
	`km®loc
(
	`tid_size
Ñ¿n¥Üt_id), 
gå_æags
);

410 ià(
»g
->
Œª¥Üt_id
 =ð
NULL
) {

411 
	`PRINT_ERROR
("%s", "Unableo‡llocate initiator…ort "

413 
out_ä“
;

415 
	`memýy
(
»g
->
Œª¥Üt_id
,¿n¥Üt_id, 
	`tid_size
(transport_id));

417 
»g
->
»l_tgt_id
 =„el_tgt_id;

418 
»g
->
key
 = key;

424 ià(!
dev_lock_locked
)

425 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

426 
	`li¡_fÜ_—ch_’Œy
(
t
, &
dev
->
dev_tgt_dev_li¡
, 
dev_tgt_dev_li¡_’Œy
) {

427 ià(
	`tid_equ®
(
t
->
£ss
->
Œª¥Üt_id
,ransport_id) &&

428 (
t
->
£ss
->
tgt
->
»l_tgt_id
 ==„el_tgt_id) &&

429 (
t
->
»gi¡¿Á
 =ð
NULL
)) {

434 
	`TRACE_PR
("Foundgt_dev %p", 
t
);

435 
»g
->
tgt_dev
 = 
t
;

436 
t
->
»gi¡¿Á
 = 
»g
;

440 ià(!
dev_lock_locked
)

441 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

443 
	`li¡_add_ž
(&
»g
->
dev_»gi¡¿Ás_li¡_’Œy
,

444 &
dev
->
dev_»gi¡¿Ás_li¡
);

446 
	`TRACE_PR
("Reg %°»gi¡”ed (dev %s,gt_dev %p)", 
»g
,

447 
dev
->
vœt_Çme
, 
»g
->
tgt_dev
);

449 
out
:

450 
	`TRACE_EXIT_HRES
(()
»g
);

451  
»g
;

453 
out_ä“
:

454 
	`kä“
(
»g
);

455 
»g
 = 
NULL
;

456 
out
;

457 
	}
}

460 
	$sc¡_´_»move_»gi¡¿Á
(
sc¡_deviû
 *
dev
,

461 
sc¡_dev_»gi¡¿Á
 *
»g
)

463 
	`TRACE_ENTRY
();

465 
	`TRACE_PR
("Removing„egistrant %s/%d (reg %p,gt_dev %p, key %016llx, "

466 "dev %s)", 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

467 
»g
->
»l_tgt_id
,„eg,„eg->
tgt_dev
,„eg->
key
, 
dev
->
vœt_Çme
);

469 
	`li¡_d–
(&
»g
->
dev_»gi¡¿Ás_li¡_’Œy
);

471 ià(
	`sc¡_´_is_hÞd”
(
dev
, 
»g
))

472 
	`sc¡_´_þ—r_hÞd”
(
dev
);

474 ià(
»g
->
tgt_dev
)

475 
»g
->
tgt_dev
->
»gi¡¿Á
 = 
NULL
;

477 
	`kä“
(
»g
->
Œª¥Üt_id
);

478 
	`kä“
(
»g
);

480 
	`TRACE_EXIT
();

482 
	}
}

485 
	$sc¡_´_£nd_ua_»g
(
sc¡_deviû
 *
dev
,

486 
sc¡_dev_»gi¡¿Á
 *
»g
,

487 
key
, 
asc
, 
ascq
)

489 
ušt8_t
 
ua
[
SCST_STANDARD_SENSE_LEN
];

491 
	`TRACE_ENTRY
();

493 
	`sc¡_£t_£n£
(
ua
, (ua), 
dev
->
d_£n£
, 
key
, 
asc
, 
ascq
);

495 
	`TRACE_PR
("Queueing UA [%x %x %x]:„egistrant %s/%d (%p),gt_dev %p, "

496 "key %016Îx", 
ua
[2], ua[12], ua[13],

497 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

498 
»g
->
»l_tgt_id
,„eg,„eg->
tgt_dev
,„eg->
key
);

500 ià(
»g
->
tgt_dev
)

501 
	`sc¡_check_£t_UA
(
»g
->
tgt_dev
, 
ua
, (ua), 0);

503 
	`TRACE_EXIT
();

505 
	}
}

508 
	$sc¡_´_£nd_ua_®l
(
sc¡_deviû
 *
dev
,

509 
sc¡_dev_»gi¡¿Á
 *
exþude_»g
,

510 
key
, 
asc
, 
ascq
)

512 
sc¡_dev_»gi¡¿Á
 *
»g
;

514 
	`TRACE_ENTRY
();

516 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

517 
dev_»gi¡¿Ás_li¡_’Œy
) {

518 ià(
»g
 !ð
exþude_»g
)

519 
	`sc¡_´_£nd_ua_»g
(
dev
, 
»g
, 
key
, 
asc
, 
ascq
);

522 
	`TRACE_EXIT
();

524 
	}
}

527 
	$sc¡_´_abÜt_»g
(
sc¡_deviû
 *
dev
,

528 
sc¡_cmd
 *
´_cmd
, 
sc¡_dev_»gi¡¿Á
 *
»g
)

530 
sc¡_£ssiÚ
 *
£ss
;

531 
__be64
 
·cked_lun
;

532 
rc
;

534 
	`TRACE_ENTRY
();

536 ià(
»g
->
tgt_dev
 =ð
NULL
) {

537 
	`TRACE_PR
("Registrant %s/%d (%p, key 0x%016llx) has‚o session",

538 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

539 
»g
->
»l_tgt_id
,„eg,„eg->
key
);

540 
out
;

543 
£ss
 = 
»g
->
tgt_dev
->sess;

545 
	`TRACE_PR
("Aborting %d commands for %s/%d (reg %p, key 0x%016llx, "

547 
	`©omic_»ad
(&
»g
->
tgt_dev
->
tgt_dev_cmd_couÁ
),

548 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

549 
»g
->
»l_tgt_id
,„eg,„eg->
key
,„eg->
tgt_dev
, 
£ss
);

551 
·cked_lun
 = 
	`sc¡_·ck_lun
(
»g
->
tgt_dev
->
lun
, 
£ss
->
acg
->
addr_m‘hod
);

553 
rc
 = 
	`sc¡_rx_mgmt_â_lun
(
£ss
, 
SCST_PR_ABORT_ALL
,

554 (
ušt8_t
 *)&
·cked_lun
, Õacked_lun), 
SCST_NON_ATOMIC
,

555 
´_cmd
);

556 ià(
rc
 != 0) {

561 
	`PRINT_ERROR
("SCST_PR_ABORT_ALL failed %d (sess %p)",

562 
rc
, 
£ss
);

565 
out
:

566 
	`TRACE_EXIT
();

568 
	}
}

570 #iâdeà
CONFIG_SCST_PROC


573 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 39)

574 
šlše
 
	$sc¡_´_vfs_uÆšk_ªd_put
(
Çmeid©a
 *
nd
)

576 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2,6,25)

577 
	`vfs_uÆšk
(
nd
->
d’Œy
->
d_·»Á
->
d_šode
,‚d->dentry);

578 
	`dput
(
nd
->
d’Œy
);

579 
	`mÁput
(
nd
->
mÁ
);

581 
	`vfs_uÆšk
(
nd
->
·th
.
d’Œy
->
d_·»Á
->
d_šode
,

582 
nd
->
·th
.
d’Œy
);

583 
	`·th_put
(&
nd
->
·th
);

585 
	}
}

587 
šlše
 
	$sc¡_´_vfs_uÆšk_ªd_put
(
·th
 *path)

589 
	`vfs_uÆšk
(
·th
->
d’Œy
->
d_·»Á
->
d_šode
,…ath->dentry);

590 
	`·th_put
(
·th
);

591 
	}
}

594 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 39)

595 
šlše
 
	$sc¡_´_·th_put
(
Çmeid©a
 *
nd
)

597 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2,6,25)

598 
	`dput
(
nd
->
d’Œy
);

599 
	`mÁput
(
nd
->
mÁ
);

601 
	`·th_put
(&
nd
->
·th
);

603 
	}
}

606 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 29)

607 
	$sc¡_´_vfs_fsync
(
fže
 *fže, 
loff_t
 
loff
,†off_ˆ
Ën
)

609 
»s
;

611 
»s
 = 
	`sync_·ge_¿nge
(
fže
->
f_d’Œy
->
d_šode
, fže->
f_m­pšg
,

612 
loff
, 
Ën
);

613  
»s
;

614 
	}
}

618 
	$sc¡_´_do_lßd_deviû_fže
(
sc¡_deviû
 *
dev
,

619 cÚ¡ *
fže_Çme
)

621 
»s
 = 0, 
rc
;

622 
fže
 *fžð
NULL
;

623 
šode
 *inode;

624 *
buf
 = 
NULL
;

625 
loff_t
 
fže_size
, 
pos
, 
d©a_size
;

626 
ušt64_t
 
sign
, 
v”siÚ
;

627 
mm_£gm’t_t
 
Þd_fs
;

628 
ušt8_t
 
´_is_£t
, 
­l
;

629 
__be64
 
key
;

630 
ušt16_t
 
»l_tgt_id
;

632 
	`TRACE_ENTRY
();

634 
Þd_fs
 = 
	`g‘_fs
();

635 
	`£t_fs
(
KERNEL_DS
);

637 
	`TRACE_PR
("Lßdšg…”si¡’ˆfž'%s'", 
fže_Çme
);

639 
fže
 = 
	`fžp_Ý’
(
fže_Çme
, 
O_RDONLY
, 0);

640 ià(
	`IS_ERR
(
fže
)) {

641 
»s
 = 
	`PTR_ERR
(
fže
);

642 
	`TRACE_PR
("UÇbËØÝ’ fž'%s' -ƒ¼Ü %d", 
fže_Çme
, 
»s
);

643 
out
;

646 
šode
 = 
fže
->
f_d’Œy
->
d_šode
;

648 ià(
	`S_ISREG
(
šode
->
i_mode
))

650 ià(
	`S_ISBLK
(
šode
->
i_mode
))

651 
šode
 = inode->
i_bdev
->
bd_šode
;

653 
	`PRINT_ERROR
("Inv®id fžmod0x%x", 
šode
->
i_mode
);

654 
out_þo£
;

657 
fže_size
 = 
šode
->
i_size
;

660 ià((
fže_size
 == 0) || (file_size >= 15*1024*1024)) {

661 
	`PRINT_ERROR
("Inv®id PR fžsiz%d", ()
fže_size
);

662 
»s
 = -
EINVAL
;

663 
out_þo£
;

666 
buf
 = 
	`vm®loc
(
fže_size
);

667 ià(
buf
 =ð
NULL
) {

668 
»s
 = -
ENOMEM
;

669 
	`PRINT_ERROR
("%s", "Unableo‡llocate buffer");

670 
out_þo£
;

673 
pos
 = 0;

674 
rc
 = 
	`vfs_»ad
(
fže
, (
__fÜû
 
__u£r
 *)
buf
, 
fže_size
, &
pos
);

675 ià(
rc
 !ð
fže_size
) {

676 
	`PRINT_ERROR
("UÇbËØ»ad fž'%s' -ƒ¼Ü %d", 
fže_Çme
,

677 
rc
);

678 
»s
 = 
rc
;

679 
out_þo£
;

682 
d©a_size
 = 0;

683 
d©a_size
 +ð(
sign
);

684 
d©a_size
 +ð(
v”siÚ
);

685 
d©a_size
 +ð(
­l
);

686 
d©a_size
 +ð(
´_is_£t
);

687 
d©a_size
 +ð(
dev
->
´_ty³
);

688 
d©a_size
 +ð(
dev
->
´_scÝe
);

690 ià(
fže_size
 < 
d©a_size
) {

691 
»s
 = -
EINVAL
;

692 
	`PRINT_ERROR
("Inv®id fž'%s' - siztoØsm®l", 
fže_Çme
);

693 
out_þo£
;

696 
pos
 = 0;

698 
sign
 = 
	`g‘_uÇligÃd
((
ušt64_t
 *)&
buf
[
pos
]);

699 ià(
sign
 !ð
SCST_PR_FILE_SIGN
) {

700 
»s
 = -
EINVAL
;

701 
	`PRINT_ERROR
("Invalid…ersistent file signature %016llx "

702 "Óx³ùed %016Îx)", 
sign
, 
SCST_PR_FILE_SIGN
);

703 
out_þo£
;

705 
pos
 +ð(
sign
);

707 
v”siÚ
 = 
	`g‘_uÇligÃd
((
ušt64_t
 *)&
buf
[
pos
]);

708 ià(
v”siÚ
 !ð
SCST_PR_FILE_VERSION
) {

709 
»s
 = -
EINVAL
;

710 
	`PRINT_ERROR
("Invalid…ersistent file version %016llx "

711 "Óx³ùed %016Îx)", 
v”siÚ
, 
SCST_PR_FILE_VERSION
);

712 
out_þo£
;

714 
pos
 +ð(
v”siÚ
);

716 
d©a_size
 < 
fže_size
) {

717 
ušt8_t
 *
tid
;

719 
d©a_size
++;

720 
tid
 = &
buf
[
d©a_size
];

721 
d©a_size
 +ð
	`tid_size
(
tid
);

722 
d©a_size
 +ð(
key
);

723 
d©a_size
 +ð(
»l_tgt_id
);

725 ià(
d©a_size
 > 
fže_size
) {

726 
»s
 = -
EINVAL
;

727 
	`PRINT_ERROR
("Invalid file '%s' - size mismatch have "

728 "%Îdƒx³ùed %Îd", 
fže_Çme
, 
fže_size
,

729 
d©a_size
);

730 
out_þo£
;

734 
­l
 = 
buf
[
pos
];

735 
dev
->
´_­l
 = 
­l
 ? 1 : 0;

736 
pos
 +ð(
­l
);

738 
´_is_£t
 = 
buf
[
pos
];

739 
dev
->
´_is_£t
 =…r_is_set ? 1 : 0;

740 
pos
 +ð(
´_is_£t
);

742 
dev
->
´_ty³
 = 
buf
[
pos
];

743 
pos
 +ð(
dev
->
´_ty³
);

745 
dev
->
´_scÝe
 = 
buf
[
pos
];

746 
pos
 +ð(
dev
->
´_scÝe
);

748 
pos
 < 
fže_size
) {

749 
ušt8_t
 
is_hÞd”
;

750 
ušt8_t
 *
tid
;

751 
sc¡_dev_»gi¡¿Á
 *
»g
 = 
NULL
;

753 
is_hÞd”
 = 
buf
[
pos
++];

755 
tid
 = &
buf
[
pos
];

756 
pos
 +ð
	`tid_size
(
tid
);

758 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
buf
[
pos
]);

759 
pos
 +ð(
key
);

761 
»l_tgt_id
 = 
	`g‘_uÇligÃd
((
ušt16_t
 *)&
buf
[
pos
]);

762 
pos
 +ð(
»l_tgt_id
);

764 
»g
 = 
	`sc¡_´_add_»gi¡¿Á
(
dev
, 
tid
, 
»l_tgt_id
, 
key
, 
çl£
);

765 ià(
»g
 =ð
NULL
) {

766 
»s
 = -
ENOMEM
;

767 
out_þo£
;

770 ià(
is_hÞd”
)

771 
dev
->
´_hÞd”
 = 
»g
;

774 
out_þo£
:

775 
	`fžp_þo£
(
fže
, 
NULL
);

777 
out
:

778 ià(
buf
 !ð
NULL
)

779 
	`vä“
(
buf
);

781 
	`£t_fs
(
Þd_fs
);

783 
	`TRACE_EXIT_RES
(
»s
);

784  
»s
;

785 
	}
}

787 
	$sc¡_´_lßd_deviû_fže
(
sc¡_deviû
 *
dev
)

789 
»s
;

791 
	`TRACE_ENTRY
();

793 ià(
dev
->
´_fže_Çme
 =ð
NULL
 || dev->
´_fže_Çme1
 == NULL) {

794 
	`PRINT_ERROR
("Inv®id fž·th fÜ '%s'", 
dev
->
vœt_Çme
);

795 
»s
 = -
EINVAL
;

796 
out
;

799 
»s
 = 
	`sc¡_´_do_lßd_deviû_fže
(
dev
, dev->
´_fže_Çme
);

800 ià(
»s
 == 0)

801 
out
;

802 ià(
»s
 =ð-
ENOMEM
)

803 
out
;

805 
»s
 = 
	`sc¡_´_do_lßd_deviû_fže
(
dev
, dev->
´_fže_Çme1
);

807 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

809 
out
:

810 
	`TRACE_EXIT_RES
(
»s
);

811  
»s
;

812 
	}
}

814 
	$sc¡_´_cÝy_fže
(cÚ¡ *
¤c
, cÚ¡ *
de¡
)

816 
»s
 = 0;

817 
šode
 *inode;

818 
loff_t
 
fže_size
, 
pos
;

819 
ušt8_t
 *
buf
 = 
NULL
;

820 
fže
 *
fže_¤c
 = 
NULL
, *
fže_de¡
 = NULL;

821 
mm_£gm’t_t
 
Þd_fs
 = 
	`g‘_fs
();

823 
	`TRACE_ENTRY
();

825 ià(
¤c
 =ð
NULL
 || 
de¡
 == NULL) {

826 
»s
 = -
EINVAL
;

827 
	`PRINT_ERROR
("%s", "Invalid…ersistent files…ath - backup "

829 
out
;

832 
	`TRACE_PR
("CÝyšg '%s' iÁØ'%s'", 
¤c
, 
de¡
);

834 
	`£t_fs
(
KERNEL_DS
);

836 
fže_¤c
 = 
	`fžp_Ý’
(
¤c
, 
O_RDONLY
, 0);

837 ià(
	`IS_ERR
(
fže_¤c
)) {

838 
»s
 = 
	`PTR_ERR
(
fže_¤c
);

839 
	`TRACE_PR
("UÇbËØÝ’ fž'%s' -ƒ¼Ü %d", 
¤c
,

840 
»s
);

841 
out_ä“
;

844 
fže_de¡
 = 
	`fžp_Ý’
(
de¡
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

845 ià(
	`IS_ERR
(
fže_de¡
)) {

846 
»s
 = 
	`PTR_ERR
(
fže_de¡
);

847 
	`TRACE_PR
("UÇbËØÝ’ backu°fž'%s' -ƒ¼Ü %d", 
de¡
,

848 
»s
);

849 
out_þo£
;

852 
šode
 = 
fže_¤c
->
f_d’Œy
->
d_šode
;

854 ià(
	`S_ISREG
(
šode
->
i_mode
))

856 ià(
	`S_ISBLK
(
šode
->
i_mode
))

857 
šode
 = inode->
i_bdev
->
bd_šode
;

859 
	`PRINT_ERROR
("Inv®id fžmod0x%x", 
šode
->
i_mode
);

860 
»s
 = -
EINVAL
;

861 
	`£t_fs
(
Þd_fs
);

862 
out_sk
;

865 
fže_size
 = 
šode
->
i_size
;

867 
buf
 = 
	`vm®loc
(
fže_size
);

868 ià(
buf
 =ð
NULL
) {

869 
»s
 = -
ENOMEM
;

870 
	`PRINT_ERROR
("%s", "Unableo‡llocateemporary buffer");

871 
out_sk
;

874 
pos
 = 0;

875 
»s
 = 
	`vfs_»ad
(
fže_¤c
, (
__fÜû
 
__u£r
 *)
buf
, 
fže_size
, &
pos
);

876 ià(
»s
 !ð
fže_size
) {

877 
	`PRINT_ERROR
("UÇbËØ»ad fž'%s' -ƒ¼Ü %d", 
¤c
, 
»s
);

878 
out_sk
;

881 
pos
 = 0;

882 
»s
 = 
	`vfs_wr™e
(
fže_de¡
, (
__fÜû
 
__u£r
 *)
buf
, 
fže_size
, &
pos
);

883 ià(
»s
 !ð
fže_size
) {

884 
	`PRINT_ERROR
("UÇbËØwr™tØ'%s' -ƒ¼Ü %d", 
de¡
, 
»s
);

885 
out_sk
;

888 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 29)

889 
»s
 = 
	`sc¡_´_vfs_fsync
(
fže_de¡
, 0, 
fže_size
);

890 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 35)

891 
»s
 = 
	`vfs_fsync
(
fže_de¡
, fže_de¡->
f_·th
.
d’Œy
, 0);

893 
»s
 = 
	`vfs_fsync
(
fže_de¡
, 0);

895 ià(
»s
 != 0) {

896 
	`PRINT_ERROR
("fsync(èoàthbacku°PR fžçžed: %d", 
»s
);

897 
out_sk
;

900 
out_sk
:

901 
	`fžp_þo£
(
fže_de¡
, 
NULL
);

903 
out_þo£
:

904 
	`fžp_þo£
(
fže_¤c
, 
NULL
);

906 
out_ä“
:

907 ià(
buf
 !ð
NULL
)

908 
	`vä“
(
buf
);

910 
	`£t_fs
(
Þd_fs
);

912 
out
:

913 
	`TRACE_EXIT_RES
(
»s
);

914  
»s
;

915 
	}
}

917 
	$sc¡_´_»move_deviû_fžes
(
sc¡_tgt_dev
 *
tgt_dev
)

919 
»s
 = 0;

920 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

921 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

922 
Çmeid©a
 
nd
;

924 
·th
…ath;

926 
mm_£gm’t_t
 
Þd_fs
 = 
	`g‘_fs
();

928 
	`TRACE_ENTRY
();

930 
	`£t_fs
(
KERNEL_DS
);

932 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

933 
»s
 = 
dev
->
´_fže_Çme
 ? 
	`·th_lookup
(dev->´_fže_Çme, 0, &
nd
) :

934 -
ENOENT
;

935 ià(!
»s
)

936 
	`sc¡_´_vfs_uÆšk_ªd_put
(&
nd
);

938 
	`TRACE_DBG
("Unableo†ookup file '%s' -ƒrror %d",

939 
dev
->
´_fže_Çme
, 
»s
);

941 
»s
 = 
dev
->
´_fže_Çme1
 ? 
	`·th_lookup
(dev->´_fže_Çme1, 0, &
nd
) :

942 -
ENOENT
;

943 ià(!
»s
)

944 
	`sc¡_´_vfs_uÆšk_ªd_put
(&
nd
);

946 
	`TRACE_DBG
("Unableo†ookup file '%s' -ƒrror %d",

947 
dev
->
´_fže_Çme1
, 
»s
);

949 
»s
 = 
dev
->
´_fže_Çme
 ? 
	`k”n_·th
(dev->´_fže_Çme, 0, &
·th
) :

950 -
ENOENT
;

951 ià(!
»s
)

952 
	`sc¡_´_vfs_uÆšk_ªd_put
(&
·th
);

954 
	`TRACE_DBG
("Unableo†ookup file '%s' -ƒrror %d",

955 
dev
->
´_fže_Çme
, 
»s
);

957 
»s
 = 
dev
->
´_fže_Çme1
 ? 
	`k”n_·th
(dev->´_fže_Çme1, 0, &
·th
) :

958 -
ENOENT
;

959 ià(!
»s
)

960 
	`sc¡_´_vfs_uÆšk_ªd_put
(&
·th
);

962 
	`TRACE_DBG
("Unableo†ookup file '%s' -ƒrror %d",

963 
dev
->
´_fže_Çme1
, 
»s
);

966 
	`£t_fs
(
Þd_fs
);

968 
	`TRACE_EXIT
();

970 
	}
}

973 
	$sc¡_´_sync_deviû_fže
(
sc¡_tgt_dev
 *
tgt_dev
, 
sc¡_cmd
 *
cmd
)

975 
»s
 = 0;

976 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

977 
fže
 *file;

978 
mm_£gm’t_t
 
Þd_fs
 = 
	`g‘_fs
();

979 
loff_t
 
pos
 = 0;

980 
ušt64_t
 
sign
;

981 
ušt64_t
 
v”siÚ
;

982 
ušt8_t
 
´_is_£t
, 
­l
;

984 
	`TRACE_ENTRY
();

986 ià((
dev
->
´_­l
 =ð0è|| 
	`li¡_em±y
(&dev->
dev_»gi¡¿Ás_li¡
)) {

987 
	`sc¡_´_»move_deviû_fžes
(
tgt_dev
);

988 
out
;

991 
	`sc¡_´_cÝy_fže
(
dev
->
´_fže_Çme
, dev->
´_fže_Çme1
);

993 
	`£t_fs
(
KERNEL_DS
);

995 
fže
 = 
	`fžp_Ý’
(
dev
->
´_fže_Çme
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

996 ià(
	`IS_ERR
(
fže
)) {

997 
»s
 = 
	`PTR_ERR
(
fže
);

998 
	`PRINT_ERROR
("Unableo (re)create PR file '%s' -ƒrror %d",

999 
dev
->
´_fže_Çme
, 
»s
);

1000 
out_£t_fs
;

1003 
	`TRACE_PR
("Upd©šg…¸fž'%s'", 
dev
->
´_fže_Çme
);

1008 
sign
 = 0;

1009 
pos
 = 0;

1010 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
sign
, (sign), &
pos
);

1011 ià(
»s
 !ð(
sign
))

1012 
wr™e_”rÜ
;

1017 
v”siÚ
 = 
SCST_PR_FILE_VERSION
;

1018 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
v”siÚ
, (v”siÚ), &
pos
);

1019 ià(
»s
 !ð(
v”siÚ
))

1020 
wr™e_”rÜ
;

1025 
­l
 = 
dev
->
´_­l
;

1026 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
­l
, ×±¶), &
pos
);

1027 ià(
»s
 !ð(
­l
))

1028 
wr™e_”rÜ
;

1033 
´_is_£t
 = 
dev
->pr_is_set;

1034 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
´_is_£t
, Õr_is_£t), &
pos
);

1035 ià(
»s
 !ð(
´_is_£t
))

1036 
wr™e_”rÜ
;

1038 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
dev
->
´_ty³
, (dev->´_ty³), &
pos
);

1039 ià(
»s
 !ð(
dev
->
´_ty³
))

1040 
wr™e_”rÜ
;

1042 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
dev
->
´_scÝe
, (dev->´_scÝe), &
pos
);

1043 ià(
»s
 !ð(
dev
->
´_scÝe
))

1044 
wr™e_”rÜ
;

1049 ià(!
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
)) {

1050 
sc¡_dev_»gi¡¿Á
 *
»g
;

1052 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

1053 
dev_»gi¡¿Ás_li¡_’Œy
) {

1054 
ušt8_t
 
is_hÞd”
 = 0;

1055 
size
;

1057 
is_hÞd”
 = (
dev
->
´_hÞd”
 =ð
»g
);

1059 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
is_hÞd”
, (is_holder),

1060 &
pos
);

1061 ià(
»s
 !ð(
is_hÞd”
))

1062 
wr™e_”rÜ
;

1064 
size
 = 
	`tid_size
(
»g
->
Œª¥Üt_id
);

1065 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)
»g
->
Œª¥Üt_id
, 
size
, &
pos
);

1066 ià(
»s
 !ð
size
)

1067 
wr™e_”rÜ
;

1069 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
»g
->
key
,

1070 (
»g
->
key
), &
pos
);

1071 ià(
»s
 !ð(
»g
->
key
))

1072 
wr™e_”rÜ
;

1074 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
»g
->
»l_tgt_id
,

1075 (
»g
->
»l_tgt_id
), &
pos
);

1076 ià(
»s
 !ð(
»g
->
»l_tgt_id
))

1077 
wr™e_”rÜ
;

1081 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 29)

1082 
»s
 = 
	`sc¡_´_vfs_fsync
(
fže
, 0, 
pos
);

1083 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 35)

1084 
»s
 = 
	`vfs_fsync
(
fže
, fže->
f_·th
.
d’Œy
, 0);

1086 
»s
 = 
	`vfs_fsync
(
fže
, 0);

1088 ià(
»s
 != 0) {

1089 
	`PRINT_ERROR
("fsync(èoàthPR fžçžed: %d", 
»s
);

1090 
wr™e_”rÜ_þo£
;

1093 
sign
 = 
SCST_PR_FILE_SIGN
;

1094 
pos
 = 0;

1095 
»s
 = 
	`vfs_wr™e
(
fže
, (
__fÜû
 
__u£r
 *)&
sign
, (sign), &
pos
);

1096 ià(
»s
 !ð(
sign
))

1097 
wr™e_”rÜ
;

1099 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 29)

1100 
»s
 = 
	`sc¡_´_vfs_fsync
(
fže
, 0, (
sign
));

1101 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 35)

1102 
»s
 = 
	`vfs_fsync
(
fže
, fže->
f_·th
.
d’Œy
, 0);

1104 
»s
 = 
	`vfs_fsync
(
fže
, 0);

1106 ià(
»s
 != 0) {

1107 
	`PRINT_ERROR
("fsync(èoàthPR fžçžed: %d", 
»s
);

1108 
wr™e_”rÜ_þo£
;

1111 
»s
 = 0;

1113 
	`fžp_þo£
(
fže
, 
NULL
);

1115 
out_£t_fs
:

1116 
	`£t_fs
(
Þd_fs
);

1118 
out
:

1119 ià(
»s
 != 0) {

1120 
	`PRINT_CRIT_ERROR
("Unableo save…ersistent information "

1122 
tgt_dev
->
£ss
->
tgt
->
tgt_Çme
,

1123 
tgt_dev
->
£ss
->
š™ŸtÜ_Çme
, 
dev
->
vœt_Çme
);

1130 ià(
cmd
 !ð
NULL
)

1131 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1135 
	`TRACE_EXIT_RES
(
»s
);

1138 
wr™e_”rÜ
:

1139 
	`PRINT_ERROR
("E¼Ü wr™šgØ'%s' -ƒ¼Ü %d", 
dev
->
´_fže_Çme
, 
»s
);

1141 
wr™e_”rÜ_þo£
:

1142 
	`fžp_þo£
(
fže
, 
NULL
);

1143 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

1145 
Çmeid©a
 
nd
;

1146 
rc
;

1148 
rc
 = 
	`·th_lookup
(
dev
->
´_fže_Çme
, 0, &
nd
);

1149 ià(!
rc
)

1150 
	`sc¡_´_vfs_uÆšk_ªd_put
(&
nd
);

1152 
	`TRACE_PR
("Unableo†ookup '%s' -ƒrror %d",

1153 
dev
->
´_fže_Çme
, 
rc
);

1157 
·th
…ath;

1158 
rc
;

1160 
rc
 = 
	`k”n_·th
(
dev
->
´_fže_Çme
, 0, &
·th
);

1161 ià(!
rc
)

1162 
	`sc¡_´_vfs_uÆšk_ªd_put
(&
·th
);

1164 
	`TRACE_PR
("Unableo†ookup '%s' -ƒrror %d",

1165 
dev
->
´_fže_Çme
, 
rc
);

1168 
out_£t_fs
;

1169 
	}
}

1171 
	$sc¡_´_check_´_·th
()

1173 
»s
;

1174 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

1175 
Çmeid©a
 
nd
;

1177 
·th
…ath;

1180 
mm_£gm’t_t
 
Þd_fs
 = 
	`g‘_fs
();

1182 
	`TRACE_ENTRY
();

1184 
	`£t_fs
(
KERNEL_DS
);

1186 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

1187 
»s
 = 
	`·th_lookup
(
SCST_PR_DIR
, 0, &
nd
);

1188 ià(
»s
 == 0)

1189 
	`sc¡_´_·th_put
(&
nd
);

1191 
»s
 = 
	`k”n_·th
(
SCST_PR_DIR
, 0, &
·th
);

1192 ià(
»s
 == 0)

1193 
	`·th_put
(&
·th
);

1195 ià(
»s
 != 0) {

1196 
	`PRINT_ERROR
("Unableo find %s (err %d), you should create "

1198 
SCST_PR_DIR
, 
»s
);

1199 
out_£tfs
;

1202 
out_£tfs
:

1203 
	`£t_fs
(
Þd_fs
);

1205 
	`TRACE_EXIT_RES
(
»s
);

1206  
»s
;

1207 
	}
}

1212 
	$sc¡_´_š™_dev
(
sc¡_deviû
 *
dev
)

1214 
»s
 = 0;

1215 
ušt8_t
 
q
;

1216 
Çme_Ën
;

1218 
	`TRACE_ENTRY
();

1220 
Çme_Ën
 = 
	`¢´štf
(&
q
, (q), "%s/%s", 
SCST_PR_DIR
, 
dev
->
vœt_Çme
) + 1;

1221 
dev
->
´_fže_Çme
 = 
	`km®loc
(
Çme_Ën
, 
GFP_KERNEL
);

1222 ià(
dev
->
´_fže_Çme
 =ð
NULL
) {

1223 
	`PRINT_ERROR
("Allocation of device '%s' file…ath failed",

1224 
dev
->
vœt_Çme
);

1225 
»s
 = -
ENOMEM
;

1226 
out
;

1228 
	`¢´štf
(
dev
->
´_fže_Çme
, 
Çme_Ën
, "%s/%s", 
SCST_PR_DIR
,

1229 
dev
->
vœt_Çme
);

1231 
Çme_Ën
 = 
	`¢´štf
(&
q
, (q), "%s/%s.1", 
SCST_PR_DIR
, 
dev
->
vœt_Çme
) + 1;

1232 
dev
->
´_fže_Çme1
 = 
	`km®loc
(
Çme_Ën
, 
GFP_KERNEL
);

1233 ià(
dev
->
´_fže_Çme1
 =ð
NULL
) {

1234 
	`PRINT_ERROR
("Allocation of device '%s' backup file…ath failed",

1235 
dev
->
vœt_Çme
);

1236 
»s
 = -
ENOMEM
;

1237 
out_ä“_Çme
;

1239 
	`¢´štf
(
dev
->
´_fže_Çme1
, 
Çme_Ën
, "%s/%s.1", 
SCST_PR_DIR
,

1240 
dev
->
vœt_Çme
);

1242 #iâdeà
CONFIG_SCST_PROC


1243 
»s
 = 
	`sc¡_´_check_´_·th
();

1244 ià(
»s
 == 0) {

1245 
»s
 = 
	`sc¡_´_lßd_deviû_fže
(
dev
);

1246 ià(
»s
 =ð-
ENOENT
)

1247 
»s
 = 0;

1251 ià(
»s
 != 0)

1252 
out_ä“_Çme1
;

1254 
out
:

1255 
	`TRACE_EXIT_RES
(
»s
);

1256  
»s
;

1258 
out_ä“_Çme1
:

1259 
	`kä“
(
dev
->
´_fže_Çme1
);

1260 
dev
->
´_fže_Çme1
 = 
NULL
;

1262 
out_ä“_Çme
:

1263 
	`kä“
(
dev
->
´_fže_Çme
);

1264 
dev
->
´_fže_Çme
 = 
NULL
;

1265 
out
;

1266 
	}
}

1269 
	$sc¡_´_þ—r_dev
(
sc¡_deviû
 *
dev
)

1271 
sc¡_dev_»gi¡¿Á
 *
»g
, *
tmp_»g
;

1273 
	`TRACE_ENTRY
();

1275 
	`li¡_fÜ_—ch_’Œy_§ã
(
»g
, 
tmp_»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

1276 
dev_»gi¡¿Ás_li¡_’Œy
) {

1277 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
»g
);

1280 
	`kä“
(
dev
->
´_fže_Çme
);

1281 
	`kä“
(
dev
->
´_fže_Çme1
);

1283 
	`TRACE_EXIT
();

1285 
	}
}

1288 
	$sc¡_´_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

1290 
»s
 = 0;

1291 
sc¡_dev_»gi¡¿Á
 *
»g
;

1292 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

1293 cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
 = 
tgt_dev
->
£ss
->transport_id;

1294 cÚ¡ 
ušt16_t
 
»l_tgt_id
 = 
tgt_dev
->
£ss
->
tgt
->rel_tgt_id;

1296 
	`TRACE_ENTRY
();

1298 ià(
tgt_dev
->
£ss
->
Œª¥Üt_id
 =ð
NULL
)

1299 
out
;

1301 
	`sc¡_´_wr™e_lock
(
dev
);

1303 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
, 
Œª¥Üt_id
, 
»l_tgt_id
);

1304 ià((
»g
 !ð
NULL
è&& (»g->
tgt_dev
 == NULL)) {

1305 
	`TRACE_PR
("Assigning„eg %s/%d (%p)ogt_dev %p (dev %s)",

1306 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
Œª¥Üt_id
),

1307 
»l_tgt_id
, 
»g
, 
tgt_dev
, 
dev
->
vœt_Çme
);

1308 
tgt_dev
->
»gi¡¿Á
 = 
»g
;

1309 
»g
->
tgt_dev
 =gt_dev;

1312 
	`sc¡_´_wr™e_uÆock
(
dev
);

1314 
out
:

1315 
	`TRACE_EXIT_RES
(
»s
);

1316  
»s
;

1317 
	}
}

1320 
	$sc¡_´_þ—r_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
)

1322 
	`TRACE_ENTRY
();

1324 ià(
tgt_dev
->
»gi¡¿Á
 !ð
NULL
) {

1325 
sc¡_dev_»gi¡¿Á
 *
»g
 = 
tgt_dev
->
»gi¡¿Á
;

1326 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

1327 
sc¡_tgt_dev
 *
t
;

1329 
	`sc¡_´_wr™e_lock
(
dev
);

1331 
tgt_dev
->
»gi¡¿Á
 = 
NULL
;

1332 
»g
->
tgt_dev
 = 
NULL
;

1335 
	`li¡_fÜ_—ch_’Œy
(
t
, &
dev
->
dev_tgt_dev_li¡
,

1336 
dev_tgt_dev_li¡_’Œy
) {

1337 ià(
t
 =ð
tgt_dev
)

1339 ià((
t
->
£ss
->
tgt
->
»l_tgt_id
 =ð
»g
->rel_tgt_id) &&

1340 
	`tid_equ®
(
t
->
£ss
->
Œª¥Üt_id
, 
»g
->transport_id)) {

1341 
	`TRACE_PR
("Reassigning„eg %s/%d (%p)ogt_dev "

1343 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

1344 
»g
->
Œª¥Üt_id
),

1345 
»g
->
»l_tgt_id
,„eg, 
t
, 
tgt_dev
);

1346 
t
->
»gi¡¿Á
 = 
»g
;

1347 
»g
->
tgt_dev
 = 
t
;

1352 
	`sc¡_´_wr™e_uÆock
(
dev
);

1355 
	`TRACE_EXIT
();

1357 
	}
}

1360 
	$sc¡_´_»gi¡”_w™h_¥ec_i_±
(
sc¡_cmd
 *
cmd
,

1361 cÚ¡ 
ušt16_t
 
»l_tgt_id
, 
ušt8_t
 *
bufãr
, 
bufãr_size
,

1362 
li¡_h—d
 *
rÞlback_li¡
)

1364 
»s
 = 0;

1365 
off£t
, 
ext_size
;

1366 
__be64
 
aùiÚ_key
;

1367 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1368 
sc¡_dev_»gi¡¿Á
 *
»g
;

1369 
ušt8_t
 *
Œª¥Üt_id
;

1371 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

1373 
ext_size
 = 
	`be32_to_ýu
(
	`g‘_uÇligÃd
((
__be32
 *)&
bufãr
[24]));

1374 ià((
ext_size
 + 28è> 
bufãr_size
) {

1375 
	`TRACE_PR
("Inv®id bufã¸siz%d (max %d)", 
bufãr_size
,

1376 
ext_size
 + 28);

1377 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1378 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

1379 
»s
 = -
EINVAL
;

1380 
out
;

1383 
off£t
 = 0;

1384 
off£t
 < 
ext_size
) {

1385 
Œª¥Üt_id
 = &
bufãr
[28 + 
off£t
];

1387 ià((
off£t
 + 
	`tid_size
(
Œª¥Üt_id
)è> 
ext_size
) {

1388 
	`TRACE_PR
("Invalidransport_id size %d (max %d)",

1389 
	`tid_size
(
Œª¥Üt_id
), 
ext_size
 - 
off£t
);

1390 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1391 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1392 
»s
 = -
EINVAL
;

1393 
out
;

1395 
	`tid_£cu»
(
Œª¥Üt_id
);

1396 
off£t
 +ð
	`tid_size
(
Œª¥Üt_id
);

1399 
off£t
 = 0;

1400 
off£t
 < 
ext_size
) {

1401 
sc¡_tgt_dev
 *
t
;

1403 
Œª¥Üt_id
 = &
bufãr
[28 + 
off£t
];

1405 
	`TRACE_PR
("»l_tgt_id %d,¿n¥Üt_id %s", 
»l_tgt_id
,

1406 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
Œª¥Üt_id
));

1408 ià((
Œª¥Üt_id
[0] & 0x0fè=ð
SCSI_TRANSPORTID_PROTOCOLID_ISCSI
 &&

1409 (
Œª¥Üt_id
[0] & 0xc0) == 0) {

1410 
	`TRACE_PR
("Wildcard iSCSI TransportID %s",

1411 &
Œª¥Üt_id
[4]);

1416 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

1417 
	`li¡_fÜ_—ch_’Œy
(
t
, &
dev
->
dev_tgt_dev_li¡
,

1418 
dev_tgt_dev_li¡_’Œy
) {

1423 ià(!
	`tid_equ®
(
t
->
£ss
->
Œª¥Üt_id
,

1424 
Œª¥Üt_id
))

1427 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
,

1428 
t
->
£ss
->
Œª¥Üt_id
, 
»l_tgt_id
);

1429 ià(
»g
 =ð
NULL
) {

1430 
»g
 = 
	`sc¡_´_add_»gi¡¿Á
(
dev
,

1431 
t
->
£ss
->
Œª¥Üt_id
,

1432 
»l_tgt_id
, 
aùiÚ_key
, 
Œue
);

1433 ià(
»g
 =ð
NULL
) {

1434 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

1435 
	`sc¡_£t_busy
(
cmd
);

1436 
»s
 = -
ENOMEM
;

1437 
out
;

1439 } ià(
»g
->
key
 !ð
aùiÚ_key
) {

1440 
	`TRACE_PR
("Changing key of„eg %p "

1441 "Ñgt_dev %p)", 
»g
, 
t
);

1442 
»g
->
rÞlback_key
 =„eg->
key
;

1443 
»g
->
key
 = 
aùiÚ_key
;

1447 
	`li¡_add_ž
(&
»g
->
aux_li¡_’Œy
,

1448 
rÞlback_li¡
);

1450 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

1452 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
, 
Œª¥Üt_id
, 
»l_tgt_id
);

1453 ià(
»g
 !ð
NULL
) {

1454 ià(
»g
->
key
 =ð
aùiÚ_key
)

1455 
Ãxt
;

1456 
	`TRACE_PR
("Changing key of„eg %p (tgt_dev %p)",

1457 
»g
,„eg->
tgt_dev
);

1458 
»g
->
rÞlback_key
 =„eg->
key
;

1459 
»g
->
key
 = 
aùiÚ_key
;

1461 
»g
 = 
	`sc¡_´_add_»gi¡¿Á
(
dev
, 
Œª¥Üt_id
,

1462 
»l_tgt_id
, 
aùiÚ_key
, 
çl£
);

1463 ià(
»g
 =ð
NULL
) {

1464 
	`sc¡_£t_busy
(
cmd
);

1465 
»s
 = -
ENOMEM
;

1466 
out
;

1470 
	`li¡_add_ž
(&
»g
->
aux_li¡_’Œy
,

1471 
rÞlback_li¡
);

1473 
Ãxt
:

1474 
off£t
 +ð
	`tid_size
(
Œª¥Üt_id
);

1476 
out
:

1477  
»s
;

1478 
	}
}

1481 
	$sc¡_´_uÄegi¡”
(
sc¡_deviû
 *
dev
,

1482 
sc¡_dev_»gi¡¿Á
 *
»g
)

1484 
boÞ
 
is_hÞd”
;

1485 
ušt8_t
 
´_ty³
;

1487 
	`TRACE_ENTRY
();

1489 
	`TRACE_PR
("UÄegi¡”šg key %0Îx", 
»g
->
key
);

1491 
is_hÞd”
 = 
	`sc¡_´_is_hÞd”
(
dev
, 
»g
);

1492 
´_ty³
 = 
dev
->pr_type;

1494 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
»g
);

1496 ià(
is_hÞd”
 && !
dev
->
´_is_£t
) {

1498 
´_ty³
) {

1499 
TYPE_WRITE_EXCLUSIVE_REGONLY
:

1500 
TYPE_EXCLUSIVE_ACCESS_REGONLY
:

1501 
	`sc¡_´_£nd_ua_®l
(
dev
, 
NULL
,

1502 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£rv©iÚ_»Ëa£d
));

1507 
	`TRACE_EXIT
();

1509 
	}
}

1512 
	$sc¡_´_uÄegi¡”_®l_tg_±
(
sc¡_deviû
 *
dev
,

1513 cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
)

1515 
sc¡_tgt_‹m¶©e
 *
tg‰
;

1516 
ušt8_t
 
´Ùo_id
 = 
Œª¥Üt_id
[0] & 0x0f;

1518 
	`TRACE_ENTRY
();

1524 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

1526 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

1527 
sc¡_tgt
 *
tgt
;

1529 ià(
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
)

1532 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

1533 
sc¡_dev_»gi¡¿Á
 *
»g
;

1535 ià(
tg‰
->
	`g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
(
tgt
, 
NULL
, NULLè!ð
´Ùo_id
)

1538 
»g
 = 
	`sc¡_´_fšd_»g
(
dev
, 
Œª¥Üt_id
,

1539 
tgt
->
»l_tgt_id
);

1540 ià(
»g
 =ð
NULL
)

1543 
	`sc¡_´_uÄegi¡”
(
dev
, 
»g
);

1547 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

1549 
	`TRACE_EXIT
();

1551 
	}
}

1554 
	$sc¡_´_»gi¡”_Ú_tgt_id
(
sc¡_cmd
 *
cmd
,

1555 cÚ¡ 
ušt16_t
 
»l_tgt_id
, 
ušt8_t
 *
bufãr
, 
bufãr_size
,

1556 
boÞ
 
¥ec_i_±
, 
li¡_h—d
 *
rÞlback_li¡
)

1558 
»s
;

1560 
	`TRACE_ENTRY
();

1562 
	`TRACE_PR
("»l_tgt_id %d, s³c_i_± %d", 
»l_tgt_id
, 
¥ec_i_±
);

1564 ià(
¥ec_i_±
) {

1565 
»s
 = 
	`sc¡_´_»gi¡”_w™h_¥ec_i_±
(
cmd
, 
»l_tgt_id
, 
bufãr
,

1566 
bufãr_size
, 
rÞlback_li¡
);

1567 ià(
»s
 != 0)

1568 
out
;

1573 ià(
	`sc¡_´_fšd_»g
(
cmd
->
dev
, cmd->
£ss
->
Œª¥Üt_id
, 
»l_tgt_id
è=ð
NULL
) {

1574 
__be64
 
aùiÚ_key
;

1575 
sc¡_dev_»gi¡¿Á
 *
»g
;

1577 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

1579 
»g
 = 
	`sc¡_´_add_»gi¡¿Á
(
cmd
->
dev
, cmd->
£ss
->
Œª¥Üt_id
,

1580 
»l_tgt_id
, 
aùiÚ_key
, 
çl£
);

1581 ià(
»g
 =ð
NULL
) {

1582 
»s
 = -
ENOMEM
;

1583 
	`sc¡_£t_busy
(
cmd
);

1584 
out
;

1587 
	`li¡_add_ž
(&
»g
->
aux_li¡_’Œy
, 
rÞlback_li¡
);

1590 
»s
 = 0;

1592 
out
:

1593 
	`TRACE_EXIT_RES
(
»s
);

1594  
»s
;

1595 
	}
}

1598 
	$sc¡_´_»gi¡”_®l_tg_±
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

1599 
bufãr_size
, 
boÞ
 
¥ec_i_±
, 
li¡_h—d
 *
rÞlback_li¡
)

1601 
»s
 = 0;

1602 
sc¡_tgt_‹m¶©e
 *
tg‰
;

1603 
ušt8_t
 
´Ùo_id
 = 
cmd
->
£ss
->
Œª¥Üt_id
[0] & 0x0f;

1605 
	`TRACE_ENTRY
();

1611 
	`mu‹x_lock
(&
sc¡_mu‹x2
);

1613 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

1614 
sc¡_tgt
 *
tgt
;

1616 ià(
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 =ð
NULL
)

1619 
	`TRACE_PR
("tg‰ %s, s³c_i_± %d", 
tg‰
->
Çme
, 
¥ec_i_±
);

1621 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

1622 ià(
tg‰
->
	`g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
(
tgt
, 
NULL
, NULLè!ð
´Ùo_id
)

1624 ià(
tgt
->
»l_tgt_id
 == 0)

1626 
	`TRACE_PR
("tgˆ%s,„–_tgt_id %d", 
tgt
->
tgt_Çme
,

1627 
tgt
->
»l_tgt_id
);

1628 
»s
 = 
	`sc¡_´_»gi¡”_Ú_tgt_id
(
cmd
, 
tgt
->
»l_tgt_id
,

1629 
bufãr
, 
bufãr_size
, 
¥ec_i_±
, 
rÞlback_li¡
);

1630 ià(
»s
 != 0)

1631 
out_uÆock
;

1635 
out_uÆock
:

1636 
	`mu‹x_uÆock
(&
sc¡_mu‹x2
);

1638 
	`TRACE_EXIT_RES
(
»s
);

1639  
»s
;

1640 
	}
}

1643 
	$__sc¡_´_»gi¡”
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

1644 
bufãr_size
, 
boÞ
 
¥ec_i_±
, boÞ 
®l_tg_±
)

1646 
»s
;

1647 
sc¡_dev_»gi¡¿Á
 *
»g
, *
Œeg
;

1648 
	`LIST_HEAD
(
rÞlback_li¡
);

1650 
	`TRACE_ENTRY
();

1652 ià(
®l_tg_±
) {

1653 
»s
 = 
	`sc¡_´_»gi¡”_®l_tg_±
(
cmd
, 
bufãr
, 
bufãr_size
,

1654 
¥ec_i_±
, &
rÞlback_li¡
);

1655 ià(
»s
 != 0)

1656 
out_rÞlback
;

1658 
»s
 = 
	`sc¡_´_»gi¡”_Ú_tgt_id
(
cmd
,

1659 
cmd
->
£ss
->
tgt
->
»l_tgt_id
, 
bufãr
, 
bufãr_size
,

1660 
¥ec_i_±
, &
rÞlback_li¡
);

1661 ià(
»s
 != 0)

1662 
out_rÞlback
;

1665 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
rÞlback_li¡
, 
aux_li¡_’Œy
) {

1666 
»g
->
rÞlback_key
 = 0;

1669 
out
:

1670 
	`TRACE_EXIT_RES
(
»s
);

1671  
»s
;

1673 
out_rÞlback
:

1674 
	`li¡_fÜ_—ch_’Œy_§ã
(
»g
, 
Œeg
, &
rÞlback_li¡
, 
aux_li¡_’Œy
) {

1675 
	`li¡_d–
(&
»g
->
aux_li¡_’Œy
);

1676 ià(
»g
->
rÞlback_key
 == 0)

1677 
	`sc¡_´_»move_»gi¡¿Á
(
cmd
->
dev
, 
»g
);

1679 
»g
->
key
 =„eg->
rÞlback_key
;

1680 
»g
->
rÞlback_key
 = 0;

1683 
out
;

1684 
	}
}

1687 
	$sc¡_´_»gi¡”
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

1689 
­l
, 
¥ec_i_±
, 
®l_tg_±
;

1690 
__be64
 
key
, 
aùiÚ_key
;

1691 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1692 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

1693 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

1694 
sc¡_dev_»gi¡¿Á
 *
»g
;

1696 
	`TRACE_ENTRY
();

1698 
­l
 = 
bufãr
[20] & 0x01;

1699 
¥ec_i_±
 = (
bufãr
[20] >> 3) & 0x01;

1700 
®l_tg_±
 = (
bufãr
[20] >> 2) & 0x01;

1701 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

1702 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

1704 ià(
¥ec_i_±
 =ð0 && 
bufãr_size
 != 24) {

1705 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

1706 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1707 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

1708 
out
;

1711 #ifdeà
CONFIG_SCST_PROC


1712 ià(
­l
) {

1713 
	`TRACE_PR
("%s", "APTL‚ot supported");

1714 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1715 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1716 
out
;

1720 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

1722 
	`TRACE_PR
("Register: initiator %s/%d (%p), key %0llx,‡ction_key %0llx "

1724 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
£ss
->
Œª¥Üt_id
),

1725 
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
key
, 
aùiÚ_key
, 
tgt_dev
);

1727 ià(
»g
 =ð
NULL
) {

1728 
	`TRACE_PR
("tgt_dev %p is‚ot„egistered yet -„egistering",

1729 
tgt_dev
);

1730 ià(
key
) {

1731 
	`TRACE_PR
("%s", "Key must be zero on‚ew„egistration");

1732 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

1733 
out
;

1735 ià(
aùiÚ_key
) {

1736 
rc
 = 
	`__sc¡_´_»gi¡”
(
cmd
, 
bufãr
, 
bufãr_size
,

1737 
¥ec_i_±
, 
®l_tg_±
);

1738 ià(
rc
 != 0)

1739 
out
;

1741 
	`TRACE_PR
("%s", "Doing‚othing -‡ction_key is zero");

1743 ià(
»g
->
key
 != key) {

1744 
	`TRACE_PR
("tgt_dev %p‡lready„egistered -„eservation "

1745 "key %0Îx mism©ch", 
tgt_dev
, 
»g
->
key
);

1746 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

1747 
SAM_STAT_RESERVATION_CONFLICT
);

1748 
out
;

1750 ià(
¥ec_i_±
) {

1751 
	`TRACE_PR
("%s", "spec_i_pt must be zero inhis case");

1752 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

1753 
sc¡_£n£_šv®id_f›ld_š_cdb
));

1754 
out
;

1756 ià(
aùiÚ_key
 == 0) {

1757 ià(
®l_tg_±
)

1758 
	`sc¡_´_uÄegi¡”_®l_tg_±
(
dev
,

1759 
£ss
->
Œª¥Üt_id
);

1761 
	`sc¡_´_uÄegi¡”
(
dev
, 
»g
);

1763 
»g
->
key
 = 
aùiÚ_key
;

1766 
dev
->
´_g’”©iÚ
++;

1768 
dev
->
´_­l
 = 
­l
;

1770 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

1772 
out
:

1773 
	`TRACE_EXIT
();

1775 
	}
}

1778 
	$sc¡_´_»gi¡”_ªd_ignÜe
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

1779 
bufãr_size
)

1781 
­l
, 
®l_tg_±
;

1782 
__be64
 
aùiÚ_key
;

1783 
sc¡_dev_»gi¡¿Á
 *
»g
 = 
NULL
;

1784 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1785 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

1786 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

1788 
	`TRACE_ENTRY
();

1790 
­l
 = 
bufãr
[20] & 0x01;

1791 
®l_tg_±
 = (
bufãr
[20] >> 2) & 0x01;

1792 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

1794 ià(
bufãr_size
 != 24) {

1795 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

1796 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1797 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

1798 
out
;

1801 #ifdeà
CONFIG_SCST_PROC


1802 ià(
­l
) {

1803 
	`TRACE_PR
("%s", "APTL‚ot supported");

1804 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1805 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1806 
out
;

1810 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

1812 
	`TRACE_PR
("Register‡nd ignore: initiator %s/%d (%p),‡ction_key "

1814 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
£ss
->
Œª¥Üt_id
),

1815 
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
aùiÚ_key
, 
tgt_dev
);

1817 ià(
»g
 =ð
NULL
) {

1818 
	`TRACE_PR
("Tgt_dev %p is‚ot„egistered yet -ryingo "

1819 "»gi¡”", 
tgt_dev
);

1820 ià(
aùiÚ_key
) {

1821 
rc
 = 
	`__sc¡_´_»gi¡”
(
cmd
, 
bufãr
, 
bufãr_size
,

1822 
çl£
, 
®l_tg_±
);

1823 ià(
rc
 != 0)

1824 
out
;

1826 
	`TRACE_PR
("%s", "Doing‚othing,‡ction_key is zero");

1828 ià(
aùiÚ_key
 == 0) {

1829 ià(
®l_tg_±
)

1830 
	`sc¡_´_uÄegi¡”_®l_tg_±
(
dev
,

1831 
£ss
->
Œª¥Üt_id
);

1833 
	`sc¡_´_uÄegi¡”
(
dev
, 
»g
);

1835 
»g
->
key
 = 
aùiÚ_key
;

1838 
dev
->
´_g’”©iÚ
++;

1840 
dev
->
´_­l
 = 
­l
;

1842 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

1844 
out
:

1845 
	`TRACE_EXIT
();

1847 
	}
}

1850 
	$sc¡_´_»gi¡”_ªd_move
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

1851 
bufãr_size
)

1853 
­l
;

1854 
uÄeg
;

1855 
tid_bufãr_size
;

1856 
__be64
 
key
, 
aùiÚ_key
;

1857 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

1858 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

1859 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

1860 
sc¡_dev_»gi¡¿Á
 *
»g
, *
»g_move
;

1861 cÚ¡ 
ušt8_t
 *
Œª¥Üt_id
 = 
NULL
;

1862 
ušt8_t
 *
Œª¥Üt_id_move
 = 
NULL
;

1863 
ušt16_t
 
»l_tgt_id_move
;

1865 
	`TRACE_ENTRY
();

1867 
­l
 = 
bufãr
[17] & 0x01;

1868 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

1869 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

1870 
uÄeg
 = (
bufãr
[17] >> 1) & 0x01;

1871 
tid_bufãr_size
 = 
	`be32_to_ýu
(
	`g‘_uÇligÃd
((
__be32
 *)&
bufãr
[20]));

1873 #ifdeà
CONFIG_SCST_PROC


1874 ià(
­l
) {

1875 
	`TRACE_PR
("%s", "APTL‚ot supported");

1876 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1877 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1878 
out
;

1882 ià((
tid_bufãr_size
 + 24è> 
bufãr_size
) {

1883 
	`TRACE_PR
("Invalid buffer size %d (%d)",

1884 
bufãr_size
, 
tid_bufãr_size
 + 24);

1885 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1886 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1887 
out
;

1890 ià(
tid_bufãr_size
 < 24) {

1891 
	`TRACE_PR
("%s", "Transport id bufferoo small");

1892 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1893 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1894 
out
;

1897 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

1899 ià(
»g
->
key
 != key) {

1900 
	`TRACE_PR
("Registrant's %s/%d (%p) key %016llx mismatch with "

1902 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

1903 
»g
->
»l_tgt_id
,„eg,„eg->
key
, key, 
tgt_dev
);

1904 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

1905 
out
;

1908 ià(!
dev
->
´_is_£t
) {

1909 
	`TRACE_PR
("%s", "There must be‡ PR");

1910 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1911 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1912 
out
;

1919 ià(!
	`sc¡_´_is_hÞd”
(
dev
, 
»g
)) {

1920 
	`TRACE_PR
("Registrant %s/%d (%p) is‚ot‡ holder (tgt_dev %p)",

1921 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

1922 
»g
->
Œª¥Üt_id
),„eg->
»l_tgt_id
,

1923 
»g
, 
tgt_dev
);

1924 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

1925 
out
;

1928 ià(
aùiÚ_key
 == 0) {

1929 
	`TRACE_PR
("%s", "Action key must be‚on-zero");

1930 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1931 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1932 
out
;

1935 
Œª¥Üt_id
 = 
£ss
->transport_id;

1936 
Œª¥Üt_id_move
 = (
ušt8_t
 *)&
bufãr
[24];

1937 
»l_tgt_id_move
 = 
	`be16_to_ýu
(
	`g‘_uÇligÃd
((
__be16
 *)&
bufãr
[18]));

1939 ià((
	`tid_size
(
Œª¥Üt_id_move
è+ 24è> 
bufãr_size
) {

1940 
	`TRACE_PR
("Invalid buffer size %d (%d)",

1941 
bufãr_size
, 
	`tid_size
(
Œª¥Üt_id_move
) + 24);

1942 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1943 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1944 
out
;

1947 
	`tid_£cu»
(
Œª¥Üt_id_move
);

1949 ià(
dev
->
´_ty³
 =ð
TYPE_WRITE_EXCLUSIVE_ALL_REG
 ||

1950 
dev
->
´_ty³
 =ð
TYPE_EXCLUSIVE_ACCESS_ALL_REG
) {

1951 
	`TRACE_PR
("Unableo finish operation dueo wrong„eservation "

1952 "ty³ %02x", 
dev
->
´_ty³
);

1953 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

1954 
out
;

1957 ià(
	`tid_equ®
(
Œª¥Üt_id
, 
Œª¥Üt_id_move
)) {

1958 
	`TRACE_PR
("%s", "Equalransport id's");

1959 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1960 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

1961 
out
;

1964 
»g_move
 = 
	`sc¡_´_fšd_»g
(
dev
, 
Œª¥Üt_id_move
, 
»l_tgt_id_move
);

1965 ià(
»g_move
 =ð
NULL
) {

1966 
»g_move
 = 
	`sc¡_´_add_»gi¡¿Á
(
dev
, 
Œª¥Üt_id_move
,

1967 
»l_tgt_id_move
, 
aùiÚ_key
, 
çl£
);

1968 ià(
»g_move
 =ð
NULL
) {

1969 
	`sc¡_£t_busy
(
cmd
);

1970 
out
;

1972 } ià(
»g_move
->
key
 !ð
aùiÚ_key
) {

1973 
	`TRACE_PR
("Chªgšg key fÜ„eg %p", 
»g
);

1974 
»g_move
->
key
 = 
aùiÚ_key
;

1977 
	`TRACE_PR
("Register‡nd move: from initiator %s/%d (%p,gt_dev %p)o "

1979 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
»g
->
Œª¥Üt_id
),

1980 
»g
->
»l_tgt_id
,„eg,„eg->
tgt_dev
,

1981 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
Œª¥Üt_id_move
),

1982 
»l_tgt_id_move
, 
»g_move
,„eg_move->
tgt_dev
, 
aùiÚ_key
,

1983 
uÄeg
);

1986 
	`sc¡_´_£t_hÞd”
(
dev
, 
»g_move
, dev->
´_scÝe
, dev->
´_ty³
);

1988 ià(
uÄeg
)

1989 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
»g
);

1991 
dev
->
´_g’”©iÚ
++;

1993 
dev
->
´_­l
 = 
­l
;

1995 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

1997 
out
:

1998 
	`TRACE_EXIT
();

2000 
	}
}

2003 
	$sc¡_´_»£rve
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2005 
ušt8_t
 
scÝe
, 
ty³
;

2006 
__be64
 
key
;

2007 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2008 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2009 
sc¡_dev_»gi¡¿Á
 *
»g
;

2011 
	`TRACE_ENTRY
();

2013 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

2014 
scÝe
 = (
cmd
->
cdb
[2] & 0x0f) >> 4;

2015 
ty³
 = 
cmd
->
cdb
[2] & 0x0f;

2017 ià(
bufãr_size
 != 24) {

2018 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

2019 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2020 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

2021 
out
;

2024 ià(!
	`sc¡_´_ty³_v®id
(
ty³
)) {

2025 
	`TRACE_PR
("Inv®id„e£rv©iÚy³ %d", 
ty³
);

2026 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2027 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2028 
out
;

2031 ià(((
cmd
->
cdb
[2] & 0x0fè>> 4è!ð
SCOPE_LU
) {

2032 
	`TRACE_PR
("Inv®id„e£rv©iÚ scÝ%d", 
scÝe
);

2033 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2034 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2035 
out
;

2038 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2040 
	`TRACE_PR
("Reserve: initiator %s/%d (%p), key %016llx, scope %d, "

2042 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
cmd
->
£ss
->
Œª¥Üt_id
),

2043 
cmd
->
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
key
, 
scÝe
, 
ty³
, 
tgt_dev
);

2046 ià(
»g
->
key
 != key) {

2047 
	`TRACE_PR
("Registrant's %p key %016llx mismatch with %016llx",

2048 
»g
,„eg->
key
, key);

2049 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2050 
out
;

2053 ià(!
dev
->
´_is_£t
)

2054 
	`sc¡_´_£t_hÞd”
(
dev
, 
»g
, 
scÝe
, 
ty³
);

2056 ià(!
	`sc¡_´_is_hÞd”
(
dev
, 
»g
)) {

2062 
	`TRACE_PR
("Only holder can override -„eg %p is‚ot‡ "

2063 "hÞd”", 
»g
);

2064 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

2065 
SAM_STAT_RESERVATION_CONFLICT
);

2066 
out
;

2068 ià(
dev
->
´_scÝe
 !ð
scÝe
 || dev->
´_ty³
 !ð
ty³
) {

2069 
	`TRACE_PR
("Error overriding scope orype for "

2070 "»g %p", 
»g
);

2071 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

2072 
SAM_STAT_RESERVATION_CONFLICT
);

2073 
out
;

2075 
	`TRACE_PR
("Do‚othing:„eservation of„eg %p "

2076 "i th§me", 
»g
);

2080 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

2082 
out
:

2083 
	`TRACE_EXIT
();

2085 
	}
}

2088 
	$sc¡_´_»Ëa£
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2090 
scÝe
, 
ty³
;

2091 
__be64
 
key
;

2092 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2093 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2094 
sc¡_dev_»gi¡¿Á
 *
»g
;

2095 
ušt8_t
 
cur_´_ty³
;

2097 
	`TRACE_ENTRY
();

2099 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

2100 
scÝe
 = (
cmd
->
cdb
[2] & 0x0f) >> 4;

2101 
ty³
 = 
cmd
->
cdb
[2] & 0x0f;

2103 ià(
bufãr_size
 != 24) {

2104 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

2105 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2106 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

2107 
out
;

2110 ià(!
dev
->
´_is_£t
) {

2111 
	`TRACE_PR
("%s", "There is‚o PR - do‚othing");

2112 
out
;

2115 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2117 
	`TRACE_PR
("Release: initiator %s/%d (%p), key %016llx, scope %d,ype "

2118 "%d (tgt_dev %p)", 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

2119 
cmd
->
£ss
->
Œª¥Üt_id
),

2120 
cmd
->
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
key
, 
scÝe
, 
ty³
, 
tgt_dev
);

2123 ià(
»g
->
key
 != key) {

2124 
	`TRACE_PR
("Registrant's %p key %016llx mismatch with %016llx",

2125 
»g
,„eg->
key
, key);

2126 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2127 
out
;

2130 ià(!
	`sc¡_´_is_hÞd”
(
dev
, 
»g
)) {

2131 
	`TRACE_PR
("Regi¡¿Á %°i nÙ‡ hÞd” - dØnÙhšg", 
»g
);

2132 
out
;

2135 ià(
dev
->
´_scÝe
 !ð
scÝe
 || dev->
´_ty³
 !ð
ty³
) {

2136 
	`TRACE_PR
("%s", "Released scope orype do‚ot match with "

2138 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2139 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_»Ëa£
));

2140 
out
;

2143 
cur_´_ty³
 = 
dev
->
´_ty³
;

2145 
	`sc¡_´_þ—r_»£rv©iÚ
(
dev
);

2147 
cur_´_ty³
) {

2148 
TYPE_WRITE_EXCLUSIVE_REGONLY
:

2149 
TYPE_EXCLUSIVE_ACCESS_REGONLY
:

2150 
TYPE_WRITE_EXCLUSIVE_ALL_REG
:

2151 
TYPE_EXCLUSIVE_ACCESS_ALL_REG
:

2152 
	`sc¡_´_£nd_ua_®l
(
dev
, 
»g
,

2153 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£rv©iÚ_»Ëa£d
));

2156 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

2158 
out
:

2159 
	`TRACE_EXIT
();

2161 
	}
}

2164 
	$sc¡_´_þ—r
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2166 
__be64
 
key
;

2167 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2168 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2169 
sc¡_dev_»gi¡¿Á
 *
»g
, *
r
, *
t
;

2171 
	`TRACE_ENTRY
();

2173 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

2175 ià(
bufãr_size
 != 24) {

2176 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

2177 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2178 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

2179 
out
;

2182 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2184 
	`TRACE_PR
("Clear: initiator %s/%d (%p), key %016llx (tgt_dev %p)",

2185 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
cmd
->
£ss
->
Œª¥Üt_id
),

2186 
cmd
->
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
key
, 
tgt_dev
);

2189 ià(
»g
->
key
 != key) {

2190 
	`TRACE_PR
("Registrant's %p key %016llx mismatch with %016llx",

2191 
»g
,„eg->
key
, key);

2192 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2193 
out
;

2196 
	`sc¡_´_£nd_ua_®l
(
dev
, 
»g
,

2197 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£rv©iÚ_´“m±ed
));

2199 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
t
, &
dev
->
dev_»gi¡¿Ás_li¡
,

2200 
dev_»gi¡¿Ás_li¡_’Œy
) {

2201 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2204 
dev
->
´_g’”©iÚ
++;

2206 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

2208 
out
:

2209 
	`TRACE_EXIT
();

2211 
	}
}

2213 
	$sc¡_´_do_´“m±
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

2214 
bufãr_size
, 
boÞ
 
abÜt
)

2216 
__be64
 
key
, 
aùiÚ_key
;

2217 
scÝe
, 
ty³
;

2218 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2219 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2220 
sc¡_dev_»gi¡¿Á
 *
»g
, *
r
, *
¹
;

2221 
exi¡šg_´_ty³
 = 
dev
->
´_ty³
;

2222 
exi¡šg_´_scÝe
 = 
dev
->
´_scÝe
;

2223 
	`LIST_HEAD
(
´“m±_li¡
);

2225 
	`TRACE_ENTRY
();

2227 
key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[0]);

2228 
aùiÚ_key
 = 
	`g‘_uÇligÃd
((
__be64
 *)&
bufãr
[8]);

2229 
scÝe
 = (
cmd
->
cdb
[2] & 0x0f) >> 4;

2230 
ty³
 = 
cmd
->
cdb
[2] & 0x0f;

2232 ià(
bufãr_size
 != 24) {

2233 
	`TRACE_PR
("Inv®id bufã¸siz%d", 
bufãr_size
);

2234 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2235 
	`SCST_LOAD_SENSE
(
sc¡_£n£_·¿m‘”_li¡_Ëngth_šv®id
));

2236 
out
;

2239 ià(!
	`sc¡_´_ty³_v®id
(
ty³
)) {

2240 
	`TRACE_PR
("Inv®id„e£rv©iÚy³ %d", 
ty³
);

2241 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2242 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2243 
out
;

2246 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2248 
	`TRACE_PR
("Preempt%s: initiator %s/%d (%p), key %016llx,‡ction_key "

2250 
abÜt
 ? "‡nd‡bort" : "",

2251 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(
cmd
->
£ss
->
Œª¥Üt_id
),

2252 
cmd
->
£ss
->
tgt
->
»l_tgt_id
, 
»g
, 
key
, 
aùiÚ_key
, 
scÝe
, 
ty³
,

2253 
tgt_dev
);

2256 ià(
»g
->
key
 != key) {

2257 
	`TRACE_PR
("Registrant's %p key %016llx mismatch with %016llx",

2258 
»g
,„eg->
key
, key);

2259 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2260 
out
;

2263 ià(!
dev
->
´_is_£t
) {

2264 
	`sc¡_´_fšd_»gi¡¿Ás_li¡_key
(
dev
, 
aùiÚ_key
,

2265 &
´“m±_li¡
);

2266 ià(
	`li¡_em±y
(&
´“m±_li¡
))

2267 
out_”rÜ
;

2268 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
¹
, &
´“m±_li¡
, 
aux_li¡_’Œy
) {

2269 ià(
abÜt
)

2270 
	`sc¡_´_abÜt_»g
(
dev
, 
cmd
, 
r
);

2271 ià(
r
 !ð
»g
) {

2272 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
, 
	`SCST_LOAD_SENSE
(

2273 
sc¡_£n£_»gi¡¿tiÚs_´“m±ed
));

2274 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2277 
dÚe
;

2280 ià(
dev
->
´_ty³
 =ð
TYPE_WRITE_EXCLUSIVE_ALL_REG
 ||

2281 
dev
->
´_ty³
 =ð
TYPE_EXCLUSIVE_ACCESS_ALL_REG
) {

2282 ià(
aùiÚ_key
 == 0) {

2283 
	`sc¡_´_fšd_»gi¡¿Ás_li¡_®l
(
dev
, 
»g
,

2284 &
´“m±_li¡
);

2285 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
¹
, &
´“m±_li¡
,

2286 
aux_li¡_’Œy
) {

2287 
	`sBUG_ON
(
r
 =ð
»g
);

2288 ià(
abÜt
)

2289 
	`sc¡_´_abÜt_»g
(
dev
, 
cmd
, 
r
);

2290 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
,

2291 
	`SCST_LOAD_SENSE
(

2292 
sc¡_£n£_»gi¡¿tiÚs_´“m±ed
));

2293 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2295 
	`sc¡_´_£t_hÞd”
(
dev
, 
»g
, 
scÝe
, 
ty³
);

2297 
	`sc¡_´_fšd_»gi¡¿Ás_li¡_key
(
dev
, 
aùiÚ_key
,

2298 &
´“m±_li¡
);

2299 ià(
	`li¡_em±y
(&
´“m±_li¡
))

2300 
out_”rÜ
;

2301 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
¹
, &
´“m±_li¡
,

2302 
aux_li¡_’Œy
) {

2303 ià(
abÜt
)

2304 
	`sc¡_´_abÜt_»g
(
dev
, 
cmd
, 
r
);

2305 ià(
r
 !ð
»g
) {

2306 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
,

2307 
	`SCST_LOAD_SENSE
(

2308 
sc¡_£n£_»gi¡¿tiÚs_´“m±ed
));

2309 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2313 
dÚe
;

2316 ià(
dev
->
´_hÞd”
->
key
 !ð
aùiÚ_key
) {

2317 ià(
aùiÚ_key
 == 0) {

2318 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

2319 
sc¡_£n£_šv®id_f›ld_š_·rm_li¡
));

2320 
out
;

2322 
	`sc¡_´_fšd_»gi¡¿Ás_li¡_key
(
dev
, 
aùiÚ_key
,

2323 &
´“m±_li¡
);

2324 ià(
	`li¡_em±y
(&
´“m±_li¡
))

2325 
out_”rÜ
;

2326 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
¹
, &
´“m±_li¡
,

2327 
aux_li¡_’Œy
) {

2328 ià(
abÜt
)

2329 
	`sc¡_´_abÜt_»g
(
dev
, 
cmd
, 
r
);

2330 ià(
r
 !ð
»g
)

2331 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
,

2332 
	`SCST_LOAD_SENSE
(

2333 
sc¡_£n£_»gi¡¿tiÚs_´“m±ed
));

2334 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2336 
dÚe
;

2340 
	`sc¡_´_fšd_»gi¡¿Ás_li¡_key
(
dev
, 
aùiÚ_key
,

2341 &
´“m±_li¡
);

2343 
	`li¡_fÜ_—ch_’Œy_§ã
(
r
, 
¹
, &
´“m±_li¡
, 
aux_li¡_’Œy
) {

2344 ià(
abÜt
)

2345 
	`sc¡_´_abÜt_»g
(
dev
, 
cmd
, 
r
);

2346 ià(
r
 !ð
»g
) {

2347 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
, 
	`SCST_LOAD_SENSE
(

2348 
sc¡_£n£_»gi¡¿tiÚs_´“m±ed
));

2349 
	`sc¡_´_»move_»gi¡¿Á
(
dev
, 
r
);

2353 
	`sc¡_´_£t_hÞd”
(
dev
, 
»g
, 
scÝe
, 
ty³
);

2355 ià(
exi¡šg_´_ty³
 !ð
ty³
 || 
exi¡šg_´_scÝe
 !ð
scÝe
) {

2356 
	`li¡_fÜ_—ch_’Œy
(
r
, &
dev
->
dev_»gi¡¿Ás_li¡
,

2357 
dev_»gi¡¿Ás_li¡_’Œy
) {

2358 ià(
r
 !ð
»g
)

2359 
	`sc¡_´_£nd_ua_»g
(
dev
, 
r
, 
	`SCST_LOAD_SENSE
(

2360 
sc¡_£n£_»£rv©iÚ_»Ëa£d
));

2364 
dÚe
:

2365 
dev
->
´_g’”©iÚ
++;

2367 
	`sc¡_´_dump_´s
(
dev
, 
çl£
);

2369 
out
:

2370 
	`TRACE_EXIT
();

2373 
out_”rÜ
:

2374 
	`TRACE_PR
("Inv®id key %016Îx", 
aùiÚ_key
);

2375 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2376 
out
;

2377 
	}
}

2380 
	$sc¡_´_´“m±
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2382 
	`TRACE_ENTRY
();

2384 
	`sc¡_´_do_´“m±
(
cmd
, 
bufãr
, 
bufãr_size
, 
çl£
);

2386 
	`TRACE_EXIT
();

2388 
	}
}

2390 
	$sc¡_cmd_dÚe_´_´“m±
(
sc¡_cmd
 *
cmd
, 
Ãxt_¡©e
,

2391 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

2393 (*
§ved_cmd_dÚe
è(
sc¡_cmd
 *
cmd
, 
Ãxt_¡©e
,

2394 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
);

2396 
	`TRACE_ENTRY
();

2398 ià(!
	`©omic_dec_ªd_‹¡
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜt_³ndšg_út
))

2399 
out
;

2401 
§ved_cmd_dÚe
 = 
cmd
->
´_abÜt_couÁ”
->saved_cmd_done;

2402 
	`kä“
(
cmd
->
´_abÜt_couÁ”
);

2403 
cmd
->
´_abÜt_couÁ”
 = 
NULL
;

2405 
	`§ved_cmd_dÚe
(
cmd
, 
Ãxt_¡©e
, 
´ef_cÚ‹xt
);

2407 
out
:

2408 
	`TRACE_EXIT
();

2410 
	}
}

2416 
	$sc¡_´_´“m±_ªd_abÜt
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

2417 
bufãr_size
)

2419 
	`TRACE_ENTRY
();

2421 
cmd
->
´_abÜt_couÁ”
 = 
	`kz®loc
((*cmd->pr_abort_counter),

2422 
GFP_KERNEL
);

2423 ià(
cmd
->
´_abÜt_couÁ”
 =ð
NULL
) {

2424 
	`PRINT_ERROR
("Unableo‡llocate PR‡bort counter (size %zd)",

2425 (*
cmd
->
´_abÜt_couÁ”
));

2426 
	`sc¡_£t_busy
(
cmd
);

2427 
out
;

2431 
	`©omic_£t
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜt_³ndšg_út
, 1);

2432 
	`©omic_£t
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜtšg_út
, 1);

2433 
	`š™_com¶‘iÚ
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜtšg_cm¶
);

2435 
cmd
->
´_abÜt_couÁ”
->
§ved_cmd_dÚe
 = cmd->
sc¡_cmd_dÚe
;

2436 
cmd
->
sc¡_cmd_dÚe
 = 
sc¡_cmd_dÚe_´_´“m±
;

2438 
	`sc¡_´_do_´“m±
(
cmd
, 
bufãr
, 
bufãr_size
, 
Œue
);

2440 ià(!
	`©omic_dec_ªd_‹¡
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜtšg_út
))

2441 
	`wa™_fÜ_com¶‘iÚ
(&
cmd
->
´_abÜt_couÁ”
->
´_abÜtšg_cm¶
);

2443 
out
:

2444 
	`TRACE_EXIT
();

2446 
	}
}

2449 
boÞ
 
	$sc¡_´_üh_ÿ£
(
sc¡_cmd
 *
cmd
)

2451 
boÞ
 
®lowed
;

2452 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2453 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2454 
sc¡_dev_»gi¡¿Á
 *
»g
;

2455 
ušt8_t
 
ty³
;

2457 
	`TRACE_ENTRY
();

2459 
	`TRACE_DBG
("Test ifhere is‡ CRH case for command %s (0x%x) from "

2460 "%s", 
cmd
->
Ý_Çme
, cmd->
cdb
[0], cmd->
£ss
->
š™ŸtÜ_Çme
);

2462 ià(!
dev
->
´_is_£t
) {

2463 
	`TRACE_PR
("%s", "PR‚ot set");

2464 
®lowed
 = 
çl£
;

2465 
out
;

2468 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2469 
ty³
 = 
dev
->
´_ty³
;

2471 
ty³
) {

2472 
TYPE_WRITE_EXCLUSIVE
:

2473 
TYPE_EXCLUSIVE_ACCESS
:

2474 
	`WARN_ON
(
dev
->
´_hÞd”
 =ð
NULL
);

2475 ià(
»g
 =ð
dev
->
´_hÞd”
)

2476 
®lowed
 = 
Œue
;

2478 
®lowed
 = 
çl£
;

2481 
TYPE_WRITE_EXCLUSIVE_REGONLY
:

2482 
TYPE_EXCLUSIVE_ACCESS_REGONLY
:

2483 
TYPE_WRITE_EXCLUSIVE_ALL_REG
:

2484 
TYPE_EXCLUSIVE_ACCESS_ALL_REG
:

2485 
®lowed
 = (
»g
 !ð
NULL
);

2489 
	`PRINT_ERROR
("Inv®id PRy³ %x", 
ty³
);

2490 
®lowed
 = 
çl£
;

2494 ià(!
®lowed
)

2495 
	`TRACE_PR
("Command %s (0x%x) from %s„ejected dueo‚ot CRH "

2496 "»£rv©iÚ", 
cmd
->
Ý_Çme
, cmd->
cdb
[0],

2497 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2499 
	`TRACE_DBG
("Command %s (0x%x) from %s is‡llowedoƒxecute "

2500 "dutØCRH", 
cmd
->
Ý_Çme
, cmd->
cdb
[0],

2501 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2503 
out
:

2504 
	`TRACE_EXIT_RES
(
®lowed
);

2505  
®lowed
;

2507 
	}
}

2510 
boÞ
 
	$sc¡_´_is_cmd_®lowed
(
sc¡_cmd
 *
cmd
)

2512 
boÞ
 
®lowed
;

2513 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2514 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2515 
sc¡_dev_»gi¡¿Á
 *
»g
;

2516 
ušt8_t
 
ty³
;

2517 
boÞ
 
uÆock
;

2519 
	`TRACE_ENTRY
();

2521 
uÆock
 = 
	`sc¡_´_»ad_lock
(
cmd
);

2523 
	`TRACE_DBG
("Testing if command %s (0x%x) from %s‡llowedoƒxecute",

2524 
cmd
->
Ý_Çme
, cmd->
cdb
[0], cmd->
£ss
->
š™ŸtÜ_Çme
);

2527 ià(
	`uÆik–y
(!
dev
->
´_is_£t
)) {

2528 
®lowed
 = 
Œue
;

2529 
out_uÆock
;

2532 
»g
 = 
tgt_dev
->
»gi¡¿Á
;

2533 
ty³
 = 
dev
->
´_ty³
;

2535 
ty³
) {

2536 
TYPE_WRITE_EXCLUSIVE
:

2537 ià(
»g
 &&„eg =ð
dev
->
´_hÞd”
)

2538 
®lowed
 = 
Œue
;

2540 
®lowed
 = (
cmd
->
Ý_æags
 & 
SCST_WRITE_EXCL_ALLOWED
) != 0;

2543 
TYPE_EXCLUSIVE_ACCESS
:

2544 ià(
»g
 &&„eg =ð
dev
->
´_hÞd”
)

2545 
®lowed
 = 
Œue
;

2547 
®lowed
 = (
cmd
->
Ý_æags
 & 
SCST_EXCL_ACCESS_ALLOWED
) != 0;

2550 
TYPE_WRITE_EXCLUSIVE_REGONLY
:

2551 
TYPE_WRITE_EXCLUSIVE_ALL_REG
:

2552 ià(
»g
)

2553 
®lowed
 = 
Œue
;

2555 
®lowed
 = (
cmd
->
Ý_æags
 & 
SCST_WRITE_EXCL_ALLOWED
) != 0;

2558 
TYPE_EXCLUSIVE_ACCESS_REGONLY
:

2559 
TYPE_EXCLUSIVE_ACCESS_ALL_REG
:

2560 ià(
»g
)

2561 
®lowed
 = 
Œue
;

2563 
®lowed
 = (
cmd
->
Ý_æags
 & 
SCST_EXCL_ACCESS_ALLOWED
) != 0;

2567 
	`PRINT_ERROR
("Inv®id PRy³ %x", 
ty³
);

2568 
®lowed
 = 
çl£
;

2572 ià(!
®lowed
)

2573 
	`TRACE_PR
("Command %s (0x%x) from %s„ejected due "

2574 "tØPR", 
cmd
->
Ý_Çme
, cmd->
cdb
[0],

2575 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2577 
	`TRACE_DBG
("Command %s (0x%x) from %s is‡llowedoƒxecute",

2578 
cmd
->
Ý_Çme
, cmd->
cdb
[0], cmd->
£ss
->
š™ŸtÜ_Çme
);

2580 
out_uÆock
:

2581 
	`sc¡_´_»ad_uÆock
(
cmd
, 
uÆock
);

2583 
	`TRACE_EXIT_RES
(
®lowed
);

2584  
®lowed
;

2585 
	}
}

2588 
	$sc¡_´_»ad_keys
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2590 
i
, 
off£t
 = 0, 
size
, 
size_max
;

2591 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2592 
sc¡_dev_»gi¡¿Á
 *
»g
;

2594 
	`TRACE_ENTRY
();

2596 ià(
bufãr_size
 < 8) {

2597 
	`TRACE_PR
("buffer_sizeoo small: %d.ƒxpected >= 8 "

2598 "(bufã¸%p)", 
bufãr_size
, 
bufãr
);

2599 
sk
;

2602 
	`TRACE_PR
("R—d Key (dev %s): PRG’ %d", 
dev
->
vœt_Çme
,

2603 
dev
->
´_g’”©iÚ
);

2605 
	`put_uÇligÃd
(
	`ýu_to_be32
(
dev
->
´_g’”©iÚ
), (
__be32
 *)&
bufãr
[0]);

2607 
off£t
 = 8;

2608 
size
 = 0;

2609 
size_max
 = 
bufãr_size
 - 8;

2611 
i
 = 0;

2612 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

2613 
dev_»gi¡¿Ás_li¡_’Œy
) {

2614 ià(
size_max
 - 
size
 >= 8) {

2615 
	`TRACE_PR
("Read Keys (dev %s): key 0x%llx",

2616 
dev
->
vœt_Çme
, 
»g
->
key
);

2618 
	`WARN_ON
(
»g
->
key
 == 0);

2620 
	`put_uÇligÃd
(
»g
->
key
,

2621 (
__be64
 *)&
bufãr
[
off£t
 + 8 * 
i
]);

2623 
off£t
 += 8;

2625 
size
 += 8;

2628 
	`put_uÇligÃd
(
	`ýu_to_be32
(
size
), (
__be32
 *)&
bufãr
[4]);

2630 
sk
:

2631 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
off£t
);

2633 
	`TRACE_EXIT
();

2635 
	}
}

2638 
	$sc¡_´_»ad_»£rv©iÚ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

2639 
bufãr_size
)

2641 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2642 
ušt8_t
 
b
[24];

2643 
size
 = 0;

2645 
	`TRACE_ENTRY
();

2647 ià(
bufãr_size
 < 8) {

2648 
	`TRACE_PR
("buffer_sizeoo small: %d.ƒxpected >= 8 "

2649 "(bufã¸%p)", 
bufãr_size
, 
bufãr
);

2650 
sk
;

2653 
	`mem£t
(
b
, 0, (b));

2655 
	`put_uÇligÃd
(
	`ýu_to_be32
(
dev
->
´_g’”©iÚ
), (
__be32
 *)&
b
[0]);

2657 ià(!
dev
->
´_is_£t
) {

2658 
	`TRACE_PR
("Read Reservation:‚o„eservations for dev %s",

2659 
dev
->
vœt_Çme
);

2660 
b
[4] =

2661 
b
[5] =

2662 
b
[6] =

2663 
b
[7] = 0;

2665 
size
 = 8;

2667 
__be64
 
key
 = 
dev
->
´_hÞd”
 ? dev->pr_holder->key : 0;

2669 
	`TRACE_PR
("Read Reservation: dev %s, holder %p, key 0x%llx, "

2670 "scÝ%d,y³ %d", 
dev
->
vœt_Çme
, dev->
´_hÞd”
,

2671 
key
, 
dev
->
´_scÝe
, dev->
´_ty³
);

2673 
b
[4] =

2674 
b
[5] =

2675 
b
[6] = 0;

2676 
b
[7] = 0x10;

2678 
	`put_uÇligÃd
(
key
, (
__be64
 *)&
b
[8]);

2679 
b
[21] = 
dev
->
´_scÝe
 << 4 | dev->
´_ty³
;

2681 
size
 = 24;

2684 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

2685 
	`memýy
(
bufãr
, 
b
, 
	`mš
(
size
, 
bufãr_size
));

2687 
sk
:

2688 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
size
);

2690 
	`TRACE_EXIT
();

2692 
	}
}

2695 
	$sc¡_´_»pÜt_ÿps
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
)

2697 
off£t
 = 0;

2698 
üh
 = 1;

2699 
©p_c
 = 1;

2700 
s_c
 = 1;

2701 #ifdeà
CONFIG_SCST_PROC


2702 
±¶_c
 = 0;

2704 
±¶_c
 = 1;

2706 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2708 
	`TRACE_ENTRY
();

2710 ià(
bufãr_size
 < 8) {

2711 
	`TRACE_PR
("buffer_sizeoo small: %d.ƒxpected >= 8 "

2712 "(bufã¸%p)", 
bufãr_size
, 
bufãr
);

2713 
sk
;

2716 
	`TRACE_PR
("Reporting capabilities (dev %s): crh %x, sip_c %x, "

2717 "©p_ø%x,…l_ø%x,…r_­È%x", 
dev
->
vœt_Çme
,

2718 
üh
, 
s_c
, 
©p_c
, 
±¶_c
, 
dev
->
´_­l
);

2720 
bufãr
[0] = 0;

2721 
bufãr
[1] = 8;

2723 
bufãr
[2] = 
üh
 << 4 | 
s_c
 << 3 | 
©p_c
 << 2 | 
±¶_c
;

2724 
bufãr
[3] = (1 << 7è| (
dev
->
´_­l
 > 0 ? 1 : 0);

2727 
bufãr
[4] = 0xEA;

2728 
bufãr
[5] = 0x1;

2730 
off£t
 += 8;

2732 
sk
:

2733 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
off£t
);

2735 
	`TRACE_EXIT
();

2737 
	}
}

2740 
	$sc¡_´_»ad_fuÎ_¡©us
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

2741 
bufãr_size
)

2743 
off£t
 = 0, 
size
, 
size_max
;

2744 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2745 
sc¡_dev_»gi¡¿Á
 *
»g
;

2747 
	`TRACE_ENTRY
();

2749 ià(
bufãr_size
 < 8)

2750 
sk
;

2752 
	`put_uÇligÃd
(
	`ýu_to_be32
(
dev
->
´_g’”©iÚ
), (
__be32
 *)&
bufãr
[0]);

2753 
off£t
 += 8;

2755 
size
 = 0;

2756 
size_max
 = 
bufãr_size
 - 8;

2758 
	`li¡_fÜ_—ch_’Œy
(
»g
, &
dev
->
dev_»gi¡¿Ás_li¡
,

2759 
dev_»gi¡¿Ás_li¡_’Œy
) {

2760 
ts
;

2761 
»c_Ën
;

2763 
ts
 = 
	`tid_size
(
»g
->
Œª¥Üt_id
);

2764 
»c_Ën
 = 24 + 
ts
;

2766 ià(
size_max
 - 
size
 > 
»c_Ën
) {

2767 
	`mem£t
(&
bufãr
[
off£t
], 0, 
»c_Ën
);

2769 
	`put_uÇligÃd
(
»g
->
key
, (
__be64
 *)(&
bufãr
[
off£t
]));

2771 ià(
dev
->
´_is_£t
 && 
	`sc¡_´_is_hÞd”
(dev, 
»g
)) {

2772 
bufãr
[
off£t
 + 12] = 1;

2773 
bufãr
[
off£t
 + 13] = (
dev
->
´_scÝe
 << 4è| dev->
´_ty³
;

2776 
	`put_uÇligÃd
(
	`ýu_to_be16
(
»g
->
»l_tgt_id
),

2777 (
__be16
 *)&
bufãr
[
off£t
 + 18]);

2778 
	`put_uÇligÃd
(
	`ýu_to_be32
(
ts
),

2779 (
__be32
 *)&
bufãr
[
off£t
 + 20]);

2781 
	`memýy
(&
bufãr
[
off£t
 + 24], 
»g
->
Œª¥Üt_id
, 
ts
);

2783 
off£t
 +ð
»c_Ën
;

2785 
size
 +ð
»c_Ën
;

2788 
	`put_uÇligÃd
(
	`ýu_to_be32
(
size
), (
__be32
 *)&
bufãr
[4]);

2790 
sk
:

2791 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
off£t
);

2793 
	`TRACE_EXIT
();

2795 
	}
}

	@/root/Desktop/scst-2.2.0/src/scst_pres.h

19 #iâdeà
SCST_PRES_H_


20 
	#SCST_PRES_H_


	)

22 
	~<lšux/d–ay.h
>

24 
	#PR_REGISTER
 0x00

	)

25 
	#PR_RESERVE
 0x01

	)

26 
	#PR_RELEASE
 0x02

	)

27 
	#PR_CLEAR
 0x03

	)

28 
	#PR_PREEMPT
 0x04

	)

29 
	#PR_PREEMPT_AND_ABORT
 0x05

	)

30 
	#PR_REGISTER_AND_IGNORE
 0x06

	)

31 
	#PR_REGISTER_AND_MOVE
 0x07

	)

33 
	#PR_READ_KEYS
 0x00

	)

34 
	#PR_READ_RESERVATION
 0x01

	)

35 
	#PR_REPORT_CAPS
 0x02

	)

36 
	#PR_READ_FULL_STATUS
 0x03

	)

38 
	#TYPE_UNSPECIFIED
 (-1)

	)

39 
	#TYPE_WRITE_EXCLUSIVE
 0x01

	)

40 
	#TYPE_EXCLUSIVE_ACCESS
 0x03

	)

41 
	#TYPE_WRITE_EXCLUSIVE_REGONLY
 0x05

	)

42 
	#TYPE_EXCLUSIVE_ACCESS_REGONLY
 0x06

	)

43 
	#TYPE_WRITE_EXCLUSIVE_ALL_REG
 0x07

	)

44 
	#TYPE_EXCLUSIVE_ACCESS_ALL_REG
 0x08

	)

46 
	#SCOPE_LU
 0x00

	)

48 
šlše
 
	$sc¡_šc_´_»ad”s_couÁ
(
sc¡_cmd
 *
cmd
,

49 
boÞ
 
locked
)

51 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

53 
	`EXTRACHECKS_BUG_ON
(
cmd
->
dec_´_»ad”s_couÁ_Ãeded
);

55 ià(!
locked
)

56 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

58 #ifdeà
CONFIG_SMP


59 
	`EXTRACHECKS_BUG_ON
(!
	`¥š_is_locked
(&
dev
->
dev_lock
));

62 
dev
->
´_»ad”s_couÁ
++;

63 
cmd
->
dec_´_»ad”s_couÁ_Ãeded
 = 1;

64 
	`TRACE_DBG
("New inø´_»ad”s_couÁ %d (cmd %p)", 
dev
->
´_»ad”s_couÁ
,

65 
cmd
);

67 ià(!
locked
)

68 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

70 
	}
}

72 
šlše
 
	$sc¡_dec_´_»ad”s_couÁ
(
sc¡_cmd
 *
cmd
,

73 
boÞ
 
locked
)

75 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

77 ià(
	`uÆik–y
(!
cmd
->
dec_´_»ad”s_couÁ_Ãeded
)) {

78 
	`PRINT_ERROR
("scst_check_local_events() should‚ot be called "

80 "sc¡_´e_check_loÿl_ev’ts(èš¡—d.", 
cmd
,

81 
cmd
->
cdb
[0]);

82 
	`WARN_ON
(1);

83 
out
;

86 ià(!
locked
)

87 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

89 #ifdeà
CONFIG_SMP


90 
	`EXTRACHECKS_BUG_ON
(!
	`¥š_is_locked
(&
dev
->
dev_lock
));

93 
dev
->
´_»ad”s_couÁ
--;

94 
cmd
->
dec_´_»ad”s_couÁ_Ãeded
 = 0;

95 
	`TRACE_DBG
("New deø´_»ad”s_couÁ %d (cmd %p)", 
dev
->
´_»ad”s_couÁ
,

96 
cmd
);

98 ià(!
locked
)

99 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

101 
out
:

102 
	`EXTRACHECKS_BUG_ON
(
dev
->
´_»ad”s_couÁ
 < 0);

104 
	}
}

106 
šlše
 
	$sc¡_»£t_»queued_cmd
(
sc¡_cmd
 *
cmd
)

108 
	`TRACE_DBG
("Re£ˆ»queued cmd %°(Ý %x)", 
cmd
, cmd->
cdb
[0]);

109 
	`sc¡_šc_´_»ad”s_couÁ
(
cmd
, 
çl£
);

110 
cmd
->
check_loÿl_ev’ts_Úû_dÚe
 = 0;

112 
	}
}

114 
šlše
 
boÞ
 
	$sc¡_´_ty³_v®id
(
ušt8_t
 
ty³
)

116 
ty³
) {

117 
TYPE_WRITE_EXCLUSIVE
:

118 
TYPE_EXCLUSIVE_ACCESS
:

119 
TYPE_WRITE_EXCLUSIVE_REGONLY
:

120 
TYPE_EXCLUSIVE_ACCESS_REGONLY
:

121 
TYPE_WRITE_EXCLUSIVE_ALL_REG
:

122 
TYPE_EXCLUSIVE_ACCESS_ALL_REG
:

123  
Œue
;

125  
çl£
;

127 
	}
}

129 
šlše
 
boÞ
 
	$sc¡_´_»ad_lock
(
sc¡_cmd
 *
cmd
)

131 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

132 
boÞ
 
uÆock
 = 
çl£
;

134 
	`TRACE_ENTRY
();

136 
	`smp_mb
();

137 ià(
	`uÆik–y
(
dev
->
´_wr™”_aùive
)) {

138 
uÆock
 = 
Œue
;

139 
	`sc¡_dec_´_»ad”s_couÁ
(
cmd
, 
çl£
);

140 
	`mu‹x_lock
(&
dev
->
dev_´_mu‹x
);

143 
	`TRACE_EXIT_RES
(
uÆock
);

144  
uÆock
;

145 
	}
}

147 
šlše
 
	$sc¡_´_»ad_uÆock
(
sc¡_cmd
 *
cmd
, 
boÞ
 
uÆock
)

149 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

151 
	`TRACE_ENTRY
();

153 ià(
	`uÆik–y
(
uÆock
))

154 
	`mu‹x_uÆock
(&
dev
->
dev_´_mu‹x
);

156 
	`sc¡_dec_´_»ad”s_couÁ
(
cmd
, 
çl£
);

158 
	`TRACE_EXIT
();

160 
	}
}

162 
šlše
 
	$sc¡_´_wr™e_lock
(
sc¡_deviû
 *
dev
)

164 
	`TRACE_ENTRY
();

166 
	`mu‹x_lock
(&
dev
->
dev_´_mu‹x
);

168 
dev
->
´_wr™”_aùive
 = 1;

170 
	`smp_mb
();

172 
Œue
) {

173 
»ad”s
;

174 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

175 
»ad”s
 = 
dev
->
´_»ad”s_couÁ
;

176 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

177 ià(
»ad”s
 == 0)

179 
	`TRACE_DBG
("Wa™šg fÜ %d„—d” (dev %p)", 
»ad”s
, 
dev
);

180 
	`m¦“p
(1);

183 
	`TRACE_EXIT
();

185 
	}
}

187 
šlše
 
	$sc¡_´_wr™e_uÆock
(
sc¡_deviû
 *
dev
)

189 
	`TRACE_ENTRY
();

191 
dev
->
´_wr™”_aùive
 = 0;

192 
	`mu‹x_uÆock
(&
dev
->
dev_´_mu‹x
);

194 
	`TRACE_EXIT
();

196 
	}
}

198 
sc¡_´_š™_dev
(
sc¡_deviû
 *
dev
);

199 
sc¡_´_þ—r_dev
(
sc¡_deviû
 *
dev
);

201 
sc¡_´_š™_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

202 
sc¡_´_þ—r_tgt_dev
(
sc¡_tgt_dev
 *
tgt_dev
);

204 
boÞ
 
sc¡_´_üh_ÿ£
(
sc¡_cmd
 *
cmd
);

205 
boÞ
 
sc¡_´_is_cmd_®lowed
(
sc¡_cmd
 *
cmd
);

207 
sc¡_´_»gi¡”
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

208 
sc¡_´_»gi¡”_ªd_ignÜe
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

209 
bufãr_size
);

210 
sc¡_´_»gi¡”_ªd_move
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

211 
bufãr_size
);

212 
sc¡_´_»£rve
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

213 
sc¡_´_»Ëa£
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

214 
sc¡_´_þ—r
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

215 
sc¡_´_´“m±
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

216 
sc¡_´_´“m±_ªd_abÜt
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

217 
bufãr_size
);

219 
sc¡_´_»ad_keys
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

220 
sc¡_´_»ad_»£rv©iÚ
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

221 
bufãr_size
);

222 
sc¡_´_»pÜt_ÿps
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
, 
bufãr_size
);

223 
sc¡_´_»ad_fuÎ_¡©us
(
sc¡_cmd
 *
cmd
, 
ušt8_t
 *
bufãr
,

224 
bufãr_size
);

226 #iâdeà
CONFIG_SCST_PROC


227 
sc¡_´_sync_deviû_fže
(
sc¡_tgt_dev
 *
tgt_dev
, 
sc¡_cmd
 *
cmd
);

230 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

231 
sc¡_´_dump_´s
(
sc¡_deviû
 *
dev
, 
boÞ
 
fÜû
);

233 
šlše
 
	$sc¡_´_dump_´s
(
sc¡_deviû
 *
dev
, 
boÞ
 
fÜû
è{
	}
}

	@/root/Desktop/scst-2.2.0/src/scst_priv.h

20 #iâdeà
__SCST_PRIV_H


21 
	#__SCST_PRIV_H


	)

23 
	~<lšux/ty³s.h
>

24 
	~<lšux/¦ab.h
>

25 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(3, 2, 0)

26 
	~<lšux/expÜt.h
>

28 
	~<scsi/scsi.h
>

29 
	~<scsi/scsi_cmnd.h
>

30 
	~<scsi/scsi_driv”.h
>

31 
	~<scsi/scsi_deviû.h
>

32 
	~<scsi/scsi_ho¡.h
>

34 
	#LOG_PREFIX
 "sc¡"

	)

36 #ifdeà
INSIDE_KERNEL_TREE


37 
	~<sc¡/sc¡_debug.h
>

39 
	~"sc¡_debug.h
"

42 
	#TRACE_RTRY
 0x80000000

	)

43 
	#TRACE_SCSI_SERIALIZING
 0x40000000

	)

45 
	#TRACE_SND_TOP
 0x20000000

	)

46 
	#TRACE_RCV_TOP
 0x01000000

	)

48 
	#TRACE_SND_BOT
 0x08000000

	)

49 
	#TRACE_RCV_BOT
 0x04000000

	)

51 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

52 
	#Œaû_æag
 
sc¡_Œaû_æag


	)

53 
sc¡_Œaû_æag
;

56 #ifdeà
CONFIG_SCST_DEBUG


58 
	#SCST_DEFAULT_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MINOR
 | 
TRACE_PID
 | \

59 
TRACE_LINE
 | 
TRACE_FUNCTION
 | 
TRACE_SPECIAL
 | 
TRACE_MGMT
 | \

60 
TRACE_MGMT_DEBUG
 | 
TRACE_RTRY
)

	)

62 
	#TRACE_RETRY
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_RTRY
,‡rgs)

	)

63 
	#TRACE_SN
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_SCSI_SERIALIZING
,‡rgs)

	)

64 
	#TRACE_SEND_TOP
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_SND_TOP
,‡rgs)

	)

65 
	#TRACE_RECV_TOP
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_RCV_TOP
,‡rgs)

	)

66 
	#TRACE_SEND_BOT
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_SND_BOT
,‡rgs)

	)

67 
	#TRACE_RECV_BOT
(
¬gs
...è
	`TRACE_DBG_FLAG
(
TRACE_RCV_BOT
,‡rgs)

	)

71 #ifdeà
CONFIG_SCST_TRACING


72 
	#SCST_DEFAULT_LOG_FLAGS
 (
TRACE_OUT_OF_MEM
 | 
TRACE_MGMT
 | \

73 
TRACE_SPECIAL
)

	)

75 
	#SCST_DEFAULT_LOG_FLAGS
 0

	)

78 
	#TRACE_RETRY
(
¬gs
...)

	)

79 
	#TRACE_SN
(
¬gs
...)

	)

80 
	#TRACE_SEND_TOP
(
¬gs
...)

	)

81 
	#TRACE_RECV_TOP
(
¬gs
...)

	)

82 
	#TRACE_SEND_BOT
(
¬gs
...)

	)

83 
	#TRACE_RECV_BOT
(
¬gs
...)

	)

96 
	#SCST_FLAG_SUSPENDING
 0

	)

99 
	#SCST_FLAG_SUSPENDED
 1

	)

105 
	#SCST_CMD_STATE_RES_CONT_NEXT
 
SCST_EXEC_COMPLETED


	)

106 
	#SCST_CMD_STATE_RES_CONT_SAME
 
SCST_EXEC_NOT_COMPLETED


	)

107 
	#SCST_CMD_STATE_RES_NEED_THREAD
 (
SCST_EXEC_NOT_COMPLETED
+1)

	)

113 
	#SCST_MAX_TGT_DEV_COMMANDS
 48

	)

120 
	#SCST_MAX_DEV_COMMANDS
 256

	)

122 
	#SCST_TGT_RETRY_TIMEOUT
 (3/2*
HZ
)

	)

125 
	#SCST_SUSPENDING_TIMEOUT
 (90 * 
HZ
)

	)

127 
mu‹x
 
sc¡_mu‹x2
;

129 
sc¡_th»ads
;

131 
sc¡_max_dev_cmd_mem
;

133 
mempoÞ_t
 *
sc¡_mgmt_mempoÞ
;

134 
mempoÞ_t
 *
sc¡_mgmt_¡ub_mempoÞ
;

135 
mempoÞ_t
 *
sc¡_ua_mempoÞ
;

136 
mempoÞ_t
 *
sc¡_£n£_mempoÞ
;

137 
mempoÞ_t
 *
sc¡_«n_mempoÞ
;

139 
kmem_ÿche
 *
sc¡_cmd_ÿch•
;

140 
kmem_ÿche
 *
sc¡_£ss_ÿch•
;

141 
kmem_ÿche
 *
sc¡_tgtd_ÿch•
;

142 
kmem_ÿche
 *
sc¡_acgd_ÿch•
;

144 
¥šlock_t
 
sc¡_maš_lock
;

146 
sc¡_æags
;

147 
li¡_h—d
 
sc¡_‹m¶©e_li¡
;

148 
li¡_h—d
 
sc¡_dev_li¡
;

149 
li¡_h—d
 
sc¡_dev_ty³_li¡
;

150 
li¡_h—d
 
sc¡_vœtu®_dev_ty³_li¡
;

151 
wa™_queue_h—d_t
 
sc¡_dev_cmd_wa™Q
;

153 #ifdeà
CONFIG_SCST_PROC


154 
li¡_h—d
 
sc¡_acg_li¡
;

155 
sc¡_acg
 *
sc¡_deçuÉ_acg
;

157 
sc¡_£tup_id
;

160 
	#SCST_DEF_MAX_TASKLET_CMD
 10

	)

161 
sc¡_max_skËt_cmd
;

163 
¥šlock_t
 
sc¡_š™_lock
;

164 
li¡_h—d
 
sc¡_š™_cmd_li¡
;

165 
wa™_queue_h—d_t
 
sc¡_š™_cmd_li¡_wa™Q
;

166 
sc¡_š™_pÞl_út
;

168 
sc¡_cmd_th»ads
 
sc¡_maš_cmd_th»ads
;

170 
¥šlock_t
 
sc¡_mcmd_lock
;

172 
li¡_h—d
 
sc¡_aùive_mgmt_cmd_li¡
;

173 
li¡_h—d
 
sc¡_d–ayed_mgmt_cmd_li¡
;

174 
wa™_queue_h—d_t
 
sc¡_mgmt_cmd_li¡_wa™Q
;

176 
	ssc¡_³rýu_šfo
 {

177 
©omic_t
 
	mýu_cmd_couÁ
;

178 
¥šlock_t
 
	mskËt_lock
;

179 
li¡_h—d
 
	mskËt_cmd_li¡
;

180 
skËt_¡ruù
 
	mskËt
;

181 } 
	g____ÿch–še_®igÃd_š_smp
;

182 
sc¡_³rýu_šfo
 
sc¡_³rýu_šfos
[
NR_CPUS
];

184 
wa™_queue_h—d_t
 
sc¡_mgmt_wa™Q
;

185 
¥šlock_t
 
sc¡_mgmt_lock
;

186 
li¡_h—d
 
sc¡_£ss_š™_li¡
;

187 
li¡_h—d
 
sc¡_£ss_shut_li¡
;

189 
ýumask_t
 
deçuÉ_ýu_mask
;

191 
	ssc¡_cmd_th»ad_t
 {

192 
sk_¡ruù
 *
	mcmd_th»ad
;

193 
li¡_h—d
 
	mth»ad_li¡_’Œy
;

196 
šlše
 
boÞ
 
	$sc¡_£t_io_cÚ‹xt
(
sc¡_cmd
 *
cmd
,

197 
io_cÚ‹xt
 **
Þd
)

199 
boÞ
 
»s
;

201 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

202  
çl£
;

205 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


206  
çl£
;

209 ià(
cmd
->
cmd_th»ads
 =ð&
sc¡_maš_cmd_th»ads
) {

210 
	`EXTRACHECKS_BUG_ON
(
	`š_š‹¼u±
());

215 
cu¼’t
->
io_cÚ‹xt
 = 
cmd
->
tgt_dev
->
async_io_cÚ‹xt
;

216 
»s
 = 
Œue
;

217 
	`TRACE_DBG
("io_cÚ‹xˆ%°Ñgt_dev %p)", 
cu¼’t
->
io_cÚ‹xt
,

218 
cmd
->
tgt_dev
);

219 
	`EXTRACHECKS_BUG_ON
(
cu¼’t
->
io_cÚ‹xt
 =ð
NULL
);

221 
»s
 = 
çl£
;

223  
»s
;

224 
	}
}

226 
šlše
 
	$sc¡_»£t_io_cÚ‹xt
(
sc¡_tgt_dev
 *
tgt_dev
,

227 
io_cÚ‹xt
 *
Þd
)

229 
cu¼’t
->
io_cÚ‹xt
 = 
Þd
;

230 
	`TRACE_DBG
("io_cÚ‹xˆ%°»£t", 
cu¼’t
->
io_cÚ‹xt
);

232 
	}
}

238 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
sc¡_·r£_th»ads_poÞ_ty³
(

239 cÚ¡ *
p
, 
Ën
);

241 
sc¡_add_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
,

242 
sc¡_deviû
 *
dev
, 
sc¡_tgt_dev
 *
tgt_dev
, 
num
);

243 
sc¡_d–_th»ads
(
sc¡_cmd_th»ads
 *
cmd_th»ads
, 
num
);

245 
sc¡_ü—‹_dev_th»ads
(
sc¡_deviû
 *
dev
);

246 
sc¡_¡Ý_dev_th»ads
(
sc¡_deviû
 *
dev
);

248 
sc¡_tgt_dev_£tup_th»ads
(
sc¡_tgt_dev
 *
tgt_dev
);

249 
sc¡_tgt_dev_¡Ý_th»ads
(
sc¡_tgt_dev
 *
tgt_dev
);

251 
boÞ
 
sc¡_d–_thr_d©a
(
sc¡_tgt_dev
 *
tgt_dev
,

252 
sk_¡ruù
 *
tsk
);

254 
sc¡_dev_ty³
 
sc¡_nuÎ_devty³
;

256 
sc¡_cmd
 *
__sc¡_check_deã¼ed_commªds
(

257 
sc¡_Üd”_d©a
 *
Üd”_d©a
);

260 
šlše
 
sc¡_cmd
 *
	$sc¡_check_deã¼ed_commªds
(

261 
sc¡_Üd”_d©a
 *
Üd”_d©a
)

263 ià(
Üd”_d©a
->
def_cmd_couÁ
 == 0)

264  
NULL
;

266  
	`__sc¡_check_deã¼ed_commªds
(
Üd”_d©a
);

267 
	}
}

269 
šlše
 
	$sc¡_make_deã¼ed_commªds_aùive
(

270 
sc¡_Üd”_d©a
 *
Üd”_d©a
)

272 
sc¡_cmd
 *
c
;

274 
c
 = 
	`__sc¡_check_deã¼ed_commªds
(
Üd”_d©a
);

275 ià(
c
 !ð
NULL
) {

276 
	`TRACE_SN
("Addšg cmd %°tØaùivcmd†i¡", 
c
);

277 
	`¥š_lock_œq
(&
c
->
cmd_th»ads
->
cmd_li¡_lock
);

278 
	`li¡_add_ž
(&
c
->
cmd_li¡_’Œy
,

279 &
c
->
cmd_th»ads
->
aùive_cmd_li¡
);

280 
	`wake_up
(&
c
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

281 
	`¥š_uÆock_œq
(&
c
->
cmd_th»ads
->
cmd_li¡_lock
);

285 
	}
}

287 
sc¡_šc_ex³ùed_¢
(
sc¡_Üd”_d©a
 *
Üd”_d©a
, 
©omic_t
 *
¦Ù
);

288 
sc¡_check_hq_cmd
(
sc¡_cmd
 *
cmd
);

290 
sc¡_unblock_deã¼ed
(
sc¡_Üd”_d©a
 *
Üd”_d©a
,

291 
sc¡_cmd
 *
cmd_¢
);

293 
sc¡_Ú_hq_cmd_»¥Ú£
(
sc¡_cmd
 *
cmd
);

294 
sc¡_xm™_´oûss_abÜ‹d_cmd
(
sc¡_cmd
 *
cmd
);

296 
sc¡_´e_·r£
(
sc¡_cmd
 *
cmd
);

298 
sc¡_cmd_th»ad
(*
¬g
);

299 
sc¡_cmd_skËt
(
p
);

300 
sc¡_š™_th»ad
(*
¬g
);

301 
sc¡_tm_th»ad
(*
¬g
);

302 
sc¡_glob®_mgmt_th»ad
(*
¬g
);

304 
sc¡_z”o_wr™e_»¡
(
sc¡_cmd
 *
cmd
);

305 
sc¡_lim™_sg_wr™e_Ën
(
sc¡_cmd
 *
cmd
);

306 
sc¡_adju¡_»¥_d©a_Ën
(
sc¡_cmd
 *
cmd
);

308 
sc¡_queue_»Œy_cmd
(
sc¡_cmd
 *
cmd
, 
fšished_cmds
);

310 
sc¡_®loc_tgt
(
sc¡_tgt_‹m¶©e
 *
tg‰
, 
sc¡_tgt
 **
tgt
);

311 
sc¡_ä“_tgt
(
sc¡_tgt
 *
tgt
);

313 
sc¡_®loc_deviû
(
gå_t
 
gå_mask
, 
sc¡_deviû
 **
out_dev
);

314 
sc¡_ä“_deviû
(
sc¡_deviû
 *
dev
);

316 
sc¡_acg
 *
sc¡_®loc_add_acg
(
sc¡_tgt
 *
tgt
,

317 cÚ¡ *
acg_Çme
, 
boÞ
 
tgt_acg
);

318 
sc¡_d–_ä“_acg
(
sc¡_acg
 *
acg
);

320 
sc¡_acg
 *
sc¡_tgt_fšd_acg
(
sc¡_tgt
 *
tgt
, cÚ¡ *
Çme
);

321 
sc¡_acg
 *
sc¡_fšd_acg
(cÚ¡ 
sc¡_£ssiÚ
 *
£ss
);

323 
sc¡_check_»assign_£ssiÚs
();

325 
sc¡_£ss_®loc_tgt_devs
(
sc¡_£ssiÚ
 *
£ss
);

326 
sc¡_£ss_ä“_tgt_devs
(
sc¡_£ssiÚ
 *
£ss
);

327 
sc¡_Ãxus_loss
(
sc¡_tgt_dev
 *
tgt_dev
, 
boÞ
 
queue_UA
);

329 
sc¡_acg_add_lun
(
sc¡_acg
 *
acg
, 
kobjeù
 *
·»Á
,

330 
sc¡_deviû
 *
dev
, 
ušt64_t
 
lun
, 
»ad_Úly
,

331 
boÞ
 
g’_sc¡_»pÜt_luns_chªged
, 
sc¡_acg_dev
 **
out_acg_dev
);

332 
sc¡_acg_d–_lun
(
sc¡_acg
 *
acg
, 
ušt64_t
 
lun
,

333 
boÞ
 
g’_sc¡_»pÜt_luns_chªged
);

335 
sc¡_acg_add_aú
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
);

336 #ifdeà
CONFIG_SCST_PROC


337 
sc¡_acg_»move_Çme
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
, 
boÞ
 
»assign
);

339 
sc¡_d–_ä“_aú
(
sc¡_aú
 *
aú
, 
boÞ
 
»assign
);

340 
sc¡_aú
 *
sc¡_fšd_aú
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
);

343 
šlše
 
boÞ
 
	$sc¡_acg_£ss_is_em±y
(
sc¡_acg
 *
acg
)

345  
	`li¡_em±y
(&
acg
->
acg_£ss_li¡
);

346 
	}
}

348 
sc¡_´•¬e_»que¡_£n£
(
sc¡_cmd
 *
Üig_cmd
);

349 
sc¡_fšish_š‹º®_cmd
(
sc¡_cmd
 *
cmd
);

351 
sc¡_¡Üe_£n£
(
sc¡_cmd
 *
cmd
);

353 
sc¡_assign_dev_hªdËr
(
sc¡_deviû
 *
dev
,

354 
sc¡_dev_ty³
 *
hªdËr
);

356 
sc¡_£ssiÚ
 *
sc¡_®loc_£ssiÚ
(
sc¡_tgt
 *
tgt
, 
gå_t
 
gå_mask
,

357 cÚ¡ *
š™ŸtÜ_Çme
);

358 
sc¡_ä“_£ssiÚ
(
sc¡_£ssiÚ
 *
£ss
);

359 
sc¡_ä“_£ssiÚ_ÿÎback
(
sc¡_£ssiÚ
 *
£ss
);

361 
sc¡_cmd
 *
sc¡_®loc_cmd
(cÚ¡ 
ušt8_t
 *
cdb
,

362 
cdb_Ën
, 
gå_t
 
gå_mask
);

363 
sc¡_ä“_cmd
(
sc¡_cmd
 *
cmd
);

364 
šlše
 
	$sc¡_de¡roy_cmd
(
sc¡_cmd
 *
cmd
)

366 
	`kmem_ÿche_ä“
(
sc¡_cmd_ÿch•
, 
cmd
);

368 
	}
}

370 
sc¡_check_»Œ›s
(
sc¡_tgt
 *
tgt
);

372 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 30)

373 
šlše
 
sc¡_exec_»q
(
scsi_deviû
 *
sdev
,

374 cÚ¡ *
cmd
, 
cmd_Ën
, 
d©a_dœeùiÚ
,

375 
sÿ‰”li¡
 *
sgl
, 
bufæ’
, 
ÃÁs
,

376 
timeout
, 
»Œ›s
, *
´ivd©a
,

377 (*
dÚe
)(*, *, , ), 
gå_t
 
gå
)

379 #ià
	`defšed
(
CONFIG_SCST_STRICT_SERIALIZING
)

380  
	`scsi_execu‹_async
(
sdev
, 
cmd
, 
cmd_Ën
, 
d©a_dœeùiÚ
, (*)
sgl
,

381 
bufæ’
, 
ÃÁs
, 
timeout
, 
»Œ›s
, 
´ivd©a
, 
dÚe
, 
gå
);

382 #–ià!
	`defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

383 
	`WARN_ON
(1);

386  
	`scsi_execu‹_async_fifo
(
sdev
, 
cmd
, 
cmd_Ën
, 
d©a_dœeùiÚ
,

387 (*)
sgl
, 
bufæ’
, 
ÃÁs
, 
timeout
, 
»Œ›s
, 
´ivd©a
, 
dÚe
, 
gå
);

389 
	}
}

391 #ià!
defšed
(
SCSI_EXEC_REQ_FIFO_DEFINED
)

392 
šlše
 
sc¡_scsi_exec_async
(
sc¡_cmd
 *
cmd
, *
d©a
,

393 (*
dÚe
)(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
))

395 
	`WARN_ON_ONCE
(1);

397 
	}
}

401 
sc¡_®loc_¥aû
(
sc¡_cmd
 *
cmd
);

403 
sc¡_lib_š™
();

404 
sc¡_lib_ex™
();

406 
__be64
 
sc¡_·ck_lun
(cÚ¡ 
ušt64_t
 
lun
, 
sc¡_lun_addr_m‘hod
 
addr_m‘hod
);

407 
ušt64_t
 
sc¡_uÅack_lun
(cÚ¡ 
ušt8_t
 *
lun
, 
Ën
);

409 
sc¡_mgmt_cmd
 *
sc¡_®loc_mgmt_cmd
(
gå_t
 
gå_mask
);

410 
sc¡_ä“_mgmt_cmd
(
sc¡_mgmt_cmd
 *
mcmd
);

411 
sc¡_dÚe_cmd_mgmt
(
sc¡_cmd
 *
cmd
);

413 
šlše
 
	$sc¡_devt_þ—nup
(
sc¡_dev_ty³
 *
devt
è{ 
	}
}

415 
sc¡_tg_š™
();

416 
sc¡_tg_þ—nup
();

417 
sc¡_dg_add
(
kobjeù
 *
·»Á
, cÚ¡ *
Çme
);

418 
sc¡_dg_»move
(cÚ¡ *
Çme
);

419 
sc¡_dev_group
 *
sc¡_lookup_dg_by_kobj
(
kobjeù
 *
kobj
);

420 
sc¡_dg_dev_add
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
);

421 
sc¡_dg_dev_»move_by_Çme
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
);

422 
sc¡_dg_dev_»move_by_dev
(
sc¡_deviû
 *
dev
);

423 
sc¡_tg_add
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
);

424 
sc¡_tg_»move_by_Çme
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
);

425 
sc¡_tg_£t_¡©e
(
sc¡_rg‘_group
 *
tg
, 
sc¡_tg_¡©e
 
¡©e
);

426 
sc¡_tg_tgt_add
(
sc¡_rg‘_group
 *
tg
, cÚ¡ *
Çme
);

427 
sc¡_tg_tgt_»move_by_Çme
(
sc¡_rg‘_group
 *
tg
, cÚ¡ *
Çme
);

428 
sc¡_tg_tgt_»move_by_tgt
(
sc¡_tgt
 *
tgt
);

429 #iâdeà
CONFIG_SCST_PROC


430 
sc¡_dg_sysfs_add
(
kobjeù
 *
·»Á
, 
sc¡_dev_group
 *
dg
);

431 
sc¡_dg_sysfs_d–
(
sc¡_dev_group
 *
dg
);

432 
sc¡_dg_dev_sysfs_add
(
sc¡_dev_group
 *
dg
, 
sc¡_dg_dev
 *
dgdev
);

433 
sc¡_dg_dev_sysfs_d–
(
sc¡_dev_group
 *
dg
,

434 
sc¡_dg_dev
 *
dgdev
);

435 
sc¡_tg_sysfs_add
(
sc¡_dev_group
 *
dg
,

436 
sc¡_rg‘_group
 *
tg
);

437 
sc¡_tg_sysfs_d–
(
sc¡_rg‘_group
 *
tg
);

438 
sc¡_tg_tgt_sysfs_add
(
sc¡_rg‘_group
 *
tg
,

439 
sc¡_tg_tgt
 *
tg_tgt
);

440 
sc¡_tg_tgt_sysfs_d–
(
sc¡_rg‘_group
 *
tg
,

441 
sc¡_tg_tgt
 *
tg_tgt
);

443 
šlše
 
	$sc¡_dg_sysfs_add
(
kobjeù
 *
·»Á
,

444 
sc¡_dev_group
 *
dg
)

447 
	}
}

448 
šlše
 
	$sc¡_dg_sysfs_d–
(
sc¡_dev_group
 *
dg
)

450 
	}
}

451 
šlše
 
	$sc¡_dg_dev_sysfs_add
(
sc¡_dev_group
 *
dg
,

452 
sc¡_dg_dev
 *
dgdev
)

455 
	}
}

456 
šlše
 
	$sc¡_dg_dev_sysfs_d–
(
sc¡_dev_group
 *
dg
,

457 
sc¡_dg_dev
 *
dgdev
)

459 
	}
}

460 
šlše
 
	$sc¡_tg_sysfs_add
(
sc¡_dev_group
 *
dg
,

461 
sc¡_rg‘_group
 *
tg
)

464 
	}
}

465 
šlše
 
	$sc¡_tg_sysfs_d–
(
sc¡_rg‘_group
 *
tg
)

467 
	}
}

468 
šlše
 
	$sc¡_tg_tgt_sysfs_add
(
sc¡_rg‘_group
 *
tg
,

469 
sc¡_tg_tgt
 *
tg_tgt
)

472 
	}
}

473 
šlše
 
	$sc¡_tg_tgt_sysfs_d–
(
sc¡_rg‘_group
 *
tg
,

474 
sc¡_tg_tgt
 *
tg_tgt
)

476 
	}
}

479 #ifdeà
CONFIG_SCST_PROC


481 
sc¡_´oc_š™_moduË
();

482 
sc¡_´oc_þ—nup_moduË
();

483 
sc¡_bužd_´oc_rg‘_dœ_’Œ›s
(
sc¡_tgt_‹m¶©e
 *
v‰
);

484 
sc¡_þ—nup_´oc_rg‘_dœ_’Œ›s
(
sc¡_tgt_‹m¶©e
 *
v‰
);

485 
sc¡_bužd_´oc_rg‘_’Œ›s
(
sc¡_tgt
 *
v‰
);

486 
sc¡_þ—nup_´oc_rg‘_’Œ›s
(
sc¡_tgt
 *
v‰
);

487 
sc¡_bužd_´oc_dev_hªdËr_dœ_’Œ›s
(
sc¡_dev_ty³
 *
dev_ty³
);

488 
sc¡_þ—nup_´oc_dev_hªdËr_dœ_’Œ›s
(
sc¡_dev_ty³
 *
dev_ty³
);

490 
šlše
 
	$sc¡_sysfs_š™
()

493 
	}
}

494 
šlše
 
	$sc¡_sysfs_þ—nup
(è{ 
	}
}

496 
šlše
 
	$sc¡_devt_dev_sysfs_ü—‹
(
sc¡_deviû
 *
dev
)

499 
	}
}

500 
šlše
 
	$sc¡_devt_dev_sysfs_d–
(
sc¡_deviû
 *
dev
è{ 
	}
}

502 
šlše
 
	$sc¡_dev_sysfs_d–
(
sc¡_deviû
 *
dev
è{ 
	}
}

504 
šlše
 
	$sc¡_tgt_dev_sysfs_ü—‹
(
sc¡_tgt_dev
 *
tgt_dev
)

507 
	}
}

508 
šlše
 
	$sc¡_tgt_dev_sysfs_d–
(
sc¡_tgt_dev
 *
tgt_dev
è{ 
	}
}

510 
šlše
 
	$sc¡_£ss_sysfs_ü—‹
(
sc¡_£ssiÚ
 *
£ss
)

513 
	}
}

515 
šlše
 
	$sc¡_acg_dev_sysfs_ü—‹
(
sc¡_acg_dev
 *
acg_dev
,

516 
kobjeù
 *
·»Á
)

519 
	}
}

521 
šlše
 
	$sc¡_acg_dev_sysfs_d–
(
sc¡_acg_dev
 *
acg_dev
è{ 
	}
}

523 
šlše
 
	$sc¡_aú_sysfs_ü—‹
(
sc¡_aú
 *
aú
)

526 
	}
}

527 
šlše
 
	$sc¡_aú_sysfs_d–
(
sc¡_aú
 *
aú
è{ 
	}
}

531 #ià
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 34)

532 cÚ¡ 
sysfs_Ýs
 
sc¡_sysfs_Ýs
;

534 
sysfs_Ýs
 
sc¡_sysfs_Ýs
;

536 
sc¡_sysfs_š™
();

537 
sc¡_sysfs_þ—nup
();

538 
sc¡_tg‰_sysfs_ü—‹
(
sc¡_tgt_‹m¶©e
 *
tg‰
);

539 
sc¡_tg‰_sysfs_d–
(
sc¡_tgt_‹m¶©e
 *
tg‰
);

540 
sc¡_tgt_sysfs_ü—‹
(
sc¡_tgt
 *
tgt
);

541 
sc¡_tgt_sysfs_´•¬e_put
(
sc¡_tgt
 *
tgt
);

542 
sc¡_tgt_sysfs_d–
(
sc¡_tgt
 *
tgt
);

543 
sc¡_£ss_sysfs_ü—‹
(
sc¡_£ssiÚ
 *
£ss
);

544 
sc¡_£ss_sysfs_d–
(
sc¡_£ssiÚ
 *
£ss
);

545 
sc¡_»ü—‹_£ss_luns_lšk
(
sc¡_£ssiÚ
 *
£ss
);

546 
sc¡_add_sgv_kobj
(
kobjeù
 *
·»Á
, cÚ¡ *
Çme
);

547 
sc¡_d–_put_sgv_kobj
();

548 
sc¡_devt_sysfs_ü—‹
(
sc¡_dev_ty³
 *
devt
);

549 
sc¡_devt_sysfs_d–
(
sc¡_dev_ty³
 *
devt
);

550 
sc¡_dev_sysfs_ü—‹
(
sc¡_deviû
 *
dev
);

551 
sc¡_dev_sysfs_d–
(
sc¡_deviû
 *
dev
);

552 
sc¡_tgt_dev_sysfs_ü—‹
(
sc¡_tgt_dev
 *
tgt_dev
);

553 
sc¡_tgt_dev_sysfs_d–
(
sc¡_tgt_dev
 *
tgt_dev
);

554 
sc¡_devt_dev_sysfs_ü—‹
(
sc¡_deviû
 *
dev
);

555 
sc¡_devt_dev_sysfs_d–
(
sc¡_deviû
 *
dev
);

556 
sc¡_acg_sysfs_ü—‹
(
sc¡_tgt
 *
tgt
,

557 
sc¡_acg
 *
acg
);

558 
sc¡_acg_sysfs_d–
(
sc¡_acg
 *
acg
);

559 
sc¡_acg_dev_sysfs_ü—‹
(
sc¡_acg_dev
 *
acg_dev
,

560 
kobjeù
 *
·»Á
);

561 
sc¡_acg_dev_sysfs_d–
(
sc¡_acg_dev
 *
acg_dev
);

562 
sc¡_aú_sysfs_ü—‹
(
sc¡_aú
 *
aú
);

563 
sc¡_aú_sysfs_d–
(
sc¡_aú
 *
aú
);

567 
__sc¡_dev_check_£t_UA
(
sc¡_deviû
 *
dev
, 
sc¡_cmd
 *
exþude
,

568 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
);

569 
sc¡_tgt_dev_d–_ä“_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

570 
sc¡_tgt_dev_UA
 *
ua
);

571 
šlše
 
	$sc¡_dev_check_£t_UA
(
sc¡_deviû
 *
dev
,

572 
sc¡_cmd
 *
exþude
, cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
)

574 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

575 
	`__sc¡_dev_check_£t_UA
(
dev
, 
exþude
, 
£n£
, 
£n£_Ën
);

576 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

578 
	}
}

579 
sc¡_dev_check_£t_loÿl_UA
(
sc¡_deviû
 *
dev
,

580 
sc¡_cmd
 *
exþude
, cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
);

582 
	#SCST_SET_UA_FLAG_AT_HEAD
 1

	)

583 
	#SCST_SET_UA_FLAG_GLOBAL
 2

	)

585 
sc¡_check_£t_UA
(
sc¡_tgt_dev
 *
tgt_dev
,

586 cÚ¡ 
ušt8_t
 *
£n£
, 
£n£_Ën
, 
æags
);

587 
sc¡_£t_³ndšg_UA
(
sc¡_cmd
 *
cmd
);

589 
sc¡_»pÜt_luns_chªged
(
sc¡_acg
 *
acg
);

591 
sc¡_abÜt_cmd
(
sc¡_cmd
 *
cmd
, 
sc¡_mgmt_cmd
 *
mcmd
,

592 
boÞ
 
Ùh”_ši
, boÞ 
ÿÎ_dev_sk_mgmt_â
);

593 
sc¡_´oûss_»£t
(
sc¡_deviû
 *
dev
,

594 
sc¡_£ssiÚ
 *
Üigš©Ü
, 
sc¡_cmd
 *
exþude_cmd
,

595 
sc¡_mgmt_cmd
 *
mcmd
, 
boÞ
 
£tUA
);

597 
boÞ
 
sc¡_is_ua_glob®
(cÚ¡ 
ušt8_t
 *
£n£
, 
Ën
);

598 
sc¡_»queue_ua
(
sc¡_cmd
 *
cmd
);

600 
sc¡_«n
 *
sc¡_®loc_«n
(
sc¡_£ssiÚ
 *
£ss
,

601 
ušt64_t
 
uÅacked_lun
);

602 
sc¡_ä“_«n
(
sc¡_«n
 *
«n
);

604 
sc¡_g’_«n_Ü_ua
(
sc¡_tgt_dev
 *
tgt_dev
,

605 
key
, 
asc
, 
ascq
);

607 
šlše
 
boÞ
 
	$sc¡_is_im¶ic™_hq_cmd
(
sc¡_cmd
 *
cmd
)

609  (
cmd
->
Ý_æags
 & 
SCST_IMPLICIT_HQ
) != 0;

610 
	}
}

612 
šlše
 
boÞ
 
	$sc¡_is_£rŸlized_cmd
(
sc¡_cmd
 *
cmd
)

614  (
cmd
->
Ý_æags
 & 
SCST_SERIALIZED
) != 0;

615 
	}
}

617 
šlše
 
boÞ
 
	$sc¡_is_¡riùly_£rŸlized_cmd
(
sc¡_cmd
 *
cmd
)

619  (
cmd
->
Ý_æags
 & 
SCST_STRICTLY_SERIALIZED
) == SCST_STRICTLY_SERIALIZED;

620 
	}
}

629 
sc¡_block_dev
(
sc¡_deviû
 *
dev
);

630 
sc¡_unblock_dev
(
sc¡_deviû
 *
dev
);

632 
boÞ
 
__sc¡_check_blocked_dev
(
sc¡_cmd
 *
cmd
);

638 
šlše
 
©omic_t
 *
	$sc¡_g‘
()

640 
©omic_t
 *
a
;

646 #ifdeà
CONFIG_DEBUG_PREEMPT


647 
	`´“m±_di§bË
();

649 
a
 = &
sc¡_³rýu_šfos
[
	`smp_´oûssÜ_id
()].
ýu_cmd_couÁ
;

650 
	`©omic_šc
(
a
);

651 #ifdeà
CONFIG_DEBUG_PREEMPT


652 
	`´“m±_’abË
();

654 
	`TRACE_DBG
("Incrementing cpu_cmd_count %p (new value %d)",

655 
a
, 
	`©omic_»ad
(a));

657 
	`smp_mb__aá”_©omic_šc
();

659  
a
;

660 
	}
}

667 
šlše
 
	$sc¡_put
(
©omic_t
 *
a
)

669 
f
;

670 
f
 = 
	`©omic_dec_ªd_‹¡
(
a
);

672 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
)è&& 
f
) {

673 
	`TRACE_MGMT_DBG
("%s", "Waking up scst_dev_cmd_waitQ");

674 
	`wake_up_®l
(&
sc¡_dev_cmd_wa™Q
);

676 
	`TRACE_DBG
("Decrementing cpu_cmd_count %p (new value %d)",

677 
a
, 
	`©omic_»ad
(a));

678 
	}
}

680 
sc¡_g‘_cmd_couÁ”
();

682 
sc¡_sched_£ssiÚ_ä“
(
sc¡_£ssiÚ
 *
£ss
);

684 
šlše
 
	$sc¡_£ss_g‘
(
sc¡_£ssiÚ
 *
£ss
)

686 
	`©omic_šc
(&
£ss
->
»fút
);

687 
	`TRACE_DBG
("Incrementing sess %p„efcnt (new value %d)",

688 
£ss
, 
	`©omic_»ad
(&£ss->
»fút
));

689 
	}
}

691 
šlše
 
	$sc¡_£ss_put
(
sc¡_£ssiÚ
 *
£ss
)

693 
	`TRACE_DBG
("Decrementing sess %p„efcnt (new value %d)",

694 
£ss
, 
	`©omic_»ad
(&£ss->
»fút
)-1);

695 ià(
	`©omic_dec_ªd_‹¡
(&
£ss
->
»fút
))

696 
	`sc¡_sched_£ssiÚ_ä“
(
£ss
);

697 
	}
}

699 
šlše
 
	$__sc¡_cmd_g‘
(
sc¡_cmd
 *
cmd
)

701 
	`©omic_šc
(&
cmd
->
cmd_»f
);

702 
	`TRACE_DBG
("Incrementing cmd %p„ef (new value %d)",

703 
cmd
, 
	`©omic_»ad
(&cmd->
cmd_»f
));

704 
	}
}

706 
šlše
 
	$__sc¡_cmd_put
(
sc¡_cmd
 *
cmd
)

708 
	`TRACE_DBG
("Decrementing cmd %p„ef (new value %d)",

709 
cmd
, 
	`©omic_»ad
(&cmd->
cmd_»f
)-1);

710 ià(
	`©omic_dec_ªd_‹¡
(&
cmd
->
cmd_»f
))

711 
	`sc¡_ä“_cmd
(
cmd
);

712 
	}
}

714 
sc¡_thrÙŽe_cmd
(
sc¡_cmd
 *
cmd
);

715 
sc¡_uÁhrÙŽe_cmd
(
sc¡_cmd
 *
cmd
);

717 #ifdeà
CONFIG_SCST_DEBUG_TM


718 
tm_dbg_check_»Ëa£d_cmds
();

719 
tm_dbg_check_cmd
(
sc¡_cmd
 *
cmd
);

720 
tm_dbg_»Ëa£_cmd
(
sc¡_cmd
 *
cmd
);

721 
tm_dbg_sk_mgmt
(
sc¡_deviû
 *
dev
, cÚ¡ *
â
,

722 
fÜû
);

723 
tm_dbg_is_»Ëa£
();

725 
šlše
 
	$tm_dbg_check_»Ëa£d_cmds
(è{
	}
}

726 
šlše
 
	$tm_dbg_check_cmd
(
sc¡_cmd
 *
cmd
)

729 
	}
}

730 
šlše
 
	$tm_dbg_»Ëa£_cmd
(
sc¡_cmd
 *
cmd
è{
	}
}

731 
šlše
 
	$tm_dbg_sk_mgmt
(
sc¡_deviû
 *
dev
, cÚ¡ *
â
,

732 
fÜû
è{
	}
}

733 
šlše
 
	$tm_dbg_is_»Ëa£
()

736 
	}
}

739 #ifdeà
CONFIG_SCST_DEBUG_SN


740 
sc¡_check_debug_¢
(
sc¡_cmd
 *
cmd
);

742 
šlše
 
	$sc¡_check_debug_¢
(
sc¡_cmd
 *
cmd
è{
	}
}

745 
šlše
 
	$sc¡_¢_befÜe
(
ušt32_t
 
£q1
, ušt32_ˆ
£q2
)

747  (
št32_t
)(
£q1
-
£q2
) < 0;

748 
	}
}

750 
g’_»Ïtive_rg‘_pÜt_id
(
ušt16_t
 *
id
);

751 
boÞ
 
sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
ušt16_t
 
id
,

752 cÚ¡ 
sc¡_tgt
 *
t
);

754 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


756 
sc¡_£t_¡¬t_time
(
sc¡_cmd
 *
cmd
);

757 
sc¡_£t_cur_¡¬t
(
sc¡_cmd
 *
cmd
);

758 
sc¡_£t_·r£_time
(
sc¡_cmd
 *
cmd
);

759 
sc¡_£t_®loc_buf_time
(
sc¡_cmd
 *
cmd
);

760 
sc¡_£t_»¡¬t_wa™šg_time
(
sc¡_cmd
 *
cmd
);

761 
sc¡_£t_rdy_to_xãr_time
(
sc¡_cmd
 *
cmd
);

762 
sc¡_£t_´e_exec_time
(
sc¡_cmd
 *
cmd
);

763 
sc¡_£t_exec_time
(
sc¡_cmd
 *
cmd
);

764 
sc¡_£t_dev_dÚe_time
(
sc¡_cmd
 *
cmd
);

765 
sc¡_£t_xm™_time
(
sc¡_cmd
 *
cmd
);

766 
sc¡_£t_tgt_Ú_ä“_time
(
sc¡_cmd
 *
cmd
);

767 
sc¡_£t_dev_Ú_ä“_time
(
sc¡_cmd
 *
cmd
);

768 
sc¡_upd©e_Ït_¡©s
(
sc¡_cmd
 *
cmd
);

772 
šlše
 
	$sc¡_£t_¡¬t_time
(
sc¡_cmd
 *
cmd
è{
	}
}

773 
šlše
 
	$sc¡_£t_cur_¡¬t
(
sc¡_cmd
 *
cmd
è{
	}
}

774 
šlše
 
	$sc¡_£t_·r£_time
(
sc¡_cmd
 *
cmd
è{
	}
}

775 
šlše
 
	$sc¡_£t_®loc_buf_time
(
sc¡_cmd
 *
cmd
è{
	}
}

776 
šlše
 
	$sc¡_£t_»¡¬t_wa™šg_time
(
sc¡_cmd
 *
cmd
è{
	}
}

777 
šlše
 
	$sc¡_£t_rdy_to_xãr_time
(
sc¡_cmd
 *
cmd
è{
	}
}

778 
šlše
 
	$sc¡_£t_´e_exec_time
(
sc¡_cmd
 *
cmd
è{
	}
}

779 
šlše
 
	$sc¡_£t_exec_time
(
sc¡_cmd
 *
cmd
è{
	}
}

780 
šlše
 
	$sc¡_£t_dev_dÚe_time
(
sc¡_cmd
 *
cmd
è{
	}
}

781 
šlše
 
	$sc¡_£t_xm™_time
(
sc¡_cmd
 *
cmd
è{
	}
}

782 
šlše
 
	$sc¡_£t_tgt_Ú_ä“_time
(
sc¡_cmd
 *
cmd
è{
	}
}

783 
šlše
 
	$sc¡_£t_dev_Ú_ä“_time
(
sc¡_cmd
 *
cmd
è{
	}
}

784 
šlše
 
	$sc¡_upd©e_Ït_¡©s
(
sc¡_cmd
 *
cmd
è{
	}
}

	@/root/Desktop/scst-2.2.0/src/scst_proc.c

20 
	~<lšux/moduË.h
>

22 
	~<lšux/š™.h
>

23 
	~<lšux/k”Ãl.h
>

24 
	~<lšux/”ºo.h
>

25 
	~<lšux/li¡.h
>

26 
	~<lšux/¥šlock.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<lšux/sched.h
>

29 
	~<lšux/uni¡d.h
>

30 
	~<lšux/¡ršg.h
>

31 
	~<lšux/´oc_fs.h
>

32 
	~<lšux/£q_fže.h
>

34 #ifdeà
INSIDE_KERNEL_TREE


35 
	~<sc¡/sc¡.h
>

37 
	~"sc¡.h
"

39 
	~"sc¡_´iv.h
"

40 
	~"sc¡_mem.h
"

41 
	~"sc¡_´es.h
"

43 
sc¡_´oc_š™_groups
();

44 
sc¡_´oc_þ—nup_groups
();

45 
sc¡_´oc_assign_hªdËr
(*
buf
);

46 
sc¡_´oc_group_add
(cÚ¡ *
p
, 
addr_m‘hod
);

47 
sc¡_´oc_d–_ä“_acg
(
sc¡_acg
 *
acg
, 
»move_´oc
);

49 
sc¡_´oc_d©a
 
	gsc¡_v”siÚ_´oc_d©a
;

50 
sc¡_´oc_d©a
 
	gsc¡_h–p_´oc_d©a
;

51 
sc¡_´oc_d©a
 
	gsc¡_sgv_´oc_d©a
;

52 
sc¡_´oc_d©a
 
	gsc¡_groups_Çmes_´oc_d©a
;

53 
sc¡_´oc_d©a
 
	gsc¡_groups_deviûs_´oc_d©a
;

54 
sc¡_´oc_d©a
 
	gsc¡_groups_addr_m‘hod_´oc_d©a
;

55 
sc¡_´oc_d©a
 
	gsc¡_£ssiÚs_´oc_d©a
;

56 
sc¡_´oc_d©a
 
	gsc¡_dev_hªdËr_ty³_´oc_d©a
;

57 
sc¡_´oc_d©a
 
	gsc¡_tgt_´oc_d©a
;

58 
sc¡_´oc_d©a
 
	gsc¡_th»ads_´oc_d©a
;

59 
sc¡_´oc_d©a
 
	gsc¡_scsi_tgt_´oc_d©a
;

60 
sc¡_´oc_d©a
 
	gsc¡_dev_hªdËr_´oc_d©a
;

66 
	#SCST_PROC_BLOCK_SIZE
 (
PAGE_SIZE
 - 512)

	)

68 
	#SCST_PROC_LOG_ENTRY_NAME
 "Œaû_Ëv–"

	)

69 
	#SCST_PROC_DEV_HANDLER_TYPE_ENTRY_NAME
 "ty³"

	)

70 
	#SCST_PROC_VERSION_NAME
 "v”siÚ"

	)

71 
	#SCST_PROC_SESSIONS_NAME
 "£ssiÚs"

	)

72 
	#SCST_PROC_HELP_NAME
 "h–p"

	)

73 
	#SCST_PROC_THREADS_NAME
 "th»ads"

	)

74 
	#SCST_PROC_GROUPS_ENTRY_NAME
 "groups"

	)

75 
	#SCST_PROC_GROUPS_DEVICES_ENTRY_NAME
 "deviûs"

	)

76 
	#SCST_PROC_GROUPS_USERS_ENTRY_NAME
 "Çmes"

	)

77 
	#SCST_PROC_GROUPS_ADDR_METHOD_ENTRY_NAME
 "addr_m‘hod"

	)

79 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


80 
	#SCST_PROC_LAT_ENTRY_NAME
 "Ï‹ncy"

	)

83 
	#SCST_PROC_ACTION_ALL
 1

	)

84 
	#SCST_PROC_ACTION_NONE
 2

	)

85 
	#SCST_PROC_ACTION_DEFAULT
 3

	)

86 
	#SCST_PROC_ACTION_ADD
 4

	)

87 
	#SCST_PROC_ACTION_CLEAR
 5

	)

88 
	#SCST_PROC_ACTION_MOVE
 6

	)

89 
	#SCST_PROC_ACTION_DEL
 7

	)

90 
	#SCST_PROC_ACTION_REPLACE
 8

	)

91 
	#SCST_PROC_ACTION_VALUE
 9

	)

92 
	#SCST_PROC_ACTION_ASSIGN
 10

	)

93 
	#SCST_PROC_ACTION_ADD_GROUP
 11

	)

94 
	#SCST_PROC_ACTION_DEL_GROUP
 12

	)

95 
	#SCST_PROC_ACTION_RENAME_GROUP
 13

	)

96 
	#SCST_PROC_ACTION_DUMP_PRS
 14

	)

98 
´oc_dœ_’Œy
 *
	gsc¡_´oc_scsi_tgt
;

99 
´oc_dœ_’Œy
 *
	gsc¡_´oc_groups_roÙ
;

101 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

102 
sc¡_´oc_d©a
 
	gsc¡_log_´oc_d©a
;

104 
sc¡_Œaû_log
 
	gsc¡_´oc_Œaû_tbl
[] = {

105 { 
TRACE_OUT_OF_MEM
, "out_of_mem" },

106 { 
TRACE_MINOR
, "minor" },

107 { 
TRACE_SG_OP
, "sg" },

108 { 
TRACE_MEMORY
, "mem" },

109 { 
TRACE_BUFF
, "buff" },

110 #iâdeà
GENERATING_UPSTREAM_PATCH


111 { 
TRACE_ENTRYEXIT
, "entryexit" },

113 { 
TRACE_PID
, "pid" },

114 { 
TRACE_LINE
, "line" },

115 { 
TRACE_FUNCTION
, "function" },

116 { 
TRACE_DEBUG
, "debug" },

117 { 
TRACE_SPECIAL
, "special" },

118 { 
TRACE_SCSI
, "scsi" },

119 { 
TRACE_MGMT
, "mgmt" },

120 { 
TRACE_MGMT_DEBUG
, "mgmt_dbg" },

121 { 
TRACE_FLOW_CONTROL
, "flow_control" },

122 { 
TRACE_PRES
, "pr" },

123 { 0, 
NULL
 }

126 
sc¡_Œaû_log
 
	gsc¡_´oc_loÿl_Œaû_tbl
[] = {

127 { 
TRACE_RTRY
, "retry" },

128 { 
TRACE_SCSI_SERIALIZING
, "scsi_serializing" },

129 { 
TRACE_RCV_BOT
, "recv_bot" },

130 { 
TRACE_SND_BOT
, "send_bot" },

131 { 
TRACE_RCV_TOP
, "recv_top" },

132 { 
TRACE_SND_TOP
, "send_top" },

133 { 0, 
NULL
 }

137 *
	gsc¡_´oc_h–p_¡ršg
 =

160 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

176 *
	gsc¡_´oc_dev_hªdËr_ty³
[] = {

195 
DEFINE_MUTEX
(
sc¡_´oc_mu‹x
);

197 
	~<lšux/ùy³.h
>

199 #ià(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 22)è&& (!
defšed
(
RHEL_RELEASE_CODE
) || RHEL_RELEASE_CODE -0 < 5 * 256 + 3)

200 #ià!
defšed
(
CONFIG_PPC
)

221 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

222 
	$¡rÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
)

224 
c1
, 
c2
;

226 
c1
 = 
	`tÞow”
(*
s1
++);

227 
c2
 = 
	`tÞow”
(*
s2
++);

228 } 
c1
 =ð
c2
 && c1 != 0);

229  
c1
 - 
c2
;

230 
	}
}

233 
	$¡ºÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
n
)

235 
c1
, 
c2
;

237 
c1
 = 
	`tÞow”
(*
s1
++);

238 
c2
 = 
	`tÞow”
(*
s2
++);

239 } (--
n
 > 0è&& 
c1
 =ð
c2
 && c1 != 0);

240  
c1
 - 
c2
;

241 
	}
}

246 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

248 
DEFINE_MUTEX
(
sc¡_log_mu‹x
);

250 
	$sc¡_´oc_log_’Œy_wr™e
(
fže
 *fže, cÚ¡ 
__u£r
 *
buf
,

251 
Ëngth
, *
log_Ëv–
,

252 
deçuÉ_Ëv–
, cÚ¡ 
sc¡_Œaû_log
 *
tbl
)

254 
»s
 = 
Ëngth
;

255 
aùiÚ
;

256 
Ëv–
 = 0, 
ÞdËv–
;

257 *
bufãr
, *
p
, *
e
;

258 cÚ¡ 
sc¡_Œaû_log
 *
t
;

259 *
d©a
 = (*)
	`PDE
(
fže
->
f_d’Œy
->
d_šode
)->data;

261 
	`TRACE_ENTRY
();

263 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

264 
»s
 = -
EOVERFLOW
;

265 
out
;

267 ià(!
buf
) {

268 
»s
 = -
EINVAL
;

269 
out
;

271 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

272 ià(!
bufãr
) {

273 
»s
 = -
ENOMEM
;

274 
out
;

276 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

277 
»s
 = -
EFAULT
;

278 
out_ä“
;

280 ià(
Ëngth
 < 
PAGE_SIZE
) {

281 
bufãr
[
Ëngth
] = '\0';

282 } ià(
bufãr
[
PAGE_SIZE
-1]) {

283 
»s
 = -
EINVAL
;

284 
out_ä“
;

293 
p
 = 
bufãr
;

294 ià(!
	`¡ºÿ£cmp
("®l", 
p
, 3)) {

295 
aùiÚ
 = 
SCST_PROC_ACTION_ALL
;

296 } ià(!
	`¡ºÿ£cmp
("nÚe", 
p
, 4) || !strncasecmp("null",…, 4)) {

297 
aùiÚ
 = 
SCST_PROC_ACTION_NONE
;

298 } ià(!
	`¡ºÿ£cmp
("deçuÉ", 
p
, 7)) {

299 
aùiÚ
 = 
SCST_PROC_ACTION_DEFAULT
;

300 } ià(!
	`¡ºÿ£cmp
("add ", 
p
, 4)) {

301 
p
 += 4;

302 
aùiÚ
 = 
SCST_PROC_ACTION_ADD
;

303 } ià(!
	`¡ºÿ£cmp
("d– ", 
p
, 4)) {

304 
p
 += 4;

305 
aùiÚ
 = 
SCST_PROC_ACTION_DEL
;

306 } ià(!
	`¡ºÿ£cmp
("v®u", 
p
, 6)) {

307 
p
 += 6;

308 
aùiÚ
 = 
SCST_PROC_ACTION_VALUE
;

309 } ià(!
	`¡ºÿ£cmp
("dump_´ ", 
p
, 9)) {

310 
p
 += 9;

311 
aùiÚ
 = 
SCST_PROC_ACTION_DUMP_PRS
;

313 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

314 
p
[
	`¡¾’
(p) - 1] = '\0';

315 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

316 
»s
 = -
EINVAL
;

317 
out_ä“
;

320 
aùiÚ
) {

321 
SCST_PROC_ACTION_ALL
:

322 
Ëv–
 = 
TRACE_ALL
;

324 
SCST_PROC_ACTION_DEFAULT
:

325 
Ëv–
 = 
deçuÉ_Ëv–
;

327 
SCST_PROC_ACTION_NONE
:

328 
Ëv–
 = 
TRACE_NULL
;

330 
SCST_PROC_ACTION_ADD
:

331 
SCST_PROC_ACTION_DEL
:

332 
	`is¥aû
(*
p
) && *p != '\0')

333 
p
++;

334 
e
 = 
p
;

335 !
	`is¥aû
(*
e
) && *e != '\0')

336 
e
++;

337 *
e
 = 0;

338 ià(
tbl
) {

339 
t
 = 
tbl
;

340 
t
->
tok’
) {

341 ià(!
	`¡rÿ£cmp
(
p
, 
t
->
tok’
)) {

342 
Ëv–
 = 
t
->
v®
;

345 
t
++;

348 ià(
Ëv–
 == 0) {

349 
t
 = 
sc¡_´oc_Œaû_tbl
;

350 
t
->
tok’
) {

351 ià(!
	`¡rÿ£cmp
(
p
, 
t
->
tok’
)) {

352 
Ëv–
 = 
t
->
v®
;

355 
t
++;

358 ià(
Ëv–
 == 0) {

359 
	`PRINT_ERROR
("UnknowÀtok’ \"%s\"", 
p
);

360 
»s
 = -
EINVAL
;

361 
out_ä“
;

364 
SCST_PROC_ACTION_VALUE
:

365 
	`is¥aû
(*
p
) && *p != '\0')

366 
p
++;

367 
Ëv–
 = 
	`sim¶e_¡¹oul
(
p
, 
NULL
, 0);

369 
SCST_PROC_ACTION_DUMP_PRS
:

371 
sc¡_deviû
 *
dev
;

373 
	`is¥aû
(*
p
) && *p != '\0')

374 
p
++;

375 
e
 = 
p
;

376 !
	`is¥aû
(*
e
) && *e != '\0')

377 
e
++;

378 *
e
 = '\0';

380 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

381 
»s
 = -
EINTR
;

382 
out_ä“
;

385 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

386 ià(
	`¡rcmp
(
dev
->
vœt_Çme
, 
p
) == 0) {

387 
	`sc¡_´_dump_´s
(
dev
, 
Œue
);

388 
out_up
;

392 
	`PRINT_ERROR
("Deviû % nÙ found", 
p
);

393 
»s
 = -
ENOENT
;

394 
out_up
:

395 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

396 
out_ä“
;

400 
ÞdËv–
 = *
log_Ëv–
;

402 
aùiÚ
) {

403 
SCST_PROC_ACTION_ADD
:

404 *
log_Ëv–
 |ð
Ëv–
;

406 
SCST_PROC_ACTION_DEL
:

407 *
log_Ëv–
 &ð~
Ëv–
;

410 *
log_Ëv–
 = 
Ëv–
;

414 
	`PRINT_INFO
("Changedrace†evel for \"%s\": "

416 (*)
d©a
, 
ÞdËv–
, *
log_Ëv–
);

418 
out_ä“
:

419 
	`ä“_·ge
(()
bufãr
);

420 
out
:

421 
	`TRACE_EXIT_RES
(
»s
);

422  
»s
;

423 
	}
}

424 
EXPORT_SYMBOL_GPL
(
sc¡_´oc_log_’Œy_wr™e
);

426 
ssize_t
 
	$sc¡_´oc_scsi_tgt_g’_wr™e_log
(
fže
 *file,

427 cÚ¡ 
__u£r
 *
buf
,

428 
size_t
 
Ëngth
, 
loff_t
 *
off
)

430 
»s
;

432 
	`TRACE_ENTRY
();

434 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_log_mu‹x
) != 0) {

435 
»s
 = -
EINTR
;

436 
out
;

439 
»s
 = 
	`sc¡_´oc_log_’Œy_wr™e
(
fže
, 
buf
, 
Ëngth
,

440 &
Œaû_æag
, 
SCST_DEFAULT_LOG_FLAGS
,

441 
sc¡_´oc_loÿl_Œaû_tbl
);

443 
	`mu‹x_uÆock
(&
sc¡_log_mu‹x
);

445 
out
:

446 
	`TRACE_EXIT_RES
(
»s
);

447  
»s
;

448 
	}
}

452 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


454 *
	gsc¡_io_size_Çmes
[] = {

462 
	$Ït_šfo_show
(
£q_fže
 *
£q
, *
v
)

464 
»s
 = 0;

465 
sc¡_acg
 *
acg
;

466 
sc¡_£ssiÚ
 *
£ss
;

467 
buf
[50];

469 
	`TRACE_ENTRY
();

471 
	`BUILD_BUG_ON
(
SCST_LATENCY_STATS_NUM
 !ð
	`ARRAY_SIZE
(
sc¡_io_size_Çmes
));

472 
	`BUILD_BUG_ON
(
SCST_LATENCY_STATS_NUM
 !ð
	`ARRAY_SIZE
(
£ss
->
£ss_Ï‹ncy_¡©
));

474 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

475 
»s
 = -
EINTR
;

476 
out
;

479 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

480 
boÞ
 
h—d”_´š‹d
 = 
çl£
;

482 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
,

483 
acg_£ss_li¡_’Œy
) {

484 
i
;

485 
t
;

486 
ušt64_t
 
sc¡_time
, 
tgt_time
, 
dev_time
;

487 
´oûs£d_cmds
;

489 ià(!
h—d”_´š‹d
) {

490 
	`£q_´štf
(
£q
, "%-15s %-15s %-46s %-46s %-46s\n",

493 
h—d”_´š‹d
 = 
Œue
;

496 
	`£q_´štf
(
£q
, "Target‚ame: %s\nInitiator‚ame: %s\n",

497 
£ss
->
tgt
->
tg‰
->
Çme
,

498 
£ss
->
š™ŸtÜ_Çme
);

500 
	`¥š_lock_bh
(&
£ss
->
Ït_lock
);

502 
i
 = 0; i < 
SCST_LATENCY_STATS_NUM
 ; i++) {

503 
ušt64_t
 
sc¡_time_wr
, 
tgt_time_wr
, 
dev_time_wr
;

504 
´oûs£d_cmds_wr
;

505 
ušt64_t
 
sc¡_time_rd
, 
tgt_time_rd
, 
dev_time_rd
;

506 
´oûs£d_cmds_rd
;

507 
sc¡_ext_Ï‹ncy_¡©
 *
Ï‹ncy_¡©
;

509 
Ï‹ncy_¡©
 = &
£ss
->
£ss_Ï‹ncy_¡©
[
i
];

510 
sc¡_time_wr
 = 
Ï‹ncy_¡©
->scst_time_wr;

511 
sc¡_time_rd
 = 
Ï‹ncy_¡©
->scst_time_rd;

512 
tgt_time_wr
 = 
Ï‹ncy_¡©
->tgt_time_wr;

513 
tgt_time_rd
 = 
Ï‹ncy_¡©
->tgt_time_rd;

514 
dev_time_wr
 = 
Ï‹ncy_¡©
->dev_time_wr;

515 
dev_time_rd
 = 
Ï‹ncy_¡©
->dev_time_rd;

516 
´oûs£d_cmds_wr
 = 
Ï‹ncy_¡©
->processed_cmds_wr;

517 
´oûs£d_cmds_rd
 = 
Ï‹ncy_¡©
->processed_cmds_rd;

519 
	`£q_´štf
(
£q
, "%-5s %-9s %-15lu ",

520 "Wr™e", 
sc¡_io_size_Çmes
[
i
],

521 ()
´oûs£d_cmds_wr
);

522 ià(
´oûs£d_cmds_wr
 == 0)

523 
´oûs£d_cmds_wr
 = 1;

525 
	`do_div
(
sc¡_time_wr
, 
´oûs£d_cmds_wr
);

526 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

527 ()
Ï‹ncy_¡©
->
mš_sc¡_time_wr
,

528 ()
sc¡_time_wr
,

529 ()
Ï‹ncy_¡©
->
max_sc¡_time_wr
,

530 ()
Ï‹ncy_¡©
->
sc¡_time_wr
);

531 
	`£q_´štf
(
£q
, "%-47s", 
buf
);

533 
	`do_div
(
tgt_time_wr
, 
´oûs£d_cmds_wr
);

534 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

535 ()
Ï‹ncy_¡©
->
mš_tgt_time_wr
,

536 ()
tgt_time_wr
,

537 ()
Ï‹ncy_¡©
->
max_tgt_time_wr
,

538 ()
Ï‹ncy_¡©
->
tgt_time_wr
);

539 
	`£q_´štf
(
£q
, "%-47s", 
buf
);

541 
	`do_div
(
dev_time_wr
, 
´oûs£d_cmds_wr
);

542 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

543 ()
Ï‹ncy_¡©
->
mš_dev_time_wr
,

544 ()
dev_time_wr
,

545 ()
Ï‹ncy_¡©
->
max_dev_time_wr
,

546 ()
Ï‹ncy_¡©
->
dev_time_wr
);

547 
	`£q_´štf
(
£q
, "%-47s\n", 
buf
);

549 
	`£q_´štf
(
£q
, "%-5s %-9s %-15lu ",

550 "R—d", 
sc¡_io_size_Çmes
[
i
],

551 ()
´oûs£d_cmds_rd
);

552 ià(
´oûs£d_cmds_rd
 == 0)

553 
´oûs£d_cmds_rd
 = 1;

555 
	`do_div
(
sc¡_time_rd
, 
´oûs£d_cmds_rd
);

556 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

557 ()
Ï‹ncy_¡©
->
mš_sc¡_time_rd
,

558 ()
sc¡_time_rd
,

559 ()
Ï‹ncy_¡©
->
max_sc¡_time_rd
,

560 ()
Ï‹ncy_¡©
->
sc¡_time_rd
);

561 
	`£q_´štf
(
£q
, "%-47s", 
buf
);

563 
	`do_div
(
tgt_time_rd
, 
´oûs£d_cmds_rd
);

564 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

565 ()
Ï‹ncy_¡©
->
mš_tgt_time_rd
,

566 ()
tgt_time_rd
,

567 ()
Ï‹ncy_¡©
->
max_tgt_time_rd
,

568 ()
Ï‹ncy_¡©
->
tgt_time_rd
);

569 
	`£q_´štf
(
£q
, "%-47s", 
buf
);

571 
	`do_div
(
dev_time_rd
, 
´oûs£d_cmds_rd
);

572 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

573 ()
Ï‹ncy_¡©
->
mš_dev_time_rd
,

574 ()
dev_time_rd
,

575 ()
Ï‹ncy_¡©
->
max_dev_time_rd
,

576 ()
Ï‹ncy_¡©
->
dev_time_rd
);

577 
	`£q_´štf
(
£q
, "%-47s\n", 
buf
);

580 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

581 
li¡_h—d
 *
h—d
 =

582 &
£ss
->
£ss_tgt_dev_li¡
[
t
];

583 
sc¡_tgt_dev
 *
tgt_dev
;

584 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

585 
£ss_tgt_dev_li¡_’Œy
) {

587 
	`£q_´štf
(
£q
, "\nLUN: %Îu\n", 
tgt_dev
->
lun
);

589 
i
 = 0; i < 
SCST_LATENCY_STATS_NUM
 ; i++) {

590 
ušt64_t
 
sc¡_time_wr
, 
tgt_time_wr
, 
dev_time_wr
;

591 
´oûs£d_cmds_wr
;

592 
ušt64_t
 
sc¡_time_rd
, 
tgt_time_rd
, 
dev_time_rd
;

593 
´oûs£d_cmds_rd
;

594 
sc¡_ext_Ï‹ncy_¡©
 *
Ï‹ncy_¡©
;

596 
Ï‹ncy_¡©
 = &
tgt_dev
->
dev_Ï‹ncy_¡©
[
i
];

597 
sc¡_time_wr
 = 
Ï‹ncy_¡©
->scst_time_wr;

598 
sc¡_time_rd
 = 
Ï‹ncy_¡©
->scst_time_rd;

599 
tgt_time_wr
 = 
Ï‹ncy_¡©
->tgt_time_wr;

600 
tgt_time_rd
 = 
Ï‹ncy_¡©
->tgt_time_rd;

601 
dev_time_wr
 = 
Ï‹ncy_¡©
->dev_time_wr;

602 
dev_time_rd
 = 
Ï‹ncy_¡©
->dev_time_rd;

603 
´oûs£d_cmds_wr
 = 
Ï‹ncy_¡©
->processed_cmds_wr;

604 
´oûs£d_cmds_rd
 = 
Ï‹ncy_¡©
->processed_cmds_rd;

606 
	`£q_´štf
(
£q
, "%-5s %-9s %-15lu ",

607 "Wr™e", 
sc¡_io_size_Çmes
[
i
],

608 ()
´oûs£d_cmds_wr
);

609 ià(
´oûs£d_cmds_wr
 == 0)

610 
´oûs£d_cmds_wr
 = 1;

612 
	`do_div
(
sc¡_time_wr
, 
´oûs£d_cmds_wr
);

613 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

614 ()
Ï‹ncy_¡©
->
mš_sc¡_time_wr
,

615 ()
sc¡_time_wr
,

616 ()
Ï‹ncy_¡©
->
max_sc¡_time_wr
,

617 ()
Ï‹ncy_¡©
->
sc¡_time_wr
);

618 
	`£q_´štf
(
£q
, "%-47s", 
buf
);

620 
	`do_div
(
tgt_time_wr
, 
´oûs£d_cmds_wr
);

621 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

622 ()
Ï‹ncy_¡©
->
mš_tgt_time_wr
,

623 ()
tgt_time_wr
,

624 ()
Ï‹ncy_¡©
->
max_tgt_time_wr
,

625 ()
Ï‹ncy_¡©
->
tgt_time_wr
);

626 
	`£q_´štf
(
£q
, "%-47s", 
buf
);

628 
	`do_div
(
dev_time_wr
, 
´oûs£d_cmds_wr
);

629 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

630 ()
Ï‹ncy_¡©
->
mš_dev_time_wr
,

631 ()
dev_time_wr
,

632 ()
Ï‹ncy_¡©
->
max_dev_time_wr
,

633 ()
Ï‹ncy_¡©
->
dev_time_wr
);

634 
	`£q_´štf
(
£q
, "%-47s\n", 
buf
);

636 
	`£q_´štf
(
£q
, "%-5s %-9s %-15lu ",

637 "R—d", 
sc¡_io_size_Çmes
[
i
],

638 ()
´oûs£d_cmds_rd
);

639 ià(
´oûs£d_cmds_rd
 == 0)

640 
´oûs£d_cmds_rd
 = 1;

642 
	`do_div
(
sc¡_time_rd
, 
´oûs£d_cmds_rd
);

643 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

644 ()
Ï‹ncy_¡©
->
mš_sc¡_time_rd
,

645 ()
sc¡_time_rd
,

646 ()
Ï‹ncy_¡©
->
max_sc¡_time_rd
,

647 ()
Ï‹ncy_¡©
->
sc¡_time_rd
);

648 
	`£q_´štf
(
£q
, "%-47s", 
buf
);

650 
	`do_div
(
tgt_time_rd
, 
´oûs£d_cmds_rd
);

651 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

652 ()
Ï‹ncy_¡©
->
mš_tgt_time_rd
,

653 ()
tgt_time_rd
,

654 ()
Ï‹ncy_¡©
->
max_tgt_time_rd
,

655 ()
Ï‹ncy_¡©
->
tgt_time_rd
);

656 
	`£q_´štf
(
£q
, "%-47s", 
buf
);

658 
	`do_div
(
dev_time_rd
, 
´oûs£d_cmds_rd
);

659 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

660 ()
Ï‹ncy_¡©
->
mš_dev_time_rd
,

661 ()
dev_time_rd
,

662 ()
Ï‹ncy_¡©
->
max_dev_time_rd
,

663 ()
Ï‹ncy_¡©
->
dev_time_rd
);

664 
	`£q_´štf
(
£q
, "%-47s\n", 
buf
);

669 
sc¡_time
 = 
£ss
->scst_time;

670 
tgt_time
 = 
£ss
->tgt_time;

671 
dev_time
 = 
£ss
->dev_time;

672 
´oûs£d_cmds
 = 
£ss
->processed_cmds;

674 
	`£q_´štf
(
£q
, "\n%-15s %-16d", "Overall ",

675 
´oûs£d_cmds
);

677 ià(
´oûs£d_cmds
 == 0)

678 
´oûs£d_cmds
 = 1;

680 
	`do_div
(
sc¡_time
, 
´oûs£d_cmds
);

681 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

682 ()
£ss
->
mš_sc¡_time
,

683 ()
sc¡_time
,

684 ()
£ss
->
max_sc¡_time
,

685 ()
£ss
->
sc¡_time
);

686 
	`£q_´štf
(
£q
, "%-47s", 
buf
);

688 
	`do_div
(
tgt_time
, 
´oûs£d_cmds
);

689 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

690 ()
£ss
->
mš_tgt_time
,

691 ()
tgt_time
,

692 ()
£ss
->
max_tgt_time
,

693 ()
£ss
->
tgt_time
);

694 
	`£q_´štf
(
£q
, "%-47s", 
buf
);

696 
	`do_div
(
dev_time
, 
´oûs£d_cmds
);

697 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

698 ()
£ss
->
mš_dev_time
,

699 ()
dev_time
,

700 ()
£ss
->
max_dev_time
,

701 ()
£ss
->
dev_time
);

702 
	`£q_´štf
(
£q
, "%-47s\n\n", 
buf
);

704 
	`¥š_uÆock_bh
(&
£ss
->
Ït_lock
);

708 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

710 
out
:

711 
	`TRACE_EXIT_RES
(
»s
);

712  
»s
;

713 
	}
}

715 
ssize_t
 
	$sc¡_´oc_scsi_tgt_g’_wr™e_Ït
(
fže
 *file,

716 cÚ¡ 
__u£r
 *
buf
,

717 
size_t
 
Ëngth
, 
loff_t
 *
off
)

719 
»s
 = 
Ëngth
, 
t
;

720 
sc¡_acg
 *
acg
;

721 
sc¡_£ssiÚ
 *
£ss
;

723 
	`TRACE_ENTRY
();

725 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

726 
»s
 = -
EINTR
;

727 
out
;

730 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

731 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
,

732 
acg_£ss_li¡_’Œy
) {

733 
	`PRINT_INFO
("Zeroing†atency statistics for initiator "

734 "%s", 
£ss
->
š™ŸtÜ_Çme
);

735 
	`¥š_lock_bh
(&
£ss
->
Ït_lock
);

737 
£ss
->
sc¡_time
 = 0;

738 
£ss
->
tgt_time
 = 0;

739 
£ss
->
dev_time
 = 0;

740 
£ss
->
mš_sc¡_time
 = 0;

741 
£ss
->
mš_tgt_time
 = 0;

742 
£ss
->
mš_dev_time
 = 0;

743 
£ss
->
max_sc¡_time
 = 0;

744 
£ss
->
max_tgt_time
 = 0;

745 
£ss
->
max_dev_time
 = 0;

746 
£ss
->
´oûs£d_cmds
 = 0;

747 
	`mem£t
(
£ss
->
£ss_Ï‹ncy_¡©
, 0,

748 (
£ss
->
£ss_Ï‹ncy_¡©
));

750 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

751 
li¡_h—d
 *
h—d
 =

752 &
£ss
->
£ss_tgt_dev_li¡
[
t
];

753 
sc¡_tgt_dev
 *
tgt_dev
;

754 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

755 
£ss_tgt_dev_li¡_’Œy
) {

756 
tgt_dev
->
sc¡_time
 = 0;

757 
tgt_dev
->
tgt_time
 = 0;

758 
tgt_dev
->
dev_time
 = 0;

759 
tgt_dev
->
´oûs£d_cmds
 = 0;

760 
	`mem£t
(
tgt_dev
->
dev_Ï‹ncy_¡©
, 0,

761 (
tgt_dev
->
dev_Ï‹ncy_¡©
));

765 
	`¥š_uÆock_bh
(&
£ss
->
Ït_lock
);

769 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

771 
out
:

772 
	`TRACE_EXIT_RES
(
»s
);

773  
»s
;

774 
	}
}

776 
sc¡_´oc_d©a
 
	gsc¡_Ït_´oc_d©a
 = {

777 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_scsi_tgt_g’_wr™e_Ït
)

778 .
show
 = 
Ït_šfo_show
,

779 .
	gd©a
 = "scsi_tgt",

784 
__š™
 
	$sc¡_´oc_š™_moduË_log
()

786 
»s
 = 0;

787 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
) || \

788 
	`defšed
(
CONFIG_SCST_MEASURE_LATENCY
)

789 
´oc_dœ_’Œy
 *
g’”ic
;

792 
	`TRACE_ENTRY
();

794 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

795 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

796 
SCST_PROC_LOG_ENTRY_NAME
,

797 &
sc¡_log_´oc_d©a
);

798 ià(!
g’”ic
) {

799 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

800 
SCST_PROC_ENTRY_NAME
, 
SCST_PROC_LOG_ENTRY_NAME
);

801 
»s
 = -
ENOMEM
;

805 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


806 ià(
»s
 == 0) {

807 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

808 
SCST_PROC_LAT_ENTRY_NAME
,

809 &
sc¡_Ït_´oc_d©a
);

810 ià(!
g’”ic
) {

811 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

812 
SCST_PROC_ENTRY_NAME
,

813 
SCST_PROC_LAT_ENTRY_NAME
);

814 
»s
 = -
ENOMEM
;

819 
	`TRACE_EXIT_RES
(
»s
);

820  
»s
;

821 
	}
}

823 
	$sc¡_´oc_þ—nup_moduË_log
()

825 
	`TRACE_ENTRY
();

827 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

828 
	`»move_´oc_’Œy
(
SCST_PROC_LOG_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

831 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


832 
	`»move_´oc_’Œy
(
SCST_PROC_LAT_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

835 
	`TRACE_EXIT
();

837 
	}
}

839 
	$sc¡_´oc_group_add_Œ“
(
sc¡_acg
 *
acg
, cÚ¡ *
Çme
)

841 
»s
 = 0;

842 
´oc_dœ_’Œy
 *
g’”ic
;

844 
	`TRACE_ENTRY
();

846 
acg
->
acg_´oc_roÙ
 = 
	`´oc_mkdœ
(
Çme
, 
sc¡_´oc_groups_roÙ
);

847 ià(
acg
->
acg_´oc_roÙ
 =ð
NULL
) {

848 
	`PRINT_ERROR
("Notƒnough memoryo„egister %sƒntry in "

849 "/´oc/%s/%s", 
Çme
, 
SCST_PROC_ENTRY_NAME
,

850 
SCST_PROC_GROUPS_ENTRY_NAME
);

851 
out
;

854 
sc¡_groups_addr_m‘hod_´oc_d©a
.
d©a
 = 
acg
;

855 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
acg
->
acg_´oc_roÙ
,

856 
SCST_PROC_GROUPS_ADDR_METHOD_ENTRY_NAME
,

857 &
sc¡_groups_addr_m‘hod_´oc_d©a
);

858 ià(!
g’”ic
) {

859 
	`PRINT_ERROR
("Cannot init /proc/%s/%s/%s/%s",

860 
SCST_PROC_ENTRY_NAME
,

861 
SCST_PROC_GROUPS_ENTRY_NAME
,

862 
Çme
, 
SCST_PROC_GROUPS_ADDR_METHOD_ENTRY_NAME
);

863 
»s
 = -
ENOMEM
;

864 
out_»move
;

867 
sc¡_groups_deviûs_´oc_d©a
.
d©a
 = 
acg
;

868 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
acg
->
acg_´oc_roÙ
,

869 
SCST_PROC_GROUPS_DEVICES_ENTRY_NAME
,

870 &
sc¡_groups_deviûs_´oc_d©a
);

871 ià(!
g’”ic
) {

872 
	`PRINT_ERROR
("Cannot init /proc/%s/%s/%s/%s",

873 
SCST_PROC_ENTRY_NAME
,

874 
SCST_PROC_GROUPS_ENTRY_NAME
,

875 
Çme
, 
SCST_PROC_GROUPS_DEVICES_ENTRY_NAME
);

876 
»s
 = -
ENOMEM
;

877 
out_»move0
;

880 
sc¡_groups_Çmes_´oc_d©a
.
d©a
 = 
acg
;

881 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
acg
->
acg_´oc_roÙ
,

882 
SCST_PROC_GROUPS_USERS_ENTRY_NAME
,

883 &
sc¡_groups_Çmes_´oc_d©a
);

884 ià(!
g’”ic
) {

885 
	`PRINT_ERROR
("Cannot init /proc/%s/%s/%s/%s",

886 
SCST_PROC_ENTRY_NAME
,

887 
SCST_PROC_GROUPS_ENTRY_NAME
,

888 
Çme
, 
SCST_PROC_GROUPS_USERS_ENTRY_NAME
);

889 
»s
 = -
ENOMEM
;

890 
out_»move1
;

893 
out
:

894 
	`TRACE_EXIT_RES
(
»s
);

895  
»s
;

897 
out_»move1
:

898 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_DEVICES_ENTRY_NAME
,

899 
acg
->
acg_´oc_roÙ
);

901 
out_»move0
:

902 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_ADDR_METHOD_ENTRY_NAME
,

903 
acg
->
acg_´oc_roÙ
);

904 
out_»move
:

905 
	`»move_´oc_’Œy
(
Çme
, 
sc¡_´oc_groups_roÙ
);

906 
out
;

907 
	}
}

909 
	$sc¡_´oc_d–_acg_Œ“
(
´oc_dœ_’Œy
 *
acg_´oc_roÙ
,

910 cÚ¡ *
Çme
)

912 
	`TRACE_ENTRY
();

914 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_ADDR_METHOD_ENTRY_NAME
, 
acg_´oc_roÙ
);

915 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_USERS_ENTRY_NAME
, 
acg_´oc_roÙ
);

916 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_DEVICES_ENTRY_NAME
, 
acg_´oc_roÙ
);

917 
	`»move_´oc_’Œy
(
Çme
, 
sc¡_´oc_groups_roÙ
);

919 
	`TRACE_EXIT
();

921 
	}
}

924 
	$sc¡_´oc_group_add
(cÚ¡ *
p
, 
addr_m‘hod
)

926 
»s
 = 0, 
Ën
 = 
	`¡¾’
(
p
) + 1;

927 
sc¡_acg
 *
acg
;

928 *
Çme
 = 
NULL
;

930 
	`TRACE_ENTRY
();

932 
Çme
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

933 ià(
Çme
 =ð
NULL
) {

934 
	`PRINT_ERROR
("AÎoÿtiÚ oàÃw‚am(siz%dèçžed", 
Ën
);

935 
out_nomem
;

937 
	`¡¾ýy
(
Çme
, 
p
, 
Ën
);

939 
acg
 = 
	`sc¡_®loc_add_acg
(
NULL
, 
Çme
, 
çl£
);

940 ià(
acg
 =ð
NULL
) {

941 
	`PRINT_ERROR
("sc¡_®loc_add_acg(èÒam%sèçžed", 
Çme
);

942 
out_ä“
;

945 
acg
->
addr_m‘hod
 =‡ddr_method;

947 
»s
 = 
	`sc¡_´oc_group_add_Œ“
(
acg
, 
p
);

948 ià(
»s
 != 0)

949 
out_ä“_acg
;

951 
out
:

952 
	`TRACE_EXIT_RES
(
»s
);

953  
»s
;

955 
out_ä“_acg
:

956 
	`sc¡_´oc_d–_ä“_acg
(
acg
, 0);

958 
out_ä“
:

959 
	`kä“
(
Çme
);

961 
out_nomem
:

962 
»s
 = -
ENOMEM
;

963 
out
;

964 
	}
}

967 
	$sc¡_´oc_d–_ä“_acg
(
sc¡_acg
 *
acg
, 
»move_´oc
)

969 
´oc_dœ_’Œy
 *
acg_´oc_roÙ
 = 
acg
->acg_proc_root;

970 
»s
 = 0;

972 
	`TRACE_ENTRY
();

974 ià(
acg
 !ð
sc¡_deçuÉ_acg
) {

975 ià(!
	`sc¡_acg_£ss_is_em±y
(
acg
)) {

976 
	`PRINT_ERROR
("%s", "Session is‚otƒmpty");

977 
»s
 = -
EBUSY
;

978 
out
;

980 ià(
»move_´oc
)

981 
	`sc¡_´oc_d–_acg_Œ“
(
acg_´oc_roÙ
, 
acg
->
acg_Çme
);

982 
	`sc¡_d–_ä“_acg
(
acg
);

984 
out
:

985 
	`TRACE_EXIT_RES
(
»s
);

986  
»s
;

987 
	}
}

990 
	$sc¡_´oc_»Çme_acg
(
sc¡_acg
 *
acg
, cÚ¡ *
Ãw_Çme
)

992 
»s
 = 0, 
Ën
 = 
	`¡¾’
(
Ãw_Çme
) + 1;

993 *
Çme
;

994 
´oc_dœ_’Œy
 *
Þd_acg_´oc_roÙ
 = 
acg
->
acg_´oc_roÙ
;

996 
	`TRACE_ENTRY
();

998 
Çme
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

999 ià(
Çme
 =ð
NULL
) {

1000 
	`PRINT_ERROR
("AÎoÿtiÚ oàÃw‚am(siz%dèçžed", 
Ën
);

1001 
out_nomem
;

1003 
	`¡¾ýy
(
Çme
, 
Ãw_Çme
, 
Ën
);

1005 
»s
 = 
	`sc¡_´oc_group_add_Œ“
(
acg
, 
Ãw_Çme
);

1006 ià(
»s
 != 0)

1007 
out_ä“
;

1009 
	`sc¡_´oc_d–_acg_Œ“
(
Þd_acg_´oc_roÙ
, 
acg
->
acg_Çme
);

1011 
	`kä“
(
acg
->
acg_Çme
);

1012 
acg
->
acg_Çme
 = 
Çme
;

1014 
	`sc¡_check_»assign_£ssiÚs
();

1016 
out
:

1017 
	`TRACE_EXIT_RES
(
»s
);

1018  
»s
;

1020 
out_ä“
:

1021 
	`kä“
(
Çme
);

1023 
out_nomem
:

1024 
»s
 = -
ENOMEM
;

1025 
out
;

1026 
	}
}

1028 
__š™
 
	$sc¡_´oc_š™_groups
()

1030 
»s
 = 0;

1032 
	`TRACE_ENTRY
();

1035 
sc¡_´oc_groups_roÙ
 = 
	`´oc_mkdœ
(
SCST_PROC_GROUPS_ENTRY_NAME
,

1036 
sc¡_´oc_scsi_tgt
);

1037 ià(
sc¡_´oc_groups_roÙ
 =ð
NULL
) {

1038 
	`PRINT_ERROR
("Notƒnough memoryo„egister %sƒntry in "

1039 "/´oc/%s", 
SCST_PROC_GROUPS_ENTRY_NAME
,

1040 
SCST_PROC_ENTRY_NAME
);

1041 
out_nomem
;

1044 
»s
 = 
	`sc¡_´oc_group_add_Œ“
(
sc¡_deçuÉ_acg
,

1045 
SCST_DEFAULT_ACG_NAME
);

1046 ià(
»s
 != 0)

1047 
out_»move
;

1049 
out
:

1050 
	`TRACE_EXIT_RES
(
»s
);

1051  
»s
;

1053 
out_»move
:

1054 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

1056 
out_nomem
:

1057 
»s
 = -
ENOMEM
;

1058 
out
;

1059 
	}
}

1061 
	$sc¡_´oc_þ—nup_groups
()

1063 
sc¡_acg
 *
acg_tmp
, *
acg
;

1065 
	`TRACE_ENTRY
();

1068 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg
, 
acg_tmp
, &
sc¡_acg_li¡
,

1069 
acg_li¡_’Œy
) {

1070 
	`sc¡_´oc_d–_ä“_acg
(
acg
, 1);

1073 
	`sc¡_´oc_d–_acg_Œ“
(
sc¡_deçuÉ_acg
->
acg_´oc_roÙ
,

1074 
SCST_DEFAULT_ACG_NAME
);

1075 
	`TRACE_DBG
("remove_proc_entry(%s, %p)",

1076 
SCST_PROC_GROUPS_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

1077 
	`»move_´oc_’Œy
(
SCST_PROC_GROUPS_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

1079 
	`TRACE_EXIT
();

1080 
	}
}

1082 
__š™
 
	$sc¡_´oc_š™_sgv
()

1084 
»s
 = 0;

1085 
´oc_dœ_’Œy
 *
´
;

1087 
	`TRACE_ENTRY
();

1089 
´
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
, "sgv",

1090 &
sc¡_sgv_´oc_d©a
);

1091 ià(
´
 =ð
NULL
) {

1092 
	`PRINT_ERROR
("%s", "cannot create sgv /procƒntry");

1093 
»s
 = -
ENOMEM
;

1096 
	`TRACE_EXIT_RES
(
»s
);

1097  
»s
;

1098 
	}
}

1100 
__ex™
 
	$sc¡_´oc_þ—nup_sgv
()

1102 
	`TRACE_ENTRY
();

1103 
	`»move_´oc_’Œy
("sgv", 
sc¡_´oc_scsi_tgt
);

1104 
	`TRACE_EXIT
();

1105 
	}
}

1107 
__š™
 
	$sc¡_´oc_š™_moduË
()

1109 
»s
 = 0;

1110 
´oc_dœ_’Œy
 *
g’”ic
;

1112 
	`TRACE_ENTRY
();

1114 
sc¡_´oc_scsi_tgt
 = 
	`´oc_mkdœ
(
SCST_PROC_ENTRY_NAME
, 
NULL
);

1115 ià(!
sc¡_´oc_scsi_tgt
) {

1116 
	`PRINT_ERROR
("ÿÂÙ in™ /´oc/%s", 
SCST_PROC_ENTRY_NAME
);

1117 
out_nomem
;

1120 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

1121 
SCST_PROC_ENTRY_NAME
,

1122 &
sc¡_tgt_´oc_d©a
);

1123 ià(!
g’”ic
) {

1124 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

1125 
SCST_PROC_ENTRY_NAME
, SCST_PROC_ENTRY_NAME);

1126 
out_»move
;

1129 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

1130 
SCST_PROC_VERSION_NAME
,

1131 &
sc¡_v”siÚ_´oc_d©a
);

1132 ià(!
g’”ic
) {

1133 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

1134 
SCST_PROC_ENTRY_NAME
, 
SCST_PROC_VERSION_NAME
);

1135 
out_»move1
;

1138 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

1139 
SCST_PROC_SESSIONS_NAME
,

1140 &
sc¡_£ssiÚs_´oc_d©a
);

1141 ià(!
g’”ic
) {

1142 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

1143 
SCST_PROC_ENTRY_NAME
, 
SCST_PROC_SESSIONS_NAME
);

1144 
out_»move2
;

1147 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

1148 
SCST_PROC_HELP_NAME
,

1149 &
sc¡_h–p_´oc_d©a
);

1150 ià(!
g’”ic
) {

1151 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

1152 
SCST_PROC_ENTRY_NAME
, 
SCST_PROC_HELP_NAME
);

1153 
out_»move3
;

1156 
g’”ic
 = 
	`sc¡_ü—‹_´oc_’Œy
(
sc¡_´oc_scsi_tgt
,

1157 
SCST_PROC_THREADS_NAME
,

1158 &
sc¡_th»ads_´oc_d©a
);

1159 ià(!
g’”ic
) {

1160 
	`PRINT_ERROR
("cannot init /proc/%s/%s",

1161 
SCST_PROC_ENTRY_NAME
, 
SCST_PROC_THREADS_NAME
);

1162 
out_»move4
;

1165 ià(
	`sc¡_´oc_š™_moduË_log
() < 0)

1166 
out_»move5
;

1168 ià(
	`sc¡_´oc_š™_groups
() < 0)

1169 
out_»move6
;

1171 ià(
	`sc¡_´oc_š™_sgv
() < 0)

1172 
out_»move7
;

1174 
out
:

1175 
	`TRACE_EXIT_RES
(
»s
);

1176  
»s
;

1178 
out_»move7
:

1179 
	`sc¡_´oc_þ—nup_groups
();

1181 
out_»move6
:

1182 
	`sc¡_´oc_þ—nup_moduË_log
();

1184 
out_»move5
:

1185 
	`»move_´oc_’Œy
(
SCST_PROC_THREADS_NAME
, 
sc¡_´oc_scsi_tgt
);

1187 
out_»move4
:

1188 
	`»move_´oc_’Œy
(
SCST_PROC_HELP_NAME
, 
sc¡_´oc_scsi_tgt
);

1190 
out_»move3
:

1191 
	`»move_´oc_’Œy
(
SCST_PROC_SESSIONS_NAME
, 
sc¡_´oc_scsi_tgt
);

1193 
out_»move2
:

1194 
	`»move_´oc_’Œy
(
SCST_PROC_VERSION_NAME
, 
sc¡_´oc_scsi_tgt
);

1196 
out_»move1
:

1197 
	`»move_´oc_’Œy
(
SCST_PROC_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

1199 
out_»move
:

1200 
	`»move_´oc_’Œy
(
SCST_PROC_ENTRY_NAME
, 
NULL
);

1202 
out_nomem
:

1203 
»s
 = -
ENOMEM
;

1204 
out
;

1205 
	}
}

1207 
__ex™
 
	$sc¡_´oc_þ—nup_moduË
()

1209 
	`TRACE_ENTRY
();

1212 
	`sc¡_´oc_þ—nup_sgv
();

1213 
	`sc¡_´oc_þ—nup_groups
();

1214 
	`sc¡_´oc_þ—nup_moduË_log
();

1215 
	`»move_´oc_’Œy
(
SCST_PROC_THREADS_NAME
, 
sc¡_´oc_scsi_tgt
);

1216 
	`»move_´oc_’Œy
(
SCST_PROC_HELP_NAME
, 
sc¡_´oc_scsi_tgt
);

1217 
	`»move_´oc_’Œy
(
SCST_PROC_SESSIONS_NAME
, 
sc¡_´oc_scsi_tgt
);

1218 
	`»move_´oc_’Œy
(
SCST_PROC_VERSION_NAME
, 
sc¡_´oc_scsi_tgt
);

1219 
	`»move_´oc_’Œy
(
SCST_PROC_ENTRY_NAME
, 
sc¡_´oc_scsi_tgt
);

1220 
	`»move_´oc_’Œy
(
SCST_PROC_ENTRY_NAME
, 
NULL
);

1222 
	`TRACE_EXIT
();

1223 
	}
}

1225 
ssize_t
 
	$sc¡_´oc_th»ads_wr™e
(
fže
 *file,

1226 cÚ¡ 
__u£r
 *
buf
,

1227 
size_t
 
Ëngth
, 
loff_t
 *
off
)

1229 
»s
 = 
Ëngth
;

1230 
ÞdŠ
, 
ÃwŠ
, 
d–
;

1231 *
bufãr
;

1233 
	`TRACE_ENTRY
();

1235 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

1236 
»s
 = -
EOVERFLOW
;

1237 
out
;

1239 ià(!
buf
) {

1240 
»s
 = -
EINVAL
;

1241 
out
;

1243 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1244 ià(!
bufãr
) {

1245 
»s
 = -
ENOMEM
;

1246 
out
;

1248 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

1249 
»s
 = -
EFAULT
;

1250 
out_ä“
;

1252 ià(
Ëngth
 < 
PAGE_SIZE
) {

1253 
bufãr
[
Ëngth
] = '\0';

1254 } ià(
bufãr
[
PAGE_SIZE
-1]) {

1255 
»s
 = -
EINVAL
;

1256 
out_ä“
;

1259 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_´oc_mu‹x
) != 0) {

1260 
»s
 = -
EINTR
;

1261 
out_ä“
;

1264 
	`mu‹x_lock
(&
sc¡_mu‹x
);

1266 
ÞdŠ
 = 
sc¡_maš_cmd_th»ads
.
Ä_th»ads
;

1267 
ÃwŠ
 = 
	`sim¶e_¡¹oul
(
bufãr
, 
NULL
, 0);

1268 ià(
ÃwŠ
 <= 0) {

1269 
	`PRINT_ERROR
("IÎeg®h»ad num v®u%d", 
ÃwŠ
);

1270 
»s
 = -
EINVAL
;

1271 
out_up_thr_ä“
;

1273 
d–
 = 
ÃwŠ
 - 
ÞdŠ
;

1274 ià(
d–
 < 0)

1275 
	`sc¡_d–_th»ads
(&
sc¡_maš_cmd_th»ads
, -
d–
);

1277 
rc
 = 
	`sc¡_add_th»ads
(&
sc¡_maš_cmd_th»ads
, 
NULL
, NULL,

1278 
d–
);

1279 ià(
rc
 != 0)

1280 
»s
 = 
rc
;

1283 
	`PRINT_INFO
("Chªged cmdh»ad num: old %d,‚ew %d", 
ÞdŠ
, 
ÃwŠ
);

1285 
out_up_thr_ä“
:

1286 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1288 
	`mu‹x_uÆock
(&
sc¡_´oc_mu‹x
);

1290 
out_ä“
:

1291 
	`ä“_·ge
(()
bufãr
);

1292 
out
:

1293 
	`TRACE_EXIT_RES
(
»s
);

1294  
»s
;

1295 
	}
}

1297 
	$sc¡_bužd_´oc_rg‘_dœ_’Œ›s
(
sc¡_tgt_‹m¶©e
 *
v‰
)

1299 
»s
 = 0;

1301 
	`TRACE_ENTRY
();

1304 
v‰
->
´oc_tgt_roÙ
 = 
	`´oc_mkdœ
(v‰->
Çme
, 
sc¡_´oc_scsi_tgt
);

1305 ià(
v‰
->
´oc_tgt_roÙ
 =ð
NULL
) {

1306 
	`PRINT_ERROR
("Notƒnough memoryo„egister SCSIarget %s "

1307 "š /´oc/%s", 
v‰
->
Çme
, 
SCST_PROC_ENTRY_NAME
);

1308 
out_nomem
;

1311 
out
:

1312 
	`TRACE_EXIT_RES
(
»s
);

1313  
»s
;

1315 
out_nomem
:

1316 
»s
 = -
ENOMEM
;

1317 
out
;

1318 
	}
}

1320 
	$sc¡_þ—nup_´oc_rg‘_dœ_’Œ›s
(
sc¡_tgt_‹m¶©e
 *
v‰
)

1322 
	`TRACE_ENTRY
();

1324 
	`»move_´oc_’Œy
(
v‰
->
Çme
, 
sc¡_´oc_scsi_tgt
);

1326 
	`TRACE_EXIT
();

1328 
	}
}

1331 
	$sc¡_bužd_´oc_rg‘_’Œ›s
(
sc¡_tgt
 *
v‰
)

1333 
»s
 = 0;

1334 
´oc_dœ_’Œy
 *
p
;

1335 
Çme
[20];

1337 
	`TRACE_ENTRY
();

1339 ià(
v‰
->
tg‰
->
»ad_´oc
 || v‰->tg‰->
wr™e_´oc
) {

1341 
	`sú´štf
(
Çme
, Òame), "%d", 
v‰
->
tg‰
->
´oc_dev_num
);

1342 
sc¡_scsi_tgt_´oc_d©a
.
d©a
 = (*)
v‰
;

1343 
p
 = 
	`sc¡_ü—‹_´oc_’Œy
(
v‰
->
tg‰
->
´oc_tgt_roÙ
,

1344 
Çme
,

1345 &
sc¡_scsi_tgt_´oc_d©a
);

1346 ià(
p
 =ð
NULL
) {

1347 
	`PRINT_ERROR
("Notƒnough memoryo„egister SCSI "

1348 "rg‘ƒÁry % š /´oc/%s/%s", 
Çme
,

1349 
SCST_PROC_ENTRY_NAME
, 
v‰
->
tg‰
->
Çme
);

1350 
»s
 = -
ENOMEM
;

1351 
out
;

1353 
v‰
->
´oc_num
 = v‰->
tg‰
->
´oc_dev_num
;

1354 
v‰
->
tg‰
->
´oc_dev_num
++;

1357 
out
:

1358 
	`TRACE_EXIT_RES
(
»s
);

1359  
»s
;

1360 
	}
}

1362 
	$sc¡_þ—nup_´oc_rg‘_’Œ›s
(
sc¡_tgt
 *
v‰
)

1364 
Çme
[20];

1366 
	`TRACE_ENTRY
();

1368 ià(
v‰
->
tg‰
->
»ad_´oc
 || v‰->tg‰->
wr™e_´oc
) {

1369 
	`sú´štf
(
Çme
, Òame), "%d", 
v‰
->
´oc_num
);

1370 
	`»move_´oc_’Œy
(
Çme
, 
v‰
->
tg‰
->
´oc_tgt_roÙ
);

1373 
	`TRACE_EXIT
();

1375 
	}
}

1377 
ssize_t
 
	$sc¡_´oc_scsi_tgt_wr™e
(
fže
 *file,

1378 cÚ¡ 
__u£r
 *
buf
,

1379 
size_t
 
Ëngth
, 
loff_t
 *
off
)

1381 
sc¡_tgt
 *
v‰
 =

1382 (
sc¡_tgt
 *)
	`PDE
(
fže
->
f_d’Œy
->
d_šode
)->
d©a
;

1383 
ssize_t
 
»s
 = 0;

1384 *
bufãr
;

1385 *
¡¬t
;

1386 
eof
 = 0;

1388 
	`TRACE_ENTRY
();

1390 ià(
v‰
->
tg‰
->
wr™e_´oc
 =ð
NULL
) {

1391 
»s
 = -
ENOSYS
;

1392 
out
;

1395 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

1396 
»s
 = -
EOVERFLOW
;

1397 
out
;

1399 ià(!
buf
) {

1400 
»s
 = -
EINVAL
;

1401 
out
;

1403 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1404 ià(!
bufãr
) {

1405 
»s
 = -
ENOMEM
;

1406 
out
;

1408 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

1409 
»s
 = -
EFAULT
;

1410 
out_ä“
;

1412 ià(
Ëngth
 < 
PAGE_SIZE
) {

1413 
bufãr
[
Ëngth
] = '\0';

1414 } ià(
bufãr
[
PAGE_SIZE
-1]) {

1415 
»s
 = -
EINVAL
;

1416 
out_ä“
;

1419 
	`TRACE_BUFFER
("Bufãr", 
bufãr
, 
Ëngth
);

1421 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_´oc_mu‹x
) != 0) {

1422 
»s
 = -
EINTR
;

1423 
out_ä“
;

1426 
»s
 = 
v‰
->
tg‰
->
	`wr™e_´oc
(
bufãr
, &
¡¬t
, 0, 
Ëngth
, &
eof
, vtt);

1428 
	`mu‹x_uÆock
(&
sc¡_´oc_mu‹x
);

1430 
out_ä“
:

1431 
	`ä“_·ge
(()
bufãr
);

1432 
out
:

1433 
	`TRACE_EXIT_RES
(
»s
);

1434  
»s
;

1435 
	}
}

1437 
	$sc¡_bužd_´oc_dev_hªdËr_dœ_’Œ›s
(
sc¡_dev_ty³
 *
dev_ty³
)

1439 
»s
 = 0;

1440 
´oc_dœ_’Œy
 *
p
;

1441 cÚ¡ *
Çme
;

1443 
	`TRACE_ENTRY
();

1445 
	`sBUG_ON
(
dev_ty³
->
´oc_dev_ty³_roÙ
);

1447 ià(
	`¡rcmp
(
dev_ty³
->
Çme
, "vdisk_fileio") == 0)

1448 
Çme
 = "vdisk";

1450 
Çme
 = 
dev_ty³
->name;

1453 
dev_ty³
->
´oc_dev_ty³_roÙ
 = 
	`´oc_mkdœ
(
Çme
,

1454 
sc¡_´oc_scsi_tgt
);

1455 ià(
dev_ty³
->
´oc_dev_ty³_roÙ
 =ð
NULL
) {

1456 
	`PRINT_ERROR
("Notƒnough memoryo„egister dev handler dir "

1457 "% š /´oc/%s", 
Çme
, 
SCST_PROC_ENTRY_NAME
);

1458 
out_nomem
;

1461 
sc¡_dev_hªdËr_ty³_´oc_d©a
.
d©a
 = 
dev_ty³
;

1462 ià(
dev_ty³
->
ty³
 >= 0) {

1463 
p
 = 
	`sc¡_ü—‹_´oc_’Œy
(
dev_ty³
->
´oc_dev_ty³_roÙ
,

1464 
SCST_PROC_DEV_HANDLER_TYPE_ENTRY_NAME
,

1465 &
sc¡_dev_hªdËr_ty³_´oc_d©a
);

1466 ià(
p
 =ð
NULL
) {

1467 
	`PRINT_ERROR
("Notƒnough memoryo„egister dev "

1469 
SCST_PROC_DEV_HANDLER_TYPE_ENTRY_NAME
,

1470 
SCST_PROC_ENTRY_NAME
, 
Çme
);

1471 
out_»move
;

1475 ià(
dev_ty³
->
»ad_´oc
 || dev_ty³->
wr™e_´oc
) {

1477 
sc¡_dev_hªdËr_´oc_d©a
.
d©a
 = (*)
dev_ty³
;

1478 
p
 = 
	`sc¡_ü—‹_´oc_’Œy
(
dev_ty³
->
´oc_dev_ty³_roÙ
,

1479 
Çme
,

1480 &
sc¡_dev_hªdËr_´oc_d©a
);

1481 ià(
p
 =ð
NULL
) {

1482 
	`PRINT_ERROR
("Notƒnough memoryo„egister dev "

1483 "hªdË¸’Œy % š /´oc/%s/%s", 
Çme
,

1484 
SCST_PROC_ENTRY_NAME
, 
Çme
);

1485 
out_»move1
;

1489 
out
:

1490 
	`TRACE_EXIT_RES
(
»s
);

1491  
»s
;

1493 
out_»move1
:

1494 ià(
dev_ty³
->
ty³
 >= 0)

1495 
	`»move_´oc_’Œy
(
SCST_PROC_DEV_HANDLER_TYPE_ENTRY_NAME
,

1496 
dev_ty³
->
´oc_dev_ty³_roÙ
);

1498 
out_»move
:

1499 
	`»move_´oc_’Œy
(
Çme
, 
sc¡_´oc_scsi_tgt
);

1501 
out_nomem
:

1502 
»s
 = -
ENOMEM
;

1503 
out
;

1504 
	}
}

1506 
	$sc¡_þ—nup_´oc_dev_hªdËr_dœ_’Œ›s
(
sc¡_dev_ty³
 *
dev_ty³
)

1509 cÚ¡ *
Çme
;

1511 
	`TRACE_ENTRY
();

1513 
	`sBUG_ON
(
dev_ty³
->
´oc_dev_ty³_roÙ
 =ð
NULL
);

1515 ià(
	`¡rcmp
(
dev_ty³
->
Çme
, "vdisk_fileio") == 0)

1516 
Çme
 = "vdisk";

1518 
Çme
 = 
dev_ty³
->name;

1520 ià(
dev_ty³
->
ty³
 >= 0) {

1521 
	`»move_´oc_’Œy
(
SCST_PROC_DEV_HANDLER_TYPE_ENTRY_NAME
,

1522 
dev_ty³
->
´oc_dev_ty³_roÙ
);

1524 ià(
dev_ty³
->
»ad_´oc
 || dev_ty³->
wr™e_´oc
)

1525 
	`»move_´oc_’Œy
(
Çme
, 
dev_ty³
->
´oc_dev_ty³_roÙ
);

1526 
	`»move_´oc_’Œy
(
Çme
, 
sc¡_´oc_scsi_tgt
);

1527 
dev_ty³
->
´oc_dev_ty³_roÙ
 = 
NULL
;

1529 
	`TRACE_EXIT
();

1531 
	}
}

1533 
ssize_t
 
	$sc¡_´oc_scsi_dev_hªdËr_wr™e
(
fže
 *file,

1534 cÚ¡ 
__u£r
 *
buf
,

1535 
size_t
 
Ëngth
, 
loff_t
 *
off
)

1537 
sc¡_dev_ty³
 *
dev_ty³
 =

1538 (
sc¡_dev_ty³
 *)
	`PDE
(
fže
->
f_d’Œy
->
d_šode
)->
d©a
;

1539 
ssize_t
 
»s
 = 0;

1540 *
bufãr
;

1541 *
¡¬t
;

1542 
eof
 = 0;

1544 
	`TRACE_ENTRY
();

1546 ià(
dev_ty³
->
wr™e_´oc
 =ð
NULL
) {

1547 
»s
 = -
ENOSYS
;

1548 
out
;

1551 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

1552 
»s
 = -
EOVERFLOW
;

1553 
out
;

1555 ià(!
buf
) {

1556 
»s
 = -
EINVAL
;

1557 
out
;

1560 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1561 ià(!
bufãr
) {

1562 
»s
 = -
ENOMEM
;

1563 
out
;

1566 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

1567 
»s
 = -
EFAULT
;

1568 
out_ä“
;

1570 ià(
Ëngth
 < 
PAGE_SIZE
) {

1571 
bufãr
[
Ëngth
] = '\0';

1572 } ià(
bufãr
[
PAGE_SIZE
-1]) {

1573 
»s
 = -
EINVAL
;

1574 
out_ä“
;

1577 
	`TRACE_BUFFER
("Bufãr", 
bufãr
, 
Ëngth
);

1579 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_´oc_mu‹x
) != 0) {

1580 
»s
 = -
EINTR
;

1581 
out_ä“
;

1584 
»s
 = 
dev_ty³
->
	`wr™e_´oc
(
bufãr
, &
¡¬t
, 0, 
Ëngth
, &
eof
, dev_type);

1586 
	`mu‹x_uÆock
(&
sc¡_´oc_mu‹x
);

1588 
out_ä“
:

1589 
	`ä“_·ge
(()
bufãr
);

1591 
out
:

1592 
	`TRACE_EXIT_RES
(
»s
);

1593  
»s
;

1594 
	}
}

1596 
ssize_t
 
	$sc¡_´oc_scsi_tgt_g’_wr™e
(
fže
 *file,

1597 cÚ¡ 
__u£r
 *
buf
,

1598 
size_t
 
Ëngth
, 
loff_t
 *
off
)

1600 
»s
, 
rc
 = 0, 
aùiÚ
;

1601 *
bufãr
, *
p
, *
µ
, *
µp
;

1602 
sc¡_acg
 *
a
, *
acg
 = 
NULL
;

1603 
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_PERIPHERAL
;

1605 
	`TRACE_ENTRY
();

1607 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

1608 
»s
 = -
EOVERFLOW
;

1609 
out
;

1611 ià(!
buf
) {

1612 
»s
 = -
EINVAL
;

1613 
out
;

1615 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1616 ià(!
bufãr
) {

1617 
»s
 = -
ENOMEM
;

1618 
out
;

1620 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

1621 
»s
 = -
EFAULT
;

1622 
out_ä“
;

1624 ià(
Ëngth
 < 
PAGE_SIZE
) {

1625 
bufãr
[
Ëngth
] = '\0';

1626 } ià(
bufãr
[
PAGE_SIZE
-1]) {

1627 
»s
 = -
EINVAL
;

1628 
out_ä“
;

1638 
p
 = 
bufãr
;

1639 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

1640 
p
[
	`¡¾’
(p) - 1] = '\0';

1641 ià(!
	`¡ºÿ£cmp
("assigÀ", 
p
, 7)) {

1642 
p
 += 7;

1643 
aùiÚ
 = 
SCST_PROC_ACTION_ASSIGN
;

1644 } ià(!
	`¡ºÿ£cmp
("add_grou°", 
p
, 10)) {

1645 
p
 += 10;

1646 
aùiÚ
 = 
SCST_PROC_ACTION_ADD_GROUP
;

1647 } ià(!
	`¡ºÿ£cmp
("d–_grou°", 
p
, 10)) {

1648 
p
 += 10;

1649 
aùiÚ
 = 
SCST_PROC_ACTION_DEL_GROUP
;

1650 } ià(!
	`¡ºÿ£cmp
("»Çme_grou°", 
p
, 13)) {

1651 
p
 += 13;

1652 
aùiÚ
 = 
SCST_PROC_ACTION_RENAME_GROUP
;

1654 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

1655 
»s
 = -
EINVAL
;

1656 
out_ä“
;

1659 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

1660 ià(
»s
 != 0)

1661 
out_ä“
;

1663 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

1664 
»s
 = -
EINTR
;

1665 
out_ä“_»sume
;

1668 
»s
 = 
Ëngth
;

1670 
	`is¥aû
(*
p
) && *p != '\0')

1671 
p
++;

1673 
aùiÚ
) {

1674 
SCST_PROC_ACTION_ADD_GROUP
:

1675 
SCST_PROC_ACTION_DEL_GROUP
:

1676 
SCST_PROC_ACTION_RENAME_GROUP
:

1677 
µ
 = 
p
;

1678 !
	`is¥aû
(*
µ
) && *pp != '\0')

1679 
µ
++;

1680 ià(*
µ
 != '\0') {

1681 *
µ
 = '\0';

1682 
µ
++;

1683 
	`is¥aû
(*
µ
) && *pp != '\0')

1684 
µ
++;

1685 ià(*
µ
 != '\0') {

1686 
aùiÚ
) {

1687 
SCST_PROC_ACTION_ADD_GROUP
:

1688 
µp
 = 
µ
;

1689 !
	`is¥aû
(*
µp
) && *ppp != '\0')

1690 
µp
++;

1691 ià(*
µp
 != '\0') {

1692 *
µp
 = '\0';

1693 
µp
++;

1694 
	`is¥aû
(*
µp
) && *ppp != '\0')

1695 
µp
++;

1696 ià(*
µp
 != '\0') {

1697 
	`PRINT_ERROR
("%s", "Too many "

1699 
»s
 = -
EINVAL
;

1700 
out_up_ä“
;

1703 ià(
	`¡rÿ£cmp
(
µ
, "FLAT") == 0)

1704 
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_FLAT
;

1705 ià(
	`¡rÿ£cmp
(
µ
, "LUN") == 0)

1706 
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_LUN
;

1708 
	`PRINT_ERROR
("Unexpected "

1709 "¬gum’ˆ%s", 
µ
);

1710 
»s
 = -
EINVAL
;

1711 
out_up_ä“
;

1714 
SCST_PROC_ACTION_DEL_GROUP
:

1715 
	`PRINT_ERROR
("%s", "Too many "

1717 
»s
 = -
EINVAL
;

1718 
out_up_ä“
;

1723 ià(
	`¡rcmp
(
p
, 
SCST_DEFAULT_ACG_NAME
) == 0) {

1724 
	`PRINT_ERROR
("Attempto‡dd/delete/rename…redefined "

1725 "grou°\"%s\"", 
p
);

1726 
»s
 = -
EINVAL
;

1727 
out_up_ä“
;

1730 
	`li¡_fÜ_—ch_’Œy
(
a
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

1731 ià(
	`¡rcmp
(
a
->
acg_Çme
, 
p
) == 0) {

1732 
	`TRACE_DBG
("group (acg) %p %s found",

1733 
a
,‡->
acg_Çme
);

1734 
acg
 = 
a
;

1739 
aùiÚ
) {

1740 
SCST_PROC_ACTION_ADD_GROUP
:

1741 ià(
acg
) {

1742 
	`PRINT_ERROR
("acg‚am% exi¡", 
p
);

1743 
»s
 = -
EINVAL
;

1744 
out_up_ä“
;

1746 
rc
 = 
	`sc¡_´oc_group_add
(
p
, 
addr_m‘hod
);

1748 
SCST_PROC_ACTION_DEL_GROUP
:

1749 ià(
acg
 =ð
NULL
) {

1750 
	`PRINT_ERROR
("acg‚am% nÙ found", 
p
);

1751 
»s
 = -
EINVAL
;

1752 
out_up_ä“
;

1754 
rc
 = 
	`sc¡_´oc_d–_ä“_acg
(
acg
, 1);

1756 
SCST_PROC_ACTION_RENAME_GROUP
:

1757 ià(
acg
 =ð
NULL
) {

1758 
	`PRINT_ERROR
("acg‚am% nÙ found", 
p
);

1759 
»s
 = -
EINVAL
;

1760 
out_up_ä“
;

1763 
p
 = 
µ
;

1764 !
	`is¥aû
(*
µ
) && *pp != '\0')

1765 
µ
++;

1766 ià(*
µ
 != '\0') {

1767 *
µ
 = '\0';

1768 
µ
++;

1769 
	`is¥aû
(*
µ
) && *pp != '\0')

1770 
µ
++;

1771 ià(*
µ
 != '\0') {

1772 
	`PRINT_ERROR
("%s", "Too many‡rguments");

1773 
»s
 = -
EINVAL
;

1774 
out_up_ä“
;

1777 
rc
 = 
	`sc¡_´oc_»Çme_acg
(
acg
, 
p
);

1781 
SCST_PROC_ACTION_ASSIGN
:

1782 
rc
 = 
	`sc¡_´oc_assign_hªdËr
(
p
);

1786 ià(
rc
 != 0)

1787 
»s
 = 
rc
;

1789 
out_up_ä“
:

1790 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1792 
out_ä“_»sume
:

1793 
	`sc¡_»sume_aùiv™y
();

1795 
out_ä“
:

1796 
	`ä“_·ge
(()
bufãr
);

1798 
out
:

1799 
	`TRACE_EXIT_RES
(
»s
);

1800  
»s
;

1801 
	}
}

1804 
	$sc¡_´oc_assign_hªdËr
(*
buf
)

1806 
»s
 = 0;

1807 *
p
 = 
buf
, *
e
, *
“
;

1808 
ho¡
, 
chªÃl
 = 0, 
id
 = 0, 
lun
 = 0;

1809 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

1810 
sc¡_dev_ty³
 *
dt
, *
hªdËr
 = 
NULL
;

1812 
	`TRACE_ENTRY
();

1814 
	`is¥aû
(*
p
) && *p != '\0')

1815 
p
++;

1817 
ho¡
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

1818 ià((
ho¡
 =ð
ULONG_MAX
è|| (*
p
 != ':'))

1819 
out_syÁ_”r
;

1820 
p
++;

1821 
chªÃl
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

1822 ià((
chªÃl
 =ð
ULONG_MAX
è|| (*
p
 != ':'))

1823 
out_syÁ_”r
;

1824 
p
++;

1825 
id
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

1826 ià((
chªÃl
 =ð
ULONG_MAX
è|| (*
p
 != ':'))

1827 
out_syÁ_”r
;

1828 
p
++;

1829 
lun
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

1830 ià(
lun
 =ð
ULONG_MAX
)

1831 
out_syÁ_”r
;

1833 
e
 = 
p
;

1834 
e
++;

1835 
	`is¥aû
(*
e
) && *e != '\0')

1836 
e
++;

1837 
“
 = 
e
;

1838 !
	`is¥aû
(*
“
) && *ee != '\0')

1839 
“
++;

1840 *
“
 = '\0';

1842 
	`TRACE_DBG
("Dev %ld:%ld:%ld:%ld, hªdË¸%s", 
ho¡
, 
chªÃl
, 
id
, 
lun
, 
e
);

1844 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1845 ià((
d
->
vœt_id
 == 0) &&

1846 
d
->
scsi_dev
->
ho¡
->
ho¡_no
 == host &&

1847 
d
->
scsi_dev
->
chªÃl
 == channel &&

1848 
d
->
scsi_dev
->
id
 == id &&

1849 
d
->
scsi_dev
->
lun
 ==†un) {

1850 
dev
 = 
d
;

1851 
	`TRACE_DBG
("Dev %p (%ld:%ld:%ld:%ld) found",

1852 
dev
, 
ho¡
, 
chªÃl
, 
id
, 
lun
);

1857 ià(
dev
 =ð
NULL
) {

1858 
	`PRINT_ERROR
("Device %ld:%ld:%ld:%ld‚ot found",

1859 
ho¡
, 
chªÃl
, 
id
, 
lun
);

1860 
»s
 = -
EINVAL
;

1861 
out
;

1864 
	`li¡_fÜ_—ch_’Œy
(
dt
, &
sc¡_dev_ty³_li¡
, 
dev_ty³_li¡_’Œy
) {

1865 ià(!
	`¡rcmp
(
dt
->
Çme
, 
e
)) {

1866 
hªdËr
 = 
dt
;

1867 
	`TRACE_DBG
("Dev handler %p with‚ame %s found",

1868 
dt
, dt->
Çme
);

1873 ià(
hªdËr
 =ð
NULL
) {

1874 
	`PRINT_ERROR
("HªdË¸% nÙ found", 
e
);

1875 
»s
 = -
EINVAL
;

1876 
out
;

1879 ià(
dev
->
scsi_dev
->
ty³
 !ð
hªdËr
->type) {

1880 
	`PRINT_ERROR
("Type %d of device %s differs fromype "

1881 "%d oàdev hªdË¸%s", 
dev
->
ty³
,

1882 
dev
->
hªdËr
->
Çme
, hªdËr->
ty³
, handler->name);

1883 
»s
 = -
EINVAL
;

1884 
out
;

1887 
»s
 = 
	`sc¡_assign_dev_hªdËr
(
dev
, 
hªdËr
);

1889 
out
:

1890 
	`TRACE_EXIT_RES
(
»s
);

1891  
»s
;

1893 
out_syÁ_”r
:

1894 
	`PRINT_ERROR
("SyÁaxƒ¼Ü oÀ%s", 
p
);

1895 
»s
 = -
EINVAL
;

1896 
out
;

1897 
	}
}

1899 
ssize_t
 
	$sc¡_´oc_groups_deviûs_wr™e
(
fže
 *file,

1900 cÚ¡ 
__u£r
 *
buf
,

1901 
size_t
 
Ëngth
, 
loff_t
 *
off
)

1903 
»s
, 
aùiÚ
, 
rc
, 
»ad_Úly
 = 0;

1904 *
bufãr
, *
p
, *
e
 = 
NULL
;

1905 
vœt_lun
;

1906 
sc¡_acg
 *
acg
 =

1907 (
sc¡_acg
 *)
	`PDE
(
fže
->
f_d’Œy
->
d_šode
)->
d©a
;

1908 
sc¡_acg_dev
 *
acg_dev
 = 
NULL
, *
acg_dev_tmp
;

1909 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

1911 
	`TRACE_ENTRY
();

1913 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

1914 
»s
 = -
EOVERFLOW
;

1915 
out
;

1917 ià(!
buf
) {

1918 
»s
 = -
EINVAL
;

1919 
out
;

1921 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1922 ià(!
bufãr
) {

1923 
»s
 = -
ENOMEM
;

1924 
out
;

1926 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

1927 
»s
 = -
EFAULT
;

1928 
out_ä“
;

1930 ià(
Ëngth
 < 
PAGE_SIZE
) {

1931 
bufãr
[
Ëngth
] = '\0';

1932 } ià(
bufãr
[
PAGE_SIZE
-1]) {

1933 
»s
 = -
EINVAL
;

1934 
out_ä“
;

1948 
p
 = 
bufãr
;

1949 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

1950 
p
[
	`¡¾’
(p) - 1] = '\0';

1951 ià(!
	`¡ºÿ£cmp
("þ—r", 
p
, 5)) {

1952 
aùiÚ
 = 
SCST_PROC_ACTION_CLEAR
;

1953 } ià(!
	`¡ºÿ£cmp
("add ", 
p
, 4)) {

1954 
p
 += 4;

1955 
aùiÚ
 = 
SCST_PROC_ACTION_ADD
;

1956 } ià(!
	`¡ºÿ£cmp
("d– ", 
p
, 4)) {

1957 
p
 += 4;

1958 
aùiÚ
 = 
SCST_PROC_ACTION_DEL
;

1959 } ià(!
	`¡ºÿ£cmp
("»¶aû ", 
p
, 8)) {

1960 
p
 += 8;

1961 
aùiÚ
 = 
SCST_PROC_ACTION_REPLACE
;

1963 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

1964 
»s
 = -
EINVAL
;

1965 
out_ä“
;

1968 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

1969 ià(
»s
 != 0)

1970 
out_ä“
;

1972 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

1973 
»s
 = -
EINTR
;

1974 
out_ä“_»sume
;

1977 
»s
 = 
Ëngth
;

1979 
aùiÚ
) {

1980 
SCST_PROC_ACTION_ADD
:

1981 
SCST_PROC_ACTION_DEL
:

1982 
SCST_PROC_ACTION_REPLACE
:

1983 
	`is¥aû
(*
p
) && *p != '\0')

1984 
p
++;

1985 
e
 = 
p
;

1986 !
	`is¥aû
(*
e
) && *e != '\0')

1987 
e
++;

1988 *
e
 = 0;

1990 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1991 ià(!
	`¡rcmp
(
d
->
vœt_Çme
, 
p
)) {

1992 
dev
 = 
d
;

1993 
	`TRACE_DBG
("Deviû %°(%sèfound", 
dev
, 
p
);

1997 ià(
dev
 =ð
NULL
) {

1998 
	`PRINT_ERROR
("Deviû % nÙ found", 
p
);

1999 
»s
 = -
EINVAL
;

2000 
out_ä“_up
;

2007 
aùiÚ
) {

2008 
SCST_PROC_ACTION_ADD
:

2009 
SCST_PROC_ACTION_REPLACE
:

2011 
boÞ
 
dev_»¶aûd
 = 
çl£
;

2013 
e
++;

2014 
	`is¥aû
(*
e
) && *e != '\0')

2015 
e
++;

2017 
vœt_lun
 = 
	`sim¶e_¡¹oul
(
e
, &e, 0);

2018 ià(
vœt_lun
 > 
SCST_MAX_LUN
) {

2019 
	`PRINT_ERROR
("ToØbig LUN %d (max %d)", 
vœt_lun
,

2020 
SCST_MAX_LUN
);

2021 
»s
 = -
EINVAL
;

2022 
out_ä“_up
;

2025 
	`is¥aû
(*
e
) && *e != '\0')

2026 
e
++;

2028 ià(*
e
 != '\0') {

2029 ià(!
	`¡ºÿ£cmp
("READ_ONLY", 
e
, 9))

2030 
»ad_Úly
 = 1;

2032 
	`PRINT_ERROR
("UnknowÀÝtiÚ \"%s\"", 
e
);

2033 
»s
 = -
EINVAL
;

2034 
out_ä“_up
;

2038 
	`li¡_fÜ_—ch_’Œy
(
acg_dev_tmp
, &
acg
->
acg_dev_li¡
,

2039 
acg_dev_li¡_’Œy
) {

2040 ià(
acg_dev_tmp
->
lun
 =ð
vœt_lun
) {

2041 
acg_dev
 = 
acg_dev_tmp
;

2045 ià(
acg_dev
 !ð
NULL
) {

2046 ià(
aùiÚ
 =ð
SCST_PROC_ACTION_ADD
) {

2047 
	`PRINT_ERROR
("virt†un %d‡lreadyƒxists in "

2048 "grou°%s", 
vœt_lun
, 
acg
->
acg_Çme
);

2049 
»s
 = -
EEXIST
;

2050 
out_ä“_up
;

2053 
rc
 = 
	`sc¡_acg_d–_lun
(
acg
, 
acg_dev
->
lun
,

2054 
çl£
);

2055 ià(
rc
) {

2056 
»s
 = 
rc
;

2057 
out_ä“_up
;

2059 
dev_»¶aûd
 = 
Œue
;

2063 
rc
 = 
	`sc¡_acg_add_lun
(
acg
, 
NULL
, 
dev
, 
vœt_lun
, 
»ad_Úly
,

2064 
çl£
, 
NULL
);

2065 ià(
rc
) {

2066 
»s
 = 
rc
;

2067 
out_ä“_up
;

2070 ià(
aùiÚ
 =ð
SCST_PROC_ACTION_ADD
)

2071 
	`sc¡_»pÜt_luns_chªged
(
acg
);

2073 ià(
dev_»¶aûd
) {

2074 
sc¡_tgt_dev
 *
tgt_dev
;

2076 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

2077 
dev_tgt_dev_li¡_’Œy
) {

2078 ià((
tgt_dev
->
acg_dev
->
acg
 ==‡cg) &&

2079 (
tgt_dev
->
lun
 =ð
vœt_lun
)) {

2080 
	`TRACE_MGMT_DBG
("INQUIRY DATA HAS CHANGED"

2081 " oÀtgt_dev %p", 
tgt_dev
);

2082 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

2083 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šqu”y_d©a_chªged
));

2089 
SCST_PROC_ACTION_DEL
:

2097 
sc¡_acg_dev
 *
a
;

2098 
	`li¡_fÜ_—ch_’Œy
(
a
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

2099 ià(
a
->
dev
 == dev) {

2100 
rc
 = 
	`sc¡_acg_d–_lun
(
acg
, 
a
->
lun
, 
Œue
);

2101 ià(
rc
)

2102 
»s
 = 
rc
;

2103 
out_ä“_up
;

2106 
	`PRINT_ERROR
("Deviû i nÙ found iÀgrou°%s", 
acg
->
acg_Çme
);

2109 
SCST_PROC_ACTION_CLEAR
:

2110 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
acg_dev_tmp
,

2111 &
acg
->
acg_dev_li¡
,

2112 
acg_dev_li¡_’Œy
) {

2113 
rc
 = 
	`sc¡_acg_d–_lun
(
acg
, 
acg_dev
->
lun
,

2114 
	`li¡_is_Ï¡
(&
acg_dev
->
acg_dev_li¡_’Œy
,

2115 &
acg
->
acg_dev_li¡
));

2116 ià(
rc
) {

2117 
»s
 = 
rc
;

2118 
out_ä“_up
;

2124 
out_ä“_up
:

2125 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2127 
out_ä“_»sume
:

2128 
	`sc¡_»sume_aùiv™y
();

2130 
out_ä“
:

2131 
	`ä“_·ge
(()
bufãr
);

2133 
out
:

2134 
	`TRACE_EXIT_RES
(
»s
);

2135  
»s
;

2136 
	}
}

2138 
ssize_t
 
	$sc¡_´oc_groups_Çmes_wr™e
(
fže
 *file,

2139 cÚ¡ 
__u£r
 *
buf
,

2140 
size_t
 
Ëngth
, 
loff_t
 *
off
)

2142 
»s
 = 
Ëngth
, 
rc
 = 0, 
aùiÚ
;

2143 *
bufãr
, *
p
, *
µ
 = 
NULL
;

2144 
sc¡_acg
 *
acg
 =

2145 (
sc¡_acg
 *)
	`PDE
(
fže
->
f_d’Œy
->
d_šode
)->
d©a
;

2146 
sc¡_aú
 *
n
, *
Â
;

2148 
	`TRACE_ENTRY
();

2150 ià(
Ëngth
 > 
SCST_PROC_BLOCK_SIZE
) {

2151 
»s
 = -
EOVERFLOW
;

2152 
out
;

2154 ià(!
buf
) {

2155 
»s
 = -
EINVAL
;

2156 
out
;

2158 
bufãr
 = (*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

2159 ià(!
bufãr
) {

2160 
»s
 = -
ENOMEM
;

2161 
out
;

2163 ià(
	`cÝy_äom_u£r
(
bufãr
, 
buf
, 
Ëngth
)) {

2164 
»s
 = -
EFAULT
;

2165 
out_ä“
;

2167 ià(
Ëngth
 < 
PAGE_SIZE
) {

2168 
bufãr
[
Ëngth
] = '\0';

2169 } ià(
bufãr
[
PAGE_SIZE
-1]) {

2170 
»s
 = -
EINVAL
;

2171 
out_ä“
;

2179 
p
 = 
bufãr
;

2180 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

2181 
p
[
	`¡¾’
(p) - 1] = '\0';

2182 ià(!
	`¡ºÿ£cmp
("þ—r", 
p
, 5)) {

2183 
aùiÚ
 = 
SCST_PROC_ACTION_CLEAR
;

2184 } ià(!
	`¡ºÿ£cmp
("add ", 
p
, 4)) {

2185 
p
 += 4;

2186 
aùiÚ
 = 
SCST_PROC_ACTION_ADD
;

2187 } ià(!
	`¡ºÿ£cmp
("d– ", 
p
, 4)) {

2188 
p
 += 4;

2189 
aùiÚ
 = 
SCST_PROC_ACTION_DEL
;

2190 } ià(!
	`¡ºÿ£cmp
("mov", 
p
, 5)) {

2191 
p
 += 5;

2192 
aùiÚ
 = 
SCST_PROC_ACTION_MOVE
;

2194 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

2195 
»s
 = -
EINVAL
;

2196 
out_ä“
;

2199 
aùiÚ
) {

2200 
SCST_PROC_ACTION_ADD
:

2201 
SCST_PROC_ACTION_DEL
:

2202 
SCST_PROC_ACTION_MOVE
:

2203 
	`is¥aû
(*
p
) && *p != '\0')

2204 
p
++;

2205 
µ
 = 
p
;

2206 !
	`is¥aû
(*
µ
) && *pp != '\0')

2207 
µ
++;

2208 ià(*
µ
 != '\0') {

2209 *
µ
 = '\0';

2210 
µ
++;

2211 
	`is¥aû
(*
µ
) && *pp != '\0')

2212 
µ
++;

2213 ià(*
µ
 != '\0') {

2214 
aùiÚ
) {

2215 
SCST_PROC_ACTION_ADD
:

2216 
SCST_PROC_ACTION_DEL
:

2217 
	`PRINT_ERROR
("%s", "Too many "

2219 
»s
 = -
EINVAL
;

2220 
out_ä“
;

2227 
rc
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

2228 ià(
rc
 != 0)

2229 
out_ä“
;

2231 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2232 
»s
 = -
EINTR
;

2233 
out_ä“_»sume
;

2236 
aùiÚ
) {

2237 
SCST_PROC_ACTION_ADD
:

2238 
rc
 = 
	`sc¡_acg_add_aú
(
acg
, 
p
);

2240 
SCST_PROC_ACTION_DEL
:

2241 
rc
 = 
	`sc¡_acg_»move_Çme
(
acg
, 
p
, 
Œue
);

2243 
SCST_PROC_ACTION_MOVE
:

2245 
sc¡_acg
 *
a
, *
Ãw_acg
 = 
NULL
;

2246 *
Çme
 = 
p
;

2247 
p
 = 
µ
;

2248 !
	`is¥aû
(*
µ
) && *pp != '\0')

2249 
µ
++;

2250 ià(*
µ
 != '\0') {

2251 *
µ
 = '\0';

2252 
µ
++;

2253 
	`is¥aû
(*
µ
) && *pp != '\0')

2254 
µ
++;

2255 ià(*
µ
 != '\0') {

2256 
	`PRINT_ERROR
("%s", "Too many‡rguments");

2257 
»s
 = -
EINVAL
;

2258 
out_ä“_uÆock
;

2261 
	`li¡_fÜ_—ch_’Œy
(
a
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

2262 ià(
	`¡rcmp
(
a
->
acg_Çme
, 
p
) == 0) {

2263 
	`TRACE_DBG
("group (acg) %p %s found",

2264 
a
,‡->
acg_Çme
);

2265 
Ãw_acg
 = 
a
;

2269 ià(
Ãw_acg
 =ð
NULL
) {

2270 
	`PRINT_ERROR
("Grou°% nÙ found", 
p
);

2271 
»s
 = -
EINVAL
;

2272 
out_ä“_uÆock
;

2274 
rc
 = 
	`sc¡_acg_»move_Çme
(
acg
, 
Çme
, 
çl£
);

2275 ià(
rc
 != 0)

2276 
out_ä“_uÆock
;

2277 
rc
 = 
	`sc¡_acg_add_aú
(
Ãw_acg
, 
Çme
);

2278 ià(
rc
 != 0)

2279 
	`sc¡_acg_add_aú
(
acg
, 
Çme
);

2282 
SCST_PROC_ACTION_CLEAR
:

2283 
	`li¡_fÜ_—ch_’Œy_§ã
(
n
, 
Â
, &
acg
->
aú_li¡
,

2284 
aú_li¡_’Œy
) {

2285 
	`sc¡_d–_ä“_aú
(
n
, 
çl£
);

2287 
	`sc¡_check_»assign_£ssiÚs
();

2291 
out_ä“_uÆock
:

2292 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2294 
out_ä“_»sume
:

2295 
	`sc¡_»sume_aùiv™y
();

2297 
out_ä“
:

2298 
	`ä“_·ge
(()
bufãr
);

2300 
out
:

2301 ià(
rc
 < 0)

2302 
»s
 = 
rc
;

2304 
	`TRACE_EXIT_RES
(
»s
);

2305  
»s
;

2306 
	}
}

2308 
	$sc¡_v”siÚ_šfo_show
(
£q_fže
 *
£q
, *
v
)

2310 
	`TRACE_ENTRY
();

2312 
	`£q_´štf
(
£q
, "%s\n", 
SCST_VERSION_STRING
);

2314 #ifdeà
CONFIG_SCST_STRICT_SERIALIZING


2315 
	`£q_´štf
(
£q
, "STRICT_SERIALIZING\n");

2318 #ifdeà
CONFIG_SCST_EXTRACHECKS


2319 
	`£q_´štf
(
£q
, "EXTRACHECKS\n");

2322 #ifdeà
CONFIG_SCST_TRACING


2323 
	`£q_´štf
(
£q
, "TRACING\n");

2326 #ifdeà
CONFIG_SCST_DEBUG


2327 
	`£q_´štf
(
£q
, "DEBUG\n");

2330 #ifdeà
CONFIG_SCST_DEBUG_TM


2331 
	`£q_´štf
(
£q
, "DEBUG_TM\n");

2334 #ifdeà
CONFIG_SCST_DEBUG_RETRY


2335 
	`£q_´štf
(
£q
, "DEBUG_RETRY\n");

2338 #ifdeà
CONFIG_SCST_DEBUG_OOM


2339 
	`£q_´štf
(
£q
, "DEBUG_OOM\n");

2342 #ifdeà
CONFIG_SCST_DEBUG_SN


2343 
	`£q_´štf
(
£q
, "DEBUG_SN\n");

2346 #ifdeà
CONFIG_SCST_USE_EXPECTED_VALUES


2347 
	`£q_´štf
(
£q
, "USE_EXPECTED_VALUES\n");

2350 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


2351 
	`£q_´štf
(
£q
, "TEST_IO_IN_SIRQ\n");

2354 #ifdeà
CONFIG_SCST_STRICT_SECURITY


2355 
	`£q_´štf
(
£q
, "STRICT_SECURITY\n");

2358 
	`TRACE_EXIT
();

2360 
	}
}

2362 
sc¡_´oc_d©a
 
	gsc¡_v”siÚ_´oc_d©a
 = {

2363 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2364 .
show
 = 
sc¡_v”siÚ_šfo_show
,

2367 
	$sc¡_h–p_šfo_show
(
£q_fže
 *
£q
, *
v
)

2369 
	`TRACE_ENTRY
();

2371 
	`£q_´štf
(
£q
, "%s\n", 
sc¡_´oc_h–p_¡ršg
);

2373 
	`TRACE_EXIT
();

2375 
	}
}

2377 
sc¡_´oc_d©a
 
	gsc¡_h–p_´oc_d©a
 = {

2378 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2379 .
show
 = 
sc¡_h–p_šfo_show
,

2382 
	$sc¡_dev_hªdËr_ty³_šfo_show
(
£q_fže
 *
£q
, *
v
)

2384 
sc¡_dev_ty³
 *
dev_ty³
 = (sc¡_dev_ty³ *)
£q
->
´iv©e
;

2386 
	`TRACE_ENTRY
();

2388 
	`£q_´štf
(
£q
, "%d - %s\n", 
dev_ty³
->
ty³
,

2389 
dev_ty³
->
ty³
 > ()
	`ARRAY_SIZE
(
sc¡_´oc_dev_hªdËr_ty³
)

2390 ? "unknown" : 
sc¡_´oc_dev_hªdËr_ty³
[
dev_ty³
->
ty³
]);

2392 
	`TRACE_EXIT
();

2394 
	}
}

2396 
sc¡_´oc_d©a
 
	gsc¡_dev_hªdËr_ty³_´oc_d©a
 = {

2397 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2398 .
show
 = 
sc¡_dev_hªdËr_ty³_šfo_show
,

2401 
	$sc¡_£ssiÚs_šfo_show
(
£q_fže
 *
£q
, *
v
)

2403 
»s
 = 0;

2404 
sc¡_acg
 *
acg
;

2405 
sc¡_£ssiÚ
 *
£ss
;

2407 
	`TRACE_ENTRY
();

2409 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2410 
»s
 = -
EINTR
;

2411 
out
;

2414 
	`£q_´štf
(
£q
, "%-20s %-45s %-35s %-15s\n",

2418 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

2419 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
,

2420 
acg_£ss_li¡_’Œy
) {

2421 
aùive_cmds
 = 0, 
t
;

2422 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

2423 
li¡_h—d
 *
h—d
 =

2424 &
£ss
->
£ss_tgt_dev_li¡
[
t
];

2425 
sc¡_tgt_dev
 *
tgt_dev
;

2426 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

2427 
£ss_tgt_dev_li¡_’Œy
) {

2428 
aùive_cmds
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_cmd_couÁ
);

2431 
	`£q_´štf
(
£q
, "%-20s %-45s %-35s %d/%d\n",

2432 
£ss
->
tgt
->
tg‰
->
Çme
,

2433 
£ss
->
š™ŸtÜ_Çme
,

2434 
acg
->
acg_Çme
, 
aùive_cmds
,

2435 
	`©omic_»ad
(&
£ss
->
£ss_cmd_couÁ
));

2439 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2441 
out
:

2442 
	`TRACE_EXIT_RES
(
»s
);

2443  
»s
;

2444 
	}
}

2446 
sc¡_´oc_d©a
 
	gsc¡_£ssiÚs_´oc_d©a
 = {

2447 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2448 .
show
 = 
sc¡_£ssiÚs_šfo_show
,

2451 
sc¡_´oc_d©a
 
	gsc¡_sgv_´oc_d©a
 = {

2452 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2453 .
show
 = 
sgv_´ocšfo_show
,

2456 
	$sc¡_groups_Çmes_show
(
£q_fže
 *
£q
, *
v
)

2458 
»s
 = 0;

2459 
sc¡_acg
 *
acg
 = (sc¡_acg *)
£q
->
´iv©e
;

2460 
sc¡_aú
 *
Çme
;

2462 
	`TRACE_ENTRY
();

2464 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2465 
»s
 = -
EINTR
;

2466 
out
;

2469 
	`li¡_fÜ_—ch_’Œy
(
Çme
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

2470 
	`£q_´štf
(
£q
, "%s\n", 
Çme
->name);

2473 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2475 
out
:

2476 
	`TRACE_EXIT_RES
(
»s
);

2477  
»s
;

2478 
	}
}

2480 
sc¡_´oc_d©a
 
	gsc¡_groups_Çmes_´oc_d©a
 = {

2481 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_groups_Çmes_wr™e
)

2482 .
show
 = 
sc¡_groups_Çmes_show
,

2485 
	$sc¡_groups_addr_m‘hod_show
(
£q_fže
 *
£q
, *
v
)

2487 
»s
 = 0;

2488 
sc¡_acg
 *
acg
 = (sc¡_acg *)
£q
->
´iv©e
;

2490 
	`TRACE_ENTRY
();

2492 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2493 
»s
 = -
EINTR
;

2494 
out
;

2497 
acg
->
addr_m‘hod
) {

2498 
SCST_LUN_ADDR_METHOD_FLAT
:

2499 
	`£q_´štf
(
£q
, "%s\n", "FLAT");

2501 
SCST_LUN_ADDR_METHOD_PERIPHERAL
:

2502 
	`£q_´štf
(
£q
, "%s\n", "PERIPHERAL");

2504 
SCST_LUN_ADDR_METHOD_LUN
:

2505 
	`£q_´štf
(
£q
, "%s\n", "LUN");

2508 
	`£q_´štf
(
£q
, "%s\n", "UNKNOWN");

2512 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2514 
out
:

2515 
	`TRACE_EXIT_RES
(
»s
);

2516  
»s
;

2517 
	}
}

2518 
sc¡_´oc_d©a
 
	gsc¡_groups_addr_m‘hod_´oc_d©a
 = {

2519 
SCST_DEF_RW_SEQ_OP
(
NULL
)

2520 .
show
 = 
sc¡_groups_addr_m‘hod_show
,

2522 
	$sc¡_groups_deviûs_show
(
£q_fže
 *
£q
, *
v
)

2524 
»s
 = 0;

2525 
sc¡_acg
 *
acg
 = (sc¡_acg *)
£q
->
´iv©e
;

2526 
sc¡_acg_dev
 *
acg_dev
;

2528 
	`TRACE_ENTRY
();

2530 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2531 
»s
 = -
EINTR
;

2532 
out
;

2535 
	`£q_´štf
(
£q
, "%-60s%-13s%s\n", "Device (host:ch:id:lun or‚ame)",

2538 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

2539 
	`£q_´štf
(
£q
, "%-60s%-13lld%s\n",

2540 
acg_dev
->
dev
->
vœt_Çme
,

2541 ()
acg_dev
->
lun
,

2542 
acg_dev
->
rd_Úly
 ? "RO" : "");

2544 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2546 
out
:

2547 
	`TRACE_EXIT_RES
(
»s
);

2548  
»s
;

2549 
	}
}

2551 
sc¡_´oc_d©a
 
	gsc¡_groups_deviûs_´oc_d©a
 = {

2552 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_groups_deviûs_wr™e
)

2553 .
show
 = 
sc¡_groups_deviûs_show
,

2556 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

2558 
	$sc¡_´oc_»ad_tbl
(cÚ¡ 
sc¡_Œaû_log
 *
tbl
,

2559 
£q_fže
 *
£q
,

2560 
log_Ëv–
, *
fœ¡
)

2562 cÚ¡ 
sc¡_Œaû_log
 *
t
 = 
tbl
;

2563 
»s
 = 0;

2565 
t
->
tok’
) {

2566 ià(
log_Ëv–
 & 
t
->
v®
) {

2567 
	`£q_´štf
(
£q
, "%s%s", *
fœ¡
 ? "" : " | ", 
t
->
tok’
);

2568 *
fœ¡
 = 0;

2570 
t
++;

2572  
»s
;

2573 
	}
}

2575 
	$sc¡_´oc_log_’Œy_»ad
(
£q_fže
 *
£q
, 
log_Ëv–
,

2576 cÚ¡ 
sc¡_Œaû_log
 *
tbl
)

2578 
»s
 = 0, 
fœ¡
 = 1;

2580 
	`TRACE_ENTRY
();

2582 
	`sc¡_´oc_»ad_tbl
(
sc¡_´oc_Œaû_tbl
, 
£q
, 
log_Ëv–
, &
fœ¡
);

2584 ià(
tbl
)

2585 
	`sc¡_´oc_»ad_tbl
(
tbl
, 
£q
, 
log_Ëv–
, &
fœ¡
);

2587 
	`£q_´štf
(
£q
, "%s\n", 
fœ¡
 ? "none" : "");

2589 
	`TRACE_EXIT_RES
(
»s
);

2590  
»s
;

2591 
	}
}

2592 
EXPORT_SYMBOL_GPL
(
sc¡_´oc_log_’Œy_»ad
);

2594 
	$log_šfo_show
(
£q_fže
 *
£q
, *
v
)

2596 
»s
;

2598 
	`TRACE_ENTRY
();

2600 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_log_mu‹x
) != 0) {

2601 
»s
 = -
EINTR
;

2602 
out
;

2605 
»s
 = 
	`sc¡_´oc_log_’Œy_»ad
(
£q
, 
Œaû_æag
,

2606 
sc¡_´oc_loÿl_Œaû_tbl
);

2608 
	`mu‹x_uÆock
(&
sc¡_log_mu‹x
);

2610 
out
:

2611 
	`TRACE_EXIT_RES
(
»s
);

2612  
»s
;

2613 
	}
}

2615 
sc¡_´oc_d©a
 
	gsc¡_log_´oc_d©a
 = {

2616 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_scsi_tgt_g’_wr™e_log
)

2617 .
show
 = 
log_šfo_show
,

2618 .
	gd©a
 = "scsi_tgt",

2623 
	$sc¡_tgt_šfo_show
(
£q_fže
 *
£q
, *
v
)

2625 
»s
 = 0;

2626 
sc¡_deviû
 *
dev
;

2628 
	`TRACE_ENTRY
();

2630 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
) != 0) {

2631 
»s
 = -
EINTR
;

2632 
out
;

2635 
	`£q_´štf
(
£q
, "%-60s%s\n", "Device (host:ch:id:lun or‚ame)",

2637 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

2638 
	`£q_´štf
(
£q
, "%-60s%s\n",

2639 
dev
->
vœt_Çme
, dev->
hªdËr
->
Çme
);

2642 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2644 
out
:

2645 
	`TRACE_EXIT_RES
(
»s
);

2646  
»s
;

2647 
	}
}

2649 
sc¡_´oc_d©a
 
	gsc¡_tgt_´oc_d©a
 = {

2650 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_scsi_tgt_g’_wr™e
)

2651 .
show
 = 
sc¡_tgt_šfo_show
,

2654 
	$sc¡_th»ads_šfo_show
(
£q_fže
 *
£q
, *
v
)

2656 
	`TRACE_ENTRY
();

2658 
	`£q_´štf
(
£q
, "%d\n", 
sc¡_maš_cmd_th»ads
.
Ä_th»ads
);

2660 
	`TRACE_EXIT
();

2662 
	}
}

2664 
sc¡_´oc_d©a
 
	gsc¡_th»ads_´oc_d©a
 = {

2665 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_th»ads_wr™e
)

2666 .
show
 = 
sc¡_th»ads_šfo_show
,

2669 
	$sc¡_scsi_tgtšfo_show
(
£q_fže
 *
£q
, *
v
)

2671 
sc¡_tgt
 *
v‰
 = 
£q
->
´iv©e
;

2672 
»s
 = 0;

2674 
	`TRACE_ENTRY
();

2676 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_´oc_mu‹x
) != 0) {

2677 
»s
 = -
EINTR
;

2678 
out
;

2681 ià(
v‰
->
tg‰
->
»ad_´oc
)

2682 
»s
 = 
v‰
->
tg‰
->
	`»ad_´oc
(
£q
, vtt);

2684 
	`mu‹x_uÆock
(&
sc¡_´oc_mu‹x
);

2685 
out
:

2686 
	`TRACE_EXIT_RES
(
»s
);

2687  
»s
;

2688 
	}
}

2690 
sc¡_´oc_d©a
 
	gsc¡_scsi_tgt_´oc_d©a
 = {

2691 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_scsi_tgt_wr™e
)

2692 .
show
 = 
sc¡_scsi_tgtšfo_show
,

2695 
	$sc¡_dev_hªdËr_šfo_show
(
£q_fže
 *
£q
, *
v
)

2697 
sc¡_dev_ty³
 *
dev_ty³
 = 
£q
->
´iv©e
;

2698 
»s
 = 0;

2700 
	`TRACE_ENTRY
();

2702 ià(
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_´oc_mu‹x
) != 0) {

2703 
»s
 = -
EINTR
;

2704 
out
;

2707 ià(
dev_ty³
->
»ad_´oc
)

2708 
»s
 = 
dev_ty³
->
	`»ad_´oc
(
£q
, dev_type);

2710 
	`mu‹x_uÆock
(&
sc¡_´oc_mu‹x
);

2712 
out
:

2713 
	`TRACE_EXIT_RES
(
»s
);

2714  
»s
;

2715 
	}
}

2717 
sc¡_´oc_d©a
 
	gsc¡_dev_hªdËr_´oc_d©a
 = {

2718 
SCST_DEF_RW_SEQ_OP
(
sc¡_´oc_scsi_dev_hªdËr_wr™e
)

2719 .
show
 = 
sc¡_dev_hªdËr_šfo_show
,

2722 
´oc_dœ_’Œy
 *
	$sc¡_ü—‹_´oc_’Œy
(
´oc_dœ_’Œy
 *
roÙ
,

2723 cÚ¡ *
Çme
, 
sc¡_´oc_d©a
 *
pd©a
)

2725 
´oc_dœ_’Œy
 *
p
 = 
NULL
;

2727 
	`TRACE_ENTRY
();

2729 ià(
roÙ
) {

2730 
mode_t
 
mode
;

2732 
mode
 = 
S_IFREG
 | 
S_IRUGO
 | (
pd©a
->
£q_Ý
.
wr™e
 ? 
S_IWUSR
 : 0);

2733 
p
 = 
	`ü—‹_´oc_’Œy
(
Çme
, 
mode
, 
roÙ
);

2734 ià(
p
 =ð
NULL
) {

2735 
	`PRINT_ERROR
("FažØü—‹ƒÁry % š /´oc", 
Çme
);

2737 
p
->
´oc_fÝs
 = &
pd©a
->
£q_Ý
;

2738 
p
->
d©a
 = 
pd©a
->data;

2742 
	`TRACE_EXIT
();

2743  
p
;

2744 
	}
}

2745 
EXPORT_SYMBOL_GPL
(
sc¡_ü—‹_´oc_’Œy
);

2747 
	$sc¡_sšgË_£q_Ý’
(
šode
 *šode, 
fže
 *file)

2749 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 23)

2750 
sc¡_´oc_d©a
 *
pd©a
 = 
	`cÚš”_of
(
	`PDE
(
šode
)->
´oc_fÝs
,

2751 
sc¡_´oc_d©a
, 
£q_Ý
);

2753 
sc¡_´oc_d©a
 *
pd©a
 = 
	`cÚš”_of
(
šode
->
i_fÝ
,

2754 
sc¡_´oc_d©a
, 
£q_Ý
);

2756  
	`sšgË_Ý’
(
fže
, 
pd©a
->
show
, 
	`PDE
(
šode
)->
d©a
);

2757 
	}
}

2758 
EXPORT_SYMBOL_GPL
(
sc¡_sšgË_£q_Ý’
);

2760 
´oc_dœ_’Œy
 *
	$sc¡_´oc_g‘_tgt_roÙ
(

2761 
sc¡_tgt_‹m¶©e
 *
v‰
)

2763  
v‰
->
´oc_tgt_roÙ
;

2764 
	}
}

2765 
EXPORT_SYMBOL_GPL
(
sc¡_´oc_g‘_tgt_roÙ
);

2767 
´oc_dœ_’Œy
 *
	$sc¡_´oc_g‘_dev_ty³_roÙ
(

2768 
sc¡_dev_ty³
 *
d‰
)

2770  
d‰
->
´oc_dev_ty³_roÙ
;

2771 
	}
}

2772 
EXPORT_SYMBOL_GPL
(
sc¡_´oc_g‘_dev_ty³_roÙ
);

	@/root/Desktop/scst-2.2.0/src/scst_sysfs.c

20 
	~<lšux/kobjeù.h
>

21 
	~<lšux/¡ršg.h
>

22 
	~<lšux/sysfs.h
>

23 
	~<lšux/moduË.h
>

24 
	~<lšux/š™.h
>

25 
	~<lšux/ùy³.h
>

26 
	~<lšux/¦ab.h
>

27 
	~<lšux/kth»ad.h
>

29 #ifdeà
INSIDE_KERNEL_TREE


30 
	~<sc¡/sc¡.h
>

32 
	~"sc¡.h
"

34 
	~"sc¡_´iv.h
"

35 
	~"sc¡_´es.h
"

37 
DECLARE_COMPLETION
(
sc¡_sysfs_roÙ_»Ëa£_com¶‘iÚ
);

39 
kobjeù
 *
	gsc¡_rg‘s_kobj
;

40 
kobjeù
 *
	gsc¡_deviûs_kobj
;

41 
kobjeù
 *
	gsc¡_hªdËrs_kobj
;

42 
kobjeù
 *
	gsc¡_deviû_groups_kobj
;

44 cÚ¡ *cÚ¡ 
	gsc¡_dev_hªdËr_ty³s
[] = {

63 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

65 
DEFINE_MUTEX
(
sc¡_log_mu‹x
);

67 
sc¡_Œaû_log
 
	gsc¡_Œaû_tbl
[] = {

68 { 
TRACE_OUT_OF_MEM
, "out_of_mem" },

69 { 
TRACE_MINOR
, "minor" },

70 { 
TRACE_SG_OP
, "sg" },

71 { 
TRACE_MEMORY
, "mem" },

72 { 
TRACE_BUFF
, "buff" },

73 #iâdeà
GENERATING_UPSTREAM_PATCH


74 { 
TRACE_ENTRYEXIT
, "entryexit" },

76 { 
TRACE_PID
, "pid" },

77 { 
TRACE_LINE
, "line" },

78 { 
TRACE_FUNCTION
, "function" },

79 { 
TRACE_DEBUG
, "debug" },

80 { 
TRACE_SPECIAL
, "special" },

81 { 
TRACE_SCSI
, "scsi" },

82 { 
TRACE_MGMT
, "mgmt" },

83 { 
TRACE_MGMT_DEBUG
, "mgmt_dbg" },

84 { 
TRACE_FLOW_CONTROL
, "flow_control" },

85 { 
TRACE_PRES
, "pr" },

86 { 0, 
NULL
 }

89 
sc¡_Œaû_log
 
	gsc¡_loÿl_Œaû_tbl
[] = {

90 { 
TRACE_RTRY
, "retry" },

91 { 
TRACE_SCSI_SERIALIZING
, "scsi_serializing" },

92 { 
TRACE_RCV_BOT
, "recv_bot" },

93 { 
TRACE_SND_BOT
, "send_bot" },

94 { 
TRACE_RCV_TOP
, "recv_top" },

95 { 
TRACE_SND_TOP
, "send_top" },

96 { 0, 
NULL
 }

100 
	$sc¡_»ad_Œaû_tbl
(cÚ¡ 
sc¡_Œaû_log
 *
tbl
, *
buf
,

101 
log_Ëv–
, *
pos
)

103 cÚ¡ 
sc¡_Œaû_log
 *
t
 = 
tbl
;

105 ià(
t
 =ð
NULL
)

106 
out
;

108 
t
->
tok’
) {

109 ià(
log_Ëv–
 & 
t
->
v®
) {

110 *
pos
 +ð
	`¥rštf
(&
buf
[*pos], "%s%s",

111 (*
pos
 == 0) ? "" : " | ",

112 
t
->
tok’
);

114 
t
++;

116 
out
:

118 
	}
}

120 
ssize_t
 
	$sc¡_Œaû_Ëv–_show
(cÚ¡ 
sc¡_Œaû_log
 *
loÿl_tbl
,

121 
log_Ëv–
, *
buf
, cÚ¡ *
h–p
)

123 
pos
 = 0;

125 
	`sc¡_»ad_Œaû_tbl
(
sc¡_Œaû_tbl
, 
buf
, 
log_Ëv–
, &
pos
);

126 
	`sc¡_»ad_Œaû_tbl
(
loÿl_tbl
, 
buf
, 
log_Ëv–
, &
pos
);

128 
pos
 +ð
	`¥rštf
(&
buf
[pos], "\n\n\nUsage:\n"

133 #iâdeà
GENERATING_UPSTREAM_PATCH


141 " s’d_tÝ%s]\n", 
h–p
 !ð
NULL
 ? help : "");

143  
pos
;

144 
	}
}

146 
	$sc¡_wr™e_Œaû
(cÚ¡ *
buf
, 
size_t
 
Ëngth
,

147 *
log_Ëv–
, 
deçuÉ_Ëv–
,

148 cÚ¡ *
Çme
, cÚ¡ 
sc¡_Œaû_log
 *
tbl
)

150 
»s
 = 
Ëngth
;

151 
aùiÚ
;

152 
Ëv–
 = 0, 
ÞdËv–
;

153 *
bufãr
, *
p
, *
e
;

154 cÚ¡ 
sc¡_Œaû_log
 *
t
;

156 
SCST_TRACE_ACTION_ALL
 = 1,

157 
SCST_TRACE_ACTION_NONE
 = 2,

158 
SCST_TRACE_ACTION_DEFAULT
 = 3,

159 
SCST_TRACE_ACTION_ADD
 = 4,

160 
SCST_TRACE_ACTION_DEL
 = 5,

161 
SCST_TRACE_ACTION_VALUE
 = 6,

164 
	`TRACE_ENTRY
();

166 ià((
buf
 =ð
NULL
è|| (
Ëngth
 == 0)) {

167 
»s
 = -
EINVAL
;

168 
out
;

171 
bufãr
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
Ëngth
, 
buf
);

172 ià(
bufãr
 =ð
NULL
) {

173 
	`PRINT_ERROR
("Unableo‡lloc intermediate buffer (size %zd)",

174 
Ëngth
+1);

175 
»s
 = -
ENOMEM
;

176 
out
;

179 
	`TRACE_DBG
("bufã¸%s", 
bufãr
);

181 
p
 = 
bufãr
;

182 ià(!
	`¡ºÿ£cmp
("®l", 
p
, 3)) {

183 
aùiÚ
 = 
SCST_TRACE_ACTION_ALL
;

184 } ià(!
	`¡ºÿ£cmp
("nÚe", 
p
, 4) || !strncasecmp("null",…, 4)) {

185 
aùiÚ
 = 
SCST_TRACE_ACTION_NONE
;

186 } ià(!
	`¡ºÿ£cmp
("deçuÉ", 
p
, 7)) {

187 
aùiÚ
 = 
SCST_TRACE_ACTION_DEFAULT
;

188 } ià(!
	`¡ºÿ£cmp
("add", 
p
, 3)) {

189 
p
 += 3;

190 
aùiÚ
 = 
SCST_TRACE_ACTION_ADD
;

191 } ià(!
	`¡ºÿ£cmp
("d–", 
p
, 3)) {

192 
p
 += 3;

193 
aùiÚ
 = 
SCST_TRACE_ACTION_DEL
;

194 } ià(!
	`¡ºÿ£cmp
("v®ue", 
p
, 5)) {

195 
p
 += 5;

196 
aùiÚ
 = 
SCST_TRACE_ACTION_VALUE
;

198 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

199 
p
[
	`¡¾’
(p) - 1] = '\0';

200 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

201 
»s
 = -
EINVAL
;

202 
out_ä“
;

205 
aùiÚ
) {

206 
SCST_TRACE_ACTION_ADD
:

207 
SCST_TRACE_ACTION_DEL
:

208 
SCST_TRACE_ACTION_VALUE
:

209 ià(!
	`is¥aû
(*
p
)) {

210 
	`PRINT_ERROR
("%s", "Syntaxƒrror");

211 
»s
 = -
EINVAL
;

212 
out_ä“
;

216 
aùiÚ
) {

217 
SCST_TRACE_ACTION_ALL
:

218 
Ëv–
 = 
TRACE_ALL
;

220 
SCST_TRACE_ACTION_DEFAULT
:

221 
Ëv–
 = 
deçuÉ_Ëv–
;

223 
SCST_TRACE_ACTION_NONE
:

224 
Ëv–
 = 
TRACE_NULL
;

226 
SCST_TRACE_ACTION_ADD
:

227 
SCST_TRACE_ACTION_DEL
:

228 
	`is¥aû
(*
p
) && *p != '\0')

229 
p
++;

230 
e
 = 
p
;

231 !
	`is¥aû
(*
e
) && *e != '\0')

232 
e
++;

233 *
e
 = 0;

234 ià(
tbl
) {

235 
t
 = 
tbl
;

236 
t
->
tok’
) {

237 ià(!
	`¡rÿ£cmp
(
p
, 
t
->
tok’
)) {

238 
Ëv–
 = 
t
->
v®
;

241 
t
++;

244 ià(
Ëv–
 == 0) {

245 
t
 = 
sc¡_Œaû_tbl
;

246 
t
->
tok’
) {

247 ià(!
	`¡rÿ£cmp
(
p
, 
t
->
tok’
)) {

248 
Ëv–
 = 
t
->
v®
;

251 
t
++;

254 ià(
Ëv–
 == 0) {

255 
	`PRINT_ERROR
("UnknowÀtok’ \"%s\"", 
p
);

256 
»s
 = -
EINVAL
;

257 
out_ä“
;

260 
SCST_TRACE_ACTION_VALUE
:

261 
	`is¥aû
(*
p
) && *p != '\0')

262 
p
++;

263 
»s
 = 
	`¡riù_¡¹oul
(
p
, 0, &
Ëv–
);

264 ià(
»s
 != 0) {

265 
	`PRINT_ERROR
("Inv®id¿û v®u\"%s\"", 
p
);

266 
»s
 = -
EINVAL
;

267 
out_ä“
;

272 
ÞdËv–
 = *
log_Ëv–
;

274 
aùiÚ
) {

275 
SCST_TRACE_ACTION_ADD
:

276 *
log_Ëv–
 |ð
Ëv–
;

278 
SCST_TRACE_ACTION_DEL
:

279 *
log_Ëv–
 &ð~
Ëv–
;

282 *
log_Ëv–
 = 
Ëv–
;

286 
	`PRINT_INFO
("Changedrace†evel for \"%s\": old 0x%08lx,‚ew 0x%08lx",

287 
Çme
, 
ÞdËv–
, *
log_Ëv–
);

289 
out_ä“
:

290 
	`kä“
(
bufãr
);

291 
out
:

292 
	`TRACE_EXIT_RES
(
»s
);

293  
»s
;

294 
	}
}

298 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 34)

303 
	$sysfs_ü—‹_fžes
(
kobjeù
 *
kobj
,

304 cÚ¡ 
©Œibu‹
 **
±r
)

306 
”r
 = 0;

307 
i
;

309 
i
 = 0; 
±r
[i] && !
”r
; i++)

310 
”r
 = 
	`sysfs_ü—‹_fže
(
kobj
, 
±r
[
i
]);

311 ià(
”r
)

312 --
i
 >= 0)

313 
	`sysfs_»move_fže
(
kobj
, 
±r
[
i
]);

314  
”r
;

315 
	}
}

317 
	$sysfs_»move_fžes
(
kobjeù
 *
kobj
,

318 cÚ¡ 
©Œibu‹
 **
±r
)

320 
i
;

322 
i
 = 0; 
±r
[i]; i++)

323 
	`sysfs_»move_fže
(
kobj
, 
±r
[
i
]);

324 
	}
}

331 
DEFINE_SPINLOCK
(
sysfs_wÜk_lock
);

332 
LIST_HEAD
(
sysfs_wÜk_li¡
);

333 
DECLARE_WAIT_QUEUE_HEAD
(
sysfs_wÜk_wa™Q
);

334 
	gaùive_sysfs_wÜks
;

335 
	gÏ¡_sysfs_wÜk_»s
;

336 
sk_¡ruù
 *
	gsysfs_wÜk_th»ad
;

341 
sc¡_®loc_sysfs_wÜk
((*
sysfs_wÜk_â
)(
sc¡_sysfs_wÜk_™em
 *),

342 
boÞ
 
»ad_Úly_aùiÚ
, 
sc¡_sysfs_wÜk_™em
 **
»s_wÜk
)

344 
»s
 = 0;

345 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

347 
	`TRACE_ENTRY
();

349 ià(
sysfs_wÜk_â
 =ð
NULL
) {

350 
	`PRINT_ERROR
("%s", "sysfs_work_fn is NULL");

351 
»s
 = -
EINVAL
;

352 
out
;

355 *
»s_wÜk
 = 
NULL
;

357 
wÜk
 = 
	`kz®loc
((*wÜk), 
GFP_KERNEL
);

358 ià(
wÜk
 =ð
NULL
) {

359 
	`PRINT_ERROR
("Unableo‡lloc sysfs work (size %zd)",

360 (*
wÜk
));

361 
»s
 = -
ENOMEM
;

362 
out
;

365 
wÜk
->
»ad_Úly_aùiÚ
 =„ead_only_action;

366 
	`k»f_š™
(&
wÜk
->
sysfs_wÜk_k»f
);

367 
	`š™_com¶‘iÚ
(&
wÜk
->
sysfs_wÜk_dÚe
);

368 
wÜk
->
sysfs_wÜk_â
 = sysfs_work_fn;

370 *
»s_wÜk
 = 
wÜk
;

372 
out
:

373 
	`TRACE_EXIT_RES
(
»s
);

374  
»s
;

375 
	}
}

376 
EXPORT_SYMBOL
(
sc¡_®loc_sysfs_wÜk
);

378 
	$sc¡_sysfs_wÜk_»Ëa£
(
k»f
 *kref)

380 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

382 
	`TRACE_ENTRY
();

384 
wÜk
 = 
	`cÚš”_of
(
k»f
, 
sc¡_sysfs_wÜk_™em
,

385 
sysfs_wÜk_k»f
);

387 
	`TRACE_DBG
("F»ešg sysf wÜk %°(buà%p)", 
wÜk
, wÜk->
buf
);

389 
	`kä“
(
wÜk
->
buf
);

390 
	`kä“
(
wÜk
->
»s_buf
);

391 
	`kä“
(
wÜk
);

393 
	`TRACE_EXIT
();

395 
	}
}

400 
	$sc¡_sysfs_wÜk_g‘
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

402 
	`k»f_g‘
(&
wÜk
->
sysfs_wÜk_k»f
);

403 
	}
}

404 
EXPORT_SYMBOL
(
sc¡_sysfs_wÜk_g‘
);

409 
	$sc¡_sysfs_wÜk_put
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

411 
	`k»f_put
(&
wÜk
->
sysfs_wÜk_k»f
, 
sc¡_sysfs_wÜk_»Ëa£
);

412 
	}
}

413 
EXPORT_SYMBOL
(
sc¡_sysfs_wÜk_put
);

416 
	$sc¡_´oûss_sysfs_wÜks
()

417 
	$__»Ëa£s
(&
sysfs_wÜk_lock
)

418 
	$__acquœes
(&
sysfs_wÜk_lock
)

420 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

422 
	`TRACE_ENTRY
();

424 !
	`li¡_em±y
(&
sysfs_wÜk_li¡
)) {

425 
wÜk
 = 
	`li¡_’Œy
(
sysfs_wÜk_li¡
.
Ãxt
,

426 
sc¡_sysfs_wÜk_™em
, 
sysfs_wÜk_li¡_’Œy
);

427 
	`li¡_d–
(&
wÜk
->
sysfs_wÜk_li¡_’Œy
);

428 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

430 
	`TRACE_DBG
("Sysf wÜk %p", 
wÜk
);

432 
wÜk
->
wÜk_»s
 = wÜk->
	`sysfs_wÜk_â
(work);

434 
	`¥š_lock
(&
sysfs_wÜk_lock
);

435 ià(!
wÜk
->
»ad_Úly_aùiÚ
)

436 
Ï¡_sysfs_wÜk_»s
 = 
wÜk
->
wÜk_»s
;

437 
aùive_sysfs_wÜks
--;

438 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

440 
	`com¶‘e_®l
(&
wÜk
->
sysfs_wÜk_dÚe
);

441 
	`k»f_put
(&
wÜk
->
sysfs_wÜk_k»f
, 
sc¡_sysfs_wÜk_»Ëa£
);

443 
	`¥š_lock
(&
sysfs_wÜk_lock
);

446 
	`TRACE_EXIT
();

448 
	}
}

450 
šlše
 
	$‹¡_sysfs_wÜk_li¡
()

452 
»s
 = !
	`li¡_em±y
(&
sysfs_wÜk_li¡
) ||

453 
	`uÆik–y
(
	`kth»ad_should_¡Ý
());

454  
»s
;

455 
	}
}

457 
	$sysfs_wÜk_th»ad_â
(*
¬g
)

459 
boÞ
 
Úe_time_Úly
 = (boÞ)
¬g
;

461 
	`TRACE_ENTRY
();

463 ià(!
Úe_time_Úly
)

464 
	`PRINT_INFO
("U£¸š‹rçûh»ad s¹ed, PID %d", 
cu¼’t
->
pid
);

466 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

468 
	`£t_u£r_niû
(
cu¼’t
, -10);

470 
	`¥š_lock
(&
sysfs_wÜk_lock
);

471 !
	`kth»ad_should_¡Ý
()) {

472 
wa™_queue_t
 
wa™
;

473 
	`š™_wa™queue_’Œy
(&
wa™
, 
cu¼’t
);

475 ià(
Úe_time_Úly
 && !
	`‹¡_sysfs_wÜk_li¡
())

478 ià(!
	`‹¡_sysfs_wÜk_li¡
()) {

479 
	`add_wa™_queue_exþusive
(&
sysfs_wÜk_wa™Q
, &
wa™
);

481 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

482 ià(
	`‹¡_sysfs_wÜk_li¡
())

484 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

485 
	`scheduË
();

486 
	`¥š_lock
(&
sysfs_wÜk_lock
);

488 
	`£t_cu¼’t_¡©e
(
TASK_RUNNING
);

489 
	`»move_wa™_queue
(&
sysfs_wÜk_wa™Q
, &
wa™
);

492 
	`sc¡_´oûss_sysfs_wÜks
();

494 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

496 ià(!
Úe_time_Úly
) {

501 
	`sBUG_ON
(!
	`li¡_em±y
(&
sysfs_wÜk_li¡
));

503 
	`PRINT_INFO
("U£¸š‹rçûh»ad PID %d fšished", 
cu¼’t
->
pid
);

506 
	`TRACE_EXIT
();

508 
	}
}

517 
	$sc¡_sysfs_queue_wa™_wÜk
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

519 
»s
 = 0, 
rc
;

520 
timeout
 = 15*
HZ
;

521 
sk_¡ruù
 *
t
;

522 
©omic_t
 
uid_th»ad_Çme
 = 
	`ATOMIC_INIT
(0);

524 
	`TRACE_ENTRY
();

526 
	`¥š_lock
(&
sysfs_wÜk_lock
);

528 
	`TRACE_DBG
("Addšg sysf wÜk %°tØthli¡", 
wÜk
);

529 
	`li¡_add_ž
(&
wÜk
->
sysfs_wÜk_li¡_’Œy
, &
sysfs_wÜk_li¡
);

531 
aùive_sysfs_wÜks
++;

533 
	`k»f_g‘
(&
wÜk
->
sysfs_wÜk_k»f
);

535 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

537 
	`wake_up
(&
sysfs_wÜk_wa™Q
);

553 
t
 = 
	`kth»ad_run
(
sysfs_wÜk_th»ad_â
, (*)
Œue
, "scst_uid%d",

554 
	`©omic_šc_»tuº
(&
uid_th»ad_Çme
));

555 ià(
	`IS_ERR
(
t
))

556 
	`PRINT_ERROR
("kthread_run() for user interfacehread %d "

557 "çžed: %d", 
	`©omic_»ad
(&
uid_th»ad_Çme
),

558 ()
	`PTR_ERR
(
t
));

561 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(

562 &
wÜk
->
sysfs_wÜk_dÚe
, 
timeout
);

563 ià(
rc
 == 0) {

564 ià(!
	`mu‹x_is_locked
(&
sc¡_mu‹x
)) {

565 
	`TRACE_DBG
("scst_mutex‚ot†ocked, continue "

566 "wa™šg (wÜk %p)", 
wÜk
);

567 
timeout
 = 5*
HZ
;

570 
	`TRACE_MGMT_DBG
("Timouˆwa™šg fÜ wÜk %p", 
wÜk
);

571 
»s
 = -
EAGAIN
;

572 
out_put
;

573 } ià(
rc
 < 0) {

574 
»s
 = 
rc
;

575 
out_put
;

580 
»s
 = 
wÜk
->
wÜk_»s
;

582 
out_put
:

583 
	`k»f_put
(&
wÜk
->
sysfs_wÜk_k»f
, 
sc¡_sysfs_wÜk_»Ëa£
);

585 
	`TRACE_EXIT_RES
(
»s
);

586  
»s
;

587 
	}
}

588 
EXPORT_SYMBOL
(
sc¡_sysfs_queue_wa™_wÜk
);

591 
	$sc¡_check_g¿b_tg‰_±r
(
sc¡_tgt_‹m¶©e
 *
tg‰
)

593 
»s
 = 0;

594 
sc¡_tgt_‹m¶©e
 *
‰
;

596 
	`TRACE_ENTRY
();

598 
	`mu‹x_lock
(&
sc¡_mu‹x
);

600 
	`li¡_fÜ_—ch_’Œy
(
‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

601 ià(
‰
 =ð
tg‰
) {

602 
tg‰
->
tg‰_aùive_sysfs_wÜks_couÁ
++;

603 
out_uÆock
;

607 
	`TRACE_DBG
("Tg‰ %°nÙ found", 
tg‰
);

608 
»s
 = -
ENOENT
;

610 
out_uÆock
:

611 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

613 
	`TRACE_EXIT_RES
(
»s
);

614  
»s
;

615 
	}
}

618 
	$sc¡_ung¿b_tg‰_±r
(
sc¡_tgt_‹m¶©e
 *
tg‰
)

620 
	`TRACE_ENTRY
();

622 
	`mu‹x_lock
(&
sc¡_mu‹x
);

623 
tg‰
->
tg‰_aùive_sysfs_wÜks_couÁ
--;

624 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

626 
	`TRACE_EXIT
();

628 
	}
}

631 
	$sc¡_check_tgt_acg_±rs
(
sc¡_tgt
 *
tgt
, 
sc¡_acg
 *
acg
)

633 
»s
 = 0;

634 
sc¡_tgt_‹m¶©e
 *
tg‰
;

636 
	`li¡_fÜ_—ch_’Œy
(
tg‰
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
) {

637 
sc¡_tgt
 *
t
;

638 
	`li¡_fÜ_—ch_’Œy
(
t
, &
tg‰
->
tgt_li¡
, 
tgt_li¡_’Œy
) {

639 ià(
t
 =ð
tgt
) {

640 
sc¡_acg
 *
a
;

641 ià(
acg
 =ð
NULL
)

642 
out
;

643 ià(
acg
 =ð
tgt
->
deçuÉ_acg
)

644 
out
;

645 
	`li¡_fÜ_—ch_’Œy
(
a
, &
tgt
->
tgt_acg_li¡
,

646 
acg_li¡_’Œy
) {

647 ià(
a
 =ð
acg
)

648 
out
;

654 
	`TRACE_DBG
("Tgˆ%p/ACG %°nÙ found", 
tgt
, 
acg
);

655 
»s
 = -
ENOENT
;

657 
out
:

658 
	`TRACE_EXIT_RES
(
»s
);

659  
»s
;

660 
	}
}

663 
	$sc¡_check_devt_±r
(
sc¡_dev_ty³
 *
devt
,

664 
li¡_h—d
 *
li¡
)

666 
»s
 = 0;

667 
sc¡_dev_ty³
 *
dt
;

669 
	`TRACE_ENTRY
();

671 
	`li¡_fÜ_—ch_’Œy
(
dt
, 
li¡
, 
dev_ty³_li¡_’Œy
) {

672 ià(
dt
 =ð
devt
)

673 
out
;

676 
	`TRACE_DBG
("Devˆ%°nÙ found", 
devt
);

677 
»s
 = -
ENOENT
;

679 
out
:

680 
	`TRACE_EXIT_RES
(
»s
);

681  
»s
;

682 
	}
}

685 
	$sc¡_check_dev_±r
(
sc¡_deviû
 *
dev
)

687 
»s
 = 0;

688 
sc¡_deviû
 *
d
;

690 
	`TRACE_ENTRY
();

692 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

693 ià(
d
 =ð
dev
)

694 
out
;

697 
	`TRACE_DBG
("Dev %°nÙ found", 
dev
);

698 
»s
 = -
ENOENT
;

700 
out
:

701 
	`TRACE_EXIT_RES
(
»s
);

702  
»s
;

703 
	}
}

706 
	$sc¡_check_g¿b_devt_±r
(
sc¡_dev_ty³
 *
devt
,

707 
li¡_h—d
 *
li¡
)

709 
»s
 = 0;

710 
sc¡_dev_ty³
 *
dt
;

712 
	`TRACE_ENTRY
();

714 
	`mu‹x_lock
(&
sc¡_mu‹x
);

716 
	`li¡_fÜ_—ch_’Œy
(
dt
, 
li¡
, 
dev_ty³_li¡_’Œy
) {

717 ià(
dt
 =ð
devt
) {

718 
devt
->
devt_aùive_sysfs_wÜks_couÁ
++;

719 
out_uÆock
;

723 
	`TRACE_DBG
("Devˆ%°nÙ found", 
devt
);

724 
»s
 = -
ENOENT
;

726 
out_uÆock
:

727 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

729 
	`TRACE_EXIT_RES
(
»s
);

730  
»s
;

731 
	}
}

734 
	$sc¡_ung¿b_devt_±r
(
sc¡_dev_ty³
 *
devt
)

736 
	`TRACE_ENTRY
();

738 
	`mu‹x_lock
(&
sc¡_mu‹x
);

739 
devt
->
devt_aùive_sysfs_wÜks_couÁ
--;

740 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

742 
	`TRACE_EXIT
();

744 
	}
}

749 
ssize_t
 
	$sc¡_show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

750 *
buf
)

752 
kobj_©Œibu‹
 *
kobj_©Œ
;

753 
kobj_©Œ
 = 
	`cÚš”_of
(
©Œ
, 
kobj_©Œibu‹
,‡ttr);

755  
kobj_©Œ
->
	`show
(
kobj
, kobj_©Œ, 
buf
);

756 
	}
}

758 
ssize_t
 
	$sc¡_¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
,

759 cÚ¡ *
buf
, 
size_t
 
couÁ
)

761 
kobj_©Œibu‹
 *
kobj_©Œ
;

762 
kobj_©Œ
 = 
	`cÚš”_of
(
©Œ
, 
kobj_©Œibu‹
,‡ttr);

764 ià(
kobj_©Œ
->
¡Üe
)

765  
kobj_©Œ
->
	`¡Üe
(
kobj
, kobj_©Œ, 
buf
, 
couÁ
);

767  -
EIO
;

768 
	}
}

770 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 34))

771 cÚ¡ 
sysfs_Ýs
 
	gsc¡_sysfs_Ýs
 = {

773 
sysfs_Ýs
 
sc¡_sysfs_Ýs
 = {

775 .
show
 = 
sc¡_show
,

776 .
	g¡Üe
 = 
sc¡_¡Üe
,

779 #ià(
LINUX_VERSION_CODE
 >ð
KERNEL_VERSION
(2, 6, 34))

780 cÚ¡ 
sysfs_Ýs
 *
	$sc¡_sysfs_g‘_sysfs_Ýs
()

782 
sysfs_Ýs
 *
	$sc¡_sysfs_g‘_sysfs_Ýs
()

785  &
sc¡_sysfs_Ýs
;

786 
	}
}

787 
EXPORT_SYMBOL_GPL
(
sc¡_sysfs_g‘_sysfs_Ýs
);

793 
	$sc¡_tg‰_»Ëa£
(
kobjeù
 *
kobj
)

795 
sc¡_tgt_‹m¶©e
 *
tg‰
;

797 
	`TRACE_ENTRY
();

799 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

800 ià(
tg‰
->
tg‰_kobj_»Ëa£_cm¶
)

801 
	`com¶‘e_®l
(
tg‰
->
tg‰_kobj_»Ëa£_cm¶
);

803 
	`TRACE_EXIT
();

805 
	}
}

807 
kobj_ty³
 
	gtg‰_kty³
 = {

808 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

809 .
	g»Ëa£
 = 
sc¡_tg‰_»Ëa£
,

812 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

814 
ssize_t
 
	$sc¡_tg‰_Œaû_Ëv–_show
(
kobjeù
 *
kobj
,

815 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

817 
sc¡_tgt_‹m¶©e
 *
tg‰
;

819 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

821  
	`sc¡_Œaû_Ëv–_show
(
tg‰
->
Œaû_tbl
,

822 
tg‰
->
Œaû_æags
 ? *tg‰->Œaû_æag : 0, 
buf
,

823 
tg‰
->
Œaû_tbl_h–p
);

824 
	}
}

826 
ssize_t
 
	$sc¡_tg‰_Œaû_Ëv–_¡Üe
(
kobjeù
 *
kobj
,

827 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

829 
»s
;

830 
sc¡_tgt_‹m¶©e
 *
tg‰
;

832 
	`TRACE_ENTRY
();

834 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

836 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_log_mu‹x
);

837 ià(
»s
 != 0)

838 
out
;

840 
»s
 = 
	`sc¡_wr™e_Œaû
(
buf
, 
couÁ
, 
tg‰
->
Œaû_æags
,

841 
tg‰
->
deçuÉ_Œaû_æags
,g‰->
Çme
,g‰->
Œaû_tbl
);

843 
	`mu‹x_uÆock
(&
sc¡_log_mu‹x
);

845 
out
:

846 
	`TRACE_EXIT_RES
(
»s
);

847  
»s
;

848 
	}
}

850 
kobj_©Œibu‹
 
	gtg‰_Œaû_©Œ
 =

851 
__ATTR
(
Œaû_Ëv–
, 
S_IRUGO
 | 
S_IWUSR
,

852 
sc¡_tg‰_Œaû_Ëv–_show
, 
sc¡_tg‰_Œaû_Ëv–_¡Üe
);

856 
ssize_t
 
	$sc¡_tg‰_mgmt_show
(
kobjeù
 *
kobj
,

857 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

859 cÚ¡ 
h–p
[] =

868 
sc¡_tgt_‹m¶©e
 *
tg‰
;

870 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

872  
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, 
h–p
,

873 (
tg‰
->
tg‰_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

876 (
tg‰
->
tgt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

879 (
tg‰
->
mgmt_cmd_h–p
) ?gtt->mgmt_cmd_help : "",

880 (
tg‰
->
add_rg‘_·¿m‘”s
 !ð
NULL
) ?

882 (
tg‰
->
add_rg‘_·¿m‘”s
 !ð
NULL
) ?

883 
tg‰
->
add_rg‘_·¿m‘”s
 : "",

884 (
tg‰
->
tg‰_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

886 (
tg‰
->
tg‰_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

887 
tg‰
->
tg‰_ÝtiÚ®_©Œibu‹s
 : "",

888 (
tg‰
->
tg‰_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ? "\n" : "",

889 (
tg‰
->
tgt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

891 (
tg‰
->
tgt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

892 
tg‰
->
tgt_ÝtiÚ®_©Œibu‹s
 : "",

893 (
tg‰
->
tgt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ? "\n" : "");

894 
	}
}

896 
	$sc¡_´oûss_tg‰_mgmt_¡Üe
(*
bufãr
,

897 
sc¡_tgt_‹m¶©e
 *
tg‰
)

899 
»s
 = 0;

900 *
p
, *
µ
, *
rg‘_Çme
;

902 
	`TRACE_ENTRY
();

904 
	`TRACE_DBG
("bufã¸%s", 
bufãr
);

907 ià(
	`sc¡_check_g¿b_tg‰_±r
(
tg‰
) != 0)

908 
out
;

910 
µ
 = 
bufãr
;

911 ià(
µ
[
	`¡¾’
(pp) - 1] == '\n')

912 
µ
[
	`¡¾’
(pp) - 1] = '\0';

914 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

916 ià(
	`¡rÿ£cmp
("add_rg‘", 
p
) == 0) {

917 
rg‘_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

918 ià(*
rg‘_Çme
 == '\0') {

919 
	`PRINT_ERROR
("%s", "Target‚ame„equired");

920 
»s
 = -
EINVAL
;

921 
out_ung¿b
;

923 
»s
 = 
tg‰
->
	`add_rg‘
(
rg‘_Çme
, 
µ
);

924 } ià(
	`¡rÿ£cmp
("d–_rg‘", 
p
) == 0) {

925 
rg‘_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

926 ià(*
rg‘_Çme
 == '\0') {

927 
	`PRINT_ERROR
("%s", "Target‚ame„equired");

928 
»s
 = -
EINVAL
;

929 
out_ung¿b
;

932 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

933 ià(*
p
 != '\0')

934 
out_syÁax_”r
;

936 
»s
 = 
tg‰
->
	`d–_rg‘
(
rg‘_Çme
);

937 } ià(
tg‰
->
mgmt_cmd
 !ð
NULL
) {

938 
	`sc¡_»¡Üe_tok’_¡r
(
p
, 
µ
);

939 
»s
 = 
tg‰
->
	`mgmt_cmd
(
bufãr
);

941 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

942 
»s
 = -
EINVAL
;

943 
out_ung¿b
;

946 
out_ung¿b
:

947 
	`sc¡_ung¿b_tg‰_±r
(
tg‰
);

949 
out
:

950 
	`TRACE_EXIT_RES
(
»s
);

951  
»s
;

953 
out_syÁax_”r
:

954 
	`PRINT_ERROR
("SyÁaxƒ¼Ü oÀ\"%s\"", 
p
);

955 
»s
 = -
EINVAL
;

956 
out_ung¿b
;

957 
	}
}

959 
	$sc¡_tg‰_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

961  
	`sc¡_´oûss_tg‰_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
tg‰
);

962 
	}
}

964 
ssize_t
 
	$sc¡_tg‰_mgmt_¡Üe
(
kobjeù
 *
kobj
,

965 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

967 
»s
;

968 *
bufãr
;

969 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

970 
sc¡_tgt_‹m¶©e
 *
tg‰
;

972 
	`TRACE_ENTRY
();

974 
tg‰
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_‹m¶©e
, 
tg‰_kobj
);

976 
bufãr
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

977 ià(
bufãr
 =ð
NULL
) {

978 
»s
 = -
ENOMEM
;

979 
out
;

982 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_tg‰_mgmt_¡Üe_wÜk_â
, 
çl£
, &
wÜk
);

983 ià(
»s
 != 0)

984 
out_ä“
;

986 
wÜk
->
buf
 = 
bufãr
;

987 
wÜk
->
tg‰
 =gtt;

989 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

990 ià(
»s
 == 0)

991 
»s
 = 
couÁ
;

993 
out
:

994 
	`TRACE_EXIT_RES
(
»s
);

995  
»s
;

997 
out_ä“
:

998 
	`kä“
(
bufãr
);

999 
out
;

1000 
	}
}

1002 
kobj_©Œibu‹
 
	gsc¡_tg‰_mgmt
 =

1003 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg‰_mgmt_show
,

1004 
sc¡_tg‰_mgmt_¡Üe
);

1006 
	$sc¡_tg‰_sysfs_ü—‹
(
sc¡_tgt_‹m¶©e
 *
tg‰
)

1008 
»s
 = 0;

1010 
	`TRACE_ENTRY
();

1012 
»s
 = 
	`kobjeù_š™_ªd_add
(&
tg‰
->
tg‰_kobj
, &
tg‰_kty³
,

1013 
sc¡_rg‘s_kobj
, 
tg‰
->
Çme
);

1014 ià(
»s
 != 0) {

1015 
	`PRINT_ERROR
("Cª'ˆaddg‰ % tØsysfs", 
tg‰
->
Çme
);

1016 
out
;

1019 ià(
tg‰
->
add_rg‘
 !ð
NULL
) {

1020 
»s
 = 
	`sysfs_ü—‹_fže
(&
tg‰
->
tg‰_kobj
,

1021 &
sc¡_tg‰_mgmt
.
©Œ
);

1022 ià(
»s
 != 0) {

1023 
	`PRINT_ERROR
("Can't‡dd mgmt‡ttr forarget driver %s",

1024 
tg‰
->
Çme
);

1025 
out_d–
;

1029 ià(
tg‰
->
tg‰_©Œs
) {

1030 
»s
 = 
	`sysfs_ü—‹_fžes
(&
tg‰
->
tg‰_kobj
,g‰->
tg‰_©Œs
);

1031 ià(
»s
 != 0) {

1032 
	`PRINT_ERROR
("Can't‡dd‡ttributes forarget "

1033 "driv” %s", 
tg‰
->
Çme
);

1034 
out_d–
;

1038 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

1039 ià(
tg‰
->
Œaû_æags
 !ð
NULL
) {

1040 
»s
 = 
	`sysfs_ü—‹_fže
(&
tg‰
->
tg‰_kobj
,

1041 &
tg‰_Œaû_©Œ
.
©Œ
);

1042 ià(
»s
 != 0) {

1043 
	`PRINT_ERROR
("Can't‡ddrace_flag forarget "

1044 "driv” %s", 
tg‰
->
Çme
);

1045 
out_d–
;

1050 
out
:

1051 
	`TRACE_EXIT_RES
(
»s
);

1052  
»s
;

1054 
out_d–
:

1055 
	`sc¡_tg‰_sysfs_d–
(
tg‰
);

1056 
out
;

1057 
	}
}

1064 
	$sc¡_tg‰_sysfs_d–
(
sc¡_tgt_‹m¶©e
 *
tg‰
)

1066 
rc
;

1067 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

1069 
	`TRACE_ENTRY
();

1071 
tg‰
->
tg‰_kobj_»Ëa£_cm¶
 = &
c
;

1073 
	`kobjeù_d–
(&
tg‰
->
tg‰_kobj
);

1074 
	`kobjeù_put
(&
tg‰
->
tg‰_kobj
);

1076 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(
tg‰
->
tg‰_kobj_»Ëa£_cm¶
, 
HZ
);

1077 ià(
rc
 == 0) {

1078 
	`PRINT_INFO
("Waiting for„eleasing sysfsƒntry "

1079 "fÜ¬g‘em¶©% (%d„efs)...", 
tg‰
->
Çme
,

1080 
	`©omic_»ad
(&
tg‰
->
tg‰_kobj
.
k»f
.
»fcouÁ
));

1081 
	`wa™_fÜ_com¶‘iÚ
(
tg‰
->
tg‰_kobj_»Ëa£_cm¶
);

1082 
	`PRINT_INFO
("Done waiting for„eleasing sysfs "

1083 "’Œy fÜ¬g‘em¶©%s", 
tg‰
->
Çme
);

1086 
	`TRACE_EXIT
();

1088 
	}
}

1094 
	$sc¡_tgt_»Ëa£
(
kobjeù
 *
kobj
)

1096 
sc¡_tgt
 *
tgt
;

1098 
	`TRACE_ENTRY
();

1100 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1101 ià(
tgt
->
tgt_kobj_»Ëa£_cm¶
)

1102 
	`com¶‘e_®l
(
tgt
->
tgt_kobj_»Ëa£_cm¶
);

1104 
	`TRACE_EXIT
();

1106 
	}
}

1108 
kobj_ty³
 
	gtgt_kty³
 = {

1109 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

1110 .
	g»Ëa£
 = 
sc¡_tgt_»Ëa£
,

1113 
	$__sc¡_´oûss_luns_mgmt_¡Üe
(*
bufãr
,

1114 
sc¡_tgt
 *
tgt
, 
sc¡_acg
 *
acg
, 
boÞ
 
tgt_kobj
)

1116 
»s
, 
»ad_Úly
 = 0, 
aùiÚ
;

1117 *
p
, *
e
 = 
NULL
;

1118 
vœt_lun
;

1119 
sc¡_acg_dev
 *
acg_dev
 = 
NULL
, *
acg_dev_tmp
;

1120 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

1122 
SCST_LUN_ACTION_ADD
 = 1,

1123 
SCST_LUN_ACTION_DEL
 = 2,

1124 
SCST_LUN_ACTION_REPLACE
 = 3,

1125 
SCST_LUN_ACTION_CLEAR
 = 4,

1128 
	`TRACE_ENTRY
();

1130 
	`TRACE_DBG
("bufã¸%s", 
bufãr
);

1132 
p
 = 
bufãr
;

1133 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

1134 
p
[
	`¡¾’
(p) - 1] = '\0';

1135 ià(
	`¡ºÿ£cmp
("add", 
p
, 3) == 0) {

1136 
p
 += 3;

1137 
aùiÚ
 = 
SCST_LUN_ACTION_ADD
;

1138 } ià(
	`¡ºÿ£cmp
("d–", 
p
, 3) == 0) {

1139 
p
 += 3;

1140 
aùiÚ
 = 
SCST_LUN_ACTION_DEL
;

1141 } ià(!
	`¡ºÿ£cmp
("»¶aû", 
p
, 7)) {

1142 
p
 += 7;

1143 
aùiÚ
 = 
SCST_LUN_ACTION_REPLACE
;

1144 } ià(!
	`¡ºÿ£cmp
("þ—r", 
p
, 5)) {

1145 
p
 += 5;

1146 
aùiÚ
 = 
SCST_LUN_ACTION_CLEAR
;

1148 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

1149 
»s
 = -
EINVAL
;

1150 
out
;

1153 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

1154 ià(
»s
 != 0)

1155 
out
;

1157 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1158 ià(
»s
 != 0)

1159 
out_»sume
;

1162 ià(
	`sc¡_check_tgt_acg_±rs
(
tgt
, 
acg
) != 0)

1163 
out_uÆock
;

1165 ià((
aùiÚ
 !ð
SCST_LUN_ACTION_CLEAR
) &&

1166 (
aùiÚ
 !ð
SCST_LUN_ACTION_DEL
)) {

1167 ià(!
	`is¥aû
(*
p
)) {

1168 
	`PRINT_ERROR
("%s", "Syntaxƒrror");

1169 
»s
 = -
EINVAL
;

1170 
out_uÆock
;

1173 
	`is¥aû
(*
p
) && *p != '\0')

1174 
p
++;

1175 
e
 = 
p
;

1176 !
	`is¥aû
(*
e
) && *e != '\0')

1177 
e
++;

1178 *
e
 = '\0';

1180 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

1181 ià(!
	`¡rcmp
(
d
->
vœt_Çme
, 
p
)) {

1182 
dev
 = 
d
;

1183 
	`TRACE_DBG
("Deviû %°(%sèfound", 
dev
, 
p
);

1187 ià(
dev
 =ð
NULL
) {

1188 
	`PRINT_ERROR
("Deviû '%s'‚Ù found", 
p
);

1189 
»s
 = -
EINVAL
;

1190 
out_uÆock
;

1194 
aùiÚ
) {

1195 
SCST_LUN_ACTION_ADD
:

1196 
SCST_LUN_ACTION_REPLACE
:

1198 
boÞ
 
dev_»¶aûd
 = 
çl£
;

1200 
e
++;

1201 
	`is¥aû
(*
e
) && *e != '\0')

1202 
e
++;

1204 
vœt_lun
 = 
	`sim¶e_¡¹oul
(
e
, &e, 0);

1205 ià(
vœt_lun
 > 
SCST_MAX_LUN
) {

1206 
	`PRINT_ERROR
("ToØbig LUN %d (max %d)", 
vœt_lun
,

1207 
SCST_MAX_LUN
);

1208 
»s
 = -
EINVAL
;

1209 
out_uÆock
;

1212 
	`is¥aû
(*
e
) && *e != '\0')

1213 
e
++;

1216 *
µ
;

1217 
v®
;

1218 *
·¿m
 = 
	`sc¡_g‘_Ãxt_tok’_¡r
(&
e
);

1219 ià(
·¿m
 =ð
NULL
)

1222 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

1223 ià(*
p
 == '\0') {

1224 
	`PRINT_ERROR
("Syntaxƒrror‡t %s (device %s)",

1225 
·¿m
, 
dev
->
vœt_Çme
);

1226 
»s
 = -
EINVAL
;

1227 
out_uÆock
;

1230 
µ
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
);

1231 ià(*
µ
 == '\0') {

1232 
	`PRINT_ERROR
("Parameter %s value missed for device %s",

1233 
p
, 
dev
->
vœt_Çme
);

1234 
»s
 = -
EINVAL
;

1235 
out_uÆock
;

1238 ià(
	`sc¡_g‘_Ãxt_Ëxem
(&
·¿m
)[0] != '\0') {

1239 
	`PRINT_ERROR
("Too many…arameter's %s values (device %s)",

1240 
p
, 
dev
->
vœt_Çme
);

1241 
»s
 = -
EINVAL
;

1242 
out_uÆock
;

1245 
»s
 = 
	`¡riù_¡¹oul
(
µ
, 0, &
v®
);

1246 ià(
»s
 != 0) {

1247 
	`PRINT_ERROR
("strict_strtoul() for %s failed: %d "

1248 "(deviû %s)", 
µ
, 
»s
, 
dev
->
vœt_Çme
);

1249 
out_uÆock
;

1252 ià(!
	`¡rÿ£cmp
("»ad_Úly", 
p
)) {

1253 
»ad_Úly
 = 
v®
;

1254 
	`TRACE_DBG
("READ ONLY %d", 
»ad_Úly
);

1256 
	`PRINT_ERROR
("Unknown…arameter %s (device %s)",

1257 
p
, 
dev
->
vœt_Çme
);

1258 
»s
 = -
EINVAL
;

1259 
out_uÆock
;

1263 
acg_dev
 = 
NULL
;

1264 
	`li¡_fÜ_—ch_’Œy
(
acg_dev_tmp
, &
acg
->
acg_dev_li¡
,

1265 
acg_dev_li¡_’Œy
) {

1266 ià(
acg_dev_tmp
->
lun
 =ð
vœt_lun
) {

1267 
acg_dev
 = 
acg_dev_tmp
;

1272 ià(
acg_dev
 !ð
NULL
) {

1273 ià(
aùiÚ
 =ð
SCST_LUN_ACTION_ADD
) {

1274 
	`PRINT_ERROR
("virt†un %d‡lreadyƒxists in "

1275 "grou°%s", 
vœt_lun
, 
acg
->
acg_Çme
);

1276 
»s
 = -
EEXIST
;

1277 
out_uÆock
;

1280 
»s
 = 
	`sc¡_acg_d–_lun
(
acg
, 
acg_dev
->
lun
,

1281 
çl£
);

1282 ià(
»s
 != 0)

1283 
out_uÆock
;

1285 
dev_»¶aûd
 = 
Œue
;

1289 
»s
 = 
	`sc¡_acg_add_lun
(
acg
,

1290 
tgt_kobj
 ? 
tgt
->
tgt_luns_kobj
 : 
acg
->
luns_kobj
,

1291 
dev
, 
vœt_lun
, 
»ad_Úly
, !
dev_»¶aûd
, 
NULL
);

1292 ià(
»s
 != 0)

1293 
out_uÆock
;

1295 ià(
dev_»¶aûd
) {

1296 
sc¡_tgt_dev
 *
tgt_dev
;

1298 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

1299 
dev_tgt_dev_li¡_’Œy
) {

1300 ià((
tgt_dev
->
acg_dev
->
acg
 ==‡cg) &&

1301 (
tgt_dev
->
lun
 =ð
vœt_lun
)) {

1302 
	`TRACE_MGMT_DBG
("INQUIRY DATA HAS CHANGED"

1303 " oÀtgt_dev %p", 
tgt_dev
);

1304 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

1305 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šqu”y_d©a_chªged
));

1312 
SCST_LUN_ACTION_DEL
:

1313 
	`is¥aû
(*
p
) && *p != '\0')

1314 
p
++;

1315 
vœt_lun
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

1317 
»s
 = 
	`sc¡_acg_d–_lun
(
acg
, 
vœt_lun
, 
Œue
);

1318 ià(
»s
 != 0)

1319 
out_uÆock
;

1321 
SCST_LUN_ACTION_CLEAR
:

1322 
	`PRINT_INFO
("Removed‡ll devices from group %s",

1323 
acg
->
acg_Çme
);

1324 
	`li¡_fÜ_—ch_’Œy_§ã
(
acg_dev
, 
acg_dev_tmp
,

1325 &
acg
->
acg_dev_li¡
,

1326 
acg_dev_li¡_’Œy
) {

1327 
»s
 = 
	`sc¡_acg_d–_lun
(
acg
, 
acg_dev
->
lun
,

1328 
	`li¡_is_Ï¡
(&
acg_dev
->
acg_dev_li¡_’Œy
,

1329 &
acg
->
acg_dev_li¡
));

1330 ià(
»s
 != 0)

1331 
out_uÆock
;

1336 
»s
 = 0;

1338 
out_uÆock
:

1339 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1341 
out_»sume
:

1342 
	`sc¡_»sume_aùiv™y
();

1344 
out
:

1345 
	`TRACE_EXIT_RES
(
»s
);

1346  
»s
;

1347 
	}
}

1349 
	$sc¡_luns_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

1351  
	`__sc¡_´oûss_luns_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
tgt
, wÜk->
acg
,

1352 
wÜk
->
is_tgt_kobj
);

1353 
	}
}

1355 
ssize_t
 
__sc¡_acg_mgmt_¡Üe
(
sc¡_acg
 *
acg
,

1356 cÚ¡ *
buf
, 
size_t
 
couÁ
, 
boÞ
 
is_tgt_kobj
,

1357 (*
sysfs_wÜk_â
)(
sc¡_sysfs_wÜk_™em
 *))

1359 
»s
;

1360 *
bufãr
;

1361 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

1363 
	`TRACE_ENTRY
();

1365 
bufãr
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

1366 ià(
bufãr
 =ð
NULL
) {

1367 
»s
 = -
ENOMEM
;

1368 
out
;

1371 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sysfs_wÜk_â
, 
çl£
, &
wÜk
);

1372 ià(
»s
 != 0)

1373 
out_ä“
;

1375 
wÜk
->
buf
 = 
bufãr
;

1376 
wÜk
->
tgt
 = 
acg
->tgt;

1377 
wÜk
->
acg
 =‡cg;

1378 
wÜk
->
is_tgt_kobj
 = is_tgt_kobj;

1380 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

1381 ià(
»s
 == 0)

1382 
»s
 = 
couÁ
;

1384 
out
:

1385 
	`TRACE_EXIT_RES
(
»s
);

1386  
»s
;

1388 
out_ä“
:

1389 
	`kä“
(
bufãr
);

1390 
out
;

1391 
	}
}

1393 
ssize_t
 
	$__sc¡_luns_mgmt_¡Üe
(
sc¡_acg
 *
acg
,

1394 
boÞ
 
tgt_kobj
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1396  
	`__sc¡_acg_mgmt_¡Üe
(
acg
, 
buf
, 
couÁ
, 
tgt_kobj
,

1397 
sc¡_luns_mgmt_¡Üe_wÜk_â
);

1398 
	}
}

1400 
ssize_t
 
	$sc¡_luns_mgmt_show
(
kobjeù
 *
kobj
,

1401 
kobj_©Œibu‹
 *
©Œ
,

1402 *
buf
)

1404 cÚ¡ 
h–p
[] =

1416  
	`¥rštf
(
buf
, "%s", 
h–p
);

1417 
	}
}

1419 
ssize_t
 
	$sc¡_luns_mgmt_¡Üe
(
kobjeù
 *
kobj
,

1420 
kobj_©Œibu‹
 *
©Œ
,

1421 cÚ¡ *
buf
, 
size_t
 
couÁ
)

1423 
»s
;

1424 
sc¡_acg
 *
acg
;

1425 
sc¡_tgt
 *
tgt
;

1427 
tgt
 = 
	`cÚš”_of
(
kobj
->
·»Á
, 
sc¡_tgt
, 
tgt_kobj
);

1428 
acg
 = 
tgt
->
deçuÉ_acg
;

1430 
»s
 = 
	`__sc¡_luns_mgmt_¡Üe
(
acg
, 
Œue
, 
buf
, 
couÁ
);

1432 
	`TRACE_EXIT_RES
(
»s
);

1433  
»s
;

1434 
	}
}

1436 
kobj_©Œibu‹
 
	gsc¡_luns_mgmt
 =

1437 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_luns_mgmt_show
,

1438 
sc¡_luns_mgmt_¡Üe
);

1440 
ssize_t
 
	$__sc¡_acg_addr_m‘hod_show
(
sc¡_acg
 *
acg
, *
buf
)

1442 
»s
;

1444 
acg
->
addr_m‘hod
) {

1445 
SCST_LUN_ADDR_METHOD_FLAT
:

1446 
»s
 = 
	`¥rštf
(
buf
, "FLAT\n");

1448 
SCST_LUN_ADDR_METHOD_PERIPHERAL
:

1449 
»s
 = 
	`¥rštf
(
buf
, "PERIPHERAL\n");

1451 
SCST_LUN_ADDR_METHOD_LUN
:

1452 
»s
 = 
	`¥rštf
(
buf
, "LUN\n");

1455 
»s
 = 
	`¥rštf
(
buf
, "UNKNOWN\n");

1459 ià(
acg
->
addr_m‘hod
 !ðacg->
tgt
->
tg‰
->
´eã¼ed_addr_m‘hod
)

1460 
»s
 +ð
	`¥rštf
(&
buf
[»s], "%s\n", 
SCST_SYSFS_KEY_MARK
);

1462  
»s
;

1463 
	}
}

1465 
ssize_t
 
	$__sc¡_acg_addr_m‘hod_¡Üe
(
sc¡_acg
 *
acg
,

1466 cÚ¡ *
buf
, 
size_t
 
couÁ
)

1468 
»s
 = 
couÁ
;

1470 ià(
	`¡ºÿ£cmp
(
buf
, "FLAT", 
	`mš_t
(, 4, 
couÁ
)) == 0)

1471 
acg
->
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_FLAT
;

1472 ià(
	`¡ºÿ£cmp
(
buf
, "PERIPHERAL", 
	`mš_t
(, 10, 
couÁ
)) == 0)

1473 
acg
->
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_PERIPHERAL
;

1474 ià(
	`¡ºÿ£cmp
(
buf
, "LUN", 
	`mš_t
(, 3, 
couÁ
)) == 0)

1475 
acg
->
addr_m‘hod
 = 
SCST_LUN_ADDR_METHOD_LUN
;

1477 
	`PRINT_ERROR
("UnknowÀadd»s m‘hod %s", 
buf
);

1478 
»s
 = -
EINVAL
;

1481 
	`TRACE_DBG
("acg %p,‡ddr_m‘hod %d", 
acg
,‡cg->
addr_m‘hod
);

1483  
»s
;

1484 
	}
}

1486 
ssize_t
 
	$sc¡_tgt_addr_m‘hod_show
(
kobjeù
 *
kobj
,

1487 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1489 
sc¡_acg
 *
acg
;

1490 
sc¡_tgt
 *
tgt
;

1492 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1493 
acg
 = 
tgt
->
deçuÉ_acg
;

1495  
	`__sc¡_acg_addr_m‘hod_show
(
acg
, 
buf
);

1496 
	}
}

1498 
ssize_t
 
	$sc¡_tgt_addr_m‘hod_¡Üe
(
kobjeù
 *
kobj
,

1499 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1501 
»s
;

1502 
sc¡_acg
 *
acg
;

1503 
sc¡_tgt
 *
tgt
;

1505 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1506 
acg
 = 
tgt
->
deçuÉ_acg
;

1508 
»s
 = 
	`__sc¡_acg_addr_m‘hod_¡Üe
(
acg
, 
buf
, 
couÁ
);

1510 
	`TRACE_EXIT_RES
(
»s
);

1511  
»s
;

1512 
	}
}

1514 
kobj_©Œibu‹
 
	gsc¡_tgt_addr_m‘hod
 =

1515 
__ATTR
(
addr_m‘hod
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tgt_addr_m‘hod_show
,

1516 
sc¡_tgt_addr_m‘hod_¡Üe
);

1518 
ssize_t
 
	$__sc¡_acg_io_groupšg_ty³_show
(
sc¡_acg
 *
acg
, *
buf
)

1520 
»s
;

1522 
acg
->
acg_io_groupšg_ty³
) {

1523 
SCST_IO_GROUPING_AUTO
:

1524 
»s
 = 
	`¥rštf
(
buf
, "%s\n", 
SCST_IO_GROUPING_AUTO_STR
);

1526 
SCST_IO_GROUPING_THIS_GROUP_ONLY
:

1527 
»s
 = 
	`¥rštf
(
buf
, "%s\n%s\n",

1528 
SCST_IO_GROUPING_THIS_GROUP_ONLY_STR
,

1529 
SCST_SYSFS_KEY_MARK
);

1531 
SCST_IO_GROUPING_NEVER
:

1532 
»s
 = 
	`¥rštf
(
buf
, "%s\n%s\n", 
SCST_IO_GROUPING_NEVER_STR
,

1533 
SCST_SYSFS_KEY_MARK
);

1536 
»s
 = 
	`¥rštf
(
buf
, "%d\n%s\n", 
acg
->
acg_io_groupšg_ty³
,

1537 
SCST_SYSFS_KEY_MARK
);

1541  
»s
;

1542 
	}
}

1544 
	$__sc¡_acg_´oûss_io_groupšg_ty³_¡Üe
(
sc¡_tgt
 *
tgt
,

1545 
sc¡_acg
 *
acg
, 
io_groupšg_ty³
)

1547 
»s
 = 0;

1548 
sc¡_acg_dev
 *
acg_dev
;

1550 
	`TRACE_DBG
("tgˆ%p,‡cg %p, io_groupšg_ty³ %d", 
tgt
, 
acg
,

1551 
io_groupšg_ty³
);

1553 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

1554 ià(
»s
 != 0)

1555 
out
;

1557 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1558 ià(
»s
 != 0)

1559 
out_»sume
;

1562 ià(
	`sc¡_check_tgt_acg_±rs
(
tgt
, 
acg
) != 0)

1563 
out_uÆock
;

1565 
acg
->
acg_io_groupšg_ty³
 = 
io_groupšg_ty³
;

1567 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

1568 
rc
;

1570 
	`sc¡_¡Ý_dev_th»ads
(
acg_dev
->
dev
);

1572 
rc
 = 
	`sc¡_ü—‹_dev_th»ads
(
acg_dev
->
dev
);

1573 ià(
rc
 != 0)

1574 
»s
 = 
rc
;

1577 
out_uÆock
:

1578 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1580 
out_»sume
:

1581 
	`sc¡_»sume_aùiv™y
();

1583 
out
:

1584  
»s
;

1585 
	}
}

1587 
	$__sc¡_acg_io_groupšg_ty³_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

1589  
	`__sc¡_acg_´oûss_io_groupšg_ty³_¡Üe
(
wÜk
->
tgt
, wÜk->
acg
,

1590 
wÜk
->
io_groupšg_ty³
);

1591 
	}
}

1593 
ssize_t
 
	$__sc¡_acg_io_groupšg_ty³_¡Üe
(
sc¡_acg
 *
acg
,

1594 cÚ¡ *
buf
, 
size_t
 
couÁ
)

1596 
»s
 = 0;

1597 
´ev
 = 
acg
->
acg_io_groupšg_ty³
;

1598 
io_groupšg_ty³
;

1599 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

1601 ià(
	`¡ºÿ£cmp
(
buf
, 
SCST_IO_GROUPING_AUTO_STR
,

1602 
	`mš_t
(, 
	`¡¾’
(
SCST_IO_GROUPING_AUTO_STR
), 
couÁ
)) == 0)

1603 
io_groupšg_ty³
 = 
SCST_IO_GROUPING_AUTO
;

1604 ià(
	`¡ºÿ£cmp
(
buf
, 
SCST_IO_GROUPING_THIS_GROUP_ONLY_STR
,

1605 
	`mš_t
(, 
	`¡¾’
(
SCST_IO_GROUPING_THIS_GROUP_ONLY_STR
), 
couÁ
)) == 0)

1606 
io_groupšg_ty³
 = 
SCST_IO_GROUPING_THIS_GROUP_ONLY
;

1607 ià(
	`¡ºÿ£cmp
(
buf
, 
SCST_IO_GROUPING_NEVER_STR
,

1608 
	`mš_t
(, 
	`¡¾’
(
SCST_IO_GROUPING_NEVER_STR
), 
couÁ
)) == 0)

1609 
io_groupšg_ty³
 = 
SCST_IO_GROUPING_NEVER
;

1611 
»s
 = 
	`¡riù_¡¹Þ
(
buf
, 0, &
io_groupšg_ty³
);

1612 ià((
»s
 !ð0è|| (
io_groupšg_ty³
 <= 0)) {

1613 
	`PRINT_ERROR
("Unknown or‚ot‡llowed I/O groupingype "

1614 "%s", 
buf
);

1615 
»s
 = -
EINVAL
;

1616 
out
;

1620 ià(
´ev
 =ð
io_groupšg_ty³
)

1621 
out
;

1623 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
__sc¡_acg_io_groupšg_ty³_¡Üe_wÜk_â
,

1624 
çl£
, &
wÜk
);

1625 ià(
»s
 != 0)

1626 
out
;

1628 
wÜk
->
tgt
 = 
acg
->tgt;

1629 
wÜk
->
acg
 =‡cg;

1630 
wÜk
->
io_groupšg_ty³
 = io_grouping_type;

1632 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

1634 
out
:

1635  
»s
;

1636 
	}
}

1638 
ssize_t
 
	$sc¡_tgt_io_groupšg_ty³_show
(
kobjeù
 *
kobj
,

1639 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1641 
sc¡_acg
 *
acg
;

1642 
sc¡_tgt
 *
tgt
;

1644 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1645 
acg
 = 
tgt
->
deçuÉ_acg
;

1647  
	`__sc¡_acg_io_groupšg_ty³_show
(
acg
, 
buf
);

1648 
	}
}

1650 
ssize_t
 
	$sc¡_tgt_io_groupšg_ty³_¡Üe
(
kobjeù
 *
kobj
,

1651 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1653 
»s
;

1654 
sc¡_acg
 *
acg
;

1655 
sc¡_tgt
 *
tgt
;

1657 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1658 
acg
 = 
tgt
->
deçuÉ_acg
;

1660 
»s
 = 
	`__sc¡_acg_io_groupšg_ty³_¡Üe
(
acg
, 
buf
, 
couÁ
);

1661 ià(
»s
 != 0)

1662 
out
;

1664 
»s
 = 
couÁ
;

1666 
out
:

1667 
	`TRACE_EXIT_RES
(
»s
);

1668  
»s
;

1669 
	}
}

1671 
kobj_©Œibu‹
 
	gsc¡_tgt_io_groupšg_ty³
 =

1672 
__ATTR
(
io_groupšg_ty³
, 
S_IRUGO
 | 
S_IWUSR
,

1673 
sc¡_tgt_io_groupšg_ty³_show
,

1674 
sc¡_tgt_io_groupšg_ty³_¡Üe
);

1676 
ssize_t
 
	$__sc¡_acg_ýu_mask_show
(
sc¡_acg
 *
acg
, *
buf
)

1678 
»s
;

1680 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 28)

1681 
»s
 = 
	`ýumask_sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
,

1682 
acg
->
acg_ýu_mask
);

1684 
»s
 = 
	`ýumask_sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
,

1685 &
acg
->
acg_ýu_mask
);

1687 ià(!
	`ýus_equ®
(
acg
->
acg_ýu_mask
, 
deçuÉ_ýu_mask
))

1688 
»s
 +ð
	`¥rštf
(&
buf
[»s], "\n%s\n", 
SCST_SYSFS_KEY_MARK
);

1690  
»s
;

1691 
	}
}

1693 
	$__sc¡_acg_´oûss_ýu_mask_¡Üe
(
sc¡_tgt
 *
tgt
,

1694 
sc¡_acg
 *
acg
, 
ýumask_t
 *
ýu_mask
)

1696 
»s
 = 0;

1697 
sc¡_£ssiÚ
 *
£ss
;

1699 
	`TRACE_DBG
("tgˆ%p,‡cg %p", 
tgt
, 
acg
);

1701 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1702 ià(
»s
 != 0)

1703 
out
;

1706 ià(
	`sc¡_check_tgt_acg_±rs
(
tgt
, 
acg
) != 0)

1707 
out_uÆock
;

1709 
	`ýumask_cÝy
(&
acg
->
acg_ýu_mask
, 
ýu_mask
);

1711 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
acg
->
acg_£ss_li¡
, 
acg_£ss_li¡_’Œy
) {

1712 
i
;

1713 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1714 
sc¡_tgt_dev
 *
tgt_dev
;

1715 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

1716 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

1717 
£ss_tgt_dev_li¡_’Œy
) {

1718 
sc¡_cmd_th»ad_t
 *
thr
;

1719 ià(
tgt_dev
->
aùive_cmd_th»ads
 !ð&tgt_dev->
tgt_dev_cmd_th»ads
)

1721 
	`li¡_fÜ_—ch_’Œy
(
thr
,

1722 &
tgt_dev
->
aùive_cmd_th»ads
->
th»ads_li¡
,

1723 
th»ad_li¡_’Œy
) {

1724 
rc
;

1725 
rc
 = 
	`£t_ýus_®lowed_±r
(
thr
->
cmd_th»ad
, 
ýu_mask
);

1726 ià(
rc
 != 0)

1727 
	`PRINT_ERROR
("Setting CPU "

1728 "affš™y fažed: %d", 
rc
);

1732 ià(
tgt
->
tg‰
->
»pÜt_«n
 !ð
NULL
) {

1733 
sc¡_«n
 *
«n
;

1734 
rc
;

1736 
«n
 = 
	`sc¡_®loc_«n
(
£ss
, 0);

1737 ià(
«n
 =ð
NULL
) {

1738 
	`PRINT_ERROR
("Unableo‚otifyarget driver %s "

1739 "abouˆýu_mask chªge", 
tgt
->
tgt_Çme
);

1743 
«n
->
ev’t_â
 = 
SCST_AEN_CPU_MASK_CHANGED
;

1745 
	`TRACE_DBG
("Callingarget's %s„eport_aen(%p)",

1746 
tgt
->
tg‰
->
Çme
, 
«n
);

1747 
rc
 = 
tgt
->
tg‰
->
	`»pÜt_«n
(
«n
);

1748 
	`TRACE_DBG
("Target's %s„eport_aen(%p)„eturned %d",

1749 
tgt
->
tg‰
->
Çme
, 
«n
, 
rc
);

1750 ià(
rc
 !ð
SCST_AEN_RES_SUCCESS
)

1751 
	`sc¡_ä“_«n
(
«n
);

1756 
out_uÆock
:

1757 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1759 
out
:

1760  
»s
;

1761 
	}
}

1763 
	$__sc¡_acg_ýu_mask_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

1765  
	`__sc¡_acg_´oûss_ýu_mask_¡Üe
(
wÜk
->
tgt
, wÜk->
acg
,

1766 &
wÜk
->
ýu_mask
);

1767 
	}
}

1769 
ssize_t
 
	$__sc¡_acg_ýu_mask_¡Üe
(
sc¡_acg
 *
acg
,

1770 cÚ¡ *
buf
, 
size_t
 
couÁ
)

1772 
»s
;

1773 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

1777 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
__sc¡_acg_ýu_mask_¡Üe_wÜk_â
,

1778 
çl£
, &
wÜk
);

1779 ià(
»s
 != 0)

1780 
out
;

1786 
»s
 = 
	`__b™m­_·r£
(
buf
, 
couÁ
, 0, 
	`ýumask_b™s
(&
wÜk
->
ýu_mask
),

1787 
Ä_ýumask_b™s
);

1788 ià(
»s
 != 0) {

1789 
	`PRINT_ERROR
("__b™m­_·r£(èçžed: %d", 
»s
);

1790 
out_»Ëa£
;

1793 ià(
	`ýus_equ®
(
acg
->
acg_ýu_mask
, 
wÜk
->
ýu_mask
))

1794 
out
;

1796 
wÜk
->
tgt
 = 
acg
->tgt;

1797 
wÜk
->
acg
 =‡cg;

1799 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

1801 
out
:

1802  
»s
;

1804 
out_»Ëa£
:

1805 
	`sc¡_sysfs_wÜk_»Ëa£
(&
wÜk
->
sysfs_wÜk_k»f
);

1806 
out
;

1807 
	}
}

1809 
ssize_t
 
	$sc¡_tgt_ýu_mask_show
(
kobjeù
 *
kobj
,

1810 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1812 
sc¡_acg
 *
acg
;

1813 
sc¡_tgt
 *
tgt
;

1815 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1816 
acg
 = 
tgt
->
deçuÉ_acg
;

1818  
	`__sc¡_acg_ýu_mask_show
(
acg
, 
buf
);

1819 
	}
}

1821 
ssize_t
 
	$sc¡_tgt_ýu_mask_¡Üe
(
kobjeù
 *
kobj
,

1822 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1824 
»s
;

1825 
sc¡_acg
 *
acg
;

1826 
sc¡_tgt
 *
tgt
;

1828 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

1829 
acg
 = 
tgt
->
deçuÉ_acg
;

1831 
»s
 = 
	`__sc¡_acg_ýu_mask_¡Üe
(
acg
, 
buf
, 
couÁ
);

1832 ià(
»s
 != 0)

1833 
out
;

1835 
»s
 = 
couÁ
;

1837 
out
:

1838 
	`TRACE_EXIT_RES
(
»s
);

1839  
»s
;

1840 
	}
}

1842 
kobj_©Œibu‹
 
	gsc¡_tgt_ýu_mask
 =

1843 
__ATTR
(
ýu_mask
, 
S_IRUGO
 | 
S_IWUSR
,

1844 
sc¡_tgt_ýu_mask_show
,

1845 
sc¡_tgt_ýu_mask_¡Üe
);

1847 
ssize_t
 
	$sc¡_ši_group_mgmt_show
(
kobjeù
 *
kobj
,

1848 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

1850 cÚ¡ 
h–p
[] =

1854  
	`¥rštf
(
buf
, "%s", 
h–p
);

1855 
	}
}

1857 
	$sc¡_´oûss_ši_group_mgmt_¡Üe
(*
bufãr
,

1858 
sc¡_tgt
 *
tgt
)

1860 
»s
, 
aùiÚ
;

1861 *
p
, *
e
 = 
NULL
;

1862 
sc¡_acg
 *
a
, *
acg
 = 
NULL
;

1864 
SCST_INI_GROUP_ACTION_CREATE
 = 1,

1865 
SCST_INI_GROUP_ACTION_DEL
 = 2,

1868 
	`TRACE_ENTRY
();

1870 
	`TRACE_DBG
("tgˆ%p, bufã¸%s", 
tgt
, 
bufãr
);

1872 
p
 = 
bufãr
;

1873 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

1874 
p
[
	`¡¾’
(p) - 1] = '\0';

1875 ià(
	`¡ºÿ£cmp
("ü—‹ ", 
p
, 7) == 0) {

1876 
p
 += 7;

1877 
aùiÚ
 = 
SCST_INI_GROUP_ACTION_CREATE
;

1878 } ià(
	`¡ºÿ£cmp
("d– ", 
p
, 4) == 0) {

1879 
p
 += 4;

1880 
aùiÚ
 = 
SCST_INI_GROUP_ACTION_DEL
;

1882 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

1883 
»s
 = -
EINVAL
;

1884 
out
;

1887 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

1888 ià(
»s
 != 0)

1889 
out
;

1891 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

1892 ià(
»s
 != 0)

1893 
out_»sume
;

1896 ià(
	`sc¡_check_tgt_acg_±rs
(
tgt
, 
NULL
) != 0)

1897 
out_uÆock
;

1899 
	`is¥aû
(*
p
) && *p != '\0')

1900 
p
++;

1901 
e
 = 
p
;

1902 !
	`is¥aû
(*
e
) && *e != '\0')

1903 
e
++;

1904 *
e
 = '\0';

1906 ià(
p
[0] == '\0') {

1907 
	`PRINT_ERROR
("%s", "Group‚ame„equired");

1908 
»s
 = -
EINVAL
;

1909 
out_uÆock
;

1912 
	`li¡_fÜ_—ch_’Œy
(
a
, &
tgt
->
tgt_acg_li¡
, 
acg_li¡_’Œy
) {

1913 ià(
	`¡rcmp
(
a
->
acg_Çme
, 
p
) == 0) {

1914 
	`TRACE_DBG
("group (acg) %p %s found",

1915 
a
,‡->
acg_Çme
);

1916 
acg
 = 
a
;

1921 
aùiÚ
) {

1922 
SCST_INI_GROUP_ACTION_CREATE
:

1923 
	`TRACE_DBG
("C»©šg grou°'%s'", 
p
);

1924 ià(
acg
 !ð
NULL
) {

1925 
	`PRINT_ERROR
("acg‚am% exi¡", 
p
);

1926 
»s
 = -
EINVAL
;

1927 
out_uÆock
;

1929 
acg
 = 
	`sc¡_®loc_add_acg
(
tgt
, 
p
, 
Œue
);

1930 ià(
acg
 =ð
NULL
)

1931 
out_uÆock
;

1933 
SCST_INI_GROUP_ACTION_DEL
:

1934 
	`TRACE_DBG
("D–‘šg grou°'%s'", 
p
);

1935 ià(
acg
 =ð
NULL
) {

1936 
	`PRINT_ERROR
("Grou°% nÙ found", 
p
);

1937 
»s
 = -
EINVAL
;

1938 
out_uÆock
;

1940 ià(!
	`sc¡_acg_£ss_is_em±y
(
acg
)) {

1941 
	`PRINT_ERROR
("Grou°% i nÙƒm±y", 
acg
->
acg_Çme
);

1942 
»s
 = -
EBUSY
;

1943 
out_uÆock
;

1945 
	`sc¡_d–_ä“_acg
(
acg
);

1949 
»s
 = 0;

1951 
out_uÆock
:

1952 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

1954 
out_»sume
:

1955 
	`sc¡_»sume_aùiv™y
();

1957 
out
:

1958 
	`TRACE_EXIT_RES
(
»s
);

1959  
»s
;

1960 
	}
}

1962 
	$sc¡_ši_group_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

1964  
	`sc¡_´oûss_ši_group_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
tgt
);

1965 
	}
}

1967 
ssize_t
 
	$sc¡_ši_group_mgmt_¡Üe
(
kobjeù
 *
kobj
,

1968 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1970 
»s
;

1971 *
bufãr
;

1972 
sc¡_tgt
 *
tgt
;

1973 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

1975 
	`TRACE_ENTRY
();

1977 
tgt
 = 
	`cÚš”_of
(
kobj
->
·»Á
, 
sc¡_tgt
, 
tgt_kobj
);

1979 
bufãr
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

1980 ià(
bufãr
 =ð
NULL
) {

1981 
»s
 = -
ENOMEM
;

1982 
out
;

1985 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_ši_group_mgmt_¡Üe_wÜk_â
, 
çl£
,

1986 &
wÜk
);

1987 ià(
»s
 != 0)

1988 
out_ä“
;

1990 
wÜk
->
buf
 = 
bufãr
;

1991 
wÜk
->
tgt
 =gt;

1993 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

1994 ià(
»s
 == 0)

1995 
»s
 = 
couÁ
;

1997 
out
:

1998 
	`TRACE_EXIT_RES
(
»s
);

1999  
»s
;

2001 
out_ä“
:

2002 
	`kä“
(
bufãr
);

2003 
out
;

2004 
	}
}

2006 
kobj_©Œibu‹
 
	gsc¡_ši_group_mgmt
 =

2007 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_ši_group_mgmt_show
,

2008 
sc¡_ši_group_mgmt_¡Üe
);

2010 
ssize_t
 
	$sc¡_tgt_’abË_show
(
kobjeù
 *
kobj
,

2011 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2013 
sc¡_tgt
 *
tgt
;

2014 
»s
;

2015 
boÞ
 
’abËd
;

2017 
	`TRACE_ENTRY
();

2019 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2021 
’abËd
 = 
tgt
->
tg‰
->
	`is_rg‘_’abËd
(tgt);

2023 
»s
 = 
	`¥rštf
(
buf
, "%d\n", 
’abËd
 ? 1 : 0);

2025 
	`TRACE_EXIT_RES
(
»s
);

2026  
»s
;

2027 
	}
}

2029 
	$sc¡_´oûss_tgt_’abË_¡Üe
(
sc¡_tgt
 *
tgt
, 
boÞ
 
’abË
)

2031 
»s
;

2033 
	`TRACE_ENTRY
();

2037 
	`TRACE_DBG
("tgˆ%s,ƒÇbË %d", 
tgt
->
tgt_Çme
, 
’abË
);

2039 ià(
’abË
) {

2040 ià(
tgt
->
»l_tgt_id
 == 0) {

2041 
»s
 = 
	`g’_»Ïtive_rg‘_pÜt_id
(&
tgt
->
»l_tgt_id
);

2042 ià(
»s
 != 0)

2043 
out_put
;

2044 
	`PRINT_INFO
("Using‡utogenerated„el ID %d forarget "

2045 "%s", 
tgt
->
»l_tgt_id
,gt->
tgt_Çme
);

2047 ià(!
	`sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(

2048 
tgt
->
»l_tgt_id
,gt)) {

2049 
	`PRINT_ERROR
("Relative…ort id %d is‚ot unique",

2050 
tgt
->
»l_tgt_id
);

2051 
»s
 = -
EBADSLT
;

2052 
out_put
;

2057 
»s
 = 
tgt
->
tg‰
->
	`’abË_rg‘
Ñgt, 
’abË
);

2059 
out_put
:

2060 
	`kobjeù_put
(&
tgt
->
tgt_kobj
);

2062 
	`TRACE_EXIT_RES
(
»s
);

2063  
»s
;

2064 
	}
}

2066 
	$sc¡_tgt_’abË_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

2068  
	`sc¡_´oûss_tgt_’abË_¡Üe
(
wÜk
->
tgt
, wÜk->
’abË
);

2069 
	}
}

2071 
ssize_t
 
	$sc¡_tgt_’abË_¡Üe
(
kobjeù
 *
kobj
,

2072 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2074 
»s
;

2075 
sc¡_tgt
 *
tgt
;

2076 
boÞ
 
’abË
;

2077 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

2079 
	`TRACE_ENTRY
();

2081 ià(
buf
 =ð
NULL
) {

2082 
	`PRINT_ERROR
("%s: NULL bufãr?", 
__func__
);

2083 
»s
 = -
EINVAL
;

2084 
out
;

2087 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2089 
buf
[0]) {

2091 
’abË
 = 
çl£
;

2094 
’abË
 = 
Œue
;

2097 
	`PRINT_ERROR
("%s: Requested‡ction‚ot understood: %s",

2098 
__func__
, 
buf
);

2099 
»s
 = -
EINVAL
;

2100 
out
;

2103 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_tgt_’abË_¡Üe_wÜk_â
, 
çl£
,

2104 &
wÜk
);

2105 ià(
»s
 != 0)

2106 
out
;

2108 
wÜk
->
tgt
 =gt;

2109 
wÜk
->
’abË
 =ƒnable;

2111 
	`kobjeù_g‘
(&
tgt
->
tgt_kobj
);

2113 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

2114 ià(
»s
 == 0)

2115 
»s
 = 
couÁ
;

2117 
out
:

2118 
	`TRACE_EXIT_RES
(
»s
);

2119  
»s
;

2120 
	}
}

2122 
kobj_©Œibu‹
 
	gtgt_’abË_©Œ
 =

2123 
__ATTR
(
’abËd
, 
S_IRUGO
 | 
S_IWUSR
,

2124 
sc¡_tgt_’abË_show
, 
sc¡_tgt_’abË_¡Üe
);

2126 
ssize_t
 
	$sc¡_»l_tgt_id_show
(
kobjeù
 *
kobj
,

2127 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2129 
sc¡_tgt
 *
tgt
;

2130 
»s
;

2132 
	`TRACE_ENTRY
();

2134 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2136 
»s
 = 
	`¥rštf
(
buf
, "%d\n%s", 
tgt
->
»l_tgt_id
,

2137 (
tgt
->
»l_tgt_id
 !ð0è? 
SCST_SYSFS_KEY_MARK
 "\n" : "");

2139 
	`TRACE_EXIT_RES
(
»s
);

2140  
»s
;

2141 
	}
}

2143 
	$sc¡_´oûss_»l_tgt_id_¡Üe
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

2145 
»s
 = 0;

2146 
sc¡_tgt
 *
tgt
 = 
wÜk
->
tgt_r
;

2147 
»l_tgt_id
 = 
wÜk
->rel_tgt_id;

2148 
boÞ
 
’abËd
;

2150 
	`TRACE_ENTRY
();

2154 
	`TRACE_DBG
("Tryingo set„elativearget…ort id %d",

2155 (
ušt16_t
)
»l_tgt_id
);

2157 ià(
tgt
->
tg‰
->
is_rg‘_’abËd
 !ð
NULL
)

2158 
’abËd
 = 
tgt
->
tg‰
->
	`is_rg‘_’abËd
(tgt);

2160 
’abËd
 = 
Œue
;

2162 ià(
’abËd
 && 
»l_tgt_id
 !ð
tgt
->rel_tgt_id) {

2163 ià(!
	`sc¡_is_»Ïtive_rg‘_pÜt_id_unique
(
»l_tgt_id
, 
tgt
)) {

2164 
	`PRINT_ERROR
("Relative…ort id %d is‚ot unique",

2165 (
ušt16_t
)
»l_tgt_id
);

2166 
»s
 = -
EBADSLT
;

2167 
out_put
;

2171 ià(
»l_tgt_id
 < 
SCST_MIN_REL_TGT_ID
 ||

2172 
»l_tgt_id
 > 
SCST_MAX_REL_TGT_ID
) {

2173 ià((
»l_tgt_id
 =ð0è&& !
’abËd
)

2174 
£t
;

2176 
	`PRINT_ERROR
("Invalid„elative…ort id %d",

2177 (
ušt16_t
)
»l_tgt_id
);

2178 
»s
 = -
EINVAL
;

2179 
out_put
;

2182 
£t
:

2183 
tgt
->
»l_tgt_id
 = (
ušt16_t
)rel_tgt_id;

2185 
out_put
:

2186 
	`kobjeù_put
(&
tgt
->
tgt_kobj
);

2188 
	`TRACE_EXIT_RES
(
»s
);

2189  
»s
;

2190 
	}
}

2192 
ssize_t
 
	$sc¡_»l_tgt_id_¡Üe
(
kobjeù
 *
kobj
,

2193 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2195 
»s
 = 0;

2196 
sc¡_tgt
 *
tgt
;

2197 
»l_tgt_id
;

2198 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

2200 
	`TRACE_ENTRY
();

2202 ià(
buf
 =ð
NULL
)

2203 
out
;

2205 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2207 
»s
 = 
	`¡riù_¡¹oul
(
buf
, 0, &
»l_tgt_id
);

2208 ià(
»s
 != 0) {

2209 
	`PRINT_ERROR
("%s", "Wrong„el_tgt_id");

2210 
»s
 = -
EINVAL
;

2211 
out
;

2214 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_´oûss_»l_tgt_id_¡Üe
, 
çl£
,

2215 &
wÜk
);

2216 ià(
»s
 != 0)

2217 
out
;

2219 
wÜk
->
tgt_r
 = 
tgt
;

2220 
wÜk
->
»l_tgt_id
 =„el_tgt_id;

2222 
	`kobjeù_g‘
(&
tgt
->
tgt_kobj
);

2224 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

2225 ià(
»s
 == 0)

2226 
»s
 = 
couÁ
;

2228 
out
:

2229 
	`TRACE_EXIT_RES
(
»s
);

2230  
»s
;

2231 
	}
}

2233 
kobj_©Œibu‹
 
	gsc¡_»l_tgt_id
 =

2234 
__ATTR
(
»l_tgt_id
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_»l_tgt_id_show
,

2235 
sc¡_»l_tgt_id_¡Üe
);

2237 
ssize_t
 
	$sc¡_tgt_comm’t_show
(
kobjeù
 *
kobj
,

2238 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2240 
sc¡_tgt
 *
tgt
;

2241 
»s
;

2243 
	`TRACE_ENTRY
();

2245 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2247 ià(
tgt
->
tgt_comm’t
 !ð
NULL
)

2248 
»s
 = 
	`¥rštf
(
buf
, "%s\n%s", 
tgt
->
tgt_comm’t
,

2249 
SCST_SYSFS_KEY_MARK
 "\n");

2251 
»s
 = 0;

2253 
	`TRACE_EXIT_RES
(
»s
);

2254  
»s
;

2255 
	}
}

2257 
ssize_t
 
	$sc¡_tgt_comm’t_¡Üe
(
kobjeù
 *
kobj
,

2258 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2260 
»s
;

2261 
sc¡_tgt
 *
tgt
;

2262 *
p
;

2263 
Ën
;

2265 
	`TRACE_ENTRY
();

2267 ià((
buf
 =ð
NULL
è|| (
couÁ
 == 0)) {

2268 
»s
 = 0;

2269 
out
;

2272 
tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt
, 
tgt_kobj
);

2274 
Ën
 = 
	`¡ºËn
(
buf
, 
couÁ
);

2275 ià(
buf
[
couÁ
-1] == '\n')

2276 
Ën
--;

2278 ià(
Ën
 == 0) {

2279 
	`kä“
(
tgt
->
tgt_comm’t
);

2280 
tgt
->
tgt_comm’t
 = 
NULL
;

2281 
out_dÚe
;

2284 
p
 = 
	`km®loc
(
Ën
+1, 
GFP_KERNEL
);

2285 ià(
p
 =ð
NULL
) {

2286 
	`PRINT_ERROR
("Unableo‡llocgt_comment string (len %d)",

2287 
Ën
+1);

2288 
»s
 = -
ENOMEM
;

2289 
out
;

2292 
	`memýy
(
p
, 
buf
, 
Ën
);

2293 
p
[
Ën
] = '\0';

2295 
	`kä“
(
tgt
->
tgt_comm’t
);

2297 
tgt
->
tgt_comm’t
 = 
p
;

2299 
out_dÚe
:

2300 
»s
 = 
couÁ
;

2302 
out
:

2303 
	`TRACE_EXIT_RES
(
»s
);

2304  
»s
;

2305 
	}
}

2307 
kobj_©Œibu‹
 
	gsc¡_tgt_comm’t
 =

2308 
__ATTR
(
comm’t
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tgt_comm’t_show
,

2309 
sc¡_tgt_comm’t_¡Üe
);

2315 
	$sc¡_tgt_sysfs_ü—‹
(
sc¡_tgt
 *
tgt
)

2317 
»s
;

2319 
	`TRACE_ENTRY
();

2321 
»s
 = 
	`kobjeù_š™_ªd_add
(&
tgt
->
tgt_kobj
, &
tgt_kty³
,

2322 &
tgt
->
tg‰
->
tg‰_kobj
,gt->
tgt_Çme
);

2323 ià(
»s
 != 0) {

2324 
	`PRINT_ERROR
("Cª'ˆaddgˆ% tØsysfs", 
tgt
->
tgt_Çme
);

2325 
out
;

2328 ià((
tgt
->
tg‰
->
’abË_rg‘
 !ð
NULL
) &&

2329 (
tgt
->
tg‰
->
is_rg‘_’abËd
 !ð
NULL
)) {

2330 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt
->
tgt_kobj
,

2331 &
tgt_’abË_©Œ
.
©Œ
);

2332 ià(
»s
 != 0) {

2333 
	`PRINT_ERROR
("Can't‡dd‡ttr %so sysfs",

2334 
tgt_’abË_©Œ
.
©Œ
.
Çme
);

2335 
out_”r
;

2339 
tgt
->
tgt_£ss_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("£ssiÚs", &tgt->
tgt_kobj
);

2340 ià(
tgt
->
tgt_£ss_kobj
 =ð
NULL
) {

2341 
	`PRINT_ERROR
("Cª'ˆü—‹ ses kobj fÜgˆ%s", 
tgt
->
tgt_Çme
);

2342 
out_nomem
;

2345 
tgt
->
tgt_luns_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("luns", &tgt->
tgt_kobj
);

2346 ià(
tgt
->
tgt_luns_kobj
 =ð
NULL
) {

2347 
	`PRINT_ERROR
("Cª'ˆü—‹†un kobj fÜgˆ%s", 
tgt
->
tgt_Çme
);

2348 
out_nomem
;

2351 
»s
 = 
	`sysfs_ü—‹_fže
(
tgt
->
tgt_luns_kobj
, &
sc¡_luns_mgmt
.
©Œ
);

2352 ià(
»s
 != 0) {

2353 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2354 
sc¡_luns_mgmt
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

2355 
out_”r
;

2358 
tgt
->
tgt_ši_g½_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("ini_groups",

2359 &
tgt
->
tgt_kobj
);

2360 ià(
tgt
->
tgt_ši_g½_kobj
 =ð
NULL
) {

2361 
	`PRINT_ERROR
("Can't create ini_grp kobj forgt %s",

2362 
tgt
->
tgt_Çme
);

2363 
out_nomem
;

2366 
»s
 = 
	`sysfs_ü—‹_fže
(
tgt
->
tgt_ši_g½_kobj
,

2367 &
sc¡_ši_group_mgmt
.
©Œ
);

2368 ià(
»s
 != 0) {

2369 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2370 
sc¡_ši_group_mgmt
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

2371 
out_”r
;

2374 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt
->
tgt_kobj
,

2375 &
sc¡_»l_tgt_id
.
©Œ
);

2376 ià(
»s
 != 0) {

2377 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2378 
sc¡_»l_tgt_id
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

2379 
out_”r
;

2382 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt
->
tgt_kobj
,

2383 &
sc¡_tgt_comm’t
.
©Œ
);

2384 ià(
»s
 != 0) {

2385 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2386 
sc¡_tgt_comm’t
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

2387 
out_”r
;

2390 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt
->
tgt_kobj
,

2391 &
sc¡_tgt_addr_m‘hod
.
©Œ
);

2392 ià(
»s
 != 0) {

2393 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2394 
sc¡_tgt_addr_m‘hod
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

2395 
out_”r
;

2398 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt
->
tgt_kobj
,

2399 &
sc¡_tgt_io_groupšg_ty³
.
©Œ
);

2400 ià(
»s
 != 0) {

2401 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2402 
sc¡_tgt_io_groupšg_ty³
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

2403 
out_”r
;

2406 
»s
 = 
	`sysfs_ü—‹_fže
(&
tgt
->
tgt_kobj
, &
sc¡_tgt_ýu_mask
.
©Œ
);

2407 ià(
»s
 != 0) {

2408 
	`PRINT_ERROR
("Can't‡dd‡ttribute %s forgt %s",

2409 
sc¡_tgt_ýu_mask
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

2410 
out_”r
;

2413 ià(
tgt
->
tg‰
->
tgt_©Œs
) {

2414 
»s
 = 
	`sysfs_ü—‹_fžes
(&
tgt
->
tgt_kobj
,gt->
tg‰
->
tgt_©Œs
);

2415 ià(
»s
 != 0) {

2416 
	`PRINT_ERROR
("Can't‡dd‡ttributes forgt %s",

2417 
tgt
->
tgt_Çme
);

2418 
out_”r
;

2422 
out
:

2423 
	`TRACE_EXIT_RES
(
»s
);

2424  
»s
;

2426 
out_nomem
:

2427 
»s
 = -
ENOMEM
;

2429 
out_”r
:

2430 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2431 
	`sc¡_tgt_sysfs_d–
(
tgt
);

2432 
	`mu‹x_lock
(&
sc¡_mu‹x
);

2433 
out
;

2434 
	}
}

2441 
	$sc¡_tgt_sysfs_d–
(
sc¡_tgt
 *
tgt
)

2443 
rc
;

2444 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

2446 
	`TRACE_ENTRY
();

2448 
tgt
->
tgt_kobj_»Ëa£_cm¶
 = &
c
;

2450 
	`kobjeù_d–
(
tgt
->
tgt_£ss_kobj
);

2451 
	`kobjeù_d–
(
tgt
->
tgt_luns_kobj
);

2452 
	`kobjeù_d–
(
tgt
->
tgt_ši_g½_kobj
);

2453 
	`kobjeù_d–
(&
tgt
->
tgt_kobj
);

2455 
	`kobjeù_put
(
tgt
->
tgt_£ss_kobj
);

2456 
	`kobjeù_put
(
tgt
->
tgt_luns_kobj
);

2457 
	`kobjeù_put
(
tgt
->
tgt_ši_g½_kobj
);

2458 
	`kobjeù_put
(&
tgt
->
tgt_kobj
);

2460 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(
tgt
->
tgt_kobj_»Ëa£_cm¶
, 
HZ
);

2461 ià(
rc
 == 0) {

2462 
	`PRINT_INFO
("Waiting for„eleasing sysfsƒntry "

2463 "fÜ¬g‘ % (%d„efs)...", 
tgt
->
tgt_Çme
,

2464 
	`©omic_»ad
(&
tgt
->
tgt_kobj
.
k»f
.
»fcouÁ
));

2465 
	`wa™_fÜ_com¶‘iÚ
(
tgt
->
tgt_kobj_»Ëa£_cm¶
);

2466 
	`PRINT_INFO
("Done waiting for„eleasing sysfs "

2467 "’Œy fÜ¬g‘ %s", 
tgt
->
tgt_Çme
);

2470 
	`TRACE_EXIT
();

2472 
	}
}

2478 
ssize_t
 
	$sc¡_dev_sysfs_ty³_show
(
kobjeù
 *
kobj
,

2479 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2481 
pos
 = 0;

2483 
sc¡_deviû
 *
dev
;

2485 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

2487 
pos
 = 
	`¥rštf
(
buf
, "%d - %s\n", 
dev
->
ty³
,

2488 ()
dev
->
ty³
 >ð
	`ARRAY_SIZE
(
sc¡_dev_hªdËr_ty³s
) ?

2489 "unknown" : 
sc¡_dev_hªdËr_ty³s
[
dev
->
ty³
]);

2491  
pos
;

2492 
	}
}

2494 
kobj_©Œibu‹
 
	gdev_ty³_©Œ
 =

2495 
__ATTR
(
ty³
, 
S_IRUGO
, 
sc¡_dev_sysfs_ty³_show
, 
NULL
);

2497 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

2499 
ssize_t
 
	$sc¡_dev_sysfs_dump_´s
(
kobjeù
 *
kobj
,

2500 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2502 
sc¡_deviû
 *
dev
;

2504 
	`TRACE_ENTRY
();

2506 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

2508 
	`sc¡_´_dump_´s
(
dev
, 
Œue
);

2510 
	`TRACE_EXIT_RES
(
couÁ
);

2511  
couÁ
;

2512 
	}
}

2514 
kobj_©Œibu‹
 
	gdev_dump_´s_©Œ
 =

2515 
__ATTR
(
dump_´s
, 
S_IWUSR
, 
NULL
, 
sc¡_dev_sysfs_dump_´s
);

2519 
	$sc¡_´oûss_dev_sysfs_th»ads_d©a_¡Üe
(

2520 
sc¡_deviû
 *
dev
, 
th»ads_num
,

2521 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
th»ads_poÞ_ty³
)

2523 
»s
 = 0;

2524 
ÞdŠ
 = 
dev
->
th»ads_num
;

2525 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
Þd‰
 = 
dev
->
th»ads_poÞ_ty³
;

2527 
	`TRACE_ENTRY
();

2529 
	`TRACE_DBG
("dev %p,h»ads_num %d,h»ads_poÞ_ty³ %d", 
dev
,

2530 
th»ads_num
, 
th»ads_poÞ_ty³
);

2532 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

2533 ià(
»s
 != 0)

2534 
out
;

2536 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

2537 ià(
»s
 != 0)

2538 
out_»sume
;

2541 ià(
	`sc¡_check_dev_±r
(
dev
) != 0)

2542 
out_uÆock
;

2544 
	`sc¡_¡Ý_dev_th»ads
(
dev
);

2546 
dev
->
th»ads_num
 =hreads_num;

2547 
dev
->
th»ads_poÞ_ty³
 =hreads_pool_type;

2549 
»s
 = 
	`sc¡_ü—‹_dev_th»ads
(
dev
);

2550 ià(
»s
 != 0)

2551 
out_uÆock
;

2553 ià(
ÞdŠ
 !ð
dev
->
th»ads_num
)

2554 
	`PRINT_INFO
("Chªged cmdh»ad numØ%d", 
dev
->
th»ads_num
);

2555 ià(
Þd‰
 !ð
dev
->
th»ads_poÞ_ty³
)

2556 
	`PRINT_INFO
("Changed cmdhreads…oolypeo %d",

2557 
dev
->
th»ads_poÞ_ty³
);

2559 
out_uÆock
:

2560 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

2562 
out_»sume
:

2563 
	`sc¡_»sume_aùiv™y
();

2565 
out
:

2566 
	`TRACE_EXIT_RES
(
»s
);

2567  
»s
;

2568 
	}
}

2570 
	$sc¡_dev_sysfs_th»ads_d©a_¡Üe_wÜk_â
(

2571 
sc¡_sysfs_wÜk_™em
 *
wÜk
)

2573  
	`sc¡_´oûss_dev_sysfs_th»ads_d©a_¡Üe
(
wÜk
->
dev
,

2574 
wÜk
->
Ãw_th»ads_num
, wÜk->
Ãw_th»ads_poÞ_ty³
);

2575 
	}
}

2577 
ssize_t
 
	$sc¡_dev_sysfs_check_th»ads_d©a
(

2578 
sc¡_deviû
 *
dev
, 
th»ads_num
,

2579 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
th»ads_poÞ_ty³
, 
boÞ
 *
¡Ý
)

2581 
»s
 = 0;

2583 
	`TRACE_ENTRY
();

2585 *
¡Ý
 = 
çl£
;

2587 ià(
dev
->
th»ads_num
 < 0) {

2588 
	`PRINT_ERROR
("Threads…ool disabled for device %s",

2589 
dev
->
vœt_Çme
);

2590 
»s
 = -
EPERM
;

2591 
out
;

2594 ià((
th»ads_num
 =ð
dev
->threads_num) &&

2595 (
th»ads_poÞ_ty³
 =ð
dev
->threads_pool_type)) {

2596 *
¡Ý
 = 
Œue
;

2597 
out
;

2600 
out
:

2601 
	`TRACE_EXIT_RES
(
»s
);

2602  
»s
;

2603 
	}
}

2605 
ssize_t
 
	$sc¡_dev_sysfs_th»ads_num_show
(
kobjeù
 *
kobj
,

2606 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2608 
pos
 = 0;

2609 
sc¡_deviû
 *
dev
;

2611 
	`TRACE_ENTRY
();

2613 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

2615 
pos
 = 
	`¥rštf
(
buf
, "%d\n%s", 
dev
->
th»ads_num
,

2616 (
dev
->
th»ads_num
 !ðdev->
hªdËr
->threads_num) ?

2617 
SCST_SYSFS_KEY_MARK
 "\n" : "");

2619 
	`TRACE_EXIT_RES
(
pos
);

2620  
pos
;

2621 
	}
}

2623 
ssize_t
 
	$sc¡_dev_sysfs_th»ads_num_¡Üe
(
kobjeù
 *
kobj
,

2624 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2626 
»s
;

2627 
sc¡_deviû
 *
dev
;

2628 
ÃwŠ
;

2629 
boÞ
 
¡Ý
;

2630 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

2632 
	`TRACE_ENTRY
();

2634 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

2636 
»s
 = 
	`¡riù_¡¹Þ
(
buf
, 0, &
ÃwŠ
);

2637 ià(
»s
 != 0) {

2638 
	`PRINT_ERROR
("¡riù_¡¹Þ(èfÜ % çžed: %d ", 
buf
, 
»s
);

2639 
out
;

2641 ià(
ÃwŠ
 < 0) {

2642 
	`PRINT_ERROR
("IÎeg®h»ad num v®u%ld", 
ÃwŠ
);

2643 
»s
 = -
EINVAL
;

2644 
out
;

2647 
»s
 = 
	`sc¡_dev_sysfs_check_th»ads_d©a
(
dev
, 
ÃwŠ
,

2648 
dev
->
th»ads_poÞ_ty³
, &
¡Ý
);

2649 ià((
»s
 !ð0è|| 
¡Ý
)

2650 
out
;

2652 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_dev_sysfs_th»ads_d©a_¡Üe_wÜk_â
,

2653 
çl£
, &
wÜk
);

2654 ià(
»s
 != 0)

2655 
out
;

2657 
wÜk
->
dev
 = dev;

2658 
wÜk
->
Ãw_th»ads_num
 = 
ÃwŠ
;

2659 
wÜk
->
Ãw_th»ads_poÞ_ty³
 = 
dev
->
th»ads_poÞ_ty³
;

2661 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

2663 
out
:

2664 ià(
»s
 == 0)

2665 
»s
 = 
couÁ
;

2667 
	`TRACE_EXIT_RES
(
»s
);

2668  
»s
;

2669 
	}
}

2671 
kobj_©Œibu‹
 
	gdev_th»ads_num_©Œ
 =

2672 
__ATTR
(
th»ads_num
, 
S_IRUGO
 | 
S_IWUSR
,

2673 
sc¡_dev_sysfs_th»ads_num_show
,

2674 
sc¡_dev_sysfs_th»ads_num_¡Üe
);

2676 
ssize_t
 
	$sc¡_dev_sysfs_th»ads_poÞ_ty³_show
(
kobjeù
 *
kobj
,

2677 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

2679 
pos
 = 0;

2680 
sc¡_deviû
 *
dev
;

2682 
	`TRACE_ENTRY
();

2684 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

2686 ià(
dev
->
th»ads_num
 == 0) {

2687 
pos
 = 
	`¥rštf
(
buf
, "Async\n");

2688 
out
;

2689 } ià(
dev
->
th»ads_num
 < 0) {

2690 
pos
 = 
	`¥rštf
(
buf
, "Not valid\n");

2691 
out
;

2694 
dev
->
th»ads_poÞ_ty³
) {

2695 
SCST_THREADS_POOL_PER_INITIATOR
:

2696 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
SCST_THREADS_POOL_PER_INITIATOR_STR
,

2697 (
dev
->
th»ads_poÞ_ty³
 !ðdev->
hªdËr
->threads_pool_type) ?

2698 
SCST_SYSFS_KEY_MARK
 "\n" : "");

2700 
SCST_THREADS_POOL_SHARED
:

2701 
pos
 = 
	`¥rštf
(
buf
, "%s\n%s", 
SCST_THREADS_POOL_SHARED_STR
,

2702 (
dev
->
th»ads_poÞ_ty³
 !ðdev->
hªdËr
->threads_pool_type) ?

2703 
SCST_SYSFS_KEY_MARK
 "\n" : "");

2706 
pos
 = 
	`¥rštf
(
buf
, "Unknown\n");

2710 
out
:

2711 
	`TRACE_EXIT_RES
(
pos
);

2712  
pos
;

2713 
	}
}

2715 
ssize_t
 
	$sc¡_dev_sysfs_th»ads_poÞ_ty³_¡Üe
(
kobjeù
 *
kobj
,

2716 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2718 
»s
;

2719 
sc¡_deviû
 *
dev
;

2720 
sc¡_dev_ty³_th»ads_poÞ_ty³
 
Ãwt
;

2721 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

2722 
boÞ
 
¡Ý
;

2724 
	`TRACE_ENTRY
();

2726 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

2728 
Ãwt
 = 
	`sc¡_·r£_th»ads_poÞ_ty³
(
buf
, 
couÁ
);

2729 ià(
Ãwt
 =ð
SCST_THREADS_POOL_TYPE_INVALID
) {

2730 
	`PRINT_ERROR
("IÎeg®h»ad poÞy³ %s", 
buf
);

2731 
»s
 = -
EINVAL
;

2732 
out
;

2735 
	`TRACE_DBG
("buà%s, couÁ %zd,‚ewˆ%d", 
buf
, 
couÁ
, 
Ãwt
);

2737 
»s
 = 
	`sc¡_dev_sysfs_check_th»ads_d©a
(
dev
, dev->
th»ads_num
,

2738 
Ãwt
, &
¡Ý
);

2739 ià((
»s
 !ð0è|| 
¡Ý
)

2740 
out
;

2742 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_dev_sysfs_th»ads_d©a_¡Üe_wÜk_â
,

2743 
çl£
, &
wÜk
);

2744 ià(
»s
 != 0)

2745 
out
;

2747 
wÜk
->
dev
 = dev;

2748 
wÜk
->
Ãw_th»ads_num
 = 
dev
->
th»ads_num
;

2749 
wÜk
->
Ãw_th»ads_poÞ_ty³
 = 
Ãwt
;

2751 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

2753 
out
:

2754 ià(
»s
 == 0)

2755 
»s
 = 
couÁ
;

2757 
	`TRACE_EXIT_RES
(
»s
);

2758  
»s
;

2759 
	}
}

2761 
kobj_©Œibu‹
 
	gdev_th»ads_poÞ_ty³_©Œ
 =

2762 
__ATTR
(
th»ads_poÞ_ty³
, 
S_IRUGO
 | 
S_IWUSR
,

2763 
sc¡_dev_sysfs_th»ads_poÞ_ty³_show
,

2764 
sc¡_dev_sysfs_th»ads_poÞ_ty³_¡Üe
);

2766 
©Œibu‹
 *
	gsc¡_dev_©Œs
[] = {

2767 &
dev_ty³_©Œ
.
©Œ
,

2768 
NULL
,

2771 
	$sc¡_sysfs_dev_»Ëa£
(
kobjeù
 *
kobj
)

2773 
sc¡_deviû
 *
dev
;

2775 
	`TRACE_ENTRY
();

2777 
dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_deviû
, 
dev_kobj
);

2778 ià(
dev
->
dev_kobj_»Ëa£_cm¶
)

2779 
	`com¶‘e_®l
(
dev
->
dev_kobj_»Ëa£_cm¶
);

2781 
	`TRACE_EXIT
();

2783 
	}
}

2785 
	$sc¡_devt_dev_sysfs_ü—‹
(
sc¡_deviû
 *
dev
)

2787 
»s
 = 0;

2789 
	`TRACE_ENTRY
();

2791 ià(
dev
->
hªdËr
 =ð&
sc¡_nuÎ_devty³
)

2792 
out
;

2794 
»s
 = 
	`sysfs_ü—‹_lšk
(&
dev
->
dev_kobj
,

2795 &
dev
->
hªdËr
->
devt_kobj
, "handler");

2796 ià(
»s
 != 0) {

2797 
	`PRINT_ERROR
("Can't create handler†ink for dev %s",

2798 
dev
->
vœt_Çme
);

2799 
out
;

2802 
»s
 = 
	`sysfs_ü—‹_lšk
(&
dev
->
hªdËr
->
devt_kobj
,

2803 &
dev
->
dev_kobj
, dev->
vœt_Çme
);

2804 ià(
»s
 != 0) {

2805 
	`PRINT_ERROR
("Can't create handler†ink for dev %s",

2806 
dev
->
vœt_Çme
);

2807 
out_”r
;

2810 ià(
dev
->
hªdËr
->
th»ads_num
 >= 0) {

2811 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
,

2812 &
dev_th»ads_num_©Œ
.
©Œ
);

2813 ià(
»s
 != 0) {

2814 
	`PRINT_ERROR
("Can't‡dd dev‡ttr %s for dev %s",

2815 
dev_th»ads_num_©Œ
.
©Œ
.
Çme
,

2816 
dev
->
vœt_Çme
);

2817 
out_”r
;

2819 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
,

2820 &
dev_th»ads_poÞ_ty³_©Œ
.
©Œ
);

2821 ià(
»s
 != 0) {

2822 
	`PRINT_ERROR
("Can't‡dd dev‡ttr %s for dev %s",

2823 
dev_th»ads_poÞ_ty³_©Œ
.
©Œ
.
Çme
,

2824 
dev
->
vœt_Çme
);

2825 
out_”r
;

2829 ià(
dev
->
hªdËr
->
dev_©Œs
) {

2830 
»s
 = 
	`sysfs_ü—‹_fžes
(&
dev
->
dev_kobj
,

2831 
dev
->
hªdËr
->
dev_©Œs
);

2832 ià(
»s
 != 0) {

2833 
	`PRINT_ERROR
("Can't‡dd dev‡ttributes for dev %s",

2834 
dev
->
vœt_Çme
);

2835 
out_”r
;

2839 
out
:

2840 
	`TRACE_EXIT_RES
(
»s
);

2841  
»s
;

2843 
out_”r
:

2844 
	`sc¡_devt_dev_sysfs_d–
(
dev
);

2845 
out
;

2846 
	}
}

2848 
	$sc¡_devt_dev_sysfs_d–
(
sc¡_deviû
 *
dev
)

2850 
	`TRACE_ENTRY
();

2852 ià(
dev
->
hªdËr
 =ð&
sc¡_nuÎ_devty³
)

2853 
out
;

2855 ià(
dev
->
hªdËr
->
dev_©Œs
)

2856 
	`sysfs_»move_fžes
(&
dev
->
dev_kobj
, dev->
hªdËr
->
dev_©Œs
);

2858 
	`sysfs_»move_lšk
(&
dev
->
dev_kobj
, "handler");

2859 
	`sysfs_»move_lšk
(&
dev
->
hªdËr
->
devt_kobj
, dev->
vœt_Çme
);

2861 ià(
dev
->
hªdËr
->
th»ads_num
 >= 0) {

2862 
	`sysfs_»move_fže
(&
dev
->
dev_kobj
,

2863 &
dev_th»ads_num_©Œ
.
©Œ
);

2864 
	`sysfs_»move_fže
(&
dev
->
dev_kobj
,

2865 &
dev_th»ads_poÞ_ty³_©Œ
.
©Œ
);

2868 
out
:

2869 
	`TRACE_EXIT
();

2871 
	}
}

2873 
kobj_ty³
 
	gsc¡_dev_kty³
 = {

2874 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

2875 .
	g»Ëa£
 = 
sc¡_sysfs_dev_»Ëa£
,

2876 .
	gdeçuÉ_©Œs
 = 
sc¡_dev_©Œs
,

2883 
	$sc¡_dev_sysfs_ü—‹
(
sc¡_deviû
 *
dev
)

2885 
»s
 = 0;

2887 
	`TRACE_ENTRY
();

2889 
»s
 = 
	`kobjeù_š™_ªd_add
(&
dev
->
dev_kobj
, &
sc¡_dev_kty³
,

2890 
sc¡_deviûs_kobj
, 
dev
->
vœt_Çme
);

2891 ià(
»s
 != 0) {

2892 
	`PRINT_ERROR
("Cª'ˆadd deviû % tØsysfs", 
dev
->
vœt_Çme
);

2893 
out
;

2896 
dev
->
dev_exp_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("exported",

2897 &
dev
->
dev_kobj
);

2898 ià(
dev
->
dev_exp_kobj
 =ð
NULL
) {

2899 
	`PRINT_ERROR
("Can't createƒxported†ink for device %s",

2900 
dev
->
vœt_Çme
);

2901 
»s
 = -
ENOMEM
;

2902 
out_d–
;

2905 ià(
dev
->
scsi_dev
 !ð
NULL
) {

2906 
»s
 = 
	`sysfs_ü—‹_lšk
(&
dev
->
dev_kobj
,

2907 &
dev
->
scsi_dev
->
sdev_dev
.
kobj
, "scsi_device");

2908 ià(
»s
 != 0) {

2909 
	`PRINT_ERROR
("Can't create scsi_device†ink for dev %s",

2910 
dev
->
vœt_Çme
);

2911 
out_d–
;

2915 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

2916 ià(
dev
->
scsi_dev
 =ð
NULL
) {

2917 
»s
 = 
	`sysfs_ü—‹_fže
(&
dev
->
dev_kobj
,

2918 &
dev_dump_´s_©Œ
.
©Œ
);

2919 ià(
»s
 != 0) {

2920 
	`PRINT_ERROR
("Can't create‡ttr %s for dev %s",

2921 
dev_dump_´s_©Œ
.
©Œ
.
Çme
, 
dev
->
vœt_Çme
);

2922 
out_d–
;

2927 
out
:

2928 
	`TRACE_EXIT_RES
(
»s
);

2929  
»s
;

2931 
out_d–
:

2932 
	`sc¡_dev_sysfs_d–
(
dev
);

2933 
out
;

2934 
	}
}

2941 
	$sc¡_dev_sysfs_d–
(
sc¡_deviû
 *
dev
)

2943 
rc
;

2944 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

2946 
	`TRACE_ENTRY
();

2948 
dev
->
dev_kobj_»Ëa£_cm¶
 = &
c
;

2950 
	`kobjeù_d–
(
dev
->
dev_exp_kobj
);

2951 
	`kobjeù_d–
(&
dev
->
dev_kobj
);

2953 
	`kobjeù_put
(
dev
->
dev_exp_kobj
);

2954 
	`kobjeù_put
(&
dev
->
dev_kobj
);

2956 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(
dev
->
dev_kobj_»Ëa£_cm¶
, 
HZ
);

2957 ià(
rc
 == 0) {

2958 
	`PRINT_INFO
("Waiting for„eleasing sysfsƒntry "

2959 "fÜ deviû % (%d„efs)...", 
dev
->
vœt_Çme
,

2960 
	`©omic_»ad
(&
dev
->
dev_kobj
.
k»f
.
»fcouÁ
));

2961 
	`wa™_fÜ_com¶‘iÚ
(
dev
->
dev_kobj_»Ëa£_cm¶
);

2962 
	`PRINT_INFO
("Done waiting for„eleasing sysfs "

2963 "’Œy fÜ deviû %s", 
dev
->
vœt_Çme
);

2966 
	`TRACE_EXIT
();

2968 
	}
}

2974 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


2976 *
	gsc¡_io_size_Çmes
[] = {

2984 
ssize_t
 
	$sc¡_tgt_dev_Ï‹ncy_show
(
kobjeù
 *
kobj
,

2985 
kobj_©Œibu‹
 *
©Œ
, *
bufãr
)

2987 
»s
 = 0, 
i
;

2988 
buf
[50];

2989 
sc¡_tgt_dev
 *
tgt_dev
;

2991 
	`TRACE_ENTRY
();

2993 
tgt_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_dev
, 
tgt_dev_kobj
);

2995 
i
 = 0; i < 
SCST_LATENCY_STATS_NUM
; i++) {

2996 
ušt64_t
 
sc¡_time_wr
, 
tgt_time_wr
, 
dev_time_wr
;

2997 
´oûs£d_cmds_wr
;

2998 
ušt64_t
 
sc¡_time_rd
, 
tgt_time_rd
, 
dev_time_rd
;

2999 
´oûs£d_cmds_rd
;

3000 
sc¡_ext_Ï‹ncy_¡©
 *
Ï‹ncy_¡©
;

3002 
Ï‹ncy_¡©
 = &
tgt_dev
->
dev_Ï‹ncy_¡©
[
i
];

3003 
sc¡_time_wr
 = 
Ï‹ncy_¡©
->scst_time_wr;

3004 
sc¡_time_rd
 = 
Ï‹ncy_¡©
->scst_time_rd;

3005 
tgt_time_wr
 = 
Ï‹ncy_¡©
->tgt_time_wr;

3006 
tgt_time_rd
 = 
Ï‹ncy_¡©
->tgt_time_rd;

3007 
dev_time_wr
 = 
Ï‹ncy_¡©
->dev_time_wr;

3008 
dev_time_rd
 = 
Ï‹ncy_¡©
->dev_time_rd;

3009 
´oûs£d_cmds_wr
 = 
Ï‹ncy_¡©
->processed_cmds_wr;

3010 
´oûs£d_cmds_rd
 = 
Ï‹ncy_¡©
->processed_cmds_rd;

3012 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3013 "%-5 %-9 %-15lu ", "Wr™e", 
sc¡_io_size_Çmes
[
i
],

3014 ()
´oûs£d_cmds_wr
);

3015 ià(
´oûs£d_cmds_wr
 == 0)

3016 
´oûs£d_cmds_wr
 = 1;

3018 
	`do_div
(
sc¡_time_wr
, 
´oûs£d_cmds_wr
);

3019 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3020 ()
Ï‹ncy_¡©
->
mš_sc¡_time_wr
,

3021 ()
sc¡_time_wr
,

3022 ()
Ï‹ncy_¡©
->
max_sc¡_time_wr
,

3023 ()
Ï‹ncy_¡©
->
sc¡_time_wr
);

3024 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3025 "%-47s", 
buf
);

3027 
	`do_div
(
tgt_time_wr
, 
´oûs£d_cmds_wr
);

3028 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3029 ()
Ï‹ncy_¡©
->
mš_tgt_time_wr
,

3030 ()
tgt_time_wr
,

3031 ()
Ï‹ncy_¡©
->
max_tgt_time_wr
,

3032 ()
Ï‹ncy_¡©
->
tgt_time_wr
);

3033 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3034 "%-47s", 
buf
);

3036 
	`do_div
(
dev_time_wr
, 
´oûs£d_cmds_wr
);

3037 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3038 ()
Ï‹ncy_¡©
->
mš_dev_time_wr
,

3039 ()
dev_time_wr
,

3040 ()
Ï‹ncy_¡©
->
max_dev_time_wr
,

3041 ()
Ï‹ncy_¡©
->
dev_time_wr
);

3042 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3043 "%-47s\n", 
buf
);

3045 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3046 "%-5 %-9 %-15lu ", "R—d", 
sc¡_io_size_Çmes
[
i
],

3047 ()
´oûs£d_cmds_rd
);

3048 ià(
´oûs£d_cmds_rd
 == 0)

3049 
´oûs£d_cmds_rd
 = 1;

3051 
	`do_div
(
sc¡_time_rd
, 
´oûs£d_cmds_rd
);

3052 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3053 ()
Ï‹ncy_¡©
->
mš_sc¡_time_rd
,

3054 ()
sc¡_time_rd
,

3055 ()
Ï‹ncy_¡©
->
max_sc¡_time_rd
,

3056 ()
Ï‹ncy_¡©
->
sc¡_time_rd
);

3057 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3058 "%-47s", 
buf
);

3060 
	`do_div
(
tgt_time_rd
, 
´oûs£d_cmds_rd
);

3061 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3062 ()
Ï‹ncy_¡©
->
mš_tgt_time_rd
,

3063 ()
tgt_time_rd
,

3064 ()
Ï‹ncy_¡©
->
max_tgt_time_rd
,

3065 ()
Ï‹ncy_¡©
->
tgt_time_rd
);

3066 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3067 "%-47s", 
buf
);

3069 
	`do_div
(
dev_time_rd
, 
´oûs£d_cmds_rd
);

3070 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3071 ()
Ï‹ncy_¡©
->
mš_dev_time_rd
,

3072 ()
dev_time_rd
,

3073 ()
Ï‹ncy_¡©
->
max_dev_time_rd
,

3074 ()
Ï‹ncy_¡©
->
dev_time_rd
);

3075 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3076 "%-47s\n", 
buf
);

3079 
	`TRACE_EXIT_RES
(
»s
);

3080  
»s
;

3081 
	}
}

3083 
kobj_©Œibu‹
 
	gtgt_dev_Ï‹ncy_©Œ
 =

3084 
__ATTR
(
Ï‹ncy
, 
S_IRUGO
,

3085 
sc¡_tgt_dev_Ï‹ncy_show
, 
NULL
);

3089 
ssize_t
 
	$sc¡_tgt_dev_aùive_commªds_show
(
kobjeù
 *
kobj
,

3090 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3092 
pos
 = 0;

3093 
sc¡_tgt_dev
 *
tgt_dev
;

3095 
tgt_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_dev
, 
tgt_dev_kobj
);

3097 
pos
 = 
	`¥rštf
(
buf
, "%d\n", 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_cmd_couÁ
));

3099  
pos
;

3100 
	}
}

3102 
kobj_©Œibu‹
 
	gtgt_dev_aùive_commªds_©Œ
 =

3103 
__ATTR
(
aùive_commªds
, 
S_IRUGO
,

3104 
sc¡_tgt_dev_aùive_commªds_show
, 
NULL
);

3106 
©Œibu‹
 *
	gsc¡_tgt_dev_©Œs
[] = {

3107 &
tgt_dev_aùive_commªds_©Œ
.
©Œ
,

3108 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


3109 &
tgt_dev_Ï‹ncy_©Œ
.
©Œ
,

3111 
NULL
,

3114 
	$sc¡_sysfs_tgt_dev_»Ëa£
(
kobjeù
 *
kobj
)

3116 
sc¡_tgt_dev
 *
tgt_dev
;

3118 
	`TRACE_ENTRY
();

3120 
tgt_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tgt_dev
, 
tgt_dev_kobj
);

3121 ià(
tgt_dev
->
tgt_dev_kobj_»Ëa£_cm¶
)

3122 
	`com¶‘e_®l
(
tgt_dev
->
tgt_dev_kobj_»Ëa£_cm¶
);

3124 
	`TRACE_EXIT
();

3126 
	}
}

3128 
kobj_ty³
 
	gsc¡_tgt_dev_kty³
 = {

3129 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

3130 .
	g»Ëa£
 = 
sc¡_sysfs_tgt_dev_»Ëa£
,

3131 .
	gdeçuÉ_©Œs
 = 
sc¡_tgt_dev_©Œs
,

3134 
	$sc¡_tgt_dev_sysfs_ü—‹
(
sc¡_tgt_dev
 *
tgt_dev
)

3136 
»s
 = 0;

3138 
	`TRACE_ENTRY
();

3140 
»s
 = 
	`kobjeù_š™_ªd_add
(&
tgt_dev
->
tgt_dev_kobj
, &
sc¡_tgt_dev_kty³
,

3141 &
tgt_dev
->
£ss
->
£ss_kobj
, "lun%lld",

3142 ()
tgt_dev
->
lun
);

3143 ià(
»s
 != 0) {

3144 
	`PRINT_ERROR
("Can't‡ddgt_dev %lldo sysfs",

3145 ()
tgt_dev
->
lun
);

3146 
out
;

3149 
out
:

3150 
	`TRACE_EXIT_RES
(
»s
);

3151  
»s
;

3152 
	}
}

3161 
	$sc¡_tgt_dev_sysfs_d–
(
sc¡_tgt_dev
 *
tgt_dev
)

3163 
rc
;

3164 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

3166 
	`TRACE_ENTRY
();

3168 
tgt_dev
->
tgt_dev_kobj_»Ëa£_cm¶
 = &
c
;

3170 
	`kobjeù_d–
(&
tgt_dev
->
tgt_dev_kobj
);

3171 
	`kobjeù_put
(&
tgt_dev
->
tgt_dev_kobj
);

3173 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(

3174 
tgt_dev
->
tgt_dev_kobj_»Ëa£_cm¶
, 
HZ
);

3175 ià(
rc
 == 0) {

3176 
	`PRINT_INFO
("Waiting for„eleasing sysfsƒntry "

3178 ()
tgt_dev
->
lun
,

3179 
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_kobj
.
k»f
.
»fcouÁ
));

3180 
	`wa™_fÜ_com¶‘iÚ
(
tgt_dev
->
tgt_dev_kobj_»Ëa£_cm¶
);

3181 
	`PRINT_INFO
("Done waiting for„eleasing sysfsƒntry for "

3182 "tgt_dev %Îd", ()
tgt_dev
->
lun
);

3185 
	`TRACE_EXIT
();

3187 
	}
}

3193 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


3195 
ssize_t
 
	$sc¡_£ss_Ï‹ncy_show
(
kobjeù
 *
kobj
,

3196 
kobj_©Œibu‹
 *
©Œ
, *
bufãr
)

3198 
ssize_t
 
»s
 = 0;

3199 
sc¡_£ssiÚ
 *
£ss
;

3200 
i
;

3201 
buf
[50];

3202 
ušt64_t
 
sc¡_time
, 
tgt_time
, 
dev_time
;

3203 
´oûs£d_cmds
;

3205 
	`TRACE_ENTRY
();

3207 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

3209 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3214 
	`¥š_lock_bh
(&
£ss
->
Ït_lock
);

3216 
i
 = 0; i < 
SCST_LATENCY_STATS_NUM
 ; i++) {

3217 
ušt64_t
 
sc¡_time_wr
, 
tgt_time_wr
, 
dev_time_wr
;

3218 
´oûs£d_cmds_wr
;

3219 
ušt64_t
 
sc¡_time_rd
, 
tgt_time_rd
, 
dev_time_rd
;

3220 
´oûs£d_cmds_rd
;

3221 
sc¡_ext_Ï‹ncy_¡©
 *
Ï‹ncy_¡©
;

3223 
Ï‹ncy_¡©
 = &
£ss
->
£ss_Ï‹ncy_¡©
[
i
];

3224 
sc¡_time_wr
 = 
Ï‹ncy_¡©
->scst_time_wr;

3225 
sc¡_time_rd
 = 
Ï‹ncy_¡©
->scst_time_rd;

3226 
tgt_time_wr
 = 
Ï‹ncy_¡©
->tgt_time_wr;

3227 
tgt_time_rd
 = 
Ï‹ncy_¡©
->tgt_time_rd;

3228 
dev_time_wr
 = 
Ï‹ncy_¡©
->dev_time_wr;

3229 
dev_time_rd
 = 
Ï‹ncy_¡©
->dev_time_rd;

3230 
´oûs£d_cmds_wr
 = 
Ï‹ncy_¡©
->processed_cmds_wr;

3231 
´oûs£d_cmds_rd
 = 
Ï‹ncy_¡©
->processed_cmds_rd;

3233 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3235 "Wr™e", 
sc¡_io_size_Çmes
[
i
],

3236 ()
´oûs£d_cmds_wr
);

3237 ià(
´oûs£d_cmds_wr
 == 0)

3238 
´oûs£d_cmds_wr
 = 1;

3240 
	`do_div
(
sc¡_time_wr
, 
´oûs£d_cmds_wr
);

3241 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3242 ()
Ï‹ncy_¡©
->
mš_sc¡_time_wr
,

3243 ()
sc¡_time_wr
,

3244 ()
Ï‹ncy_¡©
->
max_sc¡_time_wr
,

3245 ()
Ï‹ncy_¡©
->
sc¡_time_wr
);

3246 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3247 "%-47s", 
buf
);

3249 
	`do_div
(
tgt_time_wr
, 
´oûs£d_cmds_wr
);

3250 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3251 ()
Ï‹ncy_¡©
->
mš_tgt_time_wr
,

3252 ()
tgt_time_wr
,

3253 ()
Ï‹ncy_¡©
->
max_tgt_time_wr
,

3254 ()
Ï‹ncy_¡©
->
tgt_time_wr
);

3255 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3256 "%-47s", 
buf
);

3258 
	`do_div
(
dev_time_wr
, 
´oûs£d_cmds_wr
);

3259 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3260 ()
Ï‹ncy_¡©
->
mš_dev_time_wr
,

3261 ()
dev_time_wr
,

3262 ()
Ï‹ncy_¡©
->
max_dev_time_wr
,

3263 ()
Ï‹ncy_¡©
->
dev_time_wr
);

3264 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3265 "%-47s\n", 
buf
);

3267 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3269 "R—d", 
sc¡_io_size_Çmes
[
i
],

3270 ()
´oûs£d_cmds_rd
);

3271 ià(
´oûs£d_cmds_rd
 == 0)

3272 
´oûs£d_cmds_rd
 = 1;

3274 
	`do_div
(
sc¡_time_rd
, 
´oûs£d_cmds_rd
);

3275 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3276 ()
Ï‹ncy_¡©
->
mš_sc¡_time_rd
,

3277 ()
sc¡_time_rd
,

3278 ()
Ï‹ncy_¡©
->
max_sc¡_time_rd
,

3279 ()
Ï‹ncy_¡©
->
sc¡_time_rd
);

3280 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3281 "%-47s", 
buf
);

3283 
	`do_div
(
tgt_time_rd
, 
´oûs£d_cmds_rd
);

3284 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3285 ()
Ï‹ncy_¡©
->
mš_tgt_time_rd
,

3286 ()
tgt_time_rd
,

3287 ()
Ï‹ncy_¡©
->
max_tgt_time_rd
,

3288 ()
Ï‹ncy_¡©
->
tgt_time_rd
);

3289 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3290 "%-47s", 
buf
);

3292 
	`do_div
(
dev_time_rd
, 
´oûs£d_cmds_rd
);

3293 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3294 ()
Ï‹ncy_¡©
->
mš_dev_time_rd
,

3295 ()
dev_time_rd
,

3296 ()
Ï‹ncy_¡©
->
max_dev_time_rd
,

3297 ()
Ï‹ncy_¡©
->
dev_time_rd
);

3298 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3299 "%-47s\n", 
buf
);

3302 
sc¡_time
 = 
£ss
->scst_time;

3303 
tgt_time
 = 
£ss
->tgt_time;

3304 
dev_time
 = 
£ss
->dev_time;

3305 
´oûs£d_cmds
 = 
£ss
->processed_cmds;

3307 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3308 "\n%-15 %-16d", "Ov”®È", 
´oûs£d_cmds
);

3310 ià(
´oûs£d_cmds
 == 0)

3311 
´oûs£d_cmds
 = 1;

3313 
	`do_div
(
sc¡_time
, 
´oûs£d_cmds
);

3314 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3315 ()
£ss
->
mš_sc¡_time
,

3316 ()
sc¡_time
,

3317 ()
£ss
->
max_sc¡_time
,

3318 ()
£ss
->
sc¡_time
);

3319 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3320 "%-47s", 
buf
);

3322 
	`do_div
(
tgt_time
, 
´oûs£d_cmds
);

3323 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3324 ()
£ss
->
mš_tgt_time
,

3325 ()
tgt_time
,

3326 ()
£ss
->
max_tgt_time
,

3327 ()
£ss
->
tgt_time
);

3328 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3329 "%-47s", 
buf
);

3331 
	`do_div
(
dev_time
, 
´oûs£d_cmds
);

3332 
	`¢´štf
(
buf
, (buf), "%lu/%lu/%lu/%lu",

3333 ()
£ss
->
mš_dev_time
,

3334 ()
dev_time
,

3335 ()
£ss
->
max_dev_time
,

3336 ()
£ss
->
dev_time
);

3337 
»s
 +ð
	`sú´štf
(&
bufãr
[»s], 
SCST_SYSFS_BLOCK_SIZE
 -„es,

3338 "%-47s\n\n", 
buf
);

3340 
	`¥š_uÆock_bh
(&
£ss
->
Ït_lock
);

3342 
	`TRACE_EXIT_RES
(
»s
);

3343  
»s
;

3344 
	}
}

3346 
	$sc¡_£ss_z”o_Ï‹ncy
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

3348 
»s
 = 0, 
t
;

3349 
sc¡_£ssiÚ
 *
£ss
 = 
wÜk
->sess;

3351 
	`TRACE_ENTRY
();

3353 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

3354 ià(
»s
 != 0)

3355 
out_put
;

3357 
	`PRINT_INFO
("Zeroing†atency statistics for initiator "

3358 "%s", 
£ss
->
š™ŸtÜ_Çme
);

3360 
	`¥š_lock_bh
(&
£ss
->
Ït_lock
);

3362 
£ss
->
sc¡_time
 = 0;

3363 
£ss
->
tgt_time
 = 0;

3364 
£ss
->
dev_time
 = 0;

3365 
£ss
->
mš_sc¡_time
 = 0;

3366 
£ss
->
mš_tgt_time
 = 0;

3367 
£ss
->
mš_dev_time
 = 0;

3368 
£ss
->
max_sc¡_time
 = 0;

3369 
£ss
->
max_tgt_time
 = 0;

3370 
£ss
->
max_dev_time
 = 0;

3371 
£ss
->
´oûs£d_cmds
 = 0;

3372 
	`mem£t
(
£ss
->
£ss_Ï‹ncy_¡©
, 0,

3373 (
£ss
->
£ss_Ï‹ncy_¡©
));

3375 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

3376 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
t
];

3377 
sc¡_tgt_dev
 *
tgt_dev
;

3378 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

3379 
tgt_dev
->
sc¡_time
 = 0;

3380 
tgt_dev
->
tgt_time
 = 0;

3381 
tgt_dev
->
dev_time
 = 0;

3382 
tgt_dev
->
´oûs£d_cmds
 = 0;

3383 
	`mem£t
(
tgt_dev
->
dev_Ï‹ncy_¡©
, 0,

3384 (
tgt_dev
->
dev_Ï‹ncy_¡©
));

3388 
	`¥š_uÆock_bh
(&
£ss
->
Ït_lock
);

3390 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

3392 
out_put
:

3393 
	`kobjeù_put
(&
£ss
->
£ss_kobj
);

3395 
	`TRACE_EXIT_RES
(
»s
);

3396  
»s
;

3397 
	}
}

3399 
ssize_t
 
	$sc¡_£ss_Ï‹ncy_¡Üe
(
kobjeù
 *
kobj
,

3400 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

3402 
»s
;

3403 
sc¡_£ssiÚ
 *
£ss
;

3404 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

3406 
	`TRACE_ENTRY
();

3408 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

3410 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_£ss_z”o_Ï‹ncy
, 
çl£
, &
wÜk
);

3411 ià(
»s
 != 0)

3412 
out
;

3414 
wÜk
->
£ss
 = sess;

3416 
	`kobjeù_g‘
(&
£ss
->
£ss_kobj
);

3418 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

3419 ià(
»s
 == 0)

3420 
»s
 = 
couÁ
;

3422 
out
:

3423 
	`TRACE_EXIT_RES
(
»s
);

3424  
»s
;

3425 
	}
}

3427 
kobj_©Œibu‹
 
	g£ssiÚ_Ï‹ncy_©Œ
 =

3428 
__ATTR
(
Ï‹ncy
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_£ss_Ï‹ncy_show
,

3429 
sc¡_£ss_Ï‹ncy_¡Üe
);

3433 
ssize_t
 
	$sc¡_£ss_sysfs_commªds_show
(
kobjeù
 *
kobj
,

3434 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3436 
sc¡_£ssiÚ
 *
£ss
;

3438 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

3440  
	`¥rštf
(
buf
, "%i\n", 
	`©omic_»ad
(&
£ss
->
£ss_cmd_couÁ
));

3441 
	}
}

3443 
kobj_©Œibu‹
 
	g£ssiÚ_commªds_©Œ
 =

3444 
__ATTR
(
commªds
, 
S_IRUGO
, 
sc¡_£ss_sysfs_commªds_show
, 
NULL
);

3446 
	$sc¡_sysfs_£ss_g‘_aùive_commªds
(
sc¡_£ssiÚ
 *
£ss
)

3448 
»s
;

3449 
aùive_cmds
 = 0, 
t
;

3451 
	`TRACE_ENTRY
();

3453 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

3454 ià(
»s
 != 0)

3455 
out_put
;

3457 
t
 = 
SESS_TGT_DEV_LIST_HASH_SIZE
-1; >= 0;--) {

3458 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
t
];

3459 
sc¡_tgt_dev
 *
tgt_dev
;

3460 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

3461 
aùive_cmds
 +ð
	`©omic_»ad
(&
tgt_dev
->
tgt_dev_cmd_couÁ
);

3465 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

3467 
»s
 = 
aùive_cmds
;

3469 
out_put
:

3470 
	`kobjeù_put
(&
£ss
->
£ss_kobj
);

3472 
	`TRACE_EXIT_RES
(
»s
);

3473  
»s
;

3474 
	}
}

3476 
	$sc¡_sysfs_£ss_g‘_aùive_commªds_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

3478  
	`sc¡_sysfs_£ss_g‘_aùive_commªds
(
wÜk
->
£ss
);

3479 
	}
}

3481 
ssize_t
 
	$sc¡_£ss_sysfs_aùive_commªds_show
(
kobjeù
 *
kobj
,

3482 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3484 
»s
;

3485 
sc¡_£ssiÚ
 *
£ss
;

3486 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

3488 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

3490 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_sysfs_£ss_g‘_aùive_commªds_wÜk_â
,

3491 
Œue
, &
wÜk
);

3492 ià(
»s
 != 0)

3493 
out
;

3495 
wÜk
->
£ss
 = sess;

3497 
	`kobjeù_g‘
(&
£ss
->
£ss_kobj
);

3499 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

3500 ià(
»s
 !ð-
EAGAIN
)

3501 
»s
 = 
	`¥rštf
(
buf
, "%i\n",„es);

3503 
out
:

3504  
»s
;

3505 
	}
}

3507 
kobj_©Œibu‹
 
	g£ssiÚ_aùive_commªds_©Œ
 =

3508 
__ATTR
(
aùive_commªds
, 
S_IRUGO
, 
sc¡_£ss_sysfs_aùive_commªds_show
,

3509 
NULL
);

3511 
ssize_t
 
	$sc¡_£ss_sysfs_š™ŸtÜ_Çme_show
(
kobjeù
 *
kobj
,

3512 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3514 
sc¡_£ssiÚ
 *
£ss
;

3516 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

3518  
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%s\n",

3519 
£ss
->
š™ŸtÜ_Çme
);

3520 
	}
}

3522 
kobj_©Œibu‹
 
	g£ssiÚ_š™ŸtÜ_Çme_©Œ
 =

3523 
__ATTR
(
š™ŸtÜ_Çme
, 
S_IRUGO
, 
sc¡_£ss_sysfs_š™ŸtÜ_Çme_show
,

3524 
NULL
);

3526 
	#SCST_SESS_SYSFS_STAT_ATTR
(
Çme
, 
expÜ‹d_Çme
, 
dœ
, 
kb
) \

3527 
ssize_t
 
sc¡_£ss_sysfs_
##
expÜ‹d_Çme
##
	`_show
(
kobjeù
 *
kobj
, \

3528 
kobj_©Œibu‹
 *
©Œ
, *
buf
) \

3530 
sc¡_£ssiÚ
 *
£ss
; \

3531 
»s
; \

3532 
ušt64_t
 
v
; \

3534 
	`BUILD_BUG_ON
(
SCST_DATA_UNKNOWN
 != 0); \

3535 
	`BUILD_BUG_ON
(
SCST_DATA_WRITE
 != 1); \

3536 
	`BUILD_BUG_ON
(
SCST_DATA_READ
 != 2); \

3537 
	`BUILD_BUG_ON
(
SCST_DATA_BIDI
 != 3); \

3538 
	`BUILD_BUG_ON
(
SCST_DATA_NONE
 != 4); \

3540 
	`BUILD_BUG_ON
(
dœ
 >ð
SCST_DATA_DIR_MAX
); \

3542 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
); \

3543 
v
 = 
£ss
->
io_¡©s
[
dœ
].
Çme
; \

3544 ià(
kb
) \

3545 
v
 >>= 10; \

3546 
»s
 = 
	`¥rštf
(
buf
, "%Îu\n", ()
v
); \

3547  
»s
; \

3550 
ssize_t
 
sc¡_£ss_sysfs_
##
expÜ‹d_Çme
##
	`_¡Üe
(
kobjeù
 *
kobj
, \

3551 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
) \

3553 
sc¡_£ssiÚ
 *
£ss
; \

3554 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
); \

3555 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
); \

3556 
	`BUILD_BUG_ON
(
dœ
 >ð
SCST_DATA_DIR_MAX
); \

3557 
£ss
->
io_¡©s
[
dœ
].
cmd_couÁ
 = 0; \

3558 
£ss
->
io_¡©s
[
dœ
].
io_by‹_couÁ
 = 0; \

3559 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
); \

3560  
couÁ
; \

3563 
kobj_©Œibu‹
 
£ssiÚ_
##
expÜ‹d_Çme
##
_©Œ
 = \

3564 
	`__ATTR
(
expÜ‹d_Çme
, 
S_IRUGO
 | 
S_IWUSR
, \

3565 
sc¡_£ss_sysfs_
##
expÜ‹d_Çme
##
_show
, \

3566 
sc¡_£ss_sysfs_
##
expÜ‹d_Çme
##
_¡Üe
);

	)

3568 
SCST_SESS_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
unknown_cmd_couÁ
, 
SCST_DATA_UNKNOWN
, 0);

3569 
SCST_SESS_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
wr™e_cmd_couÁ
, 
SCST_DATA_WRITE
, 0);

3570 
SCST_SESS_SYSFS_STAT_ATTR
(
io_by‹_couÁ
, 
wr™e_io_couÁ_kb
, 
SCST_DATA_WRITE
, 1);

3571 
SCST_SESS_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
»ad_cmd_couÁ
, 
SCST_DATA_READ
, 0);

3572 
SCST_SESS_SYSFS_STAT_ATTR
(
io_by‹_couÁ
, 
»ad_io_couÁ_kb
, 
SCST_DATA_READ
, 1);

3573 
SCST_SESS_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
bidi_cmd_couÁ
, 
SCST_DATA_BIDI
, 0);

3574 
SCST_SESS_SYSFS_STAT_ATTR
(
io_by‹_couÁ
, 
bidi_io_couÁ_kb
, 
SCST_DATA_BIDI
, 1);

3575 
SCST_SESS_SYSFS_STAT_ATTR
(
cmd_couÁ
, 
nÚe_cmd_couÁ
, 
SCST_DATA_NONE
, 0);

3577 
©Œibu‹
 *
	gsc¡_£ssiÚ_©Œs
[] = {

3578 &
£ssiÚ_commªds_©Œ
.
©Œ
,

3579 &
£ssiÚ_aùive_commªds_©Œ
.
©Œ
,

3580 &
£ssiÚ_š™ŸtÜ_Çme_©Œ
.
©Œ
,

3581 &
£ssiÚ_unknown_cmd_couÁ_©Œ
.
©Œ
,

3582 &
£ssiÚ_wr™e_cmd_couÁ_©Œ
.
©Œ
,

3583 &
£ssiÚ_wr™e_io_couÁ_kb_©Œ
.
©Œ
,

3584 &
£ssiÚ_»ad_cmd_couÁ_©Œ
.
©Œ
,

3585 &
£ssiÚ_»ad_io_couÁ_kb_©Œ
.
©Œ
,

3586 &
£ssiÚ_bidi_cmd_couÁ_©Œ
.
©Œ
,

3587 &
£ssiÚ_bidi_io_couÁ_kb_©Œ
.
©Œ
,

3588 &
£ssiÚ_nÚe_cmd_couÁ_©Œ
.
©Œ
,

3589 #ifdeà
CONFIG_SCST_MEASURE_LATENCY


3590 &
£ssiÚ_Ï‹ncy_©Œ
.
©Œ
,

3592 
NULL
,

3595 
	$sc¡_sysfs_£ssiÚ_»Ëa£
(
kobjeù
 *
kobj
)

3597 
sc¡_£ssiÚ
 *
£ss
;

3599 
	`TRACE_ENTRY
();

3601 
£ss
 = 
	`cÚš”_of
(
kobj
, 
sc¡_£ssiÚ
, 
£ss_kobj
);

3602 ià(
£ss
->
£ss_kobj_»Ëa£_cm¶
)

3603 
	`com¶‘e_®l
(
£ss
->
£ss_kobj_»Ëa£_cm¶
);

3605 
	`TRACE_EXIT
();

3607 
	}
}

3609 
kobj_ty³
 
	gsc¡_£ssiÚ_kty³
 = {

3610 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

3611 .
	g»Ëa£
 = 
sc¡_sysfs_£ssiÚ_»Ëa£
,

3612 .
	gdeçuÉ_©Œs
 = 
sc¡_£ssiÚ_©Œs
,

3615 
	$sc¡_ü—‹_£ss_luns_lšk
(
sc¡_£ssiÚ
 *
£ss
)

3617 
»s
;

3624 ià(
£ss
->
acg
 =ð£ss->
tgt
->
deçuÉ_acg
)

3625 
»s
 = 
	`sysfs_ü—‹_lšk
(&
£ss
->
£ss_kobj
,

3626 
£ss
->
tgt
->
tgt_luns_kobj
, "luns");

3628 
»s
 = 
	`sysfs_ü—‹_lšk
(&
£ss
->
£ss_kobj
,

3629 
£ss
->
acg
->
luns_kobj
, "luns");

3631 ià(
»s
 != 0)

3632 
	`PRINT_ERROR
("Can't create†uns†ink for initiator %s",

3633 
£ss
->
š™ŸtÜ_Çme
);

3635  
»s
;

3636 
	}
}

3638 
	$sc¡_»ü—‹_£ss_luns_lšk
(
sc¡_£ssiÚ
 *
£ss
)

3640 
	`sysfs_»move_lšk
(&
£ss
->
£ss_kobj
, "luns");

3641  
	`sc¡_ü—‹_£ss_luns_lšk
(
£ss
);

3642 
	}
}

3645 
	$sc¡_£ss_sysfs_ü—‹
(
sc¡_£ssiÚ
 *
£ss
)

3647 
»s
 = 0;

3648 
sc¡_£ssiÚ
 *
s
;

3649 *
Çme
 = (*)
£ss
->
š™ŸtÜ_Çme
;

3650 
Ën
 = 
	`¡¾’
(
Çme
è+ 1, 
n
 = 1;

3652 
	`TRACE_ENTRY
();

3654 
»¡¬t
:

3655 
	`li¡_fÜ_—ch_’Œy
(
s
, &
£ss
->
tgt
->
£ss_li¡
, 
£ss_li¡_’Œy
) {

3656 ià(!
s
->
£ss_kobj_»ady
)

3659 ià(
	`¡rcmp
(
Çme
, 
	`kobjeù_Çme
(&
s
->
£ss_kobj
)) == 0) {

3660 ià(
s
 =ð
£ss
)

3663 
	`TRACE_DBG
("Duplicated session fromhe same initiator "

3664 "% found", 
Çme
);

3666 ià(
Çme
 =ð
£ss
->
š™ŸtÜ_Çme
) {

3667 
Ën
 = 
	`¡¾’
(
£ss
->
š™ŸtÜ_Çme
);

3668 
Ën
 += 20;

3669 
Çme
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

3670 ià(
Çme
 =ð
NULL
) {

3671 
	`PRINT_ERROR
("Unableo‡llocate‡ "

3673 
Ën
);

3677 
	`¢´štf
(
Çme
, 
Ën
, "%s_%d", 
£ss
->
š™ŸtÜ_Çme
, 
n
);

3678 
n
++;

3679 
»¡¬t
;

3683 
	`TRACE_DBG
("Addšg sessiÚ % tØsysfs", 
Çme
);

3685 
»s
 = 
	`kobjeù_š™_ªd_add
(&
£ss
->
£ss_kobj
, &
sc¡_£ssiÚ_kty³
,

3686 
£ss
->
tgt
->
tgt_£ss_kobj
, 
Çme
);

3687 ià(
»s
 != 0) {

3688 
	`PRINT_ERROR
("Cª'ˆadd sessiÚ % tØsysfs", 
Çme
);

3689 
out_ä“
;

3692 
£ss
->
£ss_kobj_»ady
 = 1;

3694 ià(
£ss
->
tgt
->
tg‰
->
£ss_©Œs
) {

3695 
»s
 = 
	`sysfs_ü—‹_fžes
(&
£ss
->
£ss_kobj
,

3696 
£ss
->
tgt
->
tg‰
->
£ss_©Œs
);

3697 ià(
»s
 != 0) {

3698 
	`PRINT_ERROR
("Cª'ˆadd‡‰ribu‹ fÜ sessiÚ %s", 
Çme
);

3699 
out_ä“
;

3703 
»s
 = 
	`sc¡_ü—‹_£ss_luns_lšk
(
£ss
);

3705 
out_ä“
:

3706 ià(
Çme
 !ð
£ss
->
š™ŸtÜ_Çme
)

3707 
	`kä“
(
Çme
);

3709 
	`TRACE_EXIT_RES
(
»s
);

3710  
»s
;

3711 
	}
}

3718 
	$sc¡_£ss_sysfs_d–
(
sc¡_£ssiÚ
 *
£ss
)

3720 
rc
;

3721 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

3723 
	`TRACE_ENTRY
();

3725 ià(!
£ss
->
£ss_kobj_»ady
)

3726 
out
;

3728 
	`TRACE_DBG
("Deleting session %s from sysfs",

3729 
	`kobjeù_Çme
(&
£ss
->
£ss_kobj
));

3731 
£ss
->
£ss_kobj_»Ëa£_cm¶
 = &
c
;

3733 
	`kobjeù_d–
(&
£ss
->
£ss_kobj
);

3734 
	`kobjeù_put
(&
£ss
->
£ss_kobj
);

3736 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(
£ss
->
£ss_kobj_»Ëa£_cm¶
, 
HZ
);

3737 ià(
rc
 == 0) {

3738 
	`PRINT_INFO
("Waiting for„eleasing sysfsƒntry "

3739 "fÜ sessiÚ from % (%d„efs)...", 
£ss
->
š™ŸtÜ_Çme
,

3740 
	`©omic_»ad
(&
£ss
->
£ss_kobj
.
k»f
.
»fcouÁ
));

3741 
	`wa™_fÜ_com¶‘iÚ
(
£ss
->
£ss_kobj_»Ëa£_cm¶
);

3742 
	`PRINT_INFO
("Done waiting for„eleasing sysfs "

3743 "’Œy fÜ sessiÚ %s", 
£ss
->
š™ŸtÜ_Çme
);

3746 
out
:

3747 
	`TRACE_EXIT
();

3749 
	}
}

3755 
	$sc¡_acg_dev_»Ëa£
(
kobjeù
 *
kobj
)

3757 
sc¡_acg_dev
 *
acg_dev
;

3759 
	`TRACE_ENTRY
();

3761 
acg_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg_dev
, 
acg_dev_kobj
);

3762 ià(
acg_dev
->
acg_dev_kobj_»Ëa£_cm¶
)

3763 
	`com¶‘e_®l
(
acg_dev
->
acg_dev_kobj_»Ëa£_cm¶
);

3765 
	`TRACE_EXIT
();

3767 
	}
}

3769 
ssize_t
 
	$sc¡_lun_rd_Úly_show
(
kobjeù
 *
kobj
,

3770 
kobj_©Œibu‹
 *
©Œ
,

3771 *
buf
)

3773 
sc¡_acg_dev
 *
acg_dev
;

3775 
acg_dev
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg_dev
, 
acg_dev_kobj
);

3777 ià(
acg_dev
->
rd_Úly
 ||‡cg_dev->
dev
->rd_only)

3778  
	`¥rštf
(
buf
, "%d\n%s\n", 1, 
SCST_SYSFS_KEY_MARK
);

3780  
	`¥rštf
(
buf
, "%d\n", 0);

3781 
	}
}

3783 
kobj_©Œibu‹
 
	glun_ÝtiÚs_©Œ
 =

3784 
__ATTR
(
»ad_Úly
, 
S_IRUGO
, 
sc¡_lun_rd_Úly_show
, 
NULL
);

3786 
©Œibu‹
 *
	glun_©Œs
[] = {

3787 &
lun_ÝtiÚs_©Œ
.
©Œ
,

3788 
NULL
,

3791 
kobj_ty³
 
	gacg_dev_kty³
 = {

3792 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

3793 .
	g»Ëa£
 = 
sc¡_acg_dev_»Ëa£
,

3794 .
	gdeçuÉ_©Œs
 = 
lun_©Œs
,

3804 
	$sc¡_acg_dev_sysfs_d–
(
sc¡_acg_dev
 *
acg_dev
)

3806 
rc
;

3807 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

3809 
	`TRACE_ENTRY
();

3811 
acg_dev
->
acg_dev_kobj_»Ëa£_cm¶
 = &
c
;

3813 ià(
acg_dev
->
dev
 !ð
NULL
) {

3814 
	`sysfs_»move_lšk
(
acg_dev
->
dev
->
dev_exp_kobj
,

3815 
acg_dev
->
acg_dev_lšk_Çme
);

3816 
	`kobjeù_put
(&
acg_dev
->
dev
->
dev_kobj
);

3819 
	`kobjeù_d–
(&
acg_dev
->
acg_dev_kobj
);

3820 
	`kobjeù_put
(&
acg_dev
->
acg_dev_kobj
);

3822 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(
acg_dev
->
acg_dev_kobj_»Ëa£_cm¶
, 
HZ
);

3823 ià(
rc
 == 0) {

3824 
	`PRINT_INFO
("Waiting for„eleasing sysfsƒntry "

3825 "fÜ‡cg_dev %°(%d„efs)...", 
acg_dev
,

3826 
	`©omic_»ad
(&
acg_dev
->
acg_dev_kobj
.
k»f
.
»fcouÁ
));

3827 
	`wa™_fÜ_com¶‘iÚ
(
acg_dev
->
acg_dev_kobj_»Ëa£_cm¶
);

3828 
	`PRINT_INFO
("Done waiting for„eleasing sysfs "

3829 "’Œy fÜ‡cg_dev %p", 
acg_dev
);

3832 
	`TRACE_EXIT
();

3834 
	}
}

3836 
	$sc¡_acg_dev_sysfs_ü—‹
(
sc¡_acg_dev
 *
acg_dev
,

3837 
kobjeù
 *
·»Á
)

3839 
»s
;

3841 
	`TRACE_ENTRY
();

3843 
»s
 = 
	`kobjeù_š™_ªd_add
(&
acg_dev
->
acg_dev_kobj
, &
acg_dev_kty³
,

3844 
·»Á
, "%Îu", 
acg_dev
->
lun
);

3845 ià(
»s
 != 0) {

3846 
	`PRINT_ERROR
("Cª'ˆadd‡cg_dev %°tØsysfs", 
acg_dev
);

3847 
out
;

3850 
	`kobjeù_g‘
(&
acg_dev
->
dev
->
dev_kobj
);

3852 
	`¢´štf
(
acg_dev
->
acg_dev_lšk_Çme
, (acg_dev->acg_dev_link_name),

3853 "expÜt%u", 
acg_dev
->
dev
->
dev_expÜ‹d_lun_num
++);

3855 
»s
 = 
	`sysfs_ü—‹_lšk
(
acg_dev
->
dev
->
dev_exp_kobj
,

3856 &
acg_dev
->
acg_dev_kobj
,‡cg_dev->
acg_dev_lšk_Çme
);

3857 ià(
»s
 != 0) {

3858 
	`PRINT_ERROR
("Can't create‡cg %s LUN†ink",

3859 
acg_dev
->
acg
->
acg_Çme
);

3860 
out_d–
;

3863 
»s
 = 
	`sysfs_ü—‹_lšk
(&
acg_dev
->
acg_dev_kobj
,

3864 &
acg_dev
->
dev
->
dev_kobj
, "device");

3865 ià(
»s
 != 0) {

3866 
	`PRINT_ERROR
("Can't create‡cg %s device†ink",

3867 
acg_dev
->
acg
->
acg_Çme
);

3868 
out_d–
;

3871 
out
:

3872  
»s
;

3874 
out_d–
:

3875 
	`sc¡_acg_dev_sysfs_d–
(
acg_dev
);

3876 
out
;

3877 
	}
}

3883 
	$sc¡_acg_»Ëa£
(
kobjeù
 *
kobj
)

3885 
sc¡_acg
 *
acg
;

3887 
	`TRACE_ENTRY
();

3889 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

3890 ià(
acg
->
acg_kobj_»Ëa£_cm¶
)

3891 
	`com¶‘e_®l
(
acg
->
acg_kobj_»Ëa£_cm¶
);

3893 
	`TRACE_EXIT
();

3895 
	}
}

3897 
kobj_ty³
 
	gacg_kty³
 = {

3898 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

3899 .
	g»Ëa£
 = 
sc¡_acg_»Ëa£
,

3902 
ssize_t
 
	$sc¡_acg_ši_mgmt_show
(
kobjeù
 *
kobj
,

3903 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

3905 cÚ¡ 
h–p
[] =

3911  
	`¥rštf
(
buf
, "%s", 
h–p
);

3912 
	}
}

3914 
	$sc¡_´oûss_acg_ši_mgmt_¡Üe
(*
bufãr
,

3915 
sc¡_tgt
 *
tgt
, 
sc¡_acg
 *
acg
)

3917 
»s
, 
aùiÚ
;

3918 *
p
, *
e
 = 
NULL
;

3919 *
Çme
 = 
NULL
, *
group
 = NULL;

3920 
sc¡_acg
 *
acg_de¡
 = 
NULL
;

3921 
sc¡_aú
 *
aú
 = 
NULL
, *
aú_tmp
;

3923 
SCST_ACG_ACTION_INI_ADD
 = 1,

3924 
SCST_ACG_ACTION_INI_DEL
 = 2,

3925 
SCST_ACG_ACTION_INI_CLEAR
 = 3,

3926 
SCST_ACG_ACTION_INI_MOVE
 = 4,

3929 
	`TRACE_ENTRY
();

3931 
	`TRACE_DBG
("tgˆ%p,‡cg %p, bufã¸%s", 
tgt
, 
acg
, 
bufãr
);

3933 
p
 = 
bufãr
;

3934 ià(
p
[
	`¡¾’
(p) - 1] == '\n')

3935 
p
[
	`¡¾’
(p) - 1] = '\0';

3937 ià(
	`¡ºÿ£cmp
("add", 
p
, 3) == 0) {

3938 
p
 += 3;

3939 
aùiÚ
 = 
SCST_ACG_ACTION_INI_ADD
;

3940 } ià(
	`¡ºÿ£cmp
("d–", 
p
, 3) == 0) {

3941 
p
 += 3;

3942 
aùiÚ
 = 
SCST_ACG_ACTION_INI_DEL
;

3943 } ià(
	`¡ºÿ£cmp
("þ—r", 
p
, 5) == 0) {

3944 
p
 += 5;

3945 
aùiÚ
 = 
SCST_ACG_ACTION_INI_CLEAR
;

3946 } ià(
	`¡ºÿ£cmp
("move", 
p
, 4) == 0) {

3947 
p
 += 4;

3948 
aùiÚ
 = 
SCST_ACG_ACTION_INI_MOVE
;

3950 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

3951 
»s
 = -
EINVAL
;

3952 
out
;

3955 ià(
aùiÚ
 !ð
SCST_ACG_ACTION_INI_CLEAR
)

3956 ià(!
	`is¥aû
(*
p
)) {

3957 
	`PRINT_ERROR
("%s", "Syntaxƒrror");

3958 
»s
 = -
EINVAL
;

3959 
out
;

3962 
»s
 = 
	`sc¡_su¥’d_aùiv™y
(
Œue
);

3963 ià(
»s
 != 0)

3964 
out
;

3966 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

3967 ià(
»s
 != 0)

3968 
out_»sume
;

3971 ià(
	`sc¡_check_tgt_acg_±rs
(
tgt
, 
acg
) != 0)

3972 
out_uÆock
;

3974 ià(
aùiÚ
 !ð
SCST_ACG_ACTION_INI_CLEAR
)

3975 
	`is¥aû
(*
p
) && *p != '\0')

3976 
p
++;

3978 
aùiÚ
) {

3979 
SCST_ACG_ACTION_INI_ADD
:

3980 
e
 = 
p
;

3981 !
	`is¥aû
(*
e
) && *e != '\0')

3982 
e
++;

3983 *
e
 = '\0';

3984 
Çme
 = 
p
;

3986 ià(
Çme
[0] == '\0') {

3987 
	`PRINT_ERROR
("%s", "Invalid initiator‚ame");

3988 
»s
 = -
EINVAL
;

3989 
out_uÆock
;

3992 
»s
 = 
	`sc¡_acg_add_aú
(
acg
, 
Çme
);

3993 ià(
»s
 != 0)

3994 
out_uÆock
;

3996 
SCST_ACG_ACTION_INI_DEL
:

3997 
e
 = 
p
;

3998 !
	`is¥aû
(*
e
) && *e != '\0')

3999 
e
++;

4000 *
e
 = '\0';

4001 
Çme
 = 
p
;

4003 ià(
Çme
[0] == '\0') {

4004 
	`PRINT_ERROR
("%s", "Invalid initiator‚ame");

4005 
»s
 = -
EINVAL
;

4006 
out_uÆock
;

4009 
aú
 = 
	`sc¡_fšd_aú
(
acg
, 
Çme
);

4010 ià(
aú
 =ð
NULL
) {

4011 
	`PRINT_ERROR
("Unableo find "

4013 
Çme
, 
acg
->
acg_Çme
);

4014 
»s
 = -
EINVAL
;

4015 
out_uÆock
;

4017 
	`sc¡_d–_ä“_aú
(
aú
, 
Œue
);

4019 
SCST_ACG_ACTION_INI_CLEAR
:

4020 
	`li¡_fÜ_—ch_’Œy_§ã
(
aú
, 
aú_tmp
, &
acg
->
aú_li¡
,

4021 
aú_li¡_’Œy
) {

4022 
	`sc¡_d–_ä“_aú
(
aú
, 
çl£
);

4024 
	`sc¡_check_»assign_£ssiÚs
();

4026 
SCST_ACG_ACTION_INI_MOVE
:

4027 
e
 = 
p
;

4028 !
	`is¥aû
(*
e
) && *e != '\0')

4029 
e
++;

4030 ià(*
e
 == '\0') {

4031 
	`PRINT_ERROR
("%s", "Too few…arameters");

4032 
»s
 = -
EINVAL
;

4033 
out_uÆock
;

4035 *
e
 = '\0';

4036 
Çme
 = 
p
;

4038 ià(
Çme
[0] == '\0') {

4039 
	`PRINT_ERROR
("%s", "Invalid initiator‚ame");

4040 
»s
 = -
EINVAL
;

4041 
out_uÆock
;

4044 
e
++;

4045 
p
 = 
e
;

4046 !
	`is¥aû
(*
e
) && *e != '\0')

4047 
e
++;

4048 *
e
 = '\0';

4049 
group
 = 
p
;

4051 ià(
group
[0] == '\0') {

4052 
	`PRINT_ERROR
("%s", "Invalid group‚ame");

4053 
»s
 = -
EINVAL
;

4054 
out_uÆock
;

4057 
	`TRACE_DBG
("Move initiator '%s'o group '%s'",

4058 
Çme
, 
group
);

4060 
aú
 = 
	`sc¡_fšd_aú
(
acg
, 
Çme
);

4061 ià(
aú
 =ð
NULL
) {

4062 
	`PRINT_ERROR
("Unableo find "

4064 
Çme
, 
acg
->
acg_Çme
);

4065 
»s
 = -
EINVAL
;

4066 
out_uÆock
;

4068 
acg_de¡
 = 
	`sc¡_tgt_fšd_acg
(
tgt
, 
group
);

4069 ià(
acg_de¡
 =ð
NULL
) {

4070 
	`PRINT_ERROR
("Unableo find group '%s' inarget '%s'",

4071 
group
, 
tgt
->
tgt_Çme
);

4072 
»s
 = -
EINVAL
;

4073 
out_uÆock
;

4075 ià(
	`sc¡_fšd_aú
(
acg_de¡
, 
Çme
è!ð
NULL
) {

4076 
	`PRINT_ERROR
("Initiator '%s'‡lreadyƒxists in group '%s'",

4077 
Çme
, 
acg_de¡
->
acg_Çme
);

4078 
»s
 = -
EEXIST
;

4079 
out_uÆock
;

4081 
	`sc¡_d–_ä“_aú
(
aú
, 
çl£
);

4083 
»s
 = 
	`sc¡_acg_add_aú
(
acg_de¡
, 
Çme
);

4084 ià(
»s
 != 0)

4085 
out_uÆock
;

4089 
»s
 = 0;

4091 
out_uÆock
:

4092 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4094 
out_»sume
:

4095 
	`sc¡_»sume_aùiv™y
();

4097 
out
:

4098 
	`TRACE_EXIT_RES
(
»s
);

4099  
»s
;

4100 
	}
}

4102 
	$sc¡_acg_ši_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

4104  
	`sc¡_´oûss_acg_ši_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
tgt
, wÜk->
acg
);

4105 
	}
}

4107 
ssize_t
 
	$sc¡_acg_ši_mgmt_¡Üe
(
kobjeù
 *
kobj
,

4108 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4110 
sc¡_acg
 *
acg
;

4112 
acg
 = 
	`cÚš”_of
(
kobj
->
·»Á
, 
sc¡_acg
, 
acg_kobj
);

4114  
	`__sc¡_acg_mgmt_¡Üe
(
acg
, 
buf
, 
couÁ
, 
çl£
,

4115 
sc¡_acg_ši_mgmt_¡Üe_wÜk_â
);

4116 
	}
}

4118 
kobj_©Œibu‹
 
	gsc¡_acg_ši_mgmt
 =

4119 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_acg_ši_mgmt_show
,

4120 
sc¡_acg_ši_mgmt_¡Üe
);

4122 
ssize_t
 
	$sc¡_acg_luns_mgmt_¡Üe
(
kobjeù
 *
kobj
,

4123 
kobj_©Œibu‹
 *
©Œ
,

4124 cÚ¡ *
buf
, 
size_t
 
couÁ
)

4126 
»s
;

4127 
sc¡_acg
 *
acg
;

4129 
acg
 = 
	`cÚš”_of
(
kobj
->
·»Á
, 
sc¡_acg
, 
acg_kobj
);

4130 
»s
 = 
	`__sc¡_luns_mgmt_¡Üe
(
acg
, 
çl£
, 
buf
, 
couÁ
);

4132 
	`TRACE_EXIT_RES
(
»s
);

4133  
»s
;

4134 
	}
}

4136 
kobj_©Œibu‹
 
	gsc¡_acg_luns_mgmt
 =

4137 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_luns_mgmt_show
,

4138 
sc¡_acg_luns_mgmt_¡Üe
);

4140 
ssize_t
 
	$sc¡_acg_addr_m‘hod_show
(
kobjeù
 *
kobj
,

4141 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4143 
sc¡_acg
 *
acg
;

4145 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

4147  
	`__sc¡_acg_addr_m‘hod_show
(
acg
, 
buf
);

4148 
	}
}

4150 
ssize_t
 
	$sc¡_acg_addr_m‘hod_¡Üe
(
kobjeù
 *
kobj
,

4151 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4153 
»s
;

4154 
sc¡_acg
 *
acg
;

4156 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

4158 
»s
 = 
	`__sc¡_acg_addr_m‘hod_¡Üe
(
acg
, 
buf
, 
couÁ
);

4160 
	`TRACE_EXIT_RES
(
»s
);

4161  
»s
;

4162 
	}
}

4164 
kobj_©Œibu‹
 
	gsc¡_acg_addr_m‘hod
 =

4165 
__ATTR
(
addr_m‘hod
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_acg_addr_m‘hod_show
,

4166 
sc¡_acg_addr_m‘hod_¡Üe
);

4168 
ssize_t
 
	$sc¡_acg_io_groupšg_ty³_show
(
kobjeù
 *
kobj
,

4169 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4171 
sc¡_acg
 *
acg
;

4173 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

4175  
	`__sc¡_acg_io_groupšg_ty³_show
(
acg
, 
buf
);

4176 
	}
}

4178 
ssize_t
 
	$sc¡_acg_io_groupšg_ty³_¡Üe
(
kobjeù
 *
kobj
,

4179 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4181 
»s
;

4182 
sc¡_acg
 *
acg
;

4184 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

4186 
»s
 = 
	`__sc¡_acg_io_groupšg_ty³_¡Üe
(
acg
, 
buf
, 
couÁ
);

4187 ià(
»s
 != 0)

4188 
out
;

4190 
»s
 = 
couÁ
;

4192 
out
:

4193 
	`TRACE_EXIT_RES
(
»s
);

4194  
»s
;

4195 
	}
}

4197 
kobj_©Œibu‹
 
	gsc¡_acg_io_groupšg_ty³
 =

4198 
__ATTR
(
io_groupšg_ty³
, 
S_IRUGO
 | 
S_IWUSR
,

4199 
sc¡_acg_io_groupšg_ty³_show
,

4200 
sc¡_acg_io_groupšg_ty³_¡Üe
);

4202 
ssize_t
 
	$sc¡_acg_ýu_mask_show
(
kobjeù
 *
kobj
,

4203 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4205 
sc¡_acg
 *
acg
;

4207 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

4209  
	`__sc¡_acg_ýu_mask_show
(
acg
, 
buf
);

4210 
	}
}

4212 
ssize_t
 
	$sc¡_acg_ýu_mask_¡Üe
(
kobjeù
 *
kobj
,

4213 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4215 
»s
;

4216 
sc¡_acg
 *
acg
;

4218 
acg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_acg
, 
acg_kobj
);

4220 
»s
 = 
	`__sc¡_acg_ýu_mask_¡Üe
(
acg
, 
buf
, 
couÁ
);

4221 ià(
»s
 != 0)

4222 
out
;

4224 
»s
 = 
couÁ
;

4226 
out
:

4227 
	`TRACE_EXIT_RES
(
»s
);

4228  
»s
;

4229 
	}
}

4231 
kobj_©Œibu‹
 
	gsc¡_acg_ýu_mask
 =

4232 
__ATTR
(
ýu_mask
, 
S_IRUGO
 | 
S_IWUSR
,

4233 
sc¡_acg_ýu_mask_show
,

4234 
sc¡_acg_ýu_mask_¡Üe
);

4243 
	$sc¡_acg_sysfs_d–
(
sc¡_acg
 *
acg
)

4245 
rc
;

4246 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

4248 
	`TRACE_ENTRY
();

4250 
acg
->
acg_kobj_»Ëa£_cm¶
 = &
c
;

4252 
	`kobjeù_d–
(
acg
->
luns_kobj
);

4253 
	`kobjeù_d–
(
acg
->
š™ŸtÜs_kobj
);

4254 
	`kobjeù_d–
(&
acg
->
acg_kobj
);

4256 
	`kobjeù_put
(
acg
->
luns_kobj
);

4257 
	`kobjeù_put
(
acg
->
š™ŸtÜs_kobj
);

4258 
	`kobjeù_put
(&
acg
->
acg_kobj
);

4260 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(
acg
->
acg_kobj_»Ëa£_cm¶
, 
HZ
);

4261 ià(
rc
 == 0) {

4262 
	`PRINT_INFO
("Waiting for„eleasing sysfsƒntry "

4263 "fÜ‡cg % (%d„efs)...", 
acg
->
acg_Çme
,

4264 
	`©omic_»ad
(&
acg
->
acg_kobj
.
k»f
.
»fcouÁ
));

4265 
	`wa™_fÜ_com¶‘iÚ
(
acg
->
acg_kobj_»Ëa£_cm¶
);

4266 
	`PRINT_INFO
("Done waiting for„eleasing sysfs "

4267 "’Œy fÜ‡cg %s", 
acg
->
acg_Çme
);

4270 
	`TRACE_EXIT
();

4272 
	}
}

4274 
	$sc¡_acg_sysfs_ü—‹
(
sc¡_tgt
 *
tgt
,

4275 
sc¡_acg
 *
acg
)

4277 
»s
 = 0;

4279 
	`TRACE_ENTRY
();

4281 
»s
 = 
	`kobjeù_š™_ªd_add
(&
acg
->
acg_kobj
, &
acg_kty³
,

4282 
tgt
->
tgt_ši_g½_kobj
, 
acg
->
acg_Çme
);

4283 ià(
»s
 != 0) {

4284 
	`PRINT_ERROR
("Cª'ˆadd‡cg '%s'Øsysfs", 
acg
->
acg_Çme
);

4285 
out
;

4288 
acg
->
luns_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("luns", &acg->
acg_kobj
);

4289 ià(
acg
->
luns_kobj
 =ð
NULL
) {

4290 
	`PRINT_ERROR
("Can't create†uns kobj forgt %s",

4291 
tgt
->
tgt_Çme
);

4292 
»s
 = -
ENOMEM
;

4293 
out_d–
;

4296 
»s
 = 
	`sysfs_ü—‹_fže
(
acg
->
luns_kobj
, &
sc¡_acg_luns_mgmt
.
©Œ
);

4297 ià(
»s
 != 0) {

4298 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

4299 
sc¡_acg_luns_mgmt
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

4300 
out_d–
;

4303 
acg
->
š™ŸtÜs_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("initiators",

4304 &
acg
->
acg_kobj
);

4305 ià(
acg
->
š™ŸtÜs_kobj
 =ð
NULL
) {

4306 
	`PRINT_ERROR
("Can't create initiators kobj forgt %s",

4307 
tgt
->
tgt_Çme
);

4308 
»s
 = -
ENOMEM
;

4309 
out_d–
;

4312 
»s
 = 
	`sysfs_ü—‹_fže
(
acg
->
š™ŸtÜs_kobj
,

4313 &
sc¡_acg_ši_mgmt
.
©Œ
);

4314 ià(
»s
 != 0) {

4315 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

4316 
sc¡_acg_ši_mgmt
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

4317 
out_d–
;

4320 
»s
 = 
	`sysfs_ü—‹_fže
(&
acg
->
acg_kobj
, &
sc¡_acg_addr_m‘hod
.
©Œ
);

4321 ià(
»s
 != 0) {

4322 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

4323 
sc¡_acg_addr_m‘hod
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

4324 
out_d–
;

4327 
»s
 = 
	`sysfs_ü—‹_fže
(&
acg
->
acg_kobj
, &
sc¡_acg_io_groupšg_ty³
.
©Œ
);

4328 ià(
»s
 != 0) {

4329 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

4330 
sc¡_acg_io_groupšg_ty³
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

4331 
out_d–
;

4334 
»s
 = 
	`sysfs_ü—‹_fže
(&
acg
->
acg_kobj
, &
sc¡_acg_ýu_mask
.
©Œ
);

4335 ià(
»s
 != 0) {

4336 
	`PRINT_ERROR
("Can't‡ddgt‡ttr %s forgt %s",

4337 
sc¡_acg_ýu_mask
.
©Œ
.
Çme
, 
tgt
->
tgt_Çme
);

4338 
out_d–
;

4341 
out
:

4342 
	`TRACE_EXIT_RES
(
»s
);

4343  
»s
;

4345 
out_d–
:

4346 
	`sc¡_acg_sysfs_d–
(
acg
);

4347 
out
;

4348 
	}
}

4354 
ssize_t
 
	$sc¡_aú_fže_show
(
kobjeù
 *
kobj
,

4355 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4357  
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, "%s\n",

4358 
©Œ
->©Œ.
Çme
);

4359 
	}
}

4361 
	$sc¡_aú_sysfs_ü—‹
(
sc¡_aú
 *
aú
)

4363 
»s
 = 0;

4364 
sc¡_acg
 *
acg
 = 
aú
->acg;

4365 
kobj_©Œibu‹
 *
©Œ
 = 
NULL
;

4366 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 34)

4367 #ifdeà
CONFIG_DEBUG_LOCK_ALLOC


4368 
lock_þass_key
 
__key
;

4372 
	`TRACE_ENTRY
();

4374 
aú
->
aú_©Œ
 = 
NULL
;

4376 
©Œ
 = 
	`kz®loc
((
kobj_©Œibu‹
), 
GFP_KERNEL
);

4377 ià(
©Œ
 =ð
NULL
) {

4378 
	`PRINT_ERROR
("Unableo‡llocate‡ttributes for initiator '%s'",

4379 
aú
->
Çme
);

4380 
»s
 = -
ENOMEM
;

4381 
out
;

4384 
©Œ
->©Œ.
Çme
 = 
	`k¡rdup
(
aú
->Çme, 
GFP_KERNEL
);

4385 ià(
©Œ
->©Œ.
Çme
 =ð
NULL
) {

4386 
	`PRINT_ERROR
("Unableo‡llocate‡ttributes for initiator '%s'",

4387 
aú
->
Çme
);

4388 
»s
 = -
ENOMEM
;

4389 
out_ä“
;

4392 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 36)

4393 
©Œ
->©Œ.
owÃr
 = 
THIS_MODULE
;

4395 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 34)

4396 #ifdeà
CONFIG_DEBUG_LOCK_ALLOC


4397 
©Œ
->©Œ.
key
 = &
__key
;

4401 
©Œ
->©Œ.
mode
 = 
S_IRUGO
;

4402 
©Œ
->
show
 = 
sc¡_aú_fže_show
;

4403 
©Œ
->
¡Üe
 = 
NULL
;

4405 
»s
 = 
	`sysfs_ü—‹_fže
(
acg
->
š™ŸtÜs_kobj
, &
©Œ
->attr);

4406 ià(
»s
 != 0) {

4407 
	`PRINT_ERROR
("Unableo create‡cn '%s' for group '%s'",

4408 
aú
->
Çme
, 
acg
->
acg_Çme
);

4409 
	`kä“
(
©Œ
->©Œ.
Çme
);

4410 
out_ä“
;

4413 
aú
->
aú_©Œ
 = 
©Œ
;

4415 
out
:

4416 
	`TRACE_EXIT_RES
(
»s
);

4417  
»s
;

4419 
out_ä“
:

4420 
	`kä“
(
©Œ
);

4421 
out
;

4422 
	}
}

4424 
	$sc¡_aú_sysfs_d–
(
sc¡_aú
 *
aú
)

4426 
sc¡_acg
 *
acg
 = 
aú
->acg;

4428 
	`TRACE_ENTRY
();

4430 ià(
aú
->
aú_©Œ
 !ð
NULL
) {

4431 
	`sysfs_»move_fže
(
acg
->
š™ŸtÜs_kobj
,

4432 &
aú
->
aú_©Œ
->
©Œ
);

4433 
	`kä“
(
aú
->
aú_©Œ
->
©Œ
.
Çme
);

4434 
	`kä“
(
aú
->
aú_©Œ
);

4437 
	`TRACE_EXIT
();

4439 
	}
}

4446 
	$sc¡_devt_»Ëa£
(
kobjeù
 *
kobj
)

4448 
sc¡_dev_ty³
 *
devt
;

4450 
	`TRACE_ENTRY
();

4452 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

4453 ià(
devt
->
devt_kobj_»Ëa£_com¶
)

4454 
	`com¶‘e_®l
(
devt
->
devt_kobj_»Ëa£_com¶
);

4456 
	`TRACE_EXIT
();

4458 
	}
}

4460 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

4462 
ssize_t
 
	$sc¡_devt_Œaû_Ëv–_show
(
kobjeù
 *
kobj
,

4463 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4465 
sc¡_dev_ty³
 *
devt
;

4467 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

4469  
	`sc¡_Œaû_Ëv–_show
(
devt
->
Œaû_tbl
,

4470 
devt
->
Œaû_æags
 ? *devt->Œaû_æag : 0, 
buf
,

4471 
devt
->
Œaû_tbl_h–p
);

4472 
	}
}

4474 
ssize_t
 
	$sc¡_devt_Œaû_Ëv–_¡Üe
(
kobjeù
 *
kobj
,

4475 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4477 
»s
;

4478 
sc¡_dev_ty³
 *
devt
;

4480 
	`TRACE_ENTRY
();

4482 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

4484 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_log_mu‹x
);

4485 ià(
»s
 != 0)

4486 
out
;

4488 
»s
 = 
	`sc¡_wr™e_Œaû
(
buf
, 
couÁ
, 
devt
->
Œaû_æags
,

4489 
devt
->
deçuÉ_Œaû_æags
, devt->
Çme
, devt->
Œaû_tbl
);

4491 
	`mu‹x_uÆock
(&
sc¡_log_mu‹x
);

4493 
out
:

4494 
	`TRACE_EXIT_RES
(
»s
);

4495  
»s
;

4496 
	}
}

4498 
kobj_©Œibu‹
 
	gdevt_Œaû_©Œ
 =

4499 
__ATTR
(
Œaû_Ëv–
, 
S_IRUGO
 | 
S_IWUSR
,

4500 
sc¡_devt_Œaû_Ëv–_show
, 
sc¡_devt_Œaû_Ëv–_¡Üe
);

4504 
ssize_t
 
	$sc¡_devt_ty³_show
(
kobjeù
 *
kobj
,

4505 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4507 
pos
;

4508 
sc¡_dev_ty³
 *
devt
;

4510 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

4512 
pos
 = 
	`¥rštf
(
buf
, "%d - %s\n", 
devt
->
ty³
,

4513 ()
devt
->
ty³
 >ð
	`ARRAY_SIZE
(
sc¡_dev_hªdËr_ty³s
) ?

4514 "unknown" : 
sc¡_dev_hªdËr_ty³s
[
devt
->
ty³
]);

4516  
pos
;

4517 
	}
}

4519 
kobj_©Œibu‹
 
	gsc¡_devt_ty³_©Œ
 =

4520 
__ATTR
(
ty³
, 
S_IRUGO
, 
sc¡_devt_ty³_show
, 
NULL
);

4522 
©Œibu‹
 *
	gsc¡_devt_deçuÉ_©Œs
[] = {

4523 &
sc¡_devt_ty³_©Œ
.
©Œ
,

4524 
NULL
,

4527 
kobj_ty³
 
	gsc¡_devt_kty³
 = {

4528 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

4529 .
	g»Ëa£
 = 
sc¡_devt_»Ëa£
,

4530 .
	gdeçuÉ_©Œs
 = 
sc¡_devt_deçuÉ_©Œs
,

4533 
ssize_t
 
	$sc¡_devt_mgmt_show
(
kobjeù
 *
kobj
,

4534 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4536 cÚ¡ 
h–p
[] =

4545 
sc¡_dev_ty³
 *
devt
;

4547 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

4549  
	`sú´štf
(
buf
, 
SCST_SYSFS_BLOCK_SIZE
, 
h–p
,

4550 (
devt
->
devt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

4553 (
devt
->
dev_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

4556 (
devt
->
mgmt_cmd_h–p
) ? devt->mgmt_cmd_help : "",

4557 (
devt
->
add_deviû_·¿m‘”s
 !ð
NULL
) ?

4559 (
devt
->
add_deviû_·¿m‘”s
 !ð
NULL
) ?

4560 
devt
->
add_deviû_·¿m‘”s
 : "",

4561 (
devt
->
devt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

4563 (
devt
->
devt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

4564 
devt
->
devt_ÝtiÚ®_©Œibu‹s
 : "",

4565 (
devt
->
devt_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ? "\n" : "",

4566 (
devt
->
dev_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

4568 (
devt
->
dev_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ?

4569 
devt
->
dev_ÝtiÚ®_©Œibu‹s
 : "",

4570 (
devt
->
dev_ÝtiÚ®_©Œibu‹s
 !ð
NULL
) ? "\n" : "");

4571 
	}
}

4573 
	$sc¡_´oûss_devt_mgmt_¡Üe
(*
bufãr
,

4574 
sc¡_dev_ty³
 *
devt
)

4576 
»s
 = 0;

4577 *
p
, *
µ
, *
dev_Çme
;

4579 
	`TRACE_ENTRY
();

4582 ià(
	`sc¡_check_g¿b_devt_±r
(
devt
, &
sc¡_vœtu®_dev_ty³_li¡
) != 0)

4583 
out
;

4585 
	`TRACE_DBG
("devˆ%p, bufã¸%s", 
devt
, 
bufãr
);

4587 
µ
 = 
bufãr
;

4588 ià(
µ
[
	`¡¾’
(pp) - 1] == '\n')

4589 
µ
[
	`¡¾’
(pp) - 1] = '\0';

4591 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

4593 ià(
	`¡rÿ£cmp
("add_deviû", 
p
) == 0) {

4594 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

4595 ià(*
dev_Çme
 == '\0') {

4596 
	`PRINT_ERROR
("%s", "Device‚ame„equired");

4597 
»s
 = -
EINVAL
;

4598 
out_ung¿b
;

4600 
»s
 = 
devt
->
	`add_deviû
(
dev_Çme
, 
µ
);

4601 } ià(
	`¡rÿ£cmp
("d–_deviû", 
p
) == 0) {

4602 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

4603 ià(*
dev_Çme
 == '\0') {

4604 
	`PRINT_ERROR
("%s", "Device‚ame„equired");

4605 
»s
 = -
EINVAL
;

4606 
out_ung¿b
;

4609 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

4610 ià(*
p
 != '\0')

4611 
out_syÁax_”r
;

4613 
»s
 = 
devt
->
	`d–_deviû
(
dev_Çme
);

4614 } ià(
devt
->
mgmt_cmd
 !ð
NULL
) {

4615 
	`sc¡_»¡Üe_tok’_¡r
(
p
, 
µ
);

4616 
»s
 = 
devt
->
	`mgmt_cmd
(
bufãr
);

4618 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
p
);

4619 
»s
 = -
EINVAL
;

4620 
out_ung¿b
;

4623 
out_ung¿b
:

4624 
	`sc¡_ung¿b_devt_±r
(
devt
);

4626 
out
:

4627 
	`TRACE_EXIT_RES
(
»s
);

4628  
»s
;

4630 
out_syÁax_”r
:

4631 
	`PRINT_ERROR
("SyÁaxƒ¼Ü oÀ\"%s\"", 
p
);

4632 
»s
 = -
EINVAL
;

4633 
out_ung¿b
;

4634 
	}
}

4636 
	$sc¡_devt_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

4638  
	`sc¡_´oûss_devt_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
devt
);

4639 
	}
}

4641 
ssize_t
 
__sc¡_devt_mgmt_¡Üe
(
kobjeù
 *
kobj
,

4642 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
,

4643 (*
sysfs_wÜk_â
)(
sc¡_sysfs_wÜk_™em
 *
wÜk
))

4645 
»s
;

4646 *
bufãr
;

4647 
sc¡_dev_ty³
 *
devt
;

4648 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

4650 
	`TRACE_ENTRY
();

4652 
devt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_ty³
, 
devt_kobj
);

4654 
bufãr
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

4655 ià(
bufãr
 =ð
NULL
) {

4656 
»s
 = -
ENOMEM
;

4657 
out
;

4660 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sysfs_wÜk_â
, 
çl£
, &
wÜk
);

4661 ià(
»s
 != 0)

4662 
out_ä“
;

4664 
wÜk
->
buf
 = 
bufãr
;

4665 
wÜk
->
devt
 = devt;

4667 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

4668 ià(
»s
 == 0)

4669 
»s
 = 
couÁ
;

4671 
out
:

4672 
	`TRACE_EXIT_RES
(
»s
);

4673  
»s
;

4675 
out_ä“
:

4676 
	`kä“
(
bufãr
);

4677 
out
;

4678 
	}
}

4680 
ssize_t
 
	$sc¡_devt_mgmt_¡Üe
(
kobjeù
 *
kobj
,

4681 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4683  
	`__sc¡_devt_mgmt_¡Üe
(
kobj
, 
©Œ
, 
buf
, 
couÁ
,

4684 
sc¡_devt_mgmt_¡Üe_wÜk_â
);

4685 
	}
}

4687 
kobj_©Œibu‹
 
	gsc¡_devt_mgmt
 =

4688 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_devt_mgmt_show
,

4689 
sc¡_devt_mgmt_¡Üe
);

4691 
ssize_t
 
	$sc¡_devt_·ss_through_mgmt_show
(
kobjeù
 *
kobj
,

4692 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

4694 cÚ¡ 
h–p
[] =

4697  
	`¥rštf
(
buf
, "%s", 
h–p
);

4698 
	}
}

4700 
	$sc¡_´oûss_devt_·ss_through_mgmt_¡Üe
(*
bufãr
,

4701 
sc¡_dev_ty³
 *
devt
)

4703 
»s
 = 0;

4704 *
p
, *
µ
, *
aùiÚ
;

4705 
ho¡
, 
chªÃl
, 
id
, 
lun
;

4706 
sc¡_deviû
 *
d
, *
dev
 = 
NULL
;

4708 
	`TRACE_ENTRY
();

4710 
	`TRACE_DBG
("devˆ%p, bufã¸%s", 
devt
, 
bufãr
);

4712 
µ
 = 
bufãr
;

4713 ià(
µ
[
	`¡¾’
(pp) - 1] == '\n')

4714 
µ
[
	`¡¾’
(pp) - 1] = '\0';

4716 
aùiÚ
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

4717 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

4718 ià(*
p
 == '\0') {

4719 
	`PRINT_ERROR
("%s", "Device„equired");

4720 
»s
 = -
EINVAL
;

4721 
out
;

4724 ià(*
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
) != '\0') {

4725 
	`PRINT_ERROR
("%s", "Too many…arameters");

4726 
»s
 = -
EINVAL
;

4727 
out_syÁax_”r
;

4730 
ho¡
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

4731 ià((
ho¡
 =ð
ULONG_MAX
è|| (*
p
 != ':'))

4732 
out_syÁax_”r
;

4733 
p
++;

4734 
chªÃl
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

4735 ià((
chªÃl
 =ð
ULONG_MAX
è|| (*
p
 != ':'))

4736 
out_syÁax_”r
;

4737 
p
++;

4738 
id
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

4739 ià((
chªÃl
 =ð
ULONG_MAX
è|| (*
p
 != ':'))

4740 
out_syÁax_”r
;

4741 
p
++;

4742 
lun
 = 
	`sim¶e_¡¹oul
(
p
, &p, 0);

4743 ià(
lun
 =ð
ULONG_MAX
)

4744 
out_syÁax_”r
;

4746 
	`TRACE_DBG
("Dev %ld:%ld:%ld:%ld", 
ho¡
, 
chªÃl
, 
id
, 
lun
);

4748 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

4749 ià(
»s
 != 0)

4750 
out
;

4753 ià(
	`sc¡_check_devt_±r
(
devt
, &
sc¡_dev_ty³_li¡
) != 0)

4754 
out_uÆock
;

4756 
	`li¡_fÜ_—ch_’Œy
(
d
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

4757 ià((
d
->
vœt_id
 == 0) &&

4758 
d
->
scsi_dev
->
ho¡
->
ho¡_no
 == host &&

4759 
d
->
scsi_dev
->
chªÃl
 == channel &&

4760 
d
->
scsi_dev
->
id
 == id &&

4761 
d
->
scsi_dev
->
lun
 ==†un) {

4762 
dev
 = 
d
;

4763 
	`TRACE_DBG
("Dev %p (%ld:%ld:%ld:%ld) found",

4764 
dev
, 
ho¡
, 
chªÃl
, 
id
, 
lun
);

4768 ià(
dev
 =ð
NULL
) {

4769 
	`PRINT_ERROR
("Device %ld:%ld:%ld:%ld‚ot found",

4770 
ho¡
, 
chªÃl
, 
id
, 
lun
);

4771 
»s
 = -
EINVAL
;

4772 
out_uÆock
;

4775 ià(
dev
->
scsi_dev
->
ty³
 !ð
devt
->type) {

4776 
	`PRINT_ERROR
("Type %d of device %s differs fromype "

4777 "%d oàdev hªdË¸%s", 
dev
->
ty³
,

4778 
dev
->
vœt_Çme
, 
devt
->
ty³
, devt->
Çme
);

4779 
»s
 = -
EINVAL
;

4780 
out_uÆock
;

4783 ià(
	`¡rÿ£cmp
("add_deviû", 
aùiÚ
) == 0) {

4784 
»s
 = 
	`sc¡_assign_dev_hªdËr
(
dev
, 
devt
);

4785 ià(
»s
 == 0)

4786 
	`PRINT_INFO
("Device %s‡ssignedo dev handler %s",

4787 
dev
->
vœt_Çme
, 
devt
->
Çme
);

4788 } ià(
	`¡rÿ£cmp
("d–_deviû", 
aùiÚ
) == 0) {

4789 ià(
dev
->
hªdËr
 !ð
devt
) {

4790 
	`PRINT_ERROR
("Device %s is‚ot‡ssignedo handler %s",

4791 
dev
->
vœt_Çme
, 
devt
->
Çme
);

4792 
»s
 = -
EINVAL
;

4793 
out_uÆock
;

4795 
»s
 = 
	`sc¡_assign_dev_hªdËr
(
dev
, &
sc¡_nuÎ_devty³
);

4796 ià(
»s
 == 0)

4797 
	`PRINT_INFO
("Device %s unassigned from dev handler %s",

4798 
dev
->
vœt_Çme
, 
devt
->
Çme
);

4800 
	`PRINT_ERROR
("UnknowÀaùiÚ \"%s\"", 
aùiÚ
);

4801 
»s
 = -
EINVAL
;

4802 
out_uÆock
;

4805 
out_uÆock
:

4806 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4808 
out
:

4809 
	`TRACE_EXIT_RES
(
»s
);

4810  
»s
;

4812 
out_syÁax_”r
:

4813 
	`PRINT_ERROR
("SyÁaxƒ¼Ü oÀ\"%s\"", 
p
);

4814 
»s
 = -
EINVAL
;

4815 
out
;

4816 
	}
}

4818 
	$sc¡_devt_·ss_through_mgmt_¡Üe_wÜk_â
(

4819 
sc¡_sysfs_wÜk_™em
 *
wÜk
)

4821  
	`sc¡_´oûss_devt_·ss_through_mgmt_¡Üe
(
wÜk
->
buf
, wÜk->
devt
);

4822 
	}
}

4824 
ssize_t
 
	$sc¡_devt_·ss_through_mgmt_¡Üe
(
kobjeù
 *
kobj
,

4825 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

4827  
	`__sc¡_devt_mgmt_¡Üe
(
kobj
, 
©Œ
, 
buf
, 
couÁ
,

4828 
sc¡_devt_·ss_through_mgmt_¡Üe_wÜk_â
);

4829 
	}
}

4831 
kobj_©Œibu‹
 
	gsc¡_devt_·ss_through_mgmt
 =

4832 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_devt_·ss_through_mgmt_show
,

4833 
sc¡_devt_·ss_through_mgmt_¡Üe
);

4835 
	$sc¡_devt_sysfs_ü—‹
(
sc¡_dev_ty³
 *
devt
)

4837 
»s
;

4838 
kobjeù
 *
·»Á
;

4840 
	`TRACE_ENTRY
();

4842 ià(
devt
->
·»Á
 !ð
NULL
)

4843 
·»Á
 = &
devt
->·»Á->
devt_kobj
;

4845 
·»Á
 = 
sc¡_hªdËrs_kobj
;

4847 
»s
 = 
	`kobjeù_š™_ªd_add
(&
devt
->
devt_kobj
, &
sc¡_devt_kty³
,

4848 
·»Á
, 
devt
->
Çme
);

4849 ià(
»s
 != 0) {

4850 
	`PRINT_ERROR
("Cª'ˆadd devˆ% tØsysfs", 
devt
->
Çme
);

4851 
out
;

4854 ià(
devt
->
add_deviû
 !ð
NULL
) {

4855 
»s
 = 
	`sysfs_ü—‹_fže
(&
devt
->
devt_kobj
,

4856 &
sc¡_devt_mgmt
.
©Œ
);

4858 
»s
 = 
	`sysfs_ü—‹_fže
(&
devt
->
devt_kobj
,

4859 &
sc¡_devt_·ss_through_mgmt
.
©Œ
);

4861 ià(
»s
 != 0) {

4862 
	`PRINT_ERROR
("Can't‡dd mgmt‡ttr for dev handler %s",

4863 
devt
->
Çme
);

4864 
out_”r
;

4867 ià(
devt
->
devt_©Œs
) {

4868 
»s
 = 
	`sysfs_ü—‹_fžes
(&
devt
->
devt_kobj
, devt->
devt_©Œs
);

4869 ià(
»s
 != 0) {

4870 
	`PRINT_ERROR
("Can't‡dd‡ttributes for dev handler %s",

4871 
devt
->
Çme
);

4872 
out_”r
;

4876 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

4877 ià(
devt
->
Œaû_æags
 !ð
NULL
) {

4878 
»s
 = 
	`sysfs_ü—‹_fže
(&
devt
->
devt_kobj
,

4879 &
devt_Œaû_©Œ
.
©Œ
);

4880 ià(
»s
 != 0) {

4881 
	`PRINT_ERROR
("Can't‡dd devtrace_flag for dev "

4882 "hªdË¸%s", 
devt
->
Çme
);

4883 
out_”r
;

4888 
out
:

4889 
	`TRACE_EXIT_RES
(
»s
);

4890  
»s
;

4892 
out_”r
:

4893 
	`sc¡_devt_sysfs_d–
(
devt
);

4894 
out
;

4895 
	}
}

4897 
	$sc¡_devt_sysfs_d–
(
sc¡_dev_ty³
 *
devt
)

4899 
rc
;

4900 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

4902 
	`TRACE_ENTRY
();

4904 
devt
->
devt_kobj_»Ëa£_com¶
 = &
c
;

4906 
	`kobjeù_d–
(&
devt
->
devt_kobj
);

4907 
	`kobjeù_put
(&
devt
->
devt_kobj
);

4909 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_timeout
(
devt
->
devt_kobj_»Ëa£_com¶
, 
HZ
);

4910 ià(
rc
 == 0) {

4911 
	`PRINT_INFO
("Waiting for„eleasing of sysfsƒntry "

4912 "fÜ dev hªdË¸‹m¶©% (%d„efs)...", 
devt
->
Çme
,

4913 
	`©omic_»ad
(&
devt
->
devt_kobj
.
k»f
.
»fcouÁ
));

4914 
	`wa™_fÜ_com¶‘iÚ
(
devt
->
devt_kobj_»Ëa£_com¶
);

4915 
	`PRINT_INFO
("Done waiting for„eleasing sysfsƒntry "

4916 "fÜ dev hªdË¸‹m¶©%s", 
devt
->
Çme
);

4919 
	`TRACE_EXIT
();

4921 
	}
}

4927 
	$sc¡_dg_dev_sysfs_add
(
sc¡_dev_group
 *
dg
, 
sc¡_dg_dev
 *
dgdev
)

4929 
»s
;

4931 
	`TRACE_ENTRY
();

4932 
»s
 = 
	`sysfs_ü—‹_lšk
(
dg
->
dev_kobj
, &
dgdev
->
dev
->dev_kobj,

4933 
dgdev
->
dev
->
vœt_Çme
);

4934 
	`TRACE_EXIT_RES
(
»s
);

4935  
»s
;

4936 
	}
}

4938 
	$sc¡_dg_dev_sysfs_d–
(
sc¡_dev_group
 *
dg
, 
sc¡_dg_dev
 *
dgdev
)

4940 
	`TRACE_ENTRY
();

4941 
	`sysfs_»move_lšk
(
dg
->
dev_kobj
, 
dgdev
->
dev
->
vœt_Çme
);

4942 
	`TRACE_EXIT
();

4943 
	}
}

4949 
ssize_t
 
	$sc¡_dg_devs_mgmt_show
(
kobjeù
 *
kobj
,

4950 
kobj_©Œibu‹
 *
©Œ
,

4951 *
buf
)

4953 cÚ¡ 
h–p
[] =

4957  
	`sú´štf
(
buf
, 
PAGE_SIZE
, 
h–p
);

4958 
	}
}

4960 
	$sc¡_dg_devs_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
w
)

4962 
sc¡_dev_group
 *
dg
;

4963 *
cmd
, *
p
, *
µ
, *
dev_Çme
;

4964 
»s
;

4966 
	`TRACE_ENTRY
();

4968 
cmd
 = 
w
->
buf
;

4969 
dg
 = 
	`sc¡_lookup_dg_by_kobj
(
w
->
kobj
);

4970 
	`WARN_ON
(!
dg
);

4972 
p
 = 
	`¡rchr
(
cmd
, '\n');

4973 ià(
p
)

4974 *
p
 = '\0';

4976 
»s
 = -
EINVAL
;

4977 
µ
 = 
cmd
;

4978 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

4979 ià(
	`¡rÿ£cmp
(
p
, "add") == 0) {

4980 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

4981 ià(!*
dev_Çme
)

4982 
out
;

4983 
»s
 = 
	`sc¡_dg_dev_add
(
dg
, 
dev_Çme
);

4984 } ià(
	`¡rÿ£cmp
(
p
, "del") == 0) {

4985 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

4986 ià(!*
dev_Çme
)

4987 
out
;

4988 
»s
 = 
	`sc¡_dg_dev_»move_by_Çme
(
dg
, 
dev_Çme
);

4990 
out
:

4991 
	`kobjeù_put
(
w
->
kobj
);

4992 
	`TRACE_EXIT_RES
(
»s
);

4993  
»s
;

4994 
	}
}

4996 
ssize_t
 
	$sc¡_dg_devs_mgmt_¡Üe
(
kobjeù
 *
kobj
,

4997 
kobj_©Œibu‹
 *
©Œ
,

4998 cÚ¡ *
buf
, 
size_t
 
couÁ
)

5000 *
cmd
;

5001 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

5002 
»s
;

5004 
	`TRACE_ENTRY
();

5006 
»s
 = -
ENOMEM
;

5007 
cmd
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

5008 ià(!
cmd
)

5009 
out
;

5011 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_dg_devs_mgmt_¡Üe_wÜk_â
, 
çl£
,

5012 &
wÜk
);

5013 ià(
»s
)

5014 
out
;

5016 
wÜk
->
buf
 = 
cmd
;

5017 
wÜk
->
kobj
 = kobj;

5018 
	`kobjeù_g‘
(
kobj
);

5019 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

5021 
out
:

5022 ià(
»s
 == 0)

5023 
»s
 = 
couÁ
;

5024 
	`TRACE_EXIT_RES
(
»s
);

5025  
»s
;

5026 
	}
}

5028 
kobj_©Œibu‹
 
	gsc¡_dg_devs_mgmt
 =

5029 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_dg_devs_mgmt_show
,

5030 
sc¡_dg_devs_mgmt_¡Üe
);

5032 cÚ¡ 
©Œibu‹
 *
	gsc¡_dg_devs_©Œs
[] = {

5033 &
sc¡_dg_devs_mgmt
.
©Œ
,

5034 
NULL
,

5041 
ssize_t
 
	$sc¡_tg_tgt_»l_tgt_id_show
(
kobjeù
 *
kobj
,

5042 
kobj_©Œibu‹
 *
©Œ
,

5043 *
buf
)

5045 
sc¡_tg_tgt
 *
tg_tgt
;

5047 
tg_tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tg_tgt
, kobj);

5048  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%u\n" 
SCST_SYSFS_KEY_MARK
 "\n",

5049 
tg_tgt
->
»l_tgt_id
);

5050 
	}
}

5052 
ssize_t
 
	$sc¡_tg_tgt_»l_tgt_id_¡Üe
(
kobjeù
 *
kobj
,

5053 
kobj_©Œibu‹
 *
©Œ
,

5054 cÚ¡ *
buf
, 
size_t
 
couÁ
)

5056 
sc¡_tg_tgt
 *
tg_tgt
;

5057 
»l_tgt_id
;

5058 
ch
[8];

5059 
»s
;

5061 
	`TRACE_ENTRY
();

5062 
tg_tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tg_tgt
, kobj);

5063 
	`¢´štf
(
ch
, (ch), "%.*s", 
	`mš_t
(, 
couÁ
, (ch)-1), 
buf
);

5064 
»s
 = 
	`¡riù_¡¹oul
(
ch
, 0, &
»l_tgt_id
);

5065 ià(
»s
)

5066 
out
;

5067 
»s
 = -
EINVAL
;

5068 ià(
»l_tgt_id
 == 0 ||„el_tgt_id > 0xffff)

5069 
out
;

5070 
tg_tgt
->
»l_tgt_id
 =„el_tgt_id;

5071 
»s
 = 
couÁ
;

5072 
out
:

5073 
	`TRACE_EXIT_RES
(
»s
);

5074  
»s
;

5075 
	}
}

5077 
kobj_©Œibu‹
 
	gsc¡_tg_tgt_»l_tgt_id
 =

5078 
__ATTR
(
»l_tgt_id
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg_tgt_»l_tgt_id_show
,

5079 
sc¡_tg_tgt_»l_tgt_id_¡Üe
);

5081 cÚ¡ 
©Œibu‹
 *
	gsc¡_tg_tgt_©Œs
[] = {

5082 &
sc¡_tg_tgt_»l_tgt_id
.
©Œ
,

5083 
NULL
,

5086 
	$sc¡_tg_tgt_sysfs_add
(
sc¡_rg‘_group
 *
tg
,

5087 
sc¡_tg_tgt
 *
tg_tgt
)

5089 
»s
;

5091 
	`TRACE_ENTRY
();

5092 
	`BUG_ON
(!
tg
);

5093 
	`BUG_ON
(!
tg_tgt
);

5094 
	`BUG_ON
(!
tg_tgt
->
Çme
);

5095 ià(
tg_tgt
->
tgt
)

5096 
»s
 = 
	`sysfs_ü—‹_lšk
(&
tg
->
kobj
, &
tg_tgt
->
tgt
->
tgt_kobj
,

5097 
tg_tgt
->
Çme
);

5099 
»s
 = 
	`kobjeù_add
(&
tg_tgt
->
kobj
, &
tg
->kobj, "%s",g_tgt->
Çme
);

5100 ià(
»s
)

5101 
”r
;

5102 
»s
 = 
	`sysfs_ü—‹_fžes
(&
tg_tgt
->
kobj
, 
sc¡_tg_tgt_©Œs
);

5103 ià(
»s
)

5104 
”r
;

5106 
out
:

5107 
	`TRACE_EXIT_RES
(
»s
);

5108  
»s
;

5109 
”r
:

5110 
	`sc¡_tg_tgt_sysfs_d–
(
tg
, 
tg_tgt
);

5111 
out
;

5112 
	}
}

5114 
	$sc¡_tg_tgt_sysfs_d–
(
sc¡_rg‘_group
 *
tg
,

5115 
sc¡_tg_tgt
 *
tg_tgt
)

5117 
	`TRACE_ENTRY
();

5118 ià(
tg_tgt
->
tgt
)

5119 
	`sysfs_»move_lšk
(&
tg
->
kobj
, 
tg_tgt
->
Çme
);

5121 
	`sysfs_»move_fžes
(&
tg_tgt
->
kobj
, 
sc¡_tg_tgt_©Œs
);

5122 
	`kobjeù_d–
(&
tg_tgt
->
kobj
);

5124 
	`TRACE_EXIT
();

5125 
	}
}

5131 
ssize_t
 
	$sc¡_tg_group_id_show
(
kobjeù
 *
kobj
,

5132 
kobj_©Œibu‹
 *
©Œ
,

5133 *
buf
)

5135 
sc¡_rg‘_group
 *
tg
;

5137 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

5138  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%u\n" 
SCST_SYSFS_KEY_MARK
 "\n",

5139 
tg
->
group_id
);

5140 
	}
}

5142 
ssize_t
 
	$sc¡_tg_group_id_¡Üe
(
kobjeù
 *
kobj
,

5143 
kobj_©Œibu‹
 *
©Œ
,

5144 cÚ¡ *
buf
, 
size_t
 
couÁ
)

5146 
sc¡_rg‘_group
 *
tg
;

5147 
group_id
;

5148 
ch
[8];

5149 
»s
;

5151 
	`TRACE_ENTRY
();

5152 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

5153 
	`¢´štf
(
ch
, (ch), "%.*s", 
	`mš_t
(, 
couÁ
, (ch)-1), 
buf
);

5154 
»s
 = 
	`¡riù_¡¹oul
(
ch
, 0, &
group_id
);

5155 ià(
»s
)

5156 
out
;

5157 
»s
 = -
EINVAL
;

5158 ià(
group_id
 == 0 || group_id > 0xffff)

5159 
out
;

5160 
tg
->
group_id
 = group_id;

5161 
»s
 = 
couÁ
;

5162 
out
:

5163 
	`TRACE_EXIT_RES
(
»s
);

5164  
»s
;

5165 
	}
}

5167 
kobj_©Œibu‹
 
	gsc¡_tg_group_id
 =

5168 
__ATTR
(
group_id
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg_group_id_show
,

5169 
sc¡_tg_group_id_¡Üe
);

5171 
ssize_t
 
	$sc¡_tg_´eã¼ed_show
(
kobjeù
 *
kobj
,

5172 
kobj_©Œibu‹
 *
©Œ
,

5173 *
buf
)

5175 
sc¡_rg‘_group
 *
tg
;

5177 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

5178  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%u\n%s",

5179 
tg
->
´eã¼ed
, 
SCST_SYSFS_KEY_MARK
 "\n");

5180 
	}
}

5182 
ssize_t
 
	$sc¡_tg_´eã¼ed_¡Üe
(
kobjeù
 *
kobj
,

5183 
kobj_©Œibu‹
 *
©Œ
,

5184 cÚ¡ *
buf
, 
size_t
 
couÁ
)

5186 
sc¡_rg‘_group
 *
tg
;

5187 
´eã¼ed
;

5188 
ch
[8];

5189 
»s
;

5191 
	`TRACE_ENTRY
();

5192 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

5193 
	`¢´štf
(
ch
, (ch), "%.*s", 
	`mš_t
(, 
couÁ
, (ch)-1), 
buf
);

5194 
»s
 = 
	`¡riù_¡¹oul
(
ch
, 0, &
´eã¼ed
);

5195 ià(
»s
)

5196 
out
;

5197 
»s
 = -
EINVAL
;

5198 ià(
´eã¼ed
 != 0 &&…referred != 1)

5199 
out
;

5200 
tg
->
´eã¼ed
 =…referred;

5201 
»s
 = 
couÁ
;

5202 
out
:

5203 
	`TRACE_EXIT_RES
(
»s
);

5204  
»s
;

5205 
	}
}

5207 
kobj_©Œibu‹
 
	gsc¡_tg_´eã¼ed
 =

5208 
__ATTR
(
´eã¼ed
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg_´eã¼ed_show
,

5209 
sc¡_tg_´eã¼ed_¡Üe
);

5211 ¡ruù { 
sc¡_tg_¡©e
 
	ms
; cÚ¡ *
	mn
; } 
	gsc¡_tg_¡©e_Çmes
[] = {

5212 { 
SCST_TG_STATE_OPTIMIZED
, "active" },

5213 { 
SCST_TG_STATE_NONOPTIMIZED
, "nonoptimized" },

5214 { 
SCST_TG_STATE_STANDBY
, "standby" },

5215 { 
SCST_TG_STATE_UNAVAILABLE
, "unavailable" },

5216 { 
SCST_TG_STATE_OFFLINE
, "offline" },

5217 { 
SCST_TG_STATE_TRANSITIONING
, "transitioning" },

5220 
ssize_t
 
	$sc¡_tg_¡©e_show
(
kobjeù
 *
kobj
,

5221 
kobj_©Œibu‹
 *
©Œ
,

5222 *
buf
)

5224 
sc¡_rg‘_group
 *
tg
;

5225 
i
;

5227 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

5228 
i
 = 
	`ARRAY_SIZE
(
sc¡_tg_¡©e_Çmes
) - 1; i >= 0; i--)

5229 ià(
sc¡_tg_¡©e_Çmes
[
i
].
s
 =ð
tg
->
¡©e
)

5232  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "%s\n" 
SCST_SYSFS_KEY_MARK
 "\n",

5233 
i
 >ð0 ? 
sc¡_tg_¡©e_Çmes
[i].
n
 : "???");

5234 
	}
}

5236 
	$sc¡_tg_¡©e_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
w
)

5238 
sc¡_rg‘_group
 *
tg
;

5239 *
cmd
, *
p
;

5240 
i
, 
»s
;

5242 
	`TRACE_ENTRY
();

5244 
cmd
 = 
w
->
buf
;

5245 
tg
 = 
	`cÚš”_of
(
w
->
kobj
, 
sc¡_rg‘_group
, kobj);

5247 
p
 = 
	`¡rchr
(
cmd
, '\n');

5248 ià(
p
)

5249 *
p
 = '\0';

5251 
i
 = 
	`ARRAY_SIZE
(
sc¡_tg_¡©e_Çmes
) - 1; i >= 0; i--)

5252 ià(
	`¡rcmp
(
sc¡_tg_¡©e_Çmes
[
i
].
n
, 
cmd
) == 0)

5255 
»s
 = -
EINVAL
;

5256 ià(
i
 < 0)

5257 
out
;

5258 
»s
 = 
	`sc¡_tg_£t_¡©e
(
tg
, 
sc¡_tg_¡©e_Çmes
[
i
].
s
);

5259 
out
:

5260 
	`kobjeù_put
(
w
->
kobj
);

5261 
	`TRACE_EXIT_RES
(
»s
);

5262  
»s
;

5263 
	}
}

5265 
ssize_t
 
	$sc¡_tg_¡©e_¡Üe
(
kobjeù
 *
kobj
,

5266 
kobj_©Œibu‹
 *
©Œ
,

5267 cÚ¡ *
buf
, 
size_t
 
couÁ
)

5269 *
cmd
;

5270 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

5271 
»s
;

5273 
	`TRACE_ENTRY
();

5275 
»s
 = -
ENOMEM
;

5276 
cmd
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

5277 ià(!
cmd
)

5278 
out
;

5280 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_tg_¡©e_¡Üe_wÜk_â
, 
çl£
,

5281 &
wÜk
);

5282 ià(
»s
)

5283 
out
;

5285 
wÜk
->
buf
 = 
cmd
;

5286 
wÜk
->
kobj
 = kobj;

5287 
	`kobjeù_g‘
(
kobj
);

5288 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

5290 
out
:

5291 ià(
»s
 == 0)

5292 
»s
 = 
couÁ
;

5293 
	`TRACE_EXIT_RES
(
»s
);

5294  
»s
;

5295 
	}
}

5297 
kobj_©Œibu‹
 
	gsc¡_tg_¡©e
 =

5298 
__ATTR
(
¡©e
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg_¡©e_show
,

5299 
sc¡_tg_¡©e_¡Üe
);

5301 
ssize_t
 
	$sc¡_tg_mgmt_show
(
kobjeù
 *
kobj
,

5302 
kobj_©Œibu‹
 *
©Œ
,

5303 *
buf
)

5305 cÚ¡ 
h–p
[] =

5309  
	`sú´štf
(
buf
, 
PAGE_SIZE
, 
h–p
);

5310 
	}
}

5312 
	$sc¡_tg_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
w
)

5314 
sc¡_rg‘_group
 *
tg
;

5315 *
cmd
, *
p
, *
µ
, *
rg‘_Çme
;

5316 
»s
;

5318 
	`TRACE_ENTRY
();

5320 
cmd
 = 
w
->
buf
;

5321 
tg
 = 
	`cÚš”_of
(
w
->
kobj
, 
sc¡_rg‘_group
, kobj);

5323 
p
 = 
	`¡rchr
(
cmd
, '\n');

5324 ià(
p
)

5325 *
p
 = '\0';

5327 
»s
 = -
EINVAL
;

5328 
µ
 = 
cmd
;

5329 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5330 ià(
	`¡rÿ£cmp
(
p
, "add") == 0) {

5331 
rg‘_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5332 ià(!*
rg‘_Çme
)

5333 
out
;

5334 
»s
 = 
	`sc¡_tg_tgt_add
(
tg
, 
rg‘_Çme
);

5335 } ià(
	`¡rÿ£cmp
(
p
, "del") == 0) {

5336 
rg‘_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5337 ià(!*
rg‘_Çme
)

5338 
out
;

5339 
»s
 = 
	`sc¡_tg_tgt_»move_by_Çme
(
tg
, 
rg‘_Çme
);

5341 
out
:

5342 
	`kobjeù_put
(
w
->
kobj
);

5343 
	`TRACE_EXIT_RES
(
»s
);

5344  
»s
;

5345 
	}
}

5347 
ssize_t
 
	$sc¡_tg_mgmt_¡Üe
(
kobjeù
 *
kobj
,

5348 
kobj_©Œibu‹
 *
©Œ
,

5349 cÚ¡ *
buf
, 
size_t
 
couÁ
)

5351 *
cmd
;

5352 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

5353 
»s
;

5355 
	`TRACE_ENTRY
();

5357 
»s
 = -
ENOMEM
;

5358 
cmd
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

5359 ià(!
cmd
)

5360 
out
;

5362 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_tg_mgmt_¡Üe_wÜk_â
, 
çl£
,

5363 &
wÜk
);

5364 ià(
»s
)

5365 
out
;

5367 
wÜk
->
buf
 = 
cmd
;

5368 
wÜk
->
kobj
 = kobj;

5369 
	`kobjeù_g‘
(
kobj
);

5370 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

5372 
out
:

5373 ià(
»s
 == 0)

5374 
»s
 = 
couÁ
;

5375 
	`TRACE_EXIT_RES
(
»s
);

5376  
»s
;

5377 
	}
}

5379 
kobj_©Œibu‹
 
	gsc¡_tg_mgmt
 =

5380 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_tg_mgmt_show
,

5381 
sc¡_tg_mgmt_¡Üe
);

5383 cÚ¡ 
©Œibu‹
 *
	gsc¡_tg_©Œs
[] = {

5384 &
sc¡_tg_mgmt
.
©Œ
,

5385 &
sc¡_tg_group_id
.
©Œ
,

5386 &
sc¡_tg_´eã¼ed
.
©Œ
,

5387 &
sc¡_tg_¡©e
.
©Œ
,

5388 
NULL
,

5391 
	$sc¡_tg_sysfs_add
(
sc¡_dev_group
 *
dg
, 
sc¡_rg‘_group
 *
tg
)

5393 
»s
;

5395 
	`TRACE_ENTRY
();

5396 
»s
 = 
	`kobjeù_add
(&
tg
->
kobj
, 
dg
->
tg_kobj
, "%s",g->
Çme
);

5397 ià(
»s
)

5398 
”r
;

5399 
»s
 = 
	`sysfs_ü—‹_fžes
(&
tg
->
kobj
, 
sc¡_tg_©Œs
);

5400 ià(
»s
)

5401 
”r
;

5402 
out
:

5403 
	`TRACE_EXIT_RES
(
»s
);

5404  
»s
;

5405 
”r
:

5406 
	`sc¡_tg_sysfs_d–
(
tg
);

5407 
out
;

5408 
	}
}

5410 
	$sc¡_tg_sysfs_d–
(
sc¡_rg‘_group
 *
tg
)

5412 
	`TRACE_ENTRY
();

5413 
	`sysfs_»move_fžes
(&
tg
->
kobj
, 
sc¡_tg_©Œs
);

5414 
	`kobjeù_d–
(&
tg
->
kobj
);

5415 
	`TRACE_EXIT
();

5416 
	}
}

5422 
ssize_t
 
	$sc¡_dg_tgs_mgmt_show
(
kobjeù
 *
kobj
,

5423 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5425 cÚ¡ 
h–p
[] =

5429  
	`sú´štf
(
buf
, 
PAGE_SIZE
, 
h–p
);

5430 
	}
}

5432 
	$sc¡_dg_tgs_mgmt_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
w
)

5434 
sc¡_dev_group
 *
dg
;

5435 *
cmd
, *
p
, *
µ
, *
dev_Çme
;

5436 
»s
;

5438 
	`TRACE_ENTRY
();

5440 
cmd
 = 
w
->
buf
;

5441 
dg
 = 
	`sc¡_lookup_dg_by_kobj
(
w
->
kobj
);

5442 
	`WARN_ON
(!
dg
);

5444 
p
 = 
	`¡rchr
(
cmd
, '\n');

5445 ià(
p
)

5446 *
p
 = '\0';

5448 
»s
 = -
EINVAL
;

5449 
µ
 = 
cmd
;

5450 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5451 ià(
	`¡rÿ£cmp
(
p
, "create") == 0 || strcasecmp(p, "add") == 0) {

5452 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5453 ià(!*
dev_Çme
)

5454 
out
;

5455 
»s
 = 
	`sc¡_tg_add
(
dg
, 
dev_Çme
);

5456 } ià(
	`¡rÿ£cmp
(
p
, "del") == 0) {

5457 
dev_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5458 ià(!*
dev_Çme
)

5459 
out
;

5460 
»s
 = 
	`sc¡_tg_»move_by_Çme
(
dg
, 
dev_Çme
);

5462 
out
:

5463 
	`kobjeù_put
(
w
->
kobj
);

5464 
	`TRACE_EXIT_RES
(
»s
);

5465  
»s
;

5466 
	}
}

5468 
ssize_t
 
	$sc¡_dg_tgs_mgmt_¡Üe
(
kobjeù
 *
kobj
,

5469 
kobj_©Œibu‹
 *
©Œ
,

5470 cÚ¡ *
buf
, 
size_t
 
couÁ
)

5472 *
cmd
;

5473 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

5474 
»s
;

5476 
	`TRACE_ENTRY
();

5478 
»s
 = -
ENOMEM
;

5479 
cmd
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

5480 ià(!
cmd
)

5481 
out
;

5483 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_dg_tgs_mgmt_¡Üe_wÜk_â
, 
çl£
,

5484 &
wÜk
);

5485 ià(
»s
)

5486 
out
;

5488 
wÜk
->
buf
 = 
cmd
;

5489 
wÜk
->
kobj
 = kobj;

5490 
	`kobjeù_g‘
(
kobj
);

5491 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

5493 
out
:

5494 ià(
»s
 == 0)

5495 
»s
 = 
couÁ
;

5496 
	`TRACE_EXIT_RES
(
»s
);

5497  
»s
;

5498 
	}
}

5500 
kobj_©Œibu‹
 
	gsc¡_dg_tgs_mgmt
 =

5501 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_dg_tgs_mgmt_show
,

5502 
sc¡_dg_tgs_mgmt_¡Üe
);

5504 cÚ¡ 
©Œibu‹
 *
	gsc¡_dg_tgs_©Œs
[] = {

5505 &
sc¡_dg_tgs_mgmt
.
©Œ
,

5506 
NULL
,

5513 
	$sc¡_dg_sysfs_add
(
kobjeù
 *
·»Á
, 
sc¡_dev_group
 *
dg
)

5515 
»s
;

5517 
dg
->
dev_kobj
 = 
NULL
;

5518 
dg
->
tg_kobj
 = 
NULL
;

5519 
»s
 = 
	`kobjeù_add
(&
dg
->
kobj
, 
·»Á
, "%s", dg->
Çme
);

5520 ià(
»s
)

5521 
”r
;

5522 
»s
 = -
EEXIST
;

5523 
dg
->
dev_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("deviûs", &dg->
kobj
);

5524 ià(!
dg
->
dev_kobj
)

5525 
”r
;

5526 
»s
 = 
	`sysfs_ü—‹_fžes
(
dg
->
dev_kobj
, 
sc¡_dg_devs_©Œs
);

5527 ià(
»s
)

5528 
”r
;

5529 
dg
->
tg_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("rg‘_groups", &dg->
kobj
);

5530 ià(!
dg
->
tg_kobj
)

5531 
”r
;

5532 
»s
 = 
	`sysfs_ü—‹_fžes
(
dg
->
tg_kobj
, 
sc¡_dg_tgs_©Œs
);

5533 ià(
»s
)

5534 
”r
;

5535 
out
:

5536  
»s
;

5537 
”r
:

5538 
	`sc¡_dg_sysfs_d–
(
dg
);

5539 
out
;

5540 
	}
}

5542 
	$sc¡_dg_sysfs_d–
(
sc¡_dev_group
 *
dg
)

5544 ià(
dg
->
tg_kobj
) {

5545 
	`sysfs_»move_fžes
(
dg
->
tg_kobj
, 
sc¡_dg_tgs_©Œs
);

5546 
	`kobjeù_d–
(
dg
->
tg_kobj
);

5547 
	`kobjeù_put
(
dg
->
tg_kobj
);

5548 
dg
->
tg_kobj
 = 
NULL
;

5550 ià(
dg
->
dev_kobj
) {

5551 
	`sysfs_»move_fžes
(
dg
->
dev_kobj
, 
sc¡_dg_devs_©Œs
);

5552 
	`kobjeù_d–
(
dg
->
dev_kobj
);

5553 
	`kobjeù_put
(
dg
->
dev_kobj
);

5554 
dg
->
dev_kobj
 = 
NULL
;

5556 
	`kobjeù_d–
(&
dg
->
kobj
);

5557 
	}
}

5559 
ssize_t
 
	$sc¡_deviû_groups_mgmt_show
(
kobjeù
 *
kobj
,

5560 
kobj_©Œibu‹
 *
©Œ
,

5561 *
buf
)

5563 cÚ¡ 
h–p
[] =

5567  
	`sú´štf
(
buf
, 
PAGE_SIZE
, 
h–p
);

5568 
	}
}

5570 
ssize_t
 
	$sc¡_deviû_groups_mgmt_¡Üe
(
kobjeù
 *
kobj
,

5571 
kobj_©Œibu‹
 *
©Œ
,

5572 cÚ¡ *
buf
, 
size_t
 
couÁ
)

5574 
»s
;

5575 *
p
, *
µ
, *
šput
, *
group_Çme
;

5577 
	`TRACE_ENTRY
();

5579 
šput
 = 
	`ka¥rštf
(
GFP_KERNEL
, "%.*s", ()
couÁ
, 
buf
);

5580 
µ
 = 
šput
;

5581 
p
 = 
	`¡rchr
(
šput
, '\n');

5582 ià(
p
)

5583 *
p
 = '\0';

5585 
»s
 = -
EINVAL
;

5586 
p
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5587 ià(
	`¡rÿ£cmp
(
p
, "create") == 0 || strcasecmp(p, "add") == 0) {

5588 
group_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5589 ià(!*
group_Çme
)

5590 
out
;

5591 
»s
 = 
	`sc¡_dg_add
(
sc¡_deviû_groups_kobj
, 
group_Çme
);

5592 } ià(
	`¡rÿ£cmp
(
p
, "del") == 0) {

5593 
group_Çme
 = 
	`sc¡_g‘_Ãxt_Ëxem
(&
µ
);

5594 ià(!*
group_Çme
)

5595 
out
;

5596 
»s
 = 
	`sc¡_dg_»move
(
group_Çme
);

5598 
out
:

5599 
	`kä“
(
šput
);

5600 ià(
»s
 == 0)

5601 
»s
 = 
couÁ
;

5602 
	`TRACE_EXIT_RES
(
»s
);

5603  
»s
;

5604 
	}
}

5606 
kobj_©Œibu‹
 
	gsc¡_deviû_groups_mgmt
 =

5607 
__ATTR
(
mgmt
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_deviû_groups_mgmt_show
,

5608 
sc¡_deviû_groups_mgmt_¡Üe
);

5610 cÚ¡ 
©Œibu‹
 *
	gsc¡_deviû_groups_©Œs
[] = {

5611 &
sc¡_deviû_groups_mgmt
.
©Œ
,

5612 
NULL
,

5619 
ssize_t
 
	$sc¡_th»ads_show
(
kobjeù
 *
kobj
,

5620 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5622 
couÁ
;

5624 
	`TRACE_ENTRY
();

5626 
couÁ
 = 
	`¥rštf
(
buf
, "%d\n%s", 
sc¡_maš_cmd_th»ads
.
Ä_th»ads
,

5627 (
sc¡_maš_cmd_th»ads
.
Ä_th»ads
 !ð
sc¡_th»ads
) ?

5628 
SCST_SYSFS_KEY_MARK
 "\n" : "");

5630 
	`TRACE_EXIT
();

5631  
couÁ
;

5632 
	}
}

5634 
	$sc¡_´oûss_th»ads_¡Üe
(
ÃwŠ
)

5636 
»s
;

5637 
ÞdŠ
, 
d–
;

5639 
	`TRACE_ENTRY
();

5641 
	`TRACE_DBG
("ÃwŠ %d", 
ÃwŠ
);

5643 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

5644 ià(
»s
 != 0)

5645 
out
;

5647 
ÞdŠ
 = 
sc¡_maš_cmd_th»ads
.
Ä_th»ads
;

5649 
d–
 = 
ÃwŠ
 - 
ÞdŠ
;

5650 ià(
d–
 < 0)

5651 
	`sc¡_d–_th»ads
(&
sc¡_maš_cmd_th»ads
, -
d–
);

5653 
»s
 = 
	`sc¡_add_th»ads
(&
sc¡_maš_cmd_th»ads
, 
NULL
, NULL, 
d–
);

5654 ià(
»s
 != 0)

5655 
out_up
;

5658 
	`PRINT_INFO
("Chªged cmdh»ad num: old %ld,‚ew %d", 
ÞdŠ
, 
ÃwŠ
);

5660 
out_up
:

5661 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

5663 
out
:

5664 
	`TRACE_EXIT_RES
(
»s
);

5665  
»s
;

5666 
	}
}

5668 
	$sc¡_th»ads_¡Üe_wÜk_â
(
sc¡_sysfs_wÜk_™em
 *
wÜk
)

5670  
	`sc¡_´oûss_th»ads_¡Üe
(
wÜk
->
Ãw_th»ads_num
);

5671 
	}
}

5673 
ssize_t
 
	$sc¡_th»ads_¡Üe
(
kobjeù
 *
kobj
,

5674 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5676 
»s
;

5677 
ÃwŠ
;

5678 
sc¡_sysfs_wÜk_™em
 *
wÜk
;

5680 
	`TRACE_ENTRY
();

5682 
»s
 = 
	`¡riù_¡¹Þ
(
buf
, 0, &
ÃwŠ
);

5683 ià(
»s
 != 0) {

5684 
	`PRINT_ERROR
("¡riù_¡¹Þ(èfÜ % çžed: %d ", 
buf
, 
»s
);

5685 
out
;

5687 ià(
ÃwŠ
 <= 0) {

5688 
	`PRINT_ERROR
("IÎeg®h»ad num v®u%ld", 
ÃwŠ
);

5689 
»s
 = -
EINVAL
;

5690 
out
;

5693 
»s
 = 
	`sc¡_®loc_sysfs_wÜk
(
sc¡_th»ads_¡Üe_wÜk_â
, 
çl£
, &
wÜk
);

5694 ià(
»s
 != 0)

5695 
out
;

5697 
wÜk
->
Ãw_th»ads_num
 = 
ÃwŠ
;

5699 
»s
 = 
	`sc¡_sysfs_queue_wa™_wÜk
(
wÜk
);

5700 ià(
»s
 == 0)

5701 
»s
 = 
couÁ
;

5703 
out
:

5704 
	`TRACE_EXIT_RES
(
»s
);

5705  
»s
;

5706 
	}
}

5708 
kobj_©Œibu‹
 
	gsc¡_th»ads_©Œ
 =

5709 
__ATTR
(
th»ads
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_th»ads_show
,

5710 
sc¡_th»ads_¡Üe
);

5712 
ssize_t
 
	$sc¡_£tup_id_show
(
kobjeù
 *
kobj
,

5713 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5715 
couÁ
;

5717 
	`TRACE_ENTRY
();

5719 
couÁ
 = 
	`¥rštf
(
buf
, "0x%x\n%s\n", 
sc¡_£tup_id
,

5720 (
sc¡_£tup_id
 =ð0è? "" : 
SCST_SYSFS_KEY_MARK
);

5722 
	`TRACE_EXIT
();

5723  
couÁ
;

5724 
	}
}

5726 
ssize_t
 
	$sc¡_£tup_id_¡Üe
(
kobjeù
 *
kobj
,

5727 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5729 
»s
;

5730 
v®
;

5732 
	`TRACE_ENTRY
();

5734 
»s
 = 
	`¡riù_¡¹oul
(
buf
, 0, &
v®
);

5735 ià(
»s
 != 0) {

5736 
	`PRINT_ERROR
("¡riù_¡¹oul(èfÜ % çžed: %d ", 
buf
, 
»s
);

5737 
out
;

5740 
sc¡_£tup_id
 = 
v®
;

5741 
	`PRINT_INFO
("Chªged sc¡_£tup_idØ%x", 
sc¡_£tup_id
);

5743 
»s
 = 
couÁ
;

5745 
out
:

5746 
	`TRACE_EXIT_RES
(
»s
);

5747  
»s
;

5748 
	}
}

5750 
kobj_©Œibu‹
 
	gsc¡_£tup_id_©Œ
 =

5751 
__ATTR
(
£tup_id
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_£tup_id_show
,

5752 
sc¡_£tup_id_¡Üe
);

5754 
ssize_t
 
	$sc¡_max_skËt_cmd_show
(
kobjeù
 *
kobj
,

5755 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5757 
couÁ
;

5759 
	`TRACE_ENTRY
();

5761 
couÁ
 = 
	`¥rštf
(
buf
, "%d\n%s\n", 
sc¡_max_skËt_cmd
,

5762 (
sc¡_max_skËt_cmd
 =ð
SCST_DEF_MAX_TASKLET_CMD
)

5763 ? "" : 
SCST_SYSFS_KEY_MARK
);

5765 
	`TRACE_EXIT
();

5766  
couÁ
;

5767 
	}
}

5769 
ssize_t
 
	$sc¡_max_skËt_cmd_¡Üe
(
kobjeù
 *
kobj
,

5770 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5772 
»s
;

5773 
v®
;

5775 
	`TRACE_ENTRY
();

5777 
»s
 = 
	`¡riù_¡¹oul
(
buf
, 0, &
v®
);

5778 ià(
»s
 != 0) {

5779 
	`PRINT_ERROR
("¡riù_¡¹oul(èfÜ % çžed: %d ", 
buf
, 
»s
);

5780 
out
;

5783 
sc¡_max_skËt_cmd
 = 
v®
;

5784 
	`PRINT_INFO
("Chªged sc¡_max_skËt_cmdØ%d", 
sc¡_max_skËt_cmd
);

5786 
»s
 = 
couÁ
;

5788 
out
:

5789 
	`TRACE_EXIT_RES
(
»s
);

5790  
»s
;

5791 
	}
}

5793 
kobj_©Œibu‹
 
	gsc¡_max_skËt_cmd_©Œ
 =

5794 
__ATTR
(
max_skËt_cmd
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_max_skËt_cmd_show
,

5795 
sc¡_max_skËt_cmd_¡Üe
);

5797 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

5799 
ssize_t
 
	$sc¡_maš_Œaû_Ëv–_show
(
kobjeù
 *
kobj
,

5800 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5802  
	`sc¡_Œaû_Ëv–_show
(
sc¡_loÿl_Œaû_tbl
, 
Œaû_æag
,

5803 
buf
, 
NULL
);

5804 
	}
}

5806 
ssize_t
 
	$sc¡_maš_Œaû_Ëv–_¡Üe
(
kobjeù
 *
kobj
,

5807 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

5809 
»s
;

5811 
	`TRACE_ENTRY
();

5813 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_log_mu‹x
);

5814 ià(
»s
 != 0)

5815 
out
;

5817 
»s
 = 
	`sc¡_wr™e_Œaû
(
buf
, 
couÁ
, &
Œaû_æag
,

5818 
SCST_DEFAULT_LOG_FLAGS
, "sc¡", 
sc¡_loÿl_Œaû_tbl
);

5820 
	`mu‹x_uÆock
(&
sc¡_log_mu‹x
);

5822 
out
:

5823 
	`TRACE_EXIT_RES
(
»s
);

5824  
»s
;

5825 
	}
}

5827 
kobj_©Œibu‹
 
	gsc¡_maš_Œaû_Ëv–_©Œ
 =

5828 
__ATTR
(
Œaû_Ëv–
, 
S_IRUGO
 | 
S_IWUSR
, 
sc¡_maš_Œaû_Ëv–_show
,

5829 
sc¡_maš_Œaû_Ëv–_¡Üe
);

5833 
ssize_t
 
	$sc¡_v”siÚ_show
(
kobjeù
 *
kobj
,

5834 
kobj_©Œibu‹
 *
©Œ
,

5835 *
buf
)

5837 
	`TRACE_ENTRY
();

5839 
	`¥rštf
(
buf
, "%s\n", 
SCST_VERSION_STRING
);

5841 #ifdeà
CONFIG_SCST_STRICT_SERIALIZING


5842 
	`¡rÿt
(
buf
, "STRICT_SERIALIZING\n");

5845 #ifdeà
CONFIG_SCST_EXTRACHECKS


5846 
	`¡rÿt
(
buf
, "EXTRACHECKS\n");

5849 #ifdeà
CONFIG_SCST_TRACING


5850 
	`¡rÿt
(
buf
, "TRACING\n");

5853 #ifdeà
CONFIG_SCST_DEBUG


5854 
	`¡rÿt
(
buf
, "DEBUG\n");

5857 #ifdeà
CONFIG_SCST_DEBUG_TM


5858 
	`¡rÿt
(
buf
, "DEBUG_TM\n");

5861 #ifdeà
CONFIG_SCST_DEBUG_RETRY


5862 
	`¡rÿt
(
buf
, "DEBUG_RETRY\n");

5865 #ifdeà
CONFIG_SCST_DEBUG_OOM


5866 
	`¡rÿt
(
buf
, "DEBUG_OOM\n");

5869 #ifdeà
CONFIG_SCST_DEBUG_SN


5870 
	`¡rÿt
(
buf
, "DEBUG_SN\n");

5873 #ifdeà
CONFIG_SCST_USE_EXPECTED_VALUES


5874 
	`¡rÿt
(
buf
, "USE_EXPECTED_VALUES\n");

5877 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


5878 
	`¡rÿt
(
buf
, "TEST_IO_IN_SIRQ\n");

5881 #ifdeà
CONFIG_SCST_STRICT_SECURITY


5882 
	`¡rÿt
(
buf
, "STRICT_SECURITY\n");

5885 
	`TRACE_EXIT
();

5886  
	`¡¾’
(
buf
);

5887 
	}
}

5889 
kobj_©Œibu‹
 
	gsc¡_v”siÚ_©Œ
 =

5890 
__ATTR
(
v”siÚ
, 
S_IRUGO
, 
sc¡_v”siÚ_show
, 
NULL
);

5892 
ssize_t
 
	$sc¡_Ï¡_sysfs_mgmt_»s_show
(
kobjeù
 *
kobj
,

5893 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

5895 
»s
;

5897 
	`TRACE_ENTRY
();

5899 
	`¥š_lock
(&
sysfs_wÜk_lock
);

5900 
	`TRACE_DBG
("aùive_sysfs_wÜk %d", 
aùive_sysfs_wÜks
);

5901 ià(
aùive_sysfs_wÜks
 > 0)

5902 
»s
 = -
EAGAIN
;

5904 
»s
 = 
	`¥rštf
(
buf
, "%d\n", 
Ï¡_sysfs_wÜk_»s
);

5905 
	`¥š_uÆock
(&
sysfs_wÜk_lock
);

5907 
	`TRACE_EXIT_RES
(
»s
);

5908  
»s
;

5909 
	}
}

5911 
kobj_©Œibu‹
 
	gsc¡_Ï¡_sysfs_mgmt_»s_©Œ
 =

5912 
__ATTR
(
Ï¡_sysfs_mgmt_»s
, 
S_IRUGO
,

5913 
sc¡_Ï¡_sysfs_mgmt_»s_show
, 
NULL
);

5915 
©Œibu‹
 *
	gsc¡_sysfs_roÙ_deçuÉ_©Œs
[] = {

5916 &
sc¡_th»ads_©Œ
.
©Œ
,

5917 &
sc¡_£tup_id_©Œ
.
©Œ
,

5918 &
sc¡_max_skËt_cmd_©Œ
.
©Œ
,

5919 #ià
defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

5920 &
sc¡_maš_Œaû_Ëv–_©Œ
.
©Œ
,

5922 &
sc¡_v”siÚ_©Œ
.
©Œ
,

5923 &
sc¡_Ï¡_sysfs_mgmt_»s_©Œ
.
©Œ
,

5924 
NULL
,

5927 
	$sc¡_sysfs_roÙ_»Ëa£
(
kobjeù
 *
kobj
)

5929 
	`com¶‘e_®l
(&
sc¡_sysfs_roÙ_»Ëa£_com¶‘iÚ
);

5930 
	}
}

5932 
kobj_ty³
 
	gsc¡_sysfs_roÙ_kty³
 = {

5933 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

5934 .
	g»Ëa£
 = 
sc¡_sysfs_roÙ_»Ëa£
,

5935 .
	gdeçuÉ_©Œs
 = 
sc¡_sysfs_roÙ_deçuÉ_©Œs
,

5942 
DEFINE_MUTEX
(
sc¡_sysfs_u£r_šfo_mu‹x
);

5945 
LIST_HEAD
(
sc¡_sysfs_u£r_šfo_li¡
);

5946 
ušt32_t
 
	gsc¡_sysfs_šfo_cur_cook›
;

5949 
sc¡_sysfs_u£r_šfo
 *
	$sc¡_sysfs_u£r_fšd_šfo
(
ušt32_t
 
cook›
)

5951 
sc¡_sysfs_u£r_šfo
 *
šfo
, *
»s
 = 
NULL
;

5953 
	`TRACE_ENTRY
();

5955 
	`li¡_fÜ_—ch_’Œy
(
šfo
, &
sc¡_sysfs_u£r_šfo_li¡
,

5956 
šfo_li¡_’Œy
) {

5957 ià(
šfo
->
šfo_cook›
 =ð
cook›
) {

5958 
»s
 = 
šfo
;

5963 
	`TRACE_EXIT_HRES
(
»s
);

5964  
»s
;

5965 
	}
}

5975 
sc¡_sysfs_u£r_šfo
 *
	$sc¡_sysfs_u£r_g‘_šfo
(
ušt32_t
 
cook›
)

5977 
sc¡_sysfs_u£r_šfo
 *
»s
 = 
NULL
;

5979 
	`TRACE_ENTRY
();

5981 
	`mu‹x_lock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

5983 
»s
 = 
	`sc¡_sysfs_u£r_fšd_šfo
(
cook›
);

5984 ià(
»s
 !ð
NULL
) {

5985 ià(!
»s
->
šfo_bešg_execu‹d
)

5986 
»s
->
šfo_bešg_execu‹d
 = 1;

5989 
	`mu‹x_uÆock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

5991 
	`TRACE_EXIT_HRES
(
»s
);

5992  
»s
;

5993 
	}
}

5994 
EXPORT_SYMBOL_GPL
(
sc¡_sysfs_u£r_g‘_šfo
);

6008 
	$sc¡_sysfs_u£r_add_šfo
(
sc¡_sysfs_u£r_šfo
 **
out_šfo
)

6010 
»s
 = 0;

6011 
sc¡_sysfs_u£r_šfo
 *
šfo
;

6013 
	`TRACE_ENTRY
();

6015 
šfo
 = 
	`kz®loc
((*šfo), 
GFP_KERNEL
);

6016 ià(
šfo
 =ð
NULL
) {

6017 
	`PRINT_ERROR
("Unableo‡llocate sysfs user info (size %zd)",

6018 (*
šfo
));

6019 
»s
 = -
ENOMEM
;

6020 
out
;

6023 
	`mu‹x_lock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

6025 (
šfo
->
šfo_cook›
 == 0) ||

6026 (
	`sc¡_sysfs_u£r_fšd_šfo
(
šfo
->
šfo_cook›
è!ð
NULL
))

6027 
šfo
->
šfo_cook›
 = 
sc¡_sysfs_šfo_cur_cook›
++;

6029 
	`š™_com¶‘iÚ
(&
šfo
->
šfo_com¶‘iÚ
);

6031 
	`li¡_add_ž
(&
šfo
->
šfo_li¡_’Œy
, &
sc¡_sysfs_u£r_šfo_li¡
);

6032 
šfo
->
šfo_š_li¡
 = 1;

6034 *
out_šfo
 = 
šfo
;

6036 
	`mu‹x_uÆock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

6038 
out
:

6039 
	`TRACE_EXIT_RES
(
»s
);

6040  
»s
;

6041 
	}
}

6042 
EXPORT_SYMBOL_GPL
(
sc¡_sysfs_u£r_add_šfo
);

6047 
	$sc¡_sysfs_u£r_d–_šfo
(
sc¡_sysfs_u£r_šfo
 *
šfo
)

6049 
	`TRACE_ENTRY
();

6051 
	`mu‹x_lock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

6053 ià(
šfo
->
šfo_š_li¡
)

6054 
	`li¡_d–
(&
šfo
->
šfo_li¡_’Œy
);

6056 
	`mu‹x_uÆock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

6058 
	`kä“
(
šfo
);

6060 
	`TRACE_EXIT
();

6062 
	}
}

6063 
EXPORT_SYMBOL_GPL
(
sc¡_sysfs_u£r_d–_šfo
);

6070 
boÞ
 
	$sc¡_sysfs_u£r_šfo_executšg
(
sc¡_sysfs_u£r_šfo
 *
šfo
)

6072 
boÞ
 
»s
;

6074 
	`TRACE_ENTRY
();

6076 
	`mu‹x_lock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

6078 
»s
 = 
šfo
->
šfo_bešg_execu‹d
;

6080 ià(
šfo
->
šfo_š_li¡
) {

6081 
	`li¡_d–
(&
šfo
->
šfo_li¡_’Œy
);

6082 
šfo
->
šfo_š_li¡
 = 0;

6085 
	`mu‹x_uÆock
(&
sc¡_sysfs_u£r_šfo_mu‹x
);

6087 
	`TRACE_EXIT_RES
(
»s
);

6088  
»s
;

6089 
	}
}

6101 
	$sc¡_wa™_šfo_com¶‘iÚ
(
sc¡_sysfs_u£r_šfo
 *
šfo
,

6102 
timeout
)

6104 
»s
, 
rc
;

6106 
	`TRACE_ENTRY
();

6108 
	`TRACE_DBG
("Wa™šg fÜ infØ%°com¶‘iÚ", 
šfo
);

6111 
rc
 = 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(

6112 &
šfo
->
šfo_com¶‘iÚ
, 
timeout
);

6113 ià(
rc
 > 0) {

6114 
	`TRACE_DBG
("Waiting for info %p finished with %d",

6115 
šfo
, 
rc
);

6117 } ià(
rc
 == 0) {

6118 ià(!
	`sc¡_sysfs_u£r_šfo_executšg
(
šfo
)) {

6119 
	`PRINT_ERROR
("Timeout waiting for user "

6120 "¥aûƒv’ˆ%p", 
šfo
);

6121 
»s
 = -
EBUSY
;

6122 
out
;

6125 
	`TRACE_DBG
("Keep waiting for info %p completion",

6126 
šfo
);

6127 
	`wa™_fÜ_com¶‘iÚ
(&
šfo
->
šfo_com¶‘iÚ
);

6130 } ià(
rc
 !ð-
ERESTARTSYS
) {

6131 
»s
 = 
rc
;

6132 
	`PRINT_ERROR
("wait_for_completion() failed: %d",

6133 
»s
);

6134 
out
;

6136 
	`TRACE_DBG
("Waiting for info %p finished with %d, "

6137 "»Œyšg", 
šfo
, 
rc
);

6141 
	`TRACE_DBG
("šfØ%p, stu %d", 
šfo
, info->
šfo_¡©us
);

6142 
»s
 = 
šfo
->
šfo_¡©us
;

6144 
out
:

6145 
	`TRACE_EXIT_RES
(
»s
);

6146  
»s
;

6147 
	}
}

6148 
EXPORT_SYMBOL_GPL
(
sc¡_wa™_šfo_com¶‘iÚ
);

6150 
kobjeù
 
	gsc¡_sysfs_roÙ_kobj
;

6152 
__š™
 
	$sc¡_sysfs_š™
()

6154 
»s
 = 0;

6156 
	`TRACE_ENTRY
();

6158 
sysfs_wÜk_th»ad
 = 
	`kth»ad_run
(
sysfs_wÜk_th»ad_â
,

6159 
NULL
, "scst_uid");

6160 ià(
	`IS_ERR
(
sysfs_wÜk_th»ad
)) {

6161 
»s
 = 
	`PTR_ERR
(
sysfs_wÜk_th»ad
);

6162 
	`PRINT_ERROR
("kthread_run() for user interfacehread "

6163 "çžed: %d", 
»s
);

6164 
sysfs_wÜk_th»ad
 = 
NULL
;

6165 
out
;

6168 
»s
 = 
	`kobjeù_š™_ªd_add
(&
sc¡_sysfs_roÙ_kobj
,

6169 &
sc¡_sysfs_roÙ_kty³
, 
k”Ãl_kobj
, "%s", "scst_tgt");

6170 ià(
»s
 != 0)

6171 
sysfs_roÙ_add_”rÜ
;

6173 
sc¡_rg‘s_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("targets",

6174 &
sc¡_sysfs_roÙ_kobj
);

6175 ià(
sc¡_rg‘s_kobj
 =ð
NULL
)

6176 
rg‘s_kobj_”rÜ
;

6178 
sc¡_deviûs_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("devices",

6179 &
sc¡_sysfs_roÙ_kobj
);

6180 ià(
sc¡_deviûs_kobj
 =ð
NULL
)

6181 
deviûs_kobj_”rÜ
;

6183 
»s
 = 
	`sc¡_add_sgv_kobj
(&
sc¡_sysfs_roÙ_kobj
, "sgv");

6184 ià(
»s
 != 0)

6185 
sgv_kobj_”rÜ
;

6187 
sc¡_hªdËrs_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("handlers",

6188 &
sc¡_sysfs_roÙ_kobj
);

6189 ià(
sc¡_hªdËrs_kobj
 =ð
NULL
)

6190 
hªdËrs_kobj_”rÜ
;

6192 
sc¡_deviû_groups_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("device_groups",

6193 &
sc¡_sysfs_roÙ_kobj
);

6194 ià(
sc¡_deviû_groups_kobj
 =ð
NULL
)

6195 
deviû_groups_kobj_”rÜ
;

6197 ià(
	`sysfs_ü—‹_fžes
(
sc¡_deviû_groups_kobj
,

6198 
sc¡_deviû_groups_©Œs
))

6199 
deviû_groups_©Œs_”rÜ
;

6201 
out
:

6202 
	`TRACE_EXIT_RES
(
»s
);

6203  
»s
;

6205 
deviû_groups_©Œs_”rÜ
:

6206 
	`kobjeù_d–
(
sc¡_deviû_groups_kobj
);

6207 
	`kobjeù_put
(
sc¡_deviû_groups_kobj
);

6209 
deviû_groups_kobj_”rÜ
:

6210 
	`kobjeù_d–
(
sc¡_hªdËrs_kobj
);

6211 
	`kobjeù_put
(
sc¡_hªdËrs_kobj
);

6213 
hªdËrs_kobj_”rÜ
:

6214 
	`sc¡_d–_put_sgv_kobj
();

6216 
sgv_kobj_”rÜ
:

6217 
	`kobjeù_d–
(
sc¡_deviûs_kobj
);

6218 
	`kobjeù_put
(
sc¡_deviûs_kobj
);

6220 
deviûs_kobj_”rÜ
:

6221 
	`kobjeù_d–
(
sc¡_rg‘s_kobj
);

6222 
	`kobjeù_put
(
sc¡_rg‘s_kobj
);

6224 
rg‘s_kobj_”rÜ
:

6225 
	`kobjeù_d–
(&
sc¡_sysfs_roÙ_kobj
);

6227 
sysfs_roÙ_add_”rÜ
:

6228 
	`kobjeù_put
(&
sc¡_sysfs_roÙ_kobj
);

6230 
	`kth»ad_¡Ý
(
sysfs_wÜk_th»ad
);

6232 ià(
»s
 == 0)

6233 
»s
 = -
EINVAL
;

6235 
out
;

6236 
	}
}

6238 
	$sc¡_sysfs_þ—nup
()

6240 
	`TRACE_ENTRY
();

6242 
	`PRINT_INFO
("%s", "Exiting SCST sysfs hierarchy...");

6244 
	`sc¡_d–_put_sgv_kobj
();

6246 
	`kobjeù_d–
(
sc¡_deviûs_kobj
);

6247 
	`kobjeù_put
(
sc¡_deviûs_kobj
);

6249 
	`kobjeù_d–
(
sc¡_rg‘s_kobj
);

6250 
	`kobjeù_put
(
sc¡_rg‘s_kobj
);

6252 
	`kobjeù_d–
(
sc¡_hªdËrs_kobj
);

6253 
	`kobjeù_put
(
sc¡_hªdËrs_kobj
);

6255 
	`sysfs_»move_fžes
(
sc¡_deviû_groups_kobj
, 
sc¡_deviû_groups_©Œs
);

6257 
	`kobjeù_d–
(
sc¡_deviû_groups_kobj
);

6258 
	`kobjeù_put
(
sc¡_deviû_groups_kobj
);

6260 
	`kobjeù_d–
(&
sc¡_sysfs_roÙ_kobj
);

6261 
	`kobjeù_put
(&
sc¡_sysfs_roÙ_kobj
);

6263 
	`wa™_fÜ_com¶‘iÚ
(&
sc¡_sysfs_roÙ_»Ëa£_com¶‘iÚ
);

6271 
	`m¦“p
(3000);

6273 ià(
sysfs_wÜk_th»ad
)

6274 
	`kth»ad_¡Ý
(
sysfs_wÜk_th»ad
);

6276 
	`PRINT_INFO
("%s", "Exiting SCST sysfs hierarchy done");

6278 
	`TRACE_EXIT
();

6280 
	}
}

	@/root/Desktop/scst-2.2.0/src/scst_targ.c

20 
	~<lšux/š™.h
>

21 
	~<lšux/k”Ãl.h
>

22 
	~<lšux/”ºo.h
>

23 
	~<lšux/li¡.h
>

24 
	~<lšux/¥šlock.h
>

25 
	~<lšux/¦ab.h
>

26 
	~<lšux/sched.h
>

27 
	~<lšux/uni¡d.h
>

28 
	~<lšux/¡ršg.h
>

29 
	~<lšux/kth»ad.h
>

30 
	~<lšux/d–ay.h
>

31 
	~<lšux/ktime.h
>

33 #ifdeà
INSIDE_KERNEL_TREE


34 
	~<sc¡/sc¡.h
>

36 
	~"sc¡.h
"

38 
	~"sc¡_´iv.h
"

39 
	~"sc¡_´es.h
"

43 
	#CONFIG_SCST_PER_DEVICE_CMD_COUNT_LIMIT


	)

46 
sc¡_cmd_£t_¢
(
sc¡_cmd
 *
cmd
);

47 
__sc¡_š™_cmd
(
sc¡_cmd
 *
cmd
);

48 
sc¡_fšish_cmd_mgmt
(
sc¡_cmd
 *
cmd
);

49 
sc¡_cmd
 *
__sc¡_fšd_cmd_by_g
(
sc¡_£ssiÚ
 *
£ss
,

50 
ušt64_t
 
g
, 
boÞ
 
to_abÜt
);

51 
sc¡_´oûss_»dœeù_cmd
(
sc¡_cmd
 *
cmd
,

52 
sc¡_exec_cÚ‹xt
 
cÚ‹xt
, 
check_»Œ›s
);

60 
	$sc¡_po¡_·r£
(
sc¡_cmd
 *
cmd
)

62 
	`sc¡_£t_·r£_time
(
cmd
);

63 
	}
}

64 
EXPORT_SYMBOL_GPL
(
sc¡_po¡_·r£
);

73 
	$sc¡_po¡_®loc_d©a_buf
(
sc¡_cmd
 *
cmd
)

75 
	`sc¡_£t_®loc_buf_time
(
cmd
);

76 
	}
}

77 
EXPORT_SYMBOL_GPL
(
sc¡_po¡_®loc_d©a_buf
);

79 
šlše
 
	$sc¡_scheduË_skËt
(
sc¡_cmd
 *
cmd
)

81 
sc¡_³rýu_šfo
 *
i
 = &
sc¡_³rýu_šfos
[
	`smp_´oûssÜ_id
()];

82 
æags
;

84 ià(
	`©omic_»ad
(&
i
->
ýu_cmd_couÁ
è<ð
sc¡_max_skËt_cmd
) {

85 
	`¥š_lock_œq§ve
(&
i
->
skËt_lock
, 
æags
);

86 
	`TRACE_DBG
("Addšg cmd %°tØskËˆ%d cmd†i¡", 
cmd
,

87 
	`smp_´oûssÜ_id
());

88 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
, &
i
->
skËt_cmd_li¡
);

89 
	`¥š_uÆock_œq»¡Üe
(&
i
->
skËt_lock
, 
æags
);

91 
	`skËt_scheduË
(&
i
->
skËt
);

93 
	`¥š_lock_œq§ve
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

94 
	`TRACE_DBG
("Too manyasklet commands (%d),‡dding cmd %po "

95 "aùivcmd†i¡", 
	`©omic_»ad
(&
i
->
ýu_cmd_couÁ
), 
cmd
);

96 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

97 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

98 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

99 
	`¥š_uÆock_œq»¡Üe
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

102 
	}
}

105 
boÞ
 
	$sc¡_check_blocked_dev
(
sc¡_cmd
 *
cmd
)

107 
boÞ
 
»s
;

108 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

110 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

112 
dev
->
Ú_dev_cmd_couÁ
++;

113 
cmd
->
dec_Ú_dev_Ãeded
 = 1;

114 
	`TRACE_DBG
("New inøÚ_dev_couÁ %d (cmd %p)", 
dev
->
Ú_dev_cmd_couÁ
,

115 
cmd
);

117 
	`sc¡_šc_´_»ad”s_couÁ
(
cmd
, 
Œue
);

119 ià(
	`uÆik–y
(
dev
->
block_couÁ
 > 0) ||

120 
	`uÆik–y
(
dev
->
dev_doubË_ua_possibË
) ||

121 
	`uÆik–y
(
	`sc¡_is_£rŸlized_cmd
(
cmd
)))

122 
»s
 = 
	`__sc¡_check_blocked_dev
(
cmd
);

124 
»s
 = 
çl£
;

126 ià(
	`uÆik–y
(
»s
)) {

128 
dev
->
Ú_dev_cmd_couÁ
--;

129 
cmd
->
dec_Ú_dev_Ãeded
 = 0;

130 
	`TRACE_DBG
("New dec on_dev_count %d (cmd %p)",

131 
dev
->
Ú_dev_cmd_couÁ
, 
cmd
);

133 
	`sc¡_dec_´_»ad”s_couÁ
(
cmd
, 
Œue
);

136 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

138  
»s
;

139 
	}
}

142 
	$sc¡_check_unblock_dev
(
sc¡_cmd
 *
cmd
)

144 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

146 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

148 ià(
	`lik–y
(
cmd
->
dec_Ú_dev_Ãeded
)) {

149 
dev
->
Ú_dev_cmd_couÁ
--;

150 
cmd
->
dec_Ú_dev_Ãeded
 = 0;

151 
	`TRACE_DBG
("New dec on_dev_count %d (cmd %p)",

152 
dev
->
Ú_dev_cmd_couÁ
, 
cmd
);

155 ià(
	`uÆik–y
(
cmd
->
dec_´_»ad”s_couÁ_Ãeded
))

156 
	`sc¡_dec_´_»ad”s_couÁ
(
cmd
, 
Œue
);

158 ià(
	`uÆik–y
(
cmd
->
unblock_dev
)) {

159 
	`TRACE_MGMT_DBG
("cmd %°Ñag %Îu): unblockšg dev %s", 
cmd
,

160 ()
cmd
->
g
, 
dev
->
vœt_Çme
);

161 
cmd
->
unblock_dev
 = 0;

162 
	`sc¡_unblock_dev
(
dev
);

163 } ià(
	`uÆik–y
(
dev
->
¡riùly_£rŸlized_cmd_wa™šg
)) {

164 ià(
dev
->
Ú_dev_cmd_couÁ
 == 0) {

165 
	`TRACE_MGMT_DBG
("Strictly serialized cmd waiting: "

166 "unblockšg dev %s", 
dev
->
vœt_Çme
);

167 
	`sc¡_unblock_dev
(
dev
);

171 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

173 
	}
}

191 
sc¡_cmd
 *
	$sc¡_rx_cmd
(
sc¡_£ssiÚ
 *
£ss
,

192 cÚ¡ 
ušt8_t
 *
lun
, 
lun_Ën
, cÚ¡ ušt8_ˆ*
cdb
,

193 
cdb_Ën
, 
©omic
)

195 
sc¡_cmd
 *
cmd
;

197 
	`TRACE_ENTRY
();

199 #ifdeà
CONFIG_SCST_EXTRACHECKS


200 ià(
	`uÆik–y
(
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
)) {

201 
	`PRINT_CRIT_ERROR
("%s",

203 
	`sBUG
();

207 
cmd
 = 
	`sc¡_®loc_cmd
(
cdb
, 
cdb_Ën
, 
©omic
 ? 
GFP_ATOMIC
 : 
GFP_KERNEL
);

208 ià(
	`uÆik–y
(
cmd
 =ð
NULL
))

209 
out
;

211 
cmd
->
£ss
 = sess;

212 
cmd
->
tgt
 = 
£ss
->tgt;

213 
cmd
->
tg‰
 = 
£ss
->
tgt
->tgtt;

215 
cmd
->
lun
 = 
	`sc¡_uÅack_lun
Öun, 
lun_Ën
);

216 ià(
	`uÆik–y
(
cmd
->
lun
 =ð
NO_SUCH_LUN
))

217 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

218 
	`SCST_LOAD_SENSE
(
sc¡_£n£_lun_nÙ_suµÜ‹d
));

220 
	`TRACE_DBG
("cmd %p, ses %p", 
cmd
, 
£ss
);

221 
	`sc¡_£ss_g‘
(
£ss
);

223 
out
:

224 
	`TRACE_EXIT
();

225  
cmd
;

226 
	}
}

227 
EXPORT_SYMBOL
(
sc¡_rx_cmd
);

233 
	$sc¡_š™_cmd
(
sc¡_cmd
 *
cmd
, 
sc¡_exec_cÚ‹xt
 *
cÚ‹xt
)

235 
rc
, 
»s
 = 0;

237 
	`TRACE_ENTRY
();

240 ià(
	`uÆik–y
(!
	`li¡_em±y
(&
sc¡_š™_cmd_li¡
))) {

241 
	`TRACE_MGMT_DBG
("%s", "init cmd†ist busy");

242 
out_»dœeù
;

250 
rc
 = 
	`__sc¡_š™_cmd
(
cmd
);

251 ià(
	`uÆik–y
(
rc
 > 0))

252 
out_»dœeù
;

253 ià(
	`uÆik–y
(
rc
 != 0)) {

254 
»s
 = 1;

255 
out
;

258 
	`EXTRACHECKS_BUG_ON
(*
cÚ‹xt
 =ð
SCST_CONTEXT_SAME
);

260 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


261 ià(
cmd
->
Ý_æags
 & 
SCST_TEST_IO_IN_SIRQ_ALLOWED
)

262 
out
;

266 ià((*
cÚ‹xt
 =ð
SCST_CONTEXT_TASKLET
) ||

267 (*
cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
)) {

272 
	`BUILD_BUG_ON
(
SCST_DATA_UNKNOWN
 != 0);

273 ià((
cmd
->
d©a_dœeùiÚ
 | cmd->
ex³ùed_d©a_dœeùiÚ
è& 
SCST_DATA_WRITE
) {

274 ià(!
	`‹¡_b™
(
SCST_TGT_DEV_AFTER_INIT_WR_ATOMIC
,

275 &
cmd
->
tgt_dev
->
tgt_dev_æags
))

276 *
cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

278 *
cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

281 
out
:

282 
	`TRACE_EXIT_RES
(
»s
);

283  
»s
;

285 
out_»dœeù
:

286 ià(
cmd
->
´•roûssšg_Úly
) {

293 
	`sBUG_ON
(*
cÚ‹xt
 !ð
SCST_CONTEXT_DIRECT
);

294 
	`sc¡_£t_busy
(
cmd
);

295 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

296 
»s
 = 1;

298 
	`m¦“p
(50);

300 
æags
;

301 
	`¥š_lock_œq§ve
(&
sc¡_š™_lock
, 
æags
);

302 
	`TRACE_MGMT_DBG
("Addšg cmd %°tØš™ cmd†i¡)", 
cmd
);

303 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
, &
sc¡_š™_cmd_li¡
);

304 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))

305 
sc¡_š™_pÞl_út
++;

306 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_š™_lock
, 
æags
);

307 
	`wake_up
(&
sc¡_š™_cmd_li¡_wa™Q
);

308 
»s
 = -1;

310 
out
;

311 
	}
}

336 
	$sc¡_cmd_š™_dÚe
(
sc¡_cmd
 *
cmd
,

337 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

339 
æags
;

340 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

341 
rc
;

343 
	`TRACE_ENTRY
();

345 
	`sc¡_£t_¡¬t_time
(
cmd
);

347 
	`TRACE_DBG
("P»ã¼ed cÚ‹xt: %d (cmd %p)", 
´ef_cÚ‹xt
, 
cmd
);

348 
	`TRACE
(
TRACE_SCSI
, "tag=%llu,†un=%lld, CDB†en=%d, queue_type=%x "

349 "(cmd %p, ses %p)", ()
cmd
->
g
,

350 ()
cmd
->
lun
, cmd->
cdb_Ën
,

351 
cmd
->
queue_ty³
, cmd, 
£ss
);

352 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
|
TRACE_RCV_BOT
, "Receiving CDB",

353 
cmd
->
cdb
, cmd->
cdb_Ën
);

355 #ifdeà
CONFIG_SCST_EXTRACHECKS


356 ià(
	`uÆik–y
((
	`š_œq
(è|| 
	`œqs_di§bËd
())) &&

357 ((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT
) ||

358 (
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
))) {

359 
	`PRINT_ERROR
("Wrong context %d in IRQ fromarget %s, use "

360 "SCST_CONTEXT_THREAD in¡—d", 
´ef_cÚ‹xt
,

361 
cmd
->
tg‰
->
Çme
);

362 
	`dump_¡ack
();

363 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

367 
	`©omic_šc
(&
£ss
->
£ss_cmd_couÁ
);

369 
	`¥š_lock_œq§ve
(&
£ss
->
£ss_li¡_lock
, 
æags
);

371 ià(
	`uÆik–y
(
£ss
->
š™_pha£
 !ð
SCST_SESS_IPH_READY
)) {

378 ià(
cmd
->
£ss_cmd_li¡_’Œy
.
Ãxt
 =ð
NULL
)

379 
	`li¡_add_ž
(&
cmd
->
£ss_cmd_li¡_’Œy
,

380 &
£ss
->
£ss_cmd_li¡
);

381 
£ss
->
š™_pha£
) {

382 
SCST_SESS_IPH_SUCCESS
:

384 
SCST_SESS_IPH_INITING
:

385 
	`TRACE_DBG
("Adding cmd %po init deferred cmd†ist",

386 
cmd
);

387 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

388 &
£ss
->
š™_deã¼ed_cmd_li¡
);

389 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

390 
out
;

391 
SCST_SESS_IPH_FAILED
:

392 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

393 
	`sc¡_£t_busy
(
cmd
);

394 
£t_¡©e
;

396 
	`sBUG
();

399 
	`li¡_add_ž
(&
cmd
->
£ss_cmd_li¡_’Œy
,

400 &
£ss
->
£ss_cmd_li¡
);

402 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

404 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 >ð
SCST_CMD_QUEUE_ACA
)) {

405 
	`PRINT_ERROR
("UnsuµÜ‹d queuty³ %d", 
cmd
->
queue_ty³
);

406 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

407 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_mes§ge
));

410 
£t_¡©e
:

411 ià(
	`uÆik–y
(
cmd
->
¡©us
 !ð
SAM_STAT_GOOD
)) {

412 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

413 
aùive
;

421 
cmd
->
¡©e
 = 
SCST_CMD_STATE_INIT
;

422 
rc
 = 
	`sc¡_š™_cmd
(
cmd
, &
´ef_cÚ‹xt
);

423 ià(
	`uÆik–y
(
rc
 < 0))

424 
out
;

426 
aùive
:

428 
´ef_cÚ‹xt
) {

429 
SCST_CONTEXT_TASKLET
:

430 
	`sc¡_scheduË_skËt
(
cmd
);

434 
	`PRINT_ERROR
("Context %x is undefined, usinghehread one",

435 
´ef_cÚ‹xt
);

437 
SCST_CONTEXT_THREAD
:

438 
	`¥š_lock_œq§ve
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

439 
	`TRACE_DBG
("Addšg cmd %°tØaùivcmd†i¡", 
cmd
);

440 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

441 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

442 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

444 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

445 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

446 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

447 
	`¥š_uÆock_œq»¡Üe
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

450 
SCST_CONTEXT_DIRECT
:

451 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
çl£
);

454 
SCST_CONTEXT_DIRECT_ATOMIC
:

455 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
Œue
);

459 
out
:

460 
	`TRACE_EXIT
();

462 
	}
}

463 
EXPORT_SYMBOL
(
sc¡_cmd_š™_dÚe
);

465 
	$sc¡_´e_·r£
(
sc¡_cmd
 *
cmd
)

467 
»s
;

468 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

469 
rc
;

471 
	`TRACE_ENTRY
();

480 
rc
 = 
	`sc¡_g‘_cdb_šfo
(
cmd
);

481 ià(
	`uÆik–y
(
rc
 != 0)) {

482 ià(
rc
 > 0) {

483 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

484 
out_”r
;

487 
	`EXTRACHECKS_BUG_ON
(
cmd
->
Ý_æags
 & 
SCST_INFO_VALID
);

489 
	`TRACE
(
TRACE_MINOR
, "Unknown opcode 0x%02x for %s. "

491 
cmd
->
cdb
[0], 
dev
->
hªdËr
->
Çme
);

492 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "Fažed CDB", 
cmd
->
cdb
,

493 
cmd
->
cdb_Ën
);

495 
	`EXTRACHECKS_BUG_ON
(!(
cmd
->
Ý_æags
 & 
SCST_INFO_VALID
));

497 #ifdeà
CONFIG_SCST_STRICT_SERIALIZING


498 
cmd
->
šc_ex³ùed_¢_Ú_dÚe
 = 1;

500 
cmd
->
šc_ex³ùed_¢_Ú_dÚe
 = 
dev
->
hªdËr
->
exec_sync
 ||

501 (!
dev
->
has_own_Üd”_mgmt
 &&

502 (
dev
->
queue_®g
 =ð
SCST_CONTR_MODE_QUEUE_ALG_RESTRICTED_REORDER
 ||

503 
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_ORDERED
));

507 
	`TRACE_DBG
("op_name <%s> (cmd %p), direction=%d "

509 "ËÀ%d, ouˆex³ùed†’ %d), fÏgs=0x%x", 
cmd
->
Ý_Çme
, cmd,

510 
cmd
->
d©a_dœeùiÚ
, cmd->
ex³ùed_d©a_dœeùiÚ
,

511 
	`sc¡_cmd_is_ex³ùed_£t
(
cmd
) ? "yes" : "no",

512 
cmd
->
bufæ’
, cmd->
out_bufæ’
, cmd->
ex³ùed_Œªsãr_Ën
,

513 
cmd
->
ex³ùed_out_Œªsãr_Ën
, cmd->
Ý_æags
);

515 
»s
 = 0;

517 
out
:

518 
	`TRACE_EXIT_RES
(
»s
);

519  
»s
;

521 
out_”r
:

522 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

523 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

524 
»s
 = -1;

525 
out
;

526 
	}
}

528 #iâdeà
CONFIG_SCST_USE_EXPECTED_VALUES


529 
boÞ
 
	$sc¡_is_®lowed_to_mism©ch_cmd
(
sc¡_cmd
 *
cmd
)

531 
boÞ
 
»s
 = 
çl£
;

534 ià((
cmd
->
Ý_æags
 & 
SCST_VERIFY_BYTCHK_MISMATCH_ALLOWED
) &&

535 (
cmd
->
cdb
[1] & 
BYTCHK
) == 0) {

536 
»s
 = 
Œue
;

537 
out
;

540 
cmd
->
cdb
[0]) {

541 
TEST_UNIT_READY
:

543 ià((
cmd
->
ex³ùed_d©a_dœeùiÚ
 =ð
SCST_DATA_READ
) ||

544 (
cmd
->
ex³ùed_d©a_dœeùiÚ
 =ð
SCST_DATA_NONE
))

545 
»s
 = 
Œue
;

549 
out
:

550  
»s
;

551 
	}
}

554 
	$sc¡_·r£_cmd
(
sc¡_cmd
 *
cmd
)

556 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

557 
¡©e
;

558 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

559 
Üig_bufæ’
 = 
cmd
->
bufæ’
;

561 
	`TRACE_ENTRY
();

563 ià(
	`lik–y
(!
	`sc¡_is_cmd_fuÎy_loÿl
(
cmd
))) {

564 ià(
	`uÆik–y
(!
dev
->
hªdËr
->
·r£_©omic
 &&

565 
	`sc¡_cmd_©omic
(
cmd
))) {

570 
	`TRACE_MGMT_DBG
("Dev handler %s…arse()‚eedshread "

571 "cÚ‹xt,„eschedulšg", 
dev
->
hªdËr
->
Çme
);

572 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

573 
out
;

576 
	`TRACE_DBG
("Calling dev handler %s…arse(%p)",

577 
dev
->
hªdËr
->
Çme
, 
cmd
);

578 
	`TRACE_BUFF_FLAG
(
TRACE_SND_BOT
, "Parsing: ",

579 
cmd
->
cdb
, cmd->
cdb_Ën
);

580 
	`sc¡_£t_cur_¡¬t
(
cmd
);

581 
¡©e
 = 
dev
->
hªdËr
->
	`·r£
(
cmd
);

583 
	`TRACE_DBG
("Dev handler %s…arse()„eturned %d",

584 
dev
->
hªdËr
->
Çme
, 
¡©e
);

586 
¡©e
) {

587 
SCST_CMD_STATE_NEED_THREAD_CTX
:

588 
	`sc¡_£t_·r£_time
(
cmd
);

589 
	`TRACE_DBG
("Dev handler %s…arse()„equestedhread "

590 "cÚ‹xt,„eschedulšg", 
dev
->
hªdËr
->
Çme
);

591 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

592 
out
;

594 
SCST_CMD_STATE_STOP
:

595 
	`TRACE_DBG
("Dev handler %s…arse()„equested stop "

596 "´oûssšg", 
dev
->
hªdËr
->
Çme
);

597 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

598 
out
;

601 
	`sc¡_£t_·r£_time
(
cmd
);

603 ià(
¡©e
 =ð
SCST_CMD_STATE_DEFAULT
)

604 
¡©e
 = 
SCST_CMD_STATE_PREPARE_SPACE
;

606 
¡©e
 = 
SCST_CMD_STATE_PREPARE_SPACE
;

608 ià(
	`uÆik–y
(
¡©e
 =ð
SCST_CMD_STATE_PRE_XMIT_RESP
))

609 
£t_»s
;

611 ià(
	`uÆik–y
(!(
cmd
->
Ý_æags
 & 
SCST_INFO_VALID
))) {

612 #ifdeà
CONFIG_SCST_USE_EXPECTED_VALUES


613 ià(
	`sc¡_cmd_is_ex³ùed_£t
(
cmd
)) {

614 
	`TRACE
(
TRACE_MINOR
, "Using initiator supplied values: "

616 
cmd
->
ex³ùed_d©a_dœeùiÚ
,

617 
cmd
->
ex³ùed_Œªsãr_Ën
,

618 
cmd
->
ex³ùed_out_Œªsãr_Ën
);

619 
cmd
->
d©a_dœeùiÚ
 = cmd->
ex³ùed_d©a_dœeùiÚ
;

620 
cmd
->
bufæ’
 = cmd->
ex³ùed_Œªsãr_Ën
;

621 
cmd
->
out_bufæ’
 = cmd->
ex³ùed_out_Œªsãr_Ën
;

623 
	`PRINT_ERROR
("Unknown opcode 0x%02x for %s‡nd "

625 
cmd
->
cdb
[0], 
dev
->
hªdËr
->
Çme
, cmd->
tg‰
->name);

626 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

627 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

628 
out_dÚe
;

637 ià((
cmd
->
cdb
[0] != 0x85) && (cmd->cdb[0] != 0xa1))

638 
	`PRINT_ERROR
("Refusšg unknowÀÝcod%x", 
cmd
->
cdb
[0]);

640 
	`TRACE
(
TRACE_MINOR
, "Refusing unknown opcode %x",

641 
cmd
->
cdb
[0]);

642 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

643 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

644 
out_dÚe
;

648 ià(
	`uÆik–y
(
cmd
->
cdb_Ën
 == 0)) {

649 
	`PRINT_ERROR
("Unableo get CDB†ength for "

651 "OPCODE", 
cmd
->
cdb
[0]);

652 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

653 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

654 
out_dÚe
;

657 
	`EXTRACHECKS_BUG_ON
(
cmd
->
cdb_Ën
 == 0);

659 
	`TRACE
(
TRACE_SCSI
, "op_name <%s> (cmd %p), direction=%d "

661 "ËÀ%d, ouˆex³ùed†’ %d), fÏgs=%x", 
cmd
->
Ý_Çme
, cmd,

662 
cmd
->
d©a_dœeùiÚ
, cmd->
ex³ùed_d©a_dœeùiÚ
,

663 
	`sc¡_cmd_is_ex³ùed_£t
(
cmd
) ? "yes" : "no",

664 
cmd
->
bufæ’
, cmd->
out_bufæ’
, cmd->
ex³ùed_Œªsãr_Ën
,

665 
cmd
->
ex³ùed_out_Œªsãr_Ën
, cmd->
Ý_æags
);

667 ià(
	`uÆik–y
((
cmd
->
Ý_æags
 & 
SCST_UNKNOWN_LENGTH
) != 0)) {

668 ià(
	`sc¡_cmd_is_ex³ùed_£t
(
cmd
)) {

677 
cmd
->
bufæ’
 = 
	`mš
(cmd->
ex³ùed_Œªsãr_Ën
,

679 ià(
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_BIDI
)

680 
cmd
->
out_bufæ’
 = 
	`mš
(cmd->
ex³ùed_out_Œªsãr_Ën
,

682 
cmd
->
Ý_æags
 &ð~
SCST_UNKNOWN_LENGTH
;

684 
	`PRINT_ERROR
("Unknown dataransfer†ength for opcode "

685 "0x%x (hªdË¸%s,¬g‘ %s)", 
cmd
->
cdb
[0],

686 
dev
->
hªdËr
->
Çme
, 
cmd
->
tg‰
->name);

687 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

688 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

689 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_mes§ge
));

690 
out_dÚe
;

694 ià(
	`uÆik–y
(
cmd
->
cdb
[cmd->
cdb_Ën
 - 1] & 
CONTROL_BYTE_NACA_BIT
)) {

695 
	`PRINT_ERROR
("NACA bit in control byte CDB is‚ot supported "

696 "(Ýcod0x%02x)", 
cmd
->
cdb
[0]);

697 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

698 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

699 
out_dÚe
;

702 ià(
	`uÆik–y
(
cmd
->
cdb
[cmd->
cdb_Ën
 - 1] & 
CONTROL_BYTE_LINK_BIT
)) {

703 
	`PRINT_ERROR
("Linked commands‡re‚ot supported "

704 "(Ýcod0x%02x)", 
cmd
->
cdb
[0]);

705 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

706 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

707 
out_dÚe
;

710 ià(
cmd
->
dh_d©a_buf_®loûd
 &&

711 
	`uÆik–y
((
Üig_bufæ’
 > 
cmd
->
bufæ’
))) {

712 
	`PRINT_ERROR
("Dev handler supplied data buffer (size %d), "

713 "i Ëss,hª„equœed (siz%d)", 
cmd
->
bufæ’
,

714 
Üig_bufæ’
);

715 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

716 
out_hw_”rÜ
;

719 #ifdeà
CONFIG_SCST_EXTRACHECKS


720 ià((
cmd
->
bufæ’
 != 0) &&

721 ((
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_NONE
) ||

722 ((
cmd
->
sg
 =ð
NULL
è&& (
¡©e
 > 
SCST_CMD_STATE_PREPARE_SPACE
)))) {

723 
	`PRINT_ERROR
("Dev handler %s…arse()„eturned "

725 "Ü sg %°(Ýcod0x%x)", 
dev
->
hªdËr
->
Çme
,

726 
cmd
->
d©a_dœeùiÚ
, cmd->
bufæ’
, 
¡©e
, cmd->
sg
,

727 
cmd
->
cdb
[0]);

728 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

729 
out_hw_”rÜ
;

733 ià(
	`sc¡_cmd_is_ex³ùed_£t
(
cmd
)) {

734 #ifdeà
CONFIG_SCST_USE_EXPECTED_VALUES


735 ià(
	`uÆik–y
((
cmd
->
d©a_dœeùiÚ
 !ðcmd->
ex³ùed_d©a_dœeùiÚ
) ||

736 (
cmd
->
bufæ’
 !ðcmd->
ex³ùed_Œªsãr_Ën
) ||

737 (
cmd
->
out_bufæ’
 !ðcmd->
ex³ùed_out_Œªsãr_Ën
))) {

738 
	`TRACE
(
TRACE_MINOR
, "Expected values don't match "

743 
cmd
->
d©a_dœeùiÚ
,

744 
cmd
->
ex³ùed_d©a_dœeùiÚ
,

745 
cmd
->
bufæ’
, cmd->
ex³ùed_Œªsãr_Ën
,

746 
cmd
->
out_bufæ’
, cmd->
ex³ùed_out_Œªsãr_Ën
);

747 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "Suspicious CDB",

748 
cmd
->
cdb
, cmd->
cdb_Ën
);

749 
cmd
->
d©a_dœeùiÚ
 = cmd->
ex³ùed_d©a_dœeùiÚ
;

750 
cmd
->
bufæ’
 = cmd->
ex³ùed_Œªsãr_Ën
;

751 
cmd
->
out_bufæ’
 = cmd->
ex³ùed_out_Œªsãr_Ën
;

752 
cmd
->
»sid_possibË
 = 1;

755 ià(
	`uÆik–y
(
cmd
->
d©a_dœeùiÚ
 !=

756 
cmd
->
ex³ùed_d©a_dœeùiÚ
)) {

757 ià(((
cmd
->
ex³ùed_d©a_dœeùiÚ
 !ð
SCST_DATA_NONE
) ||

758 (
cmd
->
bufæ’
 != 0)) &&

759 !
	`sc¡_is_®lowed_to_mism©ch_cmd
(
cmd
)) {

760 
	`PRINT_ERROR
("Expected data direction %d for "

763 
cmd
->
ex³ùed_d©a_dœeùiÚ
,

764 
cmd
->
cdb
[0], 
dev
->
hªdËr
->
Çme
,

765 
cmd
->
tg‰
->
Çme
, cmd->
d©a_dœeùiÚ
);

766 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
,

767 
cmd
->
cdb_Ën
);

768 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

769 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_mes§ge
));

770 
out_dÚe
;

773 ià(
	`uÆik–y
(
cmd
->
bufæ’
 !ðcmd->
ex³ùed_Œªsãr_Ën
)) {

774 
	`TRACE
(
TRACE_MINOR
, "Warning:ƒxpected "

778 
cmd
->
ex³ùed_Œªsãr_Ën
, cmd->
cdb
[0],

779 
dev
->
hªdËr
->
Çme
, 
cmd
->
tg‰
->name,

780 
cmd
->
bufæ’
);

781 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "Suspicious CDB",

782 
cmd
->
cdb
, cmd->
cdb_Ën
);

783 ià((
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) ||

784 (
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
))

785 
cmd
->
»sid_possibË
 = 1;

787 ià(
	`uÆik–y
(
cmd
->
out_bufæ’
 !ðcmd->
ex³ùed_out_Œªsãr_Ën
)) {

788 
	`TRACE
(
TRACE_MINOR
, "Warning:ƒxpected bidirectional OUT "

792 
cmd
->
ex³ùed_out_Œªsãr_Ën
, cmd->
cdb
[0],

793 
dev
->
hªdËr
->
Çme
, 
cmd
->
tg‰
->name,

794 
cmd
->
out_bufæ’
);

795 
	`PRINT_BUFF_FLAG
(
TRACE_MINOR
, "Suspicious CDB",

796 
cmd
->
cdb
, cmd->
cdb_Ën
);

797 
cmd
->
»sid_possibË
 = 1;

802 ià(
	`uÆik–y
(
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_UNKNOWN
)) {

803 
	`PRINT_ERROR
("Unknown data direction. Opcode 0x%x, handler %s, "

804 "rg‘ %s", 
cmd
->
cdb
[0], 
dev
->
hªdËr
->
Çme
,

805 
cmd
->
tg‰
->
Çme
);

806 
	`PRINT_BUFFER
("Fažed CDB", 
cmd
->
cdb
, cmd->
cdb_Ën
);

807 
out_hw_”rÜ
;

810 
£t_»s
:

811 ià(
cmd
->
d©a_Ën
 == -1)

812 
cmd
->
d©a_Ën
 = cmd->
bufæ’
;

814 ià(
cmd
->
bufæ’
 == 0) {

819 
cmd
->
d©a_dœeùiÚ
 = 
SCST_DATA_NONE
;

822 #ifdeà
CONFIG_SCST_EXTRACHECKS


823 
¡©e
) {

824 
SCST_CMD_STATE_PREPARE_SPACE
:

825 
SCST_CMD_STATE_PARSE
:

826 
SCST_CMD_STATE_RDY_TO_XFER
:

827 
SCST_CMD_STATE_TGT_PRE_EXEC
:

828 
SCST_CMD_STATE_SEND_FOR_EXEC
:

829 
SCST_CMD_STATE_START_EXEC
:

830 
SCST_CMD_STATE_LOCAL_EXEC
:

831 
SCST_CMD_STATE_REAL_EXEC
:

832 
SCST_CMD_STATE_PRE_DEV_DONE
:

833 
SCST_CMD_STATE_DEV_DONE
:

834 
SCST_CMD_STATE_PRE_XMIT_RESP
:

835 
SCST_CMD_STATE_XMIT_RESP
:

836 
SCST_CMD_STATE_FINISHED
:

837 
SCST_CMD_STATE_FINISHED_INTERNAL
:

839 
cmd
->
¡©e
 = state;

840 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

841 #ifdeà
CONFIG_SCST_EXTRACHECKS


845 ià(
¡©e
 >= 0) {

846 
	`PRINT_ERROR
("Dev handler %s…arse()„eturned "

848 
dev
->
hªdËr
->
Çme
, 
¡©e
, 
cmd
->
cdb
[0]);

850 
	`PRINT_ERROR
("Dev handler %s…arse()„eturned "

851 "”rÜ %d (Ýcod%d)", 
dev
->
hªdËr
->
Çme
,

852 
¡©e
, 
cmd
->
cdb
[0]);

854 
out_hw_”rÜ
;

858 ià(
cmd
->
»¥_d©a_Ën
 == -1) {

859 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
)

860 
cmd
->
»¥_d©a_Ën
 = cmd->
bufæ’
;

862 
cmd
->
»¥_d©a_Ën
 = 0;

866 ià(
	`uÆik–y
(
cmd
->
com¶‘ed
))

867 
out_dÚe
;

869 #iâdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


875 ià(
	`uÆik–y
(
	`sc¡_cmd_©omic
(
cmd
) &&

876 !(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
))) {

877 
	`TRACE_DBG_FLAG
(
TRACE_DEBUG
|
TRACE_MINOR
, "Atomic context‡nd "

878 "nÚ-WRITE d©¨dœeùiÚ,„eschedulšg (cmd %p)", 
cmd
);

879 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

880 
out
;

884 
out
:

885 
	`TRACE_EXIT_HRES
(
»s
);

886  
»s
;

888 
out_hw_”rÜ
:

890 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

892 
out_dÚe
:

893 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

894 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

895 
out
;

896 
	}
}

898 
	$sc¡_£t_wr™e_Ën
(
sc¡_cmd
 *
cmd
)

900 
	`TRACE_ENTRY
();

902 
	`EXTRACHECKS_BUG_ON
(!(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
));

904 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) {

905 
cmd
->
wr™e_Ën
 = cmd->
out_bufæ’
;

906 
cmd
->
wr™e_sg
 = &cmd->
out_sg
;

907 
cmd
->
wr™e_sg_út
 = &cmd->
out_sg_út
;

909 
cmd
->
wr™e_Ën
 = cmd->
bufæ’
;

913 
	`TRACE_MEM
("cmd %p, write_len %d, write_sg %p, write_sg_cnt %d, "

914 "»sid_possibË %d", 
cmd
, cmd->
wr™e_Ën
, *cmd->
wr™e_sg
,

915 *
cmd
->
wr™e_sg_út
, cmd->
»sid_possibË
);

917 ià(
	`uÆik–y
(
cmd
->
»sid_possibË
)) {

918 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) {

919 
cmd
->
wr™e_Ën
 = 
	`mš
(cmd->
out_bufæ’
,

920 
cmd
->
ex³ùed_out_Œªsãr_Ën
);

921 ià(
cmd
->
wr™e_Ën
 =ðcmd->
out_bufæ’
)

922 
out
;

924 
cmd
->
wr™e_Ën
 = 
	`mš
(cmd->
bufæ’
,

925 
cmd
->
ex³ùed_Œªsãr_Ën
);

926 ià(
cmd
->
wr™e_Ën
 =ðcmd->
bufæ’
)

927 
out
;

929 
	`sc¡_lim™_sg_wr™e_Ën
(
cmd
);

932 
out
:

933 
	`TRACE_EXIT
();

935 
	}
}

937 
	$sc¡_´•¬e_¥aû
(
sc¡_cmd
 *
cmd
)

939 
r
 = 0, 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

940 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

942 
	`TRACE_ENTRY
();

944 ià(
cmd
->
d©a_dœeùiÚ
 =ð
SCST_DATA_NONE
)

945 
dÚe
;

947 ià(
	`lik–y
(!
	`sc¡_is_cmd_fuÎy_loÿl
(
cmd
)) &&

948 (
dev
->
hªdËr
->
®loc_d©a_buf
 !ð
NULL
)) {

949 
¡©e
;

951 ià(
	`uÆik–y
(!
dev
->
hªdËr
->
®loc_d©a_buf_©omic
 &&

952 
	`sc¡_cmd_©omic
(
cmd
))) {

957 
	`TRACE_MGMT_DBG
("Dev handler %s‡lloc_data_buf()‚eeds "

959 
dev
->
hªdËr
->
Çme
);

960 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

961 
out
;

964 
	`TRACE_DBG
("Calling dev handler %s‡lloc_data_buf(%p)",

965 
dev
->
hªdËr
->
Çme
, 
cmd
);

966 
	`sc¡_£t_cur_¡¬t
(
cmd
);

967 
¡©e
 = 
dev
->
hªdËr
->
	`®loc_d©a_buf
(
cmd
);

969 
	`TRACE_DBG
("Dev handler %s‡lloc_data_buf()„eturned %d",

970 
dev
->
hªdËr
->
Çme
, 
¡©e
);

972 
¡©e
) {

973 
SCST_CMD_STATE_NEED_THREAD_CTX
:

974 
	`sc¡_£t_®loc_buf_time
(
cmd
);

975 
	`TRACE_DBG
("Dev handler %s‡lloc_data_buf()„equested "

977 
dev
->
hªdËr
->
Çme
);

978 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

979 
out
;

981 
SCST_CMD_STATE_STOP
:

982 
	`TRACE_DBG
("Dev handler %s‡lloc_data_buf()„equested "

983 "¡Ý…roûssšg", 
dev
->
hªdËr
->
Çme
);

984 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

985 
out
;

988 
	`sc¡_£t_®loc_buf_time
(
cmd
);

990 ià(
	`uÆik–y
(
¡©e
 !ð
SCST_CMD_STATE_DEFAULT
)) {

991 
cmd
->
¡©e
 = state;

992 
out
;

996 ià(
cmd
->
tgt_Ãed_®loc_d©a_buf
) {

997 
Üig_bufæ’
 = 
cmd
->
bufæ’
;

999 
	`TRACE_MEM
("Customgt data buf‡llocation„equested (cmd %p)",

1000 
cmd
);

1002 
	`sc¡_£t_cur_¡¬t
(
cmd
);

1003 
r
 = 
cmd
->
tg‰
->
	`®loc_d©a_buf
(cmd);

1004 
	`sc¡_£t_®loc_buf_time
(
cmd
);

1006 ià(
r
 > 0)

1007 
®loc
;

1008 ià(
r
 == 0) {

1009 ià(
	`uÆik–y
(
cmd
->
bufæ’
 == 0)) {

1011 ià(
cmd
->
sg
 =ð
NULL
)

1012 
®loc
;

1015 
cmd
->
tgt_d©a_buf_®loûd
 = 1;

1017 ià(
	`uÆik–y
(
Üig_bufæ’
 < 
cmd
->
bufæ’
)) {

1018 
	`PRINT_ERROR
("Target driver‡llocated data "

1020 "»quœed (siz%d)", 
Üig_bufæ’
,

1021 
cmd
->
bufæ’
);

1022 
out_”rÜ
;

1024 
	`TRACE_MEM
("tgt_d©a_buf_®loûd (cmd %p)", 
cmd
);

1026 
check
;

1029 
®loc
:

1030 ià(!
cmd
->
tgt_d©a_buf_®loûd
 && !cmd->
dh_d©a_buf_®loûd
) {

1031 
r
 = 
	`sc¡_®loc_¥aû
(
cmd
);

1032 } ià(
cmd
->
dh_d©a_buf_®loûd
 && !cmd->
tgt_d©a_buf_®loûd
) {

1033 
	`TRACE_MEM
("dh_d©a_buf_®loûd s‘ (cmd %p)", 
cmd
);

1034 
r
 = 0;

1035 } ià(
cmd
->
tgt_d©a_buf_®loûd
 && !cmd->
dh_d©a_buf_®loûd
) {

1036 
	`TRACE_MEM
("tgt_d©a_buf_®loûd s‘ (cmd %p)", 
cmd
);

1037 
cmd
->
sg
 = cmd->
tgt_sg
;

1038 
cmd
->
sg_út
 = cmd->
tgt_sg_út
;

1039 
cmd
->
out_sg
 = cmd->
tgt_out_sg
;

1040 
cmd
->
out_sg_út
 = cmd->
tgt_out_sg_út
;

1041 
r
 = 0;

1043 
	`TRACE_MEM
("Both *_data_buf_alloced set (cmd %p, sg %p, "

1044 "sg_úˆ%d,gt_sg %p,gt_sg_úˆ%d)", 
cmd
, cmd->
sg
,

1045 
cmd
->
sg_út
, cmd->
tgt_sg
, cmd->
tgt_sg_út
);

1046 
r
 = 0;

1049 
check
:

1050 ià(
r
 != 0) {

1051 ià(
	`sc¡_cmd_©omic
(
cmd
)) {

1052 
	`TRACE_MEM
("%s", "Atomic memory‡llocation failed, "

1054 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1055 
out
;

1057 
out_no_¥aû
;

1060 
dÚe
:

1061 ià(
cmd
->
´•roûssšg_Úly
) {

1062 
cmd
->
¡©e
 = 
SCST_CMD_STATE_PREPROCESSING_DONE
;

1063 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

1064 
	`sc¡_£t_wr™e_Ën
(
cmd
);

1065 } ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

1066 
cmd
->
¡©e
 = 
SCST_CMD_STATE_RDY_TO_XFER
;

1067 
	`sc¡_£t_wr™e_Ën
(
cmd
);

1069 
cmd
->
¡©e
 = 
SCST_CMD_STATE_TGT_PRE_EXEC
;

1071 
out
:

1072 
	`TRACE_EXIT_HRES
(
»s
);

1073  
»s
;

1075 
out_no_¥aû
:

1076 
	`TRACE
(
TRACE_OUT_OF_MEM
, "Unableo‡llocate or build„equested buffer "

1077 "(siz%d), s’dšg BUSY o¸QUEUE FULL stus", 
cmd
->
bufæ’
);

1078 
	`sc¡_£t_busy
(
cmd
);

1079 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1080 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1081 
out
;

1083 
out_”rÜ
:

1084 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1085 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1086 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1087 
out
;

1088 
	}
}

1090 
	$sc¡_´•roûssšg_dÚe
(
sc¡_cmd
 *
cmd
)

1092 
»s
;

1094 
	`TRACE_ENTRY
();

1096 
	`EXTRACHECKS_BUG_ON
(!
cmd
->
´•roûssšg_Úly
);

1098 
cmd
->
´•roûssšg_Úly
 = 0;

1100 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

1101 
cmd
->
¡©e
 = 
SCST_CMD_STATE_PREPROCESSING_DONE_CALLED
;

1103 
	`TRACE_DBG
("C®lšg…»´oûssšg_dÚe(cmd %p)", 
cmd
);

1104 
	`sc¡_£t_cur_¡¬t
(
cmd
);

1105 
cmd
->
tg‰
->
	`´•roûssšg_dÚe
(cmd);

1106 
	`TRACE_DBG
("%s", "preprocessing_done()„eturned");

1108 
	`TRACE_EXIT_HRES
(
»s
);

1109  
»s
;

1110 
	}
}

1128 
	$sc¡_»¡¬t_cmd
(
sc¡_cmd
 *
cmd
, 
¡©us
,

1129 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

1131 
	`TRACE_ENTRY
();

1133 
	`sc¡_£t_»¡¬t_wa™šg_time
(
cmd
);

1135 
	`TRACE_DBG
("P»ã¼ed cÚ‹xt: %d", 
´ef_cÚ‹xt
);

1136 
	`TRACE_DBG
("tag=%llu, status=%#x",

1137 ()
	`sc¡_cmd_g‘_g
(
cmd
),

1138 
¡©us
);

1140 #ifdeà
CONFIG_SCST_EXTRACHECKS


1141 ià((
	`š_œq
(è|| 
	`œqs_di§bËd
()) &&

1142 ((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT
) ||

1143 (
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
))) {

1144 
	`PRINT_ERROR
("Wrong context %d in IRQ fromarget %s, use "

1145 "SCST_CONTEXT_THREAD in¡—d", 
´ef_cÚ‹xt
,

1146 
cmd
->
tg‰
->
Çme
);

1147 
	`dump_¡ack
();

1148 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1152 
¡©us
) {

1153 
SCST_PREPROCESS_STATUS_SUCCESS
:

1154 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
)

1155 
cmd
->
¡©e
 = 
SCST_CMD_STATE_RDY_TO_XFER
;

1157 
cmd
->
¡©e
 = 
SCST_CMD_STATE_TGT_PRE_EXEC
;

1158 ià(
cmd
->
£t_¢_Ú_»¡¬t_cmd
)

1159 
	`sc¡_cmd_£t_¢
(
cmd
);

1160 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1161 ià(
cmd
->
Ý_æags
 & 
SCST_TEST_IO_IN_SIRQ_ALLOWED
)

1165 ià((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_TASKLET
) ||

1166 (
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
) ||

1167 ((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_SAME
) &&

1168 
	`sc¡_cmd_©omic
(
cmd
)))

1169 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1172 
SCST_PREPROCESS_STATUS_ERROR_SENSE_SET
:

1173 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1174 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1177 
SCST_PREPROCESS_STATUS_ERROR_FATAL
:

1178 
	`£t_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
);

1180 
SCST_PREPROCESS_STATUS_ERROR
:

1181 ià(
cmd
->
£n£
 !ð
NULL
)

1182 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1183 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1184 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1185 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1189 
	`PRINT_ERROR
("%s(è»ûived unknowÀ¡©u %x", 
__func__
,

1190 
¡©us
);

1191 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1192 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1196 
	`sc¡_´oûss_»dœeù_cmd
(
cmd
, 
´ef_cÚ‹xt
, 1);

1198 
	`TRACE_EXIT
();

1200 
	}
}

1201 
EXPORT_SYMBOL
(
sc¡_»¡¬t_cmd
);

1203 
	$sc¡_rdy_to_xãr
(
sc¡_cmd
 *
cmd
)

1205 
»s
, 
rc
;

1206 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
cmd
->tgtt;

1208 
	`TRACE_ENTRY
();

1210 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))) {

1211 
	`TRACE_MGMT_DBG
("ABORTED s‘,‡bÜtšg cmd %p", 
cmd
);

1212 
out_dev_dÚe
;

1215 ià((
tg‰
->
rdy_to_xãr
 =ð
NULL
è|| 
	`uÆik–y
(
cmd
->
š‹º®
)) {

1216 
cmd
->
¡©e
 = 
SCST_CMD_STATE_TGT_PRE_EXEC
;

1217 #iâdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1219 ià(
	`sc¡_cmd_©omic
(
cmd
)) {

1220 
	`TRACE_DBG
("NULL„dy_to_xfer()‡nd‡tomic context, "

1221 "»schedulšg (cmd %p)", 
cmd
);

1222 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1225 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1226 
out
;

1229 ià(
	`uÆik–y
(!
tg‰
->
rdy_to_xãr_©omic
 && 
	`sc¡_cmd_©omic
(
cmd
))) {

1234 
	`TRACE_MGMT_DBG
("Target driver %s„dy_to_xfer()‚eedshread "

1235 "cÚ‹xt,„eschedulšg", 
tg‰
->
Çme
);

1236 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1237 
out
;

1241 
fšished_cmds
 = 
	`©omic_»ad
(&
cmd
->
tgt
->finished_cmds);

1243 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

1244 
cmd
->
¡©e
 = 
SCST_CMD_STATE_DATA_WAIT
;

1246 ià(
tg‰
->
Ú_hw_³ndšg_cmd_timeout
 !ð
NULL
) {

1247 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

1248 
cmd
->
hw_³ndšg_¡¬t
 = 
jiff›s
;

1249 
cmd
->
cmd_hw_³ndšg
 = 1;

1250 ià(!
	`‹¡_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
, &
£ss
->
£ss_aæags
)) {

1251 
	`TRACE_DBG
("Sched HW…ending work for sess %p "

1252 "(maxim%d)", 
£ss
,

1253 
tg‰
->
max_hw_³ndšg_time
);

1254 
	`£t_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
,

1255 &
£ss
->
£ss_aæags
);

1256 
	`scheduË_d–ayed_wÜk
(&
£ss
->
hw_³ndšg_wÜk
,

1257 
tg‰
->
max_hw_³ndšg_time
 * 
HZ
);

1261 
	`sc¡_£t_cur_¡¬t
(
cmd
);

1263 
	`TRACE_DBG
("C®lšg„dy_to_xãr(%p)", 
cmd
);

1264 #ifdeà
CONFIG_SCST_DEBUG_RETRY


1265 ià(((
	`sc¡_¿ndom
() % 100) == 75))

1266 
rc
 = 
SCST_TGT_RES_QUEUE_FULL
;

1269 
rc
 = 
tg‰
->
	`rdy_to_xãr
(
cmd
);

1270 
	`TRACE_DBG
("rdy_to_xãr(è»tuºed %d", 
rc
);

1272 ià(
	`lik–y
(
rc
 =ð
SCST_TGT_RES_SUCCESS
))

1273 
out
;

1275 
	`sc¡_£t_rdy_to_xãr_time
(
cmd
);

1277 
cmd
->
cmd_hw_³ndšg
 = 0;

1280 
cmd
->
¡©e
 = 
SCST_CMD_STATE_RDY_TO_XFER
;

1282 
rc
) {

1283 
SCST_TGT_RES_QUEUE_FULL
:

1284 ià(
	`sc¡_queue_»Œy_cmd
(
cmd
, 
fšished_cmds
) == 0)

1289 
SCST_TGT_RES_NEED_THREAD_CTX
:

1290 
	`TRACE_DBG
("Target driver %s "

1292 "cÚ‹xt,„eschedulšg", 
tg‰
->
Çme
);

1293 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

1294 
out
;

1297 
out_”rÜ_rc
;

1302 
out
:

1303 
	`TRACE_EXIT_HRES
(
»s
);

1304  
»s
;

1306 
out_”rÜ_rc
:

1307 ià(
rc
 =ð
SCST_TGT_RES_FATAL_ERROR
) {

1308 
	`PRINT_ERROR
("Target driver %s„dy_to_xfer()„eturned "

1309 "çÈ”rÜ", 
tg‰
->
Çme
);

1311 
	`PRINT_ERROR
("Target driver %s„dy_to_xfer()„eturned invalid "

1312 "v®u%d", 
tg‰
->
Çme
, 
rc
);

1314 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1316 
out_dev_dÚe
:

1317 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1318 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

1319 
out
;

1320 
	}
}

1323 
	$sc¡_´oûss_»dœeù_cmd
(
sc¡_cmd
 *
cmd
,

1324 
sc¡_exec_cÚ‹xt
 
cÚ‹xt
, 
check_»Œ›s
)

1326 
sc¡_tgt
 *
tgt
 = 
cmd
->tgt;

1327 
æags
;

1329 
	`TRACE_ENTRY
();

1331 
	`TRACE_DBG
("CÚ‹xt: %x", 
cÚ‹xt
);

1333 ià(
check_»Œ›s
)

1334 
	`sc¡_check_»Œ›s
(
tgt
);

1336 ià(
cÚ‹xt
 =ð
SCST_CONTEXT_SAME
)

1337 
cÚ‹xt
 = 
	`sc¡_cmd_©omic
(
cmd
è? 
SCST_CONTEXT_DIRECT_ATOMIC
 :

1338 
SCST_CONTEXT_DIRECT
;

1340 
cÚ‹xt
) {

1341 
SCST_CONTEXT_DIRECT_ATOMIC
:

1342 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
Œue
);

1345 
SCST_CONTEXT_DIRECT
:

1346 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
çl£
);

1349 
SCST_CONTEXT_TASKLET
:

1350 
	`sc¡_scheduË_skËt
(
cmd
);

1354 
	`PRINT_ERROR
("Context %x is unknown, usinghehread one",

1355 
cÚ‹xt
);

1357 
SCST_CONTEXT_THREAD
:

1358 
	`¥š_lock_œq§ve
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

1359 
	`TRACE_DBG
("Addšg cmd %°tØaùivcmd†i¡", 
cmd
);

1360 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

1361 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

1362 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

1364 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

1365 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

1366 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

1367 
	`¥š_uÆock_œq»¡Üe
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
, 
æags
);

1371 
	`TRACE_EXIT
();

1373 
	}
}

1388 
	$sc¡_rx_d©a
(
sc¡_cmd
 *
cmd
, 
¡©us
,

1389 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

1391 
	`TRACE_ENTRY
();

1393 
	`sc¡_£t_rdy_to_xãr_time
(
cmd
);

1395 
	`TRACE_DBG
("P»ã¼ed cÚ‹xt: %d", 
´ef_cÚ‹xt
);

1396 
	`TRACE
(
TRACE_SCSI
, "cmd %p, stu %#x", 
cmd
, 
¡©us
);

1398 
cmd
->
cmd_hw_³ndšg
 = 0;

1400 #ifdeà
CONFIG_SCST_EXTRACHECKS


1401 ià((
	`š_œq
(è|| 
	`œqs_di§bËd
()) &&

1402 ((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT
) ||

1403 (
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
))) {

1404 
	`PRINT_ERROR
("Wrong context %d in IRQ fromarget %s, use "

1405 "SCST_CONTEXT_THREAD in¡—d", 
´ef_cÚ‹xt
,

1406 
cmd
->
tg‰
->
Çme
);

1407 
	`dump_¡ack
();

1408 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1412 
¡©us
) {

1413 
SCST_RX_STATUS_SUCCESS
:

1414 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

1415 ià(
Œaû_æag
 & 
TRACE_RCV_BOT
) {

1416 
i
, 
j
;

1417 
sÿ‰”li¡
 *
sg
;

1418 ià(
cmd
->
out_sg
 !ð
NULL
)

1419 
sg
 = 
cmd
->
out_sg
;

1420 ià(
cmd
->
tgt_out_sg
 !ð
NULL
)

1421 
sg
 = 
cmd
->
tgt_out_sg
;

1422 ià(
cmd
->
tgt_sg
 !ð
NULL
)

1423 
sg
 = 
cmd
->
tgt_sg
;

1425 
sg
 = 
cmd
->sg;

1426 ià(
sg
 !ð
NULL
) {

1427 
	`TRACE_RECV_BOT
("RX data for cmd %p "

1429 
cmd
, cmd->
tgt_sg_út
, 
sg
,

1430 (*)
	`sg_·ge
(&
sg
[0]));

1431 
i
 = 0, 
j
 = 0; i < 
cmd
->
tgt_sg_út
; ++i, ++j) {

1432 ià(
	`uÆik–y
(
	`sg_is_chaš
(&
sg
[
j
]))) {

1433 
sg
 = 
	`sg_chaš_±r
(&sg[
j
]);

1434 
j
 = 0;

1436 
	`PRINT_BUFF_FLAG
(
TRACE_RCV_BOT
, "RX sg",

1437 
	`sg_vœt
(&
sg
[
j
]), sg[j].
Ëngth
);

1442 
cmd
->
¡©e
 = 
SCST_CMD_STATE_TGT_PRE_EXEC
;

1444 #ifdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


1445 ià(
cmd
->
Ý_æags
 & 
SCST_TEST_IO_IN_SIRQ_ALLOWED
)

1450 ià((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_TASKLET
) ||

1451 (
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
) ||

1452 ((
´ef_cÚ‹xt
 =ð
SCST_CONTEXT_SAME
) &&

1453 
	`sc¡_cmd_©omic
(
cmd
)))

1454 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1457 
SCST_RX_STATUS_ERROR_SENSE_SET
:

1458 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1459 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1462 
SCST_RX_STATUS_ERROR_FATAL
:

1463 
	`£t_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
);

1465 
SCST_RX_STATUS_ERROR
:

1466 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1467 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1468 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1469 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1473 
	`PRINT_ERROR
("scst_rx_data()„eceived unknown status %x",

1474 
¡©us
);

1475 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1476 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1480 
	`sc¡_´oûss_»dœeù_cmd
(
cmd
, 
´ef_cÚ‹xt
, 1);

1482 
	`TRACE_EXIT
();

1484 
	}
}

1485 
EXPORT_SYMBOL
(
sc¡_rx_d©a
);

1487 
	$sc¡_tgt_´e_exec
(
sc¡_cmd
 *
cmd
)

1489 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
, 
rc
;

1491 
	`TRACE_ENTRY
();

1493 ià(
	`uÆik–y
(
cmd
->
»sid_possibË
)) {

1494 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_WRITE
) {

1495 
boÞ
 
do_z”o
 = 
çl£
;

1496 ià(
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) {

1497 ià(
cmd
->
wr™e_Ën
 !ðcmd->
out_bufæ’
)

1498 
do_z”o
 = 
Œue
;

1500 ià(
cmd
->
wr™e_Ën
 !ðcmd->
bufæ’
)

1501 
do_z”o
 = 
Œue
;

1503 ià(
do_z”o
) {

1504 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

1505 
	`sc¡_z”o_wr™e_»¡
(
cmd
);

1510 
cmd
->
¡©e
 = 
SCST_CMD_STATE_SEND_FOR_EXEC
;

1512 ià((
cmd
->
tg‰
->
´e_exec
 =ð
NULL
è|| 
	`uÆik–y
(cmd->
š‹º®
))

1513 
out
;

1515 
	`TRACE_DBG
("C®lšg…»_exec(%p)", 
cmd
);

1516 
	`sc¡_£t_cur_¡¬t
(
cmd
);

1517 
rc
 = 
cmd
->
tg‰
->
	`´e_exec
(cmd);

1518 
	`sc¡_£t_´e_exec_time
(
cmd
);

1519 
	`TRACE_DBG
("´e_exec(è»tuºed %d", 
rc
);

1521 ià(
	`uÆik–y
(
rc
 !ð
SCST_PREPROCESS_STATUS_SUCCESS
)) {

1522 
rc
) {

1523 
SCST_PREPROCESS_STATUS_ERROR_SENSE_SET
:

1524 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1526 
SCST_PREPROCESS_STATUS_ERROR_FATAL
:

1527 
	`£t_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
);

1529 
SCST_PREPROCESS_STATUS_ERROR
:

1530 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1531 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1532 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1535 
	`sBUG
();

1540 
out
:

1541 
	`TRACE_EXIT_RES
(
»s
);

1542  
»s
;

1543 
	}
}

1545 
	$sc¡_do_cmd_dÚe
(
sc¡_cmd
 *
cmd
, 
»suÉ
,

1546 cÚ¡ 
ušt8_t
 *
rq_£n£
, 
rq_£n£_Ën
, 
»sid
)

1548 
	`TRACE_ENTRY
();

1550 
	`sc¡_£t_exec_time
(
cmd
);

1552 
cmd
->
¡©us
 = 
»suÉ
 & 0xff;

1553 
cmd
->
msg_¡©us
 = 
	`msg_by‹
(
»suÉ
);

1554 
cmd
->
ho¡_¡©us
 = 
	`ho¡_by‹
(
»suÉ
);

1555 
cmd
->
driv”_¡©us
 = 
	`driv”_by‹
(
»suÉ
);

1556 ià(
	`uÆik–y
(
»sid
 != 0)) {

1557 ià((
cmd
->
d©a_dœeùiÚ
 & 
SCST_DATA_READ
) &&

1558 (
»sid
 > 0è&& (»sid < 
cmd
->
»¥_d©a_Ën
))

1559 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, cmd->
»¥_d©a_Ën
 - 
»sid
);

1566 ià(
	`uÆik–y
(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
)) {

1568 
cmd
->
dbl_ua_Üig_»¥_d©a_Ën
 = cmd->
»¥_d©a_Ën
;

1569 
cmd
->
dbl_ua_Üig_d©a_dœeùiÚ
 = cmd->
d©a_dœeùiÚ
;

1571 
	`sc¡_®loc_£t_£n£
(
cmd
, 1, 
rq_£n£
, 
rq_£n£_Ën
);

1574 
	`TRACE
(
TRACE_SCSI
, "cmd %p,„esult %x, cmd->status %x,„esid %d, "

1576 "cmd->driv”_¡©u %x", 
cmd
, 
»suÉ
, cmd->
¡©us
, 
»sid
,

1577 
cmd
->
msg_¡©us
, cmd->
ho¡_¡©us
, cmd->
driv”_¡©us
);

1579 
cmd
->
com¶‘ed
 = 1;

1581 
	`TRACE_EXIT
();

1583 
	}
}

1586 
šlše
 
sc¡_exec_cÚ‹xt
 
	$sc¡_Ýtimize_po¡_exec_cÚ‹xt
(

1587 
sc¡_cmd
 *
cmd
, 
sc¡_exec_cÚ‹xt
 
cÚ‹xt
)

1589 ià(((
cÚ‹xt
 =ð
SCST_CONTEXT_SAME
è&& 
	`sc¡_cmd_©omic
(
cmd
)) ||

1590 (
cÚ‹xt
 =ð
SCST_CONTEXT_TASKLET
) ||

1591 (
cÚ‹xt
 =ð
SCST_CONTEXT_DIRECT_ATOMIC
)) {

1592 ià(!
	`‹¡_b™
(
SCST_TGT_DEV_AFTER_EXEC_ATOMIC
,

1593 &
cmd
->
tgt_dev
->
tgt_dev_æags
))

1594 
cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

1596  
cÚ‹xt
;

1597 
	}
}

1606 
	$sc¡_·ss_through_cmd_dÚe
(*
d©a
, *
£n£
, 
»suÉ
, 
»sid
)

1608 
sc¡_cmd
 *
cmd
;

1610 
	`TRACE_ENTRY
();

1612 
cmd
 = (
sc¡_cmd
 *)
d©a
;

1613 ià(
cmd
 =ð
NULL
)

1614 
out
;

1616 
	`sc¡_do_cmd_dÚe
(
cmd
, 
»suÉ
, 
£n£
, 
SCSI_SENSE_BUFFERSIZE
, 
»sid
);

1618 
cmd
->
¡©e
 = 
SCST_CMD_STATE_PRE_DEV_DONE
;

1620 
	`sc¡_´oûss_»dœeù_cmd
(
cmd
,

1621 
	`sc¡_Ýtimize_po¡_exec_cÚ‹xt
(
cmd
, 
	`sc¡_e¡im©e_cÚ‹xt
()), 0);

1623 
out
:

1624 
	`TRACE_EXIT
();

1626 
	}
}

1627 
EXPORT_SYMBOL_GPL
(
sc¡_·ss_through_cmd_dÚe
);

1629 
	$sc¡_cmd_dÚe_loÿl
(
sc¡_cmd
 *
cmd
, 
Ãxt_¡©e
,

1630 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

1632 
	`TRACE_ENTRY
();

1634 
	`EXTRACHECKS_BUG_ON
(
cmd
->
´_abÜt_couÁ”
 !ð
NULL
);

1636 
	`sc¡_£t_exec_time
(
cmd
);

1638 
	`TRACE
(
TRACE_SCSI
, "cmd %p, status %x, msg_status %x, host_status %x, "

1639 "driv”_¡©u %x,„e¥_d©a_ËÀ%d", 
cmd
, cmd->
¡©us
,

1640 
cmd
->
msg_¡©us
, cmd->
ho¡_¡©us
, cmd->
driv”_¡©us
,

1641 
cmd
->
»¥_d©a_Ën
);

1643 ià(
Ãxt_¡©e
 =ð
SCST_CMD_STATE_DEFAULT
)

1644 
Ãxt_¡©e
 = 
SCST_CMD_STATE_PRE_DEV_DONE
;

1646 #ià
	`defšed
(
CONFIG_SCST_DEBUG
)

1647 ià(
Ãxt_¡©e
 =ð
SCST_CMD_STATE_PRE_DEV_DONE
) {

1648 ià((
Œaû_æag
 & 
TRACE_RCV_TOP
è&& (
cmd
->
sg
 !ð
NULL
)) {

1649 
i
, 
j
;

1650 
sÿ‰”li¡
 *
sg
 = 
cmd
->sg;

1651 
	`TRACE_RECV_TOP
("Exec'd %d S/G(s)‡t %p sg[0].page‡t "

1652 "%p", 
cmd
->
sg_út
, 
sg
, (*)
	`sg_·ge
(&sg[0]));

1653 
i
 = 0, 
j
 = 0; i < 
cmd
->
sg_út
; ++i, ++j) {

1654 ià(
	`uÆik–y
(
	`sg_is_chaš
(&
sg
[
j
]))) {

1655 
sg
 = 
	`sg_chaš_±r
(&sg[
j
]);

1656 
j
 = 0;

1658 
	`TRACE_BUFF_FLAG
(
TRACE_RCV_TOP
,

1659 "Exec'd sg", 
	`sg_vœt
(&
sg
[
j
]),

1660 
sg
[
j
].
Ëngth
);

1666 
cmd
->
¡©e
 = 
Ãxt_¡©e
;

1668 #ifdeà
CONFIG_SCST_EXTRACHECKS


1669 ià((
Ãxt_¡©e
 !ð
SCST_CMD_STATE_PRE_DEV_DONE
) &&

1670 (
Ãxt_¡©e
 !ð
SCST_CMD_STATE_PRE_XMIT_RESP
) &&

1671 (
Ãxt_¡©e
 !ð
SCST_CMD_STATE_FINISHED
) &&

1672 (
Ãxt_¡©e
 !ð
SCST_CMD_STATE_FINISHED_INTERNAL
)) {

1673 
	`PRINT_ERROR
("%s()„eceived invalid cmd state %d (opcode %d)",

1674 
__func__
, 
Ãxt_¡©e
, 
cmd
->
cdb
[0]);

1675 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1676 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1677 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

1680 
´ef_cÚ‹xt
 = 
	`sc¡_Ýtimize_po¡_exec_cÚ‹xt
(
cmd
,…ref_context);

1681 
	`sc¡_´oûss_»dœeù_cmd
(
cmd
, 
´ef_cÚ‹xt
, 0);

1683 
	`TRACE_EXIT
();

1685 
	}
}

1687 
	$sc¡_»pÜt_luns_loÿl
(
sc¡_cmd
 *
cmd
)

1689 
»s
 = 
SCST_EXEC_COMPLETED
, 
rc
;

1690 
dev_út
 = 0;

1691 
bufãr_size
;

1692 
i
;

1693 
sc¡_tgt_dev
 *
tgt_dev
 = 
NULL
;

1694 
ušt8_t
 *
bufãr
;

1695 
offs
, 
ov”æow
 = 0;

1697 
	`TRACE_ENTRY
();

1699 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

1700 ià(
	`uÆik–y
(
rc
 != 0))

1701 
out_dÚe
;

1703 
cmd
->
¡©us
 = 0;

1704 
cmd
->
msg_¡©us
 = 0;

1705 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

1706 
cmd
->
driv”_¡©us
 = 0;

1708 ià((
cmd
->
cdb
[2] != 0) && (cmd->cdb[2] != 2)) {

1709 
	`PRINT_ERROR
("Unsupported SELECT REPORT value %x in REPORT "

1710 "LUNS commªd", 
cmd
->
cdb
[2]);

1711 
out_”r
;

1714 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
bufãr
);

1715 ià(
	`uÆik–y
(
bufãr_size
 == 0))

1716 
out_com¶
;

1717 ià(
	`uÆik–y
(
bufãr_size
 < 0))

1718 
out_hw_”r
;

1720 ià(
bufãr_size
 < 16)

1721 
out_put_”r
;

1723 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

1724 
offs
 = 8;

1730 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1731 
li¡_h—d
 *
h—d
 = &
cmd
->
£ss
->
£ss_tgt_dev_li¡
[
i
];

1732 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

1733 ià(!
ov”æow
) {

1734 ià((
bufãr_size
 - 
offs
) < 8) {

1735 
ov”æow
 = 1;

1736 
šc_dev_út
;

1738 *(
__fÜû
 
__be64
 *)&
bufãr
[
offs
]

1739 ð
	`sc¡_·ck_lun
(
tgt_dev
->
lun
,

1740 
cmd
->
£ss
->
acg
->
addr_m‘hod
);

1741 
offs
 += 8;

1743 
šc_dev_út
:

1744 
dev_út
++;

1749 
dev_út
 *= 8;

1750 
bufãr
[0] = (
dev_út
 >> 24) & 0xff;

1751 
bufãr
[1] = (
dev_út
 >> 16) & 0xff;

1752 
bufãr
[2] = (
dev_út
 >> 8) & 0xff;

1753 
bufãr
[3] = 
dev_út
 & 0xff;

1755 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

1757 
dev_út
 += 8;

1758 ià(
dev_út
 < 
cmd
->
»¥_d©a_Ën
)

1759 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
dev_út
);

1761 
out_com¶
:

1762 
cmd
->
com¶‘ed
 = 1;

1770 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

1771 
li¡_h—d
 *
h—d
 = &
cmd
->
£ss
->
£ss_tgt_dev_li¡
[
i
];

1773 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

1774 
sc¡_tgt_dev_UA
 *
ua
;

1776 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

1777 
	`li¡_fÜ_—ch_’Œy
(
ua
, &
tgt_dev
->
UA_li¡
,

1778 
UA_li¡_’Œy
) {

1779 ià(
	`sc¡_ª®yze_£n£
(
ua
->
UA_£n£_bufãr
,

1780 
ua
->
UA_v®id_£n£_Ën
,

1781 
SCST_SENSE_ALL_VALID
,

1782 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»pÜ‹d_luns_d©a_chªged
))) {

1783 
	`TRACE_MGMT_DBG
("Freeing‚ot‚eeded "

1785 "%p", 
ua
);

1786 
	`sc¡_tgt_dev_d–_ä“_UA
(
tgt_dev
, 
ua
);

1790 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

1794 
out_dÚe
:

1796 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

1798 
	`TRACE_EXIT_RES
(
»s
);

1799  
»s
;

1801 
out_put_”r
:

1802 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

1804 
out_”r
:

1805 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1806 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1807 
out_com¶
;

1809 
out_hw_”r
:

1810 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1811 
out_com¶
;

1812 
	}
}

1814 
	$sc¡_»que¡_£n£_loÿl
(
sc¡_cmd
 *
cmd
)

1816 
»s
 = 
SCST_EXEC_COMPLETED
, 
rc
;

1817 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

1818 
ušt8_t
 *
bufãr
;

1819 
bufãr_size
 = 0, 
¦
 = 0;

1821 
	`TRACE_ENTRY
();

1823 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

1824 ià(
	`uÆik–y
(
rc
 != 0))

1825 
out_dÚe
;

1827 
cmd
->
¡©us
 = 0;

1828 
cmd
->
msg_¡©us
 = 0;

1829 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

1830 
cmd
->
driv”_¡©us
 = 0;

1832 
	`¥š_lock_bh
(&
tgt_dev
->
tgt_dev_lock
);

1834 ià(
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 == 0)

1835 
out_uÆock_nÙ_com¶‘ed
;

1837 
	`TRACE
(
TRACE_SCSI
, "%s: R‘uºšg stÜed s’£", 
cmd
->
Ý_Çme
);

1839 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
bufãr
);

1840 ià(
	`uÆik–y
(
bufãr_size
 == 0))

1841 
out_uÆock_com¶
;

1842 ià(
	`uÆik–y
(
bufãr_size
 < 0))

1843 
out_uÆock_hw_”r
;

1845 
	`mem£t
(
bufãr
, 0, 
bufãr_size
);

1847 ià(((
tgt_dev
->
tgt_dev_£n£
[0] == 0x70) ||

1848 (
tgt_dev
->
tgt_dev_£n£
[0] =ð0x71)è&& (
cmd
->
cdb
[1] & 1)) {

1849 
	`PRINT_WARNING
("%s: Fixed format ofhe saved sense, but "

1851 "Œunÿ‹d d©a", 
cmd
->
Ý_Çme
);

1852 
	`PRINT_BUFFER
("Origš® s’£", 
tgt_dev
->
tgt_dev_£n£
,

1853 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
);

1855 
bufãr_size
 = 
	`mš
(
SCST_STANDARD_SENSE_LEN
, buffer_size);

1856 
¦
 = 
	`sc¡_£t_£n£
(
bufãr
, 
bufãr_size
, 
Œue
,

1857 
tgt_dev
->
tgt_dev_£n£
[2],gt_dev->tgt_dev_sense[12],

1858 
tgt_dev
->
tgt_dev_£n£
[13]);

1859 } ià(((
tgt_dev
->
tgt_dev_£n£
[0] == 0x72) ||

1860 (
tgt_dev
->
tgt_dev_£n£
[0] =ð0x73)è&& !(
cmd
->
cdb
[1] & 1)) {

1861 
	`PRINT_WARNING
("%s: Descriptor format ofhe "

1863 "wžÈŒunÿ‹d d©a", 
cmd
->
Ý_Çme
);

1864 
	`PRINT_BUFFER
("Origš® s’£", 
tgt_dev
->
tgt_dev_£n£
,

1865 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
);

1867 
bufãr_size
 = 
	`mš
(
SCST_STANDARD_SENSE_LEN
, buffer_size);

1868 
¦
 = 
	`sc¡_£t_£n£
(
bufãr
, 
bufãr_size
, 
çl£
,

1869 
tgt_dev
->
tgt_dev_£n£
[1],gt_dev->tgt_dev_sense[2],

1870 
tgt_dev
->
tgt_dev_£n£
[3]);

1872 ià(
bufãr_size
 >ð
tgt_dev
->
tgt_dev_v®id_£n£_Ën
)

1873 
¦
 = 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
;

1875 
¦
 = 
bufãr_size
;

1876 
	`TRACE
(
TRACE_MINOR
, "%s: Being„eturned senseruncated "

1877 "tØsiz%d (Ãeded %d)", 
cmd
->
Ý_Çme
,

1878 
bufãr_size
, 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
);

1880 
	`memýy
(
bufãr
, 
tgt_dev
->
tgt_dev_£n£
, 
¦
);

1883 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

1885 
tgt_dev
->
tgt_dev_v®id_£n£_Ën
 = 0;

1887 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

1889 
	`sc¡_£t_»¥_d©a_Ën
(
cmd
, 
¦
);

1891 
out_com¶
:

1892 
cmd
->
com¶‘ed
 = 1;

1894 
out_dÚe
:

1896 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

1898 
out
:

1899 
	`TRACE_EXIT_RES
(
»s
);

1900  
»s
;

1902 
out_uÆock_hw_”r
:

1903 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

1904 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

1905 
out_com¶
;

1907 
out_uÆock_nÙ_com¶‘ed
:

1908 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

1909 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

1910 
out
;

1912 
out_uÆock_com¶
:

1913 
	`¥š_uÆock_bh
(&
tgt_dev
->
tgt_dev_lock
);

1914 
out_com¶
;

1915 
	}
}

1917 
	$sc¡_»£rve_loÿl
(
sc¡_cmd
 *
cmd
)

1919 
»s
 = 
SCST_EXEC_NOT_COMPLETED
, 
rc
;

1920 
sc¡_deviû
 *
dev
;

1921 
sc¡_tgt_dev
 *
tgt_dev_tmp
;

1923 
	`TRACE_ENTRY
();

1925 ià((
cmd
->
cdb
[0] =ð
RESERVE_10
è&& (cmd->cdb[2] & 
SCST_RES_3RDPTY
)) {

1926 
	`PRINT_ERROR
("RESERVE_10: 3rdPty RESERVE‚ot implemented "

1927 "Öun=%Îd)", ()
cmd
->
lun
);

1928 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

1929 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

1930 
out_dÚe
;

1933 
dev
 = 
cmd
->dev;

1952 
rc
 = 
	`sc¡_´e_check_loÿl_ev’ts
(
cmd
);

1953 ià(
	`uÆik–y
(
rc
 != 0))

1954 
out_dÚe
;

1956 ià(!
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
)) {

1957 ià(
	`sc¡_´_üh_ÿ£
(
cmd
))

1958 
out_com¶‘ed
;

1960 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

1961 
SAM_STAT_RESERVATION_CONFLICT
);

1962 
out_dÚe
;

1966 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

1968 ià(
	`‹¡_b™
(
SCST_TGT_DEV_RESERVED
, &
cmd
->
tgt_dev
->
tgt_dev_æags
)) {

1969 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

1970 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

1971 
out_dÚe
;

1974 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev_tmp
, &
dev
->
dev_tgt_dev_li¡
,

1975 
dev_tgt_dev_li¡_’Œy
) {

1976 ià(
cmd
->
tgt_dev
 !ð
tgt_dev_tmp
)

1977 
	`£t_b™
(
SCST_TGT_DEV_RESERVED
,

1978 &
tgt_dev_tmp
->
tgt_dev_æags
);

1980 
dev
->
dev_»£rved
 = 1;

1982 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

1984 
out
:

1985 
	`TRACE_EXIT_RES
(
»s
);

1986  
»s
;

1988 
out_com¶‘ed
:

1989 
cmd
->
com¶‘ed
 = 1;

1991 
out_dÚe
:

1993 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

1994 
»s
 = 
SCST_EXEC_COMPLETED
;

1995 
out
;

1996 
	}
}

1998 
	$sc¡_»Ëa£_loÿl
(
sc¡_cmd
 *
cmd
)

2000 
»s
 = 
SCST_EXEC_NOT_COMPLETED
, 
rc
;

2001 
sc¡_tgt_dev
 *
tgt_dev_tmp
;

2002 
sc¡_deviû
 *
dev
;

2004 
	`TRACE_ENTRY
();

2006 
dev
 = 
cmd
->dev;

2013 
rc
 = 
	`sc¡_´e_check_loÿl_ev’ts
(
cmd
);

2014 ià(
	`uÆik–y
(
rc
 != 0))

2015 
out_dÚe
;

2017 ià(!
	`li¡_em±y
(&
dev
->
dev_»gi¡¿Ás_li¡
)) {

2018 ià(
	`sc¡_´_üh_ÿ£
(
cmd
))

2019 
out_com¶‘ed
;

2021 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

2022 
SAM_STAT_RESERVATION_CONFLICT
);

2023 
out_dÚe
;

2027 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

2034 ià(
	`‹¡_b™
(
SCST_TGT_DEV_RESERVED
, &
cmd
->
tgt_dev
->
tgt_dev_æags
)) {

2035 
»s
 = 
SCST_EXEC_COMPLETED
;

2036 
cmd
->
¡©us
 = 0;

2037 
cmd
->
msg_¡©us
 = 0;

2038 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

2039 
cmd
->
driv”_¡©us
 = 0;

2040 
cmd
->
com¶‘ed
 = 1;

2042 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev_tmp
,

2043 &
dev
->
dev_tgt_dev_li¡
,

2044 
dev_tgt_dev_li¡_’Œy
) {

2045 
	`þ—r_b™
(
SCST_TGT_DEV_RESERVED
,

2046 &
tgt_dev_tmp
->
tgt_dev_æags
);

2048 
dev
->
dev_»£rved
 = 0;

2051 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

2053 ià(
»s
 =ð
SCST_EXEC_COMPLETED
)

2054 
out_dÚe
;

2056 
out
:

2057 
	`TRACE_EXIT_RES
(
»s
);

2058  
»s
;

2060 
out_com¶‘ed
:

2061 
cmd
->
com¶‘ed
 = 1;

2063 
out_dÚe
:

2064 
»s
 = 
SCST_EXEC_COMPLETED
;

2066 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2067 
out
;

2068 
	}
}

2071 
	$sc¡_³rsi¡’t_»£rve_š_loÿl
(
sc¡_cmd
 *
cmd
)

2073 
rc
;

2074 
sc¡_deviû
 *
dev
;

2075 
sc¡_tgt_dev
 *
tgt_dev
;

2076 
sc¡_£ssiÚ
 *
£ssiÚ
;

2077 
aùiÚ
;

2078 
ušt8_t
 *
bufãr
;

2079 
bufãr_size
;

2081 
	`TRACE_ENTRY
();

2083 
	`EXTRACHECKS_BUG_ON
(
	`sc¡_cmd_©omic
(
cmd
));

2085 
dev
 = 
cmd
->dev;

2086 
tgt_dev
 = 
cmd
->tgt_dev;

2087 
£ssiÚ
 = 
cmd
->
£ss
;

2089 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

2090 ià(
	`uÆik–y
(
rc
 != 0))

2091 
out_dÚe
;

2093 ià(
	`uÆik–y
(
dev
->
nÙ_´_suµÜtšg_tgt_devs_num
 != 0)) {

2094 
	`PRINT_WARNING
("Persistent Reservation command %x„efused for "

2096 "Œª¥Üt cÚÃùed", 
cmd
->
cdb
[0], 
dev
->
vœt_Çme
);

2097 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2098 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

2099 
out_dÚe
;

2102 ià(
dev
->
dev_»£rved
) {

2103 
	`TRACE_PR
("PR command„ejected, because device %s holds„egular "

2104 "»£rv©iÚ", 
dev
->
vœt_Çme
);

2105 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2106 
out_dÚe
;

2109 ià(
dev
->
scsi_dev
 !ð
NULL
) {

2110 
	`PRINT_WARNING
("PR commands for…ass-through devices‚ot "

2111 "suµÜ‹d (deviû %s)", 
dev
->
vœt_Çme
);

2112 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2113 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

2114 
out_dÚe
;

2117 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
bufãr
);

2118 ià(
	`uÆik–y
(
bufãr_size
 <= 0)) {

2119 ià(
bufãr_size
 < 0)

2120 
	`sc¡_£t_busy
(
cmd
);

2121 
out_dÚe
;

2124 
	`sc¡_´_wr™e_lock
(
dev
);

2127 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))) {

2128 
	`TRACE_MGMT_DBG
("ABORTED s‘,‡bÜtšg cmd %p", 
cmd
);

2129 
out_uÆock
;

2132 
aùiÚ
 = 
cmd
->
cdb
[1] & 0x1f;

2134 
	`TRACE
(
TRACE_SCSI
, "PR‡ùiÚ %x fÜ '%s' (LUN %Îxèäom '%s'", 
aùiÚ
,

2135 
dev
->
vœt_Çme
, 
tgt_dev
->
lun
, 
£ssiÚ
->
š™ŸtÜ_Çme
);

2137 
aùiÚ
) {

2138 
PR_READ_KEYS
:

2139 
	`sc¡_´_»ad_keys
(
cmd
, 
bufãr
, 
bufãr_size
);

2141 
PR_READ_RESERVATION
:

2142 
	`sc¡_´_»ad_»£rv©iÚ
(
cmd
, 
bufãr
, 
bufãr_size
);

2144 
PR_REPORT_CAPS
:

2145 
	`sc¡_´_»pÜt_ÿps
(
cmd
, 
bufãr
, 
bufãr_size
);

2147 
PR_READ_FULL_STATUS
:

2148 
	`sc¡_´_»ad_fuÎ_¡©us
(
cmd
, 
bufãr
, 
bufãr_size
);

2151 
	`PRINT_ERROR
("UnsuµÜ‹d‡ùiÚ %x", 
aùiÚ
);

2152 
	`sc¡_´_wr™e_uÆock
(
dev
);

2153 
out_”r
;

2156 
out_com¶‘e
:

2157 
cmd
->
com¶‘ed
 = 1;

2159 
out_uÆock
:

2160 
	`sc¡_´_wr™e_uÆock
(
dev
);

2162 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

2164 
out_dÚe
:

2165 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2167 
	`TRACE_EXIT_RES
(
SCST_EXEC_COMPLETED
);

2168  
SCST_EXEC_COMPLETED
;

2170 
out_”r
:

2171 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2172 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2173 
out_com¶‘e
;

2174 
	}
}

2177 
	$sc¡_³rsi¡’t_»£rve_out_loÿl
(
sc¡_cmd
 *
cmd
)

2179 
»s
 = 
SCST_EXEC_COMPLETED
;

2180 
rc
;

2181 
sc¡_deviû
 *
dev
;

2182 
sc¡_tgt_dev
 *
tgt_dev
;

2183 
sc¡_£ssiÚ
 *
£ssiÚ
;

2184 
aùiÚ
;

2185 
ušt8_t
 *
bufãr
;

2186 
bufãr_size
;

2187 
boÞ
 
abÜ‹d
 = 
çl£
;

2189 
	`TRACE_ENTRY
();

2191 
	`EXTRACHECKS_BUG_ON
(
	`sc¡_cmd_©omic
(
cmd
));

2193 
dev
 = 
cmd
->dev;

2194 
tgt_dev
 = 
cmd
->tgt_dev;

2195 
£ssiÚ
 = 
cmd
->
£ss
;

2197 
rc
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

2198 ià(
	`uÆik–y
(
rc
 != 0))

2199 
out_dÚe
;

2201 ià(
	`uÆik–y
(
dev
->
nÙ_´_suµÜtšg_tgt_devs_num
 != 0)) {

2202 
	`PRINT_WARNING
("Persistent Reservation command %x„efused for "

2204 "Œª¥Üt cÚÃùed", 
cmd
->
cdb
[0], 
dev
->
vœt_Çme
);

2205 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2206 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_Ýcode
));

2207 
out_dÚe
;

2210 
aùiÚ
 = 
cmd
->
cdb
[1] & 0x1f;

2212 
	`TRACE
(
TRACE_SCSI
, "PR‡ùiÚ %x fÜ '%s' (LUN %Îxèäom '%s'", 
aùiÚ
,

2213 
dev
->
vœt_Çme
, 
tgt_dev
->
lun
, 
£ssiÚ
->
š™ŸtÜ_Çme
);

2215 ià(
dev
->
dev_»£rved
) {

2216 
	`TRACE_PR
("PR command„ejected, because device %s holds„egular "

2217 "»£rv©iÚ", 
dev
->
vœt_Çme
);

2218 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2219 
out_dÚe
;

2229 ià((
aùiÚ
 !ð
PR_REGISTER
è&& (aùiÚ !ð
PR_REGISTER_AND_IGNORE
) &&

2230 (
tgt_dev
->
»gi¡¿Á
 =ð
NULL
)) {

2231 
	`TRACE_PR
("'%s'‚Ù„egi¡”ed", 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

2232 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
, 
SAM_STAT_RESERVATION_CONFLICT
);

2233 
out_dÚe
;

2236 
bufãr_size
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
bufãr
);

2237 ià(
	`uÆik–y
(
bufãr_size
 <= 0)) {

2238 ià(
bufãr_size
 < 0)

2239 
	`sc¡_£t_busy
(
cmd
);

2240 
out_dÚe
;

2244 ià((
aùiÚ
 !ð
PR_REGISTER
è&& (aùiÚ !ð
PR_REGISTER_AND_IGNORE
) &&

2245 (
aùiÚ
 !ð
PR_CLEAR
è&& ((
cmd
->
cdb
[2] & 0x0fè>> 4è!ð
SCOPE_LU
) {

2246 
	`TRACE_PR
("ScÝmu¡ bSCOPE_LU fÜ‡ùiÚ %x", 
aùiÚ
);

2247 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2248 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2249 
out_put_buf_fuÎ
;

2253 ià((
aùiÚ
 !ð
PR_REGISTER
è&& (aùiÚ !ð
PR_REGISTER_AND_MOVE
) &&

2254 ((
bufãr
[20] >> 3) & 0x01)) {

2255 
	`TRACE_PR
("SPEC_I_PT mu¡ bz”ØfÜ‡ùiÚ %x", 
aùiÚ
);

2256 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

2257 
sc¡_£n£_šv®id_f›ld_š_cdb
));

2258 
out_put_buf_fuÎ
;

2262 ià((
aùiÚ
 !ð
PR_REGISTER
è&& (aùiÚ !ð
PR_REGISTER_AND_IGNORE
) &&

2263 (
aùiÚ
 !ð
PR_REGISTER_AND_MOVE
è&& ((
bufãr
[20] >> 2) & 0x01)) {

2264 
	`TRACE_PR
("ALL_TG_PT mu¡ bz”ØfÜ‡ùiÚ %x", 
aùiÚ
);

2265 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(

2266 
sc¡_£n£_šv®id_f›ld_š_cdb
));

2267 
out_put_buf_fuÎ
;

2270 
	`sc¡_´_wr™e_lock
(
dev
);

2273 
abÜ‹d
 = 
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
);

2274 ià(
	`uÆik–y
(
abÜ‹d
)) {

2275 
	`TRACE_MGMT_DBG
("ABORTED s‘,‡bÜtšg cmd %p", 
cmd
);

2276 
out_uÆock
;

2279 
aùiÚ
) {

2280 
PR_REGISTER
:

2281 
	`sc¡_´_»gi¡”
(
cmd
, 
bufãr
, 
bufãr_size
);

2283 
PR_RESERVE
:

2284 
	`sc¡_´_»£rve
(
cmd
, 
bufãr
, 
bufãr_size
);

2286 
PR_RELEASE
:

2287 
	`sc¡_´_»Ëa£
(
cmd
, 
bufãr
, 
bufãr_size
);

2289 
PR_CLEAR
:

2290 
	`sc¡_´_þ—r
(
cmd
, 
bufãr
, 
bufãr_size
);

2292 
PR_PREEMPT
:

2293 
	`sc¡_´_´“m±
(
cmd
, 
bufãr
, 
bufãr_size
);

2295 
PR_PREEMPT_AND_ABORT
:

2296 
	`sc¡_´_´“m±_ªd_abÜt
(
cmd
, 
bufãr
, 
bufãr_size
);

2298 
PR_REGISTER_AND_IGNORE
:

2299 
	`sc¡_´_»gi¡”_ªd_ignÜe
(
cmd
, 
bufãr
, 
bufãr_size
);

2301 
PR_REGISTER_AND_MOVE
:

2302 
	`sc¡_´_»gi¡”_ªd_move
(
cmd
, 
bufãr
, 
bufãr_size
);

2305 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2306 
	`SCST_LOAD_SENSE
(
sc¡_£n£_šv®id_f›ld_š_cdb
));

2307 
out_uÆock
;

2310 #iâdeà
CONFIG_SCST_PROC


2311 ià(
cmd
->
¡©us
 =ð
SAM_STAT_GOOD
)

2312 
	`sc¡_´_sync_deviû_fže
(
tgt_dev
, 
cmd
);

2315 ià((
dev
->
hªdËr
->
´_cmds_nÙifiÿtiÚs
) &&

2316 (
cmd
->
¡©us
 =ð
SAM_STAT_GOOD
))

2317 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

2319 
out_uÆock
:

2320 
	`sc¡_´_wr™e_uÆock
(
dev
);

2322 
out_put_buf_fuÎ
:

2323 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

2325 
out_dÚe
:

2326 ià(
SCST_EXEC_COMPLETED
 =ð
»s
) {

2327 ià(!
abÜ‹d
)

2328 
cmd
->
com¶‘ed
 = 1;

2329 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
,

2330 
SCST_CONTEXT_SAME
);

2333 
	`TRACE_EXIT_RES
(
»s
);

2334  
»s
;

2335 
	}
}

2354 
	$sc¡_check_loÿl_ev’ts
(
sc¡_cmd
 *
cmd
)

2356 
»s
, 
rc
;

2357 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2358 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2360 
	`TRACE_ENTRY
();

2366 ià(
	`uÆik–y
(
dev
->
dev_doubË_ua_possibË
))

2367 
cmd
->
doubË_ua_possibË
 = 1;

2370 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_TGT_DEV_RESERVED
,

2371 &
tgt_dev
->
tgt_dev_æags
))) {

2372 ià((
cmd
->
Ý_æags
 & 
SCST_REG_RESERVE_ALLOWED
) == 0) {

2373 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

2374 
SAM_STAT_RESERVATION_CONFLICT
);

2375 
out_dec_´_»ad”s_couÁ
;

2379 ià(
	`lik–y
(!
cmd
->
check_loÿl_ev’ts_Úû_dÚe
)) {

2380 ià(
dev
->
´_is_£t
) {

2381 ià(
	`uÆik–y
(!
	`sc¡_´_is_cmd_®lowed
(
cmd
))) {

2382 
	`sc¡_£t_cmd_”rÜ_¡©us
(
cmd
,

2383 
SAM_STAT_RESERVATION_CONFLICT
);

2384 
out_com¶‘e
;

2387 
	`sc¡_dec_´_»ad”s_couÁ
(
cmd
, 
çl£
);

2394 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))) {

2395 
	`TRACE_MGMT_DBG
("ABORTED s‘,‡bÜtšg cmd %p", 
cmd
);

2396 
out_uncom¶‘e
;

2400 ià((
dev
->
scsi_dev
 !ð
NULL
) &&

2401 
	`uÆik–y
(
dev
->
scsi_dev
->
was_»£t
)) {

2402 ià(
	`sc¡_is_ua_commªd
(
cmd
)) {

2403 
dÚe
 = 0;

2407 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

2408 ià(
dev
->
scsi_dev
->
was_»£t
) {

2409 
	`TRACE
(
TRACE_MGMT
, "was_reset is %d", 1);

2410 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2411 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

2416 
dev
->
scsi_dev
->
was_»£t
 = 0;

2417 
dÚe
 = 1;

2419 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

2421 ià(
dÚe
)

2422 
out_com¶‘e
;

2426 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_TGT_DEV_UA_PENDING
,

2427 &
cmd
->
tgt_dev
->
tgt_dev_æags
))) {

2428 ià(
	`sc¡_is_ua_commªd
(
cmd
)) {

2429 
rc
 = 
	`sc¡_£t_³ndšg_UA
(
cmd
);

2430 ià(
rc
 == 0)

2431 
out_com¶‘e
;

2435 
»s
 = 0;

2437 
out
:

2438 
	`TRACE_EXIT_RES
(
»s
);

2439  
»s
;

2441 
out_dec_´_»ad”s_couÁ
:

2442 ià(
cmd
->
dec_´_»ad”s_couÁ_Ãeded
)

2443 
	`sc¡_dec_´_»ad”s_couÁ
(
cmd
, 
çl£
);

2445 
out_com¶‘e
:

2446 
»s
 = 1;

2447 
	`sBUG_ON
(!
cmd
->
com¶‘ed
);

2448 
out
;

2450 
out_uncom¶‘e
:

2451 
»s
 = -1;

2452 
out
;

2453 
	}
}

2454 
EXPORT_SYMBOL_GPL
(
sc¡_check_loÿl_ev’ts
);

2457 
	$sc¡_šc_ex³ùed_¢
(
sc¡_Üd”_d©a
 *
Üd”_d©a
, 
©omic_t
 *
¦Ù
)

2459 ià(
¦Ù
 =ð
NULL
)

2460 
šc
;

2464 
	`TRACE_SN
("SlÙ %zd, *cur_¢_¦Ù %d", 
¦Ù
 - 
Üd”_d©a
->
¢_¦Ùs
,

2465 
	`©omic_»ad
(
¦Ù
));

2467 ià(!
	`©omic_dec_ªd_‹¡
(
¦Ù
))

2468 
out
;

2470 
	`TRACE_SN
("Slot is 0 (num_free_sn_slots=%d)",

2471 
Üd”_d©a
->
num_ä“_¢_¦Ùs
);

2472 ià(
Üd”_d©a
->
num_ä“_¢_¦Ùs
 < ()
	`ARRAY_SIZE
(Üd”_d©a->
¢_¦Ùs
)-1) {

2473 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

2474 ià(
	`lik–y
(
Üd”_d©a
->
num_ä“_¢_¦Ùs
 < ()
	`ARRAY_SIZE
(Üd”_d©a->
¢_¦Ùs
)-1)) {

2475 ià(
Üd”_d©a
->
num_ä“_¢_¦Ùs
 < 0)

2476 
Üd”_d©a
->
cur_¢_¦Ù
 = 
¦Ù
;

2478 
	`smp_mb
();

2479 
Üd”_d©a
->
num_ä“_¢_¦Ùs
++;

2480 
	`TRACE_SN
("Incremented‚um_free_sn_slots (%d)",

2481 
Üd”_d©a
->
num_ä“_¢_¦Ùs
);

2484 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

2487 
šc
:

2493 
Üd”_d©a
->
ex³ùed_¢
++;

2498 
	`smp_mb
();

2499 
	`TRACE_SN
("Nexˆex³ùed_¢: %d", 
Üd”_d©a
->
ex³ùed_¢
);

2501 
out
:

2503 
	}
}

2506 
sc¡_cmd
 *
	$sc¡_po¡_exec_¢
(
sc¡_cmd
 *
cmd
,

2507 
boÞ
 
make_aùive
)

2510 
boÞ
 
šc_ex³ùed_¢
 = !
cmd
->
šc_ex³ùed_¢_Ú_dÚe
 &&

2511 
cmd
->
¢_£t
 && !cmd->
»Œy
;

2512 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
cmd
->
cur_Üd”_d©a
;

2513 
sc¡_cmd
 *
»s
;

2515 
	`TRACE_ENTRY
();

2517 ià(
šc_ex³ùed_¢
)

2518 
	`sc¡_šc_ex³ùed_¢
(
Üd”_d©a
, 
cmd
->
¢_¦Ù
);

2520 ià(
make_aùive
) {

2521 
	`sc¡_make_deã¼ed_commªds_aùive
(
Üd”_d©a
);

2522 
»s
 = 
NULL
;

2524 
»s
 = 
	`sc¡_check_deã¼ed_commªds
(
Üd”_d©a
);

2526 
	`TRACE_EXIT_HRES
(
»s
);

2527  
»s
;

2528 
	}
}

2531 
	$sc¡_do_»®_exec
(
sc¡_cmd
 *
cmd
)

2533 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

2534 
rc
;

2535 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2536 
sc¡_dev_ty³
 *
hªdËr
 = 
dev
->handler;

2537 
io_cÚ‹xt
 *
Þd_ùx
 = 
NULL
;

2538 
boÞ
 
ùx_chªged
 = 
çl£
;

2539 
scsi_deviû
 *
scsi_dev
;

2541 
	`TRACE_ENTRY
();

2543 
ùx_chªged
 = 
	`sc¡_£t_io_cÚ‹xt
(
cmd
, &
Þd_ùx
);

2545 
cmd
->
¡©e
 = 
SCST_CMD_STATE_REAL_EXECUTING
;

2547 ià(
hªdËr
->
exec
) {

2548 
	`TRACE_DBG
("Calling dev handler %sƒxec(%p)",

2549 
hªdËr
->
Çme
, 
cmd
);

2550 
	`TRACE_BUFF_FLAG
(
TRACE_SND_TOP
, "Execšg: ", 
cmd
->
cdb
,

2551 
cmd
->
cdb_Ën
);

2552 
	`sc¡_£t_cur_¡¬t
(
cmd
);

2553 
»s
 = 
hªdËr
->
	`exec
(
cmd
);

2554 
	`TRACE_DBG
("Dev handler %sƒxec()„eturned %d",

2555 
hªdËr
->
Çme
, 
»s
);

2557 ià(
»s
 =ð
SCST_EXEC_COMPLETED
)

2558 
out_com¶‘e
;

2560 
	`sc¡_£t_exec_time
(
cmd
);

2562 
	`sBUG_ON
(
»s
 !ð
SCST_EXEC_NOT_COMPLETED
);

2565 
	`TRACE_DBG
("S’dšg cmd %°tØSCSI mid-Ëv–", 
cmd
);

2567 
scsi_dev
 = 
dev
->scsi_dev;

2569 ià(
	`uÆik–y
(
scsi_dev
 =ð
NULL
)) {

2570 
	`PRINT_ERROR
("Command for virtual device must be "

2572 ()
cmd
->
lun
);

2573 
out_”rÜ
;

2576 
»s
 = 
	`sc¡_check_loÿl_ev’ts
(
cmd
);

2577 ià(
	`uÆik–y
(
»s
 != 0))

2578 
out_dÚe
;

2580 
	`sc¡_£t_cur_¡¬t
(
cmd
);

2582 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 30)

2583 
rc
 = 
	`sc¡_exec_»q
(
scsi_dev
, 
cmd
->
cdb
, cmd->
cdb_Ën
,

2584 
cmd
->
d©a_dœeùiÚ
, cmd->
sg
, cmd->
bufæ’
,

2585 
cmd
->
sg_út
, cmd->
timeout
, cmd->
»Œ›s
, cmd,

2586 
sc¡_·ss_through_cmd_dÚe
, 
GFP_KERNEL
);

2588 
rc
 = 
	`sc¡_scsi_exec_async
(
cmd
, cmd, 
sc¡_·ss_through_cmd_dÚe
);

2590 ià(
	`uÆik–y
(
rc
 != 0)) {

2591 
	`PRINT_ERROR
("sc¡…ass-throughƒxeøçžed: %x", 
rc
);

2592 ià((()
rc
 =ð-
EINVAL
) &&

2593 (
cmd
->
bufæ’
 > 
	`queue_max_hw_£ùÜs
(
scsi_dev
->
»que¡_queue
)))

2594 
	`PRINT_ERROR
("Too†ow max_hw_sectors %d sectors on %s "

2597 
	`queue_max_hw_£ùÜs
(
scsi_dev
->
»que¡_queue
),

2598 
dev
->
vœt_Çme
, 
cmd
->
cdb
[0], cmd->
bufæ’
);

2599 
out_”rÜ
;

2602 
out_com¶‘e
:

2603 
»s
 = 
SCST_EXEC_COMPLETED
;

2605 ià(
ùx_chªged
)

2606 
	`sc¡_»£t_io_cÚ‹xt
(
cmd
->
tgt_dev
, 
Þd_ùx
);

2608 
	`TRACE_EXIT_RES
(
»s
);

2609  
»s
;

2611 
out_”rÜ
:

2612 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

2613 
out_dÚe
;

2615 
out_dÚe
:

2616 
»s
 = 
SCST_EXEC_COMPLETED
;

2618 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2619 
out_com¶‘e
;

2620 
	}
}

2622 
šlše
 
	$sc¡_»®_exec
(
sc¡_cmd
 *
cmd
)

2624 
»s
;

2626 
	`TRACE_ENTRY
();

2628 
	`BUILD_BUG_ON
(
SCST_CMD_STATE_RES_CONT_SAME
 !ð
SCST_EXEC_NOT_COMPLETED
);

2629 
	`BUILD_BUG_ON
(
SCST_CMD_STATE_RES_CONT_NEXT
 !ð
SCST_EXEC_COMPLETED
);

2631 
	`__sc¡_cmd_g‘
(
cmd
);

2633 
»s
 = 
	`sc¡_do_»®_exec
(
cmd
);

2634 ià(
	`lik–y
(
»s
 =ð
SCST_EXEC_COMPLETED
)) {

2635 
	`sc¡_po¡_exec_¢
(
cmd
, 
Œue
);

2636 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

2637 ià(
cmd
->
dev
->
scsi_dev
 !ð
NULL
)

2638 
	`g’”ic_uÅlug_deviû
(

2639 
cmd
->
dev
->
scsi_dev
->
»que¡_queue
);

2642 
	`sBUG
();

2644 
	`__sc¡_cmd_put
(
cmd
);

2648 
	`TRACE_EXIT_RES
(
»s
);

2649  
»s
;

2650 
	}
}

2652 
	$sc¡_do_loÿl_exec
(
sc¡_cmd
 *
cmd
)

2654 
»s
;

2655 
sc¡_tgt_dev
 *
tgt_dev
 = 
cmd
->tgt_dev;

2657 
	`TRACE_ENTRY
();

2660 ià((
cmd
->
Ý_æags
 & 
SCST_WRITE_MEDIUM
) &&

2661 (
tgt_dev
->
acg_dev
->
rd_Úly
 || 
cmd
->
dev
->
swp
 ||

2662 
cmd
->
dev
->
rd_Úly
)) {

2663 
	`PRINT_WARNING
("Attempt of write‡ccesso„ead-only device: "

2665 
cmd
->
£ss
->
š™ŸtÜ_Çme
, cmd->
lun
, cmd->
cdb
[0]);

2666 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

2667 
	`SCST_LOAD_SENSE
(
sc¡_£n£_d©a_´Ùeù
));

2668 
out_dÚe
;

2671 ià(!
	`sc¡_is_cmd_loÿl
(
cmd
)) {

2672 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

2673 
out
;

2676 
cmd
->
cdb
[0]) {

2677 
RESERVE
:

2678 
RESERVE_10
:

2679 
»s
 = 
	`sc¡_»£rve_loÿl
(
cmd
);

2681 
RELEASE
:

2682 
RELEASE_10
:

2683 
»s
 = 
	`sc¡_»Ëa£_loÿl
(
cmd
);

2685 
PERSISTENT_RESERVE_IN
:

2686 
»s
 = 
	`sc¡_³rsi¡’t_»£rve_š_loÿl
(
cmd
);

2688 
PERSISTENT_RESERVE_OUT
:

2689 
»s
 = 
	`sc¡_³rsi¡’t_»£rve_out_loÿl
(
cmd
);

2691 
REPORT_LUNS
:

2692 
»s
 = 
	`sc¡_»pÜt_luns_loÿl
(
cmd
);

2694 
REQUEST_SENSE
:

2695 
»s
 = 
	`sc¡_»que¡_£n£_loÿl
(
cmd
);

2698 
»s
 = 
SCST_EXEC_NOT_COMPLETED
;

2702 
out
:

2703 
	`TRACE_EXIT_RES
(
»s
);

2704  
»s
;

2706 
out_dÚe
:

2708 
cmd
->
	`sc¡_cmd_dÚe
(cmd, 
SCST_CMD_STATE_DEFAULT
, 
SCST_CONTEXT_SAME
);

2709 
»s
 = 
SCST_EXEC_COMPLETED
;

2710 
out
;

2711 
	}
}

2713 
	$sc¡_loÿl_exec
(
sc¡_cmd
 *
cmd
)

2715 
»s
;

2717 
	`TRACE_ENTRY
();

2719 
	`BUILD_BUG_ON
(
SCST_CMD_STATE_RES_CONT_SAME
 !ð
SCST_EXEC_NOT_COMPLETED
);

2720 
	`BUILD_BUG_ON
(
SCST_CMD_STATE_RES_CONT_NEXT
 !ð
SCST_EXEC_COMPLETED
);

2722 
	`__sc¡_cmd_g‘
(
cmd
);

2724 
»s
 = 
	`sc¡_do_loÿl_exec
(
cmd
);

2725 ià(
	`lik–y
(
»s
 =ð
SCST_EXEC_NOT_COMPLETED
))

2726 
cmd
->
¡©e
 = 
SCST_CMD_STATE_REAL_EXEC
;

2727 ià(
»s
 =ð
SCST_EXEC_COMPLETED
)

2728 
	`sc¡_po¡_exec_¢
(
cmd
, 
Œue
);

2730 
	`sBUG
();

2732 
	`__sc¡_cmd_put
(
cmd
);

2735 
	`TRACE_EXIT_RES
(
»s
);

2736  
»s
;

2737 
	}
}

2739 
	$sc¡_exec
(
sc¡_cmd
 **
aùive_cmd
)

2741 
sc¡_cmd
 *
cmd
 = *
aùive_cmd
;

2742 
sc¡_cmd
 *
»f_cmd
;

2743 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
, 
couÁ
 = 0;

2745 
	`TRACE_ENTRY
();

2747 
cmd
->
¡©e
 = 
SCST_CMD_STATE_START_EXEC
;

2749 ià(
	`uÆik–y
(
	`sc¡_check_blocked_dev
(
cmd
)))

2750 
out
;

2753 
»f_cmd
 = 
cmd
;

2754 
	`__sc¡_cmd_g‘
(
»f_cmd
);

2757 
rc
;

2759 
cmd
->
£Á_fÜ_exec
 = 1;

2766 
	`smp_mb
();

2768 
cmd
->
sc¡_cmd_dÚe
 = 
sc¡_cmd_dÚe_loÿl
;

2769 
cmd
->
¡©e
 = 
SCST_CMD_STATE_LOCAL_EXEC
;

2771 
rc
 = 
	`sc¡_do_loÿl_exec
(
cmd
);

2772 ià(
	`lik–y
(
rc
 =ð
SCST_EXEC_NOT_COMPLETED
))

2775 
	`sBUG_ON
(
rc
 !ð
SCST_EXEC_COMPLETED
);

2776 
dÚe
;

2779 
cmd
->
¡©e
 = 
SCST_CMD_STATE_REAL_EXEC
;

2781 
rc
 = 
	`sc¡_do_»®_exec
(
cmd
);

2782 
	`sBUG_ON
(
rc
 !ð
SCST_EXEC_COMPLETED
);

2784 
dÚe
:

2785 
couÁ
++;

2787 
cmd
 = 
	`sc¡_po¡_exec_¢
(cmd, 
çl£
);

2788 ià(
cmd
 =ð
NULL
)

2791 
cmd
->
¡©e
 = 
SCST_CMD_STATE_START_EXEC
;

2793 ià(
	`uÆik–y
(
	`sc¡_check_blocked_dev
(
cmd
)))

2796 
	`__sc¡_cmd_put
(
»f_cmd
);

2797 
»f_cmd
 = 
cmd
;

2798 
	`__sc¡_cmd_g‘
(
»f_cmd
);

2802 *
aùive_cmd
 = 
cmd
;

2804 ià(
couÁ
 == 0)

2805 
out_put
;

2807 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 39)

2808 ià(
»f_cmd
->
dev
->
scsi_dev
 !ð
NULL
)

2809 
	`g’”ic_uÅlug_deviû
(
»f_cmd
->
dev
->
scsi_dev
->
»que¡_queue
);

2812 
out_put
:

2813 
	`__sc¡_cmd_put
(
»f_cmd
);

2816 
out
:

2817 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

2818 
	`TRACE_EXIT_RES
(
»s
);

2819  
»s
;

2820 
	}
}

2822 
	$sc¡_£nd_fÜ_exec
(
sc¡_cmd
 **
aùive_cmd
)

2824 
»s
;

2825 
sc¡_cmd
 *
cmd
 = *
aùive_cmd
;

2826 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
cmd
->
cur_Üd”_d©a
;

2827 
	`ty³of
(
Üd”_d©a
->
ex³ùed_¢
)ƒxpected_sn;

2829 
	`TRACE_ENTRY
();

2831 ià(
	`uÆik–y
(
cmd
->
š‹º®
))

2832 
exec
;

2834 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

2835 
exec
;

2837 
	`sBUG_ON
(!
cmd
->
¢_£t
);

2839 
ex³ùed_¢
 = 
Üd”_d©a
->expected_sn;

2841 ià((
cmd
->
¢
 !ð
ex³ùed_¢
è|| (
Üd”_d©a
->
hq_cmd_couÁ
 > 0)) {

2842 
	`¥š_lock_œq
(&
Üd”_d©a
->
¢_lock
);

2844 
Üd”_d©a
->
def_cmd_couÁ
++;

2856 
	`smp_mb
();

2858 
ex³ùed_¢
 = 
Üd”_d©a
->expected_sn;

2859 ià((
cmd
->
¢
 !ð
ex³ùed_¢
è|| (
Üd”_d©a
->
hq_cmd_couÁ
 > 0)) {

2860 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
,

2861 &
cmd
->
cmd_æags
))) {

2863 
	`TRACE_MGMT_DBG
("Aborting out of sn cmd %p "

2864 "Ñag %Îu, sÀ%u)", 
cmd
,

2865 ()
cmd
->
g
, cmd->
¢
);

2866 
Üd”_d©a
->
def_cmd_couÁ
--;

2867 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

2868 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

2870 
	`TRACE_SN
("Deferring cmd %p (sn=%d, set %d, "

2871 "ex³ùed_¢=%d)", 
cmd
, cmd->
¢
,

2872 
cmd
->
¢_£t
, 
ex³ùed_¢
);

2873 
	`li¡_add_ž
(&
cmd
->
¢_cmd_li¡_’Œy
,

2874 &
Üd”_d©a
->
deã¼ed_cmd_li¡
);

2875 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

2877 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

2878 
out
;

2880 
	`TRACE_SN
("Somebody incrementedƒxpected_sn %d, "

2881 "cÚtšušg", 
ex³ùed_¢
);

2882 
Üd”_d©a
->
def_cmd_couÁ
--;

2883 
	`¥š_uÆock_œq
(&
Üd”_d©a
->
¢_lock
);

2887 
exec
:

2888 
»s
 = 
	`sc¡_exec
(
aùive_cmd
);

2890 
out
:

2891 
	`TRACE_EXIT_HRES
(
»s
);

2892  
»s
;

2893 
	}
}

2896 
	$sc¡_check_£n£
(
sc¡_cmd
 *
cmd
)

2898 
»s
 = 0;

2899 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

2901 
	`TRACE_ENTRY
();

2903 ià(
	`uÆik–y
(
cmd
->
ua_ignÜe
))

2904 
out
;

2907 ià((
dev
->
scsi_dev
 !ð
NULL
) &&

2908 
	`uÆik–y
(
cmd
->
ho¡_¡©us
 =ð
DID_RESET
) &&

2909 
	`sc¡_is_ua_commªd
(
cmd
)) {

2910 
	`TRACE
(
TRACE_MGMT
, "DID_RESET: was_reset=%d host_status=%x",

2911 
dev
->
scsi_dev
->
was_»£t
, 
cmd
->
ho¡_¡©us
);

2912 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_»£t_UA
));

2914 
dev
->
scsi_dev
->
was_»£t
 = 0;

2917 ià(
	`uÆik–y
(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

2918 
	`SCST_SENSE_VALID
(
cmd
->
£n£
)) {

2919 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "S’£", 
cmd
->
£n£
,

2920 
cmd
->
£n£_v®id_Ën
);

2923 ià(
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
)) {

2924 ià(
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

2925 
SCST_SENSE_ASC_VALID
,

2926 0, 
SCST_SENSE_ASC_UA_RESET
, 0)) {

2927 ià(
cmd
->
doubË_ua_possibË
) {

2928 
	`TRACE_MGMT_DBG
("Double UA "

2929 "d‘eùed fÜ deviû %p", 
dev
);

2930 
	`TRACE_MGMT_DBG
("Retrying cmd"

2931 " %°Ñag %Îu)", 
cmd
,

2932 ()
cmd
->
g
);

2934 
cmd
->
¡©us
 = 0;

2935 
cmd
->
msg_¡©us
 = 0;

2936 
cmd
->
ho¡_¡©us
 = 
DID_OK
;

2937 
cmd
->
driv”_¡©us
 = 0;

2938 
cmd
->
com¶‘ed
 = 0;

2940 
	`mempoÞ_ä“
(
cmd
->
£n£
,

2941 
sc¡_£n£_mempoÞ
);

2942 
cmd
->
£n£
 = 
NULL
;

2944 
	`sc¡_check_»¡Üe_sg_buff
(
cmd
);

2946 
	`sBUG_ON
(
cmd
->
dbl_ua_Üig_»¥_d©a_Ën
 < 0);

2947 
cmd
->
d©a_dœeùiÚ
 =

2948 
cmd
->
dbl_ua_Üig_d©a_dœeùiÚ
;

2949 
cmd
->
»¥_d©a_Ën
 =

2950 
cmd
->
dbl_ua_Üig_»¥_d©a_Ën
;

2952 
cmd
->
¡©e
 = 
SCST_CMD_STATE_REAL_EXEC
;

2953 
cmd
->
»Œy
 = 1;

2954 
	`sc¡_»£t_»queued_cmd
(
cmd
);

2955 
»s
 = 1;

2956 
out
;

2959 
	`sc¡_dev_check_£t_UA
(
dev
, 
cmd
, cmd->
£n£
,

2960 
cmd
->
£n£_v®id_Ën
);

2964 ià(
	`uÆik–y
(
cmd
->
doubË_ua_possibË
)) {

2965 ià(
	`sc¡_is_ua_commªd
(
cmd
)) {

2966 
	`TRACE_MGMT_DBG
("Clearing dbl_ua_possible flag (dev %p, "

2967 "cmd %p)", 
dev
, 
cmd
);

2974 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

2975 
dev
->
dev_doubË_ua_possibË
 = 0;

2976 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

2980 
out
:

2981 
	`TRACE_EXIT_RES
(
»s
);

2982  
»s
;

2983 
	}
}

2985 
	$sc¡_check_auto_£n£
(
sc¡_cmd
 *
cmd
)

2987 
»s
 = 0;

2989 
	`TRACE_ENTRY
();

2991 ià(
	`uÆik–y
(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

2992 (!
	`SCST_SENSE_VALID
(
cmd
->
£n£
) ||

2993 
	`SCST_NO_SENSE
(
cmd
->
£n£
))) {

2994 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR_AND_MGMT_DBG
, "CHECK_CONDITION, "

2997 
cmd
->
¡©us
, cmd->
msg_¡©us
, cmd->
ho¡_¡©us
,

2998 
cmd
->
driv”_¡©us
, cmd);

2999 
»s
 = 1;

3000 } ià(
	`uÆik–y
(
cmd
->
ho¡_¡©us
)) {

3001 ià((
cmd
->
ho¡_¡©us
 =ð
DID_REQUEUE
) ||

3002 (
cmd
->
ho¡_¡©us
 =ð
DID_IMM_RETRY
) ||

3003 (
cmd
->
ho¡_¡©us
 =ð
DID_SOFT_ERROR
) ||

3004 (
cmd
->
ho¡_¡©us
 =ð
DID_ABORT
)) {

3005 
	`sc¡_£t_busy
(
cmd
);

3007 
	`TRACE
(
TRACE_SCSI
|
TRACE_MINOR_AND_MGMT_DBG
, "Host "

3009 "š¡—d (cmd %p)", 
cmd
->
ho¡_¡©us
, cmd);

3010 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3011 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3015 
	`TRACE_EXIT_RES
(
»s
);

3016  
»s
;

3017 
	}
}

3019 
	$sc¡_´e_dev_dÚe
(
sc¡_cmd
 *
cmd
)

3021 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
, 
rc
;

3023 
	`TRACE_ENTRY
();

3025 ià(
	`uÆik–y
(
	`sc¡_check_auto_£n£
(
cmd
))) {

3026 
	`PRINT_INFO
("Command finished with CHECK CONDITION, but "

3028 "REQUEST SENSE", 
cmd
->
cdb
[0]);

3029 
rc
 = 
	`sc¡_´•¬e_»que¡_£n£
(
cmd
);

3030 ià(
rc
 == 0)

3031 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

3033 
	`PRINT_ERROR
("%s", "Unableo issue REQUEST SENSE, "

3035 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3036 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3038 
out
;

3039 } ià(
	`uÆik–y
(
	`sc¡_check_£n£
(
cmd
))) {

3044 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

3045 
out
;

3048 ià(
	`lik–y
(
	`scsi_¡©us_is_good
(
cmd
->
¡©us
))) {

3049 
ty³
 = 
cmd
->
dev
->type;

3050 ià(
	`uÆik–y
((
cmd
->
cdb
[0] =ð
MODE_SENSE
 ||

3051 
cmd
->
cdb
[0] =ð
MODE_SENSE_10
)) &&

3052 (
cmd
->
tgt_dev
->
acg_dev
->
rd_Úly
 || cmd->
dev
->
swp
 ||

3053 
cmd
->
dev
->
rd_Úly
) &&

3054 (
ty³
 =ð
TYPE_DISK
 ||

3055 
ty³
 =ð
TYPE_WORM
 ||

3056 
ty³
 =ð
TYPE_MOD
 ||

3057 
ty³
 =ð
TYPE_TAPE
)) {

3058 
št32_t
 
Ëngth
;

3059 
ušt8_t
 *
add»ss
;

3060 
boÞ
 
”r
 = 
çl£
;

3062 
Ëngth
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
add»ss
);

3063 ià(
Ëngth
 < 0) {

3064 
	`PRINT_ERROR
("%s", "Unableo get "

3066 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3067 
	`SCST_LOAD_SENSE
(

3068 
sc¡_£n£_h¬dw_”rÜ
));

3069 
”r
 = 
Œue
;

3070 } ià(
Ëngth
 > 2 && 
cmd
->
cdb
[0] =ð
MODE_SENSE
)

3071 
add»ss
[2] |= 0x80;

3072 ià(
Ëngth
 > 3 && 
cmd
->
cdb
[0] =ð
MODE_SENSE_10
)

3073 
add»ss
[3] |= 0x80;

3074 
	`sc¡_put_buf_fuÎ
(
cmd
, 
add»ss
);

3076 ià(
”r
)

3077 
out
;

3084 ià(
	`uÆik–y
((
cmd
->
cdb
[0] =ð
INQUIRY
)) &&

3086 !(
cmd
->
cdb
[1] & 
SCST_INQ_EVPD
) &&

3087 (
cmd
->
»¥_d©a_Ën
 > 
SCST_INQ_BYTE3
)) {

3088 
ušt8_t
 *
bufãr
;

3089 
buæ’
;

3090 
boÞ
 
”r
 = 
çl£
;

3092 
buæ’
 = 
	`sc¡_g‘_buf_fuÎ
(
cmd
, &
bufãr
);

3093 ià(
buæ’
 > 
SCST_INQ_BYTE3
 && !
cmd
->
tg‰
->
çke_aÿ
) {

3094 #ifdeà
CONFIG_SCST_EXTRACHECKS


3095 ià(
bufãr
[
SCST_INQ_BYTE3
] & 
SCST_INQ_NORMACA_BIT
) {

3096 
	`PRINT_INFO
("NormACA set for device: "

3099 ()
cmd
->
lun
,

3100 
bufãr
[0]);

3103 
bufãr
[
SCST_INQ_BYTE3
] &ð~
SCST_INQ_NORMACA_BIT
;

3104 } ià(
buæ’
 <ð
SCST_INQ_BYTE3
 && buflen != 0) {

3105 
	`PRINT_ERROR
("%s", "Unableo get INQUIRY "

3107 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3108 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3109 
”r
 = 
Œue
;

3111 ià(
buæ’
 > 0)

3112 
	`sc¡_put_buf_fuÎ
(
cmd
, 
bufãr
);

3114 ià(
”r
)

3115 
out
;

3118 ià(
	`uÆik–y
((
cmd
->
cdb
[0] =ð
MODE_SELECT
) ||

3119 (
cmd
->
cdb
[0] =ð
MODE_SELECT_10
) ||

3120 (
cmd
->
cdb
[0] =ð
LOG_SELECT
))) {

3121 
	`TRACE
(
TRACE_SCSI
,

3123 ()
cmd
->
lun
);

3124 
cmd
->
¡©e
 = 
SCST_CMD_STATE_MODE_SELECT_CHECKS
;

3125 
out
;

3128 
	`TRACE
(
TRACE_SCSI
, "cmd %p‚ot succeeded with status %x",

3129 
cmd
, cmd->
¡©us
);

3131 ià((
cmd
->
cdb
[0] =ð
RESERVE
è|| (cmd->cdb[0] =ð
RESERVE_10
)) {

3132 ià(!
	`‹¡_b™
(
SCST_TGT_DEV_RESERVED
,

3133 &
cmd
->
tgt_dev
->
tgt_dev_æags
)) {

3134 
sc¡_tgt_dev
 *
tgt_dev_tmp
;

3135 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

3137 
	`TRACE
(
TRACE_SCSI
, "RESERVE failed†un=%lld, "

3139 ()
cmd
->
lun
,

3140 
cmd
->
¡©us
);

3141 
	`PRINT_BUFF_FLAG
(
TRACE_SCSI
, "S’£", 
cmd
->
£n£
,

3142 
cmd
->
£n£_v®id_Ën
);

3145 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

3146 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev_tmp
,

3147 &
dev
->
dev_tgt_dev_li¡
,

3148 
dev_tgt_dev_li¡_’Œy
) {

3149 
	`þ—r_b™
(
SCST_TGT_DEV_RESERVED
,

3150 &
tgt_dev_tmp
->
tgt_dev_æags
);

3152 
dev
->
dev_»£rved
 = 0;

3153 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

3158 ià((
cmd
->
dev
->
scsi_dev
 !ð
NULL
) &&

3159 (
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

3160 
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
) &&

3161 
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

3162 
SCST_SENSE_ASCx_VALID
,

3164 
	`TRACE
(
TRACE_SCSI
, "MODE PARAMETERS CHANGED UA (lun "

3165 "%Îd)", ()
cmd
->
lun
);

3166 
cmd
->
¡©e
 = 
SCST_CMD_STATE_MODE_SELECT_CHECKS
;

3167 
out
;

3171 
cmd
->
¡©e
 = 
SCST_CMD_STATE_DEV_DONE
;

3173 
out
:

3174 
	`TRACE_EXIT_RES
(
»s
);

3175  
»s
;

3176 
	}
}

3178 
	$sc¡_mode_£Ëù_checks
(
sc¡_cmd
 *
cmd
)

3180 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

3182 
	`TRACE_ENTRY
();

3184 ià(
	`lik–y
(
	`scsi_¡©us_is_good
(
cmd
->
¡©us
))) {

3185 
©omic
 = 
	`sc¡_cmd_©omic
(
cmd
);

3186 ià(
	`uÆik–y
((
cmd
->
cdb
[0] =ð
MODE_SELECT
) ||

3187 (
cmd
->
cdb
[0] =ð
MODE_SELECT_10
) ||

3188 (
cmd
->
cdb
[0] =ð
LOG_SELECT
))) {

3189 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

3190 
¦
;

3191 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

3193 ià(
©omic
 && (
dev
->
scsi_dev
 !ð
NULL
)) {

3194 
	`TRACE_DBG
("%s", "MODE/LOG SELECT:hread "

3196 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

3197 
out
;

3200 
	`TRACE
(
TRACE_SCSI
, "MODE/LOG SELECT succeeded, "

3202 ()
cmd
->
lun
);

3204 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

3205 ià(
cmd
->
cdb
[0] =ð
LOG_SELECT
) {

3206 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
,

3207 (
£n£_bufãr
),

3208 
dev
->
d_£n£
,

3209 
UNIT_ATTENTION
, 0x2a, 0x02);

3211 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
,

3212 (
£n£_bufãr
),

3213 
dev
->
d_£n£
,

3214 
UNIT_ATTENTION
, 0x2a, 0x01);

3216 
	`sc¡_dev_check_£t_loÿl_UA
(
dev
, 
cmd
, 
£n£_bufãr
, 
¦
);

3217 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

3219 ià(
dev
->
scsi_dev
 !ð
NULL
)

3220 
	`sc¡_obš_deviû_·¿m‘”s
(
dev
);

3222 } ià((
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
) &&

3223 
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
) &&

3225 (
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

3226 
SCST_SENSE_ASCx_VALID
,

3228 
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

3229 
SCST_SENSE_ASC_VALID
,

3231 
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

3232 
SCST_SENSE_ASC_VALID
,

3235 
	`sc¡_ª®yze_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
,

3236 
SCST_SENSE_ASC_VALID
,

3238 
©omic
 = 
	`sc¡_cmd_©omic
(
cmd
);

3239 ià(
©omic
) {

3240 
	`TRACE_DBG
("Possible…arameters changed UA %x: "

3241 "th»ad cÚ‹xˆ»quœed", 
cmd
->
£n£
[12]);

3242 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

3243 
out
;

3246 
	`TRACE
(
TRACE_SCSI
, "Possible…arameters changed UA %x "

3247 "(LUN %Îd): g‘tšg‚ew…¬am‘”s", 
cmd
->
£n£
[12],

3248 ()
cmd
->
lun
);

3250 
	`sc¡_obš_deviû_·¿m‘”s
(
cmd
->
dev
);

3252 
	`sBUG
();

3254 
cmd
->
¡©e
 = 
SCST_CMD_STATE_DEV_DONE
;

3256 
out
:

3257 
	`TRACE_EXIT_HRES
(
»s
);

3258  
»s
;

3259 
	}
}

3261 
	$sc¡_šc_check_ex³ùed_¢
(
sc¡_cmd
 *
cmd
)

3263 ià(
	`lik–y
(
cmd
->
¢_£t
))

3264 
	`sc¡_šc_ex³ùed_¢
(
cmd
->
cur_Üd”_d©a
, cmd->
¢_¦Ù
);

3266 
	`sc¡_make_deã¼ed_commªds_aùive
(
cmd
->
cur_Üd”_d©a
);

3267 
	}
}

3269 
	$sc¡_dev_dÚe
(
sc¡_cmd
 *
cmd
)

3271 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

3272 
¡©e
;

3273 
sc¡_deviû
 *
dev
 = 
cmd
->dev;

3275 
	`TRACE_ENTRY
();

3277 
¡©e
 = 
SCST_CMD_STATE_PRE_XMIT_RESP
;

3279 ià(
	`lik–y
(!
	`sc¡_is_cmd_fuÎy_loÿl
(
cmd
)) &&

3280 
	`lik–y
(
dev
->
hªdËr
->
dev_dÚe
 !ð
NULL
)) {

3281 
rc
;

3283 ià(
	`uÆik–y
(!
dev
->
hªdËr
->
dev_dÚe_©omic
 &&

3284 
	`sc¡_cmd_©omic
(
cmd
))) {

3289 
	`TRACE_MGMT_DBG
("Dev handler %s dev_done()‚eedshread "

3290 "cÚ‹xt,„eschedulšg", 
dev
->
hªdËr
->
Çme
);

3291 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

3292 
out
;

3295 
	`TRACE_DBG
("Calling dev handler %s dev_done(%p)",

3296 
dev
->
hªdËr
->
Çme
, 
cmd
);

3297 
	`sc¡_£t_cur_¡¬t
(
cmd
);

3298 
rc
 = 
dev
->
hªdËr
->
	`dev_dÚe
(
cmd
);

3299 
	`sc¡_£t_dev_dÚe_time
(
cmd
);

3300 
	`TRACE_DBG
("Dev handler %s dev_done()„eturned %d",

3301 
dev
->
hªdËr
->
Çme
, 
rc
);

3302 ià(
rc
 !ð
SCST_CMD_STATE_DEFAULT
)

3303 
¡©e
 = 
rc
;

3306 
¡©e
) {

3307 #ifdeà
CONFIG_SCST_EXTRACHECKS


3308 
SCST_CMD_STATE_PRE_XMIT_RESP
:

3309 
SCST_CMD_STATE_PARSE
:

3310 
SCST_CMD_STATE_PREPARE_SPACE
:

3311 
SCST_CMD_STATE_RDY_TO_XFER
:

3312 
SCST_CMD_STATE_TGT_PRE_EXEC
:

3313 
SCST_CMD_STATE_SEND_FOR_EXEC
:

3314 
SCST_CMD_STATE_START_EXEC
:

3315 
SCST_CMD_STATE_LOCAL_EXEC
:

3316 
SCST_CMD_STATE_REAL_EXEC
:

3317 
SCST_CMD_STATE_PRE_DEV_DONE
:

3318 
SCST_CMD_STATE_MODE_SELECT_CHECKS
:

3319 
SCST_CMD_STATE_DEV_DONE
:

3320 
SCST_CMD_STATE_XMIT_RESP
:

3321 
SCST_CMD_STATE_FINISHED
:

3322 
SCST_CMD_STATE_FINISHED_INTERNAL
:

3326 
cmd
->
¡©e
 = state;

3328 
SCST_CMD_STATE_NEED_THREAD_CTX
:

3329 
	`TRACE_DBG
("Dev handler %s dev_done()„equested "

3331 
dev
->
hªdËr
->
Çme
);

3332 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

3333 
out
;

3334 #ifdeà
CONFIG_SCST_EXTRACHECKS


3336 ià(
¡©e
 >= 0) {

3337 
	`PRINT_ERROR
("Dev handler %s dev_done()„eturned "

3339 
dev
->
hªdËr
->
Çme
, 
¡©e
);

3341 
	`PRINT_ERROR
("Dev handler %s dev_done()„eturned "

3342 "”rÜ %d", 
dev
->
hªdËr
->
Çme
,

3343 
¡©e
);

3345 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3346 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3347 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

3352 
	`sc¡_check_unblock_dev
(
cmd
);

3354 ià(
cmd
->
šc_ex³ùed_¢_Ú_dÚe
 && cmd->
£Á_fÜ_exec
)

3355 
	`sc¡_šc_check_ex³ùed_¢
(
cmd
);

3357 ià(
	`uÆik–y
(
cmd
->
š‹º®
))

3358 
cmd
->
¡©e
 = 
SCST_CMD_STATE_FINISHED_INTERNAL
;

3360 #iâdeà
CONFIG_SCST_TEST_IO_IN_SIRQ


3361 ià(
cmd
->
¡©e
 !ð
SCST_CMD_STATE_PRE_XMIT_RESP
) {

3363 ià(
	`sc¡_cmd_©omic
(
cmd
)) {

3364 
¡©e
) {

3365 
SCST_CMD_STATE_TGT_PRE_EXEC
:

3366 
SCST_CMD_STATE_SEND_FOR_EXEC
:

3367 
SCST_CMD_STATE_START_EXEC
:

3368 
SCST_CMD_STATE_LOCAL_EXEC
:

3369 
SCST_CMD_STATE_REAL_EXEC
:

3370 
	`TRACE_DBG
("Atomic context‡nd„edirect, "

3371 "»schedulšg (cmd %p)", 
cmd
);

3372 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

3379 
out
:

3380 
	`TRACE_EXIT_HRES
(
»s
);

3381  
»s
;

3382 
	}
}

3384 
	$sc¡_´e_xm™_»¥Ú£
(
sc¡_cmd
 *
cmd
)

3386 
»s
;

3388 
	`TRACE_ENTRY
();

3390 
	`EXTRACHECKS_BUG_ON
(
cmd
->
š‹º®
);

3392 #ifdeà
CONFIG_SCST_DEBUG_TM


3393 ià(
cmd
->
tm_dbg_d–ayed
 &&

3394 !
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

3395 ià(
	`sc¡_cmd_©omic
(
cmd
)) {

3396 
	`TRACE_MGMT_DBG
("%s",

3398 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

3399  
»s
;

3401 
	`TRACE_MGMT_DBG
("Delaying cmd %p (tag %llu) for 1 second",

3402 
cmd
, cmd->
g
);

3403 
	`scheduË_timeout_unš‹¼u±ibË
(
HZ
);

3407 ià(
	`lik–y
(
cmd
->
tgt_dev
 !ð
NULL
)) {

3412 
	`©omic_dec
(&
cmd
->
tgt_dev
->
tgt_dev_cmd_couÁ
);

3413 #ifdeà
CONFIG_SCST_PER_DEVICE_CMD_COUNT_LIMIT


3414 
	`©omic_dec
(&
cmd
->
dev
->
dev_cmd_couÁ
);

3416 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

3417 
	`sc¡_Ú_hq_cmd_»¥Ú£
(
cmd
);

3419 ià(
	`uÆik–y
(!
cmd
->
£Á_fÜ_exec
)) {

3420 
	`TRACE_SN
("cmd %p was‚ot sento mid-lev"

3422 
cmd
, cmd->
¢
, cmd->
¢_£t
);

3423 
	`sc¡_unblock_deã¼ed
(
cmd
->
cur_Üd”_d©a
, cmd);

3424 
cmd
->
£Á_fÜ_exec
 = 1;

3428 
cmd
->
dÚe
 = 1;

3429 
	`smp_mb
();

3431 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)))

3432 
	`sc¡_xm™_´oûss_abÜ‹d_cmd
(
cmd
);

3433 ià(
	`uÆik–y
(
cmd
->
¡©us
 =ð
SAM_STAT_CHECK_CONDITION
))

3434 
	`sc¡_¡Üe_£n£
(
cmd
);

3436 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_NO_RESP
, &
cmd
->
cmd_æags
))) {

3437 
	`TRACE_MGMT_DBG
("Flag NO_RESP set for cmd %p (tag %llu), "

3438 "skpšg", 
cmd
, ()cmd->
g
);

3439 
cmd
->
¡©e
 = 
SCST_CMD_STATE_FINISHED
;

3440 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

3441 
out
;

3444 ià(
	`uÆik–y
(
cmd
->
»sid_possibË
))

3445 
	`sc¡_adju¡_»¥_d©a_Ën
(
cmd
);

3447 
cmd
->
adju¡ed_»¥_d©a_Ën
 = cmd->
»¥_d©a_Ën
;

3449 
cmd
->
¡©e
 = 
SCST_CMD_STATE_XMIT_RESP
;

3450 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

3452 
out
:

3453 
	`TRACE_EXIT_HRES
(
»s
);

3454  
»s
;

3455 
	}
}

3457 
	$sc¡_xm™_»¥Ú£
(
sc¡_cmd
 *
cmd
)

3459 
sc¡_tgt_‹m¶©e
 *
tg‰
 = 
cmd
->tgtt;

3460 
»s
, 
rc
;

3462 
	`TRACE_ENTRY
();

3464 
	`EXTRACHECKS_BUG_ON
(
cmd
->
š‹º®
);

3466 ià(
	`uÆik–y
(!
tg‰
->
xm™_»¥Ú£_©omic
 &&

3467 
	`sc¡_cmd_©omic
(
cmd
))) {

3472 
	`TRACE_MGMT_DBG
("Target driver %s xmit_response()‚eedshread "

3473 "cÚ‹xt,„eschedulšg", 
tg‰
->
Çme
);

3474 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

3475 
out
;

3479 
fšished_cmds
 = 
	`©omic_»ad
(&
cmd
->
tgt
->finished_cmds);

3481 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

3482 
cmd
->
¡©e
 = 
SCST_CMD_STATE_XMIT_WAIT
;

3484 
	`TRACE_DBG
("C®lšg xm™_»¥Ú£(%p)", 
cmd
);

3486 #ià
	`defšed
(
CONFIG_SCST_DEBUG
è|| defšed(
CONFIG_SCST_TRACING
)

3487 ià(
Œaû_æag
 & 
TRACE_SND_BOT
) {

3488 
i
, 
j
;

3489 
sÿ‰”li¡
 *
sg
;

3490 ià(
cmd
->
tgt_sg
 !ð
NULL
)

3491 
sg
 = 
cmd
->
tgt_sg
;

3493 
sg
 = 
cmd
->sg;

3494 ià(
sg
 !ð
NULL
) {

3495 
	`TRACE
(
TRACE_SND_BOT
, "Xmitting data for cmd %p "

3497 "»¥†’ %d)", 
cmd
, cmd->
tgt_sg_út
,

3498 
sg
, (*)
	`sg_·ge
(&sg[0]), 
	`sg_vœt
(sg),

3499 
cmd
->
»¥_d©a_Ën
);

3500 
i
 = 0, 
j
 = 0; i < 
cmd
->
tgt_sg_út
; ++i, ++j) {

3501 ià(
	`uÆik–y
(
	`sg_is_chaš
(&
sg
[
j
]))) {

3502 
sg
 = 
	`sg_chaš_±r
(&sg[
j
]);

3503 
j
 = 0;

3505 
	`TRACE
(
TRACE_SND_BOT
, "sg %d", 
j
);

3506 
	`PRINT_BUFF_FLAG
(
TRACE_SND_BOT
,

3507 "Xm™tšg sg", 
	`sg_vœt
(&
sg
[
j
]),

3508 
sg
[
j
].
Ëngth
);

3514 ià(
tg‰
->
Ú_hw_³ndšg_cmd_timeout
 !ð
NULL
) {

3515 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

3516 
cmd
->
hw_³ndšg_¡¬t
 = 
jiff›s
;

3517 
cmd
->
cmd_hw_³ndšg
 = 1;

3518 ià(!
	`‹¡_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
, &
£ss
->
£ss_aæags
)) {

3519 
	`TRACE_DBG
("Sched HW…ending work for sess %p "

3520 "(maxim%d)", 
£ss
,

3521 
tg‰
->
max_hw_³ndšg_time
);

3522 
	`£t_b™
(
SCST_SESS_HW_PENDING_WORK_SCHEDULED
,

3523 &
£ss
->
£ss_aæags
);

3524 
	`scheduË_d–ayed_wÜk
(&
£ss
->
hw_³ndšg_wÜk
,

3525 
tg‰
->
max_hw_³ndšg_time
 * 
HZ
);

3529 
	`sc¡_£t_cur_¡¬t
(
cmd
);

3531 #ifdeà
CONFIG_SCST_DEBUG_RETRY


3532 ià(((
	`sc¡_¿ndom
() % 100) == 77))

3533 
rc
 = 
SCST_TGT_RES_QUEUE_FULL
;

3536 
rc
 = 
tg‰
->
	`xm™_»¥Ú£
(
cmd
);

3537 
	`TRACE_DBG
("xm™_»¥Ú£(è»tuºed %d", 
rc
);

3539 ià(
	`lik–y
(
rc
 =ð
SCST_TGT_RES_SUCCESS
))

3540 
out
;

3542 
	`sc¡_£t_xm™_time
(
cmd
);

3544 
cmd
->
cmd_hw_³ndšg
 = 0;

3547 
cmd
->
¡©e
 = 
SCST_CMD_STATE_XMIT_RESP
;

3549 
rc
) {

3550 
SCST_TGT_RES_QUEUE_FULL
:

3551 ià(
	`sc¡_queue_»Œy_cmd
(
cmd
, 
fšished_cmds
) == 0)

3556 
SCST_TGT_RES_NEED_THREAD_CTX
:

3557 
	`TRACE_DBG
("Target driver %s xmit_response() "

3559 
tg‰
->
Çme
);

3560 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

3561 
out
;

3564 
out_”rÜ
;

3569 
out
:

3571 
	`TRACE_EXIT_HRES
(
»s
);

3572  
»s
;

3574 
out_”rÜ
:

3575 ià(
rc
 =ð
SCST_TGT_RES_FATAL_ERROR
) {

3576 
	`PRINT_ERROR
("Target driver %s xmit_response()„eturned "

3577 "çÈ”rÜ", 
tg‰
->
Çme
);

3579 
	`PRINT_ERROR
("Target driver %s xmit_response()„eturned "

3580 "šv®id v®u%d", 
tg‰
->
Çme
, 
rc
);

3582 
	`sc¡_£t_cmd_”rÜ
(
cmd
, 
	`SCST_LOAD_SENSE
(
sc¡_£n£_h¬dw_”rÜ
));

3583 
cmd
->
¡©e
 = 
SCST_CMD_STATE_FINISHED
;

3584 
»s
 = 
SCST_CMD_STATE_RES_CONT_SAME
;

3585 
out
;

3586 
	}
}

3600 
	$sc¡_tgt_cmd_dÚe
(
sc¡_cmd
 *
cmd
,

3601 
sc¡_exec_cÚ‹xt
 
´ef_cÚ‹xt
)

3603 
	`TRACE_ENTRY
();

3605 
	`sBUG_ON
(
cmd
->
¡©e
 !ð
SCST_CMD_STATE_XMIT_WAIT
);

3607 
	`sc¡_£t_xm™_time
(
cmd
);

3609 
cmd
->
cmd_hw_³ndšg
 = 0;

3611 ià(
	`uÆik–y
(
cmd
->
tgt_dev
 =ð
NULL
))

3612 
´ef_cÚ‹xt
 = 
SCST_CONTEXT_THREAD
;

3614 
cmd
->
¡©e
 = 
SCST_CMD_STATE_FINISHED
;

3616 
	`sc¡_´oûss_»dœeù_cmd
(
cmd
, 
´ef_cÚ‹xt
, 1);

3618 
	`TRACE_EXIT
();

3620 
	}
}

3621 
EXPORT_SYMBOL
(
sc¡_tgt_cmd_dÚe
);

3623 
	$sc¡_fšish_cmd
(
sc¡_cmd
 *
cmd
)

3625 
»s
;

3626 
sc¡_£ssiÚ
 *
£ss
 = 
cmd
->sess;

3627 
sc¡_io_¡©_’Œy
 *
¡©
;

3629 
	`TRACE_ENTRY
();

3631 
	`sc¡_upd©e_Ït_¡©s
(
cmd
);

3633 ià(
	`uÆik–y
(
cmd
->
d–iv”y_¡©us
 !ð
SCST_CMD_DELIVERY_SUCCESS
)) {

3634 ià((
cmd
->
tgt_dev
 !ð
NULL
) &&

3635 
	`sc¡_is_ua_£n£
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
)) {

3637 ià(
	`sc¡_cmd_©omic
(
cmd
) &&

3638 
	`sc¡_is_ua_glob®
(
cmd
->
£n£
, cmd->
£n£_v®id_Ën
)) {

3639 
	`TRACE_MGMT_DBG
("Requeuing of global UA for "

3640 "çžed cmd %°Ãed ¨th»ad", 
cmd
);

3641 
»s
 = 
SCST_CMD_STATE_RES_NEED_THREAD
;

3642 
out
;

3644 
	`sc¡_»queue_ua
(
cmd
);

3648 
	`©omic_dec
(&
£ss
->
£ss_cmd_couÁ
);

3650 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

3652 
¡©
 = &
£ss
->
io_¡©s
[
cmd
->
d©a_dœeùiÚ
];

3653 
¡©
->
cmd_couÁ
++;

3654 
¡©
->
io_by‹_couÁ
 +ð
cmd
->
bufæ’
 + cmd->
out_bufæ’
;

3656 
	`li¡_d–
(&
cmd
->
£ss_cmd_li¡_’Œy
);

3662 
cmd
->
fšished
 = 1;

3664 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

3666 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))) {

3667 
	`TRACE_MGMT_DBG
("Aborted cmd %p finished (cmd_ref %d)",

3668 
cmd
, 
	`©omic_»ad
(&cmd->
cmd_»f
));

3670 
	`sc¡_fšish_cmd_mgmt
(
cmd
);

3673 
	`__sc¡_cmd_put
(
cmd
);

3675 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

3677 
out
:

3678 
	`TRACE_EXIT_HRES
(
»s
);

3679  
»s
;

3680 
	}
}

3686 
	$sc¡_cmd_£t_¢
(
sc¡_cmd
 *
cmd
)

3688 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
cmd
->
cur_Üd”_d©a
;

3689 
æags
;

3691 
	`TRACE_ENTRY
();

3693 ià(
	`sc¡_is_im¶ic™_hq_cmd
(
cmd
) &&

3694 
	`lik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_SIMPLE
)) {

3695 
	`TRACE_SN
("Im¶ic™ HQ cmd %p", 
cmd
);

3696 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
;

3699 
	`EXTRACHECKS_BUG_ON
(
cmd
->
¢_£t
 || cmd->
hq_cmd_šûd
);

3703 
	`sc¡_check_debug_¢
(
cmd
);

3705 #ifdeà
CONFIG_SCST_STRICT_SERIALIZING


3706 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_ORDERED
;

3709 ià(
cmd
->
dev
->
queue_®g
 =ð
SCST_CONTR_MODE_QUEUE_ALG_RESTRICTED_REORDER
) {

3715 
cmd
->
queue_ty³
 = 
SCST_CMD_QUEUE_ORDERED
;

3718 
cmd
->
queue_ty³
) {

3719 
SCST_CMD_QUEUE_SIMPLE
:

3720 
SCST_CMD_QUEUE_UNTAGGED
:

3721 ià(
	`lik–y
(
Üd”_d©a
->
num_ä“_¢_¦Ùs
 >= 0)) {

3726 ià(
	`©omic_šc_»tuº
(
Üd”_d©a
->
cur_¢_¦Ù
) == 1) {

3727 
Üd”_d©a
->
cu¼_¢
++;

3728 
	`TRACE_SN
("Incremented curr_sn %d",

3729 
Üd”_d©a
->
cu¼_¢
);

3731 
cmd
->
¢_¦Ù
 = 
Üd”_d©a
->
cur_¢_¦Ù
;

3732 
cmd
->
¢
 = 
Üd”_d©a
->
cu¼_¢
;

3734 
Üd”_d©a
->
´ev_cmd_Üd”ed
 = 0;

3736 
	`TRACE
(
TRACE_MINOR
, "***WARNING*** Notƒnough SN slots "

3737 "%zd", 
	`ARRAY_SIZE
(
Üd”_d©a
->
¢_¦Ùs
));

3738 
Üd”ed
;

3742 
SCST_CMD_QUEUE_ORDERED
:

3743 
	`TRACE_SN
("ORDERED cmd %°(Ý %x)", 
cmd
, cmd->
cdb
[0]);

3744 
Üd”ed
:

3745 ià(!
Üd”_d©a
->
´ev_cmd_Üd”ed
) {

3746 
	`¥š_lock_œq§ve
(&
Üd”_d©a
->
¢_lock
, 
æags
);

3747 ià(
Üd”_d©a
->
num_ä“_¢_¦Ùs
 >= 0) {

3748 
Üd”_d©a
->
num_ä“_¢_¦Ùs
--;

3749 ià(
Üd”_d©a
->
num_ä“_¢_¦Ùs
 >= 0) {

3750 
i
 = 0;

3755 
Üd”_d©a
->
cur_¢_¦Ù
++;

3756 ià(
Üd”_d©a
->
cur_¢_¦Ù
 ==

3757 
Üd”_d©a
->
¢_¦Ùs
 + 
	`ARRAY_SIZE
(order_data->sn_slots))

3758 
Üd”_d©a
->
cur_¢_¦Ù
 = ord”_d©a->
¢_¦Ùs
;

3760 ià(
	`©omic_»ad
(
Üd”_d©a
->
cur_¢_¦Ù
) == 0)

3763 
i
++;

3764 
	`sBUG_ON
(
i
 =ð
	`ARRAY_SIZE
(
Üd”_d©a
->
¢_¦Ùs
));

3766 
	`TRACE_SN
("New cur SN slot %zd",

3767 
Üd”_d©a
->
cur_¢_¦Ù
 -

3768 
Üd”_d©a
->
¢_¦Ùs
);

3771 
	`¥š_uÆock_œq»¡Üe
(&
Üd”_d©a
->
¢_lock
, 
æags
);

3773 
Üd”_d©a
->
´ev_cmd_Üd”ed
 = 1;

3774 
Üd”_d©a
->
cu¼_¢
++;

3775 
cmd
->
¢
 = 
Üd”_d©a
->
cu¼_¢
;

3778 
SCST_CMD_QUEUE_HEAD_OF_QUEUE
:

3779 
	`TRACE_SN
("HQ cmd %°(Ý %x)", 
cmd
, cmd->
cdb
[0]);

3780 
	`¥š_lock_œq§ve
(&
Üd”_d©a
->
¢_lock
, 
æags
);

3781 
Üd”_d©a
->
hq_cmd_couÁ
++;

3782 
	`¥š_uÆock_œq»¡Üe
(&
Üd”_d©a
->
¢_lock
, 
æags
);

3783 
cmd
->
hq_cmd_šûd
 = 1;

3784 
out
;

3787 
	`sBUG
();

3790 
	`TRACE_SN
("cmd(%p)->sn: %d (order_data %p, *cur_sn_slot %d, "

3792 "cur_¢_¦Ù %zd)", 
cmd
, cmd->
¢
, 
Üd”_d©a
,

3793 
	`©omic_»ad
(
Üd”_d©a
->
cur_¢_¦Ù
),

3794 
Üd”_d©a
->
num_ä“_¢_¦Ùs
, ord”_d©a->
´ev_cmd_Üd”ed
,

3795 
Üd”_d©a
->
cur_¢_¦Ù
 - ord”_d©a->
¢_¦Ùs
);

3797 
cmd
->
¢_£t
 = 1;

3799 
out
:

3800 
	`TRACE_EXIT
();

3802 
	}
}

3811 
	$sc¡_Œª¦©e_lun
(
sc¡_cmd
 *
cmd
)

3813 
sc¡_tgt_dev
 *
tgt_dev
 = 
NULL
;

3814 
»s
;

3816 
	`TRACE_ENTRY
();

3818 
cmd
->
ýu_cmd_couÁ”
 = 
	`sc¡_g‘
();

3820 ià(
	`lik–y
(!
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
))) {

3821 
li¡_h—d
 *
h—d
 =

3822 &
cmd
->
£ss
->
£ss_tgt_dev_li¡
[
	`SESS_TGT_DEV_LIST_HASH_FN
(cmd->
lun
)];

3823 
	`TRACE_DBG
("Fšdšggt_dev fÜ cmd %°ÖuÀ%Îd)", 
cmd
,

3824 ()
cmd
->
lun
);

3825 
»s
 = -1;

3826 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

3827 ià(
tgt_dev
->
lun
 =ð
cmd
->lun) {

3828 
	`TRACE_DBG
("tgt_dev %°found", 
tgt_dev
);

3830 ià(
	`uÆik–y
(
tgt_dev
->
dev
->
hªdËr
 ==

3831 &
sc¡_nuÎ_devty³
)) {

3832 
	`PRINT_INFO
("Dev handler for device "

3835 ()
cmd
->
lun
);

3839 
cmd
->
cmd_th»ads
 = 
tgt_dev
->
aùive_cmd_th»ads
;

3840 
cmd
->
tgt_dev
 =gt_dev;

3841 
cmd
->
cur_Üd”_d©a
 = 
tgt_dev
->
cu¼_Üd”_d©a
;

3842 
cmd
->
dev
 = 
tgt_dev
->dev;

3844 
»s
 = 0;

3848 ià(
»s
 != 0) {

3849 
	`TRACE
(
TRACE_MINOR
,

3852 ()
cmd
->
lun
,

3853 
cmd
->
£ss
->
š™ŸtÜ_Çme
, cmd->
tgt
->
tgt_Çme
);

3854 
	`sc¡_put
(
cmd
->
ýu_cmd_couÁ”
);

3857 
	`TRACE_MGMT_DBG
("%s", "FLAG SUSPENDED set, skipping");

3858 
	`sc¡_put
(
cmd
->
ýu_cmd_couÁ”
);

3859 
»s
 = 1;

3862 
	`TRACE_EXIT_RES
(
»s
);

3863  
»s
;

3864 
	}
}

3872 
	$__sc¡_š™_cmd
(
sc¡_cmd
 *
cmd
)

3874 
»s
 = 0;

3876 
	`TRACE_ENTRY
();

3878 
»s
 = 
	`sc¡_Œª¦©e_lun
(
cmd
);

3879 ià(
	`lik–y
(
»s
 == 0)) {

3880 
út
;

3881 
boÞ
 
çžu»
 = 
çl£
;

3883 
cmd
->
¡©e
 = 
SCST_CMD_STATE_PARSE
;

3885 
út
 = 
	`©omic_šc_»tuº
(&
cmd
->
tgt_dev
->
tgt_dev_cmd_couÁ
);

3886 ià(
	`uÆik–y
(
út
 > 
SCST_MAX_TGT_DEV_COMMANDS
)) {

3887 
	`TRACE
(
TRACE_FLOW_CONTROL
,

3890 
út
, (
cmd
->
£ss
->
š™ŸtÜ_Çme
[0] == '\0') ?

3891 "AnÚymous" : 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

3892 
çžu»
 = 
Œue
;

3895 #ifdeà
CONFIG_SCST_PER_DEVICE_CMD_COUNT_LIMIT


3896 
út
 = 
	`©omic_šc_»tuº
(&
cmd
->
dev
->
dev_cmd_couÁ
);

3897 ià(
	`uÆik–y
(
út
 > 
SCST_MAX_DEV_COMMANDS
)) {

3898 ià(!
çžu»
) {

3899 
	`TRACE
(
TRACE_FLOW_CONTROL
,

3902 "š™ŸtÜ \"%s\"", 
út
,

3903 (
cmd
->
£ss
->
š™ŸtÜ_Çme
[0] == '\0') ?

3905 
cmd
->
£ss
->
š™ŸtÜ_Çme
);

3906 
çžu»
 = 
Œue
;

3911 ià(
	`uÆik–y
(
çžu»
))

3912 
out_busy
;

3922 
	`sc¡_´e_·r£
(
cmd
);

3924 ià(!
cmd
->
£t_¢_Ú_»¡¬t_cmd
)

3925 
	`sc¡_cmd_£t_¢
(
cmd
);

3926 } ià(
»s
 < 0) {

3927 
	`TRACE_DBG
("Fšishšg cmd %p", 
cmd
);

3928 
	`sc¡_£t_cmd_”rÜ
(
cmd
,

3929 
	`SCST_LOAD_SENSE
(
sc¡_£n£_lun_nÙ_suµÜ‹d
));

3930 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

3932 
out
;

3934 
out
:

3935 
	`TRACE_EXIT_RES
(
»s
);

3936  
»s
;

3938 
out_busy
:

3939 
	`sc¡_£t_busy
(
cmd
);

3940 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

3941 
out
;

3942 
	}
}

3945 
	$sc¡_do_job_š™
()

3946 
	$__»Ëa£s
(&
sc¡_š™_lock
)

3947 
	$__acquœes
(&
sc¡_š™_lock
)

3949 
sc¡_cmd
 *
cmd
;

3950 
su¥
;

3952 
	`TRACE_ENTRY
();

3954 
»¡¬t
:

3959 
su¥
 = 
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
);

3960 ià(
sc¡_š™_pÞl_út
 > 0)

3961 
sc¡_š™_pÞl_út
--;

3963 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
sc¡_š™_cmd_li¡
, 
cmd_li¡_’Œy
) {

3964 
rc
;

3965 ià(
su¥
 && !
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))

3967 ià(!
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

3968 
	`¥š_uÆock_œq
(&
sc¡_š™_lock
);

3969 
rc
 = 
	`__sc¡_š™_cmd
(
cmd
);

3970 
	`¥š_lock_œq
(&
sc¡_š™_lock
);

3971 ià(
rc
 > 0) {

3972 
	`TRACE_MGMT_DBG
("%s",

3974 
»¡¬t
;

3977 
	`TRACE_MGMT_DBG
("Aborting‚ot inited cmd %p (tag %llu)",

3978 
cmd
, ()cmd->
g
);

3979 
	`sc¡_£t_cmd_abnÜm®_dÚe_¡©e
(
cmd
);

3995 
	`TRACE_MGMT_DBG
("D–‘šg cmd %°äom in™ cmd†i¡", 
cmd
);

3996 
	`smp_wmb
();

3997 
	`li¡_d–
(&
cmd
->
cmd_li¡_’Œy
);

3998 
	`¥š_uÆock
(&
sc¡_š™_lock
);

4000 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

4001 
	`TRACE_MGMT_DBG
("Addšg cmd %°tØaùivcmd†i¡", 
cmd
);

4002 ià(
	`uÆik–y
(
cmd
->
queue_ty³
 =ð
SCST_CMD_QUEUE_HEAD_OF_QUEUE
))

4003 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

4004 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

4006 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

4007 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

4008 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

4009 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

4011 
	`¥š_lock
(&
sc¡_š™_lock
);

4012 
»¡¬t
;

4016 ià(
su¥
 !ð
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
))

4017 
»¡¬t
;

4019 
	`TRACE_EXIT
();

4021 
	}
}

4023 
šlše
 
	$‹¡_š™_cmd_li¡
()

4025 
»s
 = (!
	`li¡_em±y
(&
sc¡_š™_cmd_li¡
) &&

4026 !
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
)) ||

4027 
	`uÆik–y
(
	`kth»ad_should_¡Ý
()) ||

4028 (
sc¡_š™_pÞl_út
 > 0);

4029  
»s
;

4030 
	}
}

4032 
	$sc¡_š™_th»ad
(*
¬g
)

4034 
	`TRACE_ENTRY
();

4036 
	`PRINT_INFO
("In™h»ad s¹ed, PID %d", 
cu¼’t
->
pid
);

4038 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

4040 
	`£t_u£r_niû
(
cu¼’t
, -10);

4042 
	`¥š_lock_œq
(&
sc¡_š™_lock
);

4043 !
	`kth»ad_should_¡Ý
()) {

4044 
wa™_queue_t
 
wa™
;

4045 
	`š™_wa™queue_’Œy
(&
wa™
, 
cu¼’t
);

4047 ià(!
	`‹¡_š™_cmd_li¡
()) {

4048 
	`add_wa™_queue_exþusive
(&
sc¡_š™_cmd_li¡_wa™Q
,

4049 &
wa™
);

4051 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

4052 ià(
	`‹¡_š™_cmd_li¡
())

4054 
	`¥š_uÆock_œq
(&
sc¡_š™_lock
);

4055 
	`scheduË
();

4056 
	`¥š_lock_œq
(&
sc¡_š™_lock
);

4058 
	`£t_cu¼’t_¡©e
(
TASK_RUNNING
);

4059 
	`»move_wa™_queue
(&
sc¡_š™_cmd_li¡_wa™Q
, &
wa™
);

4061 
	`sc¡_do_job_š™
();

4063 
	`¥š_uÆock_œq
(&
sc¡_š™_lock
);

4069 
	`sBUG_ON
(!
	`li¡_em±y
(&
sc¡_š™_cmd_li¡
));

4071 
	`PRINT_INFO
("In™h»ad PID %d fšished", 
cu¼’t
->
pid
);

4073 
	`TRACE_EXIT
();

4075 
	}
}

4087 
	$sc¡_´oûss_aùive_cmd
(
sc¡_cmd
 *
cmd
, 
boÞ
 
©omic
)

4089 
»s
;

4091 
	`TRACE_ENTRY
();

4098 
	`EXTRACHECKS_BUG_ON
(
	`š_œq
(è|| 
	`œqs_di§bËd
());

4099 
	`EXTRACHECKS_WARN_ON
((
	`š_©omic
(è|| 
	`š_š‹¼u±
()è&& !
©omic
);

4101 
cmd
->
©omic
 =‡tomic;

4103 
	`TRACE_DBG
("cmd %p,‡tomiø%d", 
cmd
, 
©omic
);

4106 
cmd
->
¡©e
) {

4107 
SCST_CMD_STATE_PARSE
:

4108 
»s
 = 
	`sc¡_·r£_cmd
(
cmd
);

4111 
SCST_CMD_STATE_PREPARE_SPACE
:

4112 
»s
 = 
	`sc¡_´•¬e_¥aû
(
cmd
);

4115 
SCST_CMD_STATE_PREPROCESSING_DONE
:

4116 
»s
 = 
	`sc¡_´•roûssšg_dÚe
(
cmd
);

4119 
SCST_CMD_STATE_RDY_TO_XFER
:

4120 
»s
 = 
	`sc¡_rdy_to_xãr
(
cmd
);

4123 
SCST_CMD_STATE_TGT_PRE_EXEC
:

4124 
»s
 = 
	`sc¡_tgt_´e_exec
(
cmd
);

4127 
SCST_CMD_STATE_SEND_FOR_EXEC
:

4128 ià(
	`tm_dbg_check_cmd
(
cmd
) != 0) {

4129 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

4130 
	`TRACE_MGMT_DBG
("Skipping cmd %p (tag %llu), "

4131 "beÿu£ oàTM DBG d–ay", 
cmd
,

4132 ()
cmd
->
g
);

4135 
»s
 = 
	`sc¡_£nd_fÜ_exec
(&
cmd
);

4136 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

4143 
SCST_CMD_STATE_START_EXEC
:

4144 
»s
 = 
	`sc¡_exec
(&
cmd
);

4145 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

4152 
SCST_CMD_STATE_LOCAL_EXEC
:

4153 
»s
 = 
	`sc¡_loÿl_exec
(
cmd
);

4154 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

4161 
SCST_CMD_STATE_REAL_EXEC
:

4162 
»s
 = 
	`sc¡_»®_exec
(
cmd
);

4163 
	`EXTRACHECKS_BUG_ON
(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
);

4170 
SCST_CMD_STATE_PRE_DEV_DONE
:

4171 
»s
 = 
	`sc¡_´e_dev_dÚe
(
cmd
);

4172 
	`EXTRACHECKS_BUG_ON
((
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
) &&

4173 (
cmd
->
¡©e
 =ð
SCST_CMD_STATE_PRE_DEV_DONE
));

4176 
SCST_CMD_STATE_MODE_SELECT_CHECKS
:

4177 
»s
 = 
	`sc¡_mode_£Ëù_checks
(
cmd
);

4180 
SCST_CMD_STATE_DEV_DONE
:

4181 
»s
 = 
	`sc¡_dev_dÚe
(
cmd
);

4184 
SCST_CMD_STATE_PRE_XMIT_RESP
:

4185 
»s
 = 
	`sc¡_´e_xm™_»¥Ú£
(
cmd
);

4186 
	`EXTRACHECKS_BUG_ON
(
»s
 ==

4187 
SCST_CMD_STATE_RES_NEED_THREAD
);

4190 
SCST_CMD_STATE_XMIT_RESP
:

4191 
»s
 = 
	`sc¡_xm™_»¥Ú£
(
cmd
);

4194 
SCST_CMD_STATE_FINISHED
:

4195 
»s
 = 
	`sc¡_fšish_cmd
(
cmd
);

4198 
SCST_CMD_STATE_FINISHED_INTERNAL
:

4199 
»s
 = 
	`sc¡_fšish_š‹º®_cmd
(
cmd
);

4200 
	`EXTRACHECKS_BUG_ON
(
»s
 ==

4201 
SCST_CMD_STATE_RES_NEED_THREAD
);

4205 
	`PRINT_CRIT_ERROR
("cmd (%p) in state %d, but shouldn't "

4206 "be", 
cmd
, cmd->
¡©e
);

4207 
	`sBUG
();

4208 
»s
 = 
SCST_CMD_STATE_RES_CONT_NEXT
;

4211 } 
»s
 =ð
SCST_CMD_STATE_RES_CONT_SAME
);

4213 ià(
»s
 =ð
SCST_CMD_STATE_RES_CONT_NEXT
) {

4215 } ià(
»s
 =ð
SCST_CMD_STATE_RES_NEED_THREAD
) {

4216 
	`¥š_lock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

4217 #ifdeà
CONFIG_SCST_EXTRACHECKS


4218 
cmd
->
¡©e
) {

4219 
SCST_CMD_STATE_PARSE
:

4220 
SCST_CMD_STATE_PREPARE_SPACE
:

4221 
SCST_CMD_STATE_RDY_TO_XFER
:

4222 
SCST_CMD_STATE_TGT_PRE_EXEC
:

4223 
SCST_CMD_STATE_SEND_FOR_EXEC
:

4224 
SCST_CMD_STATE_START_EXEC
:

4225 
SCST_CMD_STATE_LOCAL_EXEC
:

4226 
SCST_CMD_STATE_REAL_EXEC
:

4227 
SCST_CMD_STATE_DEV_DONE
:

4228 
SCST_CMD_STATE_XMIT_RESP
:

4230 
	`TRACE_DBG
("Adding cmd %po head of‡ctive cmd†ist",

4231 
cmd
);

4232 
	`li¡_add
(&
cmd
->
cmd_li¡_’Œy
,

4233 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

4234 #ifdeà
CONFIG_SCST_EXTRACHECKS


4237 
	`PRINT_CRIT_ERROR
("cmd %°i š inv®id s‹ %d)", 
cmd
,

4238 
cmd
->
¡©e
);

4239 
	`¥š_uÆock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

4240 
	`sBUG
();

4241 
	`¥š_lock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

4245 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

4246 
	`¥š_uÆock_œq
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

4248 
	`sBUG
();

4250 
	`TRACE_EXIT
();

4252 
	}
}

4253 
EXPORT_SYMBOL_GPL
(
sc¡_´oûss_aùive_cmd
);

4256 
	$sc¡_do_job_aùive
(
li¡_h—d
 *
cmd_li¡
,

4257 
¥šlock_t
 *
cmd_li¡_lock
, 
boÞ
 
©omic
)

4258 
	$__»Ëa£s
(
cmd_li¡_lock
)

4259 
	$__acquœes
(
cmd_li¡_lock
)

4261 
	`TRACE_ENTRY
();

4263 !
	`li¡_em±y
(
cmd_li¡
)) {

4264 
sc¡_cmd
 *
cmd
 = 
	`li¡_’Œy
(
cmd_li¡
->
Ãxt
, 
	`ty³of
(*cmd),

4265 
cmd_li¡_’Œy
);

4266 
	`TRACE_DBG
("D–‘šg cmd %°äom‡ùivcmd†i¡", 
cmd
);

4267 
	`li¡_d–
(&
cmd
->
cmd_li¡_’Œy
);

4268 
	`¥š_uÆock_œq
(
cmd_li¡_lock
);

4269 
	`sc¡_´oûss_aùive_cmd
(
cmd
, 
©omic
);

4270 
	`¥š_lock_œq
(
cmd_li¡_lock
);

4273 
	`TRACE_EXIT
();

4275 
	}
}

4277 
šlše
 
	$‹¡_cmd_th»ads
(
sc¡_cmd_th»ads
 *
p_cmd_th»ads
)

4279 
»s
 = !
	`li¡_em±y
(&
p_cmd_th»ads
->
aùive_cmd_li¡
) ||

4280 
	`uÆik–y
(
	`kth»ad_should_¡Ý
()) ||

4281 
	`tm_dbg_is_»Ëa£
();

4282  
»s
;

4283 
	}
}

4285 
	$sc¡_cmd_th»ad
(*
¬g
)

4287 
sc¡_cmd_th»ads
 *
p_cmd_th»ads
 = 
¬g
;

4289 
	`TRACE_ENTRY
();

4291 
	`PRINT_INFO
("Proûssšgh»ad % (PID %dè¡¬‹d", 
cu¼’t
->
comm
,

4292 
cu¼’t
->
pid
);

4295 
	`£t_u£r_niû
(
cu¼’t
, 10);

4297 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

4299 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 25)

4300 
	`mu‹x_lock
(&
p_cmd_th»ads
->
io_cÚ‹xt_mu‹x
);

4302 
	`WARN_ON
(
cu¼’t
->
io_cÚ‹xt
);

4304 ià(
p_cmd_th»ads
 !ð&
sc¡_maš_cmd_th»ads
) {

4309 ià(
p_cmd_th»ads
->
io_cÚ‹xt
 =ð
NULL
) {

4310 
p_cmd_th»ads
->
io_cÚ‹xt
 = 
	`g‘_io_cÚ‹xt
(
GFP_KERNEL
, -1);

4311 
	`TRACE_MGMT_DBG
("Alloced‚ew IO context %p "

4313 
p_cmd_th»ads
->
io_cÚ‹xt
,

4314 
p_cmd_th»ads
);

4319 
	`put_io_cÚ‹xt
(
p_cmd_th»ads
->
io_cÚ‹xt
);

4321 
cu¼’t
->
io_cÚ‹xt
 = 
	`ioc_sk_lšk
(
p_cmd_th»ads
->io_context);

4322 
	`TRACE_MGMT_DBG
("Linked IO context %p "

4323 "Õ_cmd_th»ad %p)", 
p_cmd_th»ads
->
io_cÚ‹xt
,

4324 
p_cmd_th»ads
);

4326 
p_cmd_th»ads
->
io_cÚ‹xt_»fút
++;

4329 
	`mu‹x_uÆock
(&
p_cmd_th»ads
->
io_cÚ‹xt_mu‹x
);

4332 
	`smp_wmb
();

4333 
p_cmd_th»ads
->
io_cÚ‹xt_»ady
 = 
Œue
;

4335 
	`¥š_lock_œq
(&
p_cmd_th»ads
->
cmd_li¡_lock
);

4336 !
	`kth»ad_should_¡Ý
()) {

4337 
wa™_queue_t
 
wa™
;

4338 
	`š™_wa™queue_’Œy
(&
wa™
, 
cu¼’t
);

4340 ià(!
	`‹¡_cmd_th»ads
(
p_cmd_th»ads
)) {

4341 
	`add_wa™_queue_exþusive_h—d
(

4342 &
p_cmd_th»ads
->
cmd_li¡_wa™Q
,

4343 &
wa™
);

4345 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

4346 ià(
	`‹¡_cmd_th»ads
(
p_cmd_th»ads
))

4348 
	`¥š_uÆock_œq
(&
p_cmd_th»ads
->
cmd_li¡_lock
);

4349 
	`scheduË
();

4350 
	`¥š_lock_œq
(&
p_cmd_th»ads
->
cmd_li¡_lock
);

4352 
	`£t_cu¼’t_¡©e
(
TASK_RUNNING
);

4353 
	`»move_wa™_queue
(&
p_cmd_th»ads
->
cmd_li¡_wa™Q
, &
wa™
);

4356 ià(
	`tm_dbg_is_»Ëa£
()) {

4357 
	`¥š_uÆock_œq
(&
p_cmd_th»ads
->
cmd_li¡_lock
);

4358 
	`tm_dbg_check_»Ëa£d_cmds
();

4359 
	`¥š_lock_œq
(&
p_cmd_th»ads
->
cmd_li¡_lock
);

4362 
	`sc¡_do_job_aùive
(&
p_cmd_th»ads
->
aùive_cmd_li¡
,

4363 &
p_cmd_th»ads
->
cmd_li¡_lock
, 
çl£
);

4365 
	`¥š_uÆock_œq
(&
p_cmd_th»ads
->
cmd_li¡_lock
);

4367 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 25)

4368 ià(
p_cmd_th»ads
 !ð&
sc¡_maš_cmd_th»ads
) {

4369 
	`mu‹x_lock
(&
p_cmd_th»ads
->
io_cÚ‹xt_mu‹x
);

4370 ià(--
p_cmd_th»ads
->
io_cÚ‹xt_»fút
 == 0)

4371 
p_cmd_th»ads
->
io_cÚ‹xt
 = 
NULL
;

4372 
	`mu‹x_uÆock
(&
p_cmd_th»ads
->
io_cÚ‹xt_mu‹x
);

4376 
	`PRINT_INFO
("Proûssšgh»ad % (PID %dèfšished", 
cu¼’t
->
comm
,

4377 
cu¼’t
->
pid
);

4379 
	`TRACE_EXIT
();

4381 
	}
}

4383 
	$sc¡_cmd_skËt
(
p
)

4385 
sc¡_³rýu_šfo
 *
i
 = (sc¡_³rýu_šfØ*)
p
;

4387 
	`TRACE_ENTRY
();

4389 
	`¥š_lock_œq
(&
i
->
skËt_lock
);

4390 
	`sc¡_do_job_aùive
(&
i
->
skËt_cmd_li¡
, &i->
skËt_lock
, 
Œue
);

4391 
	`¥š_uÆock_œq
(&
i
->
skËt_lock
);

4393 
	`TRACE_EXIT
();

4395 
	}
}

4402 
	$sc¡_mgmt_Œª¦©e_lun
(
sc¡_mgmt_cmd
 *
mcmd
)

4404 
sc¡_tgt_dev
 *
tgt_dev
 = 
NULL
;

4405 
li¡_h—d
 *
h—d
;

4406 
»s
 = -1;

4408 
	`TRACE_ENTRY
();

4410 
	`TRACE_DBG
("Fšdšggt_dev fÜ mgmˆcmd %°ÖuÀ%Îd)", 
mcmd
,

4411 ()
mcmd
->
lun
);

4413 
mcmd
->
ýu_cmd_couÁ”
 = 
	`sc¡_g‘
();

4415 ià(
	`uÆik–y
(
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
) &&

4416 !
	`‹¡_b™
(
SCST_FLAG_SUSPENDING
, &
sc¡_æags
))) {

4417 
	`TRACE_MGMT_DBG
("%s", "FLAG SUSPENDED set, skipping");

4418 
	`sc¡_put
(
mcmd
->
ýu_cmd_couÁ”
);

4419 
»s
 = 1;

4420 
out
;

4423 
h—d
 = &
mcmd
->
£ss
->
£ss_tgt_dev_li¡
[
	`SESS_TGT_DEV_LIST_HASH_FN
(mcmd->
lun
)];

4424 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

4425 ià(
tgt_dev
->
lun
 =ð
mcmd
->lun) {

4426 
	`TRACE_DBG
("tgt_dev %°found", 
tgt_dev
);

4427 
mcmd
->
mcmd_tgt_dev
 = 
tgt_dev
;

4428 
»s
 = 0;

4432 ià(
mcmd
->
mcmd_tgt_dev
 =ð
NULL
)

4433 
	`sc¡_put
(
mcmd
->
ýu_cmd_couÁ”
);

4435 
out
:

4436 
	`TRACE_EXIT_HRES
(
»s
);

4437  
»s
;

4438 
	}
}

4441 
	$sc¡_dÚe_cmd_mgmt
(
sc¡_cmd
 *
cmd
)

4443 
sc¡_mgmt_cmd_¡ub
 *
m¡b
, *
t
;

4444 
boÞ
 
wake
 = 0;

4445 
æags
;

4447 
	`TRACE_ENTRY
();

4449 
	`TRACE_MGMT_DBG
("cmd %p done (tag %llu)",

4450 
cmd
, ()cmd->
g
);

4452 
	`¥š_lock_œq§ve
(&
sc¡_mcmd_lock
, 
æags
);

4454 
	`li¡_fÜ_—ch_’Œy_§ã
(
m¡b
, 
t
, &
cmd
->
mgmt_cmd_li¡
,

4455 
cmd_mgmt_cmd_li¡_’Œy
) {

4456 
sc¡_mgmt_cmd
 *
mcmd
;

4458 ià(!
m¡b
->
dÚe_couÁed
)

4461 
mcmd
 = 
m¡b
->mcmd;

4462 
	`TRACE_MGMT_DBG
("mcmd %p, mcmd->cmd_done_wait_count %d",

4463 
mcmd
, mcmd->
cmd_dÚe_wa™_couÁ
);

4465 
mcmd
->
cmd_dÚe_wa™_couÁ
--;

4467 
	`sBUG_ON
(
mcmd
->
cmd_dÚe_wa™_couÁ
 < 0);

4469 ià(
mcmd
->
cmd_dÚe_wa™_couÁ
 > 0) {

4470 
	`TRACE_MGMT_DBG
("cmd_done_wait_count(%d)‚ot 0, "

4471 "skpšg", 
mcmd
->
cmd_dÚe_wa™_couÁ
);

4472 
check_ä“
;

4475 ià(
mcmd
->
¡©e
 =ð
SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_DONE
) {

4476 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_AFFECTED_CMDS_DONE
;

4477 
	`TRACE_MGMT_DBG
("Adding mgmt cmd %po‡ctive mgmt cmd "

4478 "li¡", 
mcmd
);

4479 
	`li¡_add_ž
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

4480 &
sc¡_aùive_mgmt_cmd_li¡
);

4481 
wake
 = 1;

4484 
check_ä“
:

4485 ià(!
m¡b
->
fšish_couÁed
) {

4486 
	`TRACE_DBG
("R–—sšg m¡b %p", 
m¡b
);

4487 
	`li¡_d–
(&
m¡b
->
cmd_mgmt_cmd_li¡_’Œy
);

4488 
	`mempoÞ_ä“
(
m¡b
, 
sc¡_mgmt_¡ub_mempoÞ
);

4492 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mcmd_lock
, 
æags
);

4494 ià(
wake
)

4495 
	`wake_up
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

4497 
	`TRACE_EXIT
();

4499 
	}
}

4502 
	$__sc¡_dec_fšish_wa™_couÁ
(
sc¡_mgmt_cmd
 *
mcmd
, 
boÞ
 *
wake
)

4504 
	`TRACE_ENTRY
();

4506 
mcmd
->
cmd_fšish_wa™_couÁ
--;

4508 
	`sBUG_ON
(
mcmd
->
cmd_fšish_wa™_couÁ
 < 0);

4510 ià(
mcmd
->
cmd_fšish_wa™_couÁ
 > 0) {

4511 
	`TRACE_MGMT_DBG
("cmd_finish_wait_count(%d)‚ot 0, "

4512 "skpšg", 
mcmd
->
cmd_fšish_wa™_couÁ
);

4513 
out
;

4516 ià(
mcmd
->
cmd_dÚe_wa™_couÁ
 > 0) {

4517 
	`TRACE_MGMT_DBG
("cmd_done_wait_count(%d)‚ot 0, "

4518 "skpšg", 
mcmd
->
cmd_dÚe_wa™_couÁ
);

4519 
out
;

4522 ià(
mcmd
->
¡©e
 =ð
SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_FINISHED
) {

4523 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_DONE
;

4524 
	`TRACE_MGMT_DBG
("Adding mgmt cmd %po‡ctive mgmt cmd "

4525 "li¡", 
mcmd
);

4526 
	`li¡_add_ž
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

4527 &
sc¡_aùive_mgmt_cmd_li¡
);

4528 *
wake
 = 
Œue
;

4531 
out
:

4532 
	`TRACE_EXIT
();

4534 
	}
}

4544 
	$sc¡_´•¬e_async_mcmd
(
sc¡_mgmt_cmd
 *
mcmd
)

4546 
æags
;

4548 
	`TRACE_ENTRY
();

4550 
	`TRACE_MGMT_DBG
("Preparing mcmd %p for‡syncƒxecution "

4551 "(cmd_fšish_wa™_couÁ %d)", 
mcmd
,

4552 
mcmd
->
cmd_fšish_wa™_couÁ
);

4554 
	`¥š_lock_œq§ve
(&
sc¡_mcmd_lock
, 
æags
);

4555 
mcmd
->
cmd_fšish_wa™_couÁ
++;

4556 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mcmd_lock
, 
æags
);

4558 
	`TRACE_EXIT
();

4560 
	}
}

4561 
EXPORT_SYMBOL_GPL
(
sc¡_´•¬e_async_mcmd
);

4571 
	$sc¡_async_mcmd_com¶‘ed
(
sc¡_mgmt_cmd
 *
mcmd
, 
¡©us
)

4573 
æags
;

4574 
boÞ
 
wake
 = 
çl£
;

4576 
	`TRACE_ENTRY
();

4578 
	`TRACE_MGMT_DBG
("Asynømcmd %°com¶‘ed (¡©u %d)", 
mcmd
, 
¡©us
);

4580 
	`¥š_lock_œq§ve
(&
sc¡_mcmd_lock
, 
æags
);

4582 ià(
¡©us
 !ð
SCST_MGMT_STATUS_SUCCESS
)

4583 
mcmd
->
¡©us
 = status;

4585 
	`__sc¡_dec_fšish_wa™_couÁ
(
mcmd
, &
wake
);

4587 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mcmd_lock
, 
æags
);

4589 ià(
wake
)

4590 
	`wake_up
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

4592 
	`TRACE_EXIT
();

4594 
	}
}

4595 
EXPORT_SYMBOL_GPL
(
sc¡_async_mcmd_com¶‘ed
);

4598 
	$sc¡_fšish_cmd_mgmt
(
sc¡_cmd
 *
cmd
)

4600 
sc¡_mgmt_cmd_¡ub
 *
m¡b
, *
t
;

4601 
boÞ
 
wake
 = 
çl£
;

4602 
æags
;

4604 
	`TRACE_ENTRY
();

4606 
	`TRACE_MGMT_DBG
("cmd %p finished (tag %llu)",

4607 
cmd
, ()cmd->
g
);

4609 
	`¥š_lock_œq§ve
(&
sc¡_mcmd_lock
, 
æags
);

4611 
	`li¡_fÜ_—ch_’Œy_§ã
(
m¡b
, 
t
, &
cmd
->
mgmt_cmd_li¡
,

4612 
cmd_mgmt_cmd_li¡_’Œy
) {

4613 
sc¡_mgmt_cmd
 *
mcmd
 = 
m¡b
->mcmd;

4615 
	`TRACE_MGMT_DBG
("mcmd %p, mcmd->cmd_fšish_wa™_couÁ %d", 
mcmd
,

4616 
mcmd
->
cmd_fšish_wa™_couÁ
);

4618 
	`sBUG_ON
(!
m¡b
->
fšish_couÁed
);

4620 ià(
cmd
->
com¶‘ed
)

4621 
mcmd
->
com¶‘ed_cmd_couÁ
++;

4623 
	`__sc¡_dec_fšish_wa™_couÁ
(
mcmd
, &
wake
);

4625 
	`TRACE_DBG
("R–—sšg m¡b %p", 
m¡b
);

4626 
	`li¡_d–
(&
m¡b
->
cmd_mgmt_cmd_li¡_’Œy
);

4627 
	`mempoÞ_ä“
(
m¡b
, 
sc¡_mgmt_¡ub_mempoÞ
);

4630 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mcmd_lock
, 
æags
);

4632 ià(
wake
)

4633 
	`wake_up
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

4635 
	`TRACE_EXIT
();

4637 
	}
}

4639 
	$sc¡_ÿÎ_dev_sk_mgmt_â
(
sc¡_mgmt_cmd
 *
mcmd
,

4640 
sc¡_tgt_dev
 *
tgt_dev
, 
£t_¡©us
)

4642 
»s
 = 
SCST_DEV_TM_NOT_COMPLETED
;

4643 
sc¡_dev_ty³
 *
h
 = 
tgt_dev
->
dev
->
hªdËr
;

4645 ià(
h
->
sk_mgmt_â
) {

4646 
	`TRACE_MGMT_DBG
("Calling dev handler %sask_mgmt_fn(fn=%d)",

4647 
h
->
Çme
, 
mcmd
->
â
);

4648 
»s
 = 
h
->
	`sk_mgmt_â
(
mcmd
, 
tgt_dev
);

4649 
	`TRACE_MGMT_DBG
("Dev handler %sask_mgmt_fn()„eturned %d",

4650 
h
->
Çme
, 
»s
);

4651 ià(
£t_¡©us
 && (
»s
 !ð
SCST_DEV_TM_NOT_COMPLETED
))

4652 
mcmd
->
¡©us
 = 
»s
;

4654  
»s
;

4655 
	}
}

4657 
šlše
 
	$sc¡_is_¡riù_mgmt_â
(
mgmt_â
)

4659 
mgmt_â
) {

4660 #ifdeà
CONFIG_SCST_ABORT_CONSIDER_FINISHED_TASKS_AS_NOT_EXISTING


4661 
SCST_ABORT_TASK
:

4664 
SCST_ABORT_TASK_SET
:

4665 
SCST_CLEAR_TASK_SET
:

4671 
	}
}

4677 
	$sc¡_abÜt_cmd
(
sc¡_cmd
 *
cmd
, 
sc¡_mgmt_cmd
 *
mcmd
,

4678 
boÞ
 
Ùh”_ši
, boÞ 
ÿÎ_dev_sk_mgmt_â
)

4680 
æags
;

4681 
	`DEFINE_SPINLOCK
(
Ùh”_ši_lock
);

4683 
	`TRACE_ENTRY
();

4685 
	`TRACE
(
TRACE_SCSI
|
TRACE_MGMT_DEBUG
, "Aborting cmd %p (tag %llu, op %x)",

4686 
cmd
, ()cmd->
g
, cmd->
cdb
[0]);

4689 
	`¥š_lock_œq§ve
(&
Ùh”_ši_lock
, 
æags
);

4691 ià(
Ùh”_ši
) {

4692 
sc¡_deviû
 *
dev
 = 
NULL
;

4695 ià(!
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
))

4696 
	`£t_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
);

4699 ià(
cmd
->
dev
 !ð
NULL
)

4700 
dev
 = 
cmd
->dev;

4701 ià((
mcmd
 !ð
NULL
è&& (mcmd->
mcmd_tgt_dev
 != NULL))

4702 
dev
 = 
mcmd
->
mcmd_tgt_dev
->dev;

4704 ià(
dev
 !ð
NULL
) {

4705 ià(
dev
->
s
)

4706 
	`£t_b™
(
SCST_CMD_DEVICE_TAS
, &
cmd
->
cmd_æags
);

4708 
	`PRINT_WARNING
("Abort cmd %p from other initiator, but "

4710 "TAS infÜm©iÚ cª blo¡", 
cmd
, 
mcmd
);

4713 
	`þ—r_b™
(
SCST_CMD_ABORTED_OTHER
, &
cmd
->
cmd_æags
);

4716 
	`£t_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
);

4718 
	`¥š_uÆock_œq»¡Üe
(&
Ùh”_ši_lock
, 
æags
);

4725 
	`smp_mb__aá”_£t_b™
();

4727 ià(
cmd
->
tgt_dev
 =ð
NULL
) {

4728 
	`¥š_lock_œq§ve
(&
sc¡_š™_lock
, 
æags
);

4729 
sc¡_š™_pÞl_út
++;

4730 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_š™_lock
, 
æags
);

4731 
	`wake_up
(&
sc¡_š™_cmd_li¡_wa™Q
);

4734 ià(!
cmd
->
fšished
 && 
ÿÎ_dev_sk_mgmt_â
 && (cmd->
tgt_dev
 !ð
NULL
))

4735 
	`sc¡_ÿÎ_dev_sk_mgmt_â
(
mcmd
, 
cmd
->
tgt_dev
, 1);

4737 
	`¥š_lock_œq§ve
(&
sc¡_mcmd_lock
, 
æags
);

4738 ià((
mcmd
 !ð
NULL
è&& !
cmd
->
fšished
) {

4739 
sc¡_mgmt_cmd_¡ub
 *
m¡b
;

4741 
m¡b
 = 
	`mempoÞ_®loc
(
sc¡_mgmt_¡ub_mempoÞ
, 
GFP_ATOMIC
);

4742 ià(
m¡b
 =ð
NULL
) {

4743 
	`PRINT_CRIT_ERROR
("Allocation of management command "

4744 "¡ub fažed (mcmd %p, cmd %p)", 
mcmd
, 
cmd
);

4745 
uÆock
;

4747 
	`mem£t
(
m¡b
, 0, (*mstb));

4749 
	`TRACE_DBG
("m¡b %p, mcmd %p", 
m¡b
, 
mcmd
);

4751 
m¡b
->
mcmd
 = mcmd;

4765 ià(
cmd
->
£Á_fÜ_exec
 && !cmd->
dÚe
) {

4766 
	`TRACE_MGMT_DBG
("cmd %p (tag %llu) is beingƒxecuted",

4767 
cmd
, ()cmd->
g
);

4768 
m¡b
->
dÚe_couÁed
 = 1;

4769 
mcmd
->
cmd_dÚe_wa™_couÁ
++;

4776 ià(!
Ùh”_ši
) {

4777 
m¡b
->
fšish_couÁed
 = 1;

4778 
mcmd
->
cmd_fšish_wa™_couÁ
++;

4781 ià(
m¡b
->
dÚe_couÁed
 || m¡b->
fšish_couÁed
) {

4782 
	`TRACE
(
TRACE_SCSI
|
TRACE_MGMT_DEBUG
, "cmd %p (tag %llu, "

4786 "cmd_fšish_wa™_couÁ %d)", 
cmd
,

4787 ()
cmd
->
g
,

4788 
cmd
->
¢
, cmd->
¡©e
, cmd->
cdb
[0],

4789 ()(
jiff›s
 - 
cmd
->
¡¬t_time
è/ 
HZ
,

4790 
cmd
->
timeout
 / 
HZ
, 
mcmd
->
cmd_dÚe_wa™_couÁ
,

4791 
mcmd
->
cmd_fšish_wa™_couÁ
);

4796 
	`li¡_add_ž
(&
m¡b
->
cmd_mgmt_cmd_li¡_’Œy
,

4797 &
cmd
->
mgmt_cmd_li¡
);

4800 
	`mempoÞ_ä“
(
m¡b
, 
sc¡_mgmt_¡ub_mempoÞ
);

4803 ià(
cmd
->
tg‰
->
Ú_abÜt_cmd
)

4804 
cmd
->
tg‰
->
	`Ú_abÜt_cmd
(cmd);

4807 
uÆock
:

4808 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mcmd_lock
, 
æags
);

4810 
	`tm_dbg_»Ëa£_cmd
(
cmd
);

4812 
	`TRACE_EXIT
();

4814 
	}
}

4817 
	$sc¡_£t_mcmd_Ãxt_¡©e
(
sc¡_mgmt_cmd
 *
mcmd
)

4819 
»s
;

4821 
	`¥š_lock_œq
(&
sc¡_mcmd_lock
);

4823 
mcmd
->
¡©e
) {

4824 
SCST_MCMD_STATE_INIT
:

4825 
SCST_MCMD_STATE_EXEC
:

4826 ià(
mcmd
->
cmd_dÚe_wa™_couÁ
 == 0) {

4827 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_AFFECTED_CMDS_DONE
;

4828 
»s
 = 0;

4830 
	`TRACE
(
TRACE_SCSI
|
TRACE_MGMT_DEBUG
,

4832 "´•¬šgØwa™", 
mcmd
->
cmd_dÚe_wa™_couÁ
);

4833 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_DONE
;

4834 
»s
 = -1;

4838 
SCST_MCMD_STATE_AFFECTED_CMDS_DONE
:

4839 ià(
mcmd
->
cmd_fšish_wa™_couÁ
 == 0) {

4840 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_DONE
;

4841 
»s
 = 0;

4843 
	`TRACE
(
TRACE_SCSI
|
TRACE_MGMT_DEBUG
,

4846 
mcmd
->
cmd_fšish_wa™_couÁ
);

4847 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_WAITING_AFFECTED_CMDS_FINISHED
;

4848 
»s
 = -1;

4852 
SCST_MCMD_STATE_DONE
:

4853 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_FINISHED
;

4854 
»s
 = 0;

4858 
	`PRINT_CRIT_ERROR
("Wrong mcmd %p state %d (fn %d, "

4860 
mcmd
, mcmd->
¡©e
, mcmd->
â
,

4861 
mcmd
->
cmd_fšish_wa™_couÁ
, mcmd->
cmd_dÚe_wa™_couÁ
);

4862 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

4863 
»s
 = -1;

4864 
	`sBUG
();

4865 
out
;

4868 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

4870 
out
:

4871  
»s
;

4872 
	}
}

4875 
boÞ
 
	$__sc¡_check_unblock_abÜ‹d_cmd
(
sc¡_cmd
 *
cmd
,

4876 
li¡_h—d
 *
li¡_’Œy
)

4878 
boÞ
 
»s
;

4879 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
, &
cmd
->
cmd_æags
)) {

4880 
	`li¡_d–
(
li¡_’Œy
);

4881 
	`¥š_lock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

4882 
	`li¡_add_ž
(&
cmd
->
cmd_li¡_’Œy
,

4883 &
cmd
->
cmd_th»ads
->
aùive_cmd_li¡
);

4884 
	`wake_up
(&
cmd
->
cmd_th»ads
->
cmd_li¡_wa™Q
);

4885 
	`¥š_uÆock
(&
cmd
->
cmd_th»ads
->
cmd_li¡_lock
);

4886 
»s
 = 1;

4888 
»s
 = 0;

4889  
»s
;

4890 
	}
}

4892 
	$sc¡_unblock_abÜ‹d_cmds
(
sc¡_mu‹x_h–d
)

4894 
sc¡_deviû
 *
dev
;

4896 
	`TRACE_ENTRY
();

4898 ià(!
sc¡_mu‹x_h–d
)

4899 
	`mu‹x_lock
(&
sc¡_mu‹x
);

4901 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
) {

4902 
sc¡_cmd
 *
cmd
, *
tcmd
;

4903 
sc¡_tgt_dev
 *
tgt_dev
;

4904 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

4905 
	`loÿl_œq_di§bË
();

4906 
	`li¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
tcmd
, &
dev
->
blocked_cmd_li¡
,

4907 
blocked_cmd_li¡_’Œy
) {

4908 ià(
	`__sc¡_check_unblock_abÜ‹d_cmd
(
cmd
,

4909 &
cmd
->
blocked_cmd_li¡_’Œy
)) {

4910 
	`TRACE_MGMT_DBG
("Unblock‡borted blocked cmd %p",

4911 
cmd
);

4914 
	`loÿl_œq_’abË
();

4915 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

4917 
	`loÿl_œq_di§bË
();

4918 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

4919 
dev_tgt_dev_li¡_’Œy
) {

4920 
sc¡_Üd”_d©a
 *
Üd”_d©a
 = 
tgt_dev
->
cu¼_Üd”_d©a
;

4921 
	`¥š_lock
(&
Üd”_d©a
->
¢_lock
);

4922 
	`li¡_fÜ_—ch_’Œy_§ã
(
cmd
, 
tcmd
,

4923 &
Üd”_d©a
->
deã¼ed_cmd_li¡
,

4924 
¢_cmd_li¡_’Œy
) {

4925 ià(
	`__sc¡_check_unblock_abÜ‹d_cmd
(
cmd
,

4926 &
cmd
->
¢_cmd_li¡_’Œy
)) {

4927 
	`TRACE_MGMT_DBG
("Unblocked‡borted SN "

4929 
cmd
, cmd->
¢
);

4930 
Üd”_d©a
->
def_cmd_couÁ
--;

4933 
	`¥š_uÆock
(&
Üd”_d©a
->
¢_lock
);

4935 
	`loÿl_œq_’abË
();

4938 ià(!
sc¡_mu‹x_h–d
)

4939 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

4941 
	`TRACE_EXIT
();

4943 
	}
}

4945 
	$__sc¡_abÜt_sk_£t
(
sc¡_mgmt_cmd
 *
mcmd
,

4946 
sc¡_tgt_dev
 *
tgt_dev
)

4948 
sc¡_cmd
 *
cmd
;

4949 
sc¡_£ssiÚ
 *
£ss
 = 
tgt_dev
->sess;

4950 
boÞ
 
Ùh”_ši
;

4952 
	`TRACE_ENTRY
();

4954 ià((
mcmd
->
â
 =ð
SCST_PR_ABORT_ALL
) &&

4955 (
mcmd
->
Üigš_´_cmd
->
£ss
 != sess))

4956 
Ùh”_ši
 = 
Œue
;

4958 
Ùh”_ši
 = 
çl£
;

4960 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

4962 
	`TRACE_DBG
("S—rchšg iÀ£s cmd†i¡ (£ss=%p)", 
£ss
);

4963 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
,

4964 
£ss_cmd_li¡_’Œy
) {

4965 ià((
mcmd
->
â
 =ð
SCST_PR_ABORT_ALL
) &&

4966 (
mcmd
->
Üigš_´_cmd
 =ð
cmd
))

4968 ià((
cmd
->
tgt_dev
 ==gt_dev) ||

4969 ((
cmd
->
tgt_dev
 =ð
NULL
) &&

4970 (
cmd
->
lun
 =ð
tgt_dev
->lun))) {

4971 ià(
mcmd
->
cmd_¢_£t
) {

4972 
	`sBUG_ON
(!
cmd
->
tgt_¢_£t
);

4973 ià(
	`sc¡_¢_befÜe
(
mcmd
->
cmd_¢
, 
cmd
->
tgt_¢
) ||

4974 (
mcmd
->
cmd_¢
 =ð
cmd
->
tgt_¢
))

4977 
	`sc¡_abÜt_cmd
(
cmd
, 
mcmd
, 
Ùh”_ši
, 0);

4980 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

4982 
	`TRACE_EXIT
();

4984 
	}
}

4987 
	$sc¡_abÜt_sk_£t
(
sc¡_mgmt_cmd
 *
mcmd
)

4989 
»s
;

4990 
sc¡_tgt_dev
 *
tgt_dev
 = 
mcmd
->
mcmd_tgt_dev
;

4992 
	`TRACE
(
TRACE_MGMT
, "Abortingask set (lun=%lld, mcmd=%p)",

4993 ()
tgt_dev
->
lun
, 
mcmd
);

4995 
	`__sc¡_abÜt_sk_£t
(
mcmd
, 
tgt_dev
);

4997 ià(
mcmd
->
â
 =ð
SCST_PR_ABORT_ALL
) {

4998 
sc¡_´_abÜt_®l_³ndšg_mgmt_cmds_couÁ”
 *
´_út
 =

4999 
mcmd
->
Üigš_´_cmd
->
´_abÜt_couÁ”
;

5000 ià(
	`©omic_dec_ªd_‹¡
(&
´_út
->
´_abÜtšg_út
))

5001 
	`com¶‘e_®l
(&
´_út
->
´_abÜtšg_cm¶
);

5004 
	`tm_dbg_sk_mgmt
(
mcmd
->
mcmd_tgt_dev
->
dev
, "ABORT TASK SET/PR ABORT", 0);

5006 
	`sc¡_unblock_abÜ‹d_cmds
(0);

5008 
	`sc¡_ÿÎ_dev_sk_mgmt_â
(
mcmd
, 
tgt_dev
, 0);

5010 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5012 
	`TRACE_EXIT_RES
(
»s
);

5013  
»s
;

5014 
	}
}

5016 
	$sc¡_is_cmd_b–Úgs_to_dev
(
sc¡_cmd
 *
cmd
,

5017 
sc¡_deviû
 *
dev
)

5019 
sc¡_tgt_dev
 *
tgt_dev
 = 
NULL
;

5020 
li¡_h—d
 *
h—d
;

5021 
»s
 = 0;

5023 
	`TRACE_ENTRY
();

5025 
	`TRACE_DBG
("Fšdšg m©ch fÜ dev % ªd cmd %°ÖuÀ%Îd)", 
dev
->
vœt_Çme
,

5026 
cmd
, ()cmd->
lun
);

5028 
h—d
 = &
cmd
->
£ss
->
£ss_tgt_dev_li¡
[
	`SESS_TGT_DEV_LIST_HASH_FN
(cmd->
lun
)];

5029 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

5030 ià(
tgt_dev
->
lun
 =ð
cmd
->lun) {

5031 
	`TRACE_DBG
("dev % found", 
tgt_dev
->
dev
->
vœt_Çme
);

5032 
»s
 = (
tgt_dev
->
dev
 == dev);

5033 
out
;

5037 
out
:

5038 
	`TRACE_EXIT_HRES
(
»s
);

5039  
»s
;

5040 
	}
}

5043 
	$sc¡_þ—r_sk_£t
(
sc¡_mgmt_cmd
 *
mcmd
)

5045 
»s
;

5046 
sc¡_deviû
 *
dev
 = 
mcmd
->
mcmd_tgt_dev
->dev;

5047 
sc¡_tgt_dev
 *
tgt_dev
;

5048 
	`LIST_HEAD
(
UA_tgt_devs
);

5050 
	`TRACE_ENTRY
();

5052 
	`TRACE
(
TRACE_MGMT
, "Clearingask set (lun=%lld, mcmd=%p)",

5053 ()
mcmd
->
lun
, mcmd);

5062 
mcmd
->
Ãeds_unblockšg
 = 1;

5063 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

5064 
	`sc¡_block_dev
(
dev
);

5065 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

5068 
	`__sc¡_abÜt_sk_£t
(
mcmd
, mcmd->
mcmd_tgt_dev
);

5070 
	`mu‹x_lock
(&
sc¡_mu‹x
);

5072 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

5073 
dev_tgt_dev_li¡_’Œy
) {

5074 
sc¡_£ssiÚ
 *
£ss
 = 
tgt_dev
->sess;

5075 
sc¡_cmd
 *
cmd
;

5076 
abÜ‹d
 = 0;

5078 ià(
tgt_dev
 =ð
mcmd
->
mcmd_tgt_dev
)

5081 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

5083 
	`TRACE_DBG
("S—rchšg iÀ£s cmd†i¡ (£ss=%p)", 
£ss
);

5084 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
,

5085 
£ss_cmd_li¡_’Œy
) {

5086 ià((
cmd
->
dev
 == dev) ||

5087 ((
cmd
->
dev
 =ð
NULL
) &&

5088 
	`sc¡_is_cmd_b–Úgs_to_dev
(
cmd
, 
dev
))) {

5089 
	`sc¡_abÜt_cmd
(
cmd
, 
mcmd
, 1, 0);

5090 
abÜ‹d
 = 1;

5093 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

5095 ià(
abÜ‹d
)

5096 
	`li¡_add_ž
(&
tgt_dev
->
exŒa_tgt_dev_li¡_’Œy
,

5097 &
UA_tgt_devs
);

5100 
	`tm_dbg_sk_mgmt
(
mcmd
->
mcmd_tgt_dev
->
dev
, "CLEAR TASK SET", 0);

5102 
	`sc¡_unblock_abÜ‹d_cmds
(1);

5104 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

5106 ià(!
dev
->
s
) {

5107 
ušt8_t
 
£n£_bufãr
[
SCST_STANDARD_SENSE_LEN
];

5108 
¦
;

5110 
¦
 = 
	`sc¡_£t_£n£
(
£n£_bufãr
, (sense_buffer),

5111 
dev
->
d_£n£
,

5112 
	`SCST_LOAD_SENSE
(
sc¡_£n£_þ—»d_by_ªÙh”_ši_UA
));

5114 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
UA_tgt_devs
,

5115 
exŒa_tgt_dev_li¡_’Œy
) {

5116 
	`sc¡_check_£t_UA
(
tgt_dev
, 
£n£_bufãr
, 
¦
, 0);

5120 
	`sc¡_ÿÎ_dev_sk_mgmt_â
(
mcmd
, mcmd->
mcmd_tgt_dev
, 0);

5122 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5124 
	`TRACE_EXIT_RES
(
»s
);

5125  
»s
;

5126 
	}
}

5130 
	$sc¡_mgmt_cmd_š™
(
sc¡_mgmt_cmd
 *
mcmd
)

5132 
»s
 = 0, 
rc
;

5134 
	`TRACE_ENTRY
();

5136 
mcmd
->
â
) {

5137 
SCST_ABORT_TASK
:

5139 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

5140 
sc¡_cmd
 *
cmd
;

5142 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

5143 
cmd
 = 
	`__sc¡_fšd_cmd_by_g
(
£ss
, 
mcmd
->
g
, 
Œue
);

5144 ià(
cmd
 =ð
NULL
) {

5145 
	`TRACE_MGMT_DBG
("ABORT TASK: command "

5147 ()
mcmd
->
g
);

5148 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_TASK_NOT_EXIST
;

5149 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

5150 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5151 
out
;

5153 
	`__sc¡_cmd_g‘
(
cmd
);

5154 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

5155 
	`TRACE_DBG
("Cmdo‡bort %p forag %llu found",

5156 
cmd
, ()
mcmd
->
g
);

5157 
mcmd
->
cmd_to_abÜt
 = 
cmd
;

5158 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_EXEC
;

5162 
SCST_TARGET_RESET
:

5163 
SCST_NEXUS_LOSS_SESS
:

5164 
SCST_ABORT_ALL_TASKS_SESS
:

5165 
SCST_NEXUS_LOSS
:

5166 
SCST_ABORT_ALL_TASKS
:

5167 
SCST_UNREG_SESS_TM
:

5168 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_EXEC
;

5171 
SCST_ABORT_TASK_SET
:

5172 
SCST_CLEAR_ACA
:

5173 
SCST_CLEAR_TASK_SET
:

5174 
SCST_LUN_RESET
:

5175 
SCST_PR_ABORT_ALL
:

5176 
rc
 = 
	`sc¡_mgmt_Œª¦©e_lun
(
mcmd
);

5177 ià(
rc
 == 0)

5178 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_EXEC
;

5179 ià(
rc
 < 0) {

5180 
	`PRINT_ERROR
("Corresponding device for LUN %lld‚ot "

5181 "found", ()
mcmd
->
lun
);

5182 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_LUN_NOT_EXIST
;

5183 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5185 
»s
 = 
rc
;

5189 
	`sBUG
();

5192 
out
:

5193 
	`TRACE_EXIT_RES
(
»s
);

5194  
»s
;

5195 
	}
}

5198 
	$sc¡_rg‘_»£t
(
sc¡_mgmt_cmd
 *
mcmd
)

5200 
»s
, 
rc
;

5201 
sc¡_deviû
 *
dev
;

5202 
sc¡_acg
 *
acg
 = 
mcmd
->
£ss
->acg;

5203 
sc¡_acg_dev
 *
acg_dev
;

5204 
cÚt
, 
c
;

5205 
	`LIST_HEAD
(
ho¡_devs
);

5207 
	`TRACE_ENTRY
();

5209 
	`TRACE
(
TRACE_MGMT
, "Target„eset (mcmd %p, cmd count %d)",

5210 
mcmd
, 
	`©omic_»ad
(&mcmd->
£ss
->
£ss_cmd_couÁ
));

5212 
mcmd
->
Ãeds_unblockšg
 = 1;

5214 
	`mu‹x_lock
(&
sc¡_mu‹x
);

5216 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

5217 
sc¡_deviû
 *
d
;

5218 
sc¡_tgt_dev
 *
tgt_dev
;

5219 
found
 = 0;

5221 
dev
 = 
acg_dev
->dev;

5223 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

5224 
	`sc¡_block_dev
(
dev
);

5225 
	`sc¡_´oûss_»£t
(
dev
, 
mcmd
->
£ss
, 
NULL
, mcmd, 
Œue
);

5226 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

5228 
cÚt
 = 0;

5229 
c
 = 0;

5230 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

5231 
dev_tgt_dev_li¡_’Œy
) {

5232 
cÚt
 = 1;

5233 ià(
mcmd
->
£ss
 =ð
tgt_dev
->sess) {

5234 
rc
 = 
	`sc¡_ÿÎ_dev_sk_mgmt_â
(
mcmd
,

5235 
tgt_dev
, 0);

5236 ià(
rc
 =ð
SCST_DEV_TM_NOT_COMPLETED
)

5237 
c
 = 1;

5238 ià((
rc
 < 0) &&

5239 (
mcmd
->
¡©us
 =ð
SCST_MGMT_STATUS_SUCCESS
))

5240 
mcmd
->
¡©us
 = 
rc
;

5244 ià(
cÚt
 && !
c
)

5247 ià(
dev
->
scsi_dev
 =ð
NULL
)

5250 
	`li¡_fÜ_—ch_’Œy
(
d
, &
ho¡_devs
, 
tm_dev_li¡_’Œy
) {

5251 ià(
dev
->
scsi_dev
->
ho¡
->
ho¡_no
 ==

5252 
d
->
scsi_dev
->
ho¡
->
ho¡_no
) {

5253 
found
 = 1;

5257 ià(!
found
)

5258 
	`li¡_add_ž
(&
dev
->
tm_dev_li¡_’Œy
, &
ho¡_devs
);

5260 
	`tm_dbg_sk_mgmt
(
dev
, "TARGET RESET", 0);

5263 
	`sc¡_unblock_abÜ‹d_cmds
(1);

5270 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
ho¡_devs
, 
tm_dev_li¡_’Œy
) {

5272 
	`TRACE
(
TRACE_MGMT
, "Resetting host %d bus ",

5273 
dev
->
scsi_dev
->
ho¡
->
ho¡_no
);

5274 #ià
LINUX_VERSION_CODE
 >ð
	`KERNEL_VERSION
(2, 6, 26)

5275 
rc
 = 
	`scsi_»£t_´ovid”
(
dev
->
scsi_dev
, 
SCSI_TRY_RESET_TARGET
);

5277 
rc
 = 
	`scsi_»£t_´ovid”
(
dev
->
scsi_dev
, 
SCSI_TRY_RESET_BUS
);

5279 
	`TRACE
(
TRACE_MGMT
, "Result of host %darget„eset: %s",

5280 
dev
->
scsi_dev
->
ho¡
->
ho¡_no
,

5281 (
rc
 =ð
SUCCESS
) ? "SUCCESS" : "FAILED");

5283 ià((
rc
 !ð
SUCCESS
) &&

5284 (
mcmd
->
¡©us
 =ð
SCST_MGMT_STATUS_SUCCESS
)) {

5289 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_FAILED
;

5299 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
, 
acg_dev_li¡_’Œy
) {

5300 
dev
 = 
acg_dev
->dev;

5301 ià(
dev
->
scsi_dev
 !ð
NULL
)

5302 
dev
->
scsi_dev
->
was_»£t
 = 0;

5305 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

5307 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5309 
	`TRACE_EXIT_RES
(
»s
);

5310  
»s
;

5311 
	}
}

5314 
	$sc¡_lun_»£t
(
sc¡_mgmt_cmd
 *
mcmd
)

5316 
»s
, 
rc
;

5317 
sc¡_tgt_dev
 *
tgt_dev
 = 
mcmd
->
mcmd_tgt_dev
;

5318 
sc¡_deviû
 *
dev
 = 
tgt_dev
->dev;

5320 
	`TRACE_ENTRY
();

5322 
	`TRACE
(
TRACE_MGMT
, "Resetting LUN %lld (mcmd %p)",

5323 ()
tgt_dev
->
lun
, 
mcmd
);

5325 
mcmd
->
Ãeds_unblockšg
 = 1;

5327 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

5328 
	`sc¡_block_dev
(
dev
);

5329 
	`sc¡_´oûss_»£t
(
dev
, 
mcmd
->
£ss
, 
NULL
, mcmd, 
Œue
);

5330 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

5332 
rc
 = 
	`sc¡_ÿÎ_dev_sk_mgmt_â
(
mcmd
, 
tgt_dev
, 1);

5333 ià(
rc
 !ð
SCST_DEV_TM_NOT_COMPLETED
)

5334 
out_tm_dbg
;

5336 ià(
dev
->
scsi_dev
 !ð
NULL
) {

5337 
	`TRACE
(
TRACE_MGMT
, "Resetting host %d bus ",

5338 
dev
->
scsi_dev
->
ho¡
->
ho¡_no
);

5339 
rc
 = 
	`scsi_»£t_´ovid”
(
dev
->
scsi_dev
, 
SCSI_TRY_RESET_DEVICE
);

5341 ià(
rc
 !ð
SUCCESS
 && 
mcmd
->
¡©us
 =ð
SCST_MGMT_STATUS_SUCCESS
)

5342 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_FAILED
;

5349 
dev
->
scsi_dev
->
was_»£t
 = 0;

5352 
	`sc¡_unblock_abÜ‹d_cmds
(0);

5354 
out_tm_dbg
:

5355 
	`tm_dbg_sk_mgmt
(
mcmd
->
mcmd_tgt_dev
->
dev
, "LUN RESET", 0);

5357 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5359 
	`TRACE_EXIT_RES
(
»s
);

5360  
»s
;

5361 
	}
}

5364 
	$sc¡_do_Ãxus_loss_£ss
(
sc¡_mgmt_cmd
 *
mcmd
)

5366 
i
;

5367 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

5368 
sc¡_tgt_dev
 *
tgt_dev
;

5370 
	`TRACE_ENTRY
();

5372 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

5373 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

5374 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

5375 
	`sc¡_Ãxus_loss
(
tgt_dev
,

5376 (
mcmd
->
â
 !ð
SCST_UNREG_SESS_TM
));

5380 
	`TRACE_EXIT
();

5382 
	}
}

5385 
	$sc¡_abÜt_®l_Ãxus_loss_£ss
(
sc¡_mgmt_cmd
 *
mcmd
,

5386 
Ãxus_loss
)

5388 
»s
;

5389 
i
;

5390 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

5391 
sc¡_tgt_dev
 *
tgt_dev
;

5393 
	`TRACE_ENTRY
();

5395 ià(
Ãxus_loss
) {

5396 
	`TRACE_MGMT_DBG
("Nexus†oss for sess %p (mcmd %p)",

5397 
£ss
, 
mcmd
);

5399 
	`TRACE_MGMT_DBG
("Aborting‡ll from sess %p (mcmd %p)",

5400 
£ss
, 
mcmd
);

5403 
	`mu‹x_lock
(&
sc¡_mu‹x
);

5405 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

5406 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

5407 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
, 
£ss_tgt_dev_li¡_’Œy
) {

5408 
rc
;

5410 
	`__sc¡_abÜt_sk_£t
(
mcmd
, 
tgt_dev
);

5412 
rc
 = 
	`sc¡_ÿÎ_dev_sk_mgmt_â
(
mcmd
, 
tgt_dev
, 0);

5413 ià(
rc
 < 0 && 
mcmd
->
¡©us
 =ð
SCST_MGMT_STATUS_SUCCESS
)

5414 
mcmd
->
¡©us
 = 
rc
;

5416 
	`tm_dbg_sk_mgmt
(
tgt_dev
->
dev
, "NEXUS LOSS SESS or "

5418 (
mcmd
->
â
 =ð
SCST_UNREG_SESS_TM
));

5422 
	`sc¡_unblock_abÜ‹d_cmds
(1);

5424 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

5426 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5428 
	`TRACE_EXIT_RES
(
»s
);

5429  
»s
;

5430 
	}
}

5433 
	$sc¡_do_Ãxus_loss_tgt
(
sc¡_mgmt_cmd
 *
mcmd
)

5435 
i
;

5436 
sc¡_tgt
 *
tgt
 = 
mcmd
->
£ss
->tgt;

5437 
sc¡_£ssiÚ
 *
£ss
;

5439 
	`TRACE_ENTRY
();

5441 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
, 
£ss_li¡_’Œy
) {

5442 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

5443 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

5444 
sc¡_tgt_dev
 *
tgt_dev
;

5445 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

5446 
£ss_tgt_dev_li¡_’Œy
) {

5447 
	`sc¡_Ãxus_loss
(
tgt_dev
, 
Œue
);

5452 
	`TRACE_EXIT
();

5454 
	}
}

5456 
	$sc¡_abÜt_®l_Ãxus_loss_tgt
(
sc¡_mgmt_cmd
 *
mcmd
,

5457 
Ãxus_loss
)

5459 
»s
;

5460 
i
;

5461 
sc¡_tgt
 *
tgt
 = 
mcmd
->
£ss
->tgt;

5462 
sc¡_£ssiÚ
 *
£ss
;

5464 
	`TRACE_ENTRY
();

5466 ià(
Ãxus_loss
) {

5467 
	`TRACE_MGMT_DBG
("I_T Nexus†oss (tgt %p, mcmd %p)",

5468 
tgt
, 
mcmd
);

5470 
	`TRACE_MGMT_DBG
("Aborting‡ll fromgt %p (mcmd %p)",

5471 
tgt
, 
mcmd
);

5474 
	`mu‹x_lock
(&
sc¡_mu‹x
);

5476 
	`li¡_fÜ_—ch_’Œy
(
£ss
, &
tgt
->
£ss_li¡
, 
£ss_li¡_’Œy
) {

5477 
i
 = 0; i < 
SESS_TGT_DEV_LIST_HASH_SIZE
; i++) {

5478 
li¡_h—d
 *
h—d
 = &
£ss
->
£ss_tgt_dev_li¡
[
i
];

5479 
sc¡_tgt_dev
 *
tgt_dev
;

5480 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, 
h—d
,

5481 
£ss_tgt_dev_li¡_’Œy
) {

5482 
rc
;

5484 
	`__sc¡_abÜt_sk_£t
(
mcmd
, 
tgt_dev
);

5486 ià(
mcmd
->
£ss
 =ð
tgt_dev
->sess) {

5487 
rc
 = 
	`sc¡_ÿÎ_dev_sk_mgmt_â
(

5488 
mcmd
, 
tgt_dev
, 0);

5489 ià((
rc
 < 0) &&

5490 (
mcmd
->
¡©us
 =ð
SCST_MGMT_STATUS_SUCCESS
))

5491 
mcmd
->
¡©us
 = 
rc
;

5494 
	`tm_dbg_sk_mgmt
(
tgt_dev
->
dev
, "NEXUS LOSS or "

5500 
	`sc¡_unblock_abÜ‹d_cmds
(1);

5502 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

5504 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5506 
	`TRACE_EXIT_RES
(
»s
);

5507  
»s
;

5508 
	}
}

5510 
	$sc¡_abÜt_sk
(
sc¡_mgmt_cmd
 *
mcmd
)

5512 
»s
;

5513 
sc¡_cmd
 *
cmd
 = 
mcmd
->
cmd_to_abÜt
;

5515 
	`TRACE_ENTRY
();

5517 
	`TRACE_MGMT_DBG
("Abortingask (cmd %p, sn %d, set %d,ag %llu, "

5518 "queue_ty³ %x)", 
cmd
, cmd->
¢
, cmd->
¢_£t
,

5519 ()
mcmd
->
g
, 
cmd
->
queue_ty³
);

5521 ià(
mcmd
->
lun_£t
 && (mcmd->
lun
 !ð
cmd
->lun)) {

5522 
	`PRINT_ERROR
("ABORT TASK: LUN mismatch: mcmd LUN %llx, "

5524 ()
mcmd
->
lun
,

5525 ()
cmd
->
lun
,

5526 ()
mcmd
->
g
);

5527 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_REJECTED
;

5528 } ià(
mcmd
->
cmd_¢_£t
 &&

5529 (
	`sc¡_¢_befÜe
(
mcmd
->
cmd_¢
, 
cmd
->
tgt_¢
) ||

5530 (
mcmd
->
cmd_¢
 =ð
cmd
->
tgt_¢
))) {

5531 
	`PRINT_ERROR
("ABORT TASK: SN mismatch: mcmd SN %x, "

5532 "cmd SN %x, cmdag %Îu", 
mcmd
->
cmd_¢
,

5533 
cmd
->
tgt_¢
, ()
mcmd
->
g
);

5534 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_REJECTED
;

5536 
	`¥š_lock_œq
(&
cmd
->
£ss
->
£ss_li¡_lock
);

5537 
	`sc¡_abÜt_cmd
(
cmd
, 
mcmd
, 0, 1);

5538 
	`¥š_uÆock_œq
(&
cmd
->
£ss
->
£ss_li¡_lock
);

5540 
	`sc¡_unblock_abÜ‹d_cmds
(0);

5543 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5545 
mcmd
->
cmd_to_abÜt
 = 
NULL
;

5547 
	`__sc¡_cmd_put
(
cmd
);

5549 
	`TRACE_EXIT_RES
(
»s
);

5550  
»s
;

5551 
	}
}

5554 
	$sc¡_mgmt_cmd_exec
(
sc¡_mgmt_cmd
 *
mcmd
)

5556 
»s
 = 0;

5558 
	`TRACE_ENTRY
();

5560 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_SUCCESS
;

5562 
mcmd
->
â
) {

5563 
SCST_ABORT_TASK
:

5564 
»s
 = 
	`sc¡_abÜt_sk
(
mcmd
);

5567 
SCST_ABORT_TASK_SET
:

5568 
SCST_PR_ABORT_ALL
:

5569 
»s
 = 
	`sc¡_abÜt_sk_£t
(
mcmd
);

5572 
SCST_CLEAR_TASK_SET
:

5573 ià(
mcmd
->
mcmd_tgt_dev
->
dev
->
t¡
 ==

5574 
SCST_CONTR_MODE_SEP_TASK_SETS
)

5575 
»s
 = 
	`sc¡_abÜt_sk_£t
(
mcmd
);

5577 
»s
 = 
	`sc¡_þ—r_sk_£t
(
mcmd
);

5580 
SCST_LUN_RESET
:

5581 
»s
 = 
	`sc¡_lun_»£t
(
mcmd
);

5584 
SCST_TARGET_RESET
:

5585 
»s
 = 
	`sc¡_rg‘_»£t
(
mcmd
);

5588 
SCST_ABORT_ALL_TASKS_SESS
:

5589 
»s
 = 
	`sc¡_abÜt_®l_Ãxus_loss_£ss
(
mcmd
, 0);

5592 
SCST_NEXUS_LOSS_SESS
:

5593 
SCST_UNREG_SESS_TM
:

5594 
»s
 = 
	`sc¡_abÜt_®l_Ãxus_loss_£ss
(
mcmd
, 1);

5597 
SCST_ABORT_ALL_TASKS
:

5598 
»s
 = 
	`sc¡_abÜt_®l_Ãxus_loss_tgt
(
mcmd
, 0);

5601 
SCST_NEXUS_LOSS
:

5602 
»s
 = 
	`sc¡_abÜt_®l_Ãxus_loss_tgt
(
mcmd
, 1);

5605 
SCST_CLEAR_ACA
:

5606 ià(
	`sc¡_ÿÎ_dev_sk_mgmt_â
(
mcmd
, mcmd->
mcmd_tgt_dev
, 1) ==

5607 
SCST_DEV_TM_NOT_COMPLETED
) {

5608 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_FN_NOT_SUPPORTED
;

5611 
out_dÚe
;

5614 
	`PRINT_ERROR
("UnknowÀsk mªagem’ˆfunùiÚ %d", 
mcmd
->
â
);

5615 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_REJECTED
;

5616 
out_dÚe
;

5619 
out
:

5620 
	`TRACE_EXIT_RES
(
»s
);

5621  
»s
;

5623 
out_dÚe
:

5624 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5625 
out
;

5626 
	}
}

5628 
	$sc¡_ÿÎ_sk_mgmt_afãùed_cmds_dÚe
(
sc¡_mgmt_cmd
 *
mcmd
)

5630 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

5632 ià((
£ss
->
tgt
->
tg‰
->
sk_mgmt_afãùed_cmds_dÚe
 !ð
NULL
) &&

5633 (
mcmd
->
â
 !ð
SCST_UNREG_SESS_TM
) &&

5634 (
mcmd
->
â
 !ð
SCST_PR_ABORT_ALL
)) {

5635 
	`TRACE_DBG
("Callingarget %sask_mgmt_affected_cmds_done(%p)",

5636 
£ss
->
tgt
->
tg‰
->
Çme
, sess);

5637 
£ss
->
tgt
->
tg‰
->
	`sk_mgmt_afãùed_cmds_dÚe
(
mcmd
);

5638 
	`TRACE_MGMT_DBG
("Target's %sask_mgmt_affected_cmds_done() "

5639 "»tuºed", 
£ss
->
tgt
->
tg‰
->
Çme
);

5642 
	}
}

5644 
	$sc¡_mgmt_afãùed_cmds_dÚe
(
sc¡_mgmt_cmd
 *
mcmd
)

5646 
»s
;

5648 
	`TRACE_ENTRY
();

5650 
	`mu‹x_lock
(&
sc¡_mu‹x
);

5652 
mcmd
->
â
) {

5653 
SCST_NEXUS_LOSS_SESS
:

5654 
SCST_UNREG_SESS_TM
:

5655 
	`sc¡_do_Ãxus_loss_£ss
(
mcmd
);

5658 
SCST_NEXUS_LOSS
:

5659 
	`sc¡_do_Ãxus_loss_tgt
(
mcmd
);

5663 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

5665 
	`sc¡_ÿÎ_sk_mgmt_afãùed_cmds_dÚe
(
mcmd
);

5667 
»s
 = 
	`sc¡_£t_mcmd_Ãxt_¡©e
(
mcmd
);

5669 
	`TRACE_EXIT_RES
(
»s
);

5670  
»s
;

5671 
	}
}

5673 
	$sc¡_mgmt_cmd_£nd_dÚe
(
sc¡_mgmt_cmd
 *
mcmd
)

5675 
sc¡_deviû
 *
dev
;

5676 
sc¡_£ssiÚ
 *
£ss
 = 
mcmd
->sess;

5678 
	`TRACE_ENTRY
();

5680 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_FINISHED
;

5681 ià(
	`sc¡_is_¡riù_mgmt_â
(
mcmd
->
â
è&& (mcmd->
com¶‘ed_cmd_couÁ
 > 0))

5682 
mcmd
->
¡©us
 = 
SCST_MGMT_STATUS_TASK_NOT_EXIST
;

5684 ià(
mcmd
->
â
 < 
SCST_UNREG_SESS_TM
)

5685 
	`TRACE
(
TRACE_MGMT
, "TM fn %d (%p) finished, "

5686 "¡©u %d", 
mcmd
->
â
, mcmd, mcmd->
¡©us
);

5688 
	`TRACE_MGMT_DBG
("TM fn %d (%p) finished, "

5689 "¡©u %d", 
mcmd
->
â
, mcmd, mcmd->
¡©us
);

5691 ià(
mcmd
->
â
 =ð
SCST_PR_ABORT_ALL
) {

5692 
mcmd
->
Üigš_´_cmd
->
	`sc¡_cmd_dÚe
(mcmd->origin_pr_cmd,

5693 
SCST_CMD_STATE_DEFAULT
,

5694 
SCST_CONTEXT_THREAD
);

5695 } ià((
£ss
->
tgt
->
tg‰
->
sk_mgmt_â_dÚe
 !ð
NULL
) &&

5696 (
mcmd
->
â
 !ð
SCST_UNREG_SESS_TM
)) {

5697 
	`TRACE_DBG
("Callingarget %sask_mgmt_fn_done(%p)",

5698 
£ss
->
tgt
->
tg‰
->
Çme
, sess);

5699 
£ss
->
tgt
->
tg‰
->
	`sk_mgmt_â_dÚe
(
mcmd
);

5700 
	`TRACE_MGMT_DBG
("Target's %sask_mgmt_fn_done() "

5701 "»tuºed", 
£ss
->
tgt
->
tg‰
->
Çme
);

5704 ià(
mcmd
->
Ãeds_unblockšg
) {

5705 
mcmd
->
â
) {

5706 
SCST_LUN_RESET
:

5707 
SCST_CLEAR_TASK_SET
:

5708 
dev
 = 
mcmd
->
mcmd_tgt_dev
->dev;

5709 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

5710 
	`sc¡_unblock_dev
(
dev
);

5711 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

5714 
SCST_TARGET_RESET
:

5716 
sc¡_acg
 *
acg
 = 
mcmd
->
£ss
->acg;

5717 
sc¡_acg_dev
 *
acg_dev
;

5719 
	`mu‹x_lock
(&
sc¡_mu‹x
);

5720 
	`li¡_fÜ_—ch_’Œy
(
acg_dev
, &
acg
->
acg_dev_li¡
,

5721 
acg_dev_li¡_’Œy
) {

5722 
dev
 = 
acg_dev
->dev;

5723 
	`¥š_lock_bh
(&
dev
->
dev_lock
);

5724 
	`sc¡_unblock_dev
(
dev
);

5725 
	`¥š_uÆock_bh
(&
dev
->
dev_lock
);

5727 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

5732 
	`sBUG
();

5737 
mcmd
->
tgt_´iv
 = 
NULL
;

5739 
	`TRACE_EXIT
();

5741 
	}
}

5744 
	$sc¡_´oûss_mgmt_cmd
(
sc¡_mgmt_cmd
 *
mcmd
)

5746 
»s
 = 0;

5748 
	`TRACE_ENTRY
();

5755 
	`TRACE_DBG
("mcmd %p, s‹ %d", 
mcmd
, mcmd->
¡©e
);

5758 
mcmd
->
¡©e
) {

5759 
SCST_MCMD_STATE_INIT
:

5760 
»s
 = 
	`sc¡_mgmt_cmd_š™
(
mcmd
);

5761 ià(
»s
 != 0)

5762 
out
;

5765 
SCST_MCMD_STATE_EXEC
:

5766 ià(
	`sc¡_mgmt_cmd_exec
(
mcmd
))

5767 
out
;

5770 
SCST_MCMD_STATE_AFFECTED_CMDS_DONE
:

5771 ià(
	`sc¡_mgmt_afãùed_cmds_dÚe
(
mcmd
))

5772 
out
;

5775 
SCST_MCMD_STATE_DONE
:

5776 
	`sc¡_mgmt_cmd_£nd_dÚe
(
mcmd
);

5779 
SCST_MCMD_STATE_FINISHED
:

5780 
	`sc¡_ä“_mgmt_cmd
(
mcmd
);

5782 
out
;

5785 
	`PRINT_CRIT_ERROR
("Wrong mcmd %p state %d (fn %d, "

5787 "%d)", 
mcmd
, mcmd->
¡©e
, mcmd->
â
,

5788 
mcmd
->
cmd_fšish_wa™_couÁ
,

5789 
mcmd
->
cmd_dÚe_wa™_couÁ
);

5790 
	`sBUG
();

5791 
»s
 = -1;

5792 
out
;

5796 
out
:

5797 
	`TRACE_EXIT_RES
(
»s
);

5798  
»s
;

5799 
	}
}

5801 
šlše
 
	$‹¡_mgmt_cmd_li¡
()

5803 
»s
 = !
	`li¡_em±y
(&
sc¡_aùive_mgmt_cmd_li¡
) ||

5804 
	`uÆik–y
(
	`kth»ad_should_¡Ý
());

5805  
»s
;

5806 
	}
}

5808 
	$sc¡_tm_th»ad
(*
¬g
)

5810 
	`TRACE_ENTRY
();

5812 
	`PRINT_INFO
("Task mªagem’ˆth»ad s¹ed, PID %d", 
cu¼’t
->
pid
);

5814 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

5816 
	`£t_u£r_niû
(
cu¼’t
, -10);

5818 
	`¥š_lock_œq
(&
sc¡_mcmd_lock
);

5819 !
	`kth»ad_should_¡Ý
()) {

5820 
wa™_queue_t
 
wa™
;

5821 
	`š™_wa™queue_’Œy
(&
wa™
, 
cu¼’t
);

5823 ià(!
	`‹¡_mgmt_cmd_li¡
()) {

5824 
	`add_wa™_queue_exþusive
(&
sc¡_mgmt_cmd_li¡_wa™Q
,

5825 &
wa™
);

5827 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

5828 ià(
	`‹¡_mgmt_cmd_li¡
())

5830 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

5831 
	`scheduË
();

5832 
	`¥š_lock_œq
(&
sc¡_mcmd_lock
);

5834 
	`£t_cu¼’t_¡©e
(
TASK_RUNNING
);

5835 
	`»move_wa™_queue
(&
sc¡_mgmt_cmd_li¡_wa™Q
, &
wa™
);

5838 !
	`li¡_em±y
(&
sc¡_aùive_mgmt_cmd_li¡
)) {

5839 
rc
;

5840 
sc¡_mgmt_cmd
 *
mcmd
;

5841 
mcmd
 = 
	`li¡_’Œy
(
sc¡_aùive_mgmt_cmd_li¡
.
Ãxt
,

5842 
	`ty³of
(*
mcmd
), 
mgmt_cmd_li¡_’Œy
);

5843 
	`TRACE_MGMT_DBG
("Deleting mgmt cmd %p from‡ctive cmd "

5844 "li¡", 
mcmd
);

5845 
	`li¡_d–
(&
mcmd
->
mgmt_cmd_li¡_’Œy
);

5846 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

5847 
rc
 = 
	`sc¡_´oûss_mgmt_cmd
(
mcmd
);

5848 
	`¥š_lock_œq
(&
sc¡_mcmd_lock
);

5849 ià(
rc
 > 0) {

5850 ià(
	`‹¡_b™
(
SCST_FLAG_SUSPENDED
, &
sc¡_æags
) &&

5851 !
	`‹¡_b™
(
SCST_FLAG_SUSPENDING
,

5852 &
sc¡_æags
)) {

5853 
	`TRACE_MGMT_DBG
("Adding mgmt cmd %po "

5855 
mcmd
);

5856 
	`li¡_add
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

5857 &
sc¡_d–ayed_mgmt_cmd_li¡
);

5859 
	`TRACE_MGMT_DBG
("Adding mgmt cmd %po "

5861 
mcmd
);

5862 
	`li¡_add
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

5863 &
sc¡_aùive_mgmt_cmd_li¡
);

5868 
	`¥š_uÆock_œq
(&
sc¡_mcmd_lock
);

5874 
	`sBUG_ON
(!
	`li¡_em±y
(&
sc¡_aùive_mgmt_cmd_li¡
));

5876 
	`PRINT_INFO
("Task mªagem’ˆth»ad PID %d fšished", 
cu¼’t
->
pid
);

5878 
	`TRACE_EXIT
();

5880 
	}
}

5882 
sc¡_mgmt_cmd
 *
	$sc¡_´e_rx_mgmt_cmd
(
sc¡_£ssiÚ


5883 *
£ss
, 
â
, 
©omic
, *
tgt_´iv
)

5885 
sc¡_mgmt_cmd
 *
mcmd
 = 
NULL
;

5887 
	`TRACE_ENTRY
();

5889 ià(
	`uÆik–y
(
£ss
->
tgt
->
tg‰
->
sk_mgmt_â_dÚe
 =ð
NULL
)) {

5890 
	`PRINT_ERROR
("New mgmt cmd, butask_mgmt_fn_done() is NULL "

5891 "Ñ¬g‘ %s)", 
£ss
->
tgt
->
tg‰
->
Çme
);

5892 
out
;

5895 
mcmd
 = 
	`sc¡_®loc_mgmt_cmd
(
©omic
 ? 
GFP_ATOMIC
 : 
GFP_KERNEL
);

5896 ià(
mcmd
 =ð
NULL
) {

5897 
	`PRINT_CRIT_ERROR
("Lo¡ TM fÀ%d, in™ŸtÜ %s", 
â
,

5898 
£ss
->
š™ŸtÜ_Çme
);

5899 
out
;

5902 
mcmd
->
£ss
 = sess;

5903 
mcmd
->
â
 = fn;

5904 
mcmd
->
¡©e
 = 
SCST_MCMD_STATE_INIT
;

5905 
mcmd
->
tgt_´iv
 =gt_priv;

5907 ià(
â
 =ð
SCST_PR_ABORT_ALL
) {

5908 
	`©omic_šc
(&
mcmd
->
Üigš_´_cmd
->
´_abÜt_couÁ”
->
´_abÜt_³ndšg_út
);

5909 
	`©omic_šc
(&
mcmd
->
Üigš_´_cmd
->
´_abÜt_couÁ”
->
´_abÜtšg_út
);

5912 
out
:

5913 
	`TRACE_EXIT
();

5914  
mcmd
;

5915 
	}
}

5917 
	$sc¡_po¡_rx_mgmt_cmd
(
sc¡_£ssiÚ
 *
£ss
,

5918 
sc¡_mgmt_cmd
 *
mcmd
)

5920 
æags
;

5921 
»s
 = 0;

5923 
	`TRACE_ENTRY
();

5925 
	`sc¡_£ss_g‘
(
£ss
);

5927 ià(
	`uÆik–y
(
£ss
->
shut_pha£
 !ð
SCST_SESS_SPH_READY
)) {

5928 
	`PRINT_CRIT_ERROR
("New mgmt cmd while shutting downhe "

5929 "£ssiÚ %°shut_pha£ %ld", 
£ss
, sess->
shut_pha£
);

5930 
	`sBUG
();

5933 
	`loÿl_œq_§ve
(
æags
);

5935 
	`¥š_lock
(&
£ss
->
£ss_li¡_lock
);

5936 
	`©omic_šc
(&
£ss
->
£ss_cmd_couÁ
);

5938 ià(
	`uÆik–y
(
£ss
->
š™_pha£
 !ð
SCST_SESS_IPH_READY
)) {

5939 
£ss
->
š™_pha£
) {

5940 
SCST_SESS_IPH_INITING
:

5941 
	`TRACE_DBG
("Adding mcmd %po init deferred mcmd†ist",

5942 
mcmd
);

5943 
	`li¡_add_ž
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

5944 &
£ss
->
š™_deã¼ed_mcmd_li¡
);

5945 
out_uÆock
;

5946 
SCST_SESS_IPH_SUCCESS
:

5948 
SCST_SESS_IPH_FAILED
:

5949 
»s
 = -1;

5950 
out_uÆock
;

5952 
	`sBUG
();

5956 
	`¥š_uÆock
(&
£ss
->
£ss_li¡_lock
);

5958 
	`TRACE_MGMT_DBG
("Addšg mgmˆcmd %°tØaùivmgmˆcmd†i¡", 
mcmd
);

5959 
	`¥š_lock
(&
sc¡_mcmd_lock
);

5960 
	`li¡_add_ž
(&
mcmd
->
mgmt_cmd_li¡_’Œy
, &
sc¡_aùive_mgmt_cmd_li¡
);

5961 
	`¥š_uÆock
(&
sc¡_mcmd_lock
);

5963 
	`loÿl_œq_»¡Üe
(
æags
);

5965 
	`wake_up
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

5967 
out
:

5968 
	`TRACE_EXIT
();

5969  
»s
;

5971 
out_uÆock
:

5972 
	`¥š_uÆock
(&
£ss
->
£ss_li¡_lock
);

5973 
	`loÿl_œq_»¡Üe
(
æags
);

5974 
out
;

5975 
	}
}

5988 
	$sc¡_rx_mgmt_â
(
sc¡_£ssiÚ
 *
£ss
,

5989 cÚ¡ 
sc¡_rx_mgmt_·¿ms
 *
·¿ms
)

5991 
»s
 = -
EFAULT
;

5992 
sc¡_mgmt_cmd
 *
mcmd
 = 
NULL
;

5994 
	`TRACE_ENTRY
();

5996 
·¿ms
->
â
) {

5997 
SCST_ABORT_TASK
:

5998 
	`sBUG_ON
(!
·¿ms
->
g_£t
);

6000 
SCST_TARGET_RESET
:

6001 
SCST_ABORT_ALL_TASKS
:

6002 
SCST_NEXUS_LOSS
:

6005 
	`sBUG_ON
(!
·¿ms
->
lun_£t
);

6008 
mcmd
 = 
	`sc¡_´e_rx_mgmt_cmd
(
£ss
, 
·¿ms
->
â
,…¬ams->
©omic
,

6009 
·¿ms
->
tgt_´iv
);

6010 ià(
mcmd
 =ð
NULL
)

6011 
out
;

6013 ià(
·¿ms
->
lun_£t
) {

6014 
mcmd
->
lun
 = 
	`sc¡_uÅack_lun
(
·¿ms
->lun,…¬ams->
lun_Ën
);

6015 ià(
mcmd
->
lun
 =ð
NO_SUCH_LUN
)

6016 
out_ä“
;

6017 
mcmd
->
lun_£t
 = 1;

6020 ià(
·¿ms
->
g_£t
)

6021 
mcmd
->
g
 = 
·¿ms
->tag;

6023 
mcmd
->
cmd_¢_£t
 = 
·¿ms
->cmd_sn_set;

6024 
mcmd
->
cmd_¢
 = 
·¿ms
->cmd_sn;

6026 ià(
·¿ms
->
â
 < 
SCST_UNREG_SESS_TM
)

6027 
	`TRACE
(
TRACE_MGMT
, "TM fÀ%d (%p)", 
·¿ms
->
â
, 
mcmd
);

6029 
	`TRACE_MGMT_DBG
("TM fÀ%d (%p)", 
·¿ms
->
â
, 
mcmd
);

6031 
	`TRACE_MGMT_DBG
("sess=%p,ag_set %d,ag %lld,†un_set %d, "

6032 "lun=%Îd, cmd_¢_£ˆ%d, cmd_¢ %d,…riv %p", 
£ss
,

6033 
·¿ms
->
g_£t
,

6034 ()
·¿ms
->
g
,

6035 
·¿ms
->
lun_£t
,

6036 ()
mcmd
->
lun
,

6037 
·¿ms
->
cmd_¢_£t
,

6038 
·¿ms
->
cmd_¢
,

6039 
·¿ms
->
tgt_´iv
);

6041 ià(
	`sc¡_po¡_rx_mgmt_cmd
(
£ss
, 
mcmd
) != 0)

6042 
out_ä“
;

6044 
»s
 = 0;

6046 
out
:

6047 
	`TRACE_EXIT_RES
(
»s
);

6048  
»s
;

6050 
out_ä“
:

6051 
	`sc¡_ä“_mgmt_cmd
(
mcmd
);

6052 
mcmd
 = 
NULL
;

6053 
out
;

6054 
	}
}

6055 
EXPORT_SYMBOL
(
sc¡_rx_mgmt_â
);

6070 
boÞ
 
	$__wždcmp
(cÚ¡ *
wžd
, cÚ¡ *
¡ršg
, 
»cursiÚ_Ëv–
)

6072 cÚ¡ *
ý
 = 
NULL
, *
mp
 = NULL;

6074 (*
¡ršg
è&& (*
wžd
 != '*')) {

6075 ià((*
wžd
 =ð'!'è&& (
»cursiÚ_Ëv–
 == 0))

6076  !
	`__wždcmp
(++
wžd
, 
¡ršg
, ++
»cursiÚ_Ëv–
);

6078 ià((*
wžd
 !ð*
¡ršg
) && (*wild != '?'))

6079  
çl£
;

6081 
wžd
++;

6082 
¡ršg
++;

6085 *
¡ršg
) {

6086 ià((*
wžd
 =ð'!'è&& (
»cursiÚ_Ëv–
 == 0))

6087  !
	`__wždcmp
(++
wžd
, 
¡ršg
, ++
»cursiÚ_Ëv–
);

6089 ià(*
wžd
 == '*') {

6090 ià(!*++
wžd
)

6091  
Œue
;

6093 
mp
 = 
wžd
;

6094 
ý
 = 
¡ršg
+1;

6095 } ià((*
wžd
 =ð*
¡ršg
) || (*wild == '?')) {

6096 
wžd
++;

6097 
¡ršg
++;

6099 
wžd
 = 
mp
;

6100 
¡ršg
 = 
ý
++;

6104 *
wžd
 == '*')

6105 
wžd
++;

6107  !*
wžd
;

6108 
	}
}

6133 
boÞ
 
	$wždcmp
(cÚ¡ *
wžd
, cÚ¡ *
¡ršg
)

6135  
	`__wždcmp
(
wžd
, 
¡ršg
, 0);

6136 
	}
}

6138 #ifdeà
CONFIG_SCST_PROC


6141 
sc¡_acg
 *
	$sc¡_fšd_acg_by_Çme_wžd
(cÚ¡ *
š™ŸtÜ_Çme
)

6143 
sc¡_acg
 *
acg
, *
»s
 = 
NULL
;

6144 
sc¡_aú
 *
n
;

6146 
	`TRACE_ENTRY
();

6148 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

6149 
	`li¡_fÜ_—ch_’Œy
(
n
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

6150 ià(
	`wždcmp
(
n
->
Çme
, 
š™ŸtÜ_Çme
)) {

6151 
	`TRACE_DBG
("Access control group %s found",

6152 
acg
->
acg_Çme
);

6153 
»s
 = 
acg
;

6154 
out
;

6159 
out
:

6160 
	`TRACE_EXIT_HRES
(
»s
);

6161  
»s
;

6162 
	}
}

6165 
sc¡_acg
 *
	$sc¡_fšd_acg_by_Çme
(cÚ¡ *
acg_Çme
)

6167 
sc¡_acg
 *
acg
, *
»s
 = 
NULL
;

6169 
	`TRACE_ENTRY
();

6171 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
sc¡_acg_li¡
, 
acg_li¡_’Œy
) {

6172 ià(
	`¡rcmp
(
acg
->
acg_Çme
,‡cg_name) == 0) {

6173 
	`TRACE_DBG
("Access control group %s found",

6174 
acg
->
acg_Çme
);

6175 
»s
 = 
acg
;

6176 
out
;

6180 
out
:

6181 
	`TRACE_EXIT_HRES
(
»s
);

6182  
»s
;

6183 
	}
}

6188 
sc¡_acg
 *
	$sc¡_fšd_tgt_acg_by_Çme_wžd
(
sc¡_tgt
 *
tgt
,

6189 cÚ¡ *
š™ŸtÜ_Çme
)

6191 
sc¡_acg
 *
acg
, *
»s
 = 
NULL
;

6192 
sc¡_aú
 *
n
;

6194 
	`TRACE_ENTRY
();

6196 ià(
š™ŸtÜ_Çme
 =ð
NULL
)

6197 
out
;

6199 
	`li¡_fÜ_—ch_’Œy
(
acg
, &
tgt
->
tgt_acg_li¡
, 
acg_li¡_’Œy
) {

6200 
	`li¡_fÜ_—ch_’Œy
(
n
, &
acg
->
aú_li¡
, 
aú_li¡_’Œy
) {

6201 ià(
	`wždcmp
(
n
->
Çme
, 
š™ŸtÜ_Çme
)) {

6202 
	`TRACE_DBG
("Access control group %s found",

6203 
acg
->
acg_Çme
);

6204 
»s
 = 
acg
;

6205 
out
;

6210 
out
:

6211 
	`TRACE_EXIT_HRES
(
»s
);

6212  
»s
;

6213 
	}
}

6218 
sc¡_acg
 *
	$__sc¡_fšd_acg
(
sc¡_tgt
 *
tgt
,

6219 cÚ¡ *
š™ŸtÜ_Çme
)

6221 
sc¡_acg
 *
acg
 = 
NULL
;

6223 
	`TRACE_ENTRY
();

6225 #ifdeà
CONFIG_SCST_PROC


6226 ià(
š™ŸtÜ_Çme
)

6227 
acg
 = 
	`sc¡_fšd_acg_by_Çme_wžd
(
š™ŸtÜ_Çme
);

6228 ià((
acg
 =ð
NULL
è&& (
tgt
->
deçuÉ_group_Çme
 != NULL))

6229 
acg
 = 
	`sc¡_fšd_acg_by_Çme
(
tgt
->
deçuÉ_group_Çme
);

6230 ià(
acg
 =ð
NULL
)

6231 
acg
 = 
sc¡_deçuÉ_acg
;

6233 
acg
 = 
	`sc¡_fšd_tgt_acg_by_Çme_wžd
(
tgt
, 
š™ŸtÜ_Çme
);

6234 ià(
acg
 =ð
NULL
)

6235 
acg
 = 
tgt
->
deçuÉ_acg
;

6238 
	`TRACE_EXIT_HRES
(()
acg
);

6239  
acg
;

6240 
	}
}

6243 
sc¡_acg
 *
	$sc¡_fšd_acg
(cÚ¡ 
sc¡_£ssiÚ
 *
£ss
)

6245  
	`__sc¡_fšd_acg
(
£ss
->
tgt
, sess->
š™ŸtÜ_Çme
);

6246 
	}
}

6254 
boÞ
 
	$sc¡_š™ŸtÜ_has_luns
(
sc¡_tgt
 *
tgt
, cÚ¡ *
š™ŸtÜ_Çme
)

6256 
boÞ
 
»s
;

6257 
sc¡_acg
 *
acg
;

6259 
	`TRACE_ENTRY
();

6261 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6263 
acg
 = 
	`__sc¡_fšd_acg
(
tgt
, 
š™ŸtÜ_Çme
);

6265 
»s
 = !
	`li¡_em±y
(&
acg
->
acg_dev_li¡
);

6267 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6269 
	`TRACE_EXIT_RES
(
»s
);

6270  
»s
;

6271 
	}
}

6272 
EXPORT_SYMBOL_GPL
(
sc¡_š™ŸtÜ_has_luns
);

6274 
	$sc¡_š™_£ssiÚ
(
sc¡_£ssiÚ
 *
£ss
)

6276 
»s
 = 0;

6277 
sc¡_cmd
 *
cmd
;

6278 
sc¡_mgmt_cmd
 *
mcmd
, *
tm
;

6279 
mwake
 = 0;

6281 
	`TRACE_ENTRY
();

6283 
	`mu‹x_lock
(&
sc¡_mu‹x
);

6285 
£ss
->
acg
 = 
	`sc¡_fšd_acg
(sess);

6287 
	`PRINT_INFO
("Using security group \"%s\" for initiator \"%s\" "

6288 "Ñ¬g‘ %s)", 
£ss
->
acg
->
acg_Çme
, sess->
š™ŸtÜ_Çme
,

6289 
£ss
->
tgt
->
tgt_Çme
);

6291 
	`li¡_add_ž
(&
£ss
->
acg_£ss_li¡_’Œy
, &£ss->
acg
->
acg_£ss_li¡
);

6293 
	`TRACE_DBG
("Addšg ses %°tØtgt->£ss_li¡", 
£ss
);

6294 
	`li¡_add_ž
(&
£ss
->
£ss_li¡_’Œy
, &£ss->
tgt
->
£ss_li¡
);

6296 ià(
£ss
->
tgt
->
tg‰
->
g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
 !ð
NULL
) {

6297 
»s
 = 
£ss
->
tgt
->
tg‰
->
	`g‘_š™ŸtÜ_pÜt_Œª¥Üt_id
(

6298 
£ss
->
tgt
, sess, &£ss->
Œª¥Üt_id
);

6299 ià(
»s
 != 0) {

6300 
	`PRINT_ERROR
("Unableo make initiator %s…ort "

6301 "Œª¥Üˆid", 
£ss
->
š™ŸtÜ_Çme
);

6302 
çžed
;

6304 
	`TRACE_PR
("£s %°(š˜%s),¿n¥Üˆid %s/%d", 
£ss
,

6305 
£ss
->
š™ŸtÜ_Çme
,

6306 
	`debug_Œª¥Üt_id_to_š™ŸtÜ_Çme
(

6307 
£ss
->
Œª¥Üt_id
), sess->
tgt
->
»l_tgt_id
);

6310 
»s
 = 
	`sc¡_£ss_sysfs_ü—‹
(
£ss
);

6311 ià(
»s
 != 0)

6312 
çžed
;

6318 
»s
 = 
	`sc¡_£ss_®loc_tgt_devs
(
£ss
);

6320 
çžed
:

6321 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

6323 ià(
£ss
->
š™_»suÉ_â
) {

6324 
	`TRACE_DBG
("C®lšg in™_»suÉ_â(%p)", 
£ss
);

6325 
£ss
->
	`š™_»suÉ_â
(£ss, sess->
»g_£ss_d©a
, 
»s
);

6326 
	`TRACE_DBG
("%s", "init_result_fn()„eturned");

6329 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

6331 ià(
»s
 == 0)

6332 
£ss
->
š™_pha£
 = 
SCST_SESS_IPH_SUCCESS
;

6334 
£ss
->
š™_pha£
 = 
SCST_SESS_IPH_FAILED
;

6336 
»¡¬t
:

6337 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
š™_deã¼ed_cmd_li¡
,

6338 
cmd_li¡_’Œy
) {

6339 
	`TRACE_DBG
("D–‘šg cmd %°äom in™ deã¼ed cmd†i¡", 
cmd
);

6340 
	`li¡_d–
(&
cmd
->
cmd_li¡_’Œy
);

6341 
	`©omic_dec
(&
£ss
->
£ss_cmd_couÁ
);

6342 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

6343 
	`sc¡_cmd_š™_dÚe
(
cmd
, 
SCST_CONTEXT_THREAD
);

6344 
	`¥š_lock_œq
(&
£ss
->
£ss_li¡_lock
);

6345 
»¡¬t
;

6348 
	`¥š_lock
(&
sc¡_mcmd_lock
);

6349 
	`li¡_fÜ_—ch_’Œy_§ã
(
mcmd
, 
tm
, &
£ss
->
š™_deã¼ed_mcmd_li¡
,

6350 
mgmt_cmd_li¡_’Œy
) {

6351 
	`TRACE_DBG
("Moving mgmt command %p from init deferred mcmd†ist",

6352 
mcmd
);

6353 
	`li¡_move_ž
(&
mcmd
->
mgmt_cmd_li¡_’Œy
,

6354 &
sc¡_aùive_mgmt_cmd_li¡
);

6355 
mwake
 = 1;

6358 
	`¥š_uÆock
(&
sc¡_mcmd_lock
);

6363 
£ss
->
š™_pha£
 = 
SCST_SESS_IPH_READY
;

6364 
	`¥š_uÆock_œq
(&
£ss
->
£ss_li¡_lock
);

6366 ià(
mwake
)

6367 
	`wake_up
(&
sc¡_mgmt_cmd_li¡_wa™Q
);

6369 
	`sc¡_£ss_put
(
£ss
);

6371 
	`TRACE_EXIT
();

6372  
»s
;

6373 
	}
}

6418 
sc¡_£ssiÚ
 *
sc¡_»gi¡”_£ssiÚ
(
sc¡_tgt
 *
tgt
, 
©omic
,

6419 cÚ¡ *
š™ŸtÜ_Çme
, *
tgt_´iv
, *
»suÉ_â_d©a
,

6420 (*
»suÉ_â
è(
sc¡_£ssiÚ
 *
£ss
, *
d©a
, 
»suÉ
))

6422 
sc¡_£ssiÚ
 *
£ss
;

6423 
»s
;

6424 
æags
;

6426 
	`TRACE_ENTRY
();

6428 
£ss
 = 
	`sc¡_®loc_£ssiÚ
(
tgt
, 
©omic
 ? 
GFP_ATOMIC
 : 
GFP_KERNEL
,

6429 
š™ŸtÜ_Çme
);

6430 ià(
£ss
 =ð
NULL
)

6431 
out
;

6433 
	`sc¡_£ss_£t_tgt_´iv
(
£ss
, 
tgt_´iv
);

6435 
	`sc¡_£ss_g‘
(
£ss
);

6436 
	`sc¡_£ss_g‘
(
£ss
);

6438 ià(
©omic
) {

6439 
£ss
->
»g_£ss_d©a
 = 
»suÉ_â_d©a
;

6440 
£ss
->
š™_»suÉ_â
 = 
»suÉ_â
;

6441 
	`¥š_lock_œq§ve
(&
sc¡_mgmt_lock
, 
æags
);

6442 
	`TRACE_DBG
("Addšg ses %°tØsc¡_£ss_š™_li¡", 
£ss
);

6443 
	`li¡_add_ž
(&
£ss
->
£ss_š™_li¡_’Œy
,

6444 &
sc¡_£ss_š™_li¡
);

6445 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mgmt_lock
, 
æags
);

6446 
	`wake_up
(&
sc¡_mgmt_wa™Q
);

6448 
»s
 = 
	`sc¡_š™_£ssiÚ
(
£ss
);

6449 ià(
»s
 != 0)

6450 
out_ä“
;

6453 
out
:

6454 
	`TRACE_EXIT
();

6455  
£ss
;

6457 
out_ä“
:

6458 
	`sc¡_ä“_£ssiÚ
(
£ss
);

6459 
£ss
 = 
NULL
;

6460 
out
;

6461 
	}
}

6462 
EXPORT_SYMBOL_GPL
(
sc¡_»gi¡”_£ssiÚ
);

6476 
sc¡_£ssiÚ
 *
	$sc¡_»gi¡”_£ssiÚ_nÚ_g¶
(
sc¡_tgt
 *
tgt
,

6477 cÚ¡ *
š™ŸtÜ_Çme
, *
tgt_´iv
)

6479  
	`sc¡_»gi¡”_£ssiÚ
(
tgt
, 0, 
š™ŸtÜ_Çme
, 
tgt_´iv
,

6480 
NULL
, NULL);

6481 
	}
}

6482 
EXPORT_SYMBOL
(
sc¡_»gi¡”_£ssiÚ_nÚ_g¶
);

6517 
sc¡_uÄegi¡”_£ssiÚ
(
sc¡_£ssiÚ
 *
£ss
, 
wa™
,

6518 (*
uÄeg_dÚe_â
è(
sc¡_£ssiÚ
 *
£ss
))

6520 
æags
;

6521 
	`DECLARE_COMPLETION_ONSTACK
(
c
);

6522 
rc
, 
lun
;

6524 
	`TRACE_ENTRY
();

6526 
	`TRACE_MGMT_DBG
("UÄegi¡”šg sessiÚ %°(wa™ %d)", 
£ss
, 
wa™
);

6528 
£ss
->
uÄeg_dÚe_â
 = unreg_done_fn;

6531 
lun
 = 0;

6532 
rc
 = 
	`sc¡_rx_mgmt_â_lun
(
£ss
, 
SCST_UNREG_SESS_TM
,

6533 (
ušt8_t
 *)&
lun
, Öun), 
SCST_ATOMIC
, 
NULL
);

6534 ià(
rc
 != 0) {

6535 
	`PRINT_ERROR
("SCST_UNREG_SESS_TM failed %d (sess %p)",

6536 
rc
, 
£ss
);

6539 
£ss
->
shut_pha£
 = 
SCST_SESS_SPH_SHUTDOWN
;

6541 
	`¥š_lock_œq§ve
(&
sc¡_mgmt_lock
, 
æags
);

6543 ià(
wa™
)

6544 
£ss
->
shutdown_com¶
 = &
c
;

6546 
	`¥š_uÆock_œq»¡Üe
(&
sc¡_mgmt_lock
, 
æags
);

6548 
	`sc¡_£ss_put
(
£ss
);

6550 ià(
wa™
) {

6551 
	`TRACE_DBG
("Wa™šg fÜ sessiÚ %°tØcom¶‘e", 
£ss
);

6552 
	`wa™_fÜ_com¶‘iÚ
(&
c
);

6555 
	`TRACE_EXIT
();

6557 
	}
}

6558 
EXPORT_SYMBOL_GPL
(
sc¡_uÄegi¡”_£ssiÚ
);

6568 
	$sc¡_uÄegi¡”_£ssiÚ_nÚ_g¶
(
sc¡_£ssiÚ
 *
£ss
)

6570 
	`TRACE_ENTRY
();

6572 
	`sc¡_uÄegi¡”_£ssiÚ
(
£ss
, 1, 
NULL
);

6574 
	`TRACE_EXIT
();

6576 
	}
}

6577 
EXPORT_SYMBOL
(
sc¡_uÄegi¡”_£ssiÚ_nÚ_g¶
);

6579 
šlše
 
	$‹¡_mgmt_li¡
()

6581 
»s
 = !
	`li¡_em±y
(&
sc¡_£ss_š™_li¡
) ||

6582 !
	`li¡_em±y
(&
sc¡_£ss_shut_li¡
) ||

6583 
	`uÆik–y
(
	`kth»ad_should_¡Ý
());

6584  
»s
;

6585 
	}
}

6587 
	$sc¡_glob®_mgmt_th»ad
(*
¬g
)

6589 
sc¡_£ssiÚ
 *
£ss
;

6591 
	`TRACE_ENTRY
();

6593 
	`PRINT_INFO
("Mªagem’ˆth»ad s¹ed, PID %d", 
cu¼’t
->
pid
);

6595 
cu¼’t
->
æags
 |ð
PF_NOFREEZE
;

6597 
	`£t_u£r_niû
(
cu¼’t
, -10);

6599 
	`¥š_lock_œq
(&
sc¡_mgmt_lock
);

6600 !
	`kth»ad_should_¡Ý
()) {

6601 
wa™_queue_t
 
wa™
;

6602 
	`š™_wa™queue_’Œy
(&
wa™
, 
cu¼’t
);

6604 ià(!
	`‹¡_mgmt_li¡
()) {

6605 
	`add_wa™_queue_exþusive
(&
sc¡_mgmt_wa™Q
, &
wa™
);

6607 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

6608 ià(
	`‹¡_mgmt_li¡
())

6610 
	`¥š_uÆock_œq
(&
sc¡_mgmt_lock
);

6611 
	`scheduË
();

6612 
	`¥š_lock_œq
(&
sc¡_mgmt_lock
);

6614 
	`£t_cu¼’t_¡©e
(
TASK_RUNNING
);

6615 
	`»move_wa™_queue
(&
sc¡_mgmt_wa™Q
, &
wa™
);

6618 !
	`li¡_em±y
(&
sc¡_£ss_š™_li¡
)) {

6619 
£ss
 = 
	`li¡_’Œy
(
sc¡_£ss_š™_li¡
.
Ãxt
,

6620 
	`ty³of
(*
£ss
), 
£ss_š™_li¡_’Œy
);

6621 
	`TRACE_DBG
("Removing sess %p from scst_sess_init_list",

6622 
£ss
);

6623 
	`li¡_d–
(&
£ss
->
£ss_š™_li¡_’Œy
);

6624 
	`¥š_uÆock_œq
(&
sc¡_mgmt_lock
);

6626 ià(
£ss
->
š™_pha£
 =ð
SCST_SESS_IPH_INITING
)

6627 
	`sc¡_š™_£ssiÚ
(
£ss
);

6629 
	`PRINT_CRIT_ERROR
("session %p is in "

6631 "š™…ha£ %x", 
£ss
,

6632 
£ss
->
š™_pha£
);

6633 
	`sBUG
();

6636 
	`¥š_lock_œq
(&
sc¡_mgmt_lock
);

6639 !
	`li¡_em±y
(&
sc¡_£ss_shut_li¡
)) {

6640 
£ss
 = 
	`li¡_’Œy
(
sc¡_£ss_shut_li¡
.
Ãxt
,

6641 
	`ty³of
(*
£ss
), 
£ss_shut_li¡_’Œy
);

6642 
	`TRACE_DBG
("Removing sess %p from scst_sess_shut_list",

6643 
£ss
);

6644 
	`li¡_d–
(&
£ss
->
£ss_shut_li¡_’Œy
);

6645 
	`¥š_uÆock_œq
(&
sc¡_mgmt_lock
);

6647 
£ss
->
shut_pha£
) {

6648 
SCST_SESS_SPH_SHUTDOWN
:

6649 
	`sBUG_ON
(
	`©omic_»ad
(&
£ss
->
»fút
) != 0);

6650 
	`sc¡_ä“_£ssiÚ_ÿÎback
(
£ss
);

6653 
	`PRINT_CRIT_ERROR
("session %p is in "

6655 "shuˆpha£ %lx", 
£ss
,

6656 
£ss
->
shut_pha£
);

6657 
	`sBUG
();

6661 
	`¥š_lock_œq
(&
sc¡_mgmt_lock
);

6664 
	`¥š_uÆock_œq
(&
sc¡_mgmt_lock
);

6670 
	`sBUG_ON
(!
	`li¡_em±y
(&
sc¡_£ss_š™_li¡
));

6671 
	`sBUG_ON
(!
	`li¡_em±y
(&
sc¡_£ss_shut_li¡
));

6673 
	`PRINT_INFO
("Mªagem’ˆth»ad PID %d fšished", 
cu¼’t
->
pid
);

6675 
	`TRACE_EXIT
();

6677 
	}
}

6680 
sc¡_cmd
 *
	$__sc¡_fšd_cmd_by_g
(
sc¡_£ssiÚ
 *
£ss
,

6681 
ušt64_t
 
g
, 
boÞ
 
to_abÜt
)

6683 
sc¡_cmd
 *
cmd
, *
»s
 = 
NULL
;

6685 
	`TRACE_ENTRY
();

6689 
	`TRACE_DBG
("%s (sess=%p,ag=%llu)", "Searching in sess cmd†ist",

6690 
£ss
, ()
g
);

6692 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
,

6693 
£ss_cmd_li¡_’Œy
) {

6694 ià(
cmd
->
g
 ==ag) {

6704 ià(
cmd
->
dÚe
) {

6705 ià(
to_abÜt
) {

6710 ià(
»s
 =ð
NULL
)

6711 
»s
 = 
cmd
;

6713 ià(
	`‹¡_b™
(
SCST_CMD_ABORTED
,

6714 &
»s
->
cmd_æags
)) {

6715 
»s
 = 
cmd
;

6716 } ià(!
	`‹¡_b™
(
SCST_CMD_ABORTED
,

6717 &
cmd
->
cmd_æags
))

6718 
»s
 = 
cmd
;

6723 
»s
 = 
cmd
;

6729 
	`TRACE_EXIT
();

6730  
»s
;

6731 
	}
}

6740 
sc¡_cmd
 *
sc¡_fšd_cmd
(
sc¡_£ssiÚ
 *
£ss
, *
d©a
,

6741 (*
cmp_â
è(
sc¡_cmd
 *
cmd
,

6742 *
d©a
))

6744 
sc¡_cmd
 *
cmd
 = 
NULL
;

6745 
æags
 = 0;

6747 
	`TRACE_ENTRY
();

6749 ià(
cmp_â
 =ð
NULL
)

6750 
out
;

6752 
	`¥š_lock_œq§ve
(&
£ss
->
£ss_li¡_lock
, 
æags
);

6754 
	`TRACE_DBG
("S—rchšg iÀ£s cmd†i¡ (£ss=%p)", 
£ss
);

6755 
	`li¡_fÜ_—ch_’Œy
(
cmd
, &
£ss
->
£ss_cmd_li¡
, 
£ss_cmd_li¡_’Œy
) {

6763 ià(
cmd
->
dÚe
)

6765 ià(
	`cmp_â
(
cmd
, 
d©a
))

6766 
out_uÆock
;

6769 
cmd
 = 
NULL
;

6771 
out_uÆock
:

6772 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

6774 
out
:

6775 
	`TRACE_EXIT
();

6776  
cmd
;

6777 
	}
}

6778 
EXPORT_SYMBOL
(
sc¡_fšd_cmd
);

6787 
sc¡_cmd
 *
	$sc¡_fšd_cmd_by_g
(
sc¡_£ssiÚ
 *
£ss
,

6788 
ušt64_t
 
g
)

6790 
æags
;

6791 
sc¡_cmd
 *
cmd
;

6792 
	`¥š_lock_œq§ve
(&
£ss
->
£ss_li¡_lock
, 
æags
);

6793 
cmd
 = 
	`__sc¡_fšd_cmd_by_g
(
£ss
, 
g
, 
çl£
);

6794 
	`¥š_uÆock_œq»¡Üe
(&
£ss
->
£ss_li¡_lock
, 
æags
);

6795  
cmd
;

6796 
	}
}

6797 
EXPORT_SYMBOL
(
sc¡_fšd_cmd_by_g
);

	@/root/Desktop/scst-2.2.0/src/scst_tg.c

18 
	~<asm/uÇligÃd.h
>

19 #ifdeà
INSIDE_KERNEL_TREE


20 
	~<sc¡/sc¡.h
>

22 
	~"sc¡.h
"

24 
	~"sc¡_´iv.h
"

26 
li¡_h—d
 
	gsc¡_dev_group_li¡
;

29 
sc¡_deviû
 *
	$__lookup_dev
(cÚ¡ *
Çme
)

31 
sc¡_deviû
 *
dev
;

33 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
sc¡_dev_li¡
, 
dev_li¡_’Œy
)

34 ià(
	`¡rcmp
(
dev
->
vœt_Çme
, 
Çme
) == 0)

35  
dev
;

37  
NULL
;

38 
	}
}

41 
sc¡_tgt
 *
	$__lookup_tgt
(cÚ¡ *
Çme
)

43 
sc¡_tgt_‹m¶©e
 *
t
;

44 
sc¡_tgt
 *
tgt
;

46 
	`li¡_fÜ_—ch_’Œy
(
t
, &
sc¡_‹m¶©e_li¡
, 
sc¡_‹m¶©e_li¡_’Œy
)

47 
	`li¡_fÜ_—ch_’Œy
(
tgt
, &
t
->
tgt_li¡
, 
tgt_li¡_’Œy
)

48 ià(
	`¡rcmp
(
tgt
->
tgt_Çme
, 
Çme
) == 0)

49  
tgt
;

51  
NULL
;

52 
	}
}

55 
sc¡_tg_tgt
 *
	$__lookup_dg_tgt
(
sc¡_dev_group
 *
dg
,

56 cÚ¡ *
tgt_Çme
)

58 
sc¡_rg‘_group
 *
tg
;

59 
sc¡_tg_tgt
 *
tg_tgt
;

61 
	`BUG_ON
(!
dg
);

62 
	`BUG_ON
(!
tgt_Çme
);

63 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
)

64 
	`li¡_fÜ_—ch_’Œy
(
tg_tgt
, &
tg
->
tgt_li¡
, 
’Œy
)

65 ià(
	`¡rcmp
(
tg_tgt
->
Çme
, 
tgt_Çme
) == 0)

66  
tg_tgt
;

68  
NULL
;

69 
	}
}

72 
sc¡_rg‘_group
 *

73 
	$__lookup_tg_by_Çme
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
)

75 
sc¡_rg‘_group
 *
tg
;

77 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
)

78 ià(
	`¡rcmp
(
tg
->
Çme
,‚ame) == 0)

79  
tg
;

81  
NULL
;

82 
	}
}

85 
sc¡_dg_dev
 *
	$__lookup_dg_dev_by_dev
(
sc¡_dev_group
 *
dg
,

86 
sc¡_deviû
 *
dev
)

88 
sc¡_dg_dev
 *
dgd
;

90 
	`li¡_fÜ_—ch_’Œy
(
dgd
, &
dg
->
dev_li¡
, 
’Œy
)

91 ià(
dgd
->
dev
 == dev)

92  
dgd
;

94  
NULL
;

95 
	}
}

98 
sc¡_dg_dev
 *
	$__lookup_dg_dev_by_Çme
(
sc¡_dev_group
 *
dg
,

99 cÚ¡ *
Çme
)

101 
sc¡_dg_dev
 *
dgd
;

103 
	`li¡_fÜ_—ch_’Œy
(
dgd
, &
dg
->
dev_li¡
, 
’Œy
)

104 ià(
	`¡rcmp
(
dgd
->
dev
->
vœt_Çme
, 
Çme
) == 0)

105  
dgd
;

107  
NULL
;

108 
	}
}

111 
sc¡_dg_dev
 *
	$__glob®_lookup_dg_dev_by_Çme
(cÚ¡ *
Çme
)

113 
sc¡_dev_group
 *
dg
;

114 
sc¡_dg_dev
 *
dgd
;

116 
	`li¡_fÜ_—ch_’Œy
(
dg
, &
sc¡_dev_group_li¡
, 
’Œy
) {

117 
dgd
 = 
	`__lookup_dg_dev_by_Çme
(
dg
, 
Çme
);

118 ià(
dgd
)

119  
dgd
;

121  
NULL
;

122 
	}
}

125 
sc¡_dev_group
 *
	$__lookup_dg_by_Çme
(cÚ¡ *
Çme
)

127 
sc¡_dev_group
 *
dg
;

129 
	`li¡_fÜ_—ch_’Œy
(
dg
, &
sc¡_dev_group_li¡
, 
’Œy
)

130 ià(
	`¡rcmp
(
dg
->
Çme
,‚ame) == 0)

131  
dg
;

133  
NULL
;

134 
	}
}

137 
sc¡_dev_group
 *
	$__lookup_dg_by_dev
(
sc¡_deviû
 *
dev
)

139 
sc¡_dev_group
 *
dg
;

141 
	`li¡_fÜ_—ch_’Œy
(
dg
, &
sc¡_dev_group_li¡
, 
’Œy
)

142 ià(
	`__lookup_dg_dev_by_dev
(
dg
, 
dev
))

143  
dg
;

145  
NULL
;

146 
	}
}

152 
	$sc¡_»Ëa£_tg_tgt
(
kobjeù
 *
kobj
)

154 
sc¡_tg_tgt
 *
tg_tgt
;

156 
tg_tgt
 = 
	`cÚš”_of
(
kobj
, 
sc¡_tg_tgt
, kobj);

157 
	`kä“
(
tg_tgt
->
Çme
);

158 
	`kä“
(
tg_tgt
);

159 
	}
}

161 
kobj_ty³
 
	gsc¡_tg_tgt_kty³
 = {

162 #iâdeà
CONFIG_SCST_PROC


163 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

165 .
	g»Ëa£
 = 
sc¡_»Ëa£_tg_tgt
,

171 
	$sc¡_tg_tgt_add
(
sc¡_rg‘_group
 *
tg
, cÚ¡ *
Çme
)

173 
sc¡_tg_tgt
 *
tg_tgt
;

174 
sc¡_tgt
 *
tgt
;

175 
»s
;

177 
	`TRACE_ENTRY
();

178 
	`BUG_ON
(!
tg
);

179 
	`BUG_ON
(!
Çme
);

180 
»s
 = -
ENOMEM
;

181 
tg_tgt
 = 
	`kz®loc
( *tg_tgt, 
GFP_KERNEL
);

182 ià(!
tg_tgt
)

183 
out
;

184 
tg_tgt
->
tg
 =g;

185 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 24)

186 
	`kobjeù_š™
(&
tg_tgt
->
kobj
, &
sc¡_tg_tgt_kty³
);

188 
	`kobjeù_š™
(&
tg_tgt
->
kobj
);

189 
tg_tgt
->
kobj
.
kty³
 = &
sc¡_tg_tgt_kty³
;

191 
tg_tgt
->
Çme
 = 
	`k¡rdup
Òame, 
GFP_KERNEL
);

192 ià(!
tg_tgt
->
Çme
)

193 
out_put
;

195 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

196 ià(
»s
)

197 
out_put
;

198 
»s
 = -
EEXIST
;

199 
tgt
 = 
	`__lookup_tgt
(
Çme
);

200 ià(
	`__lookup_dg_tgt
(
tg
->
dg
, 
Çme
))

201 
out_uÆock
;

202 
tg_tgt
->
tgt
 =gt;

203 
»s
 = 
	`sc¡_tg_tgt_sysfs_add
(
tg
, 
tg_tgt
);

204 ià(
»s
)

205 
out_uÆock
;

206 
	`li¡_add_ž
(&
tg_tgt
->
’Œy
, &
tg
->
tgt_li¡
);

207 
»s
 = 0;

208 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

209 
out
:

210 
	`TRACE_EXIT_RES
(
»s
);

211  
»s
;

212 
out_uÆock
:

213 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

214 
out_put
:

215 
	`kobjeù_put
(&
tg_tgt
->
kobj
);

216 
out
;

217 
	}
}

219 
	$__sc¡_tg_tgt_»move
(
sc¡_rg‘_group
 *
tg
,

220 
sc¡_tg_tgt
 *
tg_tgt
)

222 
	`TRACE_ENTRY
();

223 
	`li¡_d–
(&
tg_tgt
->
’Œy
);

224 
	`sc¡_tg_tgt_sysfs_d–
(
tg
, 
tg_tgt
);

225 
	`kobjeù_put
(&
tg_tgt
->
kobj
);

226 
	`TRACE_EXIT
();

227 
	}
}

232 
	$sc¡_tg_tgt_»move_by_Çme
(
sc¡_rg‘_group
 *
tg
, cÚ¡ *
Çme
)

234 
sc¡_tg_tgt
 *
tg_tgt
;

235 
»s
;

237 
	`TRACE_ENTRY
();

238 
	`BUG_ON
(!
tg
);

239 
	`BUG_ON
(!
Çme
);

240 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

241 ià(
»s
)

242 
out
;

243 
»s
 = -
EINVAL
;

244 
tg_tgt
 = 
	`__lookup_dg_tgt
(
tg
->
dg
, 
Çme
);

245 ià(!
tg_tgt
)

246 
out_uÆock
;

247 
	`__sc¡_tg_tgt_»move
(
tg
, 
tg_tgt
);

248 
»s
 = 0;

249 
out_uÆock
:

250 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

251 
out
:

252 
	`TRACE_EXIT_RES
(
»s
);

253  
»s
;

254 
	}
}

257 
	$sc¡_tg_tgt_»move_by_tgt
(
sc¡_tgt
 *
tgt
)

259 
sc¡_dev_group
 *
dg
;

260 
sc¡_rg‘_group
 *
tg
;

261 
sc¡_tg_tgt
 *
t
, *
t2
;

263 
	`BUG_ON
(!
tgt
);

264 
	`li¡_fÜ_—ch_’Œy
(
dg
, &
sc¡_dev_group_li¡
, 
’Œy
)

265 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
)

266 
	`li¡_fÜ_—ch_’Œy_§ã
(
t
, 
t2
, &
tg
->
tgt_li¡
, 
’Œy
)

267 ià(
t
->
tgt
 ==gt)

268 
	`__sc¡_tg_tgt_»move
(
tg
, 
t
);

269 
	}
}

275 
	$sc¡_»Ëa£_tg
(
kobjeù
 *
kobj
)

277 
sc¡_rg‘_group
 *
tg
;

279 
tg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_rg‘_group
, kobj);

280 
	`kä“
(
tg
->
Çme
);

281 
	`kä“
(
tg
);

282 
	}
}

284 
kobj_ty³
 
	gsc¡_tg_kty³
 = {

285 #iâdeà
CONFIG_SCST_PROC


286 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

288 .
	g»Ëa£
 = 
sc¡_»Ëa£_tg
,

294 
	$sc¡_tg_add
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
)

296 
sc¡_rg‘_group
 *
tg
;

297 
»s
;

299 
	`TRACE_ENTRY
();

300 
»s
 = -
ENOMEM
;

301 
tg
 = 
	`kz®loc
( *tg, 
GFP_KERNEL
);

302 ià(!
tg
)

303 
out
;

304 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 24)

305 
	`kobjeù_š™
(&
tg
->
kobj
, &
sc¡_tg_kty³
);

307 
	`kobjeù_š™
(&
tg
->
kobj
);

308 
tg
->
kobj
.
kty³
 = &
sc¡_tg_kty³
;

310 
tg
->
Çme
 = 
	`k¡rdup
Òame, 
GFP_KERNEL
);

311 ià(!
tg
->
Çme
)

312 
out_put
;

313 
tg
->
dg
 = dg;

314 
tg
->
¡©e
 = 
SCST_TG_STATE_OPTIMIZED
;

315 
	`INIT_LIST_HEAD
(&
tg
->
tgt_li¡
);

317 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

318 ià(
»s
)

319 
out_put
;

320 
»s
 = -
EEXIST
;

321 ià(
	`__lookup_tg_by_Çme
(
dg
, 
Çme
))

322 
out_uÆock
;

323 
»s
 = 
	`sc¡_tg_sysfs_add
(
dg
, 
tg
);

324 ià(
»s
)

325 
out_uÆock
;

326 
	`li¡_add_ž
(&
tg
->
’Œy
, &
dg
->
tg_li¡
);

327 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

329 
out
:

330 
	`TRACE_EXIT_RES
(
»s
);

331  
»s
;

333 
out_uÆock
:

334 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

335 
out_put
:

336 
	`kobjeù_put
(&
tg
->
kobj
);

337 
out
;

338 
	}
}

340 
	$__sc¡_tg_»move
(
sc¡_dev_group
 *
dg
,

341 
sc¡_rg‘_group
 *
tg
)

343 
sc¡_tg_tgt
 *
tg_tgt
;

345 
	`TRACE_ENTRY
();

346 
	`BUG_ON
(!
dg
);

347 
	`BUG_ON
(!
tg
);

348 !
	`li¡_em±y
(&
tg
->
tgt_li¡
)) {

349 
tg_tgt
 = 
	`li¡_fœ¡_’Œy
(&
tg
->
tgt_li¡
, 
sc¡_tg_tgt
,

350 
’Œy
);

351 
	`__sc¡_tg_tgt_»move
(
tg
, 
tg_tgt
);

353 
	`li¡_d–
(&
tg
->
’Œy
);

354 
	`sc¡_tg_sysfs_d–
(
tg
);

355 
	`kobjeù_put
(&
tg
->
kobj
);

356 
	`TRACE_EXIT
();

357 
	}
}

362 
	$sc¡_tg_»move_by_Çme
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
)

364 
sc¡_rg‘_group
 *
tg
;

365 
»s
;

367 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

368 ià(
»s
)

369 
out
;

370 
»s
 = -
EINVAL
;

371 
tg
 = 
	`__lookup_tg_by_Çme
(
dg
, 
Çme
);

372 ià(!
tg
)

373 
out_uÆock
;

374 
	`__sc¡_tg_»move
(
dg
, 
tg
);

375 
»s
 = 0;

376 
out_uÆock
:

377 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

378 
out
:

379  
»s
;

380 
	}
}

382 
	$sc¡_tg_£t_¡©e
(
sc¡_rg‘_group
 *
tg
, 
sc¡_tg_¡©e
 
¡©e
)

384 
sc¡_dg_dev
 *
dg_dev
;

385 
sc¡_deviû
 *
dev
;

386 
sc¡_tgt_dev
 *
tgt_dev
;

387 
»s
;

389 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

390 ià(
»s
)

391 
out
;

393 
tg
->
¡©e
 = state;

395 
	`li¡_fÜ_—ch_’Œy
(
dg_dev
, &
tg
->
dg
->
dev_li¡
, 
’Œy
) {

396 
dev
 = 
dg_dev
->dev;

397 
	`li¡_fÜ_—ch_’Œy
(
tgt_dev
, &
dev
->
dev_tgt_dev_li¡
,

398 
dev_tgt_dev_li¡_’Œy
) {

399 
	`TRACE_MGMT_DBG
("ALUA state ofgt_dev %p has changed",

400 
tgt_dev
);

401 
	`sc¡_g’_«n_Ü_ua
(
tgt_dev
,

402 
	`SCST_LOAD_SENSE
(
sc¡_£n£_asym_acûss_¡©e_chªged
));

405 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

406 
out
:

407  
»s
;

408 
	}
}

420 
	$sc¡_dg_dev_add
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
)

422 
sc¡_dg_dev
 *
dgdev
;

423 
sc¡_deviû
 *
dev
;

424 
»s
;

426 
»s
 = -
ENOMEM
;

427 
dgdev
 = 
	`kz®loc
( *dgdev, 
GFP_KERNEL
);

428 ià(!
dgdev
)

429 
out
;

431 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

432 ià(
»s
)

433 
out_ä“
;

434 
»s
 = -
EEXIST
;

435 ià(
	`__glob®_lookup_dg_dev_by_Çme
(
Çme
))

436 
out_uÆock
;

437 
»s
 = -
EINVAL
;

438 
dev
 = 
	`__lookup_dev
(
Çme
);

439 ià(!
dev
)

440 
out_uÆock
;

441 
dgdev
->
dev
 = dev;

442 
»s
 = 
	`sc¡_dg_dev_sysfs_add
(
dg
, 
dgdev
);

443 ià(
»s
)

444 
out_uÆock
;

445 
	`li¡_add_ž
(&
dgdev
->
’Œy
, &
dg
->
dev_li¡
);

446 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

448 
out
:

449  
»s
;

451 
out_uÆock
:

452 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

453 
out_ä“
:

454 
	`kä“
(
dgdev
);

455 
out
;

456 
	}
}

458 
	$__sc¡_dg_dev_»move
(
sc¡_dev_group
 *
dg
,

459 
sc¡_dg_dev
 *
dgdev
)

461 
	`li¡_d–
(&
dgdev
->
’Œy
);

462 
	`sc¡_dg_dev_sysfs_d–
(
dg
, 
dgdev
);

463 
	`kä“
(
dgdev
);

464 
	}
}

469 
	$sc¡_dg_dev_»move_by_Çme
(
sc¡_dev_group
 *
dg
, cÚ¡ *
Çme
)

471 
sc¡_dg_dev
 *
dgdev
;

472 
»s
;

474 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

475 ià(
»s
)

476 
out
;

477 
»s
 = -
EINVAL
;

478 
dgdev
 = 
	`__lookup_dg_dev_by_Çme
(
dg
, 
Çme
);

479 ià(!
dgdev
)

480 
out_uÆock
;

481 
	`__sc¡_dg_dev_»move
(
dg
, 
dgdev
);

482 
»s
 = 0;

483 
out_uÆock
:

484 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

485 
out
:

486  
»s
;

487 
	}
}

490 
	$sc¡_dg_dev_»move_by_dev
(
sc¡_deviû
 *
dev
)

492 
sc¡_dev_group
 *
dg
;

493 
sc¡_dg_dev
 *
dgdev
;

494 
»s
;

496 
»s
 = -
EINVAL
;

497 
dg
 = 
	`__lookup_dg_by_dev
(
dev
);

498 ià(!
dg
)

499 
out
;

500 
dgdev
 = 
	`__lookup_dg_dev_by_dev
(
dg
, 
dev
);

501 
	`BUG_ON
(!
dgdev
);

502 
	`__sc¡_dg_dev_»move
(
dg
, 
dgdev
);

503 
»s
 = 0;

504 
out
:

505  
»s
;

506 
	}
}

512 
	$sc¡_»Ëa£_dg
(
kobjeù
 *
kobj
)

514 
sc¡_dev_group
 *
dg
;

516 
dg
 = 
	`cÚš”_of
(
kobj
, 
sc¡_dev_group
, kobj);

517 
	`kä“
(
dg
->
Çme
);

518 
	`kä“
(
dg
);

519 
	}
}

521 
kobj_ty³
 
	gsc¡_dg_kty³
 = {

522 #iâdeà
CONFIG_SCST_PROC


523 .
sysfs_Ýs
 = &
sc¡_sysfs_Ýs
,

525 .
	g»Ëa£
 = 
sc¡_»Ëa£_dg
,

531 
	$sc¡_dg_add
(
kobjeù
 *
·»Á
, cÚ¡ *
Çme
)

533 
sc¡_dev_group
 *
dg
;

534 
»s
;

536 
	`TRACE_ENTRY
();

538 
»s
 = -
ENOMEM
;

539 
dg
 = 
	`kz®loc
((*dg), 
GFP_KERNEL
);

540 ià(!
dg
)

541 
out
;

542 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 24)

543 
	`kobjeù_š™
(&
dg
->
kobj
, &
sc¡_dg_kty³
);

545 
	`kobjeù_š™
(&
dg
->
kobj
);

546 
dg
->
kobj
.
kty³
 = &
sc¡_dg_kty³
;

548 
dg
->
Çme
 = 
	`k¡rdup
Òame, 
GFP_KERNEL
);

549 ià(!
dg
->
Çme
)

550 
out_put
;

552 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

553 ià(
»s
)

554 
out_put
;

555 
»s
 = -
EEXIST
;

556 ià(
	`__lookup_dg_by_Çme
(
Çme
))

557 
out_uÆock
;

558 
»s
 = -
ENOMEM
;

559 
	`INIT_LIST_HEAD
(&
dg
->
dev_li¡
);

560 
	`INIT_LIST_HEAD
(&
dg
->
tg_li¡
);

561 
»s
 = 
	`sc¡_dg_sysfs_add
(
·»Á
, 
dg
);

562 ià(
»s
)

563 
out_uÆock
;

564 
	`li¡_add_ž
(&
dg
->
’Œy
, &
sc¡_dev_group_li¡
);

565 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

566 
out
:

567 
	`TRACE_EXIT_RES
(
»s
);

568  
»s
;

570 
out_uÆock
:

571 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

572 
out_put
:

573 
	`kobjeù_put
(&
dg
->
kobj
);

574 
out
;

575 
	}
}

577 
	$__sc¡_dg_»move
(
sc¡_dev_group
 *
dg
)

579 
sc¡_dg_dev
 *
dgdev
;

580 
sc¡_rg‘_group
 *
tg
;

582 
	`li¡_d–
(&
dg
->
’Œy
);

583 
	`sc¡_dg_sysfs_d–
(
dg
);

584 !
	`li¡_em±y
(&
dg
->
dev_li¡
)) {

585 
dgdev
 = 
	`li¡_fœ¡_’Œy
(&
dg
->
dev_li¡
, 
sc¡_dg_dev
,

586 
’Œy
);

587 
	`__sc¡_dg_dev_»move
(
dg
, 
dgdev
);

589 !
	`li¡_em±y
(&
dg
->
tg_li¡
)) {

590 
tg
 = 
	`li¡_fœ¡_’Œy
(&
dg
->
tg_li¡
, 
sc¡_rg‘_group
,

591 
’Œy
);

592 
	`__sc¡_tg_»move
(
dg
, 
tg
);

594 
	`kobjeù_put
(&
dg
->
kobj
);

595 
	}
}

597 
	$sc¡_dg_»move
(cÚ¡ *
Çme
)

599 
sc¡_dev_group
 *
dg
;

600 
»s
;

602 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

603 ià(
»s
)

604 
out
;

605 
»s
 = -
EINVAL
;

606 
dg
 = 
	`__lookup_dg_by_Çme
(
Çme
);

607 ià(!
dg
)

608 
out_uÆock
;

609 
	`__sc¡_dg_»move
(
dg
);

610 
»s
 = 0;

611 
out_uÆock
:

612 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

613 
out
:

614  
»s
;

615 
	}
}

625 
sc¡_dev_group
 *
	$sc¡_lookup_dg_by_kobj
(
kobjeù
 *
kobj
)

627 
»s
;

628 
sc¡_dev_group
 *
dg
;

630 
dg
 = 
NULL
;

631 
»s
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
sc¡_mu‹x
);

632 ià(
»s
)

633 
out
;

634 
	`li¡_fÜ_—ch_’Œy
(
dg
, &
sc¡_dev_group_li¡
, 
’Œy
)

635 ià(
dg
->
dev_kobj
 =ð
kobj
 || dg->
tg_kobj
 == kobj)

636 
out_uÆock
;

637 
dg
 = 
NULL
;

638 
out_uÆock
:

639 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

640 
out
:

641  
dg
;

642 
	}
}

649 
	$sc¡_tg_š™
()

651 
	`INIT_LIST_HEAD
(&
sc¡_dev_group_li¡
);

652 
	}
}

654 
	$sc¡_tg_þ—nup
()

656 
sc¡_dev_group
 *
tg
;

658 
	`mu‹x_lock
(&
sc¡_mu‹x
);

659 !
	`li¡_em±y
(&
sc¡_dev_group_li¡
)) {

660 
tg
 = 
	`li¡_fœ¡_’Œy
(&
sc¡_dev_group_li¡
,

661 
sc¡_dev_group
, 
’Œy
);

662 
	`__sc¡_dg_»move
(
tg
);

664 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

665 
	}
}

678 
ušt16_t
 
	$sc¡_lookup_tg_id
(
sc¡_deviû
 *
dev
, 
sc¡_tgt
 *
tgt
)

680 
sc¡_dev_group
 *
dg
;

681 
sc¡_rg‘_group
 *
tg
;

682 
sc¡_tg_tgt
 *
tg_tgt
;

683 
ušt16_t
 
tg_id
 = 0;

685 
	`TRACE_ENTRY
();

686 
	`mu‹x_lock
(&
sc¡_mu‹x
);

687 
dg
 = 
	`__lookup_dg_by_dev
(
dev
);

688 ià(!
dg
)

689 
out_uÆock
;

690 
tg_tgt
 = 
	`__lookup_dg_tgt
(
dg
, 
tgt
->
tgt_Çme
);

691 ià(!
tg_tgt
)

692 
out_uÆock
;

693 
tg
 = 
tg_tgt
->tg;

694 
	`BUG_ON
(!
tg
);

695 
tg_id
 = 
tg
->
group_id
;

696 
out_uÆock
:

697 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

699 
	`TRACE_EXIT_RES
(
tg_id
);

700  
tg_id
;

701 
	}
}

702 
EXPORT_SYMBOL_GPL
(
sc¡_lookup_tg_id
);

708 
boÞ
 
	$sc¡_im¶_®ua_cÚfigu»d
(
sc¡_deviû
 *
dev
)

710 
sc¡_dev_group
 *
dg
;

711 
boÞ
 
»s
;

713 
	`mu‹x_lock
(&
sc¡_mu‹x
);

714 
dg
 = 
	`__lookup_dg_by_dev
(
dev
);

715 
»s
 = 
dg
 !ð
NULL
;

716 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

718  
»s
;

719 
	}
}

720 
EXPORT_SYMBOL_GPL
(
sc¡_im¶_®ua_cÚfigu»d
);

729 
	$sc¡_tg_g‘_group_šfo
(**
buf
, 
ušt32_t
 *
Ëngth
,

730 
sc¡_deviû
 *
dev
, 
ušt8_t
 
d©a_fÜm©
)

732 
sc¡_dev_group
 *
dg
;

733 
sc¡_rg‘_group
 *
tg
;

734 
sc¡_tg_tgt
 *
tgtgt
;

735 
sc¡_tgt
 *
tgt
;

736 
ušt8_t
 *
p
;

737 
ušt32_t
 
»t_d©a_Ën
;

738 
ušt16_t
 
»l_tgt_id
;

739 
»s
;

741 
	`TRACE_ENTRY
();

743 
	`BUG_ON
(!
buf
);

744 
	`BUG_ON
(!
Ëngth
);

746 
»t_d©a_Ën
 = 0;

748 
»s
 = -
EINVAL
;

749 
d©a_fÜm©
) {

754 
»t_d©a_Ën
 += 4;

757 
out
;

760 *
Ëngth
 = 4;

762 
	`mu‹x_lock
(&
sc¡_mu‹x
);

764 
dg
 = 
	`__lookup_dg_by_dev
(
dev
);

765 ià(
dg
) {

766 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
) {

768 
»t_d©a_Ën
 += 8;

769 
	`li¡_fÜ_—ch_’Œy
(
tgtgt
, &
tg
->
tgt_li¡
, 
’Œy
) {

771 
»t_d©a_Ën
 += 4;

776 *
Ëngth
 +ð
»t_d©a_Ën
;

778 
»s
 = -
ENOMEM
;

779 *
buf
 = 
	`kz®loc
(*
Ëngth
, 
GFP_KERNEL
);

780 ià(!*
buf
)

781 
out_uÆock
;

783 
p
 = *
buf
;

785 
	`put_uÇligÃd
(
	`ýu_to_be32
(
»t_d©a_Ën
), (
__be32
 *)
p
);

786 
p
 += 4;

787 ià(
d©a_fÜm©
 == 1) {

789 *
p
++ = 0x10;

790 *
p
++ = 0x00;

791 
p
 += 2;

794 ià(!
dg
)

795 
dÚe
;

797 
	`li¡_fÜ_—ch_’Œy
(
tg
, &
dg
->
tg_li¡
, 
’Œy
) {

799 *
p
++ = (
tg
->
´eã¼ed
 ? 
SCST_TG_PREFERRED
 : 0è|g->
¡©e
;

800 *
p
++ = 
SCST_TG_SUP_OPTIMIZED


801 | 
SCST_TG_SUP_NONOPTIMIZED


802 | 
SCST_TG_SUP_STANDBY


803 | 
SCST_TG_SUP_UNAVAILABLE
;

804 
	`put_uÇligÃd
(
	`ýu_to_be16
(
tg
->
group_id
), (
__be16
 *)
p
);

805 
p
 += 2;

806 
p
++;

807 *
p
++ = 2;

808 
p
++;

809 
	`li¡_fÜ_—ch_’Œy
(
tgtgt
, &
tg
->
tgt_li¡
, 
’Œy
)

810 (*
p
)++;

811 
p
++;

812 
	`li¡_fÜ_—ch_’Œy
(
tgtgt
, &
tg
->
tgt_li¡
, 
’Œy
) {

813 
tgt
 = 
tgtgt
->tgt;

814 
»l_tgt_id
 = 
tgt
 ?gt->»l_tgt_id : 
tgtgt
->rel_tgt_id;

816 
p
 += 2;

818 
	`put_uÇligÃd
(
	`ýu_to_be16
(
»l_tgt_id
),

819 (
__be16
 *)
p
);

820 
p
 += 2;

824 
dÚe
:

825 
	`WARN_ON
(
p
 - (
ušt8_t
 *)*
buf
 !ð*
Ëngth
);

827 
»s
 = 0;

829 
out_uÆock
:

830 
	`mu‹x_uÆock
(&
sc¡_mu‹x
);

831 
out
:

832 
	`TRACE_EXIT_RES
(
»s
);

833  
»s
;

834 
	}
}

835 
EXPORT_SYMBOL_GPL
(
sc¡_tg_g‘_group_šfo
);

	@
1
.
0
38
1886
/root/Desktop/scst-2.2.0/include/scst.h
/root/Desktop/scst-2.2.0/include/scst_const.h
/root/Desktop/scst-2.2.0/include/scst_debug.h
/root/Desktop/scst-2.2.0/include/scst_sgv.h
/root/Desktop/scst-2.2.0/include/scst_user.h
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_cdrom.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_cdrom.mod.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_changer.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_changer.mod.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_dev_handler.h
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_disk.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_disk.mod.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_modisk.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_modisk.mod.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_processor.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_processor.mod.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_raid.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_raid.mod.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_tape.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_tape.mod.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_user.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_user.mod.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_vdisk.c
/root/Desktop/scst-2.2.0/src/dev_handlers/scst_vdisk.mod.c
/root/Desktop/scst-2.2.0/src/scst.mod.c
/root/Desktop/scst-2.2.0/src/scst_debug.c
/root/Desktop/scst-2.2.0/src/scst_lib.c
/root/Desktop/scst-2.2.0/src/scst_main.c
/root/Desktop/scst-2.2.0/src/scst_mem.c
/root/Desktop/scst-2.2.0/src/scst_mem.h
/root/Desktop/scst-2.2.0/src/scst_module.c
/root/Desktop/scst-2.2.0/src/scst_pres.c
/root/Desktop/scst-2.2.0/src/scst_pres.h
/root/Desktop/scst-2.2.0/src/scst_priv.h
/root/Desktop/scst-2.2.0/src/scst_proc.c
/root/Desktop/scst-2.2.0/src/scst_sysfs.c
/root/Desktop/scst-2.2.0/src/scst_targ.c
/root/Desktop/scst-2.2.0/src/scst_tg.c
